/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/TableDelegate","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/StableIdHelper","sap/fe/macros/field/FieldHelper","sap/fe/macros/table/TableHelper","sap/fe/macros/DelegateUtil"],function(T,X,a,F,J,C,S,b,c,D){"use strict";var d="sap.fe.TableDelegate.propertyInfoMap";var O=Object.assign({},T);function _(p,l,L){var s=l?p.lastIndexOf("/"):p.indexOf("/");if(s===-1){return p;}return L?p.substring(s+1,p.length):p.substring(0,s);}function e(B,n){var m=B.getModel(),s=B.getPath(),N=m.createBindingContext(s+"/"+n),l=C.getLabel(N),j=null,p=C.getIdentifyingName(N),G=_(p,true),I=G!=p,k=I?C.getLabel(B,G):null,o=C.isPropertyFilterable(p,{context:N}),H=N.getProperty("@com.sap.vocabularies.UI.v1.Hidden"),t=N.getProperty("$kind")&&N.getProperty("$Type"),q=t&&t.indexOf("Edm.")!==0;if(H||q){return null;}return{name:p,path:p,metadataPath:n,groupLabel:k,group:I?G:null,label:l,description:j||l,maxLength:N.$MaxLength,precision:N.$Precision,scale:N.$Scale,type:N.$Type,filterable:o,sortable:true};}function f(B){var s=B.getPath(),m=B.getModel(),I=function(o){return o.name===this.name;};return m.requestObject(s+"/@com.sap.vocabularies.UI.v1.LineItem").then(function(l){return l.map(function(o,j){switch(o.$Type){case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldDefault":return e(B,"@com.sap.vocabularies.UI.v1.LineItem/"+j,m);case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataPoint":case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":default:return null;}}).filter(function(p){return!!p;}).filter(function(p,j,A){return!A.slice(0,j).some(I.bind(p));});});}function g(B,m){var o=m.createBindingContext(B);return f(o).then(function(j){return Promise.all([D.fetchPropertiesForEntity(B,m),D.fetchAnnotationsForEntity(B,m)]).then(function(r){if(!r[0]&&!r[1]){return Promise.resolve(j);}var E=r[0],k=r[1],s=k["@Org.OData.Capabilities.V1.SortRestrictions"]||{},n=(s["NonSortableProperties"]||[]).map(function(q){return q["$PropertyPath"];}),l,p,I=function(q){return q.name===p.name;};for(var K in E){l=E[K];if(l&&l.$kind==="Property"){p=e(o,K);if(p){if(!j.some(I)){j.push(p);}p.sortable=p.sortable&&n.indexOf(K)===-1;}}}return j;});});}function h(t){return t.data(d);}function i(t,E,m){var j=h(t);if(j){return Promise.resolve(j);}return g(E,m).then(function(j){t.data(d,j);return j;});}O.rebindTable=function(t,B,s){var u;if(t.data("unboundIBNActions")){u=t.data("unboundIBNActions").split(",");}if(!t.getModel("actionsVisibility")&&u){var k=new J();for(var j=0;j<u.length;j++){k.setProperty("/"+u[j],false);}t.setModel(k,"actionsVisibility");c.updateDataFiledForIBNButtonsVisibility(k);}if(s){B.parameters.$search=s;}else{delete B.parameters.$search;}var l=t.getModel("localUI");if(l){var m=t.getId().split("--")[1];l.setProperty("/$contexts/"+m+"/deleteEnabled",false);l.setProperty("/$contexts/"+m+"/numberOfSelectedContexts",0);l.setProperty("/$contexts/"+m+"/selectedContexts",[]);l.setProperty("/$contexts/"+m+"/deletableContexts",[]);}T.rebindTable(t,B,s);};O.fetchProperties=function(t){return D.fetchModel(t).then(function(m){if(!m){return[];}return i(t,t.data("targetCollectionName"),m.getMetaModel());});};O.updateBindingInfo=function(m,B){if(B.binding&&!B.binding.isSuspended()){B.suspended=false;}T.updateBindingInfo.call(T,m,B);};O.beforeAddColumnFlex=function(p,t,P){var m=P.appComponent&&P.appComponent.getModel().getMetaModel(),M=P.modifier,I=M.targets==="xmlTree",s=M.getId(t),o=(!I&&P.view&&P.view.getController())||undefined,j,v,k,l;if(!m){return Promise.resolve(null);}j=D.getCustomDataProperty("targetCollectionName",t,M);k=m.createBindingContext(j);var n=j+"/"+p,q=m.createBindingContext(n);v=D.checkValueHelp({sPropertyName:p,sBindingPath:j,sVHIdPrefix:"TableVH",oControl:t,oMetaModel:m,oModifier:M}).then(function(V){if(V){return r("sap.fe.macros.table.ValueHelp");}return Promise.resolve();});function r(w){var x=new J({id:s}),y={bindingContexts:{"collection":k,"item":q,"this":x.createBindingContext("/")},models:{"this":x,"collection":m,"item":m}};return D.templateControlFragment(w,y,undefined,M.targets==="xmlTree").then(function(v){if(v){M.insertAggregation(t,"dependents",v,0);}});}function u(w,H){var x=new J({editMode:"{"+D.getCustomDataProperty("editModePropertyBinding",t,M)+"}",onCallAction:D.getCustomDataProperty("onCallAction",t,M),tableType:D.getCustomDataProperty("tableType",t,M),onChange:D.getCustomDataProperty("onChange",t,M),parentControl:"Table",id:s,navigationPropertyPath:p}),y={bindingContexts:{"collection":k,"dataField":q,"this":x.createBindingContext("/")},models:{"this":x,"collection":m,"dataField":m}};return D.templateControlFragment(w,y,H,M.targets==="xmlTree");}l=v.then(u.bind(this,"sap.fe.macros.table.ColumnProperty",o));return l;};return O;},false);
