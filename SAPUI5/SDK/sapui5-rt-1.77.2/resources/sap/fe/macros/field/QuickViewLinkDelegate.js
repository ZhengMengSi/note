/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/link/Panel","sap/ui/mdc/link/PanelItem","sap/ui/mdc/LinkDelegate","sap/ui/mdc/link/LinkItem","sap/ui/mdc/link/Factory","sap/ui/mdc/link/Log","sap/base/Log","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/fe/macros/field/FieldHelper","sap/base/util/isPlainObject","sap/ui/mdc/link/SemanticObjectMapping","sap/ui/mdc/link/SemanticObjectMappingItem","sap/ui/mdc/link/SemanticObjectUnavailableAction","sap/fe/core/CommonUtils","sap/fe/navigation/NavigationHelper","sap/base/util/merge","sap/fe/navigation/SelectionVariant"],function(P,a,L,b,F,c,S,X,d,e,f,i,g,h,j,C,N,m,k){"use strict";var l=Object.assign({},L);l._getEntityType=function(p,M){if(M){return M.createBindingContext(p.entityType);}};l._getDataField=function(p,M){return M.createBindingContext(p.dataField);};l._getContact=function(p,M){return M.createBindingContext(p.contact);};l.fnTemplateFragment=function(s){var o=d.loadTemplate(s,"fragment");var n={};if(this.payLoad.entityType&&this._getEntityType(this.payLoad,this.oMetaModel)){n.bindingContexts={"entityType":this._getEntityType(this.payLoad,this.oMetaModel)};n.models={"entityType":this.oMetaModel};}else if(this.payLoad.dataField&&this._getDataField(this.payLoad,this.oMetaModel)){n.bindingContexts={"dataField":this._getDataField(this.payLoad,this.oMetaModel)};n.models={"dataField":this.oMetaModel};}else if(this.payLoad.contact&&this._getContact(this.payLoad,this.oMetaModel)){n.bindingContexts={"contact":this._getContact(this.payLoad,this.oMetaModel)};n.models={"contact":this.oMetaModel};}return Promise.resolve(X.process(o,{name:s},n)).then(function(o){return e.load({definition:o});});};l.fetchAdditionalContent=function(p,B){this.payLoad=p;if(B){this.oMetaModel=B.getModel().getMetaModel();return this.fnTemplateFragment("sap.fe.macros.field.QuickViewLinkDelegate").then(function(o){return[o];});}return Promise.resolve([]);};l.fetchLinkItems=function(p,B,I){if(B&&l._getSemanticObjects(p)){var o=B.getObject();var n=[];if(I){I.initialize(l._getSemanticObjects(p));n.forEach(function(q){I.addIntent(c.IntentType.API,{text:q.getText(),intent:q.getHref()});});}var s=l._calculateSemanticAttributes(o,p,I);return l._retrieveNavigationTargets("",s,p,I).then(function(q,O){return q;});}else{return Promise.resolve([]);}};l.modifyLinkItems=function(p,B,n){if(n.length!==0){var o=n[0].getParent();var v=sap.ui.fl.Utils.getViewForControl(o);var A=C.getAppComponent(v);var q=o.getBindingContext().getObject();var r;if(v.getAggregation("content")[0]&&v.getAggregation("content")[0].getBindingContext()){r=N.removeSensitiveData(v.getAggregation("content")[0].getBindingContext());}else{var s=v.getController();r=s.filterBarConditions;}if(r){delete r["@odata.context"];}var M=m({},r,q);var t=N.mixAttributesAndSelectionVariant(M,new k());A.getService("navigation").then(function(u){var U=F.getService("URLParsing");if(!U){S.error("QuickViewLinkDelegate: Service 'URLParsing' could not be obtained");return Promise.reject();}var E=N._getTargetCollection(B);var w=u.storeInnerAppStateWithImmediateReturn(t,true,E,true);var x=u.getUrlParametersFromSelectionVariant(t);var y,z;n.forEach(function(o){y=U.parseShellHash(o.getHref());z={target:{semanticObject:y.semanticObject,action:y.action},params:x,appStateKey:w.appStateKey};o.setHref("#"+U.constructShellHash(z));});});}return Promise.resolve(n);};l._calculateSemanticAttributes=function(o,p,I){var s=l._getSemanticObjects(p);var n=l._convertSemanticObjectMapping(l._getSemanticObjectMappings(p));if(!s.length){s.push("");}var r={};s.forEach(function(q){if(I){I.addContextObject(q,o);}r[q]={};for(var A in o){var t=null,T=null;if(I){t=I.getSemanticObjectAttribute(q,A);if(!t){t=I.createAttributeStructure();I.addSemanticObjectAttribute(q,A,t);}}if(o[A]===undefined||o[A]===null){if(t){t.transformations.push({value:undefined,description:"\u2139 Undefined and null values have been removed in SimpleLinkDelegate."});}continue;}if(i(o[A])){if(t){t.transformations.push({value:undefined,description:"\u2139 Plain objects has been removed in SimpleLinkDelegate."});}continue;}var u=n&&n[q]&&n[q][A]?n[q][A]:A;if(t&&A!==u){T={value:undefined,description:"\u2139 The attribute "+A+" has been renamed to "+u+" in SimpleLinkDelegate.",reason:"\ud83d\udd34 A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object "+q+" with source attribute "+A+" and target attribute "+u+". You can modify the annotation if the mapping result is not what you expected."};}if(r[q][u]){S.error("SimpleLinkDelegate: The attribute "+A+" can not be renamed to the attribute "+u+" due to a clash situation. This can lead to wrong navigation later on.");}r[q][u]=o[A];if(t){if(T){t.transformations.push(T);var v=I.createAttributeStructure();v.transformations.push({value:o[A],description:"\u2139 The attribute "+u+" with the value "+o[A]+" has been added due to a mapping rule regarding the attribute "+A+" in SimpleLinkDelegate."});I.addSemanticObjectAttribute(q,u,v);}}}});return r;};l._retrieveNavigationTargets=function(A,s,p,I){if(!p.semanticObjects){return new Promise(function(n){n([]);});}var o=p.semanticObjects;var q=p.sourceControl;var r={ownNavigation:undefined,availableActions:[]};return sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true}).then(function(){return new Promise(function(t){sap.ui.require(["sap/ui/fl/Utils"],function(U){var u=F.getService("CrossApplicationNavigation");var v=F.getService("URLParsing");if(!u||!v){S.error("SimpleLinkDelegate: Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");return t(r.availableActions,r.ownNavigation);}var w=sap.ui.getCore().byId(q);var x=U.getAppComponentForControl(w);var y=o.map(function(n){return[{semanticObject:n,params:s?s[n]:undefined,appStateKey:A,ui5Component:x,sortResultsBy:"text"}];});return new Promise(function(){u.getLinks(y).then(function(z){if(!z||!z.length){return t(r.availableActions,r.ownNavigation);}var B=l._getSemanticObjectUnavailableActions(p);var D=l._convertSemanticObjectUnavailableAction(B);var E=u.hrefForExternal();if(E&&E.indexOf("?")!==-1){E=E.split("?")[0];}if(E){E+="?";}var G=function(J,K){return(!!D&&!!D[J]&&D[J].indexOf(K)>-1);};var H=function(J){var K=v.parseShellHash(J.intent);if(G(K.semanticObject,K.action)){return;}var M=u.hrefForExternal({target:{shellHash:J.intent}},x);if(J.intent&&J.intent.indexOf(E)===0){r.ownNavigation=new b({href:M,text:J.text});return;}var O=new b({key:K.semanticObject&&K.action?K.semanticObject+"-"+K.action:undefined,text:J.text,description:undefined,href:M,icon:undefined,isSuperior:J.tags&&J.tags.indexOf("superiorAction")>-1});r.availableActions.push(O);if(I){I.addSemanticObjectIntent(K.semanticObject,{intent:O.getHref(),text:O.getText()});}};for(var n=0;n<o.length;n++){z[n][0].forEach(H);}return t(r.availableActions,r.ownNavigation);},function(){S.error("SimpleLinkDelegate: '_retrieveNavigationTargets' failed executing getLinks method");return t(r.availableActions,r.ownNavigation);});});});});});};l._getSemanticObjects=function(p){return p.semanticObjects?p.semanticObjects:[];};l._getSemanticObjectUnavailableActions=function(p){var s=[];if(p.semanticObjectUnavailableActions){p.semanticObjectUnavailableActions.forEach(function(o){s.push(new j({semanticObject:o.semanticObject,actions:o.actions}));});}return s;};l._getSemanticObjectMappings=function(p){var s=[];var n=[];if(p.semanticObjectMappings){p.semanticObjectMappings.forEach(function(o){n=[];if(o.items){o.items.forEach(function(q){n.push(new h({key:q.key,value:q.value}));});}s.push(new g({semanticObject:o.semanticObject,items:n}));});}return s;};l._convertSemanticObjectMapping=function(s){if(!s.length){return undefined;}var n={};s.forEach(function(o){if(!o.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+o.getSemanticObject()+"' is not valid");}n[o.getSemanticObject()]=o.getItems().reduce(function(M,I){M[I.getKey()]=I.getValue();return M;},{});});return n;};l._convertSemanticObjectUnavailableAction=function(s){if(!s.length){return undefined;}var n={};s.forEach(function(o){if(!o.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+o.getSemanticObject()+"' is not valid");}n[o.getSemanticObject()]=o.getActions();});return n;};return l;},true);
