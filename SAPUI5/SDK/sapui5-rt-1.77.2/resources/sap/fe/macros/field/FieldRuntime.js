/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/macros/ResourceModel","sap/fe/macros/SideEffectsUtil","sap/base/Log"],function(X,a,F,R,S,L){"use strict";function _(s,e){var B=s.getBindingContext(),m=B.getModel().getMetaModel(),M=m.getMetaPath(B.getPath()),E=m.getObject(M)["$Type"],C=B;if(e!==E){C=B.getBinding().getContext();if(C){M=m.getMetaPath(C.getPath());E=m.getObject(M)["$Type"];if(e!==E){return undefined;}}}return C||undefined;}function b(C){while(C&&!(C.getMetadata().getName()==="sap.ui.core.mvc.XMLView")){C=C.getParent();}return C;}function c(s){if(!s){return undefined;}Object.keys(s).forEach(function(C){var o=s[C];o.pathExpressions=S.replaceEmptyNavigationPaths(o.pathExpressions);});return s;}var d={formatDraftOwnerTextInPopover:function(h,D,s,e,f){if(h){var u=e||D||f||s;if(!u){return R.getText("draft.POPOVER_UNSAVED_CHANGES_BY_UNKNOWN");}else{return D?R.getText("draft.POPOVER_LOCKED_BY_KNOWN",u):R.getText("draft.POPOVER_UNSAVED_CHANGES_BY_KNOWN",u);}}else{return R.getText("draft.POPOVER_NO_DATA_TEXT");}},onDataFieldWithNavigationPath:function(C,s){var o=C&&C.getView(),B=o&&o.getBindingContext();if(C.routingListener){C.routingListener.navigateToTarget(B,s);}else{L.error("FieldRuntime: No routing listener controller extension found. Internal navigation aborted.","sap.fe.macros.field.FieldRuntime","onDataFieldWithNavigationPath");}},onDraftLinkPressed:function(e,E){var t=this,s=e.getSource(),v=b(s),B=s.getBindingContext(),m=B.getModel().getMetaModel(),V=v.getId(),D;this.mDraftPopovers=this.mDraftPopovers||{};this.mDraftPopovers[V]=this.mDraftPopovers[V]||{};D=this.mDraftPopovers[V][E];if(D){D.setBindingContext(B);D.openBy(s);}else{var f="sap.fe.macros.field.DraftPopOverAdminData",p=X.loadTemplate(f,"fragment");Promise.resolve(a.process(p,{name:f},{bindingContexts:{entitySet:m.createBindingContext("/"+E)},models:{entitySet:m}})).then(function(o){return F.load({definition:o,controller:t});}).then(function(P){D=t.mDraftPopovers[V][E]=P;D.setModel(R.getModel(),"i18n");v.addDependent(D);D.setBindingContext(B);D.openBy(s);});}},closeDraftAdminPopover:function(e){e.getSource().getParent().getParent().close();},_initSideEffectsQueue:function(C,o){this.sideEffectsRequestsQueue=this.sideEffectsRequestsQueue||{};this.sideEffectsRequestsQueue[C]=this.sideEffectsRequestsQueue[C]||{};this.sideEffectsRequestsQueue[C]["context"]=this.sideEffectsRequestsQueue[C]["context"]||o;this.sideEffectsRequestsQueue[C]["pathExpressions"]=this.sideEffectsRequestsQueue[C]["pathExpressions"]||[];if(this.aFailedSideEffects&&this.aFailedSideEffects[C]){this.sideEffectsRequestsQueue[C]["pathExpressions"]=this.sideEffectsRequestsQueue[C]["pathExpressions"].concat(this.aFailedSideEffects[C]["pathExpressions"]);delete this.aFailedSideEffects[C];}},prepareForSideEffects:function(f,s){var t=this,p=[],A=[],w=f.indexOf("#")>-1,e=(w&&f.split("#")[0])||f,q=(w&&f.split("#")[1])||"",g="/"+e+"@com.sap.vocabularies.Common.v1.SideEffects",B=s.getBindingContext(),m=B.getModel().getMetaModel(),C,h,P,Q,E,i,o,G=function(k){return k["$PropertyPath"];},j=function(k){return k["$NavigationPropertyPath"];};g=(w&&g+"#"+q)||g;o=m.getObject(g);if(o&&t.aPendingSideEffects.indexOf(f)>-1){C=_(s,e);if(!C){return Promise.resolve();}h=C.getPath();p=p.concat(o.TargetProperties||[]).concat(o.TargetEntities||[]);p.forEach(function(k){if(k["$PropertyPath"]){var T=m.getObject("/"+e+"/"+k["$PropertyPath"]+"@com.sap.vocabularies.Common.v1.Text");if(T&&T["$Path"]){A.push({"$PropertyPath":T["$Path"]});}}});p=p.concat(A);if(p.length){t._initSideEffectsQueue(h,C);Q=t.sideEffectsRequestsQueue[h]["pathExpressions"].filter(G).map(G);i=t.sideEffectsRequestsQueue[h]["pathExpressions"].filter(j).map(j);P=p.map(G).filter(function(k){return k&&Q.indexOf(k)<0;}).map(function(k){return{"$PropertyPath":k};});E=p.map(j).filter(function(k){return(k||k==="")&&i.indexOf(k)<0;}).map(function(k){return{"$NavigationPropertyPath":k};});p=P.concat(E);t.sideEffectsRequestsQueue[h]["pathExpressions"]=t.sideEffectsRequestsQueue[h]["pathExpressions"].concat(p);t.aPendingSideEffects.splice(t.aPendingSideEffects.indexOf(f),1);}}return Promise.resolve();},requestSideEffects:function(){if(!this.sideEffectsRequestsQueue){return;}var t=this,s=this.sideEffectsRequestsQueue;this.sideEffectsRequestsQueue=null;s=c(s)||{};Object.keys(s).forEach(function(p){var o=s[p];S.logRequest(o);o["context"].requestSideEffects(o["pathExpressions"]).then(function(){},function(){L.info("FieldRuntime: Failed to request side effect - "+p,"sap.fe.macros.field.FieldRuntime","requestSideEffects");t.aFailedSideEffects[p]=o;});});},requestTextIfRequired:function(s){var A=s.getBindingInfo("additionalValue");if(!A){return;}var p=A.parts.map(function(P){return{"$PropertyPath":P.path};}),C=s.getBindingContext();if(p.length){C.requestSideEffects(p).then(function(){},function(){L.info("FieldRuntime: Failed to request Text association - "+(p[0]&&p[0]["$PropertyPath"]),"sap.fe.macros.field.FieldRuntime","requestTextIfRequired");});}},handleChange:function(e){var t=this,s=e.getSource(),i=s&&s.getBindingContext().isTransient(),p=e.getParameter("promise")||Promise.resolve(),f=p,A=false;if(i){return;}this.aPendingSideEffects=this.aPendingSideEffects||[];this.mFieldGroupResolves=this.mFieldGroupResolves||{};this.aFailedSideEffects=this.aFailedSideEffects||{};p.then(function(){t.requestTextIfRequired(s);});if(s.getFieldGroupIds()){s.getFieldGroupIds().forEach(function(g){var I=g.indexOf("$$ImmediateRequest")>-1;if(I){A=true;g=g.substr(0,g.indexOf("$$ImmediateRequest"));}else if(t.mFieldGroupResolves.hasOwnProperty(g)){t.mFieldGroupResolves[g].push(p);}else{t.mFieldGroupResolves[g]=[p];}if(t.aPendingSideEffects.indexOf(g)===-1){t.aPendingSideEffects.push(g);}if(I){f=f.then(function(){return t.prepareForSideEffects(g,s);});}});if(A){f.then(this.requestSideEffects.bind(this));}}},handleSideEffect:function(e){if(!this.aPendingSideEffects||this.aPendingSideEffects.length===0){return;}var t=this,f=e.getParameter("fieldGroupIds"),s=e.getSource(),p=Promise.resolve();f=f||[];f.forEach(function(g){var h=[Promise.resolve()];if(t.mFieldGroupResolves&&t.mFieldGroupResolves[g]){h=t.mFieldGroupResolves[g];delete(t.mFieldGroupResolves&&t.mFieldGroupResolves[g]);}p=p.then(function(){return Promise.all(h).then(t.prepareForSideEffects.bind(t,g,s));});});p.then(this.requestSideEffects.bind(this));},handlePatchEvents:function(B){if(!B){return;}var t=this;B=(B.getBinding&&B.getBinding())||B;B.attachEvent("patchCompleted",function(e){if(e.getParameter("success")!==false&&t.aFailedSideEffects){Object.keys(t.aFailedSideEffects).forEach(function(C){t._initSideEffectsQueue(C,t.aFailedSideEffects[C]["context"]);});t.requestSideEffects();}});}};return d;},true);
