/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/FilterBarDelegate","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/StableIdHelper","sap/fe/macros/field/FieldHelper","sap/base/util/ObjectPath","sap/ui/mdc/odata/v4/FieldBaseDelegate","sap/ui/model/odata/type/String","sap/fe/macros/ResourceModel","sap/base/util/merge","sap/fe/macros/DelegateUtil","sap/fe/macros/FilterBarHelper"],function(F,X,a,b,J,C,S,c,O,d,e,R,m,D,f){"use strict";var g=Object.assign({},F),v=[],h={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"},E="$editState",i="$search";function _(p){var I=true;switch(p.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":I=false;break;}if(p.type&&p.type.indexOf("Boolean")>0){I=false;}return I;}function j(){return{name:i,path:i,type:"sap.ui.model.odata.type.String",baseType:new e(),maxConditions:1};}function k(){return{name:E,path:E,groupLabel:null,group:null,label:R.getText("filterbar.EDITING_STATUS"),tooltip:null,hiddenFilter:false,type:"sap.ui.model.odata.type.String",baseType:new e(),defaultFilterConditions:[{fieldPath:"$editState",operator:"DRAFT_EDIT_STATE",values:["0"]}]};}function t(o,M){var T=new J({id:D.getCustomDataProperty("localId",o,M),draftEditStateModelName:D.getCustomDataProperty("draftEditStateModelName",o,M)}),p={bindingContexts:{"this":T.createBindingContext("/")},models:{"this.i18n":R.getModel(),"this":T}};return D.templateControlFragment("sap.fe.macros.ValueHelp",p,undefined,M.targets==="xmlTree");}function l(p,N,K,B,M){var P=M.getObject(N+"/"+K+"@"),o=M.getObject(N+"/@"),q,r,I,s,u,w,x,y,G=N!==B?M.getObject(N+"@com.sap.vocabularies.Common.v1.Label")||M.getObject(N+"/@com.sap.vocabularies.Common.v1.Label")||M.getObject(N+"@sapui.name"):"",L=P["@com.sap.vocabularies.Common.v1.Label"]||K,z=N.substr(B.length);I=C.getBoolAnnotationValue(P["@com.sap.vocabularies.UI.v1.Hidden"]);u=p.$Type&&p.$Type.indexOf("Edm.")!==0;if(I||u){return false;}s=C.getBoolAnnotationValue(P["@com.sap.vocabularies.UI.v1.HiddenFilter"]);w=C.getBoolAnnotationValue(P["@com.sap.vocabularies.Common.v1.IsDigitSequence"]);if(p.$MaxLength||p.$Precision||p.$Scale||w){x={};if(p.$MaxLength){x.maxLength=p.$MaxLength;}if(p.$Precision){x.precision=p.$Precision;}if(p.$Scale){x.scale=p.$Scale;}if(w){x.isDigitSequence=w;}}else{x=null;}r=P["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(r){q=r["$"+h[p.$Type]];}if(z.indexOf("/")===0){z=z.substr(1);}var A,H,Q;if(z.split("/").length>1){Q=B+"/"+z.substr(0,z.lastIndexOf("/"));A=M.getObject(Q+"@com.sap.vocabularies.Common.v1.Label")||M.getObject(Q+"/@com.sap.vocabularies.Common.v1.Label");H=G;G=A+" > "+H;}if(z){z=z+"/";}z=z+K;y={name:z,path:z,groupLabel:G||null,group:N,label:L,tooltip:P["@com.sap.vocabularies.Common.v1.QuickInfo"]||null,hiddenFilter:s,type:d.getDataTypeClass({},p.$Type)};if(p.$Type==="Edm.DateTimeOffset"){if(!x){x={};}x.V4=true;}if(x){y.constraints=x;}if(q){y.defaultFilterConditions=[{fieldPath:K,operator:"EQ",values:[q]}];}var T=O.get(y.type||"");if(T){y.baseType=new T(y.formatOptions,y.constraints);}y.display=c.displayMode(P,o);return y;}function n(s,N,B,M){return Promise.all([D.fetchPropertiesForEntity(B,M),D.fetchAnnotationsForEntity(B,M)]).then(function(r){var o=r[0],p=r[1];if(!o){return Promise.resolve([]);}var q,P,u=[],w=[],x=[],y=[],A={},z=p["@Org.OData.Capabilities.V1.FilterRestrictions"];if(z){if(z.NonFilterableProperties){w=z.NonFilterableProperties.map(function(G){return G.$PropertyPath;});}if(z.RequiredProperties){x=z.RequiredProperties.map(function(G){return G.$PropertyPath;});}if(z.FilterExpressionRestrictions){z.FilterExpressionRestrictions.forEach(function(G){A[G.Property.$PropertyPath]=G.AllowedExpressions;});}}z=M.getObject(s+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(z){y=z.map(function(G){return G.$PropertyPath;});}for(var K in o){q=o[K];if(q){if(q.$kind==="Property"){if(w.indexOf(K)>=0){continue;}P=l(q,N,K,B,M);if(P!==false){P.required=x.indexOf(K)>=0;P.visible=y.indexOf(K)>=0;if(A[K]){P.filterExpression=A[K];}else{P.filterExpression="auto";}P.maxConditions=_(P)?-1:1;u.push(P);}}}}return u;});}g.beforeAddFilterFlex=function(p,o,P){var M=P.modifier;if(p===E){return t(o,M);}if(p===i){return Promise.resolve();}var q=P.appComponent&&P.appComponent.getModel().getMetaModel(),I=M.targets==="xmlTree",s;if(!q){return Promise.resolve(null);}s="/"+D.getCustomDataProperty("entitySet",o,M);var r=s+"/"+p,u,w,N=p.indexOf("/")>=0?p.substring(0,p.lastIndexOf("/")):"";w=N?S.generate([M.getId(o),"FF",N]):S.generate([M.getId(o),"FF"]);u=N?S.generate([M.getId(o),"FFVH",N]):S.generate([M.getId(o),"FFVH"]);var x=q.createBindingContext(r),T={bindingContexts:{"entitySet":q.createBindingContext(s),"property":x},models:{"entitySet":q,"property":q},isXml:I};function y(A){var B=new J({idPrefix:u,conditionModel:"$filters>/conditions/"+p,navigationPrefix:N?"/"+N:""}),G=m({},A,{bindingContexts:{"this":B.createBindingContext("/")},models:{"this":B}});return D.templateControlFragment("sap.fe.macros.ValueHelp",G,undefined,M.targets==="xmlTree").then(function(V){if(V){M.insertAggregation(o,"dependents",V,0);}});}function z(A){var B=new J({idPrefix:w,vhIdPrefix:u,propertyPath:p,navigationPrefix:N?"/"+N:""}),G=m({},A,{bindingContexts:{"this":B.createBindingContext("/")},models:{"this":B}});return D.templateControlFragment("sap.fe.macros.FilterField",G,undefined,M.targets==="xmlTree");}return D.checkValueHelp({sPropertyName:p,sBindingPath:s,sVHIdPrefix:"FFVH",oControl:o,oMetaModel:q,oModifier:M}).then(function(V){if(V){return y(T);}return Promise.resolve();}).then(z.bind(this,T));};g.fetchProperties=function(o){var s=o.data("entitySet"),p="/"+s,M;return D.fetchModel(o).then(function(q){if(!q){return[];}M=q.getMetaModel();if(o.getBindingContext()){p=C.getTargetCollection(o.getBindingContext(),s);}v.push(M.getObject(p+"/@sapui.name"));return n(p,p,p,M).then(function(P){if(o.data("draftEditStateModelName")){P.push(k());}if(f.checkIfBasicSearchIsVisible(o.data("hideBasicSearch")==="true",M.getObject(p+"@Org.OData.Capabilities.V1.SearchRestrictions"))){P.push(j());}return P;});});};return g;},false);
