/*!
 * @copyright@
 */
sap.ui.define(["sap/base/Log","sap/fe/navigation/SelectionVariant","sap/fe/navigation/NavError"],function(L,S,N){"use strict";var a={aValidTypes:["Edm.Boolean","Edm.Byte","Edm.Date","Edm.DateTimeOffset","Edm.Decimal","Edm.Double","Edm.Guid","Edm.Int16","Edm.Int32","Edm.Int64","Edm.SByte","Edm.Single","Edm.String","Edm.TimeOfDay"],oExcludeMap:{"Contains":"NotContains","StartsWith":"NotStartsWith","EndsWith":"NotEndsWith","Empty":"NotEmpty","NotEmpty":"Empty","LE":"NOTLE","GE":"NOTGE","LT":"NOTLT","GT":"NOTGT","BT":"NOTBT","NE":"EQ","EQ":"NE"},removeSensitiveData:function(c,d){if(!c){L.error("Context is required");return;}var p=[],i,P,C=c.getObject(),m=c.getModel().getMetaModel(),e=this._getTargetCollection(c),t=this,I=function(s,b,D){var f;b=b||e;D=D||C;f=m.getObject(b+"/"+s+"@");if(f){if(t._checkPropertyAnnotationsForSensitiveData(f)){return true;}else if(f["@com.sap.vocabularies.Common.v1.FieldControl"]){var F=f["@com.sap.vocabularies.Common.v1.FieldControl"];if(F["$EnumMember"]&&F["$EnumMember"].split("/")[1]==="Inapplicable"){return true;}else if(F["$Path"]){var o=F["$Path"],g=o.split("/");if(g.length>1){return D[g[0]]&&D[g[0]][g[1]]&&D[g[0]][g[1]]===0;}else{return D[o]===0;}}}}return false;};if(d){P=d;if(d.getMetadata&&d.getMetadata().getName()==="sap.fe.navigation.SelectionVariant"){i=true;p=d.getPropertyNames()||[];}else if(d instanceof Object){p=Object.keys(d)||[];}else{L.error("Unsupported format - Sensitive data not removed. Pass a SelectionVariant or data map");}}else{p=Object.keys(C)||[];P=JSON.parse(JSON.stringify(C));}p.forEach(function(s){if(!(C[s]instanceof Object)){if(I(s)){if(i){P.removeSelectOption(s);}else{delete P[s];}}}else{var b="/"+m.getObject(e+"/$NavigationPropertyBinding/"+s),n=i?JSON.parse(d.getSelectOption(s)[0].Low):P[s],f=Object.keys(n),g=false;f.forEach(function(h){if(I(h,b,n)){g=true;delete n[h];}});if(g){if(i){P.removeSelectOption(s);P.addSelectOption(s,"I","EQ",JSON.stringify(n));}else{P[s]=n;}}}});return P;},_checkPropertyAnnotationsForSensitiveData:function(p){return(p["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||p["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||p["@com.sap.vocabularies.Analytics.v1.Measure"]);},_getTargetCollection:function(c,n){var p=c.getPath(),P,e,b;if(c.getMetadata().getName()==="sap.ui.model.Context"&&c.getObject("$kind")==="EntitySet"){return p;}if(c.getModel){p=(c.getModel().getMetaPath&&c.getModel().getMetaPath(p))||c.getModel().getMetaModel().getMetaPath(p);}P=p.split("/").filter(Boolean);e="/"+P[0];if(P.length===1){return e;}b=typeof n==="undefined"?P[P.length-1]:n;return e+"/$NavigationPropertyBinding/"+b;},getValueTypeCompliant:function(v,t){var V;if(a.aValidTypes.indexOf(t)>-1){V=v;if(t==="Edm.Boolean"){V=v==="true"||(v==="false"?false:undefined);}else if(t==="Edm.Double"||t==="Edm.Single"){V=isNaN(v)?undefined:parseFloat(v);}else if(t==="Edm.Byte"||t==="Edm.Int16"||t==="Edm.Int32"||t==="Edm.SByte"){V=isNaN(v)?undefined:parseInt(v,10);}else if(t==="Edm.Date"){V=v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/)?v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/)[0]:v.match(/^(\d{8})/)&&v.match(/^(\d{8})/)[0];}else if(t==="Edm.DateTimeOffset"){if(v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})T(\d{1,2}):(\d{1,2}):(\d{1,2})\+(\d{1,4})/)){V=v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})T(\d{1,2}):(\d{1,2}):(\d{1,2})\+(\d{1,4})/)[0];}else if(v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})T(\d{1,2}):(\d{1,2}):(\d{1,2})/)){V=v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})T(\d{1,2}):(\d{1,2}):(\d{1,2})/)[0]+"+0000";}else if(v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/)){V=v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/)[0]+"T00:00:00+0000";}else if(v.indexOf("Z")===v.length-1){V=v.split("Z")[0]+"+0100";}else{V=undefined;}}else if(t==="Edm.TimeOfDay"){V=v.match(/(\d{1,2}):(\d{1,2}):(\d{1,2})/)?v.match(/(\d{1,2}):(\d{1,2}):(\d{1,2})/)[0]:undefined;}}return V;},createConditions:function(o,v,V,s){var b=v,c,i,C={isEmpty:null,values:[]};if(v===undefined||v===null){return;}switch(o){case"CP":i="Contains";if(b){var n=b.indexOf("*");var d=b.lastIndexOf("*");if(n>-1){if(n===0&&d!==b.length-1){i="EndsWith";b=b.substring(1,b.length);}else if(n!==0&&d===b.length-1){i="StartsWith";b=b.substring(0,b.length-1);}else{b=b.substring(1,b.length-1);}}else{L.warning("Contains Option cannot be used without '*'.");return;}}break;case"EQ":i=v===""?"Empty":o;break;case"NE":i=v===""?"NotEmpty":o;break;case"BT":if(V===undefined||V===null){return;}c=V;i=o;break;case"LE":case"GE":case"GT":case"LT":i=o;break;default:L.warning("Selection Option is not supported : '"+o+"'");return;}if(s==="E"){i=a.oExcludeMap[i];}C.operator=i;C.values.push(b);if(c){C.values.push(c);}return C;},addSelectionVariantToConditions:function(s,c,v){var b=s.getSelectOptionsPropertyNames();b.forEach(function(p){if(p in v){var C=[],d=s.getSelectOption(p);C=d.reduce(function(C,o){var V=a.getValueTypeCompliant(o.Low,v[p].$Type),e=o.High?a.getValueTypeCompliant(o.High,v[p].$Type):undefined;if((V!==undefined||V!==null)&&o.Option){C.push(a.createConditions(o.Option,V,e,o.Sign));}return C;},[]);if(C.length){c[p]=c.hasOwnProperty(p)?c[p].concat(C):C;}}});return c;},addDefaultDisplayCurrency:function(m,A){if(A&&A.oSelectionVariant&&m&&m.length){for(var i=0;i<m.length;i++){var s=A.oSelectionVariant.getSelectOption("DisplayCurrency"),d=A.oDefaultedSelectionVariant&&A.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency");if(m[i].$PropertyPath==="DisplayCurrency"&&(!s||!s.length)&&d&&d.length){var b=d[0];var c=b["Sign"];var o=b["Option"];var l=b["Low"];var h=b["High"];A.oSelectionVariant.addSelectOption("DisplayCurrency",c,o,l,h);}}}},mixAttributesAndSelectionVariant:function(s,b,c){var o=new S(b);var n=new S();if(o.getFilterContextUrl()){n.setFilterContextUrl(o.getFilterContextUrl());}if(o.getParameterContextUrl()){n.setParameterContextUrl(o.getParameterContextUrl());}for(var p in s){if(s.hasOwnProperty(p)){var v=s[p];if(jQuery.type(v)==="array"||jQuery.type(v)==="object"){v=JSON.stringify(v);}else if(jQuery.type(v)==="date"){v=v.toJSON();}else if(jQuery.type(v)==="number"||jQuery.type(v)==="boolean"){v=v.toString();}if(v===""){if(c&sap.fe.navigation.SuppressionBehavior.ignoreEmptyString){L.info("Semantic attribute "+p+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue;}}if(v===null){if(c&sap.fe.navigation.SuppressionBehavior.raiseErrorOnNull){throw new N("NavigationHandler.INVALID_INPUT");}else{L.warning("Semantic attribute "+p+" is null and ignored for mix in to selection variant");continue;}}if(v===undefined){if(c&sap.fe.navigation.SuppressionBehavior.raiseErrorOnUndefined){throw new N("NavigationHandler.INVALID_INPUT");}else{L.warning("Semantic attribute "+p+" is undefined and ignored for mix in to selection variant");continue;}}if(jQuery.type(v)==="string"){n.addSelectOption(p,"I","EQ",v);}else{throw new N("NavigationHandler.INVALID_INPUT");}}}var P=o.getParameterNames();for(var i=0;i<P.length;i++){if(!n.getSelectOption(P[i])){n.addSelectOption(P[i],"I","EQ",o.getParameter(P[i]));}}var d=o.getSelectOptionsPropertyNames();for(i=0;i<d.length;i++){var e=o.getSelectOption(d[i]);for(var j=0;j<e.length;j++){n.addSelectOption(d[i],e[j].Sign,e[j].Option,e[j].Low,e[j].High);}}return n;},addExternalStateFiltersToSelectionVariant:function(s,f){var F,l="",h=null;var g=function(O,d,H){var e={option:"",sign:"I",low:d,high:H};switch(O){case"Contains":e.option="CP";break;case"StartsWith":e.option="CP";e.low+="*";break;case"EndsWith":e.option="CP";e.low="*"+e.low;break;case"BT":case"LE":case"LT":case"GT":case"NE":case"EQ":e.option=O;break;case"EEQ":e.option="EQ";break;case"Empty":e.option="EQ";e.low="";break;case"NotContains":e.option="CP";e.sign="E";break;case"NOTBT":e.option="BT";e.sign="E";break;case"NotStartsWith":e.option="CP";e.low+="*";e.sign="E";break;case"NotEndsWith":e.option="CP";e.low="*"+e.low;e.sign="E";break;case"NotEmpty":e.option="NE";e.low="";break;case"NOTLE":e.option="LE";e.sign="E";break;case"NOTGE":e.option="GE";e.sign="E";break;case"NOTLT":e.option="LT";e.sign="E";break;case"NOTGT":e.option="GT";e.sign="E";break;default:L.warning(O+" is not supported. "+F+" could not be added to the navigation context");}return e;};f=f.filter||f;for(var F in f){if(F==="$editState"){continue;}var b=f[F];for(var i in b){var o=b[i];l=o.values[0].toString();h=(o.values[1]&&o.values[1].toString())||null;var c=g(o.operator,l,h);if(c.option){s.addSelectOption(F,c.sign,c.option,c.low,c.high);}}}return s;}};return a;});
