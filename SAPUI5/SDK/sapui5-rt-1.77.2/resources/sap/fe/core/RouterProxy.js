/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ui/core/routing/HashChanger","sap/ui/base/EventProvider","sap/fe/core/Synchronization"],function(L,B,A,H,E,S){"use strict";var e={EQUAL:0,COMPATIBLE:1,ANCESTOR:2,DIFFERENT:3};var a={LAYOUTPARAM:"layout",IAPPSTATEPARAM:"sap-iapp-state"};return B.extend("sap.fe.core.RouterProxy",{bIsRebuildHistoryRunning:false,bIsComputingTitleHierachy:false,oNavigationGuardState:null,bIsGuardCrossAllowed:false,sIAppStateKey:null,init:function(o){var f=sap.ushell.Container.getService("URLParsing").splitHash(window.location.hash).shellPart;this.initRaw(o.getRouter(),f);this._initRoutesInfo(o);this._oRouteMatchSynchronization=new S();this._bActivateRouteMatchSynchro=false;history.replaceState(Object.assign({feLevel:0},history.state),null,window.location);},initRaw:function(r,f){this._oRouter=r;this._oManagedHistory=[];this._sFlpAppName=f;var c=this._oRouter.getHashChanger().getHash();this._oManagedHistory.push(this._extractStateFromHash(c));this.sIAppStateKey=this._findAppStateInHash(c);},_initRoutesInfo:function(o){var m=o.getManifest(),r=m["sap.ui5"].routing.routes,t=m["sap.ui5"].routing.targets,b=this;this._aRoutesWithoutAppState=[];r.forEach(function(R){if(!Array.isArray(R.target)){var T=t[R.target];if(T.name!=="sap.fe.templates.ListReport"){b._aRoutesWithoutAppState.push(R.name);}}});},navToHash:function(h,p){var t=this;if(this._oRouteMatchSynchronization){return this._oRouteMatchSynchronization.waitFor().then(function(){t._oRouteMatchSynchronization=null;return t._internalNavToHash(h,p);});}else{if(this._bActivateRouteMatchSynchro){this._oRouteMatchSynchronization=new S();this._bActivateRouteMatchSynchro=false;}return t._internalNavToHash(h,p);}},_internalNavToHash:function(h,p){var t=this,l=sap.ui.getCore().getCurrentFocusedControlId(),s=l&&sap.ui.getCore().byId(l)?sap.ui.getCore().byId(l).getFocusInfo():null,b=window.location.hash;var r=this._oRouter.getRouteInfoByHash(h);if(this.sIAppStateKey&&!this._findAppStateInHash(h)&&r&&this._aRoutesWithoutAppState.indexOf(r.name)===-1){h=this._setAppStateInHash(h,this.sIAppStateKey);}var n=this._extractStateFromHash(h);if(!this._checkNavigationGuard(n)){if(!this.oResourceBundle){this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");}if(!confirm(this.oResourceBundle.getText("SAPFE_EXIT_NOTSAVED_MESSAGE"))){return Promise.resolve();}this.bIsGuardCrossAllowed=true;}this._pushNewState(n,p);return this._rebuildBrowserHistory(h).then(function(){t.storeFocusForHash(l,s,b);});},storeFocusForHash:function(l,s,b){var m=this._oManagedHistory;for(var i=0;i<m.length;i++){var h="#"+m[i].hash;if(b===h||h===b+"&/"){m[i].oLastFocusControl={controlId:l,focusInfo:s};break;}}},navTo:function(r,p){var h=this._oRouter.getURL(r,p);return this.navToHash(h);},exitFromApp:function(){return new Promise(function(r,b){var x=sap.ushell.Container.getService("CrossApplicationNavigation");x.backToPreviousApp();r();});},isCurrentStateImpactedBy:function(h){var s=this._extractStateFromHash(h);return this._compareCacheStates(s,this._oManagedHistory[this._oManagedHistory.length-1])!==e.DIFFERENT;},isNavigationFinalized:function(){return!this.bIsRebuildHistoryRunning;},setNavigationGuard:function(){var c=this._sFlpAppName+"&/"+this._oRouter.getHashChanger().getHash();var i=-1;this._oManagedHistory.forEach(function(h,_){if(h.hash===c){i=_;}});if(i!==-1){while(i>0&&this._compareStateKeys(this._oManagedHistory[i-1],this._oManagedHistory[i])){i--;}this.oNavigationGuardState=this._oManagedHistory[i];this.bIsGuardCrossAllowed=false;}else{throw new Error("current hash has no entry in Managed cache !!!");}},discardNavigationGuard:function(){this.oNavigationGuardState=null;},checkHashWithGuard:function(h){if(this.oNavigationGuardState===null){return true;}var n=this._extractStateFromHash(h);return this._checkNavigationGuard(n);},isGuardCrossAllowedByUser:function(){return this.bIsGuardCrossAllowed;},_checkNavigationGuard:function(s){if(this.oNavigationGuardState===null){return true;}var c=this._compareCacheStates(this.oNavigationGuardState,s);return c!==e.DIFFERENT;},activateRouteMatchSynchronization:function(){this._bActivateRouteMatchSynchro=true;},resolveRouteMatch:function(){if(this._oRouteMatchSynchronization){this._oRouteMatchSynchronization.resolve();}},_extractStateFromHash:function(h){var s={keys:[]};var b=h.split("?")[0];var t=b.split("/");t.forEach(function(T){var r=/[^\(\)]+\([^\(\)]+\)/;if(r.test(T)){T=T.substring(0,T.length-1);var n={keyID:T.split("(")[0]};var k=T.split("(")[1].split(",");if(k.length>1){k.forEach(function(v){var c=v.split("=");n[c[0]]=c[1];});}else{n["ID"]=T.split("(")[1];}s.keys.push(n);}});var l=h.match(new RegExp("\\?.*"+a.LAYOUTPARAM+"=([^&]*)"));s.sLayout=l&&l.length>1?l[1]:null;if(s.sLayout==="MidColumnFullScreen"){s.screenMode=1;}else if(s.sLayout==="EndColumnFullScreen"){s.screenMode=2;}else{s.screenMode=0;}s.hash=this._sFlpAppName+"&/"+h;return s;},_pushNewState:function(n,p){var c=this._extractStateFromHash(this._oRouter.getHashChanger().getHash()),l=this._oManagedHistory.length-1,t=this;while(l>=0&&this._compareCacheStates(this._oManagedHistory[l],c)!==e.EQUAL){this._oManagedHistory.pop();l--;}if(this._oManagedHistory.length===0){this._oManagedHistory.push(c);history.replaceState(Object.assign({feLevel:0},history.state),null,window.location);}var o;while(this._oManagedHistory.length>0&&this._compareCacheStates(this._oManagedHistory[this._oManagedHistory.length-1],n)!==e.ANCESTOR&&!p){o=this._oManagedHistory[this._oManagedHistory.length-1].oLastFocusControl;this._oManagedHistory.pop();}var s=this._findAppStateInHash(n.hash);if(s&&this.sIAppStateKey!==s){this.sIAppStateKey=s;this._oManagedHistory.forEach(function(m){m.hash=t._setAppStateInHash(m.hash,s);});}n.oLastFocusControl=o;this._oManagedHistory.push(n);},_findAppStateInHash:function(h){var b=h.match(new RegExp("\\?.*"+a.IAPPSTATEPARAM+"=([^&]*)"));return b&&b.length>1?b[1]:null;},_setAppStateInHash:function(h,s){var n;if(h.indexOf(a.IAPPSTATEPARAM)>=0){n=h.replace(new RegExp(a.IAPPSTATEPARAM+"=[^&]*"),a.IAPPSTATEPARAM+"="+s);}else{if(h.indexOf("?")<0){n=h+"?";}else{n=h+"&";}n+=a.IAPPSTATEPARAM+"="+s;}return n;},_disableEventOnHashChange:function(){this._oRouter.stop();},_enableEventOnHashChange:function(i){this._oRouter.initialize(i);},_rebuildBrowserHistory:function(n){var t=this;return new Promise(function(r,b){if(t.bIsRebuildHistoryRunning===true){L.warning("_rebuildBrowserHistory already running ... Add this call to the pool");if(!t.rebuildHistoryPool){t.rebuildHistoryPool=[];}t.rebuildHistoryPool.push(n);r();return;}t.bIsRebuildHistoryRunning=true;function c(){if(t._oManagedHistory[0].hash.indexOf("&/")===-1){t._oManagedHistory[0].hash+="&/";}var s=Object.assign({},history.state);s.sap=Object.assign({},history.state.sap);if(!s.sap.history){s.sap.history=[];}if(t._oManagedHistory.length===1){t._enableEventOnHashChange(true);window.location.replace("#"+t._oManagedHistory[0].hash);history.replaceState(Object.assign(s,{feLevel:0}),null,"#"+t._oManagedHistory[0].hash);}else{history.replaceState(Object.assign(s,{feLevel:0}),null,"#"+t._oManagedHistory[0].hash);var i=1;while(i<t._oManagedHistory.length-1){s.sap.history=s.sap.history.concat();s.sap.history.push(t._oManagedHistory[i].hash);history.pushState(Object.assign(s,{feLevel:i}),null,"#"+t._oManagedHistory[i].hash);i++;}t._enableEventOnHashChange(true);window.location="#"+t._oManagedHistory[i].hash;s.sap.history=s.sap.history.concat();s.sap.history.push(t._oManagedHistory[i].hash);history.replaceState(Object.assign(s,{feLevel:t._oManagedHistory.length-1}),null,"#"+t._oManagedHistory[i].hash);}t.bIsRebuildHistoryRunning=false;if(t.rebuildHistoryPool&&t.rebuildHistoryPool.length>0){var l=t.rebuildHistoryPool[0];t.rebuildHistoryPool.shift();t._rebuildBrowserHistory(l);}r();}function d(){if(history.state.feLevel===0){window.removeEventListener("popstate",d);c();}else{history.back();}}t._disableEventOnHashChange();if(!history.state||history.state.feLevel===undefined){window.addEventListener("popstate",d);history.back();}else if(history.state.feLevel!==0){window.addEventListener("popstate",d);history.go(-history.state.feLevel);}else{c();}});},_compareCacheStates:function(s,o){if(s.keys.length>o.keys.length){return e.DIFFERENT;}var b=true;var i;for(i=0;b&&i<s.keys.length;i++){if(s.keys[i].keyID!==o.keys[i].keyID||s.keys[i].ID!==o.keys[i].ID){b=false;}}if(!b){return e.DIFFERENT;}if(s.keys.length<o.keys.length||s.screenMode<o.screenMode){return e.ANCESTOR;}if(s.screenMode>o.screenMode){return e.DIFFERENT;}for(i=0;b&&i<s.keys.length;i++){if(s.keys[i].IsActiveEntity!==o.keys[i].IsActiveEntity){b=false;}}if(!b||s.sLayout!==o.sLayout){return e.COMPATIBLE;}else{return e.EQUAL;}},_compareStateKeys:function(s,o){if(s.keys.length!=o.keys.length){return false;}var b=true;var i;for(i=0;b&&i<s.keys.length;i++){if(s.keys[i].keyID!==o.keys[i].keyID||s.keys[i].ID!==o.keys[i].ID){b=false;}}return b;},checkIfBackIsOutOfGuard:function(){var t=this,p,P=this._sFlpAppName+"&/"+t._oRouter.getHashChanger().getHash();if(t.oNavigationGuardState&&t._oManagedHistory){for(var i=t._oManagedHistory.length-1;i>0;i--){if(t._oManagedHistory[i].hash===P){p=t._oManagedHistory[i-1].hash;break;}}return!p||!t.checkHashWithGuard(p.split(this._sFlpAppName+"&/")[1]);}return false;}});});
