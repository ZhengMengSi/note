/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/actions/messageHandling","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/sticky","sap/fe/core/TransactionHelper","sap/base/Log","sap/m/Text","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/routing/HashChanger","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/base/util/merge","sap/fe/macros/SideEffectsUtil","sap/fe/library"],function(C,m,X,a,F,s,T,L,b,B,D,J,H,c,d,e,S,f){"use strict";var g=f.core.CreationMode,h="sap.fe.core.controls.field.DraftPopOverAdminData",p=X.loadTemplate(h,"fragment"),t={};var E=C.extend("sap.fe.core.controllerextensions.EditFlow",{override:{onExit:function(){this.getUIStateModel().destroy();C.prototype.destroy.apply(this,arguments);}},syncTask:function(v){var n;if(v instanceof Promise){n=function(){return v;};}else if(typeof v==="function"){n=v;}this._pTasks=this._pTasks||Promise.resolve();if(!!n){this._pTasks=this._pTasks.then(n).catch(function(){return Promise.resolve();});}return this._pTasks;},getProgrammingModel:function(o){return this.getTransactionHelper().getProgrammingModel(o);},createDocument:function(l,P){var i=this,j=this.getTransactionHelper(),o=j.getUIStateModel(),r=i.base.getView().getController().oResourceBundle,k=!P||(P.creationMode!==g.Inline&&P.creationMode!==g.CreationRow);function n(q,u){u.then(function(N){var v=i.base.getView().getBindingContext();if(!c.hasTransientContext(q)){i.requestSideEffects(q.getPath(),v);}});}k&&d.lock(o);return this.syncTask().then(function(){return new Promise(function(q,u){var G,v,w,M;P=P||{};if(typeof l==="object"){G=Promise.resolve(l);}else{throw new Error("Binding object expected");}G.then(function(x){w=x;M=w.getModel();var y=P.creationMode;if((!y||y===g.NewPage)&&i.base.getView().getViewData()._creationMode==="Inplace"){y=g.Inline;}return j.getProgrammingModel(w).then(function(z){v=z;if(y&&y!==g.NewPage){return y;}else{switch(v){case"Draft":case"Sticky":if(!w.isRelative()){var A=M.getMetaModel(),I=w.getPath(),N=v==="Draft"?A.getObject(I+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction"):A.getObject(I+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction"),K=(N&&A.getObject("/"+N+"/@$ui5.overload/0/$Parameter"))||[];if(K.length>1){return"Deferred";}}return g.Async;case"NonDraft":return g.Sync;}}});}).then(function(x){var y,A,z=P.creationRow,I,V=Promise.resolve(),K,N,O=M.getMetaModel();if(x!==g.Deferred){if(x===g.CreationRow){I=z.getBindingContext();N=O.getMetaPath(I.getPath());K=I.getObject();P.data={};Object.keys(K).forEach(function(U){var W=O.getObject(N+"/"+U);if(W&&W.$kind==="NavigationProperty"){return;}P.data[U]=K[U];});V=i.checkForValidationErrors(I);}if(x===g.CreationRow||x===g.Inline){P.keepTransientContextOnFailed=true;P.busyMode="Local";if(x===g.CreationRow){P.busyMode="None";}if(x===g.Inline){P.keepTransientContextOnFailed=false;}i.handleCreateEvents(w);}y=V.then(function(){if(!P.parentControl){P.parentControl=i.base.getView();}return j.createDocument(w,P,r);});}var Q=new Promise(function(q){switch(x){case g.Deferred:i.base.routing.navigateForwardToContext(w,{deferredContext:true,noHistoryEntry:P.noHistoryEntry,editable:true}).then(function(){q();});break;case g.Async:i.base.routing.navigateForwardToContext(w,{asyncContext:y,noHistoryEntry:P.noHistoryEntry,editable:true}).then(function(){q();});break;case g.Sync:A={noHistoryEntry:P.noHistoryEntry,editable:true};if(v=="Sticky"){A.transient=true;}y.then(function(U){if(!U){var r,W;r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");W=c.getAppComponent(i.base.getView()).getRootControl();i.base.routing.navigateToMessagePage(r.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:r.getText("SAPFE_ERROR"),description:r.getText("SAPFE_CREATION_FAILED_DESCRIPTION"),navContainer:W});}else{i.base.routing.navigateForwardToContext(U,A).then(function(){q();});}});break;case g.Inline:n(w,y);q();break;case g.CreationRow:V.then(function(){var U=I.getBinding(),W;n(w,y);W=U.create();z.setBindingContext(W);W.created().catch(function(){L.trace("transient fast creation context deleted");});I.delete("$direct");});q();break;default:L.error("Unhandled creationMode "+x);break;}});var R=i.base.getView().getModel("localUI");if(v==="Sticky"){R.setProperty("/sessionOn",true);}if(y){Promise.all([y,Q]).then(function(U){i.setEditMode("Editable",true);var W=U[0];if(W){i.base.routing.setUIStateDirty();if(v==="Sticky"){i._handleStickyOn(W);}}q();},function(){u();});}else{q();}});});}).finally(function(){k&&d.unlock(o);});},editDocument:function(o){var i=this,j=this.getTransactionHelper();return j.editDocument(o).then(function(n){j.getProgrammingModel(o).then(function(P){var N;if(P==="Sticky"){var l=i.base.getView().getModel("localUI");l.setProperty("/sessionOn",true);N=true;}i.setEditMode("Editable",false);if(n!==o){i.handleNewContext(n,true,N,true,true,true).then(function(){if(P==="Sticky"){i._handleStickyOn(n);}});}});});},saveDocument:function(o){var i=this,j=this.getTransactionHelper(),r=i.base.getView().getController().oResourceBundle;return(this.syncTask().then(this._submitOpenChanges.bind(this,o)).then(this.checkForValidationErrors.bind(this,o)).then(j.saveDocument.bind(j,o,r)).then(function(A){return j.getProgrammingModel(o).then(function(P){var n;if(P==="Sticky"){var l=i.base.getView().getModel("localUI");l.setProperty("/sessionOn",false);i._handleStickyOff(o);if(o.getPath()===A.getPath()){n=true;}}i.setEditMode("Display",false);if(A!==o){i.handleNewContext(A,true,n,false,true,false);}});}));},cancelDocument:function(o,P){var i=this,j=this.getTransactionHelper(),r=i.base.getView().getController().oResourceBundle;this.syncTask().then(j.cancelDocument.bind(j,o,P,r)).then(function(A){j.getProgrammingModel(o).then(function(k){var n;if(k==="Sticky"){var l=i.base.getView().getModel("localUI");l.setProperty("/sessionOn",false);i._handleStickyOff(o);n=true;}i.setEditMode("Display",false);if(!A){i.base.routing.setUIStateDirty();i.base.routing.navigateBackFromContext(o);}else{i.handleNewContext(A,true,n,false,true,true);}});});},requestSideEffects:function(n,o){var M=this.base.getView().getModel().getMetaModel(),i="/"+M.getObject(M.getMetaPath(o.getPath()))["$Type"],A=M.getObject(i+"@"),j=Object.keys(A).filter(function(r){return r.indexOf("@com.sap.vocabularies.Common.v1.SideEffects")>-1;}),k=[],P,l=[],q=[];j.forEach(function(r){var u=A[r];if(u.SourceEntities){u.SourceEntities.forEach(function(v){if(v["$NavigationPropertyPath"]===n){k.push(r);}});}if(u.SourceProperties&&k.indexOf(r)===-1){u.SourceProperties.forEach(function(v){if(k.indexOf(r)===-1&&v["$PropertyPath"].indexOf(n+"/")===0){k.push(r);}});}});k.forEach(function(r){var u=[],v=A[r],w=v.TargetProperties||[],x=v.TargetEntities||[];w=w.map(function(y){return y["$PropertyPath"];}).filter(function(y){return l.indexOf(y)<0;});w.forEach(function(y){var z=M.getObject(i+"/"+y+"@com.sap.vocabularies.Common.v1.Text");if(z&&z["$Path"]){u.push(z["$Path"]);}});x=x.map(function(y){return y["$NavigationPropertyPath"];}).filter(function(y){return q.indexOf(y)<0;});l=l.concat(w).concat(u);q=q.concat(x);});P=l.map(function(r){return{"$PropertyPath":r};}).concat(q.map(function(r){return{"$NavigationPropertyPath":r};}));if(P.length){P=S.replaceEmptyNavigationPaths(P);S.logRequest({context:o,pathExpressions:P});o.requestSideEffects(P);}},deleteSingleDocument:function(o,P){var i=this;this._deleteDocumentTransaction(o,P).then(function(){i.base.routing.setUIStateDirty();i.base.routing.navigateBackFromContext(o);});},deleteMultipleDocuments:function(o,P){var i=this;this._deleteDocumentTransaction(o,P).then(function(){var j=i.getView().byId(P.controlId);if(j&&j.isA("sap.ui.mdc.Table")){j.clearSelection();}var k=i.base.getView().getBindingContext();if(k&&Array.isArray(o)){var l=o[0].getBinding();if(!c.hasTransientContext(l)){i.requestSideEffects(l.getPath(),k);}}i.base.routing.setUIStateDirty();var A=c.getAppComponent(i.base.getView());var r=A.getRouterProxy();var I=false;for(var n=0;!I&&n<o.length;n++){if(r.isCurrentStateImpactedBy(o[n].getPath())){I=true;i.base.routing.navigateBackFromContext(o[n]);}}});},_deleteDocumentTransaction:function(o,P){var i=this,l=this.base.getView().getModel("localUI"),r=this.base.getView().getController().oResourceBundle,j=this.getTransactionHelper();P=P||{};return this.syncTask().then(j.deleteDocument.bind(j,o,P,l,r)).then(function(){var l=i.base.getView().getModel("localUI");l.setProperty("/sessionOn",false);});},applyDocument:function(o){var i=this,u=this.getTransactionHelper().getUIStateModel(),r=this.base.getView().getController().oResourceBundle;d.lock(u);return this._submitOpenChanges(o).then(function(){m.showUnboundMessages();i.base.routing.navigateBackFromContext(o);return true;}).catch(function(j){var k=[];k.push({text:c.getTranslatedText("SAPFE_APPLY_ERROR",r),type:"Error"});m.showUnboundMessages(k);return false;}).finally(function(){d.unlock(u);});},_submitOpenChanges:function(o){var M=o.getModel(),v=this.base&&this.base.getView(),l=v&&v.getModel("localUI"),i=l.getProperty("/batchGroups");if(!i.length){return Promise.resolve();}var P=[];i.forEach(function(G){P.push(M.submitBatch(G));});return Promise.all(P).then(function(){if(i.some(M.hasPendingChanges.bind(M))){return Promise.reject("submit of open changes failed");}});},_handleStickyOn:function(o){var i=this,A=c.getAppComponent(this.base.getView());if(!this.bStickyOn){this.bStickyOn=true;var j=H.getInstance().getHash(),l=this.base.getView().getModel("localUI");setTimeout(function(){A.getRouterProxy().setNavigationGuard();},0);if(sap.ushell){A.getService("ShellUIService").then(function(n){n.setBackNavigation(i.onBackNavigationInSession.bind(i));});this.fnDirtyStateProvider=function(){var n=H.getInstance().getHash(),r=A.getRouterProxy(),q,u=l.getProperty("/sessionOn");if(!u){return;}if(!r.isNavigationFinalized()){q=false;j=n;}else if(j===n){q=true;}else if(r.checkHashWithGuard(n)||r.isGuardCrossAllowedByUser()){j=n;q=false;}else{q=true;}if(q){setTimeout(function(){sap.ushell.Container.setDirtyFlag(false);},0);}return q;};sap.ushell.Container.registerDirtyStateProvider(this.fnDirtyStateProvider);}var k=this.base.getView().getModel("sap.fe.i18n");this.fnHandleSessionTimeout=function(){m.removeBoundTransitionMessages();m.removeUnboundTransitionMessages();var n=new D({title:"{sap.fe.i18n>OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new b({text:"{sap.fe.i18n>OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new B({text:"{sap.fe.i18n>SAPFE_OK}",type:"Emphasized",press:function(){i._handleStickyOff();i.base.routing.navigateBackFromContext(o);}}),afterClose:function(){n.destroy();}});n.addStyleClass("sapUiContentPadding");n.setModel(k,"sap.fe.i18n");i.base.getView().addDependent(n);n.open();};this.base.getView().getModel().attachSessionTimeout(this.fnHandleSessionTimeout);this.fnStickyDiscardAfterNavigation=function(){var n=H.getInstance().getHash();if(!n||!A.getRouterProxy().checkHashWithGuard(n)){i.fnStickyDiscard(o);}};this.base.routing.attachOnAfterNavigation(this.fnStickyDiscardAfterNavigation);}},_handleStickyOff:function(){var A=c.getAppComponent(this.base.getView());if(A.getRouterProxy){A.getRouterProxy().discardNavigationGuard();}if(sap.ushell){if(this.fnDirtyStateProvider){sap.ushell.Container.deregisterDirtyStateProvider(this.fnDirtyStateProvider);this.fnDirtyStateProvider=null;}}if(this.base.getView().getModel()&&this.fnHandleSessionTimeout){this.base.getView().getModel().detachSessionTimeout(this.fnHandleSessionTimeout);}this.base.routing.detachOnAfterNavigation(this.fnStickyDiscardAfterNavigation);this.fnStickyDiscardAfterNavigation=null;this.setEditMode("Display",false);this.bStickyOn=false;if(A.getService){A.getService("ShellUIService").then(function(o){o.setBackNavigation();});}},handleNewContext:function(o,n,N,i,P,u){this.base.routing.setUIStateDirty();return this.base.routing.navigateToContext(o,{noHistoryEntry:n,noHashChange:N,editable:i,bPersistOPScroll:P,useHash:u});},onCallAction:function(A,P){var i=this,j=this.getTransactionHelper();P.localUIModel=i.base.getView().getModel("localUI");if(!P.parentControl){P.parentControl=this.base.getView();}return this.syncTask().then(j.onCallAction.bind(j,A,P)).then(function(){if(P.contexts){i.base.routing.setUIStateDirty();}});},formatDraftOwnerText:function(i,j,k,l,n){var o="";var u=j||i||l||k;if(n){o+=i?c.getTranslatedText("DRAFTINFO_GENERIC_LOCKED_OBJECT_POPOVER_TEXT")+" ":c.getTranslatedText("DRAFTINFO_LAST_CHANGE_USER_TEXT")+" ";}o+=u?c.getTranslatedText("DRAFTINFO_OWNER",null,[u]):c.getTranslatedText("DRAFTINFO_ANOTHER_USER");return o;},formatDraftOwnerTextInline:function(i,j,k,l){return this.formatDraftOwnerText(i,k,j,l,false);},formatDraftOwnerTextInPopover:function(i,j,k,l){return this.formatDraftOwnerText(i,k,j,l,true);},onDraftLinkPressed:function(o,i){var j=this,k=o.getSource(),l=k.getBindingContext(),v=this.base.getView(),M=v.getModel().getMetaModel(),n=v.getController(),O=function(){var P=j._oPopover.getModel("draftInfo");P.setProperty("/bIsActive",l.getProperty("IsActiveEntity"));P.setProperty("/bHasDraft",l.getProperty("HasDraftEntity"));j._oPopover.getModel().bindContext(l.getPath(),undefined,{$$groupId:"$auto.veryHigh"});j._oPopover.openBy(k);};if(!this._oPopover||!this._oPopover.oPopup){Promise.resolve(j._oFragment||a.process(p,{name:h},{bindingContexts:{entitySet:M.createBindingContext("/"+i)},models:{entitySet:M}})).then(function(q){j._oFragment=q;return F.load({definition:q,controller:n});}).then(function(P){j._oPopover=P;v.addDependent(j._oPopover);var q=new J({bIsActive:undefined,bHasDraft:undefined});j._oPopover.setModel(q,"draftInfo");O();});}else{O();}},closeDraftAdminPopover:function(){this._oPopover.close();},handlePatchEvents:function(o){var i=this,j=this.getTransactionHelper(),k=j.getUIStateModel();k.setProperty("/draftStatus","Clear");return j.getProgrammingModel(o).then(function(P){o=(o.getBinding&&o.getBinding())||o;o.attachEvent("patchSent",function(){j.handleDocumentModifications();i.base.routing.setUIStateDirty();if(P==="Draft"){k.setProperty("/draftStatus","Saving");}});o.attachEvent("patchCompleted",function(l){if(P==="Draft"){k.setProperty("/draftStatus",l.getParameter("success")?"Saved":"Clear");}m.showUnboundMessages();});});},handleCreateEvents:function(o){var i=this.getTransactionHelper(),j=i.getUIStateModel();j.setProperty("/draftStatus","Clear");return i.getProgrammingModel(o).then(function(P){o=(o.getBinding&&o.getBinding())||o;o.attachEvent("createSent",function(){i.handleDocumentModifications();if(P==="Draft"){j.setProperty("/draftStatus","Saving");}});o.attachEvent("createCompleted",function(k){if(P==="Draft"){j.setProperty("/draftStatus",k.getParameter("success")?"Saved":"Clear");}m.showUnboundMessages();});});},handleErrorOfTable:function(o){if(o.getParameter("error")){setTimeout(m.showUnboundMessages,0);}},getUIStateModel:function(i){if(!this.editFlowStateModel){this.editFlowStateModel=new J({createMode:false});}if(i){this.editFlowStateModel.setData(e(this.editFlowStateModel.getData(),i));}return this.editFlowStateModel;},computeEditMode:function(o){var i=this;return new Promise(function(r,j){var k=i.getUIStateModel();i.getTransactionHelper().getProgrammingModel(o).then(function(P){if(P==="Draft"){o.requestObject("IsActiveEntity").then(function(I){if(I===false){i.setEditMode("Editable");o.requestObject("HasActiveEntity").then(function(l){if(l){k.setProperty("/createMode",false);}else{k.setProperty("/createMode",true);}r();});}else{i.setEditMode("Display");r();}});}else{r();}});});},setEditMode:function(i,j){var o=this.getUIStateModel(),k=this.getTransactionHelper().getUIStateModel();if(i){k.setProperty("/editable",i);}if(j!==undefined){o.setProperty("/createMode",j);}},checkForValidationErrors:function(o){return this.syncTask().then(function(){var P=o.getPath(),M=sap.ui.getCore().getMessageManager().getMessageModel().getData(),j,k;for(var i=0;i<M.length;i++){k=M[i];if(k.validation){j=sap.ui.getCore().byId(k.getControlId());if(j&&j.getBindingContext()&&j.getBindingContext().getPath().indexOf(P)===0){return Promise.reject("validation errors exist");}}}});},getTransactionHelper:function(){if(!this._oTransactionHelper){var A=c.getAppComponent(this.base.getView()),i=A.getId();if(!t[i]){var o=new T();o.initialize(A);t[i]=o;}this._oTransactionHelper=t[i];}return this._oTransactionHelper;},onBackNavigationInSession:function(){var i=this,v=i.base.getView(),A=c.getAppComponent(v),r=A.getRouterProxy();if(r.checkIfBackIsOutOfGuard()){var o=v&&v.getBindingContext();i.getTransactionHelper().getProgrammingModel(o).then(function(j){c.processDataLossConfirmation(function(){i.fnStickyDiscard(o);history.back();},v,j);});return;}history.back();},fnStickyDiscard:function(o){s.discardDocument(o);this._handleStickyOff();}});E.onExitApplication=function(A){var o=t[A];o&&o.destroy();delete t[A];};return E;});
