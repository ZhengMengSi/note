/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/p13n/StateUtil","sap/fe/navigation/navigationLibrary","sap/fe/core/CommonUtils","sap/fe/navigation/NavigationHelper","sap/ui/core/routing/HashChanger","sap/base/Log"],function(S,N,C,a,H,L){"use strict";var A={bIsAppStateReady:false,sNavType:null,init:function(){this.bIsAppStateReady=false;},createAppState:function(c){var o=C.getAppComponent(c.getView());var v=c.getView().getViewData();var m=c.getView().getModel().getMetaModel();var i=o.getRootViewController().isFclEnabled();var e=v.entitySet;var r=o.getRouterProxy();var h=H.getInstance().getHash();var t=this;var T;if((v.viewLevel===0||i)&&c.getView().getViewData().variantManagement!=="None"&&this._getIsAppStateReady()&&this.sNavType!=="initial"&&this.sNavType!=="xAppState"&&this.sNavType!=="URLParams"){T="LR";var f=this.createKeyForAppStateData(T,[e],"FilterBar");var I={};var V,b;var F=c.getView().byId(c.getView().getContent()[0].data("filterBarId"));switch(c.getView().getViewData().variantManagement){case"Page":b=c.getView().byId("fe::lr::vm");V=this.createKeyForAppStateData(T,[e],"Variant");break;case"None":L.debug("AppState handling is currently only working with Page VM");break;case"Control":L.debug("Variant Management is set to Control VM which does not support the AppState handling yet");break;default:L.error("Variant Management not correctly defined, variable wrongly set to: "+c.getView().getViewData().variantManagement);break;}S.retrieveExternalState(F).then(function(E){o.getService("navigation").then(function(n){I[f]=E;switch(c.getView().getViewData().variantManagement){case"Page":I[V]={"variantId":b.getCurrentVariantKey()};break;case"Control":break;default:break;}var s={appState:I};s=t.removeSensitiveDataForIAppState(s,m,e);var d=n.storeInnerAppStateWithImmediateReturn(s,true,e,true);var g=d.appStateKey;var j=n.replaceInnerAppStateKey(h,g);r.navToHash(j);});});}else if(v.viewLevel===1){T="OP";}else if(v.viewLevel>1){T="SUBOP";}this.sNavType=null;},applyAppState:function(c){var t=this;var o=C.getAppComponent(c.getView());var f=c.getView().byId(c.getView().getContent()[0].data("filterBarId"));o.getService("navigation").then(function(n){var p=n.parseNavigation();p.done(function(b,s,d){t.sNavType=d;if(d){t._applyAppStateToPage(c,b,s,d);}else{t._setIsAppStateReady(true,f);}});});},_applyAppStateToPage:function(c,o,s,n){var t=this,T,b,f,d=C.getAppComponent(c.getView()),m=d.getMetaModel(),v=c.getView().getViewData(),e=v.entitySet,i=d.getRootViewController().isFclEnabled();if(n!=="iAppState"){b={};f=c.getView().byId(c.getView().getContent()[0].data("filterBarId"));if(o.oSelectionVariant){var p=C.getEntitySetProperties(m,e),M=C.getMandatoryFilterFields(m,e);a.addDefaultDisplayCurrency(M,o);a.addSelectionVariantToConditions(o.oSelectionVariant,b,p);S.applyExternalState(f,{filter:b}).then(function(){t._setIsAppStateReady(true,f);});}else{t._setIsAppStateReady(true,f);}}else if(v.viewLevel===0||i){T="LR";var F=this.createKeyForAppStateData(T,[e],"FilterBar");var V;switch(c.getView().getViewData().variantManagement){case"Page":V=this.createKeyForAppStateData(T,[e],"Variant");break;case"None":break;case"Control":break;default:L.error("Variant Management not correctly defined, variable wrongly set to: "+c.getView().getViewData().variantManagement);break;}f=c.getView().byId(c.getView().getContent()[0].data("filterBarId"));if((o&&o.appState&&o.appState[V]&&o.appState[V].variantId)||(o&&o.appState&&o.appState[F])){var g=function(){var h=m.getObject("/"+e+"@Org.OData.Capabilities.V1.FilterRestrictions");var E=m.getObject("/"+e+"/");var j=[];if(h){if(h.NonFilterableProperties){j=h.NonFilterableProperties.map(function(P){return P.$PropertyPath;});}}var O;var k={};for(var K in E){O=E[K];if(O){if(O.$kind==="Property"){if(j.indexOf(K)>=0){continue;}k[K]=[];}}}S.applyExternalState(f,{filter:{"filter":k}}).then(function(){if(o&&o.appState&&o.appState[F]){b=o.appState[F].filter;}S.applyExternalState(f,{filter:b}).then(function(){t._setIsAppStateReady(true,f);});});};switch(c.getView().getViewData().variantManagement){case"Page":sap.ui.fl.ControlPersonalizationAPI.activateVariant(d,o.appState[V].variantId).then(g);break;case"None":L.debug("AppState handling is currently only working with Page VM");break;case"Control":L.debug("Variant Management is set to Control VM which does not support the AppState handling yet");break;default:L.error("Variant Management not correctly defined, variable wrongly set to: "+c.getView().getViewData().variantManagement);break;}}}else if(v.viewLevel===1){T="OP";}else if(v.viewLevel>1){T="SUBOP";}},createKeyForAppStateData:function(v,e,c){var k="";k=k+v+"_";for(var i=0;i<e.length;i++){k=k+e[0]+"/";}k=k+c;return k;},_setIsAppStateReady:function(i,f){this.bIsAppStateReady=i;if(!Object.keys(f.getFilterConditions()).length){this.sNavType=null;}},_getIsAppStateReady:function(){return this.bIsAppStateReady;},removeSensitiveDataForIAppState:function(d,m,e){var p;var k="LR_"+e+"/FilterBar";var f=d.appState[k].filter;var K=Object.keys(f);K.map(function(P){if(P!=="$editState"){p=m.getObject("/"+e+"/"+P+"@");if(p){if(a._checkPropertyAnnotationsForSensitiveData(p)){delete f[P];}}}});d.appState[k].filter=f;return d;}};return A;},true);
