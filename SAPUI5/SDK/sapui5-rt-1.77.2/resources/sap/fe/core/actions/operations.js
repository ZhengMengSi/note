/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/messageHandling","sap/fe/core/BusyLocker","sap/fe/macros/table/TableRuntime","sap/fe/macros/SideEffectsUtil","sap/fe/core/CommonUtils"],function(M,D,J,X,a,F,m,B,T,S,C){"use strict";function c(A,i,j,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}P=P||{};if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=[i];}var l=j.getMetaModel(),n=l.getMetaPath(i[0].getPath())+"/"+A,q=l.createBindingContext(n+"/@$ui5.overload/0");P.aContexts=i;P.isCriticalAction=f(l,n);return d(A,j,q,P);}function b(A,i,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var j=i.getMetaModel(),l=i.bindContext("/"+A).getPath(),n=j.createBindingContext("/"+j.createBindingContext(l).getObject("$Action")+"/0");P.isCriticalAction=f(j,l+"/@$ui5.overload");return d(A,i,n,P);}function d(A,i,j,P){return new Promise(function(r,l){P=P||{};var n=P.actionParameters||[],q={},t,u,v=P.label,w=P.showActionParameterDialog,x=P.aContexts,I=P.bIsCreateAction,y=P.isCriticalAction;if(!j){l("Action not found");}if(w||n.length>0){n=p(j,n);if(!n||n.length===0){w=false;}}if(w){t=s;}else if(y){t=e;}q={fnOnSubmitted:P.onSubmitted,actionName:A,model:i,aActionParameters:n,ownerComponent:P.ownerComponent};if(j.getObject("$IsBound")){q.aContexts=x;q.mBindingParameters=P.mBindingParameters;q.additionalSideEffect=P.additionalSideEffect;q.bGrouped=P.invocationGrouping==="ChangeSet";q.bReturnAsArray=P.bReturnAsArray;q.localUIModel=P.localUIModel;q.prefix=P.prefix;q.operationAvailableMap=P.operationAvailableMap;}if(I){q.bIsCreateAction=I;}if(t){u=t(A,v,q,n,j,P.parentControl,P.entitySetName);}else{u=_(q);}return u.then(function(O){r(O);}).catch(function(O){l(O);});});}function e(A,i,P,j,l,n,q){return new Promise(function(r,t){var u=A&&q?q+"|"+A:"";var R=n.getController().oResourceBundle;var v=C.getTranslatedText("SAPFE_ACTION_CONFIRM",R,null,u);M.confirm(v,{onClose:function(w){return _(P).then(function(O){r(O);}).catch(function(E){m.showUnboundMessages();});}});});}function s(A,j,P,l,n,q,r){var t=k(n,A),u=n.getModel().oModel.getMetaModel(),v=u.createBindingContext(t),w=n.getObject("$IsBound")?n.getPath().split("/@$ui5.overload/0")[0]:n.getPath().split("/0")[0],x=u.createBindingContext(w),y=Promise.resolve(),z="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(E,G){var H=X.loadTemplate(z,"fragment"),I=new J({$displayMode:{}});return a.process(H,{name:z},{bindingContexts:{action:n,actionName:x,entitySet:v},models:{action:n.getModel(),actionName:x.getModel(),entitySet:v.getModel()}}).then(function(H){return h(P.ownerComponent,l,I).then(function(){F.load({definition:H}).then(function(K){var O;var R=q.getController().oResourceBundle;var L=new D({title:j||C.getTranslatedText("SAPFE_ACTION_PARAMETER_DIALOG_TITLE",R),content:[K],escapeHandler:function(Z){L.close();L.destroy();E(false);},beginButton:{text:j||C.getTranslatedText("SAPFE_OK",R),type:"Emphasized",press:function(Z){B.lock(L);var $=Z.getSource();$.setEnabled(false);y.then(function(){var a1,i,b1,c1=K.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");var d1=function(i1){var j1={};for(i=0;i<i1.length;i++){var k1=i1[i].getFields()[0];if(k1.getProperty("required")&&k1.mBindingInfos.value.binding){j1[k1.mBindingInfos.value.binding.getPath()]={element:k1};}}return j1;};var e1=d1(c1);var f1;var g1=O&&O.getParameterContext();for(i=0;i<l.length;i++){f1=l[i].$Name;b1=g1.getProperty(f1);if(!b1&&e1[f1]){a1=true;L.fireValidationError({element:e1[f1].element,property:"value",type:sap.ui.core.MessageType.Error,newValue:b1,message:C.getTranslatedText("SAPFE_ACTION_PARAMETER_REQUIRED",R)});$.setEnabled(true);}}if(!a1){m.removeUnboundTransitionMessages();var h1;for(var i in P.aActionParameters){h1=g1.getProperty(P.aActionParameters[i].$Name);P.aActionParameters[i].value=h1;h1=undefined;}return _(P).then(function(i1){L.close();E(i1);}).catch(function(i1){$.setEnabled(true);m.showUnboundMessages();});}}).finally(function(){B.unlock(L);});}},endButton:{text:C.getTranslatedText("SAPFE_ACTION_PARAMETER_DIALOG_CANCEL",R),press:function(){L.close();m.removeUnboundTransitionMessages();G();}},afterClose:function(){L.destroy();}});L.setModel(n.getModel().oModel);L.setModel(I,"paramsModel");L.bindElement({path:"/",model:"paramsModel"});var N=A+"(...)";var Q=P.aContexts||[];if(!Q.length){N="/"+N;}L.bindElement({path:N});if(q){q.addDependent(L);}if(Q.length>0){L.setBindingContext(Q[0]);}O=L.getObjectBinding();if(Q.length===1){O.setParameter("_it",Q[0].getObject());}var U=function(W,Z){var $;if(Z){if(Q.length>0&&Z.$Path){$=Q[0].getProperty(Z.$Path);for(var i=1;i<Q.length;i++){if(Q[i].getProperty(Z.$Path)!==$){return;}}}else{$=Z;}}else{if(I&&I.oData[W]){$=I.oData[W];}}if($){O.setParameter(W,$);}};var V=function(W){var Z=L.getModel().getMetaModel(),N=n.sPath&&n.sPath.split("/@")[0],$=Z.getObject(N),a1=$&&$[0]&&$[0].$Parameter,b1=a1&&a1[0]&&a1[0].$Name,c1=N+"/"+W+"@",d1=Z.getObject(c1),e1=d1&&d1["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];if(e1&&e1.$Path&&e1.$Path.startsWith(b1+"/")){e1.$Path=e1.$Path.replace(b1+"/","");}return e1;};var W,Y;for(var i in P.aActionParameters){W=P.aActionParameters[i].$Name;Y=V(W);U(W,Y);}L.open();});});});});}function p(A,P){var i=g(A);P=P||[];if(P.length>0){}return i;}function g(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function f(i,P){return!!i.getObject(P+"@com.sap.vocabularies.Common.v1.IsActionCritical");}function _(P){var l=P.aContexts||[],n=P.model,A=P.aActionParameters||[],q=P.actionName,O=P.fnOnSubmitted,I=P.bIsCreateAction,r=false,t;function u(i){return i.then(function(j){return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function v(){if(A&&A.length){r=true;for(var j=0;j<A.length;j++){if(!A[j].value){switch(A[j].$Type){case"Edm.String":A[j].value="";break;case"Edm.Boolean":A[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":A[j].value=0;break;default:break;}}t.setParameter(A[j].$Name,A[j].value);}}}if(l.length){return new Promise(function(j,x){var y=P.mBindingParameters,G=P.bGrouped,R=P.bReturnAsArray,z=[],i,E,H=function(t,K,L){v();E=!G?"$auto."+K:t.getUpdateGroupId();z.push(t.execute(E));if(L&&L.pathExpressions){S.logRequest(L);L.context.requestSideEffects(L.pathExpressions,E).then(function(){if(P.operationAvailableMap){T.setActionEnablement(P.localUIModel,JSON.parse(P.operationAvailableMap),"/$contexts/"+P.prefix,P.aContexts);}});}};for(i=0;i<l.length;i++){t=n.bindContext(q+"(...)",l[i],y);H(t,l.length<=1?null:i,{context:l[i],pathExpressions:P.additionalSideEffect});}(O||jQuery.noop)(z);Promise.all(z.map(u)).then(function(K){var L=[],N=[],Q;for(Q=0;Q<K.length;Q++){if(K[Q].status==="rejected"){L.push(K[Q].response);}if(K[Q].status==="resolved"){if(I&&r){K[Q].bConsiderDocumentModified=true;N.push(K[Q]);}else{N.push(K[Q].response);}}}if(!K||(K&&K.length===0)){x(true);}if(L.length===0){if(R){j(N);}else{j(N[0]);}}else{x({resolvedItems:N,rejectedItems:L});}});});}else{var w;t=n.bindContext("/"+q+"(...)");v();w=t.execute("actionImport");n.submitBatch("actionImport");(O||jQuery.noop)(w);return w;}}function h(A,i,P){return new Promise(function(r,j){var l=A.getComponentData().startupParameters,n=sap.ushell.Container.getService("CrossApplicationNavigation")||{};if(!n.getStartupAppState){i.map(function(q){if(l[q.$Name]){P.setProperty(q.$Name,l[q.$Name][0]);}});return r(true);}return n.getStartupAppState(A).then(function(q){var t=q.getData()||{},E=(t.selectionVariant&&t.selectionVariant.SelectOptions)||[];i.map(function(u){if(l[u.$Name]){P.setProperty("/"+u.$Name,l[u.$Name][0]);}else if(E.length>0){var v;E.some(function(w){if(w.PropertyName===u.$Name){v=w.Ranges;return true;}});if(v&&v.length===1&&v[0].Sign==="I"&&v[0].Option==="EQ"){P.setProperty("/"+u.$Name,v[0].Low);}}});return r(true);});});}function k(A,i){var P=A.getPath();P=A.getObject("$IsBound")?P.split("@$ui5.overload")[0]:P.split("/0")[0];return P.split("/"+i)[0];}var o={callBoundAction:c,callActionImport:b};return o;});
