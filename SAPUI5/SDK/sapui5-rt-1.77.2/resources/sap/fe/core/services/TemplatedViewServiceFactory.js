sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/base/ManagedObjectModel","sap/ui/core/cache/CacheManager","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/View","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/core/routing/HashChanger","sap/fe/core/TemplateModel","sap/fe/core/converters/MetaModelConverter"],function(S,a,b,M,C,R,V,c,J,L,H,T,d){"use strict";function e(n,i){this.name=n;this.currentPath=i||"";this.lastPath="";this.set=function(N){while(N.indexOf("../")===0){this.currentPath=this.currentPath.substr(0,this.currentPath.lastIndexOf(this.lastPath)-1);this.lastPath=this.currentPath.substr(this.currentPath.lastIndexOf("/")+1);N=N.substr(3);}if(N){this.lastPath=N;}this.currentPath+=N;L.info(this.name+" is now : "+this.currentPath);};this.get=function(){return this.currentPath;};this.delete=function(){this.currentPath="";L.info(this.name+" has been deleted");};}var f=S.extend("sap.fe.core.services.TemplatedViewService",{initPromise:null,init:function(){var t=this;var s=[];var o=this.getContext();var g=o.scopeObject;var A=c.getOwnerComponentFor(g);var m=A.getMetaModel();var h=A.getMetadata().getComponentName()+"::"+A.getLocalId(g.getId());var E=g.getEnhanceI18n()||[];var j;if(E){j=sap.ui.require.toUrl(A.getMetadata().getComponentName());for(var i=0;i<E.length;i++){E[i]=j+"/"+E[i];}}var k=A.getMetadata().getName()+"_"+h+"_"+sap.ui.getCore().getConfiguration().getLanguageTag();s.push(b.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:g,settings:{bundles:["sap.fe.core","sap.fe.templates"],enhanceI18n:E,modelName:"sap.fe.i18n"}}).then(function(r){return r.getResourceModel();}));s.push(b.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:m}}).then(function(l){return l.validateCacheKey(k);}));this.initPromise=Promise.all(s).then(function(D){var r=D[0];var l=D[1];return t.createView(r,h,l);}).then(function(l){var n=b.get("sap.fe.core.services.CacheHandlerService").getInstance(m);n.invalidateIfNeeded(l,k);});},createView:function(r,s,g){var t=this;var o=this.getContext(),m=o.settings,h=o.scopeObject,E=h.getProperty("entitySet"),A=c.getOwnerComponentFor(h),i=A.getMetaModel(),D=new J(sap.ui.Device).setDefaultBindingMode("OneWay"),j=new J(A.getManifest()),k=new J({currentPath:new e(),navigationPath:new e("NavigationPath")});this.oFactory=o.factory;return A.getService("routingService").then(function(l){var n=l.getTargetInformationFor(h);var v={navigation:h.getNavigation(),viewLevel:n.viewLevel};if(h.getViewData){Object.assign(v,h.getViewData());}var p=new J(v),P=new J(d.convertPage(i,v)),q=o.oTemplateModel,G=o.oConfigModel,u=G.getData();Object.assign(u,P.getData());var w={type:"XML",preprocessors:{xml:{bindingContexts:{entitySet:E?q.createBindingContext("/"+E):null,viewData:v?p.createBindingContext("/"):null},models:{entitySet:q,"sap.fe.i18n":r,"sap.ui.mdc.metaModel":i,"sap.fe.deviceModel":D,manifest:j,viewData:p,metaPath:k}}},id:s,viewName:m.viewName,viewData:v,cache:{keys:[g]},height:"100%"};function x(y){L.error(y);w.viewName=m.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";w.preprocessors.xml.models["error"]=new J(y);return h.runAsOwner(function(){return V.create(w);});}return h.runAsOwner(function(){return V.create(w).catch(x).then(function(y){t.oView=y;t.oView.setModel(new M(t.oView),"$view");h.setAggregation("rootControl",t.oView);return g;}).catch(L.error);});}).catch(function(l){throw new Error("Error while creating view : "+l);});},getView:function(){return this.oView;},exit:function(){this.oFactory.removeGlobalInstance();}});return a.extend("sap.fe.core.services.TemplatedViewServiceFactory",{_oInstanceRegistry:{},createInstance:function(s){var A=c.getOwnerComponentFor(s.scopeObject);if(!this._oInstanceRegistry[A]){var o=new J();this._oInstanceRegistry[A]={configModel:o,templateModel:new T(A.getMetaModel(),o)};}s.oTemplateModel=this._oInstanceRegistry[A].templateModel;s.oConfigModel=this._oInstanceRegistry[A].configModel;var t=new f(Object.assign({factory:this},s));return t.initPromise.then(function(){return t;});},removeGlobalInstance:function(){this._oInstanceRegistry={};}});},true);
