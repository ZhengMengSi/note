/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/Routing","sap/fe/core/controllerextensions/RoutingListener","sap/fe/core/controllerextensions/FlexibleColumnLayout","sap/fe/core/controllerextensions/EditFlow","sap/ui/model/odata/v4/ODataListBinding","sap/fe/macros/field/FieldRuntime","sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/macros/CommonHelper","sap/m/MessageBox","sap/fe/core/BusyLocker","sap/fe/navigation/NavigationHelper","sap/fe/core/actions/messageHandling","sap/fe/core/FEHelper","sap/ui/core/routing/HashChanger","sap/fe/macros/ResourceModel","sap/m/Link"],function(C,J,R,a,F,E,O,b,L,m,c,S,d,M,B,N,e,f,H,g,h){"use strict";var j;return C.extend("sap.fe.templates.ObjectPage.ObjectPageController",{routing:R,fcl:F,editFlow:E,routingListener:a,createExtensionAPI:function(){return{};},onInit:function(){var t=this,o=this.byId("fe::op");this.getView().setModel(this.editFlow.getTransactionHelper().getUIStateModel(),"ui");this.getView().setModel(this.editFlow.getUIStateModel({sessionOn:false,batchGroups:t._getBatchGroupsForView()}),"localUI");var r=new J({visibility:false,items:null});this.getView().setModel(r,"relatedAppsModel");if(o.getEnableLazyLoading()){o.attachEvent("subSectionEnteredViewPort",this._handleSubSectionEnteredViewPort.bind(this));}},onExit:function(){this.getView().getModel("relatedAppsModel").destroy();},getTableBinding:function(t){return t&&t._getRowBinding();},onAfterRendering:function(o){c.updateDataFiledForIBNButtonsVisibility(this.getView().getModel("localUI"));var t=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.oResourceBundle=r;});},onBeforeBinding:function(o,p){var t=this,T=this._findTables(),k,l=this.byId("fe::op"),n=p.listBinding,q=t.getView().getModel("localUI"),r=q.getProperty("/batchGroups");if(l.getBindingContext()&&l.getBindingContext().hasPendingChanges()&&!r.some(l.getBindingContext().getModel().hasPendingChanges.bind(l.getBindingContext().getModel()))){l.getBindingContext().getBinding().resetChanges();}for(var i=0;i<T.length;i++){k=T[i].getCreationRow();if(k){k.setBindingContext(null);}}var s=function(D){if(!p.bPersistOPScroll){l.setSelectedSection(null);l.detachModelContextChange(s);}};l.attachModelContextChange(s);if(n&&n.isA("sap.ui.model.odata.v4.ODataListBinding")){var P=t.byId("fe::paginator");if(P){P.setListBinding(n);}}if(!p.editable){if(q.getProperty("/sessionOn")===true){q.setProperty("/sessionOn",false);}}if(l.getEnableLazyLoading()){var u=l.getSections(),U=l.getUseIconTabBar(),v=2;for(var w=0;w<u.length;w++){var x=u[w];var y=x.getSubSections();for(var z=0;z<y.length;z++,v--){if(v<1||(U&&w>0)){var A=y[z];A.setBindingContext(null);}}}}},_handleSubSectionEnteredViewPort:function(o){var s=o.getParameter("subSection");s.setBindingContext(undefined);},onAfterBinding:function(o,p){var i=this.byId("fe::op"),t=this,k=o.getModel(),T=this._findTables(),l;o=i.getBindingContext();l=this.editFlow.computeEditMode(o);if(o.getBinding().oCache){t._updateRelatedApps();}else{var u=function(){t._updateRelatedApps();o.getBinding().detachDataReceived(u);};o.getBinding().attachDataReceived(u);}function n(r,s){var v=r.getCreationRow(),w,x;if(v){l.then(function(){if(v.getVisible()){w=k.bindList(s.getPath(),s.getContext(),[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});w.refreshInternal=function(){};x=w.create();v.setBindingContext(x);x.created().catch(function(){L.trace("transient fast creation context deleted");});}});}}function q(r){var s=t.getTableBinding(r),v=function(){t.editFlow.handlePatchEvents(s);b.handlePatchEvents(s);n(r,s);};if(s.oContext){v();}else{var w=function(){if(s.oContext){v();s.detachChange(w);}};s.attachChange(w);}}this.editFlow.handlePatchEvents(o).then(function(){T.forEach(function(r){r.done().then(q);});});b.handlePatchEvents(o);i._triggerVisibleSubSectionsEvents();},onPageReady:function(p){var t=this;var T=this._findTables();var l=this.getView().getModel("localUI");T.forEach(function(s){var u=t.getView().getLocalId(s.getId());var w=(s&&s.getSelectedContexts())||[];if(w.length>0){s.clearSelection();if(l){l.setProperty("/$contexts/"+u,{});}}});var o=p.lastFocusedControl;if(o&&o.controlId&&o.focusInfo){var v=this.getView();var i=v.byId(o.controlId);if(i){i.applyFocusInfo(o.focusInfo);return;}}var k=this.byId("fe::op");var n=k.getModel("ui").getProperty("/editable")==="Display";var q;if(n){var A=k.getHeaderTitle().getActions();if(A.length){q=A.find(function(s){return s.mProperties["visible"];});if(q){q.focus();}}}else{var r=k._getFirstEditableInput();if(r){r.focus();}}},getPageTitleInformation:function(){var o=this.byId("fe::op");var t={title:o.data("ObjectPageTitle")||"",subtitle:"",intent:"",icon:""};var i=o.getCustomData().find(function(k){return k.getKey()==="ObjectPageSubtitle";});if(i&&i.getBinding("value")!==undefined){return i.getBinding("value").requestValue().then(function(v){t.subtitle=v;return t;});}else{return Promise.resolve(t);}},executeHeaderShortcut:function(i){var s=this.getView().getId()+"--"+i,o=this.byId("fe::op").getHeaderTitle().getActions().find(function(k){return k.getId()===s;});c.fireButtonPress(o);},executeFooterShortcut:function(i){var s=this.getView().getId()+"--"+i,o=this.byId("fe::op").getFooter().getContent().find(function(k){return k.getMetadata().getName()==="sap.m.Button"&&k.getId()===s;});c.fireButtonPress(o);},executeTabShortCut:function(o){var i=this.byId("fe::op"),s=i.indexOfSection(this.byId(i.getSelectedSection())),k=i.getSections(),l=k.length-1,n=o.oSource.getCommand(),p;if(s!==-1&&l>0){if(n==="NextTab"){if(s<=l-1){p=k[++s];}}else{if(s!==0){p=k[--s];}}if(p){i.setSelectedSection(p);p.focus();}}},getFooterVisiblity:function(o){j=o.getParameter("iMessageLength");var l=this.getView().getModel("localUI");j>0?l.setProperty("/showMessageFooter",true):l.setProperty("/showMessageFooter",false);},showMessagePopover:function(o){var i=o.oMessagePopover,I=i.getBinding("items");if(I.getLength()>0){i.openBy(o);}},editDocument:function(){var o=this.getView().getModel("ui");B.lock(o);return this.editFlow.editDocument.apply(this.editFlow,arguments).finally(function(){B.unlock(o);});},saveDocument:function(o){var t=this,i=this.getView().getModel("ui");B.lock(i);return this.editFlow.saveDocument(o).then(function(){var k=t.getView().byId("MessageButton");var D={onAfterRendering:function(l){t.showMessagePopover(k);k.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};t._oDelegateOnAfter=D;k.addEventDelegate(D,t);}).catch(function(k){var l=t.getView().byId("MessageButton");if(l){t.showMessagePopover(l);}}).finally(function(){B.unlock(i);});},_updateRelatedApps:function(){var o=this.byId("fe::op");if(c.resolveStringtoBoolean(o.data("showRelatedApps"))){c.updateRelatedAppsDetails(o);}},_findTables:function(){var o=this.byId("fe::op"),t=[];function i(p,q){for(var r=0;r<p.length;r++){var P=p[r].getAggregation("items")&&p[r].getAggregation("items")[0],u=P&&P.getAggregation("content");if(u&&u.isA("sap.ui.mdc.Table")){t.push(u);if(u.getType().isA("sap.ui.mdc.table.GridTableType")&&!q.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){q.addStyleClass("sapUxAPObjectPageSubSectionFitContainer");}}}}var s=o.getSections();for(var k=0;k<s.length;k++){var l=s[k].getSubSections();for(var n=0;n<l.length;n++){i(l[n].getBlocks(),l[n]);i(l[n].getMoreBlocks(),l[n]);}}return t;},_mergePageAndLineContext:function(p,l){var o,s;if(Array.isArray(l)){s=d.getMergedLineContexts(l,undefined,p);}else{o=m({},p,l);s=N.mixAttributesAndSelectionVariant(o,new S());}return s;},_getBatchGroupsForView:function(){var t=this,v=t.getView().getViewData(),o=v.controlConfiguration,i=o&&Object.keys(o),k=["$auto.Heroes","$auto.Decoration","$auto.Workers"];if(i&&i.length>0){i.forEach(function(K){var l=o[K];if(l.requestGroupId==="LongRunners"){k.push("$auto.LongRunners");}});}return k;},setBreadcrumbLinks:function(s){var o=s.getBindingContext();var A=c.getAppComponent(this.getView());if(o){var n=o.getPath(),p=n.split("/"),P="";p.shift();p.splice(-1,1);p.forEach(function(k,i){P+="/"+k;var r=A.getRootViewController();var t=r.getTitleHierarchyCache();var l;if(!t[P]){l=r.addNewEntryInCacheTitle(P,A);}else{l=Promise.resolve(t[P]);}l.then(function(T){var q=s.getLinks()[i]?s.getLinks()[i]:new h();var u=k.replace(/ *\([^)]*\) */g,"");q.setText(T.subtitle||u);q.setHref(T.intent);if(!s.getLinks()[i]){s.addLink(q);}});});}},handlers:{onFieldValueChange:function(o){this.editFlow.syncTask(o.getParameter("promise"));b.handleChange(o);},onRelatedAppsItemPressed:function(o,k){var l=o.getSource(),n=k&&k.getView()&&k.getView().getBindingContext();k.editFlow.getProgrammingModel(n).then(function(p){var P=function(){var q=l.getCustomData(),t,r,s;for(var i=0;i<q.length;i++){var u=q[i].getKey();var v=q[i].getValue();if(u=="targetSemObject"){t=v;}else if(u=="targetAction"){r=v;}else if(u=="targetParams"){s=v;}}var w={target:{semanticObject:t,action:r},params:s};sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(w);};c.processDataLossConfirmation(P,l,p,k);});},onCallActionFromFooter:function(v,A,p){var o=v.getController();var t=o;return o.editFlow.onCallAction(A,p).then(function(){var i=t.getView().byId("MessageButton");if(i.isActive()){t.showMessagePopover(i);}else if(j){t._oDelegateOnAfter={onAfterRendering:function(k){t.showMessagePopover(i);i.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};i.addEventDelegate(t._oDelegateOnAfter,t);}}).catch(function(i){var k=t.getView().byId("MessageButton");if(k){t.showMessagePopover(k);}});},onDataFieldForIntentBasedNavigation:function(o,s,A,i,l,r,I){var k=o&&o.getView(),n=k&&k.getBindingContext();if(I==="true"&&(r==="false"||r==="undefined")){M.show(g.getText("navigation.CONTEXT_MESSAGE"),{title:g.getText("navigation.ERROR_TITLE")});}else{o.editFlow.getProgrammingModel(n).then(function(p){var P=function(){var q;var t={};var u={};if(r||l){if(o.getView().getAggregation("content")[0].getBindingContext()){t=N.removeSensitiveData(o.getView().getAggregation("content")[0].getBindingContext());}if(l){if(!Array.isArray(l)){u=N.removeSensitiveData(l);q=o._mergePageAndLineContext(t,u);}else{var v=[];for(var w in l){u=N.removeSensitiveData(l[w]);v.push(u);}q=o._mergePageAndLineContext(t,v);}}else{q=o._mergePageAndLineContext(t,v);}if(i!="undefined"){q=f.setSemanticObjectMappings(q,i);}}c.navigateToExternalApp(o.getView(),q,s,A);};c.processDataLossConfirmation(P,k,p,o);});}},onChevronPressNavigateOutBound:function(o,s,i){var k=o&&o.getView(),l=k&&k.getBindingContext();return o.editFlow.getProgrammingModel(l).then(function(p){var P=function(){var n=o.routing.getOutbounds(),q,D=n[s],r=N.removeSensitiveData(o.getView().getAggregation("content")[0].getBindingContext()),t=N.removeSensitiveData(i);if(D){if(i){q=o._mergePageAndLineContext(r,t);}c.navigateToExternalApp(o.getView(),q,D.semanticObject,D.action,d.showNavigateErrorMessage);return Promise.resolve();}else{throw new Error("outbound target "+s+" not found in cross navigation definition of manifest");}};c.processDataLossConfirmation(P,k,p,o);});}}});});
