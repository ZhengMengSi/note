/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/EventProvider"],function(E){"use strict";var H="sapui5.history-";var M=3;var i;var a=E.extend("sap.ui.comp.providers.HistoryValuesProvider",{metadata:{library:"sap.ui.comp",events:{fieldUpdated:{parameters:{fieldData:{type:"Array"},fieldName:{type:"String"}}}}},constructor:function(){E.apply(this,arguments);this._initialize();}});a.prototype._initialize=function(){this._oHistoryDataReadyPromise=new Promise(function(r){this._historyDataReadyResolve=r;}.bind(this));this._getGlobalPersonalizer().getPersData().then(function(d){if(!d){d={};}var A=this._getAppUniqueID();this._appContainerID=d[A];if(!this._appContainerID){this._appContainerID=this._getAppContainerID();d[A]=this._appContainerID;this._getGlobalPersonalizer().setPersData(d);}this._getInitialDataFromService();}.bind(this));};a.prototype.registerControl=function(c,f){if(c.isA("sap.m.MultiInput")){c.attachTokenUpdate(function(e){this._onMultiInputChange(f,e);},this);return;}if(c.isA("sap.m.MultiComboBox")){c.attachSelectionChange(function(e){this._onMultiComboBoxChange(f,e);},this);return;}if(c.isA("sap.m.Input")){c.attachChange(function(e){this._onInputChange(f,e);},this);return;}if(c.isA("sap.m.ComboBox")){c.attachChange(function(e){this._onComboBoxChange(f,e);},this);return;}};a.prototype.getFieldData=function(f){return this._getHistoryData()[f]||[];};a.prototype.isDataReady=function(){return this._oHistoryDataReadyPromise;};a.prototype._onMultiInputChange=function(f,e){var t=e.getParameter("type"),A=e.getParameter("addedTokens");if(t==="added"){var d=A.reduce(function(r,T){var D=T.data("row");if(D){D=Object.assign({},D);delete D.__metadata;delete D.order;return r.concat(D);}return r;},[]);this._saveFieldData(f,d);}};a.prototype._onMultiComboBoxChange=function(f,e){var s=e.getParameter("selected"),c=e.getParameter("changedItem");if(s&&c){var d=c.getBindingContext("list").getObject();this._processSingleValueControl(f,d);}};a.prototype._onInputChange=function(f,e){var v=e.getParameter("validated"),s=sap.ui.getCore().byId(e.getSource().getSelectedRow());if(v&&s){var d=s.getBindingContext("list").getObject();this._processSingleValueControl(f,d);}};a.prototype._onComboBoxChange=function(f,e){var v=e.getParameter("value"),n=e.getParameter("newValue"),s=e.getSource().getSelectedItem();if(v&&n&&s){var d=s.getBindingContext("list").getObject();this._processSingleValueControl(f,d);}};a.prototype._processSingleValueControl=function(f,d){if(d){d=Object.assign({},d);delete d.__metadata;delete d.order;this._saveFieldData(f,[d]);}};a.prototype._getGlobalPersonalizer=function(){if(this._globalPersonalizer){return this._globalPersonalizer;}var p=sap.ushell.Container.getService("Personalization"),s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:false,validity:Infinity},g={container:this._getGlobalContainerID(),item:this._getHistoryPrefix()+"appContainerIDs"};this._globalPersonalizer=p.getPersonalizer(g,s);return this._globalPersonalizer;};a.prototype._getAppPersonalizer=function(){if(this._appPersonalizer){return this._appPersonalizer;}var p=sap.ushell.Container.getService("Personalization"),s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:false,validity:Infinity},A={container:this._getAppContainerID(),item:this._getHistoryPrefix()+"appData"};this._appPersonalizer=p.getPersonalizer(A,s);return this._appPersonalizer;};a.prototype._getInitialDataFromService=function(){return this._getAppPersonalizer().getPersData().then(function(d){d=d||{};this._setHistoryData(d);this._historyDataReadyResolve(d);return d;}.bind(this));};a.prototype._getHistoryData=function(){return this._historyData;};a.prototype._setHistoryData=function(d){this._historyData=d;};a.prototype._saveFieldData=function(f,F){var A=this._getHistoryData(),b=A[f]||[],m=this._getMaxHistoryRecords();A[f]=this._getDistinct(F.concat(b)).slice(0,m);this._setHistoryData(A);this.fireEvent("fieldUpdated",{fieldData:A[f],fieldName:f});return this._getAppPersonalizer().setPersData(A);};a.prototype._getGlobalContainerID=function(){if(!this._globalContainerID){this._globalContainerID=this._getHistoryPrefix()+"all.apps.containers";}return this._globalContainerID;};a.prototype._getAppContainerID=function(){if(!this._appContainerID){this._appContainerID=this._createUUID();}return this._appContainerID;};a.prototype._getAppUniqueID=function(){if(this._appUniqueID){return this._appUniqueID;}var A=sap.ushell.Container.getService("AppLifeCycle"),c=A.getCurrentApplication(),C,m,o,I;if(c){C=c.componentInstance;}if(C){m=C.getMetadata();}if(m){o=m.getManifest();}if(o){I=o["sap.app"].id;}this._appUniqueID=this._getHistoryPrefix()+I;return this._appUniqueID;};a.prototype._getHistoryPrefix=function(){return H;};a.prototype._getMaxHistoryRecords=function(){return M;};a.prototype._getDistinct=function(d){var u={},D=[],k=d[0]&&Object.keys(d[0])[0];d.forEach(function(x){var c=x[k];if(!u[c]){D.push(x);u[c]=true;}},this);return D;};a.prototype._createUUID=function(){var u="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(p){var r=Math.random()*16|0;if(p==='y'){r=r&0x3|0x8;}return r.toString(16);});return u;};return{getInstance:function(){if(!i){i=new a();}return i;}};});
