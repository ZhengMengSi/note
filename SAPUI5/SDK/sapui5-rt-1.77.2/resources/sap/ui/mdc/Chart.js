/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/mdc/Control","./ChartRenderer","sap/ui/base/ManagedObjectObserver","sap/ui/model/json/JSONModel","sap/ui/mdc/library","sap/ui/model/base/ManagedObjectModel","sap/ui/model/Sorter","sap/base/Log","sap/base/util/deepEqual","sap/ui/Device","sap/ui/mdc/chart/ToolbarHandler"],function(C,a,b,M,J,c,d,S,L,e,D,T){"use strict";var f,g,h,l,m;var n=a.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",defaultAggregation:"items",properties:{delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/ChartDelegate"}},header:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc",defaultValue:"column"},selectionMode:{type:"string",group:"Misc",defaultValue:"MULTIPLE"},p13nMode:{type:"sap.ui.mdc.ChartP13nMode[]"},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},vizProperties:{type:"object",group:"Misc"},_colorings:{type:"object",visibility:"_hidden",byValue:true},ignoreToolbarActions:{type:"sap.ui.mdc.ChartToolbarActionType[]",defaultValue:[]},minWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"240px",invalidate:true},minHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"400px",invalidate:true},sortConditions:{type:"object"}},aggregations:{data:{multiple:true},items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--toolbar",aggregation:"actions"}},_chart:{type:"sap.chart.Chart",multiple:false},_toolbar:{type:"sap.ui.mdc.ActionToolbar",multiple:false},_breadcrumbs:{type:"sap.m.Breadcrumbs",multiple:false},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}}}}});n.prototype.init=function(){this._oObserver=new M(this.update.bind(this));this._oAdaptationController=null;this._oObserver.observe(this,{aggregations:["items","_chart"],properties:["ignoreToolbarActions","p13nMode"]});this._oManagedObjectModel=new d(this);this.setModel(this._oManagedObjectModel,"$mdcChart");a.prototype.init.apply(this,arguments);};n.prototype.applySettings=function(s){s=s||{};var A=s.actions||[];delete s.actions;this.oChartPromise=this.loadInnerChart().then(function(){if(!this._bIsBeingDestroyed){return this.loadDelegateModule().then(function(i){return i.fetchProperties(this);}.bind(this)).then(function(p){var I={};for(var i=0;i<p.length;i++){I[p[i].name]=p[i];}T.createToolbar(this,A);this._createDrillBreadcrumbs();return this._createInnerChart(s,I);}.bind(this));}else{return null;}}.bind(this));a.prototype.applySettings.apply(this,[s]);};n.prototype.bindAggregation=function(N,B){if(N=="data"){this.oDataInfo=B;var i=this.getAggregation("_chart");if(i){i.bindAggregation("data",B);}else{this.oChartPromise.then(function(i){i.bindAggregation("data",this.oDataInfo);}.bind(this));}return this;}return a.bindAggregation(N,B);};n.prototype.getBindingInfo=function(N){if(N=="data"){return this.oDataInfo;}return a.prototype.getBindingInfo.apply(this,[N]);};n.prototype.setLegendVisible=function(v){this.setVizProperties({'legend':{'visible':v},'sizeLegend':{'visible':v}});return this.setProperty("legendVisible",v);};n.prototype._createInnerChart=function(s,I){var k={},p,v=[],q=[],r=[],V={};k.chartType='{$mdcChart>/chartType}';k.dimensions=[];k.measures=[];k.id=this.getId()+"--innerChart";k.height='100%';k.width='100%';k.vizProperties='{$mdcChart>/vizProperties}';s.items=s.items||[];function t(j){if(this&&this.getVizItemType()=="Dimension"){k.dimensions.push(j);}else{k.measures.push(j);}}function u(p,x){if(p.getCriticality()){x._addCriticality(p);}r.push(p.getKey());if(p.getAdditionalColoringMeasures){for(var j=0;j<p.getAdditionalColoringMeasures().length;j++){if(q.indexOf(p.getAdditionalColoringMeasures()[j])==-1){q.push(p.getAdditionalColoringMeasures()[j]);}}}}function w(j){var K,x;for(var i=0;i<q.length;i++){K=q[i];if(r.indexOf(K)==-1){x=j.retrieveAggregationItem("items",I[K]);x=m.getVizItemSettings(x.settings);v.push(m.createVizChartItem(x).then(t));}}}for(var i=0;i<s.items.length;i++){p=s.items[i];u(p,this);if(I[p.getKey()]){V=this.DELEGATE.retrieveAggregationItem("items",I[p.getKey()]).settings;}else{V=undefined;}v.push(p.toVizChartItem(V).then(t.bind(p)));}w(this.DELEGATE);var W=new Promise(function(j){sap.ui.require(["sap/ui/fl/apply/api/FlexRuntimeInfoAPI"],function(F){if(!F.isFlexSupported({element:this})){return Promise.resolve();}F.waitForChanges({element:this}).then(function(){return j();});}.bind(this));}.bind(this));return Promise.all(v,W).then(function(){var j=new f(k);j.setVisibleDimensions([]);j.setVisibleMeasures([]);j.setInResultDimensions([]);this._oObserver.observe(j,{bindings:["data"],aggregations:["dimensions","measures"]});this.setAggregation("_chart",j);return j;}.bind(this));};n.prototype.setSelectionMode=function(v){var i=this.getAggregation("_chart");if(i){i.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}else{this.oChartPromise.then(function(i){if(i){i.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}}.bind(this));}return this.setProperty("selectionMode",v,true);};function o(i){return i.every(function(s){return!!sap.ui.require(s);});}n.prototype.loadInnerChart=function(){if(this.oChartLibPromise){return this.oChartLibPromise;}var i=["sap/chart/Chart","sap/ui/mdc/chart/ChartTypeButton","sap/ui/mdc/chart/MeasureItem"];if(o(i)){return Promise.resolve();}return new Promise(function(r,j){sap.ui.require(i,function(n,k,p){f=n;l=k;m=p;r();});});};n.prototype.addItem=function(i,s){var j=this.getAggregation("_chart");if(j){i.toChart(j);}else{this.oChartPromise.then(function(j){if(j){this.toChart(j);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.addAggregation("items",i,s);};n.prototype.insertItem=function(i,I,s){if(i.getCriticality()){this._addCriticality(i);}var j=this.getAggregation("_chart");if(j){i.toChart(j);}else{this.oChartPromise.then(function(j){if(j){this.toChart(j);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.insertAggregation("items",i,I,s);};n.prototype.removeItem=function(i,s){this._oObserver.unobserve(i);return this.removeAggregation("items",i,s);};n.prototype.exit=function(){var i=this.getAggregation("_chart");if(this._oAdaptationController){this._oAdaptationController.destroy();this._oAdaptationController=null;}if(i){i.destroy();}else{this._bIsBeingDestroyed=true;this.oChartPromise.finally(function(){var i=this.getAggregation("_chart");if(i){i.destroy();}}.bind(this));}a.prototype.exit.apply(this,[]);};n.prototype.getItemsByName=function(I){var j=[];I.forEach(function(s){for(var i=this.getItems().length-1;i>=0;i--){if(this.getItems()[i].getKey()==s){j.push(this.getItems()[i]);break;}}}.bind(this));return j;};n.prototype._showDrillDown=function(){if(h){if(!this._oDrillDownPopover){h.createDrillDownPopover(this);}h.showDrillDownPopover(this);}else{sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(i){h=i;h.createDrillDownPopover(this);h.showDrillDownPopover(this,this.getDelegate().name);}.bind(this));}};n.prototype._createDrillBreadcrumbs=function(){if(h){if(!this._oDrillBreadcrumbs){h.createDrillBreadcrumbs(this);}}else{sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(i){h=i;h.createDrillBreadcrumbs(this);}.bind(this));}};n.prototype._getPropertyData=function(){return new Promise(function(r,i){if(!this.aFetchedProperties){return this.oDelegatePromise.then(function(j){return j.fetchProperties(this);}.bind(this)).then(function(F){this.aFetchedProperties=F;r(F);}.bind(this));}else{r(this.aFetchedProperties);}}.bind(this));};n.prototype.getAvailableChartTypes=function(){var j=[];var k=this.getAggregation("_chart");if(k){var A=k.getAvailableChartTypes().available;if(j){var p=C.getLibraryResourceBundle("sap.chart.messages");for(var i=0;i<A.length;i++){var t=A[i].chart;j.push({key:t,icon:l.mMatchingIcon[t],text:p.getText("info/"+t),selected:(t==this.getChartType())});}}}return j;};n.prototype.getTypeInfo=function(){var t=this.getChartType(),i=C.getLibraryResourceBundle("sap.ui.mdc");var I={icon:l.mMatchingIcon[t],text:i.getText("chart.CHART_TYPE_TOOLTIP",[t])};return I;};n.prototype.getManagedObjectModel=function(){return this._oManagedObjectModel;};n.prototype.update=function(i){var j=this.getAggregation("_chart");if(j){this._update(j,i);}else{this.oChartPromise.then(function(j){if(j){this._update(j,i);}}.bind(this));}};n.prototype._update=function(j,k){var I=this.getItems(),v,p,V=[],q=[],r=[],s={};if(k.name==="ignoreToolbarActions"||k.name==="p13nMode"){T.updateToolbar(this);return;}if(k.name==="data"&&k.type==="binding"&&k.mutation==="prepare"&&k.object.isA("sap.chart.Chart")){k.bindingInfo.sorter=this._getSorters();}this._aInResultProperties=[];for(var i=0;i<I.length;i++){p=I[i];v=p.getVizItemType()=="Measure"?j.getMeasureByName(p.getKey()):j.getDimensionByName(p.getKey());if(!v){continue;}if(p.getVisible()){if(p.getVizItemType()=="Measure"){V.push(v.getName());if(p.getDataPoint()){s[v.getName()]=p.getDataPoint();}}else{q.push(v.getName());}this._aInResultProperties.push(v.getName());}if(p.getVizItemType()=="Dimension"){if(p.getInResult()){r.push(v.getName());this._aInResultProperties.push(v.getName());}}}var R=false;if(!e(q,j.getVisibleDimensions())){j.setVisibleDimensions(q);R=true;}if(!e(V,j.getVisibleMeasures())){j.setVisibleMeasures(V);R=true;}if(!e(r,j.getInResultDimensions())){j.setInResultDimensions(r);R=true;}if(R){this._rebind();this._updateSemanticalPattern(j,V,s);this._updateColoring(j,q,V);}if(h&&this.getAggregation("_breadcrumbs")){h._updateDrillBreadcrumbs(this,this.getAggregation("_breadcrumbs"));}};n.prototype._updateSemanticalPattern=function(i,v,j){for(var k=0;k<v.length;k++){var p=j[v[k]];if(p){if(p.targetValue||p.foreCastValue){var A=i.getMeasureByName(v[k]);A.setSemantics("actual");if(p.targetValue!=null){var r=i.getMeasureByName(p.targetValue);if(r){r.setSemantics("reference");}else{L.error("sap.ui.mdc.Chart: "+p.targetValue+" is not a valid measure");}}if(p.foreCastValue){var P=i.getMeasureByName(p.foreCastValue);if(P){P.setSemantics("projected");}else{L.error("sap.ui.comp.SmartChart: "+p.ForecastValue.Path+" is not a valid measure");}}A.setSemanticallyRelatedMeasures({referenceValueMeasure:p.targetValue,projectedValueMeasure:p.foreCastValue});}}}};n.prototype._updateColoring=function(i,v,V,j){var p=this.getProperty("_colorings"),k;if(p&&p.Criticality){var A;for(k=0;k<v.length;k++){if(p.Criticality.DimensionValues[v[k]]){A={coloring:"Criticality",parameters:{dimension:v[k]}};delete p.Criticality.MeasureValues;break;}}if(!A){delete p.Criticality.DimensionValues;for(var s in p.Criticality.MeasureValues){if(V.indexOf(s)==-1){delete p.Criticality.MeasureValues[s];}}A={coloring:"Criticality",parameters:{measure:V}};}if(A){i.setColorings(p);i.setActiveColoring(A);}}};n.prototype._prepareSelection=function(){if(g){g.prepareChart(this);}else{if(!this.oSelectionHandlerPromise){this.oSelectionHandlerPromise=new Promise(function(r,i){sap.ui.require(["sap/ui/mdc/chart/SelectionHandler"],function(j){g=j;r(true);});});}this.oSelectionHandlerPromise.then(function(){g.prepareChart(this);}.bind(this));}};n.prototype._getSorters=function(){var s;var i=this.getSortConditions()?this.getSortConditions().sorters:[];i.forEach(function(j){if(this._aInResultProperties.indexOf(j.name)!=-1){var k=new S(j.name,j.descending);if(s){s.push(k);}else{s=[k];}}}.bind(this));return s;};n.prototype._rebind=function(){var i=this.getAggregation("_chart"),j=i&&i.getBinding("data");if(!j){return;}var s=this._getSorters();if(s){j.sort(s);}};n.prototype._addCriticality=function(i){var j=this.getProperty("_colorings");j=j||{Criticality:{DimensionValues:{},MeasureValues:{}}};var k=i.getCriticality(),p={};if(i.getVizItemType()=="Dimension"){for(var K in k){p[K]={Values:k[K]};}j.Criticality.DimensionValues[i.getKey()]=p;}else{for(var K in k){p[K]=k[K];}j.Criticality.MeasureValues[i.getKey()]=p;}this.setProperty("_colorings",j);};n.prototype.getCollectionModel=function(){var B=this.getBindingInfo("data");return B?this.getModel(B.model):null;};n.prototype.getCollectionPath=function(){var B=this.getBindingInfo("data");return B?B.path:null;};n.prototype.done=function(){return this.oChartPromise;};return n;},true);
