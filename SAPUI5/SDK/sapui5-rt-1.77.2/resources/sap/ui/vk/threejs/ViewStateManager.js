/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ContentConnector","../ViewStateManagerBase","./thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight","../AnimationTrackType","../AnimationTrackValueType","../AnimationMath"],function(v,C,V,t,a,b,d,e,S,O,R,N,f,H,g,h,A,k,m){"use strict";var n;var o=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var p=o.getMetadata().getParent().getClass().prototype;o.prototype.init=function(){if(p.init){p.init.call(this);}this._channel=0;this._layers=new THREE.Layers();this._layers.set(this._channel);this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._outlineRenderer=new f(1.0);this._outlinedNodes=new Set();this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1.0);this._visibilityTracker=new n();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this._selectionColor=new THREE.Color(0xC0C000);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._customPositionedNodes=new Set();this._jointMap=new Map();this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new H();this._transitionHighlightPlayer=new H();v.getEventBus().subscribe("sap.ui.vk","activateView",this._onViewActivated,this);};o.prototype.exit=function(){v.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onViewActivated,this);};o.prototype._setContent=function(c){var s=null;if(c&&c instanceof S){s=c;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}};o.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};o.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};o.prototype._handleContentReplaced=function(c){var i=c.getParameter("newContent");this._setContent(i);};o.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;return this;};o.prototype._setNodeHierarchy=function(c){var i=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear();}if(c){this._nodeHierarchy=c;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._initialState={visible:[],hidden:[]};var j=this;var l=c.findNodesByName();l.forEach(function(q){(q.layers.test(j._layers)?j._initialState.visible:j._initialState.hidden).push(q);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(c!==i){this.fireNodeHierarchyReplaced({oldNodeHierarchy:i,newNodeHierarchy:c});}return this;};o.prototype._handleNodeReplaced=function(c){var r=c.getParameter("ReplacedNodeRef");var i=c.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(i,true);this.setSelectionState(r,false);}};o.prototype._handleNodeUpdated=function(c){var i=c.getParameter("nodeRef");if(this.getSelectionState(i)){this.setSelectionState(i,false);this.setSelectionState(i,true);}};o.prototype._renderOutline=function(r,s,i){var c=d(this._outlineColorABGR);var j=new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0);this._outlineRenderer.render(r,s,i,Array.from(this._outlinedNodes),j,this._jointCollection);};o.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};o.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};o.prototype.getCurrentView=function(){var c=sap.ui.getCore().byId(this.getViewManager());if(!c){return null;}var i=c.getActiveView();return i;};o.prototype.resetNodeProperty=function(c,i){var j=this.getCurrentView();if(!j){return;}var l=j.getNodeInfos();if(l){var q=[];q.push(c);if(this._jointCollection&&this._jointCollection.length>0){for(var r=0;r<this._jointCollection.length;r++){var s=this._jointCollection[r];if(!s.node||!s.parent){continue;}var w=s.parent;if(w!==c){break;}q.push(s.node);}}l.forEach(function(x){if(!q.includes(x.target)){return;}if(!i||i!=="opacity"){var y={nodeRefs:[],positions:[]};var z;var B;var D;if(x.transform){var E=new THREE.Vector3();var F=new THREE.Quaternion();var G=new THREE.Vector3();var I=u(x.transform);I.decompose(E,F,G);z=E.toArray();B=F.toArray();D=G.toArray();}else if(x.scale&&x.rotate&&x.translate){z=x.translate.slice();B=x.rotate.slice();D=x.scale.slice();}if(z){y.nodeRefs.push(x.target);y.positions.push({translation:z,quaternion:B,scale:D});this.setTransformation(y.nodeRefs,y.positions);}}else{c._vkSetOpacity(x.opacity,this._jointCollection);var J={changed:c,opacity:l.opacity};this.fireOpacityChanged(J);}}.bind(this));}};o.prototype.getVisibilityComplete=function(){var c=this.getNodeHierarchy(),i=c.findNodesByName(),j=[],l=[];i.forEach(function(q){var r=c.createNodeProxy(q);var s=r.getVeId();c.destroyNodeProxy(r);if(s){if(this.getVisibilityState(q)){j.push(s);}else{l.push(s);}}},this);return{visible:j,hidden:l};};o.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};o.prototype.getVisibilityState=function(c){var l=this._layers;return Array.isArray(c)?c.map(function(i){return i.layers.test(l);}):c.layers.test(l);};o.prototype.setVisibilityState=function(c,i,r){if(!Array.isArray(c)){c=[c];}var j=Array.isArray(i);var l=[];var q=c;if(r){q=[];c.forEach(function(E,F){var G=this._collectNodesRecursively(E);q=q.concat(G);var I=l.length;l.length=I+G.length;l.fill(j?i[F]:i,I);},this);}else if(!j){l.length=q.length;l.fill(i);}else{l=i;}var s=[];var w=new Set();var x=this._layers,y=this._channel;var z=q.filter(function(E,F){if(w.has(E)){return false;}w.add(E);var z=E?E.layers.test(x)!=l[F]:false;if(z){s.push(l[F]);}return z;},this);if(z.length>0){var B={visible:[],hidden:[]};z.forEach(function(E,F){if(s[F]){E.layers.enable(y);B.visible.push(E);}else{E.layers.disable(y);B.hidden.push(E);}},this);if(this.getShouldTrackVisibilityChanges()){z.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}if(this._scene.getEnableDivAnnotations()){var D=this._scene.getAnnotations();B.visible.forEach(function(E){var F=E.userData.nodeId;var G=D.get(F);if(G){G.setVisible(true);}});B.hidden.forEach(function(E){var F=E.userData.nodeId;var G=D.get(F);if(G){G.setVisible(false);}});}this.fireVisibilityChanged(B);}return this;};o.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};o.prototype.enumerateOutlinedNodes=function(c){this._outlinedNodes.forEach(c);return this;};o.prototype.getSelectionState=function(c){var s=this._selectedNodes;function i(j){return s.has(j);}return Array.isArray(c)?c.map(i):i(c);};o.prototype._isAChild=function(c,i){var j=c.parent;while(j){if(i.has(j)){return true;}j=j.parent;}return false;};o.prototype._AddBoundingBox=function(c){if(c.userData.boundingBox===undefined){c.userData.boundingBox=new THREE.Box3();c._vkCalculateObjectOrientedBoundingBox();}if(!c.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&c.userData.boxHelper===undefined){var i=new THREE.Box3Helper(c.userData.boundingBox,0xffff00);i.material.color=this._selectionColor;this._boundingBoxesScene.add(i);i.parent=c;c.userData.boxHelper=i;}};o.prototype._RemoveBoundingBox=function(c){if(c.userData.boundingBox!==undefined){delete c.userData.boundingBox;}if(c.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(c.userData.boxHelper);delete c.userData.boxHelper;}};o.prototype._updateBoundingBoxesIfNeeded=function(){var c=new Set();this._selectedNodes.forEach(function(i){var j=i.parent;while(j){if(this._selectedNodes.has(j)){c.add(j);}j=j.parent;}}.bind(this));c.forEach(function(i){i._vkCalculateObjectOrientedBoundingBox();});};o.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(c){if(c.userData.boundingBox){c._vkCalculateObjectOrientedBoundingBox();}});};o.prototype.setShowSelectionBoundingBox=function(c){this._showSelectionBoundingBox=c;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(i){this._AddBoundingBox(i);}.bind(this));}else{this._selectedNodes.forEach(function(i){this._RemoveBoundingBox(i);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};o.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};o.prototype._isAncestorSelected=function(c){c=c.parent;while(c){if(this._selectedNodes.has(c)){return true;}c=c.parent;}return false;};o.prototype._updateHighlightColor=function(c,j){var s=j||this._selectedNodes.has(c);c.userData.highlightColor=s?this._highlightColorABGR:undefined;c._vkUpdateMaterialColor();var q=c.children;for(var i=0,l=q.length;i<l;i++){var r=q[i].userData;if(r&&r.objectType===O.Hotspot){continue;}this._updateHighlightColor(q[i],s);}};o.prototype.setSelectionState=function(c,s,r,i){if(!Array.isArray(c)){c=[c];}c=(r||this.getRecursiveSelection()?this._collectNodesRecursively(c):c).filter(function(q,w,x){return x.indexOf(q)===w;});if(this.getRecursiveSelection()&&!s){c=this._nodeHierarchy._appendAncestors(c);}var j=c.filter(function(q){return this._selectedNodes.has(q)!==s;},this);if(j.length>0){j.forEach(function(q){if(q){this._selectedNodes[s?"add":"delete"](q);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](q);}}},this);j.forEach(function(q){if(q){this._updateHighlightColor(q,s||this._isAncestorSelected(q));}},this);if(this._scene.getEnableDivAnnotations()){var l=this._scene.getAnnotations();j.forEach(function(q){var w=q.userData.nodeId;var x=l.get(w);if(x){x.setSelected(s);}});}if(!i){this.fireSelectionChanged({selected:s?j:[],unselected:s?[]:j});}}return this;};o.prototype.setSelectionStates=function(s,c,r,i){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(c)){c=[c];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);c=(r||this.getRecursiveSelection()?this._collectNodesRecursively(c):c);if(this.getRecursiveSelection()){c=this._nodeHierarchy._appendAncestors(c,s);}var j=s.filter(function(w){return this._selectedNodes.has(w)===false;},this);var l=c.filter(function(w){return this._selectedNodes.has(w)===true;},this);if(j.length>0||l.length>0){j.forEach(function(w){this._selectedNodes.add(w);this._updateHighlightColor(w,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(w);}},this);l.forEach(function(w){this._selectedNodes.delete(w);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(w);}},this);l.forEach(function(w){this._updateHighlightColor(w,this._isAncestorSelected(w));},this);if(this._scene.getEnableDivAnnotations()){var q=this._scene.getAnnotations();j.forEach(function(w){var x=w.userData.nodeId;var y=q.get(x);if(y){y.setSelected(true);}});l.forEach(function(w){var x=w.userData.nodeId;var y=q.get(x);if(y){y.setSelected(false);}});}if(!i){this.fireSelectionChanged({selected:j,unselected:l});}}return this;};o.prototype.setOutlineColor=function(c){switch(typeof c){case"number":this._outlineColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._outlineColorABGR=e(a(c));}break;default:return this;}this.fireOutlineColorChanged({outlineColor:b(d(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this;};o.prototype.getOutlineColor=function(i){return i?this._outlineColorABGR:b(d(this._outlineColorABGR));};o.prototype.getOutliningState=function(c){var i=this._outlinedNodes;function j(l){return i.has(l);}return Array.isArray(c)?c.map(j):j(c);};o.prototype.setOutliningStates=function(c,i,r,j){if(!Array.isArray(c)){c=[c];}if(!Array.isArray(i)){i=[i];}c=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(c):c);i=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(i):i);if(this.getRecursiveOutlining()){i=this._nodeHierarchy._appendAncestors(i,c);}var l=c.filter(function(s){return this._outlinedNodes.has(s)===false;},this);var q=i.filter(function(s){return this._outlinedNodes.has(s)===true;},this);if(l.length>0||q.length>0){l.forEach(function(s){this._outlinedNodes.add(s);},this);q.forEach(function(s){this._outlinedNodes.delete(s);},this);if(!j){this.fireOutliningChanged({outlined:l,unoutlined:q});}}return this;};o.prototype.setOutlineWidth=function(w){this._outlineWidth=w;this._outlineRenderer.setOutlineWidth(w);this.fireOutlineWidthChanged({width:w});return this;};o.prototype.getOutlineWidth=function(){return this._outlineWidth;};o.prototype._collectNodesRecursively=function(c){var r=[],i=this;if(!Array.isArray(c)){c=[c];}c.forEach(function collectChildNodes(j){r.push(j);i._nodeHierarchy.enumerateChildren(j,collectChildNodes,false,true);});return r;};o.prototype._getOpacity=function(c){return c.userData.opacity!==undefined?c.userData.opacity:null;};o.prototype.getOpacity=function(c){if(Array.isArray(c)){return c.map(this._getOpacity,this);}else{return this._getOpacity(c);}};o.prototype.setOpacity=function(c,i,r){if(!Array.isArray(c)){c=[c];}var j=Array.isArray(i);if(i==null){i=undefined;}else if(j){i.forEach(function(z,B){if(z==null){i[B]=undefined;}});}var l=[];var q=c;if(!j){l.length=q.length;l.fill(i);}else{l=i;}var s=[];var w=new Set();var x=q.filter(function(z,B){if(w.has(z)){return false;}w.add(z);var x=z?z.userData.opacity!==l[B]:false;if(x){s.push(l[B]);}return x;},this);if(x.length>0){x.forEach(function(z,B){z._vkSetOpacity(s[B],this._jointCollection);},this);var y={changed:x,opacity:j?s:s[0]};this.fireOpacityChanged(y);}return this;};o.prototype._getTintColorABGR=function(c){return c.userData.tintColor!==undefined?c.userData.tintColor:null;};o.prototype._getTintColor=function(c){return c.userData.tintColor!==undefined?b(d(c.userData.tintColor)):null;};o.prototype.getTintColor=function(c,i){var j=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(c)){return c.map(this[j],this);}else{return this[j](c);}};o.prototype.setTintColor=function(c,i,r){if(!Array.isArray(c)){c=[c];}var j=function(D){var E=null;switch(typeof D){case"number":E=D;break;case"string":if(sap.ui.core.CSSColor.isValid(D)){E=e(a(D));}break;default:E=undefined;break;}return E;};var l=Array.isArray(i);var q=[];var s=c;if(r){s=[];c.forEach(function(D,E){var F=this._collectNodesRecursively(D);s=s.concat(F);var G=q.length;q.length=G+F.length;q.fill(l?i[E]:i,G);},this);}else if(!l){q.length=s.length;q.fill(i);}else{q=i;}var w=[];var x=new Set();var y=s.filter(function(D,E){if(x.has(D)){return false;}x.add(D);var y=D?D.userData.tintColor!==j(q[E]):false;if(y){w.push(q[E]);}return y;},this);if(y.length>0){var z=[];y.forEach(function(D,E){var F=j(w[E]);D._vkSetTintColor(F);z.push(F);},this);var B={changed:y,tintColor:l?w:w[0],tintColorABGR:l?z:z[0]};this.fireTintColorChanged(B);}return this;};o.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=e(a(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(i){this._updateHighlightColor(i,true);},this);}this.fireHighlightColorChanged({highlightColor:b(d(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};o.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:b(d(this._highlightColorABGR));};o.prototype.getRestTransformationUsingJoint=function(c){var j=this._jointMap.get(c);if(j&&j.translation&&j.scale&&j.quaternion){return j;}else{return this.getRestTransformation(c);}};o.prototype.getRelativeTransformation=function(c){var i=false;var j=this.getCurrentView();if(j){var l=j.getPlayback(0);if(l&&l.getReversed()){i=true;}}var q=function(s){var w=this.getRestTransformation(s,i);var x=[s.position.x-w.translation[0],s.position.y-w.translation[1],s.position.z-w.translation[2]];var y=new THREE.Quaternion(w.quaternion[0],w.quaternion[1],w.quaternion[2],w.quaternion[3]);var z=new THREE.Matrix4().makeRotationFromQuaternion(y);var B=new THREE.Matrix4().getInverse(z);var M=new THREE.Matrix4();var D=new THREE.Matrix4();M.makeRotationFromQuaternion(s.quaternion);D.multiplyMatrices(M,B);var E=new THREE.Quaternion().setFromRotationMatrix(D);var F=E.toArray();var G=[s.scale.x/w.scale[0],s.scale.y/w.scale[1],s.scale.z/w.scale[2]];return{translation:x,quaternion:F,scale:G};}.bind(this);if(!Array.isArray(c)){return q(c);}var r=[];c.forEach(function(s){r.push(q(s));});return r;};o.prototype.getTransformationWorld=function(c){var i=function(j){var l=new THREE.Vector3();var s=new THREE.Vector3();var q=new THREE.Quaternion();j.updateMatrixWorld();j.matrixWorld.decompose(l,q,s);return{translation:l.toArray(),quaternion:q.toArray(),scale:s.toArray()};};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};o.prototype.getTransformation=function(c){var i=function(j){return{translation:this.getTranslation(j),quaternion:this.getRotation(j,R.Quaternion),scale:this.getScale(j)};}.bind(this);if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};o.prototype.getTranslation=function(c){var i=function(j){return j.position.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};o.prototype.getScale=function(c){var i=function(j){return j.scale.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};o.prototype._convertQuaternionToAngleAxis=function(q){if(q.w>1){q.normalize();}if(q.w>0.9999&&q.x<0.0001&&q.y<0.0001&&q.z<0.0001){q.w=1;q.x=0;q.y=0;q.z=0;}var c=2*Math.acos(q.w);var x;var y;var z;var s=Math.sqrt(1-q.w*q.w);if(s<0.0001){x=1;y=0;z=0;}else{x=q.x/s;y=q.y/s;z=q.z/s;}return[x,y,z,c];};o.prototype.getRotation=function(c,r){var i=function(l){var q=l.quaternion;var j;switch(r){case R.AngleAxis:j=this._convertQuaternionToAngleAxis(q);break;case R.Euler:var s=new THREE.Euler();s.setFromQuaternion(q);j=s.toArray();break;default:j=q.toArray();}return j;};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(l){j.push(i(l));});return j;};o.prototype.setTransformation=function(c,i){var j=Array.isArray(c);if(!Array.isArray(c)){c=[c];}var l={changed:[],transformation:[]};var q=function(r){return{position:r.position.toArray(),quaternion:r.quaternion.toArray(),scale:r.scale.toArray()};};if(!i){c.forEach(function(r){if(r.userData.position&&r.userData.quaternion&&r.userData.scale){r.position=r.userData.position;r.quaternion=r.userData.quaternion;r.scale=r.userData.scale;r.updateMatrix();delete r.userData.position;delete r.userData.quaternion;delete r.userData.scale;}this._customPositionedNodes.delete(r);l.changed.push(r);l.transformation.push(q(r));},this);}else{if(!Array.isArray(i)){i=[i];}c.forEach(function(r,s){var w=r.userData;if(!w){return;}if(!w.position){w.position=r.position.clone();}if(!w.quaternion){w.quaternion=r.quaternion.clone();}if(!w.scale){w.scale=r.scale.clone();}var x=i[s];if(x.transform){var y=u(x.transform);y.decompose(r.position,r.quaternion,r.scale);}else{r.position.fromArray(x.translation);r.scale.fromArray(x.scale);if(x.quaternion){r.quaternion.fromArray(x.quaternion);}else if(x.angleAxis){var z=new THREE.Vector3(x.angleAxis[0],x.angleAxis[1],x.angleAxis[2]);r.quaternion.setFromAxisAngle(z,x.angleAxis[3]);}else if(x.euler){var B=new THREE.Euler();B.fromArray(x.euler[0],x.euler[1],x.euler[2],x.euler[3]);r.quaternion.setFromEuler(B);}}r.updateMatrix();this._customPositionedNodes.add(r);l.changed.push(r);l.transformation.push(q(r));},this);}if(!j){l.changed=l.changed[0];l.transformation=l.transformation[0];}this.fireTransformationChanged(l);return this;};o.prototype.getJoints=function(){return this._jointCollection;};o.prototype.setJoints=function(j){this._jointCollection=[];if(!j){return this;}var c=new Set();this._jointMap.clear();j.forEach(function(l){if(!l.node||!l.parent){return;}c.add(l.node);this._jointMap.set(l.node,l);}.bind(this));while(c.size>0){var i=c.values().next().value;c.delete(i);var l=this._jointMap.get(i);var q=[l];var r=[];var s=l.parent;while(s){l=this._jointMap.get(s);if(l!==undefined){if(c.delete(s)){q.push(l);}if(r.length>0){l.nodesToUpdate=l.nodesToUpdate||[];while(r.length>0){var w=r.pop();if(l.nodesToUpdate.indexOf(w)>=0){break;}l.nodesToUpdate.push(w);}}r.length=0;s=l.parent;}else{r.push(s);s=s.parent;}}while(q.length>0){this._jointCollection.push(q.pop());}}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(l){if(!l.node||!l.parent){return;}l.translation=null;l.scale=null;l.quaternion=null;if(l.node.userData){l.node.userData.offsetTranslation=null;l.node.userData.offsetQuaternion=null;l.node.userData.offsetScale=null;l.node.userData.originalRotationType=null;}});this._jointCollection.forEach(function(l){this._updateJointNode(l);}.bind(this));}return this;};o.prototype._updateJointNode=function(j){if(!j.node||!j.parent){return;}if(j.translation&&j.quaternion&&j.scale){return;}var c=false;var i=this.getCurrentView();if(i){var l=i.getPlayback(0);if(l&&l.getReversed()){c=true;}}var q,s,r,w,x;var y=j.node;var z=new THREE.Matrix4();while(y){x=this.getRestTransformation(y,c);if(!x){continue;}q=new THREE.Vector3(x.translation[0],x.translation[1],x.translation[2]);s=new THREE.Vector3(x.scale[0],x.scale[1],x.scale[2]);r=new THREE.Quaternion(x.quaternion[0],x.quaternion[1],x.quaternion[2],x.quaternion[3]);w=new THREE.Matrix4().compose(q,r,s);z.premultiply(w);y=y.parent;}var B=j.parent;var P=new THREE.Matrix4();while(B){var D=this._jointMap.get(B);if(D){if(!D.translation){this._updateJoint(D);}q=new THREE.Vector3(D.translation[0],D.translation[1],D.translation[2]);s=new THREE.Vector3(D.scale[0],D.scale[1],D.scale[2]);r=new THREE.Quaternion(D.quaternion[0],D.quaternion[1],D.quaternion[2],D.quaternion[3]);B=D.parent;}else{x=this.getRestTransformation(B,c);if(!x){continue;}q=new THREE.Vector3(x.translation[0],x.translation[1],x.translation[2]);s=new THREE.Vector3(x.scale[0],x.scale[1],x.scale[2]);r=new THREE.Quaternion(x.quaternion[0],x.quaternion[1],x.quaternion[2],x.quaternion[3]);B=B.parent;}w=new THREE.Matrix4().compose(q,r,s);P.premultiply(w);}var E=P.getInverse(P).multiply(z);E.decompose(q,r,s);j.translation=q.toArray();j.quaternion=r.toArray();j.scale=s.toArray();};o.prototype._updateMaterialInNode=function(c){var j=c.target;var i,l;if(j&&j.children){for(i=0;i<j.children.length;i++){l=j.children[i];if(l.userData&&l.userData.animatedColor){l._vkUpdateMaterialColor();}}}var q=j.userData.materialId;j.userData.materialId=c.materialId;var r=false;if(q===undefined){if(j.userData.materialId!==undefined){r=true;}}else if(q!==j.userData.materialId){r=true;}if(!r){return;}var s=null;if(j.userData.materialId){var w=this._scene.getMaterial(j.userData.materialId);if(w){s=w.getMaterialRef();}}if(j&&j.children){for(i=0;i<j.children.length;i++){l=j.children[i];if(s){l.material=s;l.userData.materialId=c.materialId;}else if(l.userData&&l.userData.initialMaterialId){var x=this._scene.getMaterial(l.userData.initialMaterialId);if(x){var y=x.getMaterialRef();l.material=y;l.userData.materialId=l.userData.initialMaterialId;}}if(l.material&&l.material.userData){l.userData.originalMaterial=l.material;l.material=l.material.clone();}}}};function u(c){return new THREE.Matrix4().set(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],0,0,0,1);}o.prototype._resetNodesStatusByCurrenView=function(c,s,i){var j=this.getNodeHierarchy();if(j){var l;if(c){l=c.getPlaybacks();}var q=c.getNodeInfos();if(q){this._nodesTransitionHelper.clear();var r={nodeRefs:[],positions:[]};var w=new THREE.Vector3();var x=new THREE.Quaternion();var y=new THREE.Vector3();q.forEach(function(D){if(D.target===null){return;}function E(I,J,K){for(var L=0;L<I.elements.length;L++){if(Math.abs(I.elements[L]-J.elements[L])>K){return false;}}return true;}if(D.transform){var F=u(D.transform);if(!E(F,D.target.matrix,1e-6)){if((!l||!l.length)&&i){var G=j.createNodeProxy(D.target);this._nodesTransitionHelper.setNodeForDisplay(G,F);}else{F.decompose(w,x,y);r.nodeRefs.push(D.target);r.positions.push({translation:w.toArray(),quaternion:x.toArray(),scale:y.toArray()});}}}else if(D.scale&&D.rotate&&D.translate){r.nodeRefs.push(D.target);r.positions.push({translation:D.translate.slice(),quaternion:D.rotate.slice(),scale:D.scale.slice()});}}.bind(this));if(c.userData&&c.userData.nodeStartDataByAnimation){c.userData.nodeStartDataByAnimation.forEach(function(D,E){if(D[A.Translate]&&D[A.Rotate]&&D[A.Scale]){r.nodeRefs.push(E);r.positions.push({translation:D[A.Translate].slice(),quaternion:D[A.Rotate].slice(),scale:D[A.Scale].slice()});}},this);}if(r.nodeRefs.length){this.setTransformation(r.nodeRefs,r.positions);}if(s){var z=[];var B=[];q.forEach(function(D){(D.visible?z:B).push(D.target);});this.setVisibilityState(j.getChildren()[0].children,false,true);this.setVisibilityState(z,true,false);this.setVisibilityState(B,false,false);this._startViewChangeNodeTransition();}}}};o.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var c=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){c=false;});var i=function(){if(c){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(i);}}.bind(this);window.requestAnimationFrame(i);};o.prototype._resetNodesMaterialAndOpacityByCurrenView=function(c){if(!c){return;}var i=c.getNodeInfos();if(i){i.forEach(function(l){if(!l.target){return;}this._updateMaterialInNode(l);}.bind(this));i.forEach(function(l){if(!l.target||!l.target.userData){return;}l.target.userData.opacity=l.opacity;});var j=this._scene.getSceneRef();j._vkSetOpacity(undefined,this._jointCollection);}this._selectedNodes.forEach(function(l){this._updateHighlightColor(l);}.bind(this));};o.prototype._onViewActivated=function(c,i,j){var l=this.getViewManager();if(!l||j.source.getId()!==l){return;}this.activateView(j.view,false,j.playViewGroup,j.notAnimateCameraChange);};o.prototype.activateView=function(c,i,j,l){this.fireViewStateApplying({view:c});this.setJoints(undefined);this._customPositionedNodes.clear();this._resetNodesMaterialAndOpacityByCurrenView(c);this._resetTransitionHighlight(c);this._resetNodesStatusByCurrenView(c,true,true);this._highlightPlayer.reset(c,this._scene);this.fireViewStateApplied({view:c,ignoreAnimationPosition:i,notAnimateCameraChange:l,playViewGroup:j});v.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:c,ignoreAnimationPosition:i,notAnimateCameraChange:l,playViewGroup:j});return this;};o.prototype.setHighlightDisplayState=function(s){if(s===g.playing){this._highlightPlayer.start((new Date()).getTime());}else if(s===g.stopped){this._highlightPlayer.stop();}else if(s===g.pausing){this._highlightPlayer.pause((new Date()).getTime());}this.fireHighlightColorChanged({highlightColor:b(d(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};o.prototype._startHighlight=function(){this._highlightPlayer.start((new Date()).getTime());return this;};o.prototype._playHighlight=function(){return this._highlightPlayer.play((new Date()).getTime());};o.prototype._resetTransitionHighlight=function(c){this._transitionHighlightPlayer.reset();this._transitionHighlightPlayer.fadeInNodes=[];this._transitionHighlightPlayer.fadeOutNodes=[];this._transitionHighlightPlayer.setViewStateManager(this);var j=c.getNodeInfos();if(!j){return;}var l=function(w,x,y){if(!w||!w.length){return;}for(var i=0;i<w.length;i++){var z=w[i];if(z.type==="Mesh"&&(!y||(y&&!y.includes(z)))){x.push(z);}l(z.children,x,y);}};var q=[];var r=[];var s=this;j.forEach(function(i){var w=i.target;var x=w.layers.test(s._layers);if(x&&!i.visible){q.push(w);}if(!x&&i.visible){r.push(w);}});l(r,this._transitionHighlightPlayer.fadeInNodes);l(q,this._transitionHighlightPlayer.fadeOutNodes,this._transitionHighlightPlayer.fadeInNodes);};o.prototype._startTransitionHighlight=function(c){var i=this._transitionHighlightPlayer.fadeInNodes;var j=this._transitionHighlightPlayer.fadeOutNodes;if(i&&i.length){var l=new h("FadeIn",{duration:c/500.0,opacities:[0.0,1.0],cycles:1});this._transitionHighlightPlayer.addHighlights(l,i);}if(j&&j.length){var q=new h("FadeOut",{duration:c/500.0,opacities:[1.0,0.0],cycles:1,fadeOut:true});this._transitionHighlightPlayer.addHighlights(q,j);}if((i&&i.length)||(j&&j.length)){this._transitionHighlightPlayer.start((new Date()).getTime());this._transitionHighlightPlayer.play((new Date()).getTime());return c;}else{return 0;}return 0;};o.prototype._playTransitionHighlight=function(){return this._transitionHighlightPlayer.play((new Date()).getTime());};o.prototype.updateRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(l){if(l.target!==c){return;}c.updateMatrix();var q=c.matrix.elements;var r=[q[0],q[4],q[8],q[12],q[1],q[5],q[9],q[13],q[2],q[6],q[10],q[14]];l.transform=r;});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(l){if(!l.node||!l.parent){return;}if(l.parent===c){l.translation=null;l.scale=null;l.quaternion=null;}});this._jointCollection.forEach(function(l){if(!l.node||!l.parent){return;}if(l.parent===c){this._updateJointNode(l);this.restoreRestTransformation(l.node);}}.bind(this));}return this;};o.prototype.restoreRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(q){if(q.target!==c){return;}if(q.transform){var r=u(q.transform);r.decompose(c.position,c.quaternion,c.scale);}else if(q.scale&&q.rotate&&q.translate){c.position.set(q.translate[0],q.translate[1],q.translate[2]);c.quaternion.set(q.rotate[0],q.rotate[1],q.rotate[2],q.rotate[3]);c.scale.set(q.scale[0],q.scale[1],q.scale[2]);}c.updateMatrix();});}var l={changed:[c],transformation:[{position:c.position.toArray(),quaternion:c.quaternion.toArray(),scale:c.scale.toArray()}]};this.fireTransformationChanged(l);return this;};o.prototype.setRestTransformation=function(c,i,q,s){var j=this.getCurrentView();if(!j){return this;}var l=j.getNodeInfos();if(l){l.forEach(function(r){if(r.target!==c){return;}if(!i||!q||!s){if(r.transform){var w=new THREE.Vector3();var x=new THREE.Quaternion();var y=new THREE.Vector3();var z=u(r.transform);z.decompose(w,x,y);if(!i){i=[w.x,w.y,w.z];}if(!s){s=[y.x,y.y,y.z];}if(!q){q=[x.x,x.y,x.z,x.w];}}else if(r.scale&&r.rotate&&r.translate){if(!i){i=r.translate.slice();}if(!s){s=r.scale.slice();}if(!q){q=r.rotate.slice();}}}var B=new THREE.Vector3(i[0],i[1],i[2]);var D=new THREE.Quaternion(q[0],q[1],q[2],q[3]);var E=new THREE.Vector3(s[0],s[1],s[2]);var F=new THREE.Matrix4();F.compose(B,D,E);var G=F.elements;r.transform=[G[0],G[4],G[8],G[12],G[1],G[5],G[9],G[13],G[2],G[6],G[10],G[14]];});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(r){if(!r.node||!r.parent){return;}if(r.parent===c){r.translation=null;r.scale=null;r.quaternion=null;}});this._jointCollection.forEach(function(r){if(!r.node||!r.parent){return;}if(r.parent===c){this._updateJointNode(r);this.restoreRestTransformation(r.node);}}.bind(this));}return this;};o.prototype.getRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}var r=1;if(i){i.forEach(function(l){if(l.target!==c){return;}if(l.opacity!==undefined&&l.opacity!==null){r=l.opacity;}});}return r;};o.prototype.setRestOpacity=function(c,i){var j;var l=this.getCurrentView();if(l){j=l.getNodeInfos();}if(j){j.forEach(function(q){if(q.target!==c){return;}q.opacity=i;});}return this;};o.prototype.restoreRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(l){if(l.target!==c){return;}var q=1;if(l.opacity!==undefined){q=l.opacity;}this.setOpacity(c,q);}.bind(this));}return this;};o.prototype.updateRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(l){if(l.target!==c){return;}if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){l.opacity=c.userData.opacity;}else{delete l.opacity;}});}return this;};o.prototype.getRestTransformationWorld=function(c){var j;var l=this.getCurrentView();if(l){j=l.getNodeInfos();}var r;if(j){var w=new THREE.Matrix4();while(c){for(var i=0;i<j.length;i++){var q=j[i];if(q.target!==c){continue;}var s;if(q.transform){s=u(q.transform);}else if(q.scale&&q.rotate&&q.translate){var x=new THREE.Vector3(q.translate[0],q.translate[1],q.translate[3]);var y=new THREE.Quaternion(q.rotate[0],q.rotate[1],q.rotate[2],q.rotate[3]);var z=new THREE.Vector3(q.scale[0],q.scale[1],q.scale[3]);s=new THREE.Matrix4().compose(x,y,z);}if(s){w.premultiply(s);}break;}c=c.parent;}var B=new THREE.Vector3();var D=new THREE.Quaternion();var E=new THREE.Vector3();w.decompose(B,D,E);r={};r.translation=B.toArray();r.quaternion=D.toArray();r.scale=E.toArray();}if(!r){r=this.getTransformationWorld(c);}return r;};o.prototype.getRestTransformation=function(c,i){var j;var l=this.getCurrentView();if(l){j=l.getNodeInfos();}var r;if(j){j.forEach(function(q){if(q.target!==c){return;}if(q.transform){var s=q.transform;var w=new THREE.Vector3();var x=new THREE.Quaternion();var y=new THREE.Vector3();var z=u(q.transform);z.decompose(w,x,y);if(i){var B=this._getEndTranslationInPreviousSequence(c);if(B){w.x-=B[0];w.y-=B[1];w.z-=B[2];}var D=this._getEndScaleInPreviousSequence(c);if(D){y.x/=D[0];y.y/=D[1];y.z/=D[2];}var E=this._getEndRotateInPreviousSequence(c);if(E){var F=new THREE.Quaternion(E[0],E[1],E[2],E[3]);x=F.inverse().normalize().multiply(x);}z.compose(w,x,y);var G=z.elements;s=[G[0],G[4],G[8],G[12],G[1],G[5],G[9],G[13],G[2],G[6],G[10],G[14]];}r={};r.translation=w.toArray();r.quaternion=x.toArray();r.scale=y.toArray();r.transformRowWise=s;r.transformColumnWise=[s[0],s[4],s[8],s[1],s[5],s[9],s[2],s[6],s[10],s[3],s[7],s[11]];}else if(q.scale&&q.rotate&&q.translate){r={};r.translation=q.translate.slice();r.quaternion=q.rotate.slice();r.scale=q.scale.slice();}}.bind(this));}if(!r){r={};r.translation=c.userData.position?c.userData.position.toArray():c.position.toArray();r.quaternion=c.userData.quaternion?c.userData.quaternion.toArray():c.quaternion.toArray();r.scale=c.userData.scale?c.userData.scale.toArray():c.scale.toArray();r.matrix=c.matrix.clone();}return r;};o.prototype._addToTransformation=function(c,j,q,s,l){var r={};var i;if(j){r.translation=[];for(i=0;i<3;i++){r.translation.push(j[i]+c.translation[i]);}}else{r.translation=c.translation;}if(s){r.scale=[];for(i=0;i<3;i++){r.scale.push(s[i]*c.scale[i]);}}else{r.scale=c.scale;}if(q){var w=new THREE.Quaternion(q[0],q[1],q[2],q[3]);var x=new THREE.Matrix4().makeRotationFromQuaternion(w);var y=new THREE.Quaternion(c.quaternion[0],c.quaternion[1],c.quaternion[2],c.quaternion[3]);var z=new THREE.Matrix4().makeRotationFromQuaternion(y);z.premultiply(x);y.setFromRotationMatrix(z);r.quaternion=[y.x,y.y,y.z,y.w];}else{r.quaternion=c.quaternion;}return r;};o.prototype.addToRestTransformation=function(c,i,q,s,j){var l=false;var r=this.getCurrentView();if(r){var w=r.getPlayback(0);if(w&&w.getReversed()){l=true;}}var x=this.getRestTransformation(c,l);if(!c.userData){c.userData={};}if(i){c.userData.offsetTranslation=i;}else{c.userData.offsetTranslation=null;}if(s){c.userData.offsetScale=s;}else{c.userData.offsetScale=null;}if(q){c.userData.offsetQuaternion=q;c.userData.originalRotationType=j;}else{c.userData.offsetQuaternion=null;c.userData.originalRotationType=null;}return this._addToTransformation(x,i,q,s,j);};o.prototype._setJointNodeMatrix=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(j){if(!j.node||!j.parent){return;}var c=j.node;if(c.userData.skipUpdateJointNode){return;}var i={};i.translation=j.translation.slice();i.scale=j.scale.slice();i.quaternion=j.quaternion.slice();var l=this._addToTransformation(i,c.userData.offsetTranslation,c.userData.offsetQuaternion,c.userData.offsetScale,c.userData.originalRotationType);c.position.fromArray(l.translation);c.scale.fromArray(l.scale);c.quaternion.fromArray(l.quaternion);c.updateMatrix();if(j.parent){j.parent.updateMatrixWorld();c.matrixWorld.multiplyMatrices(j.parent.matrixWorld,c.matrix);}else{c.matrixWorld.copy(c.matrix);}if(c.parent){c.matrix.getInverse(c.parent.matrixWorld).multiply(c.matrixWorld);}else{c.matrix.copy(c.matrixWorld);}c.matrix.decompose(c.position,c.quaternion,c.scale);if(j.nodesToUpdate){j.nodesToUpdate.forEach(function(s){if(s.matrixAutoUpdate){s.updateMatrix();}s.matrixWorld.multiplyMatrices(s.parent.matrixWorld,s.matrix);});}}.bind(this));}};o.prototype._getEndTranslationInPreviousSequence=function(c,s){var j=[0.0,0.0,0.0];if(s&&s._convertedFromAbsolute){return null;}var l=this.getCurrentView();if(!l){return null;}var q=l.getPlaybacks();for(var i=0;i<q.length;i++){var r=q[i];var w=r.getSequence();if(w===s){break;}if(!w||w._convertedFromAbsolute){continue;}var x=w.getNodeAnimation(c);if(!x){continue;}var y;var z;var B=x[A.Translate];if(B){y=B.getKeysCount();if(y){z=B.getKey(y-1).value;}}if(z){j[0]+=z[0];j[1]+=z[1];j[2]+=z[2];}}return j;};o.prototype._getEndScaleInPreviousSequence=function(c,s){var j=[1.0,1.0,1.0];if(s&&s._convertedFromAbsolute){return null;}var l=this.getCurrentView();if(!l){return null;}var q=l.getPlaybacks();for(var i=0;i<q.length;i++){var r=q[i];var w=r.getSequence();if(w===s){break;}if(!w||w._convertedFromAbsolute){continue;}var x=w.getNodeAnimation(c);if(!x){continue;}var y;var z;var B=x[A.Scale];if(B){y=B.getKeysCount();if(y){z=B.getKey(y-1).value;}}if(z){j[0]*=z[0];j[1]*=z[1];j[2]*=z[2];}}return j;};o.prototype._getEndOpacityInPreviousSequence=function(c,s){var j=1.0;if(s&&s._convertedFromAbsolute){return j;}var l=this.getCurrentView();if(!l){return j;}var q=l.getPlaybacks();for(var i=0;i<q.length;i++){var r=q[i];var w=r.getSequence();if(w===s){break;}if(!w||w._convertedFromAbsolute){continue;}var x=w.getNodeAnimation(c);if(!x){continue;}var y;var z;var B=x[A.Opacity];if(B){y=B.getKeysCount();if(y){z=B.getKey(y-1).value;}}if(z){j*=z;}}return j;};o.prototype._getEndRotateInPreviousSequence=function(c,s){if(s&&s._convertedFromAbsolute){return null;}var j=this.getCurrentView();if(!j){return null;}var l=j.getPlaybacks();var q=new THREE.Quaternion();for(var i=0;i<l.length;i++){var r=l[i];var w=r.getSequence();if(w===s){break;}if(!w||w._convertedFromAbsolute){continue;}var x=w.getNodeAnimation(c);if(!x){continue;}var y;var z;var B=x[A.Rotate];if(B){y=B.getKeysCount();if(y){z=B.getKey(y-1).value;}}if(z){var D=new THREE.Euler(z[0],z[1],z[2]);var E=new THREE.Quaternion().setFromEuler(D);q.premultiply(E);}}return[q.x,q.y,q.z,q.w];};o.prototype._getEndPropertyInPreviousSequence=function(c,i,s){if(i===A.Translate){return this._getEndTranslationInPreviousSequence(c,s);}else if(i===A.Scale){return this._getEndScaleInPreviousSequence(c,s);}else if(i===A.Rotate){return this._getEndRotateInPreviousSequence(c,s);}else if(i===A.Opacity){return this._getEndOpacityInPreviousSequence(c,s);}else{return null;}};o.prototype._convertTracksToRelative=function(s){if(s._convertionDone){return this;}s._convertedFromAbsolute=false;var c=this.getCurrentView();if(!c){return this;}var l=s.getNodeAnimation();if(!l||!l.length){return this;}var w=c.getNodeInfos();if(w){w.forEach(function(x){var y;for(var i=0;i<l.length;i++){if(x.target===l[i].nodeRef){y=l[i];break;}}if(!y){return;}var z=[0,0,0];var B=[1,1,1];var D=new THREE.Quaternion();var E=new THREE.Vector3();var F=new THREE.Vector3();if(x.transform){var G=u(x.transform);G.decompose(E,D,F);z=E.toArray();B=F.toArray();}else if(x.scale&&x.rotate&&x.translate){z=x.translate.slice();D=new THREE.Quaternion(x.rotate[0],x.rotate[1],x.rotate[2],x.rotate[3]);B=x.scale.slice();}else{x.target.matrix.decompose(E,D,F);z=E.toArray();B=F.toArray();}var j,I,J,K;var L=y[A.Translate];if(L&&L.getIsAbsoluteValue()){I=L.getKeysCount();for(j=0;j<I;j++){J=L.getKey(j);K=[J.value[0]-z[0],J.value[1]-z[1],J.value[2]-z[2]];L.updateKey(j,K);}L.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var M=y[A.Scale];if(M&&M.getIsAbsoluteValue()){I=M.getKeysCount();for(j=0;j<I;j++){J=M.getKey(j);K=[J.value[0]/B[0],J.value[1]/B[1],J.value[2]/B[2]];M.updateKey(j,K);}M.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var P=y[A.Opacity];if(P&&P.getIsAbsoluteValue()){var Q=this.getRestOpacity(x);I=P.getKeysCount();for(j=0;j<I;j++){J=P.getKey(j);K=J/Q;P.updateKey(j,K);}P.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var T=function(c1){var d1=0;var e1=2*Math.PI;if(c1>0){while(c1>e1-0.0001){d1+=e1;c1-=e1;}}else if(c1<0){while(c1<-e1+0.0001){d1-=e1;c1+=e1;}}return d1;};var U=y[A.Rotate];if(U&&U.getIsAbsoluteValue()){var W;var X=new THREE.Matrix4().makeRotationFromQuaternion(D);var Y=new THREE.Matrix4().getInverse(X);var Z=new THREE.Matrix4();var $=new THREE.Matrix4();I=U.getKeysCount();var _=U.getKeysType();for(j=0;j<I;j++){J=U.getKey(j);if(_===k.Quaternion){W=new THREE.Quaternion(J.value[0],J.value[1],J.value[2],J.value[3]);Z.makeRotationFromQuaternion(W);$.multiplyMatrices(Z,Y);W.setFromRotationMatrix($);K=W.toArray();U.updateKey(j,K);}else if(_===k.Euler){var q=m.neutralEulerToGlMatrixQuat(J.value);var r=m.glMatrixQuatToNeutral(q);W=new THREE.Quaternion(r[0],r[1],r[2],r[3]);Z=new THREE.Matrix4().makeRotationFromQuaternion(W);$.multiplyMatrices(Z,Y);W.setFromRotationMatrix($);var a1=m.neutralQuatToNeutralEuler(W,J.value[3]);K=[a1[0]+T(J.value[0]),a1[1]+T(J.value[1]),a1[2]+T(J.value[2]),J.value[3]];U.updateKey(j,K);}else if(j===0){var b1=new THREE.Vector3(J.value[0],J.value[1],J.value[2]);Z.makeRotationAxis(b1,J.value[3]);$.multiplyMatrices(Z,Y);W=new THREE.Quaternion().setFromRotationMatrix($);K=this._convertQuaternionToAngleAxis(W);U.updateKey(j,K);break;}}U.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}}.bind(this));}s._convertionDone=true;return this;};o.prototype._getTrackKeys=function(c){var i=[];var l=c.getKeysCount();for(var j=0;j<l;j++){var q=c.getKey(j);var r;if(Array.isArray(q.value)){r=q.value.slice();}else{r=q.value;}i.push({time:q.time,value:r});}return i;};o.prototype._setJointNodeOffsets=function(c){var j=this._jointMap.get(c);if(j){c.updateMatrixWorld();if(j.parent){j.parent.updateMatrixWorld();c.matrix.getInverse(j.parent.matrixWorld).multiply(c.matrixWorld);}else{c.matrix.copy(c.matrixWorld);}c.matrix.decompose(c.position,c.quaternion,c.scale);var i=c.position.toArray();c.userData.offsetTranslation=[i[0]-j.translation[0],i[1]-j.translation[1],i[2]-j.translation[2]];var l=c.scale.toArray();c.userData.offsetScale=[l[0]/j.scale[0],l[1]/j.scale[1],l[2]/j.scale[2]];var s=new THREE.Quaternion(j.quaternion[0],j.quaternion[1],j.quaternion[2],j.quaternion[3]);var q=new THREE.Matrix4().makeRotationFromQuaternion(s);var r=new THREE.Matrix4().getInverse(q);var M=new THREE.Matrix4();var w=new THREE.Matrix4();M.makeRotationFromQuaternion(c.quaternion);w.multiplyMatrices(M,r);var x=new THREE.Quaternion().setFromRotationMatrix(w);c.userData.offsetQuaternion=x.toArray();}return this;};o.prototype.setTranslationKey=function(c,i,s){var r;var j=false;var l=this.getCurrentView();if(l){var q=l.getPlayback(0);if(q&&q.getReversed()){j=true;}}var w=this._jointMap.get(c);if(w){r=w.translation.slice();c.updateMatrixWorld();if(w.parent){w.parent.updateMatrixWorld();c.matrix.getInverse(w.parent.matrixWorld).multiply(c.matrixWorld);}else{c.matrix.copy(c.matrixWorld);}}else{var x=this.getRestTransformation(c,j);r=x.translation;}c.matrix.decompose(c.position,c.quaternion,c.scale);var y=c.position.toArray();var z=[y[0]-r[0],y[1]-r[1],y[2]-r[2]];var B=this._getEndTranslationInPreviousSequence(c,s);if(B){z[0]-=B[0];z[1]-=B[1];z[2]-=B[2];}var D=s.getNodeAnimation(c,A.Translate);var E;if(!D){D=this._scene.createTrack(null,{trackValueType:k.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Translate,D);}else{E=this._getTrackKeys(D);}D.insertKey(i,z);var F=this._getTrackKeys(D);return{KeyValue:z,absoluteValue:y,offset:B,PreviousTrack:E,CurrentTrack:F};};o.prototype.setScaleKey=function(c,i,s){var r;var j=false;var l=this.getCurrentView();if(l){var q=l.getPlayback(0);if(q&&q.getReversed()){j=true;}}var w=this._jointMap.get(c);if(w){r=w.scale.slice();c.updateMatrixWorld();if(w.parent){w.parent.updateMatrixWorld();c.matrix.getInverse(w.parent.matrixWorld).multiply(c.matrixWorld);}else{c.matrix.copy(c.matrixWorld);}}else{var x=this.getRestTransformation(c,j);r=x.scale;}var y=c.scale.toArray();var z=[y[0]/r[0],y[1]/r[1],y[2]/r[2]];var B=this._getEndScaleInPreviousSequence(c,s);if(B){z[0]/=B[0];z[1]/=B[1];z[2]/=B[2];}var D=s.getNodeAnimation(c,A.Scale);var E;if(!D){D=this._scene.createTrack(null,{trackValueType:k.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Scale,D);}else{E=this._getTrackKeys(D);}D.insertKey(i,z);var F=this._getTrackKeys(D);return{KeyValue:z,absoluteValue:y,offset:B,PreviousTrack:E,CurrentTrack:F};};o.prototype.setRotationKey=function(c,i,j,s){var l=36;var q=[j[0],j[1],j[2],l];var r=s.getNodeAnimation(c,A.Rotate);if(r&&r.getKeysType()!==k.Euler){return null;}var w;if(!r){r=this._scene.createTrack(null,{trackValueType:k.Euler,isAbsoluteValue:false});s.setNodeAnimation(c,A.Rotate,r);}else{w=this._getTrackKeys(r);}r.insertKey(i,q);var x=this._getTrackKeys(r);var y=new THREE.Quaternion();var z=new THREE.Euler(j[0],j[1],j[2]);y.setFromEuler(z);var B=this._getEndRotateInPreviousSequence(c,s);if(B){var D=new THREE.Quaternion(B[0],B[1],B[2],B[3]);y.multiply(D);}var E=new THREE.Quaternion();var F=this._jointMap.get(c);if(F){E.fromArray(F.quaternion);}else{var G=false;var I=this.getCurrentView();if(I){var J=I.getPlayback(0);if(J&&J.getReversed()){G=true;}}var K=this.getRestTransformation(c,G);E.fromArray(K.quaternion);}y.multiply(E);return{KeyValue:q,absoluteValue:y.toArray(),offset:B,PreviousTrack:w,CurrentTrack:x};};o.prototype.getTotalOpacity=function(c){return c._vkGetTotalOpacity(this._jointCollection);};o.prototype.setTotalOpacity=function(c,i){var j=1;var l=this._jointMap.get(c);if(l&&l.parent){j=l.parent._vkGetTotalOpacity(this._jointCollection);}else if(c.parent){j=c.parent._vkGetTotalOpacity(this._jointCollection);}if(!c.userData){c.userData={};}var q=this.getOpacity(c);if(j!==0.0){q=i/j;}else{i=0.0;}c._vkSetOpacity(q,this._jointCollection);var r={changed:c,opacity:q};this.fireOpacityChanged(r);return{opacity:q,totalOpacity:i};};o.prototype.setOpacityKey=function(c,i,s){var j=1;if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){j=c.userData.opacity;}var r=this.getRestOpacity(c);j/=r;var l=this._getEndOpacityInPreviousSequence(c,s);if(l){j/=l;}var q=s.getNodeAnimation(c,A.Opacity);var w;if(!q){q=this._scene.createTrack(null,{trackValueType:k.Opacity});s.setNodeAnimation(c,A.Opacity,q);}else{w=this._getTrackKeys(q);}q.insertKey(i,j);var x=this._getTrackKeys(q);return{KeyValue:j,totalOpacity:this.getTotalOpacity(c),PreviousTrack:w,CurrentTrack:x};};n=function(){this._visibilityChanges=new Set();};n.prototype.getInfo=function(c){var i=[];this._visibilityChanges.forEach(function(j){var l=c.createNodeProxy(j);var q=l.getVeId();c.destroyNodeProxy(l);if(q){i.push(q);}else{i.push(c.getScene().nodeRefToPersistentId(j));}});return i;};n.prototype.clear=function(){this._visibilityChanges.clear();};n.prototype.trackNodeRef=function(c){if(this._visibilityChanges.has(c)){this._visibilityChanges.delete(c);}else{this._visibilityChanges.add(c);}};C.injectMethodsIntoClass(o);return o;});
