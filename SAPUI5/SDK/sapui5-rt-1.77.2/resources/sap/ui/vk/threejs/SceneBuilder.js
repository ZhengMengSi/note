/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./thirdparty/three","sap/base/Log","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","../ObjectType","../getResourceBundle","./MarchingCubes","../NodeContentType","./ThreeExtensions","../thirdparty/ie-polyfills"],function(q,t,L,B,U,T,O,P,D,A,a,V,b,C,c,d,f,g,h,n,o,p,r,s,R,M,u,v,w,N,x,y){"use strict";var S=function(e,i,j,k){this._id=S._nextId++;S._add(this);this._callouts=new Map();this._cameras=new Map();this._images=new Map();this._imageIdsAndTileWidths=new Map();this._imageTextures=new Map();this._geometries=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._geometryMeshes=new Map();this._materialMeshes=new Map();this._materialClones=new Map();this._joints=[];this._annotationViews=new Map();this._annotations=new Map();if(e){this._rootNode=e;this._nodes=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();this._animationHelper=new A(this);if(i){this._countentResource=i;var l=i.getNodeProxy();var m=l.getNodeHierarchy();this._vkScene=m.getScene();var j1=i.getSource();if(j1&&j1.name){this._sceneIdTreeNodesMap.set(j1.name,this._nodes);this._sceneIdRootNodeMap.set(j1.name,e);this._sceneIdViewGroupMap.set(j1.name,this._viewGroups);this._sceneIdViewMap.set(j1.name,this._views);this._currentSceneId=j1.name;}if(this._rootNode){if(!this._rootNode.userData){this._rootNode.userData={};}this._rootNode.userData.skipIt=!i.name;}}this._viewThumbnails=new Map();this._thrustlines=new Map();this._animations=new Map();this._animationTracks=new Map();this._jointNodesMap=new Map();this._jointParentsMap=new Map();this._resolve=j;this._reject=k;};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S.getById=function(i){return this._map.get(i);};S._add=function(e){S._map.set(e.getId(),e);return this;};var z=[R.Default,R.Default,R.Default,R.LineIllustration,R.SolidOutline,R.ShadedIllustration];S.prototype.setScene=function(i){if(i.result!==1){var e={status:i.result};switch(i.result){case-1:e.errorText=v().getText("LOADER_FILENOTFOUND");break;case-2:e.errorText=v().getText("LOADER_WRONGFILEFORMAT");break;case-3:e.errorText=v().getText("LOADER_WRONGPASSWORD");break;case-4:e.errorText=v().getText("LOADER_ERRORREADINGFILE");break;case-5:e.errorText=v().getText("LOADER_FILECONTENT");break;default:e.errorText=v().getText("LOADER_UNKNOWNERROR");}this._reject(e);}else{this._vkScene._setSceneBuilder(this);var j=this._cameras.get(i.cameraId);this._resolve({node:this._parentNode,camera:j,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,upAxis:i.upAxis,annotations:this._annotations,annotationViews:this._annotationViews,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(e,i,j,k){this._rootNode=e;this._nodes=new Map();this._nodes.set(i,e);if(!this._rootNode.userData){this._rootNode.userData={};}this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._sequenceIdToPlaybacks=new Map();this._viewGroups=new Map();this._views=new Map();if(j){this._sceneIdTreeNodesMap.set(j,this._nodes);this._sceneIdRootNodeMap.set(j,e);this._sceneIdViewGroupMap.set(j,this._viewGroups);this._sceneIdViewMap.set(j,this._views);this._currentSceneId=j;}if(k){this._vkScene=k;}return this;};S.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var i=this._sceneIdTreeNodesMap.get(e);if(i){this._nodes=i;}else{this._nodes=null;}var j=this._sceneIdRootNodeMap.get(e);if(j){this._rootNode=j;}else{this._rootNode=null;}this._currentSceneId=e;}};S.prototype.getNode=function(e,i){if(i){this._resetCurrentScene(i);if(this._nodes){return this._nodes.get(e);}}else{var j=this._sceneIdTreeNodesMap.values();var k=j.next();while(!k.done){var l=k.value.get(e);if(l){return l;}k=j.next();}}return null;};S.prototype.hasMesh=function(m){return this._meshSubmeshes.has(m);};S.prototype.hasImage=function(i){return this._images.has(i);};S.prototype.setNodePersistentId=function(e,i,j){if(!e.userData.treeNode){e.userData.treeNode={};}var k=null;if(e.userData.treeNode.sid){k=e.userData.treeNode.sid;delete(e.userData.treeNode.sid);}this._resetCurrentScene(j);e.userData.treeNode.sid=i;if(this._nodes){if(k){this._nodes.delete(k);}this._nodes.set(i,e);}return true;};var E=function(e){var m=new THREE.Matrix4();if(e.length===3){m.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){m.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){m.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return m;};var F={r:0.0235,g:0.0235,b:0.0235};var G={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(m){var e=new THREE.MeshPhongMaterial({color:0xaaaaaa});e.userData.defaultHighlightingEmissive=F;e.userData.defaultHighlightingSpecular=G;e.userData.materialUsed=0;e.userData.materialId=m;e.userData.toBeUpdated=true;var i=new M();i.setMaterialRef(e);this._vkScene.setMaterial(m,i);return e;};S.prototype._getMaterialRef=function(m){var e=this._vkScene.getMaterial(m);return e?e.getMaterialRef():null;};S.prototype.checkMaterialExists=function(m){if(this._getMaterialRef(m)===null){this._createTemporaryMaterial(m);return false;}return true;};S.prototype._attachMaterialClone=function(m,e){T.pushElementIntoMapArray(this._materialClones,m,e);};S.prototype._addDynamicObject=function(e,i){if(!this._rootNode.userData._vkDynamicObjects){this._rootNode.userData._vkDynamicObjects=[];}this._rootNode.userData._vkDynamicObjects.push(e);e._vkUpdate=i;};S.prototype.createNode=function(e,j){this._resetCurrentScene(j);var k=new THREE.Group();this._nodes.set(e.sid,k);var i;var l=this._jointNodesMap.get(e.sid);if(l&&l.length){for(i=0;i<l.length;i++){l[i].node=k;}}var m=this._jointParentsMap.get(e.sid);if(m&&m.length){for(i=0;i<m.length;i++){m[i].parent=k;}}var j1=this._nodes.get(e.parentId);(j1||this._rootNode).add(k);var k1=k.userData;k1.treeNode=e;if(e.closed){k1.closed=true;}if(e.selectable===false){k1.selectable=false;}if(e.visualisable===false){k1.skipIt=true;}if(e.metadata){k1.metadata=e.metadata;}if(e.veids){k1.veids=e.veids;}if(e.sid){k1.nodeId=e.sid;}if(e.name){k.name=e.name;}if(e.visible!==undefined){k.layers.mask=e.visible?(1|0):0;}if(j1&&j1.name&&k.name&&k.name===j1.name+" offset geometry"){k.layers=j1.layers;}else{var l1=j1;while(l1){if(l1.userData.closed){k.layers=l1.layers;break;}l1=l1.parent;}}if(j){var m1=j1;while(m1){if((m1.layers.mask&1)===0){k.layers.mask&=~1;break;}m1=m1.parent;}}if(e.renderOrder){k.renderOrder=e.renderOrder;}k1.opacity=e.opacity;if(e.transform){k.applyMatrix(E(e.transform));}k.updateMatrixWorld(true);if(e.transformType){k1.transformType=e.transformType;switch(e.transformType){case"BILLBOARD_VIEW":this._addDynamicObject(k,b.prototype._billboardViewUpdate);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(k,b.prototype._lockToViewportUpdate);break;default:break;}}if(e.materialId){k1.materialId=e.materialId;}if(e.meshId){this.setMeshNode(e.sid,e.meshId);}if(k.parent.userData.objectType===u.Hotspot){k1.objectType=u.Hotspot;}else if(k.parent.userData.objectType===u.PMI){k1.objectType=u.PMI;}else if(e.contentType==="HOTSPOT"){k1.objectType=u.Hotspot;}else if(e.contentType==="PMI"){k1.objectType=u.PMI;}if(e.contentType==="REFERENCE"){k._vkSetNodeContentType(N.Reference);}else if(e.contentType==="ANNOTATION"){k._vkSetNodeContentType(N.Annotation);}return k;};function H(e,m,l){var i;if(e.isPolyline){var j=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1});if(m){j.color.copy(m.color);}i=new THREE.LineSegments(e,j);}else{i=new THREE.Mesh(e,m);}if(e.isPositionQuantized){K(i,l.boundingBox);}U.increaseGeometryUsed(e);return i;}S.prototype.getChildNodeIds=function(e,j,k){this._resetCurrentScene(j);var l=this._nodes.get(e);var m=[];if(!l){return m;}if(l&&l.children){for(var i=0;i<l.children.length;i++){var j1=l.children[i];if(j1.userData.treeNode&&j1.userData.treeNode.sid){m.push(j1.userData.treeNode.sid);}else if(k&&j1.userData.submeshInfo&&j1.userData.submeshInfo.id){m.push(j1.userData.submeshInfo.id);}}}return m;};function I(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}return null;}function J(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}function K(m,e){if(e&&e.length===6){m.position.set((e[3]+e[0])*0.5,(e[4]+e[1])*0.5,(e[5]+e[2])*0.5);m.scale.set(Math.max(e[3]-e[0],Number.EPSILON),Math.max(e[4]-e[1],Number.EPSILON),Math.max(e[5]-e[2],Number.EPSILON));}}S.prototype.insertSubmesh=function(e){var m=this._getMaterialRef(e.materialId)||this._createTemporaryMaterial(e.materialId);var i,j;if(e.lods){var l=J(e.lods);if(!l){return false;}j=this._geometries.get(l.id);if(j){i=H(j,m,l);if(j.userData&&j.userData.noNormal&&e.materialId){this.updateMaterialForGeometryWithoutNormal(e.materialId);}}else{var k;var j1=I(e.lods);if(j1&&j1.data){var k1=T.base64ToUint8Array(j1.data);var l1=B.unpackSubDividedBoundingBox(k1);k=w.march(l1);}i=new THREE.Mesh(k?k:new THREE.BoxBufferGeometry(1,1,1),m);var m1=l.boundingBox;if(m1&&m1.length===6){var n1=new THREE.Matrix4();n1.scale(new THREE.Vector3(Math.max(m1[3]-m1[0],Number.EPSILON),Math.max(m1[4]-m1[1],Number.EPSILON),Math.max(m1[5]-m1[2],Number.EPSILON)));n1.setPosition(new THREE.Vector3((m1[3]+m1[0])*0.5,(m1[4]+m1[1])*0.5,(m1[5]+m1[2])*0.5));i.geometry.applyMatrix(n1);}i.userData.geometryId=l.id;i.userData.lodInfo=l;T.pushElementIntoMapArray(this._geometryMeshes,l.id,e.meshId);}}else{return false;}if(e.transform){i.applyMatrix(E(e.transform));}i.userData.submeshId=e.id;i.userData.initialMaterialId=e.materialId;i.userData.meshId=e.meshId;i.userData.materialId=e.materialId;i.userData.submeshInfo=e;T.pushElementIntoMapArray(this._materialMeshes,e.materialId,e.meshId);T.pushElementIntoMapArray(this._meshSubmeshes,e.meshId,i);var o1=this._meshNodes.get(e.meshId);if(o1){o1.forEach(function(p1){var q1=i.clone();q1.layers=p1.layers;if(p1.userData.materialId){q1.material=this._getMaterialRef(p1.userData.materialId)||i.material;}p1.add(q1);X(p1,e.materialId,this._materialClones);}.bind(this));}return true;};function Q(e,j,k,m){for(var i=0;i<e.length;i++){var l=e[i];if(j&&l.userData.geometryId===j&&l.geometry!==k){if(l.type==="Mesh"&&!k.isPolyline){l.geometry=k;if(k.isPositionQuantized){K(l,l.userData.lodInfo.boundingBox);}U.increaseGeometryUsed(k);}else{var j1=H(k,l.material,l.userData.lodInfo);j1.userData=l.userData;j1.layers=l.layers;j1.parent=l.parent;e[i]=j1;l.parent=null;}}}}function W(e,m,i,j){var k=e.children;k.forEach(function(l){if(l.userData.materialId===m){U.increaseMaterialUsed(i);l.material=i;delete l.userData.originalMaterial;l._vkUpdateMaterialOpacity();if(l.material!==i){T.pushElementIntoMapArray(j,m,l.material);}}});}function X(e,m,i){e.children.forEach(function(j){if(j.material&&(!m||m===j.material.userData.materialId)){var k=j.material;j._vkUpdateMaterialOpacity();if(j.material!==k){T.pushElementIntoMapArray(i,j.material.userData.materialId,j.material);}}});}function Y(e,l){var m=new Float32Array(e.length);var p0=new THREE.Vector3();var p1=new THREE.Vector3();var p2=new THREE.Vector3();var j1=new THREE.Vector3();var i,k1;for(i=0,k1=l.length;i<k1;i+=3){var pi=[l[i]*3,l[i+1]*3,l[i+2]*3];p0.fromArray(e,pi[0]);p1.fromArray(e,pi[1]).sub(p0);p2.fromArray(e,pi[2]).sub(p0);j1.crossVectors(p1,p2).normalize();for(var j=0;j<3;j++){var k=pi[j];m[k]+=j1.x;m[k+1]+=j1.y;m[k+2]+=j1.z;}}for(i=0,k1=m.length;i<k1;i+=3){j1.fromArray(m,i).normalize().toArray(m,i);}return m;}S.prototype.setGeometry=function(e){var i=new THREE.BufferGeometry();var j=e.data;var k=new THREE.BufferAttribute(new Uint16Array(j.indices),1);var l=new THREE.BufferAttribute(new Float32Array(j.points),3);i.setIndex(k);i.setAttribute("position",l);if(!e.isPolyline){if(!j.normals||j.normals.length!==l.array){j.normals=Y(l.array,k.array);}var m=new THREE.BufferAttribute(new Float32Array(j.normals),3);i.setAttribute("normal",m);if(j.uvs&&j.uvs.length*3===j.points.length*2){i.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}i.computeBoundingBox();i.computeBoundingSphere();i.isPositionQuantized=e.isPositionQuantized;i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);var j1=this._geometryMeshes.get(e.id);if(j1){for(var mi=0;mi<j1.length;mi++){var l1=j1[mi];var m1=this._meshNodes.get(l1);if(m1){for(var ni=0;ni<m1.length;ni++){Q(m1[ni].children,e.id,i);}}var o1=this._meshSubmeshes.get(l1);if(o1){Q(o1,e.id,i);}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype.setMeshNode=function(e,m){var i=this._nodes.get(e);if(i){T.pushElementIntoMapArray(this._meshNodes,m,i);var j=this._meshSubmeshes.get(m);if(j){j.forEach(function(k){var l=k.clone();l.layers=i.layers;if(i.userData.materialId){l.material=this._getMaterialRef(i.userData.materialId)||k.material;}i.add(l);}.bind(this));X(i,null,this._materialClones);}}};S.prototype.progress=function(e){L.log("reading progress:",e);};S.prototype.loadingFinished=function(i){if(this._fireLoadingFinished){this._fireLoadingFinished(i);}};S.prototype.getGeometry=function(e){return this._geometries.get(e);};var Z=[f.RectangularShape,f.CircularShape,f.None,f.TextGlow];var $=[c.Viewport,c.Screen,c.World];var _=[g.None,g.Solid,g.Dash,g.Dot,g.DashDot,g.DashDotDot];var a1=[n.None,n.Point,n.Arrow];var b1=[d.PlainText,d.HtmlText];var c1=[h.Left,h.Center,h.Right];function d1(e){var i=e.toString(16);if(e.length>=3){i=(((e[0]*255)<<16)|((e[1]*255)<<8)|(e[2]*255)).toString(16);}return"#"+"000000".substring(i.length)+i;}function e1(e){for(var i=0,l=e.length;i<l;i++){if(!isFinite(e[i])){return false;}}return true;}S.prototype.setViewAnnotations=function(e){e.nodes.forEach(function(i){if(i.contentType===N.Annotation){if(this._annotationViews.get(i.annotationId)){this._annotationViews.get(i.annotationId).viewIds.set(e.viewId,true);}else{var j=new Map();j.set(e.viewId,true);this._annotationViews.set(i.annotationId,{viewIds:j});}}},this);};S.prototype.createAnnotation=function(e,i){if(!e.position){this._annotations.set(e.id,{annotation:e,node:this._nodes.get(e.nodeId),targetNode:(e.attachment&&e.attachment.sid)?this._nodes.get(e.attachment.sid):null});return;}if(!e1(e.position)){return;}this._resetCurrentScene(i);var j=this._nodes.get(e.nodeId);var k=e.position;e.coordinateSpace|=0;var l=e.backgroundOpacity;if(!l){l=e.backgroundColour?e.backgroundColour[3]:0;}var m=e.borderOpacity;if(!m){m=e.borderColour?e.borderColour[3]:0;}var j1={node:j,coordinateSpace:$[e.coordinateSpace],style:Z[e.shape||0],width:e.width,height:e.height,backgroundColor:e.backgroundColour?d1(e.backgroundColour):"#fff",backgroundOpacity:l,borderColor:e.borderColour?d1(e.borderColour):"#000",borderOpacity:m,borderWidth:e.borderWidth,borderLineStyle:_[e.borderLineStyle]};if(e.encoding!==undefined){j1.encoding=b1[e.encoding];j1.font=e.font;j1.fontSize=e.fontSize;j1.fontWeight=Math.min(e.fontWeight,900);j1.fontItalic=e.fontItalic;j1.textColor=d1(e.textColor);j1.link=e.link;j1.horizontalAlignment=c1[e.textHorizontalAlignment];j1.position=new THREE.Vector3().fromArray(k);}else if(e.fontFace){j1.encoding=d.PlainText;j1.font=e.fontFace;j1.fontSize=Math.abs(e.fontSize);j1.fontWeight=Math.min(e.fontWeight,900);j1.textColor=d1(e.textColour);}else{j1.encoding=d.HtmlText;}if(e.coordinateSpace<2){if(!j1.positions){j1.position=new THREE.Vector3(k[0]*2-1,k[1]*-2+1,k[2]);}j1.renderOrder=(e.order|0)+1000;var k1=new b(j1);k1.setText(e.text);this._addDynamicObject(j,k1._update.bind(k1));}else{j1.anchorNode=this._nodes.get(e.sid)||this._rootNode;if(!j1.postion){j1.position=new THREE.Vector3().fromArray(k);}j1.depthTest=false;j1.renderOrder=e.order|0;if(e.alwaysOnTop){j1.renderOrder=1;}var l1=new C(j1);l1.setText(e.text);this._callouts.set(e.id,l1);this._addDynamicObject(j,l1._update.bind(l1));}};S.prototype.createImageNote=function(e,i){this._resetCurrentScene(i);var j=this._nodes.get(e.nodeId);j.updateMatrix();var k=new THREE.Vector3().fromArray(e.position);var l=e.width;var m=e.height;if(!e.properlyAligned){k.x+=e.width*0.5;k.y+=e.height*0.5;k.applyMatrix4(j.matrix);l=e.width*0.5*j.matrix.elements[0];m=e.height*0.5*j.matrix.elements[5];}var j1=new b({node:j,coordinateSpace:c.Screen,renderOrder:(e.order|0)+1000,position:k,width:l,height:m});var k1=this._getMaterialRef(e.labelMaterialId);j1.setMaterial(k1);this._addDynamicObject(j,j1._update.bind(j1));};S.prototype.insertLeaderLine=function(e,j){this._resetCurrentScene(j);var k=this._callouts.get(e.annotationId);if(k){var m=[];for(var i=0,l=e.points.length;i<l;i++){m.push(new THREE.Vector3().fromArray(e.points[i]));}var j1=this._getMaterialRef(e.materialId);var k1=this._nodes.get(e.startPointSid)||this._roteNode;k.addLeaderLine(m,k1,j1,a1[e.startPointHeadStyle],a1[e.endPointHeadStyle],e.pointHeadConstant,e.extensionLength);}};var f1=[o.DetailView,o.Cutaway];var g1=[p.Box,p.Circle,p.CircleLine,p.CirclePointer,p.CircleArrow,p.CircleBubbles,p.BoxLine,p.BoxNoOutline,p.SolidPointer,p.SolidArrow];S.prototype.createDetailView=function(i,e){this._resetCurrentScene(e);var j=this._nodes.get(i.nodeId);if(j){if(!i.properlyAligned){if(!i.shape){i.shape=i.leaderStyle?p.BoxLine:p.Box;}else{i.shape=[p.Circle,p.CircleLine,p.CirclePointer,p.CircleArrow,p.CircleBubbles][i.leaderStyle||0];}i.type=i.cutaway?o.Cutaway:o.DetailView;i.camera=i.camera?this.createCamera(i.camera):null;i.origin=new THREE.Vector2(j.position.x*2-1+j.scale.x,j.position.y*-2+1-j.scale.x);i.size=new THREE.Vector2(j.scale.x,j.scale.y);i.renderOrder=j.renderOrder;}else{i.type=f1[i.type];i.shape=g1[i.shape];i.camera=this._cameras.get(i.cameraId);i.origin=new THREE.Vector2().fromArray(i.origin);i.size=new THREE.Vector2().fromArray(i.size);}var k=[];if(i.visibleNodes){i.visibleNodes.forEach(function(j1){var j=this._nodes.get(j1);if(j){k.push(j);}else{L.warning("Unknown detailView visible node reference",j1);}}.bind(this));}var l=[];if(i.targetNodes){i.targetNodes.forEach(function(j1){var j=this._nodes.get(j1);if(j){l.push(j);}else{L.warning("Unknown detailView target node reference",j1);}}.bind(this));}var m=new D({name:i.name,camera:i.camera,type:i.type,shape:i.shape,borderWidth:i.borderWidth||0,backgroundColor:d1(i.backgroundColour),borderColor:d1(i.borderColour),origin:i.origin,size:i.size,attachmentPoint:new THREE.Vector3().fromArray(i.attachment),metadata:i.metadata,veId:i.veid,visibleNodes:k,targetNodes:l});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:m,node:j,renderOrder:i.renderOrder||0});}};S.prototype.insertThrustline=function(i){var e=this._nodes.get(i.thrustlineId);if(e&&!this._thrustlines.get(i.thrustlineId)){var j=new a({node:e,principleAxis:new THREE.Vector3().fromArray(i.principleAxis),material:this._getMaterialRef(i.materialId)});var k=[];var l=0;var m=0;var j1=0;for(var ii=0;ii<i.itemCount;ii++){var l1={};l1.target=this._nodes.get(i.targets[ii]);l1.majorAxisIndex=i.itemMajorAxisesIndices[ii];var bi;l1.basisAxises=[];j1=l+i.itemBasisAxisesCounts[ii];for(bi=l;bi<j1;bi++){var n1={};n1.x=i.itemBasisAxisesCoordinates[bi*3];n1.y=i.itemBasisAxisesCoordinates[bi*3+1];n1.z=i.itemBasisAxisesCoordinates[bi*3+2];l1.basisAxises.push(n1);}l=j1;l1.dimension={};l1.dimension.x=i.itemDimensionsCoordinates[ii*3];l1.dimension.y=i.itemDimensionsCoordinates[ii*3+1];l1.dimension.z=i.itemDimensionsCoordinates[ii*3+2];l1.center={};l1.center.x=i.itemCentersCoordinates[ii*3];l1.center.y=i.itemCentersCoordinates[ii*3+1];l1.center.z=i.itemCentersCoordinates[ii*3+2];l1.boundPoints=[];j1=m+i.itemBoundPointsCounts[ii];for(bi=m;bi<j1;bi++){var o1={};o1.x=i.itemBoundPointsCoordinates[bi*3];o1.y=i.itemBoundPointsCoordinates[bi*3+1];o1.z=i.itemBoundPointsCoordinates[bi*3+2];l1.boundPoints.push(o1);}m=j1;k.push(l1);}j.setItems(k);var p1=0;var q1=[];for(var si=0;si<i.segmentCount;si++){var s1={};s1.startItemIndex=i.segmentsStartItemIndices[si];s1.endItemIndex=i.segmentsEndItemIndices[si];s1.startBoundIndex=i.segmentsStartBoundIndices[si];s1.endBoundIndex=i.segmentsEndBoundIndices[si];s1.ratios=[];j1=p1+i.segmentRatioCounts[si];for(var ri=0;ri<j1;ri++){var u1={};u1.x=i.segmentRatiosCoordinates[ri*2];u1.y=i.segmentRatiosCoordinates[ri*2+1];s1.ratios.push(u1);}p1=j1;q1.push(s1);}j.setSegments(q1);this._thrustlines.set(i.thrustlineId,j);this._addDynamicObject(e,j._update.bind(j));}};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(e,i){this._resetCurrentScene(i);var j=this;e=[].concat(e);e.forEach(function(k){var l=j._nodes.get(k);if(l){j._decrementResourceCounters(l);j._nodes.delete(k);}});return this;};S.prototype.remove=function(e,j){this._resetCurrentScene(j);var k=this;e=[].concat(e);e.forEach(function(l){var m=k._nodes.get(l);if(m){k._decrementResourceCounters(m);if(m.parent){m.parent.remove(m);}k._nodes.delete(l);for(var i=0;i<m.children.length;i++){var j1=m.children[i];if(j1.userData&&j1.userData.treeNode&&j1.userData.treeNode.sid){k.remove(j1.userData.treeNode.sid,j);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(i){var j=i.userData.geometryUsed;if(j<=0){i.dispose();}});return this;};S.prototype.createCamera=function(e,i){this._resetCurrentScene(i);var j;if(e.ortho){j=new THREE.OrthographicCamera(-1,1,1,-1,e.near,e.far);}else{j=new THREE.PerspectiveCamera(e.fov*180/Math.PI,1,e.near,e.far);}if(e.origin){j.position.fromArray(e.origin);}if(e.up){j.up.fromArray(e.up);if(e.notUseDirectionVector){j.up.sub(j.position);}j.up.normalize();}if(e.target){var k=new THREE.Vector3().fromArray(e.target);if(!e.notUseDirectionVector){k.add(j.position);}j.lookAt(k);}if(e.ortho){j.zoom=e.zoom||0.02;}this._rootNode.userData.camera=j;var l=null;if(j.isOrthographicCamera){l=new O();}else if(j.isPerspectiveCamera){l=new P();}l.setCameraRef(j);l.setUsingDefaultClipPlanes(true);if(e.zoom===-1){l.setZoomNeedRecalculate(true);}var m=e.id;if(m){this._cameras.set(m,l);}this._rootNode.userData.camera=l;return l;};S.prototype.insertCamera=function(e,i,j){this._resetCurrentScene(j);var k=this._nodes.get(e);var l=this._cameras.get(i);if(k&&l){(k||this._rootNode).add(l.parent?l.clone():l);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(m){var e=this._getMaterialRef(m);if(e&&e.emissive){e.emissive.copy(e.color);e.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(m){var e=[];var i=m.id;var j=this._getMaterialRef(i);if(m.lineWidth>0){if(!j||!j.isLineBasicMaterial){j=new THREE.LineBasicMaterial();var k=new M(true);k.setMaterialRef(j);this._vkScene.setMaterial(i,k);}j.color=new THREE.Color(m.lineColour[0],m.lineColour[1],m.lineColour[2]);j.linewidth=m.lineWidth;j.userData.lineStyle={width:m.lineWidth,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale,widthCoordinateSpace:m.lineWidthCoordinateSpace};j.userData.materialInfo=m;j.userData.materialId=i;return e;}if(!j){j=this._createTemporaryMaterial(i);}delete j.userData.toBeUpdated;j.userData.materialInfo=m;if(m.diffuseColour){j.color.fromArray(m.diffuseColour);}if(m.specularColour){j.specular.fromArray(m.specularColour);}var l=true;if(m.emissiveColour){j.emissive.fromArray(m.emissiveColour);if(j.emissive.r!==0||j.emissive.g!==0||j.emissive.b!==0){l=false;}}if(l&&m.ambientColour){j.emissive.fromArray(m.ambientColour);j.emissive.multiplyScalar(0.2);}if(j.opacity!==undefined){j.opacity=m.opacity;j.transparent=m.opacity<0.99;if(j.transparent){j.side=THREE.DoubleSide;}}var j1=j.glossiness?j.glossiness:0;var k1=j.specularLevel?j.specularLevel:0;j.shininess=j1*2+k1*3;j.userData.defaultHighlightingEmissive=F;j.userData.defaultHighlightingSpecular=G;e=this.updateTextureMaps(i);if(e.length>0){j.userData.imageIdsToLoad=new Set();for(var ti=0;ti<e.length;ti++){var m1=e[ti];T.pushElementIntoMapArray(this._imageTextures,m1.imageId,{textureType:m1.textureType,materialId:i});j.userData.imageIdsToLoad.add(m1.imageId);}}var n1=this._materialMeshes.get(i);if(n1){for(var mi=0;mi<n1.length;mi++){var p1=n1[mi];var q1=this._meshNodes.get(p1);if(q1){for(var ni=0;ni<q1.length;ni++){W(q1[ni],i,j,this._materialClones);}}}}return e;};S.prototype.getMaterial=function(m){return this._getMaterialRef(m);};var h1=function(i){var j="";try{var k=0x8000;var l=0;var m=i.length;var j1;while(l<m){j1=i.slice(l,Math.min(l+k,m));j+=String.fromCharCode.apply(null,j1);l+=k;}}catch(e){j="";}return j;};S.prototype.createImage=function(e){var j=new DataView(e.binaryData.buffer);var k=true;if(j.getUint8(0,true)===parseInt("0xFF",16)&&j.getUint8(1,true)===parseInt("0xD8",16)){k=false;}var l=h1(e.binaryData);var m="data:image/"+(k?"png":"jpeg")+";base64,"+btoa(l);this._images.set(e.id,m);var j1=this._imageTextures.get(e.id);if(j1){this._imageTextures.delete(e.id);for(var i=0;i<j1.length;i++){var k1=j1[i];this.updateTextureMap(k1.materialId,k1.textureType);}}return this;};var i1=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(m){var e=[];var i=this._getMaterialRef(m);if(!i){return e;}var j=i.userData.materialInfo;if(!j){return e;}if(j.textureDiffuse){var k=this.updateTextureMap(m,S.TextureType.Diffuse);if(k.imageId){e.push(k);}}if(j.textureBump){var l=this.updateTextureMap(m,S.TextureType.Bump);if(l.imageId){e.push(l);}}if(j.textureOpacity){var j1=this.updateTextureMap(m,S.TextureType.Opacity);if(j1.imageId){e.push(j1);}}if(j.textureEmissive){var k1=this.updateTextureMap(m,S.TextureType.Emissive);if(k1.imageId){e.push(k1);}}if(j.textureAmbientOcclusion){var l1=this.updateTextureMap(m,S.TextureType.AmbientOcclusion);if(l1.imageId){e.push(l1);}}if(j.textureReflection){var m1=this.updateTextureMap(m,S.TextureType.Reflection);if(m1.imageId){e.push(m1);}}return e;};S.prototype.updateTextureMap=function(e,i){var j={textureType:i,imageId:null};var k=this._getMaterialRef(e);if(!k){return j;}var l=k.userData.materialInfo;if(!l){return j;}var j1=null;switch(i){case S.TextureType.Diffuse:j1=l.textureDiffuse;break;case S.TextureType.Bump:j1=l.textureBump;break;case S.TextureType.Opacity:j1=l.textureOpacity;break;case S.TextureType.Reflection:j1=l.textureReflection;break;case S.TextureType.Emissive:j1=l.textureEmissive;break;case S.TextureType.AmbientOcclusion:j1=l.textureAmbientOcclusion;break;default:break;}if(!j1){return j;}var k1=j1[0]||j1;var l1=this._images.get(k1.imageId);if(!l1){j.imageId=k1.imageId;return j;}if(k.userData.imageIdsToLoad){k.userData.imageIdsToLoad.delete(k1.imageId);if(k.userData.imageIdsToLoad.size===0){delete k.userData.imageIdsToLoad;}}var m1=i1.load(l1,this._fireSceneUpdated);m1.wrapS=k1.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;m1.wrapT=k1.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;m1.magFilter=k1.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;m1.minFilter=k1.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;m1.anisotropy=4;var n1=k1.influence!==undefined?k1.influence:0;var o1=k1.uvHorizontalScale!==undefined?k1.uvHorizontalScale:1;var p1=k1.uvVerticalScale!==undefined?k1.uvVerticalScale:1;var q1=k1.uvHorizontalOffset!==undefined?k1.uvHorizontalOffset:0;var r1=k1.uvVerticalOffset!==undefined?k1.uvVerticalOffset:0;m1.repeat.set(o1,p1);m1.center.set(-q1,-r1);m1.offset.set(q1,r1);m1.rotation=-k1.uvRotationAngle;function s1(m){switch(i){case S.TextureType.Diffuse:m.map=m1;m.transparent|=l1.startsWith("data:image/png");break;case S.TextureType.Bump:m.bumpMap=m1;m.bumpScale=n1;break;case S.TextureType.Opacity:m.alphaMap=m1;break;case S.TextureType.Reflection:m1.mapping=THREE.SphericalReflectionMapping;m.envMap=m1;m.combine=THREE.AddOperation;m.reflectivity=n1;break;case S.TextureType.Emissive:m.emissiveMap=m1;m.emissive.setRGB(1,1,1);break;case S.TextureType.AmbientOcclusion:m.aoMap=m1;break;default:}m.needsUpdate=true;}s1(k);var t1=this._materialClones.get(e);if(t1){t1.forEach(function(m){s1(m);});}return j;};S.prototype.insertPlayback=function(e,i,j){this._resetCurrentScene(j);var k=this._vkScene.findSequence(e.sequenceId);var l=new r(e.id,{sequence:k,timeScale:e.speed?1.0/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var m=this._views.get(i);if(m){m.addPlayback(l);}if(!k){T.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,l);}return this;};S.prototype.insertSequence=function(i,e){var j;if(i.endTime){j=i.endTime;}else{j=1.0;}var k=this._vkScene.createSequence(i.id,{name:i.name,duration:j});if(Array.isArray(i.joints)){i.joints.forEach(function(l1){var m1=this._joints[l1];if(m1){k.setJoint(m1);}}.bind(this));}if(i.nodes&&i.nodes.length>0){for(var l=0;l<i.nodes.length;l++){var m=i.nodes[l];if(m.empty){m.type=m.binding;var j1=this._nodes.get(m.sid);this._animationHelper.insertEmptyTrack(m,k,j1,this._vkScene);continue;}T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,m.trackId,{sequenceId:i.id,targetId:m.sid,type:m.binding,pivot:m.pivot,isAbsoluteValue:m.isAbsoluteValue});}}var k1=this._sequenceIdToPlaybacks.get(i.id);if(k1){k1.forEach(function(l1){l1.setSequence(k);});}return this;};S.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this;};S.prototype.insertJoints=function(j,e){this._resetCurrentScene(e);this._joints=[];j.forEach(function(i){var k=this._nodes.get(i.childSid);var l=this._nodes.get(i.parentSid);var m={id:i.id,node:k,parent:l,translation:new Float32Array(i.t?i.t:[0,0,0]),quaternion:new Float32Array(i.q?i.q:[0,0,0,1]),scale:new Float32Array(i.s?i.s:[1,1,1])};if(!k){var j1=this._jointNodesMap.get(i.childSid);if(!j1){j1=[];}j1.push(m);this._jointNodesMap.set(i.childSid,j1);}if(!l){var k1=this._jointParentsMap.get(i.parentSid);if(!k1){k1=[];}k1.push(m);this._jointParentsMap.set(i.parentSid,k1);}this._joints.push(m);}.bind(this));return this;};S.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}e.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map();}var i;var j=this._viewGroups.entries();var k=j.next();while(!k.done){i=k.value[1];k=j.next();var l=[];for(var m=0;m<i.getViews().length;m++){if(i.getViews()[m].id){var j1=this._views.get(i.getViews()[m].id);if(j1){l.push(j1);}}}}return this;};S.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var i=this._viewGroups.entries();var j=i.next();while(!j.done){var k=j.value[1];var l=j.value[0];if(!k||!k.views||!k.views.length){j=i.next();continue;}k.removeViews();for(var m=0;m<k.views.length;m++){var j1=k.views[m].id;var k1=this._views.get(j1);if(k1&&k1.userData.viewInfo.thumbnailId&&!k1.thumbnailData){var l1=this._images.get(k1.userData.viewInfo.thumbnailId);if(l1){k1.thumbnailData=l1;}}if(k1){k1.viewGroupId=l;k.addView(k1);}}j=i.next();}return this;};S.prototype.insertViewGroup=function(i,e){this._resetCurrentScene(e);var j=this._viewGroups.get(i.id);if(!j){j=this._vkScene.createViewGroup({viewGroupId:i.id,name:i.name,description:i.description});this._viewGroups.set(i.id,j);}else{j.setViewGroupId(i.id);j.setName(i.name);j.setDescription(i.description);}j.type=i.type;j.metadata=i.metadata;j.veids=i.veids;j.views=i.views;j.sceneId=i.sceneId;return this;};S.prototype.getViewGroup=function(e,i){this._resetCurrentScene(i);var j=this._viewGroups.get(e);var k=[];if(j&&j.views){for(var l=0;l<j.views.length;l++){var m=j.views[l].id;var j1=this._views.get(m);if(j1){k.push(j1);}}}return k;};S.prototype.insertView=function(e,i){this._resetCurrentScene(i);if(e.description){var j=new RegExp("^<[^>]*?>");if(j.test(e.description)){var k=new RegExp("(^(<[^>]*?>\s*)+)|((<[^>]*?>\s*)+$)","g");var l=e.description.replace(k,"");if(!l){e.description=l;}}}var m=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?"<pre style=\"white-space: pre-wrap;\">"+e.description+"</pre>":e.description,aspectRatio:e.safeAreaAspectRatio});m.userData={};m.userData.viewInfo=e;if(e.thumbnailId){var j1=this._images.get(e.thumbnailId);if(j1){m.thumbnailData=j1;}else{this._viewThumbnails.set(e.thumbnailId,m);}}if(e.animatedThumbnailId){var k1=this._images.get(e.animatedThumbnailId);if(k1){m.animatedThumbnailData=k1;m.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId);}}if(e.cameraId){m.setCamera(this._cameras.get(e.cameraId));}m.type=e.type;m.flyToTime=e.flyToTime;m.preDelay=e.preDelay;m.postDelay=e.postDelay;m.navigationMode=e.navigationMode;m.topColor=e.topColor;m.bottomColor=e.bottomColor;m.renderMode=z[e.renderMethod];m.dimension=e.dimension;m.query=e.query;m.metadata=e.metadata;m.veids=e.veids;m.viewGroupId=e.viewGroupId;m.id=e.viewId;this._views.set(e.viewId,m);if(m.viewGroupId){var l1=this._viewGroups.get(m.viewGroupId);if(l1){l1.addView(m);}}return this;};S.prototype.setModelViewVisibilitySet=function(i){var e=this._views.get(i.viewId);var j=[];i.visibleNodes.forEach(function(k){var l=this._nodes.get(k);if(l){j.push({target:l,visible:true});}else{L.warning("Unknown modelView visible node reference",k);}}.bind(this));e.updateNodeInfos(j);};S.prototype.recordHighlightedNodeInView=function(e,i,j,k){this._resetCurrentScene(k);var l=this._views.get(j);if(!l){return this;}var m=this._nodes.get(i);if(!m){return this;}l.addHighlightedNodes(e,m);return this;};S.prototype.insertHighlightStyle=function(i){var e=this._vkScene.getHighlight(i.id);if(e){return this;}this._vkScene.createHighlight(i.id,i);return this;};S.prototype.insertModelViewHighlight=function(i){var e=this._views.get(i.viewId);if(e){var j=[];i.highlightNodes.forEach(function(j1){var k1=this._nodes.get(j1);if(k1){j.push(k1);}else{}}.bind(this));var k={duration:i.duration,cycles:i.cycles};if(!i.id){i.id=THREE.Math.generateUUID().toLowerCase();}var l=new THREE.Color(i.color1).toArray();var m=new THREE.Color(i.color2).toArray();l[3]=((i.color1>>>24)&255)/255;m[3]=((i.color2>>>24)&255)/255;k.colours=[l,m];k.opacities=[i.opacity1,i.opacity2];this._vkScene.createHighlight(i.id,k);e.addHighlightedNodes(i.id,j);}};S.prototype.createThumbnail=function(i){var e=this._viewThumbnails.get(i.imageId);if(e){e.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:e});}}};S.prototype.highlightStyleExists=function(i){var e=this._vkScene.getHighlight(i);return e!==undefined;};S.prototype.getView=function(e,i){this._resetCurrentScene(i);return this._views.get(e);};S.prototype.getSequence=function(e){return this._vkScene.findSequence(e);};S.prototype.setViewCamera=function(e,i,j){this._resetCurrentScene(j);var k=this._cameras.get(e);var l=this._views.get(i);if(k&&l){l.setCamera(k);}return this;};S.prototype.setViewNodeInfos=function(e,i,j){this._resetCurrentScene(j);var k=this._views.get(i);k.setNodeInfos(e);return this;};S.prototype.setViewThumbnail=function(i,e,j,k){this._resetCurrentScene(j);var l=this._views.get(e);var m=this._images.get(i);if(l&&m){if(l.userData!==undefined){if(l.userData.viewInfo.thumbnailId===i){l.thumbnailData=m;}else if(l.userData.viewInfo.animatedThumbnailId===i){l.animatedThumbnailData=m;l.tileWidth=k;}}}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._vkScene){this._vkScene.clearMaterials();}this._callouts.clear();this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._materialClones.clear();this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._tracks){this._tracks.clear();}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdViewGroupMap.clear();this._sceneIdViewMap.clear();S._map.delete(this._id);};S.prototype.insertAnimationGroup=function(i){var e=this._vkScene.findSequence(i.animationGroupRef.toString());if(!e){var j;if(i.endTime){if(!i.startTime){i.startTime=0;}j=i.endTime-i.startTime;}e=this._vkScene.createSequence(i.animationGroupRef.toString(),{name:i.name,duration:j});if(!e.userData){e.userData={};}e.userData.animations=[];}if(i.modelViewRef){var m=this._views.get(i.modelViewRef);if(m){var k=this._vkScene.findSequence(i.animationGroupRef.toString());var l=new r({sequence:k,timeScale:i.playbackSpeed?1.0/i.playbackSpeed:1,preDelay:i.playbackPreDelay?i.playbackPreDelay:0,postDelay:i.playbackPostDelay?i.playbackPostDelay:0,repeat:i.playbackRepeat?Math.abs(i.playbackRepeat):0,reversed:i.playbackReversed?true:false,startTime:0});m.addPlayback(l);}}};S.prototype.insertAnimation=function(i){var e=this._animations.get(i.animationRef);if(!e){e={};e.type=i.animationType;e.targetRefs=[];e.targetPivots=[];e.sequenceId=i.animationGroupRef.toString();e.trackIds=new Set();e.tracks=[];this._animations.set(i.animationRef,e);}if(i.animationGroupRef){var j=this._vkScene.findSequence(i.animationGroupRef.toString());if(!j.userData.animations.includes(i.animationRef)){j.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var e=this._animations.get(i.animationRef);if(e){if(!e.targetRefs.includes(i.targetRef)){e.targetRefs.push(i.targetRef);e.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var e=this._animationTracks.get(i.animationTrackRef);var j=i.animationRef;if(!e){delete i.animationRef;e=i;this._animationTracks.set(i.animationTrackRef,e);}if(!j){return;}var k=this._animations.get(j);if(!k||!k.sequenceId){return;}if(k.trackIds.has(e.animationTrackRef)){return;}k.trackIds.add(e.animationTrackRef);for(var l=0;k.targetRefs&&l<k.targetRefs.length;l++){var m=k.targetRefs[l];var j1=k.targetPivots[l];var k1=this._nodes.get(m);if(!k1){continue;}var l1;if(j1.x!==0||j1.y!==0||j1.z!==0){l1=[j1.x,j1.y,j1.z];}var m1=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][e.type]||"";T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,i.animationTrackRef,{sequenceId:k.sequenceId,targetId:m,type:m1,pivot:l1,isAbsoluteValue:true});var n1={};n1.times=Array.prototype.slice.call(e.times);n1.values=Array.prototype.slice.call(e.values);n1.id=i.animationTrackRef;n1.cyclicInfo={};n1.cyclicInfo.cyclicStart=e.cyclicStart;n1.cyclicInfo.cyclicEnd=e.cyclicEnd;var ki;if(k.type===0){if(e.dataType===0){if(e.values.length!==e.keyCount||e.times.length!==e.keyCount){continue;}if(e.type===3){n1.values=[];for(ki=0;ki<e.keyCount;ki++){n1.values.push(e.values[ki]);n1.values.push(e.values[ki]);n1.values.push(e.values[ki]);}}}else if(e.dataType===1||e.dataType===3){if(e.values.length!==3*e.keyCount||e.times.length!==e.keyCount){continue;}}else if(e.dataType===4||e.dataType===5||e.dataType===6){if(e.values.length!==4*e.keyCount||e.times.length!==e.keyCount){continue;}if(e.dataType===4){n1.rotateType=s.AngleAxis;}else if(e.dataType===6){n1.rotateType=s.Euler;}else{n1.rotateType=s.Quaternion;for(var vi=3;vi<n1.values.length;vi=vi+4){n1.values[vi]=-n1.values[vi];}}}}k.tracks.push(n1);}};S.prototype.setAnimationTracks=function(e){var i=this._animations.get(e);if(i){this._animationHelper.insertTracks(i.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);}};S.prototype.setAnimationPlaybacks=function(i){var e=this._viewGroups.get(i.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(e.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(e.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(e.getViews(),this._vkScene);};return S;});
