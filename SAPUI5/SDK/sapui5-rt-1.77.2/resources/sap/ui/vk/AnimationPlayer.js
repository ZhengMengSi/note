/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","./AnimationMath","./AnimationTrackType","./AnimationTrackValueType","./thirdparty/GlMatrixUtils"],function(E,v,A,a,b,g){"use strict";var c=E.extend("sap.ui.vk.AnimationPlayer",{metadata:{associations:{viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{viewActivated:{type:"sap.ui.vk.View"},timeChanged:{time:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"}},stateChanged:{playing:{type:"boolean"},stopped:{type:"boolean"},endOfAnimation:{type:"boolean"}}}}});c.prototype._getViewStateManager=function(){var d=this.getViewStateManager();return d?sap.ui.getCore().byId(d):undefined;};c.prototype.init=function(){this._step=this._step.bind(this);this._playbackCollection=null;this._currentPlayback=null;this._time=0;this._nodeChanges=new Map();v.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().subscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().subscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};c.prototype.exit=function(){this._playbackCollection=null;this._currentPlayback=null;v.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().unsubscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};c.prototype._onViewApplied=function(d,e,f){if(f.source.getId()!=this.getViewStateManager()){return;}var h=f.view;var i=f.ignoreAnimationPosition;this.activateView(h,i);};c.prototype._onSequenceChanged=function(d,e,f){if(this._currentPlayback){var h=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(h&&s){if(s.getId()===f.sequenceId){h.setJoints(s.getJoint());}}}};c.prototype._onNodeAnimationRemoved=function(d,e,f){if(this._currentPlayback){var h=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(h&&s){if(s.getId()===f.sequenceId){h.resetNodeProperty(f.nodeRef,f.property);this.setTime(this._time);}}}};c.prototype.getAnimatedProperty=function(n,p){var r={};var d=this._getViewStateManager();if(!d){return null;}if(p!==a.Opacity){var w=d.getTransformationWorld(n);if(p===a.Rotate){r.world=w.quaternion;}else if(p===a.Translate){r.world=w.translation;}else{r.world=w.scale;}}var e=this._nodeChanges.get(n);if(!e||e[p]===undefined){r.offsetToPrevious=null;r.offsetToRest=null;if(p===a.Opacity){r.absolute=d.getOpacity(n);r.totalOpacity=d.getTotalOpacity(n);}else{var t=d.getTransformation(n);if(p===a.Rotate){r.absolute=t.quaternion;}else if(p===a.Translate){r.absolute=t.translation;}else{r.absolute=t.scale;}}return r;}if(p===a.Opacity){var o=e[p];r.offsetToRest=o;r.offsetToPrevious=e.offsetToPrevious[p];r.opacity=e.absolute.opacity;r.totalOpacity=e["totalOpacity"];return r;}var f=e[p];r.offset=f;if(p===a.Rotate){r.absolute=e.absolute.quaternion;}else if(p===a.Translate){r.absolute=e.absolute.translate;}else{r.absolute=e.absolute.scale;}r.offsetToPrevious=e.offsetToPrevious[p];r.offsetToRest=e[p];return r;};c.prototype.setTime=function(t,p){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){this._currentPlayback=undefined;this._time=0;}else{if(p!=null){t=this._getAbsoluteTime(t,p);}var d=this._getViewStateManager();this._time=t;if(t>=0&&t<=this.getTotalDuration()){var e=this._currentPlayback;var n;if(p!=null){n=this._playbackCollection.getPlayback(p);}else{n=this._findPlaybackByAbsoluteTime(t);}this._currentPlayback=n;if(d&&this._currentPlayback&&e!==this._currentPlayback){var s=this._currentPlayback.getSequence();if(s){d.setJoints(s.getJoint());}}else if(!this._currentPlayback||!this._currentPlayback.getSequence()){d.setJoints(undefined);}}else if(d){d.setJoints(undefined);}if(d){var f={nodeRefs:[],positions:[]};var o={nodeRefs:[],values:[]};this._collectNodeChanges();this._nodeChanges.forEach(function(h,i){var j=d.addToRestTransformation(i,h.rtranslate,h.rrotate,h.rscale,h.originalRotationType);if(j){f.nodeRefs.push(i);f.positions.push(j);h.absolute={};h.absolute.translate=j.translation;h.absolute.scale=j.scale;h.absolute.quaternion=j.quaternion;}if(h[a.Opacity]!==undefined){var r=d.getRestOpacity(i);d.setOpacity(i,h[a.Opacity]*r);i.userData.animatedOpacity=true;h.absolute={};h.absolute.opacity=h[a.Opacity]*r;h.totalOpacity=d.getTotalOpacity(i);o.nodeRefs.push(i);o.values.push(h[a.Opacity]);}},this);d.setTransformation(f.nodeRefs,f.positions);d.setOpacity(o.nodeRefs,o.values);}}this.fireTimeChanged({time:this._time,currentPlayback:this._currentPlayback});return this;};c.prototype.getTime=function(){return this._time;};c.prototype.getCurrentPlayback=function(){return this._currentPlayback;};c.prototype.getCurrentPlaybackTime=function(){var t=this._time;var p=this._playbackCollection.getPlaybacks();if(!Array.isArray(p)||!this.getCurrentPlayback()){return-1;}var i=0;while(p[i]!=this.getCurrentPlayback()){t-=p[i].getDuration();i++;}return t;};c.prototype.getStartTime=function(p){if(!this._playbackCollection){return undefined;}if(typeof p==="number"){p=this._playbackCollection.getPlayback(p);}return p?p.getStartTime():undefined;};c.prototype.getTotalDuration=function(){if(!this._playbackCollection){return 0;}var t=0;this._playbackCollection.getPlaybacks().forEach(function(p){t+=p.getDuration();});return t;};c.prototype._step=function(t){if(!this._lastFrameTimestamp){this._lastFrameTimestamp=t;}var p=t-this._lastFrameTimestamp;this._lastFrameTimestamp=t;var n=this.getTime()+p/1000;var r=n>=0&&n<=this.getTotalDuration();if(n>this.getTotalDuration()){n=this.getTotalDuration();}this.setTime(n);if(r){this._frameId=window.requestAnimationFrame(this._step);}else{this.stop();}};c.prototype._interpolate=function(d,e,t){var r={};var q;if(!e.before&&!e.after){return undefined;}else if(!e.before){if(d===b.Euler){r[b.Euler]=e.after.value.slice();q=A.neutralEulerToGlMatrixQuat(e.after.value);r.value=A.glMatrixQuatToNeutral(q);}else if(d===b.AngleAxis){r[b.AngleAxis]=e.after.value.slice();q=A.neutralAngleAxisToGlMatrixQuat(e.after.value);r.value=A.glMatrixQuatToNeutral(q);}else if(d===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(e.after.value);r.value=A.glMatrixQuatToNeutral(q);}else{r.value=e.after.value;}return r;}else if(!e.after){if(d===b.Euler){r[b.Euler]=e.before.value;q=A.neutralEulerToGlMatrixQuat(e.before.value);r.value=A.glMatrixQuatToNeutral(q);}else if(d===b.AngleAxis){r[b.AngleAxis]=e.before.value;q=A.neutralAngleAxisToGlMatrixQuat(e.before.value);r.value=A.glMatrixQuatToNeutral(q);}else if(d===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(e.before.value);r.value=A.glMatrixQuatToNeutral(q);}else{r.value=e.before.value;}return r;}var k=0;if(e.before.time!==e.after.time){k=(e.time-e.before.time)/(e.after.time-e.before.time);}return A.interpolate(d,e.before,e.after,k,t);};c.getBoundaryKey=function(t,i){var d=t.getKeysCount();if(!d){return null;}var e;if(i){e=t.getKey(0);}else{e=t.getKey(d-1);}var f=t.getKeysType();var q,r={};if(f===b.Euler){r[f]=e.value;q=A.neutralEulerToGlMatrixQuat(e.value);r.value=A.glMatrixQuatToNeutral(q);r.time=e.time;}else if(f===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(e.value);r.value=A.glMatrixQuatToNeutral(q);r.time=e.time;}else if(f!==b.AngleAxis){r.value=e.value;r.time=e.time;}else{var h;var k=0;if(i){h=e;if(d>1){h=t.getKey(1);}k=0;}else{h=e;if(d>1){e=t.getKey(d-2);k=1;}}r=A.interpolate(f,e,h,k,t);r.time=i?e.time:h.time;}return r;};c.prototype._getKeyFramesBracket=function(t,d){var k=d.getKeysCount();if(!k){return null;}var r={time:t,before:undefined,after:undefined};for(var i=0;i<k;i++){var e=d.getKey(i);if(e.time===t){r.before=r.after=e;}else if(e.time>t){r.before=(i===0?undefined:d.getKey(i-1));r.after=e;break;}}if(!r.before&&!r.after&&k>0){r.before=d.getKey(k-1);}if(k>1&&(!r.after||!r.before)&&(d.isCycleForward()||d.isCycleBackward())){var f=d.getKey(0).time;var h=d.getKey(k-1).time-f;var j=Math.floor((t-f)/h);var l=t-h*j;return this._getKeyFramesBracket(l,d);}return r;};c.prototype._collectNodeChangesFromSequenceBoundaryKeys=function(n,s,i,d,p){var e=s.getNodeAnimation();if(!e){return;}var f=this._getViewStateManager();var h=function(j,k,l,m){if(!j||!k||!l){return;}var o=n.get(j);if(o&&o.hasOwnProperty(k)){if(o&&o.animationProperties&&o.animationProperties[k]){return;}if(o&&o.isFront&&!i){return;}if(o&&o.isFront&&i&&o.keyTime>l.time+p){return;}if(o&&!o.isFront&&!i&&o.keyTime<l.time+p){return;}}if(!o){o={};n.set(j,o);}if(!o.offsetToPrevious){o.offsetToPrevious={};}var r;if(this._currentPlayback){var t=this._currentPlayback.getSequence();if(t){r=f._getEndPropertyInPreviousSequence(j,k,t);}}var u=f._getEndPropertyInPreviousSequence(j,k,s);if(k===a.Opacity){o[k]=l.value;if(u){o[k]*=u;}if(r){o.offsetToPrevious[k]=o[k]/r;}}else{o[k]=l.value.slice();if(u){if(k===a.Translate){o[k][0]+=u[0];o[k][1]+=u[1];o[k][2]+=u[2];}else if(k===a.Scale){o[k][0]*=u[0];o[k][1]*=u[1];o[k][2]*=u[2];}}if(r){if(k===a.Translate){o.offsetToPrevious[k]=[o[k][0]-r[0],o[k][1]-r[1],o[k][2]-r[2]];}else if(k===a.Scale){o.offsetToPrevious[k]=[o[k][0]/r[0],o[k][1]/r[1],o[k][2]/r[2]];}}}o.keyTime=l.time+p;o.isFront=i;if(m){o.originalRotationType=m;}if(m===b.Euler||m===b.AngleAxis){o[m]=l[m].slice();if(m===b.Euler&&u){if(u){var w=A.neutralQuatToGlMatrixQuat(u);var x=A.neutralQuatToGlMatrixQuat(o[k]);var q=g.quat.multiply(g.quat.create(),x,w);o[k]=A.glMatrixQuatToNeutral(q);}o.offsetToPrevious[k]=[0,0,0];}}}.bind(this);e.forEach(function(j){for(var t in a){var k=a[t];var l=j[k];if(l&&l.getKeysCount()){var m=l.getKeysType();var o=c.getBoundaryKey(l,(!i&&!d)||(i&&d));if(!o){return;}if(k===a.Rotate){h(j.nodeRef,k,o,m);}else{h(j.nodeRef,k,o);}}}},this);};c.prototype._collectNodeChangesFromPlaybackBoundaryKeys=function(d,n,p){var s=p.getSequence();if(!s){return;}var t=d-p.getStartTime();var e=s.getDuration()*p.getTimeScale()*p.getRepeats();if(t<=0){this._collectNodeChangesFromSequenceBoundaryKeys(n,s,false,p.getReversed(),p.getStartTime());}else if(t>=p.getPreDelay()+e){this._collectNodeChangesFromSequenceBoundaryKeys(n,s,true,p.getReversed(),p.getStartTime());}};c.prototype._collectSequenceNodeChanges=function(t,n,s,i){var d=s.getNodeAnimation();if(!d){return;}var e=this._getViewStateManager();var f=function(h,p,r,j){if(!h||!p||r===undefined||r===null||!r.value){return;}var k=n.get(h);if(!k){k={};n.set(h,k);}if(!k.animationProperties){k.animationProperties={};}k.animationProperties[p]=true;if(j){k.originalRotationType=j;}if(!k.offsetToPrevious){k.offsetToPrevious={};}var o=e._getEndPropertyInPreviousSequence(h,p,s);if(p===a.Opacity){k[p]=r.value;k.offsetToPrevious[p]=r.value;if(o){k[p]*=o;}}else{k[p]=r.value.slice();k.offsetToPrevious[p]=r.value.slice();if(o){if(p===a.Translate){k[p][0]+=o[0];k[p][1]+=o[1];k[p][2]+=o[2];}else if(p===a.Scale){k[p][0]*=o[0];k[p][1]*=o[1];k[p][2]*=o[2];}}}if(j===b.Euler||j===b.AngleAxis){k[j]=r[j].slice();k.offsetToPrevious[p]=r[j].slice();if(j===b.Euler&&o){var l=A.neutralQuatToGlMatrixQuat(o);var m=A.neutralQuatToGlMatrixQuat(k[p]);var q=g.quat.multiply(g.quat.create(),m,l);k[p]=A.glMatrixQuatToNeutral(q);}}};d.forEach(function(h){var k;for(var j in a){var l=a[j];var m=h[l];if(m&&m.getKeysCount()&&(!i||(i&&m.isInfinite()))){k=this._getKeyFramesBracket(t,m);if(!k){return;}var o=m.getKeysType();var r=this._interpolate(o,k,m);if(l===a.Rotate){f(h.nodeRef,l,r,o);}else{f(h.nodeRef,l,r);}}}},this);};c.prototype._collectPlaybackNodeChanges=function(d,n,p){var s=p.getSequence();if(!s){return;}var t=d-p.getStartTime();if(t<0){return;}var e=s.getDuration()*p.getTimeScale()*p.getRepeats();var f=(t-p.getPreDelay())/p.getTimeScale();if(f>0&&f%p.getSequence().getDuration()===0){f=s.getDuration();}else{f=f%p.getSequence().getDuration();}f=p.getReversed()?p.getSequence().getDuration()-f:f;if(t<p.getPreDelay()){}else if(t>p.getPreDelay()+e){this._collectSequenceNodeChanges(f,n,p.getSequence(),true);}else{this._collectSequenceNodeChanges(f,n,p.getSequence(),false);}};c.prototype._collectNodeChanges=function(){this._nodeChanges.clear();var p=this._playbackCollection.getPlaybacks();var d=this.getTime();var i;for(i=0;i<p.length;i++){if(this._currentPlayback&&this._currentPlayback!==p[i]){continue;}this._collectPlaybackNodeChanges(d,this._nodeChanges,p[i]);}for(i=0;i<p.length;i++){this._collectNodeChangesFromPlaybackBoundaryKeys(d,this._nodeChanges,p[i]);}};c.prototype.play=function(){this._lastFrameTimestamp=undefined;this._frameId=window.requestAnimationFrame(this._step);v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:true,stopped:false,endOfAnimation:false});this.fireStateChanged({playing:true,stopped:false});return this;};c.prototype.stop=function(){if(this._frameId){window.cancelAnimationFrame(this._frameId);this._frameId=undefined;}this._lastFrameTimestamp=undefined;this.fireStateChanged({playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});return this;};c.prototype.activateView=function(d,p){this.stop();var e=this._getViewStateManager();var f=d.getPlaybacks();if(f&&f.length>0){for(var i=0;i<f.length;i++){var h=f[i];var s=h.getSequence();if(s){e._convertTracksToRelative(s);}}}this._currentPlayback=undefined;if(!p){this._playbackCollection=d;}else{this._playbackCollection=undefined;}this.setTime(0);if(p){this._playbackCollection=d;}this.fireViewActivated({view:d});return this;};c.prototype._getAbsoluteTime=function(t,p){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return-1;}var d=this._playbackCollection.getPlaybacks();if(p<0||p>=d.length){return-1;}var e=this._playbackCollection.getPlayback(p);if(!e||e.getDuration()<t||t<0){return-1;}var f=t;var i=0;while(i<p){var h=d[i].getDuration();f+=h;i++;}return f;};c.prototype._findPlaybackByAbsoluteTime=function(t){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return undefined;}var p=this._playbackCollection.getPlaybacks();var l=-1;var d=-1;p.forEach(function(f,h){if(f.getStartTime()>d){l=h;d=f.getStartTime();}});var i=0;while(i<p.length){var e=p[i].getDuration();var s=p[i].getStartTime();if((i!==l&&t>=s&&t<(s+e))||(i===l&&t>=s&&t<=(s+e))){return p[i];}i++;}return undefined;};return c;});
