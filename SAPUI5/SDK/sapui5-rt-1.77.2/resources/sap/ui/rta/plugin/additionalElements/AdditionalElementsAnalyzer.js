/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/dt/ElementUtil","sap/ui/rta/Utils","sap/base/Log","sap/ui/rta/util/BindingsExtractor"],function(q,E,R,L,B){"use strict";function _(P,O,j,x){var y={name:P.name,bindingPath:P.name,entityType:O.name};var z=P["com.sap.vocabularies.Common.v1.Label"];y.label=z&&z.String;var Q=P["com.sap.vocabularies.Common.v1.QuickInfo"];y.tooltip=Q&&Q.String;var H=P["com.sap.vocabularies.UI.v1.Hidden"];y.unsupported=!!H&&H.Bool==="true";var F;if(!y.unsupported){F=P["com.sap.vocabularies.Common.v1.FieldControl"];if(F&&F.EnumMember){y.unsupported=F.EnumMember==="com.sap.vocabularies.Common.v1.FieldControlType/Hidden";}else{var C=F&&F.Path;if(C){var D=j.getBinding(x)instanceof sap.ui.model.ListBinding;if(!D){var G=j.getBindingContext().getProperty(C);y.unsupported=G===0;}}}}return y;}function a(P){if(P&&P.type){if(P.type.toLowerCase().indexOf("edm")!==0){return true;}}return false;}function b(j,x){if(!j){return false;}var y=j.getBindingInfo(x);var P=y&&y.path;if(!P){return false;}if(P.indexOf(">")>-1){P=P.split(">").pop();}return P.indexOf("/")===0;}function c(j,x,y){var z;if(x){z=j.getBindingInfo(y);if(typeof z.model==="string"&&z.model!==""){z=undefined;}}else{z=j.getBindingContext();}return z;}function d(j,x){var y=b(j,x);var z=c(j,y,x);if(z){return y?z.path:z.getPath();}}function e(O,M,j,x){var P=O.property.map(function(y){var z=_(y,O,j,x);if(a(y)){var C=M.getODataComplexType(y.type);if(C){z.properties=C.property.map(function(D){var I=_(D,O,j,x);I.bindingPath=y.name+"/"+D.name;I.referencedComplexPropertyName=z.label||z.name;return I;});}}return z;});if(O.navigationProperty){var N=O.navigationProperty.map(function(y){var F=(M.getODataAssociationEnd(O,y.name)&&M.getODataAssociationEnd(O,y.name).type);return{name:y.name,entityType:F,bindingPath:y.name,unsupported:true};});P=P.concat(N);}return P;}function f(P){var F=P.reduce(function(j,x){if(Array.isArray(x.properties)){j=j.concat(x.properties);}else{j.push(x);}return j;},[]);return F;}function g(j){return Promise.resolve().then(function(){var M=j.getModel();if(M){var x=M.getMetadata().getName();if(x==="sap.ui.model.odata.ODataModel"||x==="sap.ui.model.odata.v2.ODataModel"){var y=M.getMetaModel();return y.loaded().then(function(){return y;});}}});}function h(M,j){var x=M.getMetaContext(j);return x.getObject();}function i(j,M,O){var D=j.getMetadata().getAggregation();if(D){var x=j.getBindingInfo(D.name);var T=x&&x.template;if(T){var P=j.getBindingPath(D.name);var y=M.getODataAssociationEnd(O,P);var F=y&&y.type;if(F){var z=M.getODataEntityType(F);O=z;}}}return O;}function k(j,x){return g(j).then(function(M){var P=[];if(M){var y=d(j,x);if(y){var O=h(M,y);O=i(j,M,O);P=e(O,M,j,x);}}return P;}).then(f);}function l(P){return P.filter(function(j){return!j.unsupported;});}function m(P,C){C.type="custom";if(C.id){C.itemId=P+"-"+C.id;C.key=C.itemId;}return C;}function n(O){return{selected:false,label:O.label||O.name,referencedComplexPropertyName:O.referencedComplexPropertyName?O.referencedComplexPropertyName:"",duplicateComplexName:O.duplicateComplexName?O.duplicateComplexName:false,tooltip:O.tooltip||O.label,originalLabel:"",type:"odata",entityType:O.entityType,name:O.name,bindingPath:O.bindingPath};}function o(D){var j=D.element;var x=D.action;var y=D.bindingPathCollection;return{selected:false,label:j.label||E.getLabelForElement(j,x.getLabel),tooltip:j.tooltip||E.getLabelForElement(j,x.getLabel)||j.name,referencedComplexPropertyName:j.referencedComplexPropertyName?j.referencedComplexPropertyName:"",duplicateComplexName:j.duplicateComplexName?j.duplicateComplexName:false,bindingPaths:y.bindingPaths,originalLabel:j.renamedLabel&&j.label!==j.originalLabel?j.originalLabel:"",type:"invisible",elementId:j.getId()};}function p(j,x,y){if(x&&x!==j){var z=R.getEntityTypeByPath(j.getModel(),d(j,y));return E.findAllSiblingsInContainer(j,x).filter(function(S){var P=d(S,y);if(P){return R.getEntityTypeByPath(S.getModel(),P)===z;}return false;});}return[j];}function r(P){P.forEach(function(O,x,P){if(O["duplicateComplexName"]!==true){for(var j=x+1;j<P.length-1;j++){if(O.label===P[j].label){O["duplicateComplexName"]=true;P[j]["duplicateComplexName"]=true;}}}});return P;}function s(I,P){return P.some(function(D){return D.label===I.label;});}function t(j){return Array.isArray(j)&&j.length>0;}function u(C,P){return P.filter(function(D){return C.some(function(j){return j.startsWith(D.bindingPath);});}).pop();}function v(I,S){I.originalLabel=S.label;I.tooltip=S.tooltip;I.name=S.name;if(I.label!==I.originalLabel){I.renamedLabel=true;}if(S.referencedComplexPropertyName){I.referencedComplexPropertyName=S.referencedComplexPropertyName;}}function w(I,P,j){var x=j.bindingPaths;var O;return(!t(x)||((O=u(x,P))&&(v(I,O)||true)));}var A={enhanceInvisibleElements:function(j,x){var M=j.getModel();var y=x.reveal;var z=x.addODataProperty;var C=x.custom;var D=j.getMetadata().getAggregation();var F=D?D.name:x.aggregation;return Promise.resolve().then(function(){return k(j,F);}).then(function(O){O=r(O);var G=[];var I=y.elements||[];I.forEach(function(H){var J=H.element;var K=H.action;var N=true;var P={};J.label=E.getLabelForElement(J,K.getLabel);if(z){if(d(j,F)===d(J,F)){P=B.collectBindingPaths(J,M);J.duplicateComplexName=s(J,O);if(O.length>0){N=w(J,O,P);}}else if(B.getBindings(J,M).length>0){N=false;}}if(C&&N){C.items.forEach(function(Q){m(j.getParent().getId(),Q);if(Q.itemId===J.getId()){v(J,Q);}});}if(N){G.push({element:J,action:K,bindingPathCollection:P});}});return G;}).then(function(G){return G.map(o);});},getUnboundODataProperties:function(j,x){var D=j.getMetadata().getAggregation();var y=D?D.name:x.action.aggregation;var M=j.getModel();return Promise.resolve().then(function(){return k(j,y);}).then(function(P){var O=l(P);var z=p(j,x.relevantContainer,y);var C=[];z.forEach(function(j){C=C.concat(B.getBindings(j,M).map(function(G){return(q.isPlainObject(G)?G.parts[0].path:!!G.getPath&&G.getPath());}));});var F=x.action.filter?x.action.filter:function(){return true;};O=O.filter(function(G){var H=false;if(C){H=C.some(function(I){return I===G.bindingPath;});}return!H&&F(x.relevantContainer,G);});O=r(O);return O;}).then(function(U){return U.map(n);});},getCustomAddItems:function(j,x){return new Promise(function(y){if(Array.isArray(x.items)){y(x.items.map(m.bind(null,j.getParent().getId())).filter(function(C){if(!C.id){L.error("CustomAdd item with label "+C.label+" does not contain an 'id' property","sap.ui.rta.plugin.AdditionalElementsAnalyzer#showAvailableElements");return false;}return!E.getElementInstance(C.itemId);}));}else{y();}});},getFilteredItemsList:function(j){var I=j[0];var C=2;var x=j[C];if(x){var y=I.map(function(z){return z.elementId;});j[C]=x.filter(function(z){return!z.itemId||y.indexOf(z.itemId)===-1;});}return j.reduce(function(z,D){return z.concat(D);},[]);}};return A;});
