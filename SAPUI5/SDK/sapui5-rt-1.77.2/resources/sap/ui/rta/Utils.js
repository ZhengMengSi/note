/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/registry/Settings","sap/ui/dt/OverlayUtil","sap/ui/dt/DOMUtil","sap/m/MessageBox","sap/ui/rta/util/BindingsExtractor","sap/base/Log","sap/base/util/UriParameters","sap/base/util/restricted/_omit"],function(q,F,L,a,S,O,D,M,B,b,U,_){"use strict";var c={};c.RESOLVED_PROMISE=Promise.resolve(true);c._sFocusableOverlayClass=".sapUiDtOverlaySelectable";c._sRtaStyleClassName='';c.getRtaStyleClassName=function(){return c._sRtaStyleClassName;};c.setRtaStyleClassName=function(l){if(l===L.USER){c._sRtaStyleClassName="";}else if(a.getLayerIndex(l)>-1){c._sRtaStyleClassName="sapUiRTABorder";}};c.isExtensibilityEnabledInSystem=function(C){var s=F.getComponentClassName(C);if(!s||s===""){return Promise.resolve(false);}return S.getInstance(s).then(function(o){if(o.isModelS){return o.isModelS();}return false;});};c.isServiceUpToDate=function(C){return this.isExtensibilityEnabledInSystem(C).then(function(e){if(e){return new Promise(function(r,R){sap.ui.require(["sap/ui/fl/fieldExt/Access"],function(A){var o=C.getModel();if(o){var s=A.isServiceOutdated(o.sServiceUrl);if(s){A.setServiceValid(o.sServiceUrl);sap.ui.getCore().getEventBus().publish("sap.ui.core.UnrecoverableClientStateCorruption","RequestReload",{});return R();}}return r();});});}});};c.isCustomFieldAvailable=function(C){return this.isExtensibilityEnabledInSystem(C).then(function(s){if(!s||!C.getModel()){return false;}return new Promise(function(r,R){sap.ui.require(["sap/ui/fl/fieldExt/Access"],function(A){var d=C.getModel().sServiceUrl;var e=this.getBoundEntityType(C).name;var $;try{$=A.getBusinessContexts(d,e);}catch(E){b.error("exception occured in sap.ui.fl.fieldExt.Access.getBusinessContexts",E);r(false);}return Promise.resolve($).then(function(o){if(o&&Array.isArray(o.BusinessContexts)&&o.BusinessContexts.length>0){o.EntityType=e;return r(o);}return r(false);}).catch(function(E){if(E){if(Array.isArray(E.errorMessages)){for(var i=0;i<E.errorMessages.length;i++){b.error(E.errorMessages[i].text);}}}return r(false);});}.bind(this),R);}.bind(this));}.bind(this));};c.openRemoveConfirmationDialog=function(e,t){var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var s;return new Promise(function(r){s=T.getText("CTX_REMOVE_TITLE");var d={messageText:t,titleText:s,icon:"sap-icon://question-mark",removeText:T.getText("BTN_FREP_REMOVE"),cancelText:T.getText("BTN_FREP_CANCEL")};var o=new sap.ui.model.json.JSONModel();o.setData(d);var f;var C=function(){if(f){f.close();f.destroy();f=null;}};var g={removeField:function(){C();r(true);},closeDialog:function(){C();r(false);}};if(!f){f=sap.ui.xmlfragment("sap.ui.rta.view.RemoveElementDialog",g);f.setModel(o);}f.addStyleClass(c.getRtaStyleClassName());f.open();});};c.isOverlaySelectable=function(o){return o.isSelectable()&&D.isVisible(o.getDomRef());};c.getPropertyValue=function(e,p){var o=e.getMetadata().getPropertyLikeSetting(p);var P=o._sGetter;return e[P]();};c.getOverlayInstanceForDom=function(d){var i=q(d).attr("id");if(i){return sap.ui.getCore().byId(i);}};c.getFocusedOverlay=function(){if(document.activeElement){var e=sap.ui.getCore().byId(document.activeElement.id);if(e instanceof sap.ui.dt.ElementOverlay){return e;}}};c.getFocusableParentOverlay=function(o){if(!o){return undefined;}var f=o.getParentElementOverlay();while(f&&!f.getSelectable()){f=f.getParentElementOverlay();}return f;};c.getFirstFocusableDescendantOverlay=function(o){return O.getFirstDescendantByCondition(o,this.isOverlaySelectable);};c.getLastFocusableDescendantOverlay=function(o){return O.getLastDescendantByCondition(o,this.isOverlaySelectable);};c.getNextFocusableSiblingOverlay=function(o){var N=true;var n=O.getNextSiblingOverlay(o);while(n&&!this.isOverlaySelectable(n)){n=O.getNextSiblingOverlay(n);}if(!n){n=this._findSiblingOverlay(o,N);}return n;};c.getPreviousFocusableSiblingOverlay=function(o){var P=false;var p=O.getPreviousSiblingOverlay(o);while(p&&!this.isOverlaySelectable(p)){p=O.getPreviousSiblingOverlay(p);}if(!p){p=this._findSiblingOverlay(o,P);}return p;};c._findSiblingOverlay=function(o,n){var p=o.getParentElementOverlay();if(p){var s=n?O.getNextSiblingOverlay(p):O.getPreviousSiblingOverlay(p);if(!s){return this._findSiblingOverlay(p,n);}var d=n?this.getFirstFocusableDescendantOverlay(s):this.getLastFocusableDescendantOverlay(s);return d;}return undefined;};c.getIndex=function(p,C,A,g){var i;if(g&&typeof g==="function"){i=g(p,C);}else{var o=p.getMetadata();var d=o.getAggregation(A);var G=d._sGetter;var e=p[G]();if(Array.isArray(e)&&C){i=e.indexOf(C)+1;}else{i=0;}}return i;};c.createFieldLabelId=function(p,e,s){return(p.getId()+"_"+e+"_"+s).replace("/","_");};c.getBoundEntityType=function(e,o){o||(o=e.getModel());var d=e.getBindingContext();if(d){return c.getEntityTypeByPath(o,d.getPath())||{};}return{};};c.openNewWindow=function(u){window.open(u,"_blank");};c.getElementBindingPaths=function(e){var p={};if(e.mBindingInfos){for(var i in e.mBindingInfos){var P=e.mBindingInfos[i].parts[0].path?e.mBindingInfos[i].parts[0].path:"";P=P.split("/")[P.split("/").length-1];p[P]={valueProperty:i};}}return p;};c.getFiori2Renderer=function(){var C=F.getUshellContainer()||{};return typeof C.getRenderer==="function"?C.getRenderer("fiori2"):undefined;};c.getEntityTypeByPath=function(o,p){return o.oMetadata&&o.oMetadata._getEntityTypeByPath(p);};c.extendWith=function(d,s,C){if(!(typeof C==="function")){throw new Error('In order to use extendWith() utility function fnCustomizer should be provided!');}for(var e in s){if(s.hasOwnProperty(e)){if(C(d[e],s[e],e,d,s)){d[e]=s[e];}}}};c.isElementInViewport=function(d){if(d instanceof q){d=d.get(0);}var r=d.getBoundingClientRect();return(r.top>=0&&r.left>=0&&r.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&r.right<=(window.innerWidth||document.documentElement.clientWidth));};c.showMessageBox=function(s,d,p){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta",true).then(function(r){p=p||{};var e=r.getText(d,p.error?[p.error.userMessage||p.error.message||p.error]:undefined);var t=r.getText(p.titleKey);var o=_(p,["titleKey","error"]);o.title=t;o.styleClass=c.getRtaStyleClassName();return m(s,e,o);});};function m(s,d,o){return new Promise(function(r){o.onClose=r;M[s](d,o);});}c.checkSourceTargetBindingCompatibility=function(s,t,o){o=o||s.getModel();var d=B.collectBindingPaths(s,o);var e;var T;if(d.bindingPaths.length===0){return true;}e=B.getBindingContextPath(s);T=B.getBindingContextPath(t);if(e===T){return true;}return false;};c.doIfAllControlsAreAvailable=function(C,f){if(C.every(function(o){return o&&!o._bIsBeingDestroyed;})){return f();}};c.buildHashMapFromArray=function(A,k,v){return A.reduce(function(d,i){d[i[k]]=i[v];return d;},{});};c.hasUrlParameterWithValue=function(p,P){var u=F.getUshellContainer();if(u){var d=F.getParsedURLHash();return d.params&&d.params[p]&&d.params[p][0]===P;}var o=U.fromQuery(document.location.search);if(!o){return false;}var s=o.get(p);return s===P;};c.handleUrlParameter=function(u,p,P){if(c.hasUrlParameterWithValue(p,P)){if(u.startsWith("?")){u=u.substr(1,u.length);}var f=u.split("&").filter(function(s){return s!==p+"="+P;});u="";if(f.length>0){u="?"+f.toString();}}else{u+=(u.length>0?'&':'?')+p+"="+P;}return u;};return c;},true);
