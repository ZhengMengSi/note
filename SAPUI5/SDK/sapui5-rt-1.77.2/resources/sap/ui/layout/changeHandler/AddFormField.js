/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/changeHandler/ChangeHandlerMediator","sap/base/Log","sap/base/util/merge"],function(B,C,L,m){"use strict";function g(d){return d&&d.content&&d.content.createFunction;}function c(o,d){var e=o.content;if(e){return o.content.newFieldSelector&&(o.content.newFieldIndex!==undefined)&&o.content.bindingPath&&o.content.oDataServiceVersion&&!!g(d);}return false;}function a(d,p){return new Promise(function(r){sap.ui.require([d.name],r);}).then(function(D){var e=m({aggregationName:"formElements",payload:d.payload},p);return D.createControlForProperty(e).then(function(f){var n=p.modifier.getId(f.control);e.labelFor=n;return D.createLabel(e).then(function(l){return{label:l,control:f.control,valueHelp:f.valueHelp};});});});}function b(o,p){return C.getChangeHandlerSettings({"scenario":"addODataFieldWithLabel","oDataServiceVersion":o.content&&o.content.oDataServiceVersion}).then(function(d){if(c(o,d)){var f=g(d);return f(p.modifier,p);}else{L.error("Change does not contain sufficient information to be applied or ChangeHandlerMediator could not be retrieved: ["+o.layer+"]"+o.namespace+"/"+o.fileName+"."+o.fileType);}});}var A={};A.applyChange=function(o,f,p){var d=o.getDefinition();var v=p.view;var i=d.content.newFieldIndex;var e=p.appComponent;var h=d.content;var F=h.newFieldSelector;var s=m({},h.newFieldSelector);s.id=s.id+"-field";var j=h.bindingPath;var k={appComponent:p.appComponent,view:p.view,fieldSelector:s,bindingPath:j,modifier:p.modifier};if(p.modifier.bySelector(F,e)){return B.markAsNotApplicable("Control to be created already exists:"+F);}var r={newFieldSelector:F};var D=p.modifier.getFlexDelegate(f);var w=D?a(D,k):b(d,k);return w.then(function(I){var l=p.modifier.createControl("sap.ui.layout.form.FormElement",e,v,F);p.modifier.insertAggregation(l,"label",I.label,0,v);p.modifier.insertAggregation(l,"fields",I.control,0,v);var P=o.getDependentControl("parentFormContainer",p);p.modifier.insertAggregation(P,"formElements",l,i,v);if(I.valueHelp){p.modifier.insertAggregation(P,"dependents",I.valueHelp,0,v);var V=p.modifier.getSelector(p.modifier.getId(I.valueHelp),e);r.valueHelpSelector=V;}o.setRevertData(r);return true;});};A.completeChangeContent=function(o,s,p){var d=p.appComponent;var e=o.getDefinition();if(!e.content){e.content={};}if(s.parentId){o.addDependentControl(s.parentId,"parentFormContainer",p);}else{throw new Error("oSpecificChangeInfo.parentId attribute required");}if(s.bindingPath){e.content.bindingPath=s.bindingPath;}else{throw new Error("oSpecificChangeInfo.bindingPath attribute required");}if(s.newControlId){e.content.newFieldSelector=p.modifier.getSelector(s.newControlId,d);}else{throw new Error("oSpecificChangeInfo.newControlId attribute required");}if(s.index===undefined){throw new Error("oSpecificChangeInfo.targetIndex attribute required");}else{e.content.newFieldIndex=s.index;}if(s.oDataServiceVersion===undefined){throw new Error("oSpecificChangeInfo.oDataServiceVersion attribute required");}else{e.content.oDataServiceVersion=s.oDataServiceVersion;}};A.revertChange=function(o,f,p){var d=p.appComponent;var v=p.view;var M=p.modifier;var F=o.getRevertData().newFieldSelector;var V=o.getRevertData().valueHelpSelector;var e=M.bySelector(F,d,v);var P=o.getDependentControl("parentFormContainer",p);M.removeAggregation(P,"formElements",e);M.destroy(e);if(V){var h=M.bySelector(V,d,v);M.removeAggregation(P,"dependents",h);M.destroy(h);}o.resetRevertData();return true;};return A;},true);
