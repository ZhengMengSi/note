/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/fl/variants/VariantController","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/util/includes","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState"],function(D,S,C,L,V,U,a,b,A,c,d,J,e,f,M,q,i,m,g,h){"use strict";var j=function(n){this._mComponent=n;this._mChanges=D.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=m({},this._mChanges);this._mVariantsChanges={};if(!this._mComponent||!this._mComponent.name){g.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._oVariantController=new d(this._mComponent.name,this._mComponent.appVersion,{});this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function k(v,o){var F;Object.keys(v).some(function(s){return v[s].variants.some(function(n){if(n.content.fileName===o.getDefinition().variantReference){F=n;return true;}});});return F;}function r(v,o){return v.controlChanges.some(function(n,p){if(n.fileName===o.getDefinition().fileName){v.controlChanges.splice(p,1,o);return true;}});}function l(F,o){var n;if(o instanceof C){n=o;this._mChangesEntries[n.getFileName()]=n;}else{if(!this._mChangesEntries[o.fileName]){this._mChangesEntries[o.fileName]=new C(o);}n=this._mChangesEntries[o.fileName];n.setState(C.states.PERSISTED);if(n.getVariantReference()){var v=this._oVariantController.getChangeFileContent();var p=k.call(this,v,n);if(p&&r(p,n)){h.updateVariantsState({reference:this._mComponent.name,content:v});}}}return n;}j.prototype.getComponentName=function(){return this._mComponent.name;};j.prototype.getCacheKey=function(o){return b.getCacheKey(this._mComponent,o);};j.prototype._preconditionsFulfilled=function(I,o){var n=o instanceof C?o.getDefinition():o;if(!n.fileName){g.warning("A change without fileName is detected and excluded from component: "+this._mComponent.name);return false;}function p(){if(I){return(n.fileType==="change")||(n.fileType==="variant");}return(n.fileType==="change")&&(n.changeType!=="defaultVariant");}function s(){if(I){if((n.fileType==="variant")||(n.changeType==="defaultVariant")){return n.selector&&n.selector.persistencyKey;}}return true;}function t(){if((n.fileType==="ctrl_variant")||(n.fileType==="ctrl_variant_change")||(n.fileType==="ctrl_variant_management_change")){return n.variantManagementReference||n.variantReference||(n.selector&&n.selector.id);}}if(p()&&s()||t()){return true;}return false;};j.prototype.getChangesForComponent=function(p,I){return b.getChangesFillingCache(this._mComponent,p,I).then(function(p,w){var o=m({},w);var n=p&&p.component&&U.getAppComponentForControl(p.component);var H=S.isStorageResponseFilled(o.changes);if(!H){return[];}var s=o.changes.changes;if(!this._oMessagebundle&&o.messagebundle&&n){if(!n.getModel("i18nFlexVendor")){if(s.some(function(B){return B.layer===L.VENDOR;})){this._oMessagebundle=o.messagebundle;var t=new f(this._oMessagebundle);n.setModel(t,"i18nFlexVendor");}}}var u=p&&p.currentLayer;var F=!(p&&p.ignoreMaxLayerParameter);var v=function(){return true;};if(u){v=this._filterChangeForCurrentLayer.bind(this,u);s=s.filter(v);}else if(a.isLayerFilteringRequired()&&F){v=this._filterChangeForMaxLayer.bind(this);s=s.filter(v);}else if(this._bHasChangesOverMaxLayer&&!F){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}var x=o.changes&&p&&p.includeCtrlVariants;this._oVariantController.setChangeFileContent(o);var y=this._getAllCtrlVariantChanges(o,x,v);s=s.concat(y);var z=p&&p.includeVariants;return this._checkAndGetChangeInstances(s,z,o);}.bind(this,p));};j.prototype._checkAndGetChangeInstances=function(n,I,o){return n.filter(this._preconditionsFulfilled.bind(this,I)).map(l.bind(this,o));};j.prototype._filterChangeForMaxLayer=function(o){if(a.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(o))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;};j.prototype._filterChangeForCurrentLayer=function(s,o){return s===this._getLayerFromChangeOrChangeContent(o);};j.prototype._getLayerFromChangeOrChangeContent=function(o){var s;if(o instanceof V||o instanceof C){s=o.getLayer();}else{s=o.layer;}return s;};j.prototype._getAllCtrlVariantChanges=function(o,I,F){if(!I){return h.loadInitialChanges({reference:this._mComponent.name});}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(R,v){if(o.changes[v]){return R.concat(o.changes[v]);}return R;},[]).filter(F);};j.prototype.getSmartVariantManagementChangeMap=function(){return this._mVariantsChanges;};j.prototype.getChangesForVariant=function(s,n,p){if(this._mVariantsChanges[n]){return Promise.resolve(this._mVariantsChanges[n]);}var o=function(u){var v=false;var w=u._oDefinition.selector;q.each(w,function(x,y){if(x===s&&y===n){v=true;}});return v;};var t=function(u,v){g.error("key : "+u+" and text : "+v.value);};return this.getChangesForComponent(p).then(function(u){return u.filter(o);}).then(function(u){if(!this._mVariantsChanges[n]){this._mVariantsChanges[n]={};}var I;u.forEach(function(v){I=v.getId();if(v.isValid()){if(this._mVariantsChanges[n][I]&&v.isVariant()){g.error("Id collision - two or more variant files having the same id detected: "+I);q.each(v.getDefinition().texts,t);g.error("already exists in variant : ");q.each(this._mVariantsChanges[n][I].getDefinition().texts,t);}this._mVariantsChanges[n][I]=v;}}.bind(this));return this._mVariantsChanges[n];}.bind(this));};j.prototype.addChangeForVariant=function(s,n,p){var F;var I;var o;var t;var u;if(!p){return undefined;}if(!p.type){g.error("sap.ui.fl.Persistence.addChange : type is not defined");}var v=q.type(p.content);if(v!=='object'&&v!=='array'){g.error("mParameters.content is not of expected type object or array, but is: "+v,"sap.ui.fl.Persistence#addChange");}o={};if(typeof(p.texts)==="object"){q.each(p.texts,function(x,y){o[x]={value:y,type:"XFLD"};});}var w={creation:this._mComponent.appVersion,from:this._mComponent.appVersion};if(this._mComponent.appVersion&&p.developerMode){w.to=this._mComponent.appVersion;}I={changeType:p.type,service:p.ODataService,texts:o,content:p.content,reference:this._mComponent.name,isVariant:p.isVariant,packageName:p.packageName,isUserDependent:p.isUserDependent,validAppVersions:w};I.selector={};I.selector[s]=n;F=C.createInitialFileContent(I);if(p.id){F.fileName=p.id;}t=new C(F);u=t.getId();if(!this._mVariantsChanges[n]){this._mVariantsChanges[n]={};}this._mVariantsChanges[n][u]=t;return t.getId();};j.prototype.saveAllChangesForVariant=function(s){var p=[];q.each(this._mVariantsChanges[s],function(n,o){var t=o.getId();switch(o.getPendingAction()){case"NEW":var u=c.write({flexObjects:[o.getDefinition()],layer:o.getLayer(),transport:o.getRequest(),isLegacyVariant:o.isVariant()}).then(function(x){if(x&&x.response&&x.response[0]){o.setResponse(x.response[0]);}else{o.setState(C.states.PERSISTED);}b.addChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return x;}.bind(this));p.push(u);break;case"UPDATE":var v=c.update({flexObject:o.getDefinition(),layer:o.getLayer(),transport:o.getRequest()}).then(function(x){if(x&&x.response){o.setResponse(x.response);}else{o.setState(C.states.PERSISTED);}b.updateChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return x;}.bind(this));p.push(v);break;case"DELETE":var w=c.remove({flexObject:o.getDefinition(),layer:o.getLayer(),transport:o.getRequest()}).then(function(x){var o=this._mVariantsChanges[s][t];if(o.getPendingAction()==="DELETE"){delete this._mVariantsChanges[s][t];}b.deleteChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return x;}.bind(this));p.push(w);break;default:break;}}.bind(this));return Promise.all(p);};j.prototype.loadChangesMapForComponent=function(o){return this.getChangesForComponent({component:o}).then(n.bind(this));function n(p){M.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=D.createEmptyDependencyMap();p.forEach(this._addChangeAndUpdateDependencies.bind(this,o));this._mChangesInitial=m({},this._mChanges);M.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this);}};j.prototype.checkForOpenDependenciesForControl=function(s,o){return D.checkForOpenDependenciesForControl(this._mChanges,J.getControlIdBySelector(s,o),o);};j.prototype.copyDependenciesFromInitialChangesMap=function(o,n,p){var I=m({},this._mChangesInitial.mDependencies);var s=I[o.getId()];if(s){var N=[];s.dependencies.forEach(function(v){if(n(v)){this._mChanges.mDependentChangesOnMe[v]=this._mChanges.mDependentChangesOnMe[v]||[];this._mChanges.mDependentChangesOnMe[v].push(o.getId());N.push(v);}}.bind(this));var t;var u=[];s.controlsDependencies.forEach(function(v){if(!J.bySelector(v,p)){t=J.getControlIdBySelector(v,p);u.push(v);this._mChanges.mControlsWithDependencies[t]=this._mChanges.mControlsWithDependencies[t]||[];if(!i(this._mChanges.mControlsWithDependencies[t],o.getId())){this._mChanges.mControlsWithDependencies[t].push(o.getId());}}}.bind(this));s.dependencies=N;s.controlsDependencies=u;if(N.length||u.length){this._mChanges.mDependencies[o.getId()]=s;}}return this._mChanges;};j.prototype._addChangeAndUpdateDependencies=function(o,n){n.setInitialApplyState();D.addChangeAndUpdateDependencies(n,o,this._mChanges);};j.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(o,n){D.addRuntimeChangeAndUpdateDependencies(n,o,this._mChanges,this._mChangesInitial);};j.prototype.getChangesMapForComponent=function(){return this._mChanges;};j.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated;};function _(p,o){var n=p.modifier;var s=p.appComponent;var t=o.getSelector();if(!t||!p){return false;}if(t.viewSelector){var u=n.getControlIdBySelector(t.viewSelector,s);return u===p.viewId;}var v=t.id;if(v){var w;if(o.getSelector().idIsLocal){if(s){w=s.getLocalId(p.viewId);}}else{w=p.viewId;}var I=0;var x;do{I=v.indexOf("--",I);x=v.slice(0,I);I++;}while(x!==w&&I>0);return x===w;}return false;}j.prototype.getChangesForView=function(p){return this.getChangesForComponent(p).then(function(n){return n.filter(_.bind(this,p));}.bind(this));};j.prototype.getChangesForExtensionPoint=function(p){var n=function(o){var N=o.getSelector().name;if(N!==p.name){return false;}return _(p,o);};if(!p.name){g.warning("Missing name from extension point info!");return Promise.resolve([]);}return this.getChangesForComponent().then(function(o){return o.filter(n);});};j.prototype.addChange=function(v,o){var n=this.addDirtyChange(v);this._addRunTimeCreatedChangeAndUpdateDependencies(o,n);this._addPropagationListener(o);return n;};j.prototype.addDirtyChange=function(v){var n;if(v instanceof C||v instanceof V){n=v;}else{n=new C(v);}if(this._aDirtyChanges.indexOf(n)===-1){this._aDirtyChanges.push(n);}return n;};j.prototype._addPropagationListener=function(o){var n=U.getAppComponentForControl(o);if(n instanceof e){var p=function(P){return!P._bIsSapUiFlFlexControllerApplyChangesOnControl;};var N=n.getPropagationListeners().every(p);if(N){var s=n.getManifestObject();var v=U.getAppVersionFromManifest(s);var F=sap.ui.require("sap/ui/fl/FlexControllerFactory");var t=F.create(this.getComponentName(),v);var P=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),n,t);P._bIsSapUiFlFlexControllerApplyChangesOnControl=true;n.addPropagationListener(P);}}};j.prototype.saveDirtyChanges=function(s,n,o){var p=n||this._aDirtyChanges;var t=p.slice(0);var R=this._getRequests(p);var P=this._getPendingActions(p);if(P.length===1&&R.length===1&&P[0]==="NEW"){var u=R[0];var v=this._prepareDirtyChanges(p);return c.write({layer:v[0].layer,flexObjects:v,transport:u,isLegacyVariant:false,draft:o}).then(function(w){this._massUpdateCacheAndDirtyState(t,s);return w;}.bind(this));}return this.saveSequenceOfDirtyChanges(t,s,o);};j.prototype.saveSequenceOfDirtyChanges=function(n,s,o){return n.reduce(function(p,t){return p.then(this._performSingleSaveAction(t,o)).then(this._updateCacheAndDirtyState.bind(this,t,s));}.bind(this),Promise.resolve());};j.prototype._performSingleSaveAction=function(o,n){return function(){if(o.getPendingAction()==="NEW"){return c.write({layer:o.getLayer(),flexObjects:[o.getDefinition()],transport:o.getRequest(),isLegacyVariant:o.isVariant(),draft:n});}if(o.getPendingAction()==="DELETE"){return c.remove({flexObject:o.getDefinition(),layer:o.getLayer(),transport:o.getRequest()});}};};j.prototype._updateCacheAndDirtyState=function(o,s){if(!s){if(U.isChangeRelatedToVariants(o)){h.updateVariantsState({reference:this._mComponent.name,content:this._oVariantController.getChangeFileContent(),changeToBeAddedOrDeleted:o});}else if(o.getPendingAction()==="NEW"){b.addChange(this._mComponent,o.getDefinition());}else if(o.getPendingAction()==="DELETE"){b.deleteChange(this._mComponent,o.getDefinition());}}this._aDirtyChanges=this._aDirtyChanges.filter(function(E){return o.getId()!==E.getId();});};j.prototype._massUpdateCacheAndDirtyState=function(n,s){n.forEach(function(o){this._updateCacheAndDirtyState(o,s);},this);};j.prototype._getRequests=function(n){var R=[];n.forEach(function(o){var s=o.getRequest();if(R.indexOf(s)===-1){R.push(s);}});return R;};j.prototype._getPendingActions=function(n){var p=[];n.forEach(function(o){var P=o.getPendingAction();if(p.indexOf(P)===-1){p.push(P);}});return p;};j.prototype._prepareDirtyChanges=function(n){var o=[];n.forEach(function(p){o.push(p.getDefinition());});return o;};j.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};j.prototype.deleteChange=function(o,R){var n=this._aDirtyChanges.indexOf(o);if(n>-1){if(o.getPendingAction()==="DELETE"){return;}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(o,R);return;}o.markForDeletion();this.addDirtyChange(o);this._deleteChangeInMap(o,R);};j.prototype._deleteChangeInMap=function(o,R){var s=o.getId();D.removeChangeFromMap(this._mChanges,s);D.removeChangeFromDependencies(R?this._mChangesInitial:this._mChanges,s);};j.prototype.loadSwitchChangesMapForComponent=function(p){p.changesMap=this._mChanges.mChanges;return this._oVariantController.getChangesForVariantSwitch(p);};j.prototype.transportAllUIChanges=function(R,s,n,o){return this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}).then(function(p){return c.publish({transportDialogSettings:{rootControl:R,styleClass:s},layer:n,reference:this.getComponentName(),appVersion:this._mComponent.appVersion,localChanges:p,appVariantDescriptors:o});}.bind(this));};j.prototype._getChangesFromMapByNames=function(n){return this._mChanges.aChanges.filter(function(o){return n.indexOf(o.getFileName())!==-1;});};j.prototype.resetChanges=function(s,G,n,o){var p=n&&n.length>0;var t=o&&o.length>0;if(!G&&!p&&!t){g.error("Of the generator, selector IDs and change types parameters at least one has to filled");return Promise.reject("Of the generator, selector IDs and change types parameters at least one has to filled");}return this.getChangesForComponent({currentLayer:s,includeCtrlVariants:true}).then(function(u){var P={reference:this.getComponentName(),appVersion:this._mComponent.appVersion,layer:s,changes:u};if(G){P.generator=G;}if(p){P.selectorIds=n;}if(t){P.changeTypes=o;}return c.reset(P);}.bind(this)).then(function(R){var u=[];if(n||o){var N=[];if(R&&R.response&&R.response.length>0){R.response.forEach(function(v){N.push(v.name);});}b.removeChanges(this._mComponent,N);u=this._getChangesFromMapByNames(N);}return u;}.bind(this));};j.prototype.resetVariantMap=function(R){return this._oVariantController.resetMap(R);};j.prototype.getResetAndPublishInfo=function(p){return c.getFlexInfo(p);};return j;},true);
