/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./library','sap/ui/core/Core','sap/ui/core/Control','sap/ui/core/EnabledPropagator','sap/ui/core/delegate/ItemNavigation',"sap/ui/core/InvisibleText",'sap/ui/core/ResizeHandler','sap/m/Button','sap/m/IconTabFilter','sap/m/IconTabSeparator','sap/m/IconTabBarDragAndDropUtil','sap/m/IconTabHeaderRenderer',"sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/events/KeyCodes"],function(l,C,a,E,I,b,R,B,c,d,e,f,q,L,K){"use strict";var g=l.BackgroundDesign;var h=l.IconTabHeaderMode;var j=l.IconTabDensityMode;var k=a.extend("sap.m.IconTabHeader",{metadata:{library:"sap.m",properties:{showSelection:{type:"boolean",group:"Misc",defaultValue:true,deprecated:true},selectedKey:{type:"string",group:"Data",defaultValue:null},visible:{type:"boolean",group:"Behavior",defaultValue:true},mode:{type:"sap.m.IconTabHeaderMode",group:"Appearance",defaultValue:h.Standard},showOverflowSelectList:{type:"boolean",group:"Appearance",defaultValue:false,deprecated:true},backgroundDesign:{type:"sap.m.BackgroundDesign",group:"Appearance",defaultValue:g.Solid},enableTabReordering:{type:"boolean",group:"Behavior",defaultValue:false},tabDensityMode:{type:"sap.m.IconTabDensityMode",group:"Appearance",defaultValue:j.Cozy}},aggregations:{items:{type:"sap.m.IconTab",multiple:true,singularName:"item",dnd:{draggable:true,droppable:true,layout:"Horizontal"}},_overflow:{type:"sap.m.IconTabFilter",multiple:false,visibility:"hidden"}},events:{select:{parameters:{item:{type:"sap.m.IconTabFilter"},key:{type:"string"}}}}}});var r=C.getLibraryResourceBundle("sap.m");E.apply(k.prototype,[true]);k.prototype.init=function(){this._aTabKeys=[];this._oAriaHeadText=new b({id:this.getId()+"-ariaHeadText"});};k.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation;}if(this._sResizeListenerId){R.deregister(this._sResizeListenerId);this._sResizeListenerId=null;}if(this._aTabKeys){this._aTabKeys=null;}if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}if(this.getAggregation("_overflow")){this._getOverflow().removeEventDelegate(this._oOverflowEventDelegate);this._oOverflowEventDelegate=null;}this._oAriaHeadText.destroy();this._oAriaHeadText=null;this._bRtl=null;};k.prototype.onBeforeRendering=function(){this._bRtl=C.getConfiguration().getRTL();if(this._sResizeListenerId){R.deregister(this._sResizeListenerId);this._sResizeListenerId=null;}this._updateSelection();this._setsDragAndDropConfigurations();};k.prototype.onAfterRendering=function(){this._applyTabDensityMode();var p=this.getParent();var i=this._isInsideIconTabBar();if(this.oSelectedItem&&(!i||i&&p.getExpanded())){this.oSelectedItem.$().addClass("sapMITBSelected").attr({'aria-selected':true});if(this._oSelectedRootItem){this._oSelectedRootItem.$().addClass("sapMITBSelected");this._oSelectedRootItem.$().attr({"aria-selected":true});}}if(C.isThemeApplied()){this._setItemsForStrip();}else{C.attachThemeChanged(this._handleThemeLoad,this);}this._initItemNavigation();this._sResizeListenerId=R.register(this.getDomRef(),q.proxy(this._fnResize,this));};k.prototype._getSelectList=function(){return this._getOverflow()._getSelectList();};k.prototype._getOverflow=function(){var o=this.getAggregation("_overflow");if(!o){o=new c({id:this.getId()+'-overflow',text:r.getText("ICONTABHEADER_OVERFLOW_MORE")});o._bIsOverflow=true;this._oOverflowEventDelegate={onlongdragover:this._handleOnLongDragOver,ondragover:this._handleOnDragOver,ondragleave:this._handleOnDragLeave,ondrop:this._handleOnDrop};o.addEventDelegate(this._oOverflowEventDelegate,this);o.addEventDelegate({onsapnext:o.onsapdown},o);this.setAggregation("_overflow",o);}return o;};k.prototype._onItemNavigationFocusLeave=function(){if(!this.oSelectedItem){return;}var m=this.getItems();var n=-1;var o;for(var i=0;i<m.length;i++){o=m[i];if(o instanceof c==false){continue;}n++;if((this._oSelectedRootItem||this.oSelectedItem)==o){break;}}this._oItemNavigation.setFocusedIndex(n);};k.prototype.getTabFilters=function(){var t=[];this.getItems().forEach(function(i){if(i instanceof c){t.push(i);}});return t;};k.prototype._handleOnLongDragOver=function(){var o=this._getOverflow();if(!o._oPopover||!o._oPopover.isOpen()){o._expandButtonPress();}};k.prototype._handleOnDragOver=function(o){this._getOverflow()._getExpandButton().addStyleClass("sapMBtnDragOver");o.preventDefault();};k.prototype._handleOnDrop=function(){this._getOverflow()._getExpandButton().removeStyleClass("sapMBtnDragOver");};k.prototype._handleOnDragLeave=function(){this._getOverflow()._getExpandButton().removeStyleClass("sapMBtnDragOver");};k.prototype._setsDragAndDropConfigurations=function(){if(!this.getEnableTabReordering()&&this.getDragDropConfig().length){this.destroyDragDropConfig();}else if(this.getEnableTabReordering()&&!this.getDragDropConfig().length){e.setDragDropAggregations(this,"Horizontal");}};k.prototype.setSelectedKey=function(s){var m=this.getTabFilters(),n=this._isInsideIconTabBar(),S;if(m.length>0){s=s||m[0]._getNonEmptyKey();}if(this.$().length){for(var i=0;i<m.length;i++){if(m[i]._getNonEmptyKey()===s){this.setSelectedItem(m[i],true);S=true;break;}}if(!S&&!n&&s){this.setSelectedItem(null);}}this.setProperty("selectedKey",s,true);return this;};k.prototype.setSelectedItem=function(i,A){if(!i){if(this.oSelectedItem){this.oSelectedItem.$().removeClass("sapMITBSelected");this.oSelectedItem=null;if(this._oSelectedRootItem){this._oSelectedRootItem.getDomRef().classList.remove("sapMITBSelected");this._oSelectedRootItem=null;}}return this;}if(this._isUnselectable(i)){return this;}var p=this.getParent();var m=this._isInsideIconTabBar();var n=false;if(i.getContent().length===0&&this.oSelectedItem&&this.oSelectedItem.getContent().length===0){n=true;}if(this.oSelectedItem&&this.oSelectedItem.getVisible()&&(!A&&m&&p.getExpandable()||this.oSelectedItem!==i)){this.oSelectedItem.$().removeClass("sapMITBSelected").attr('aria-selected',false).removeAttr('aria-expanded');if(this._oSelectedRootItem){this._oSelectedRootItem.$().removeClass("sapMITBSelected").attr('aria-selected',false).removeAttr('aria-expanded');}}if(i.getVisible()){if(this.oSelectedItem===i){if(!A&&m&&p.getExpandable()){p._toggleExpandCollapse();}}else{if(m){p.$("content").attr('aria-labelledby',i.sId);}this.oSelectedItem=i;if(this.oSelectedItem._getNestedLevel()!==1){this._oSelectedRootItem=this.oSelectedItem._getRootTab();this._oSelectedRootItem.$().addClass("sapMITBSelected").attr({'aria-selected':true});}else{this._oSelectedRootItem=null;}this.setProperty("selectedKey",this.oSelectedItem._getNonEmptyKey(),true);if(!m){this.oSelectedItem.$().addClass("sapMITBSelected").attr({'aria-selected':true});}if(m&&(p.getExpandable()||p.getExpanded())){this.oSelectedItem.$().addClass("sapMITBSelected").attr({'aria-selected':true});var s=this.oSelectedItem.getContent();if(s.length>0){p._rerenderContent(s);}else{if(!n){p._rerenderContent(p.getContent());}}if(!A&&p.getExpandable()&&!p.getExpanded()){p._toggleExpandCollapse(true);}}}}this.oSelectedItem=i;var S=this.oSelectedItem._getNonEmptyKey();this.setProperty("selectedKey",S,true);if(m){p.setProperty("selectedKey",S,true);}if(!A){if(m){p.fireSelect({selectedItem:this.oSelectedItem,selectedKey:S,item:this.oSelectedItem,key:S});}else{this.fireSelect({selectedItem:this.oSelectedItem,selectedKey:S,item:this.oSelectedItem,key:S});}}this._setItemsForStrip();return this;};k.prototype.getVisibleTabFilters=function(){return this.getTabFilters().filter(function(F){return F.getVisible();});};k.prototype._initItemNavigation=function(){var t=this,i=this.getItems(),T=[],s=-1;i.forEach(function(m){if(m.isA("sap.m.IconTabFilter")){var n=t.getFocusDomRef(m);if(!n){return;}n.setAttribute("tabindex","-1");T.push(n);if(m===t.oSelectedItem||m===t._oSelectedRootItem){s=T.indexOf(n);}}});if(this.$().hasClass("sapMITHOverflowList")){var o=this._getOverflow().getFocusDomRef();o.setAttribute("tabindex","-1");T.push(o);}if(!this._oItemNavigation){this._oItemNavigation=new I().setCycling(false).attachEvent(I.Events.FocusLeave,this._onItemNavigationFocusLeave,this).setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"]});this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(this.getDomRef()).setItemDomRefs(T).setPageSize(T.length).setSelectedIndex(s);};k.prototype.onThemeChanged=function(){this._applyTabDensityMode();};k.prototype._applyTabDensityMode=function(){var t=this.getTabDensityMode();this.$().removeClass("sapUiSizeCompact");switch(t){case j.Compact:this.$().addClass("sapUiSizeCompact");break;case j.Inherit:if(this.$().closest(".sapUiSizeCompact").length){this.$().addClass("sapUiSizeCompact");}break;}};k.prototype._handleThemeLoad=function(){setTimeout(this._setItemsForStrip.bind(this),350);C.detachThemeChanged(this._handleThemeLoad,this);};k.prototype.destroyItems=function(){this.oSelectedItem=null;this._aTabKeys=[];this.destroyAggregation("items");return this;};k.prototype.addItem=function(i){if(!(i instanceof d)){var s=i.getKey();if(this._aTabKeys.indexOf(s)!==-1){L.warning("sap.m.IconTabHeader: duplicate key '"+s+"' inside the IconTabFilter. Please use unique keys.");}this._aTabKeys.push(s);}this.addAggregation("items",i);this._invalidateParentIconTabBar();};k.prototype.insertItem=function(i,m){if(!(i instanceof d)){var s=i.getKey();if(this._aTabKeys.indexOf(s)!==-1){L.warning("sap.m.IconTabHeader: duplicate key '"+s+"' inside the IconTabFilter. Please use unique keys.");}this._aTabKeys.push(s);}this.insertAggregation("items",i,m);this._invalidateParentIconTabBar();};k.prototype.removeAllItems=function(){var o=this.removeAllAggregation("items");this._aTabKeys=[];this.oSelectedItem=null;this._invalidateParentIconTabBar();return o;};k.prototype.removeItem=function(i){i=this.removeAggregation("items",i);if(i&&!(i instanceof d)){var s=i.getKey();this._aTabKeys.splice(this._aTabKeys.indexOf(s),1);}if(this.oSelectedItem===i){this.oSelectedItem=null;}this._invalidateParentIconTabBar();return i;};k.prototype.updateAggregation=function(){this.oSelectedItem=null;a.prototype.updateAggregation.apply(this,arguments);this.invalidate();};k.prototype.removeAggregation=function(A,o,s){var i=this.getTabFilters();var m=a.prototype.removeAggregation.apply(this,arguments);if(s){return m;}if(m&&m==this.oSelectedItem&&A=='items'){var n=(i?Array.prototype.indexOf.call(i,m):-1);i=this.getTabFilters();n=Math.max(0,Math.min(n,i.length-1));var S=i[n];if(S){this.setSelectedItem(S,true);}else{var p=this.getParent();if(this._isInsideIconTabBar()&&p.getExpanded()){p.$("content").children().remove();}}}return m;};k.prototype.removeAllAggregation=function(A,s){if(A=='items'){var i=this.getParent();if(this._isInsideIconTabBar()&&i.getExpanded()){i.$("content").children().remove();}}return a.prototype.removeAllAggregation.apply(this,arguments);};k.prototype._getDisplayText=function(i){var t=i.getText();if(this.isInlineMode()){var s=i.getCount();if(s){if(this._bRtl){t='('+s+') '+t;}else{t+=' ('+s+')';}}}return t;};k.prototype.isInlineMode=function(){return this._bTextOnly&&this.getMode()==h.Inline;};k.prototype._checkTextOnly=function(){this._bTextOnly=this.getItems().every(function(i){return i instanceof d||!i.getIcon();});return this._bTextOnly;};k.prototype._checkNoText=function(m){if(m.length>0){for(var i=0;i<m.length;i++){if(!(m[i]instanceof d)){if(m[i].getText().length>0){return false;}}}}return true;};k.prototype._checkInLine=function(m){var o;if(m.length>0){for(var i=0;i<m.length;i++){o=m[i];if(!(o instanceof d)){if(o.getIcon()||o.getCount()){this._bInLine=false;return false;}}}}this._bInLine=true;return true;};k.prototype._getItemsInStrip=function(){return this.getItems().filter(function(i){var o=i.getDomRef();return o&&!o.classList.contains("sapMITBFilterHidden");});};k.prototype._setItemsForStrip=function(){var t=this.getVisibleTabFilters();if(!C.isThemeApplied()||!t.length){return;}var T=this.getDomRef("head"),s=(this.oSelectedItem&&this.oSelectedItem.getVisible())?this.oSelectedItem:t[0];if(!T){return;}if(this._oPopover){this._oPopover.close();}var m=T.offsetWidth,o,i,S=(this._oSelectedRootItem||s).getDomRef(),n=this.getItems().filter(function(o){return o.getDomRef();}).map(function(o){return o.getDomRef();});if(!n.length||!S){return;}n.forEach(function(o){o.style.width="";o.classList.remove("sapMITBFilterHidden");});S.classList.remove("sapMITBFilterTruncated");var p=window.getComputedStyle(S);var u=S.offsetWidth+Number.parseInt(p.marginLeft)+Number.parseInt(p.marginRight);n.splice(n.indexOf(S),1);if(m<u){S.style.width=m-20+"px";S.classList.add("sapMITBFilterTruncated");for(i=0;i<n.length;i++){o=n[i];if(o){o.classList.add("sapMITBFilterHidden");}}return;}var v=-1;for(i=0;i<n.length;i++){o=n[i];var w=window.getComputedStyle(o);var x=o.offsetWidth+Number.parseInt(w.marginLeft)+Number.parseInt(w.marginRight);if(m>(u+x)){u+=x;v=i;}else{break;}}for(i=v+1;i<n.length;i++){o=n[i];o.classList.add("sapMITBFilterHidden");}this.$().toggleClass("sapMITHOverflowList",v+1!==n.length);};k.prototype._handleActivation=function(o){var t=o.target.id,i=o.srcControl,s,$=q(o.target);if(i instanceof B){return;}var m=q(document.getElementById(t));if(m.parents()&&Array.prototype.indexOf.call(m.parents(),this.$("content")[0])>-1){}else{if(t){o.preventDefault();if($.hasClass('sapMITBFilterIcon')||$.hasClass('sapMITBCount')||$.hasClass('sapMITBText')||$.hasClass('sapMITBTab')||$.hasClass('sapMITBContentArrow')||$.hasClass('sapMITBSep')||$.hasClass('sapMITBSepIcon')){s=o.srcControl.getId().replace(/-icon$/,"");i=C.byId(s);if(i.getMetadata().isInstanceOf("sap.m.IconTab")&&!(i instanceof d)){if(this._isUnselectable(i)){if(i.getItems().length){i._expandButtonPress();}return;}if(i===this._getOverflow()){i._expandButtonPress();return;}this.setSelectedItem(i);}}else if(i.getMetadata().isInstanceOf("sap.m.IconTab")&&!(i instanceof d)){if(this._isUnselectable(i)){if(i.getItems().length){i._expandButtonPress();}return;}if(i===this._getOverflow()){i._expandButtonPress();return;}this.setSelectedItem(i);}}else{if(i.getMetadata().isInstanceOf("sap.m.IconTab")&&!(i instanceof d)){if(this._isUnselectable(i)){if(i.getItems().length){i._expandButtonPress();}return;}if(i===this._getOverflow()){i._expandButtonPress();return;}this.setSelectedItem(i);}}}};k.prototype._fnResize=function(){if(this._getOverflow()._oPopover){this._getOverflow()._oPopover.close();}this._setItemsForStrip();this._initItemNavigation();};k.prototype._isUnselectable=function(i){var F=i._getRealTab();return!F.getEnabled()||(this._isInsideIconTabBar()&&!this.getParent().getContent().length&&F._getNestedLevel()===1&&F.getItems().length&&!F.getContent().length);};k.prototype._isInsideIconTabBar=function(){var p=this.getParent();return p instanceof a&&p.isA('sap.m.IconTabBar');};k.prototype._invalidateParentIconTabBar=function(){if(this._isInsideIconTabBar()){this.getParent().invalidate();}};k.prototype.getFocusDomRef=function(F){var t=F||this.oSelectedItem;if(!t){return null;}return t.getDomRef();};k.prototype.applyFocusInfo=function(F){if(F.focusDomRef){q(F.focusDomRef).focus();}};k.prototype._updateSelection=function(){var m=this.getItems(),s=this.getSelectedKey(),i=0,p=this.getParent(),n=this._isInsideIconTabBar(),o=p&&p.isA("sap.tnt.ToolHeader");if(m.length>0){if(!this.oSelectedItem||s&&s!==this.oSelectedItem._getNonEmptyKey()){if(s){for(;i<m.length;i++){if(!(m[i]instanceof d)&&m[i]._getNonEmptyKey()===s){this.oSelectedItem=m[i];break;}}}if(!this.oSelectedItem&&(n||!s)){for(i=0;i<m.length;i++){if(!(m[i]instanceof d)&&m[i].getVisible()){this.oSelectedItem=m[i];break;}}}}if(!o&&this.oSelectedItem&&!this.oSelectedItem.getVisible()){for(i=0;i<m.length;i++){if(!(m[i]instanceof d)&&m[i].getVisible()){this.oSelectedItem=m[i];break;}}}if(!this.oSelectedItem){return;}if(this._isUnselectable(this.oSelectedItem)){this.setSelectedItem(this.oSelectedItem._getFirstAvailableSubFilter(),true);return;}this.setProperty("selectedKey",this.oSelectedItem._getNonEmptyKey(),true);}};k.prototype.ontouchstart=function(o){var t=o.targetTouches[0];this._iActiveTouch=t.identifier;};k.prototype.ontouchend=function(o){if(this._iActiveTouch===undefined){return;}var M=0;var i=1;var m;if(o.which===m||o.which===M||o.which===i){this._handleActivation(o);}this._iActiveTouch=undefined;};k.prototype.ontouchcancel=k.prototype.ontouchend;k.prototype.onkeydown=function(o){switch(o.which){case K.ENTER:this._handleActivation(o);o.preventDefault();break;case K.SPACE:this._handleActivation(o);o.preventDefault();break;}};k.prototype._handleDragAndDrop=function(o){var D=o.getParameter("dropPosition"),i=o.getParameter("draggedControl"),m=o.getParameter("droppedControl");e.handleDrop(this,D,i._getRealTab(),m,false);this._setItemsForStrip();this._initItemNavigation();this._getSelectList()._initItemNavigation();i._getRealTab().$().focus();};k.prototype._moveTab=function(t,i){e.moveItem.call(this,t,i);this._setItemsForStrip();this._initItemNavigation();};k.prototype.ondragrearranging=function(o){if(!this.getEnableTabReordering()){return;}var t=o.srcControl;this._moveTab(t,o.keyCode);t.$().focus();};k.prototype.onsaphomemodifiers=k.prototype.ondragrearranging;k.prototype.onsapendmodifiers=k.prototype.ondragrearranging;k.prototype.onsapincreasemodifiers=k.prototype.ondragrearranging;k.prototype.onsapdecreasemodifiers=k.prototype.ondragrearranging;return k;});
