/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/library","sap/ui/core/Core","sap/ui/core/Item","sap/ui/core/Renderer","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/Control",'sap/ui/Device',"./AccButton","sap/m/Button","sap/m/ResponsivePopover","sap/m/IconTabBarSelectList"],function(l,c,C,I,R,a,b,d,D,A,B,e,f){"use strict";var T=c.TextAlign;var g=c.TextDirection;var h=l.ButtonType;var P=l.PlacementType;var j=l.ImageHelper;var k=l.IconTabFilterDesign;var m=c.IconColor;var n=I.extend("sap.m.IconTabFilter",{metadata:{interfaces:["sap.m.IconTab","sap.ui.core.PopupInterface"],library:"sap.m",designtime:"sap/m/designtime/IconTabFilter.designtime",properties:{count:{type:"string",group:"Data",defaultValue:''},showAll:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:''},iconColor:{type:"sap.ui.core.IconColor",group:"Appearance",defaultValue:m.Default},iconDensityAware:{type:"boolean",group:"Appearance",defaultValue:true},visible:{type:"boolean",group:"Behavior",defaultValue:true},design:{type:"sap.m.IconTabFilterDesign",group:"Appearance",defaultValue:k.Vertical}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},items:{type:"sap.m.IconTabFilter",multiple:true,singularName:"item"},_expandButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"}}}});var r=C.getLibraryResourceBundle("sap.m");n._aAllIconColors=['sapMITBFilterCritical','sapMITBFilterPositive','sapMITBFilterNegative','sapMITBFilterDefault','sapMITBFilterNeutral'];n.prototype._getImageControl=function(i,p,o){var q={src:this.getIcon(),densityAware:this.getIconDensityAware(),useIconTooltip:false};if(q.src){this._oImageControl=j.getImageControl(this.getId()+"-icon",this._oImageControl,p,q,i,o);}else if(this._oImageControl){this._oImageControl.destroy();this._oImageControl=null;}return this._oImageControl;};n.prototype.exit=function(E){if(this._oImageControl){this._oImageControl.destroy();}if(I.prototype.exit){I.prototype.exit.call(this,E);}if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null;}if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};n.prototype.invalidate=function(){var i=this.getParent(),o,O;if(!i){return;}o=i.getParent();if(!(o instanceof sap.m.IconTabBar)){i.invalidate();return;}O=o.getParent();if(O instanceof sap.m.ObjectHeader){O.invalidate();}else{o.invalidate();}};n.prototype.setProperty=function(p,v,s){switch(p){case'enabled':case'textDirection':case'text':case'count':case'showAll':case'icon':case'iconColor':case'iconDensityAware':case'design':if(this.getProperty(p)===v){return this;}d.prototype.setProperty.call(this,p,v,true);if(!s){var i=this.getParent();if(i instanceof sap.m.IconTabHeader){i.invalidate();}}break;default:d.prototype.setProperty.apply(this,arguments);break;}return this;};n.prototype._getNonEmptyKey=function(){var K=this.getKey();if(K){return K;}return this.getId();};n.prototype._getRealTab=function(){return this._oTabFilter||this;};n.prototype._getRootTab=function(){var t=this._getRealTab(),p=t.getParent();while(p&&p.isA("sap.m.IconTabFilter")){t=p;p=p.getParent();}return t;};n.prototype._getNestedLevel=function(){var p=this._getRealTab().getParent(),L;for(L=1;p&&p.isA("sap.m.IconTabFilter");L++){p=p.getParent();}return L;};n.prototype.render=function(o,v,V){if(!this.getVisible()){return;}var i=this.getParent(),p=i.getParent(),H=i._isInsideIconTabBar(),q=C.getLibraryResourceBundle("sap.m"),s={role:"tab"},t=this.getId(),u=this.getCount(),w=this.getText(),x=this.getIcon(),y=this.getIconColor(),S=y==='Positive'||y==='Critical'||y==='Negative',z=this.getDesign()===k.Horizontal,E=i._bTextOnly,F=i._bInLine||i.isInlineMode();if(H){s.controls=p.getId()+"-content";}if(this._getAllSubFilters().length){s.roledescription=q.getText("ICONTABFILTER_SPLIT_TAB");}if(w.length||u!==""||x){var G=[];if(u!==""){G.push(t+"-count");}if(w.length){G.push(t+"-text");}if(x){G.push(t+"-icon");}if(S){G.push(t+"-iconColor");}s.labelledby=G.join(" ");}if(v!==undefined&&V!==undefined){Object.assign(s,{posinset:v+1,setsize:V});}o.openStart("div",this).accessibilityState(s).class("sapMITBItem");if(!u){o.class("sapMITBItemNoCount");}if(z){o.class("sapMITBHorizontal");}else{o.class("sapMITBVertical");}if(this.getShowAll()){o.class("sapMITBAll");}else{o.class("sapMITBFilter").class("sapMITBFilter"+y);}if(i._isUnselectable(this)){o.class("sapMITHUnselectable");}if(!this.getEnabled()){o.class("sapMITBDisabled").attr("aria-disabled",true);}o.attr("aria-selected",false);var J=this.getTooltip_AsString();if(J){o.attr("title",J);}if(this._bIsOverflow||this.getItems().length){o.attr("aria-haspopup","menu");}o.openEnd();o.openStart("div").class("sapMITBFilterWrapper").openEnd();if(!F){o.openStart("div",t+"-tab").class("sapMITBTab").openEnd();if(!this.getShowAll()||!x){if(S){o.openStart("div",t+"-iconColor").style("display","none").openEnd().text(q.getText('ICONTABBAR_ICONCOLOR_'+y.toUpperCase())).close("div");}o.renderControl(this._getImageControl(['sapMITBFilterIcon','sapMITBFilter'+y],i,n._aAllIconColors));}if(!this.getShowAll()&&!x&&!E){o.openStart("span").class("sapMITBFilterNoIcon").openEnd().close("span");}if(z&&!this.getShowAll()){o.close("div");o.openStart("div").class("sapMITBHorizontalWrapper").openEnd();}o.openStart("span",t+"-count").class("sapMITBCount").openEnd();if(u===""&&z){o.unsafeHtml("&nbsp;");}else{o.text(u);}o.close("span");if(!z){o.close("div");}}if(w.length){o.openStart("div",t+"-text").class("sapMITBText");if(H&&p.getUpperCase()){o.class("sapMITBTextUpperCase");}if(F){o.attr("dir","ltr");}o.openEnd().text(i._getDisplayText(this)).close("div");}if(!F&&z){o.close("div");}o.openStart("div").class("sapMITBContentArrow").openEnd().close("div");o.close("div");if(this._bIsOverflow||this.getItems().length>0){o.openStart("span").accessibilityState({role:"separator"}).openEnd().close("span");o.renderControl(this._getExpandButton());}o.close("div");};n.prototype.renderInSelectList=function(o,s,i,S,p){if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null;}if(!this.getVisible()){return;}var t=true,q=s._bIconOnly,u=s._oIconTabHeader,v=C.getLibraryResourceBundle('sap.m');if(u){t=u._bTextOnly;}o.openStart("li",this).attr("tabindex","-1").attr("role","menuitem");if(p){o.style("padding-left",p+"rem");}if(i!==undefined&&S!==undefined){o.attr("aria-posinset",i+1);o.attr("aria-setsize",S);o.attr("aria-level",this._getNestedLevel());}var w=this.getTooltip_AsString();if(w){o.attr("title",w);}if(u._isUnselectable(this)){o.class("sapMITHUnselectable");}if(!this.getEnabled()){o.class("sapMITBDisabled").attr("aria-disabled",true);}o.class("sapMITBSelectItem");if(s.getSelectedItem()==this){o.class("sapMITBSelectItemSelected");o.attr("aria-selected",true);}var x=this.getIconColor();o.class("sapMITBFilter"+x);var y=this.getId(),z=x=='Positive'||x=='Critical'||x=='Negative',L=[];if(!q){L.push(y+"-text");}if(!t&&this.getIcon()){L.push(y+"-icon");}if(z){this._invisibleText=new b({text:v.getText('ICONTABBAR_ICONCOLOR_'+x.toUpperCase())});L.push(this._invisibleText.getId());}o.accessibilityState({labelledby:L.join(" ")}).openEnd();if(this._invisibleText){o.renderControl(this._invisibleText);}if(!t){this._renderIcon(o);}if(!q){this._renderText(o);}o.close("li");};n.prototype._renderIcon=function(o){var i=this.getIcon();if(i){var p=a.getIconInfo(i),q=["sapMITBSelectItemIcon"];if(p&&!p.suppressMirroring){q.push("sapUiIconMirrorInRTL");}o.icon(i,q,{id:this.getId()+"-icon","aria-hidden":true});}else{o.openStart("span").class("sapUiIcon").openEnd().close("span");}};n.prototype._renderText=function(o){var t=this.getText(),s=this.getCount(),i=C.getConfiguration().getRTL(),p=this.getTextDirection();o.openStart("span",this.getId()+"-text").attr("dir","ltr").class("sapMText").class("sapMTextNoWrap").class("sapMITBText");if(p!==g.Inherit){o.attr('dir',p.toLowerCase());}var q=R.getTextAlign(T.Begin,p);if(q){o.style("text-align",q);}if(s){if(i){t='('+s+') '+t;}else{t+=' ('+s+')';}}o.openEnd().text(t).close("span");};n.prototype._getSelectList=function(){if(!this._oSelectList){this._oSelectList=new f({selectionChange:function(E){var t=E.getParameter("selectedItem");this._oIconTabHeader.setSelectedItem(t._getRealTab());this._oTabFilter._closeOverflow();}});this._oSelectList._oIconTabHeader=this.getParent();this._oSelectList._oTabFilter=this;}return this._oSelectList;};n.prototype._getExpandButton=function(){var o=this.getAggregation("_expandButton");if(!o){o=new A(this.getId()+"-expandButton",{type:h.Transparent,icon:a.getIconURI("slim-arrow-down"),tooltip:C.getLibraryResourceBundle("sap.m").getText("ICONTABHEADER_OVERFLOW_MORE"),tabIndex:"-1",press:this._expandButtonPress.bind(this)}).addStyleClass("sapMITBFilterExpandBtn");this.setAggregation("_expandButton",o);}return o;};n.prototype._expandButtonPress=function(){this.$().focus();if(!this._oPopover){this._oPopover=new e({showArrow:false,showHeader:false,offsetY:0,offsetX:0,placement:P.VerticalPreferredBottom}).addStyleClass("sapMITBFilterPopover");this._oPopover.attachBeforeClose(function(){this._getSelectList().destroyItems();},this);if(D.system.phone){this._oPopover._oControl.addButton(this._createPopoverCloseButton());}this.addDependent(this._oPopover);this._oPopover._oControl._adaptPositionParams=function(){var i=this.$().parents().hasClass("sapUiSizeCompact");this._arrowOffset=0;if(i){this._offsets=["0 0","0 0","0 4","0 0"];}else{this._offsets=["0 0","0 0","0 5","0 0"];}this._atPositions=["end top","end top","end bottom","begin top"];this._myPositions=["end bottom","begin top","end top","end top"];};}var H=this._setSelectListItems();var s=this._getSelectList();this._oPopover.removeAllContent();this._oPopover.addContent(s).setInitialFocus(H?s.getSelectedItem():s.getItems()[0]).openBy(this._getExpandButton());};n.prototype._getAllSubFilters=function(){var i=[];this._getRealTab().getItems().forEach(function(o){i=i.concat(o,o._getAllSubFilters());});return i;};n.prototype._getAllSubFiltersDomRefs=function(){return this._getAllSubFilters().filter(function(s){return Boolean(s._getRealTab().getDomRef());}).map(function(s){return s._getRealTab().getDomRef();});};n.prototype._getFirstAvailableSubFilter=function(){var o=this._getAllSubFilters();for(var i=0;i<o.length;i++){var p=o[i];if(p.getContent().length&&p.getVisible()){return p;}}return this;};n.prototype._isParentOf=function(o){var p=this._getAllSubFilters();for(var i=0;i<p.length;i++){if(p[i]._getRealTab()===o){return true;}}return false;};n.prototype._createPopoverCloseButton=function(){return new B({text:r.getText("SELECT_CANCEL_BUTTON"),press:this._closeOverflow.bind(this)});};n.prototype._closeOverflow=function(){if(this._oPopover){this._oPopover.close();this._oPopover.removeAllContent();}if(this._bIsOverflow&&this.getParent().oSelectedItem){(this.getParent()._oSelectedRootItem||this.getParent().oSelectedItem).$().focus();}};n.prototype._setSelectListItems=function(){var o=this.getParent(),s=this._getSelectList(),t=this.getItems(),p=o.oSelectedItem,H=false,q;if(this._bIsOverflow){t=o.getTabFilters();q=o._getItemsInStrip();}s.destroyItems();s.setSelectedItem(null);for(var i=0;i<t.length;i++){var u=t[i];if(this._bIsOverflow&&!D.system.phone&&q.indexOf(u)>-1){continue;}var L=u.clone(undefined,undefined,{cloneChildren:false,cloneBindings:true});L._oTabFilter=u;s.addItem(L);if(L._getRealTab()===p){s.setSelectedItem(L);H=true;continue;}if(L._getRealTab()._isParentOf(p)){s.setSelectedItem(p._getRealTab());H=true;}}return H;};n.prototype.onsapdown=function(E){if(this._bIsOverflow||((this._getNestedLevel()===1&&this._getRealTab()===this)&&this._getRealTab().getItems().length!==0)){E.stopImmediatePropagation();this._expandButtonPress();}};return n;});
