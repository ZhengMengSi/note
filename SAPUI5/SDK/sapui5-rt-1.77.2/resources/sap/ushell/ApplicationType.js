// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/base/Log","sap/ushell/utils","sap/ushell/URLTemplateProcessor","sap/ushell/_ApplicationType/utils","sap/ushell/_ApplicationType/systemAlias","sap/ushell/_ApplicationType/wdaResolution","sap/ushell/_ApplicationType/guiResolution","sap/ushell/services/_ClientSideTargetResolution/ParameterMapping","sap/ushell/Config"],function(U,L,u,a,A,s,w,g,p,C){"use strict";function b(x,B,E){var I=x.inbound;var R=I&&I.resolutionResult;if(!(!I||!R||!(R["sap.wda"]))){return w.constructFullWDAResolutionResult(x,B,E);}if(!(!I||!R)){return w.constructWDAResolutionResult(x,B,E);}}function c(x,B,E){var y=new U(B),I=x.inbound,z=I&&I.resolutionResult,D=jQuery.extend(true,{},x.mappedIntentParamsPlusSimpleDefaults),S,F;if(D["sap-system"]){S=D["sap-system"][0];delete D["sap-system"];}if(D["sap-system-src"]){F=D["sap-system-src"][0];delete D["sap-system-src"];}return new Promise(function(R,G){s.spliceSapSystemIntoURI(y,z.systemAlias,S,F,"WCF",z.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).done(function(H){var P=A.getURLParsing().paramsToString(D),J=A.appendParametersToUrl(P,H.toString());var K={url:J,text:z.text||"",additionalInformation:z.additionalInformation||"",applicationType:"WCF",fullWidth:true};R(K);}).fail(function(H){G(H);});});}function d(x,B,E){var I=x.inbound,y,S,z,D,R={};["applicationType","additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){R[P]=I.resolutionResult[P];}});R.url=B;if(R.applicationDependencies&&typeof R.url==="undefined"){R.url="";}if(typeof R.url==="undefined"){return Promise.reject("Cannot resolve intent: url was not specified in matched inbound");}D=jQuery.extend(true,{},x.mappedIntentParamsPlusSimpleDefaults);R.reservedParameters={};var F={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true,"sap-ui-fl-version":true};Object.keys(F).forEach(function(N){var V=D[N];if(V){delete D[N];R.reservedParameters[N]=V;}});x.mappedDefaultedParamNames=x.mappedDefaultedParamNames.filter(function(G){return!F[G];});if(x.mappedDefaultedParamNames.length>0){D["sap-ushell-defaultedParameterNames"]=[JSON.stringify(x.mappedDefaultedParamNames)];}S=D["sap-system"]&&D["sap-system"][0];z=D["sap-system-src"]&&D["sap-system-src"][0];R["sap-system"]=S;if(typeof z==="string"){R["sap-system-src"]=z;}x.effectiveParameters=D;y=A.getURLParsing().paramsToString(D);if(y){R.url=R.url+((R.url.indexOf("?")<0)?"?":"&")+y;}if(typeof I.resolutionResult.ui5ComponentName!=="undefined"){R.ui5ComponentName=I.resolutionResult.ui5ComponentName;}R.text=I.title;return Promise.resolve(R);}function e(){var H=new U().fragment();var x=H.lastIndexOf("&/");if(x>0){return H.substr(x+1);}}function f(){var x=sap.ushell.Container.getService("UserInfo");var y=x.getUser();var z=sap.ui.getCore().getConfiguration();var B=u.getUi5Version();var D=y.getContentDensity();var T=y.getTheme();if(T.indexOf("sap_")!==0){var E=sap.ushell.User.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;T=y.getTheme(E);}var F;var G;if(z){G=z.getLanguage&&z.getLanguage();F=z.getSAPLogonLanguage&&z.getSAPLogonLanguage();}var H=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";return{language:G,logonLanguage:F,theme:T,themeServiceRoot:H,isDebugMode:!!window["sap-ui-debug"],ui5Version:B,contentDensity:D,sapPlugins:h()};}function h(){var S=sap.ushell.Container.getService("PluginManager");if(S){return S._getNamesOfPluginsWithAgents();}else{return"";}}function i(x,B,E){var I=x.inbound;var T=I.templateContext;var R={innerAppRoute:e()||x.parsedIntent.appSpecificRoute,targetNavMode:x.targetNavigationMode,defaultParameterNames:x.mappedDefaultedParamNames,startupParameter:x.mappedIntentParamsPlusSimpleDefaults,env:f()};var y=a.expand(T.payload,T.site,R,T.siteAppSection,"startupParameter");var z={applicationType:"URL",text:I.title,appCapabilities:j(T.payload.capabilities||{},T.siteAppSection),url:y,extendedInfo:m(x,y)};return n(y).then(function(D){z.url=D;return z;},function(){return z;});}function j(T,S){var x=u.clone(T);x.navigationMode=k(T.navigationMode,S);return x;}function k(T,S){var x=l(T);var y=u.getMember(S,"sap|integration.navMode");switch(y){case"inplace":return"embedded";case"explace":if(x==="embedded"){return"newWindowThenEmbedded";}if(["newWindowThenEmbedded","newWindow"].indexOf(x)>=0){return x;}L.error("App-defined navigation mode was ignored","Application requests to be opened in a new window but no expected navigation mode was defined on the template","sap.ushell.ApplicationType");default:return x;}}function l(x){var I;switch(x){case"inplace":I="embedded";break;case"explace":I="newWindow";break;default:I=x||"newWindow";}return I;}function m(x){var I={};I.appParams={};if(x.mappedIntentParamsPlusSimpleDefaults){I.appParams=JSON.parse(JSON.stringify(x.mappedIntentParamsPlusSimpleDefaults));}return I;}function n(x){return new Promise(function(R,y){var z=new U(x);var P=z.query(true);sap.ushell.Container.getService("ShellNavigation").compactParams(P,["sap-language","sap-theme","sap-ui-app-id","transaction"],undefined,true).done(function(B){if(!B.hasOwnProperty("sap-intent-param")){R(x);return;}z.query(B);var D=z.toString();R(D);}).fail(function(E){y(E);});});}function o(x,B,E){var I=x.inbound,y=I&&I.resolutionResult,R={};var z=new U(B);var D=jQuery.extend(true,{},x.mappedIntentParamsPlusSimpleDefaults);if(x.inbound&&x.inbound.action==="launchURL"&&x.inbound.semanticObject==="Shell"){delete D["sap-external-url"];}var S=D["sap-system"]&&D["sap-system"][0];var F=D["sap-system-src"]&&D["sap-system-src"][0];R["sap-system"]=S;delete D["sap-system"];if(typeof F==="string"){R["sap-system-src"]=F;delete D["sap-system-src"];}return(new Promise(function(G,H){if(A.absoluteUrlDefinedByUser(z,y.systemAlias,y.systemAliasSemantics)){G(B);}else{s.spliceSapSystemIntoURI(z,y.systemAlias,S,F,"URL",y.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).fail(H).done(function(J){var K=J.toString();G(K);});}})).then(function(G){var P=A.getURLParsing().paramsToString(D);var H=C.last("/core/navigation/flpURLDetectionPattern");var J=new RegExp(H);return J.test(G)?A.appendParametersToIntentURL(D,G):A.appendParametersToUrl(P,G);},Promise.reject.bind(Promise)).then(function(G){["additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){R[P]=I.resolutionResult[P];}});R.url=G;R.text=I.title;R.applicationType="URL";return Promise.resolve(R);},Promise.reject.bind(Promise));}var q={URL:{type:"URL",defaultFullWidthSetting:true,generateResolutionResult:function(x){var y=x.inbound.hasOwnProperty("templateContext");return y?i.apply(null,arguments):o.apply(null,arguments);},easyAccessMenu:{intent:"Shell-startURL",resolver:null,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:false,systemSelectionPriority:1}},WDA:{type:"WDA",defaultFullWidthSetting:true,generateResolutionResult:b,easyAccessMenu:{intent:"Shell-startWDA",resolver:w.resolveEasyAccessMenuIntentWDA,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:2}},TR:{type:"TR",defaultFullWidthSetting:true,generateResolutionResult:g.generateTRResolutionResult,easyAccessMenu:{intent:"Shell-startGUI",resolver:g.resolveEasyAccessMenuIntentWebgui,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:3}},NWBC:{type:"NWBC",defaultFullWidthSetting:true},WCF:{type:"WCF",generateResolutionResult:c,defaultFullWidthSetting:true},SAPUI5:{type:"SAPUI5",generateResolutionResult:d,defaultFullWidthSetting:false}};function r(){return Object.keys(q).map(function(x){return q[x];}).filter(function(x){return typeof x.easyAccessMenu==="object";});}function t(){var E={};r().forEach(function(x){E[x.easyAccessMenu.intent]=x.easyAccessMenu.resolver;});return function(x,R){if(E[x]&&(!R||R!=="SAPUI5")){return E[x];}return null;};}function v(x){if(!q[x]){return false;}return q[x].defaultFullWidthSetting;}Object.defineProperty(q,"enum",{value:Object.keys(q).reduce(function(x,y){if(q[y].type){x[y]=q[y].type;}return x;},{})});var M={getEasyAccessMenuResolver:t(),getEasyAccessMenuDefinitions:r,getDefaultFullWidthSetting:v};Object.keys(M).forEach(function(x){Object.defineProperty(q,x,{value:M[x]});});return q;});
