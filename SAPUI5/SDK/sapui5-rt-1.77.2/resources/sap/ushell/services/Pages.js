// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/utils/RestrictedJSONModel","sap/base/util/deepClone","sap/ushell/resources","sap/ushell/utils","sap/ushell/Config"],function(L,r,R,d,a,u,C){"use strict";var P=function(){this.COMPONENT_NAME="sap/ushell/services/Pages";this._oCdmServicePromise=sap.ushell.Container.getServiceAsync("CommonDataModel");this._oVisualizationLoadingServicePromise=sap.ushell.Container.getServiceAsync("VisualizationLoading");this._oPagesModel=new R({pages:[]});};P.prototype._generateId=function(p){var i=[];var o=this.getModel().getProperty(this.getPagePath(p));o.sections.forEach(function(s){i.push(s.id);s.visualizations.forEach(function(v){i.push(v.id);});});return u.generateUniqueId(i);};P.prototype.getModel=function(){return this._oPagesModel;};P.prototype.getPageIndex=function(p){var b=this._oPagesModel.getProperty("/pages");for(var i=0;i<b.length;++i){if(b[i].id===p){return i;}}return undefined;};P.prototype.getPagePath=function(p){var i=this.getPageIndex(p);if(typeof i==="undefined"){return"";}return"/pages/"+i;};P.prototype.loadPage=function(p){var s=this.getPagePath(p);if(s){return Promise.resolve(s);}return Promise.all([this._oCdmServicePromise,this._oVisualizationLoadingServicePromise]).catch(function(e){L.error("Pages - loadPage: Couldn't resolve CDM Service or Visualization Loading Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(S){var c=S[0];var v=S[1];return Promise.all([c.getPage(p),c.getVisualizations(),c.getApplications(),v.loadVisualizationData()]).then(function(b){var o=b[0];var V=b[1];var A=b[2];var i=this._oPagesModel.getProperty("/pages/").length;var n="/pages/"+i;this._oPagesModel._setProperty(n,this._getModelForPage(o,V,A));return n;}.bind(this)).catch(function(e){L.error("Pages - loadPage: Failed to gather site data.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));}.bind(this));};P.prototype.findVisualization=function(p,s,v){return this._oCdmServicePromise.catch(function(e){L.error("Pages - findVisualization: Personalization cannot be saved: CDM Service cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){return Promise.all([this.loadPage(p),c.getVisualizations(),c.getApplications()]).then(function(b){var e=b[0];var f=this.getModel().getProperty(e+"/sections")||[];return f.reduce(function(g,h,i){if(s&&h.id!==s){return g;}var V=h.visualizations.reduce(function(j,k,l){if(k.vizId===v){j.push(l);}return j;},[]);if(V.length){g.push({pageId:p,sectionIndex:i,vizIndexes:V});}return g;},[]);}.bind(this)).catch(function(e){L.error("Pages - findVisualization: Couldn't load page, get visualizations or applications.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));}.bind(this));};P.prototype.moveVisualization=function(p,s,S,t,T){if(s===t&&S===T){return Promise.resolve();}this.setPersonalizationActive(true);var o=this._oPagesModel.getProperty("/pages/"+p);var b=o.id;var c=o.sections[s];var e=o.sections[t];var f=c.id;var g=e.id;var m=c.visualizations[S];var M=m.id;c.visualizations.splice(S,1);if(T===-1){T=e.visualizations.length;}else if(s===t&&S<T){T--;}e.visualizations.splice(T,0,m);if(c.default&&!c.visualizations.length){o.sections.splice(s,1);}this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(h){return h.getPage(b);}).catch(function(E){L.error("Pages - moveVisualization: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(h){var i=h.payload.sections[f];var j=i.layout.vizOrder;var k=i.viz;var l=h.payload.sections[g];var n=l.layout.vizOrder;var q=l.viz;var v=d(k[M]);j.splice(j.indexOf(M),1);n.splice(T,0,M);if(f!==g){delete k[M];q[M]=v;}if(i.default&&!Object.keys(k).length){delete h.payload.sections[f];h.payload.layout.sectionOrder.splice(s,1);}return this.savePersonalization(b);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.deleteVisualization=function(p,s,S){var o=this._oPagesModel.getProperty("/pages/"+p);var b=o.sections[s];if(b.default&&b.visualizations.length<2){return this.deleteSection(p,s);}this.setPersonalizationActive(true);var c=b.visualizations;var e=c[S];c.splice(S,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(f){return f.getPage(o.id);}).catch(function(E){L.error("Pages - deleteVisualization: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(f){var g=f.payload.sections[b.id].layout.vizOrder;var v=f.payload.sections[b.id].viz;Object.keys(v).forEach(function(V){if(v[V].vizId===e.vizId){delete v[V];g.splice(S,1);}});return this.savePersonalization(f.identification.id);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype._getSectionIndex=function(p,s){var S=this.getModel().getProperty(p+"/sections")||[],i=0;for(;i<S.length;i+=1){if(S[i].id===s){return i;}}};P.prototype._getVisualizationData=function(p,v,V,A,m){var o=A||{vizId:v};var s={applications:m,visualizations:V};var b=r.getVizData(s,o);if(!b.id){b.id=this._generateId(p);}return b;};P.prototype.addVisualization=function(p,s,v){return this._oCdmServicePromise.catch(function(e){L.error("Pages - addVisualization: Personalization cannot be saved: CDM Service cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){return Promise.all([this.loadPage(p),c.getVisualizations(),c.getApplications()]).catch(function(e){L.error("Pages - addVisualization: Personalization cannot be saved: Failed to load page, get visualizations or get applications.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(b){var e=b[0],S=this._getSectionIndex(e,s),f=this.getModel().getProperty(e+"/sections")||[],V=this._getVisualizationData(p,v,b[1],null,b[2]);var D;for(var i=0;i<f.length;i++){if(f[i].default){D=i;}}if(S!==undefined||D!==undefined){this.setPersonalizationActive(true);var g=S!==undefined?S:D||0,h=e+"/sections/"+g+"/visualizations";this.getModel().getProperty(h).push(V);this.getModel().refresh();return c.getPage(p).catch(function(E){L.error("Pages - addVisualization: Personalization cannot be saved: Failed to get page.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){var k=o.payload.sections[s||o.payload.layout.sectionOrder[0]];k.layout.vizOrder.push(V.id);k.viz[V.id]={id:V.id,vizId:v};return this.savePersonalization(p);}.bind(this));}var j=parseInt(e.split("/")[2],10);return this.addSection(j,0,{title:a.i18n.getText("DefaultSection.Title"),default:true,visualizations:[V]});}.bind(this));}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.moveSection=function(p,s,t){if(s===t){return Promise.resolve();}this.setPersonalizationActive(true);var b=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var m=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);var M=m.id;S.splice(s,1);if(s<t){t--;}S.splice(t,0,m);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(c){return c.getPage(b);}).catch(function(e){L.error("Pages - moveSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(o){var c=o.payload.layout.sectionOrder;c.splice(c.indexOf(M),1);c.splice(t,0,M);return this.savePersonalization(b);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.addSection=function(p,s,S){this.setPersonalizationActive(true);var o=S||{},b=this._oPagesModel.getProperty("/pages/"+p+"/sections"),c=this._oPagesModel.getProperty("/pages/"+p+"/id");var n={id:o.id!==undefined?o.id:this._generateId(c),title:o.title!==undefined?o.title:"",visible:o.visible!==undefined?o.visible:true,preset:o.preset!==undefined?o.preset:false,locked:o.locked!==undefined?o.locked:false,default:o.default!==undefined?o.default:false,visualizations:o.visualizations!==undefined?o.visualizations:[]};b.splice(s,0,n);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(e){return e.getPage(c);}).catch(function(e){L.error("Pages - addSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(e){var f={id:n.id,title:n.title,visible:n.visible,preset:n.preset,locked:n.locked,default:n.default,layout:{vizOrder:[]},viz:{}};if(n.visualizations){var i=0,v;for(;i<n.visualizations.length;i++){v=n.visualizations[i];f.layout.vizOrder.push(v.id);if(v.isBookmark){f.viz[v.id]=v;}else{f.viz[v.id]={id:v.id,vizId:v.vizId};}}}e.payload.layout.sectionOrder.splice(s,0,n.id);e.payload.sections[n.id]=f;return this.savePersonalization(c);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.deleteSection=function(p,s){this.setPersonalizationActive(true);var b=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var c=S[s].id;S.splice(s,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(o){return o.getPage(b);}).catch(function(e){L.error("Pages - deleteSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(o){delete o.payload.sections[c];o.payload.layout.sectionOrder.splice(s,1);return this.savePersonalization(b);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.setSectionVisibility=function(p,s,v){this.setPersonalizationActive(true);var b=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");var o=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);if(o.visible===v){return Promise.resolve();}o.visible=v;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(c){return c.getPage(b);}).catch(function(e){L.error("Pages - setSectionVisibility: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){c.payload.sections[S].visible=v;return this.savePersonalization(b);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.renameSection=function(p,s,n){this.setPersonalizationActive(true);var o=this._oPagesModel.getProperty("/pages/"+p);var S=o.sections[s];S.title=n;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(c){return c.getPage(o.id);}).catch(function(e){L.error("Pages - renameSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(b){b.payload.sections[S.id].title=n;return this.savePersonalization(b.identification.id);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.resetSection=function(p,s){this.setPersonalizationActive(true);var b=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");return this._oCdmServicePromise.then(function(c){return Promise.all([c.getVisualizations(),c.getApplications(),c.getPage(b),c.getOriginalPage(b)]);}).catch(function(e){L.error("Pages - resetSection: Personalization cannot be saved: Failed to gather data from CDM Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){var v=c[0];var A=c[1];var o=c[2];var O=c[3];var e=this._getModelForPage(O,v,A);var f=d(e.sections.find(function(i){return i.id===S;}));var g=f.visualizations.map(function(V){return V.id;});var h=this._oPagesModel.getProperty("/pages/"+p);h.sections.forEach(function(i){if(f.id!==i.id){i.visualizations.forEach(function(V){if(g.indexOf(V.id)!==-1){var n=this._generateId(b);var j=d(o.payload.sections[i.id].viz[V.id]);delete o.payload.sections[i.id].viz[V.id];var k=o.payload.sections[i.id].layout.vizOrder.indexOf(j.id);j.id=n;o.payload.sections[i.id].viz[n]=j;o.payload.sections[i.id].layout.vizOrder[k]=n;V.id=n;}}.bind(this));}}.bind(this));this._oPagesModel._setProperty("/pages/"+p+"/sections/"+s,f);o.payload.sections[f.id]=O.payload.sections[f.id];return this.savePersonalization(o.identification.id);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.resetPage=function(p){this.setPersonalizationActive(true);var s=this._oPagesModel.getProperty("/pages/"+p+"/id");return this._oCdmServicePromise.then(function(c){return Promise.all([c.getVisualizations(),c.getApplications(),c.getPage(s),c.getOriginalPage(s)]);}).catch(function(e){L.error("Pages - resetPage: Personalization cannot be saved: Failed to gather data from CDM Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(S){var v=S[0];var A=S[1];var c=S[2];var o=S[3];var O=this._getModelForPage(o,v,A);this._oPagesModel._setProperty("/pages/"+p,O);c.payload=d(o.payload);return this.savePersonalization(c.identification.id);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.setPersonalizationActive=function(s){if(!this._bDirtyState&&s===true){this._bDirtyState=true;this._oCopiedModelData=d(this._oPagesModel.getProperty("/"));}else if(this._bDirtyState&&s===false){this._oPagesModel._setData(this._oCopiedModelData);this._bDirtyState=false;}};P.prototype.savePersonalization=function(p){return this._oCdmServicePromise.then(function(c){return c.save(p);}).then(function(){this._bDirtyState=false;}.bind(this)).catch(function(e){L.error("Pages - savePersonalization: Personalization cannot be saved: CDM Service cannot be retrieved or the save process encountered an error.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));};P.prototype._getModelForPage=function(p,v,b){var o={id:p.identification.id||"",title:p.identification.title||"",description:"",sections:[]};var e=C.last("/core/catalog/enableHideGroups");p.payload.layout.sectionOrder.forEach(function(s){var c=p.payload.sections[s];var S={id:c.id||"",title:c.title||"",visualizations:[],visible:!e||(c.visible!==undefined?c.visible:true),locked:c.locked!==undefined?c.locked:false,preset:c.preset!==undefined?c.preset:true,default:c.default!==undefined?c.default:false};c.layout.vizOrder.forEach(function(i){var V=c.viz[i],f=V.vizId,g=V.isBookmark?V:this._getVisualizationData(p.identification.id,f,v,V,b);S.visualizations.push(g);}.bind(this));o.sections.push(S);}.bind(this));return o;};P.prototype.addBookmarkToPage=function(p,b){if(!p){return Promise.reject("Pages - addBookmarkToPage: Adding bookmark tile failed: No page id is provided.");}this.setPersonalizationActive(true);return this.loadPage(p).catch(function(e){L.error("Pages - addBookmarkToPage: Personalization cannot be saved: Could not load page.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){var v=b;v.isBookmark=true;v.id=this._generateId(p);var i=parseInt(/pages\/(\d+)/.exec(c)[1],10);var o=this._oPagesModel.getProperty(c);var D=o.sections.find(function(s){return s.default;});if(!D){return this.addSection(i,0,{title:a.i18n.getText("DefaultSection.Title"),default:true,visualizations:[v]});}D.visualizations.push(v);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(e){return e.getPage(p);}).catch(function(e){L.error("Pages - addBookmarkToPage: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(e){var s=e.payload.sections[D.id];s.layout.vizOrder.push(v.id);s.viz[v.id]=v;return this.savePersonalization(p);}.bind(this));}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.hasNoAdapter=true;return P;},true);
