// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_CommonDataModel/PersonalizationProcessor","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/ushell/services/_CommonDataModel/SiteConverter","sap/base/util/isEmptyObject","sap/base/util/deepClone","sap/base/util/Version","sap/ushell/Config","sap/base/util/includes"],function(P,O,q,a,S,b,d,V,C,c){"use strict";var e="sap.ushell.services.CommonDataModel",f={"STATIC_LAUNCHER":"sap.ushell.StaticAppLauncher","DYNAMIC_LAUNCHER":"sap.ushell.DynamicAppLauncher","CARD":"sap.ushell.Card"};function g(A,o,p,s){var h=new q.Deferred();this._oAdapter=A;this._oPersonalizationProcessor=new P();this._oSiteDeferred=h;this._oOriginalSite={};this._oPersonalizedSite={};this._oContentProviderIndex={};this._oSiteConverter=new S();this._mPersonalizationDeltas={};this._oGetSitePromise=A.getSite().then(this._loadAndApplyPersonalization.bind(this)).fail(h.reject);}g.prototype._loadAndApplyPersonalization=function(s){this._oOriginalSite=q.extend(true,{},s);var o=new V(s._version);if(o.compareTo("3.1.0")<0){this._oAdapter.getPersonalization(o).then(function(p){if(p){this._mPersonalizationDeltas=d(p);}else{this._mPersonalizationDeltas={version:"3.0.0",_version:"3.0.0"};}this._triggerMixinPersonalisationInSite(s,p);}.bind(this)).fail(this._oSiteDeferred.reject);}else{this._oPersonalizedPages={};this._oOriginalSite=this._ensureStandardVizTypesPresent(this._oOriginalSite);this._oSiteDeferred.resolve(this._oOriginalSite);}};g.prototype._triggerMixinPersonalisationInSite=function(s,p){return new Promise(function(r,h){this._oPersonalizationProcessor.mixinPersonalization(s,p).done(function(o){this._oPersonalizedSite=this._ensureCompleteSite(o);this._oPersonalizedSite=this._ensureGroupsOrder(this._oPersonalizedSite);this._oPersonalizedSite=this._ensureStandardVizTypesPresent(this._oPersonalizedSite);this._oSiteDeferred.resolve(this._oPersonalizedSite);r(this._oPersonalizedSite);}.bind(this)).fail(function(m){this._oSiteDeferred.reject(m);h();}.bind(this));}.bind(this));};g.prototype._triggerMixinPersonalisationInSiteAndStore=function(s,p,h){return this._triggerMixinPersonalisationInSite(s,p).then(function(o){var i=this._oSiteConverter.convertTo("3.1.0",d(o));if(this._oPersonalizedPages){this._oPersonalizedPages[h]=i;}return i;}.bind(this));};g.prototype.getHomepageGroups=function(){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var G=(s&&s.site&&s.site.payload&&s.site.payload.groupsOrder)?s.site.payload.groupsOrder:[];D.resolve(G);});return D.promise();};g.prototype.getGroups=function(){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var G=[];Object.keys(s.groups).forEach(function(k){G.push(s.groups[k]);});D.resolve(G);});return D.promise();};g.prototype.getGroup=function(i){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var G=s.groups[i];if(G){D.resolve(G);}else{D.reject("Group "+i+" not found");}});return D.promise();};g.prototype.getSite=function(){return this._oSiteDeferred.promise();};g.prototype.getPage=function(p){return new Promise(function(r,h){var E=C.last("/core/shell/enablePersonalization");this._oGetSitePromise.done(function(){if(E){this._getPageAndPersonalization(p).then(function(o){var i=o.page,j=o.personalization,k=this._oSiteConverter.convertTo("3.0.0",d(i));this._oOriginalSite.pages[i.identification.id]=d(i);this._mPersonalizationDeltas=d(j);var m=j[p]||{};this._triggerMixinPersonalisationInSiteAndStore.call(this,k,m,p).then(r).catch(function(){h("Personalization Processor: Cannot mixin the personalization.");});}.bind(this)).catch(h);}else if(!this._oAdapter.getPage){r(this._oOriginalSite.pages[p]);}else{this._oAdapter.getPage(p).then(r).catch(h);}}.bind(this)).fail(h);}.bind(this));};g.prototype._getPageAndPersonalization=function(p){return new Promise(function(r,h){var i;var o=new Promise(function(k,m){this._oAdapter.getPersonalization(this._oOriginalSite._version).done(k).fail(m);}.bind(this));if(!this._oAdapter.getPage){var j=this._oOriginalSite.pages[p];i=Promise.resolve(j);}else{i=this._oAdapter.getPage(p);}Promise.all([i,o]).then(function(k){r({page:k[0],personalization:k[1]});}).catch(function(){h("CommonDataModel Service: Cannot get page "+p+" or its personalization");});}.bind(this));};g.prototype.getPages=function(p){return new Promise(function(r,h){var E=C.last("/core/shell/enablePersonalization");var i;this._oGetSitePromise.done(function(){if(!this._oAdapter.getPages){var o={};for(var s in this._oOriginalSite.pages){if(c(p,this._oOriginalSite.pages[s].identification.id)){o[s]=this._oOriginalSite.pages[s];}}i=Promise.resolve(o);}else{i=this._oAdapter.getPages(p);}if(!E){return r(i.then(function(j){return Object.keys(j).map(function(s){return j[s];});}));}return i.then(function(j){var k=Promise.all(p.map(function(s){var m=j[s];if(!m){return Promise.resolve();}return new Promise(function(n,t){this._oAdapter.getPersonalization(this._oOriginalSite._version).done(function(u){var v=m,w=u,x=this._oSiteConverter.convertTo("3.0.0",d(v));this._oOriginalSite.pages[v.identification.id]=d(v);this._mPersonalizationDeltas=d(w);var y=w[v.identification.id]||{};this._triggerMixinPersonalisationInSiteAndStore.call(this,x,y,v.identification.id).then(function(z){n(z);}).catch(t);}.bind(this)).fail(t);}.bind(this));}.bind(this)));var F=k.then(function(m){return m.filter(function(n){return!!n;});});return r(F);}.bind(this)).catch(h);}.bind(this)).fail(h);}.bind(this));};g.prototype.getAllPages=function(){return sap.ushell.Container.getServiceAsync("Menu").then(function(m){return m.getSpacesPagesHierarchy();}).then(function(h){var p=[];h.spaces.forEach(function(s){s.pages.forEach(function(o){if(p.indexOf(o.id)===-1){p.push(o.id);}});});return this.getPages(p);}.bind(this));};g.prototype.getApplications=function(){return new Promise(function(r,h){this._oSiteDeferred.then(function(s){var A=s.applications;if(A){r(A);}else{h("CDM applications not found.");}}).fail(h);}.bind(this));};g.prototype.getVisualizations=function(){return new Promise(function(r,h){this._oSiteDeferred.then(function(s){var v=s.visualizations;if(v){r(v);}else{h("CDM visualizations not found.");}}).fail(h);}.bind(this));};g.prototype.getGroupFromOriginalSite=function(G){var D=new q.Deferred();if(typeof G==="string"&&this._oOriginalSite&&this._oOriginalSite.groups&&this._oOriginalSite.groups[G]){D.resolve(q.extend(true,{},this._oOriginalSite.groups[G]));}else{D.reject("Group does not exist in original site.");}return D.promise();};g.prototype.getOriginalPage=function(p){return this._oOriginalSite.pages[p];};g.prototype.save=function(p){var D=new q.Deferred(),o,h;if(this._oOriginalSite._version==="3.1.0"){if(!p){return D.reject("No page id was provided").promise();}h=this._oSiteConverter.convertTo("3.0.0",this._oOriginalSite.pages[p]);o=this._oSiteConverter.convertTo("3.0.0",this._oPersonalizedPages[p]);}else{h=this._oOriginalSite;o=this._oPersonalizedSite;}this._oPersonalizationProcessor.extractPersonalization(o,h).done(function(E){if(!b(E)){if(this._mPersonalizationDeltas.version===undefined||this._mPersonalizationDeltas._version===undefined){this._mPersonalizationDeltas.version=this._oOriginalSite._version;this._mPersonalizationDeltas._version=this._oOriginalSite._version;}if(p){this._mPersonalizationDeltas[p]=E;}else{this._mPersonalizationDeltas=E;}this._setPersonalization(this._mPersonalizationDeltas).then(D.resolve).catch(D.reject);}else{D.resolve();}}.bind(this)).fail(function(){D.reject("Personalization Processor: Cannot extract personalization.");});return D.promise();};g.prototype._setPersonalization=function(h,p){if(this._oPendingPersonalizationDeferred){if(!this._oNextPersonalizationQuery){this._oNextPersonalizationQuery={fnNextCall:null,aPromiseResolvers:[]};}return new Promise(function(r,i){this._oNextPersonalizationQuery.fnNextCall=this._setPersonalization.bind(this,h,p);this._oNextPersonalizationQuery.aPromiseResolvers.push({resolve:r,reject:i});}.bind(this));}this._oPendingPersonalizationDeferred=this._oAdapter.setPersonalization(h,p);return new Promise(function(r,i){this._oPendingPersonalizationDeferred.then(r).fail(i).always(function(){delete this._oPendingPersonalizationDeferred;if(this._oNextPersonalizationQuery){var n=this._oNextPersonalizationQuery.fnNextCall();this._cleanupPersonalizationQueuePromises(n,this._oNextPersonalizationQuery.aPromiseResolvers);delete this._oNextPersonalizationQuery;}}.bind(this));}.bind(this));};g.prototype._cleanupPersonalizationQueuePromises=function(n,h){h.forEach(function(p){n.then(p.resolve).catch(p.reject);});};function l(){var p=sap.ushell.Container.getService("PluginManager");return p.loadPlugins("ContentProvider");}g.prototype._getUnreferencedCatalogApplications=function(E){var u={};var A=Object.keys(E.applications).map(function(s){return E.applications[s]["sap.app"].id;}).reduce(function(i,s){i[s]=true;return i;},{});var o=E.catalogs;Object.keys(o).forEach(function(s){var h=o[s].payload.appDescriptors;h.map(function(i){return i.id;}).filter(function(i){return!A[i];}).forEach(function(B){if(!u.hasOwnProperty(s)){u[s]={};}u[s][B]=true;});});return u;};g.prototype._formatUnreferencedApplications=function(s,u){return"One or more apps from "+s+" content provider are not listed among the applications section "+"of the extended site and will be discarded - "+Object.keys(u).map(function(h){var B=Object.keys(u[h]).map(function(U){return"'"+U+"'";});return"From catalog '"+h+"': "+B.join(", ");}).join("; ");};g.prototype._removeUnreferencedApplications=function(E,u){Object.keys(E.catalogs).forEach(function(s){var o=E.catalogs[s].payload;var A=o.appDescriptors;o.appDescriptors=A.filter(function(h){return u[s]&&!u[s][h.id];});});};g.prototype.getExtensionSites=function(){var t=this;var D=new q.Deferred();l().done(function(){var h=Object.keys(t._oContentProviderIndex),T=h.length;if(T===0){D.resolve([]);return;}var G=h.map(function(s,i){var o=t._oContentProviderIndex[s];var j;try{j=o.getSite();if(!j||typeof j.then!=="function"){throw"getSite does not return a Promise";}}catch(E){j=Promise.reject("call to getSite failed: "+E);}return j.then(function(s,k){var m=q.extend(true,{},k);var u=t._getUnreferencedCatalogApplications(k);if(Object.keys(u).length>0){var n=t._formatUnreferencedApplications(s,u);q.sap.log.error(n,null,e);t._removeUnreferencedApplications(m,u);}var L={providerId:s,success:true,site:m};D.notify(L);return L;}.bind(null,s),function(s,k){return{providerId:s,success:false,error:k};}.bind(null,s));});Promise.all(G).then(function(L){D.resolve(L);});});return D.promise();};g.prototype.registerContentProvider=function(i,s){if(this._oContentProviderIndex[i]){q.sap.log.error("a content provider with ID '"+i+"' is already registered",null,e);return;}this._oContentProviderIndex[i]=s;q.sap.log.debug("ContentProvider '"+i+"' was registered",null,e);};g.prototype._ensureCompleteSite=function(p){if(p.groups){var G=p.groups;Object.keys(G).forEach(function(k){if(!G[k]){delete G[k];}else{if(!G[k].payload){G[k].payload={};}if(!G[k].payload.links){G[k].payload.links=[];}if(!G[k].payload.tiles){G[k].payload.tiles=[];}if(!G[k].payload.groups){G[k].payload.groups=[];}}});}return p;};g.prototype._ensureGroupsOrder=function(s){var G=O.get("site.payload.groupsOrder",s),o=s.groups,h,i=0;if(!G){return s;}while(i<G.length){h=G[i];if(!o[h]){G.splice(i,1);}else{i++;}}return s;};g.prototype.getPlugins=(function(){var D,E,p;E=function(s,o){var h,n=Object.keys(o).length;if(n===0){return{};}if(!o.hasOwnProperty("Shell-plugin")){q.sap.log.error("Cannot find inbound with id 'Shell-plugin' for plugin '"+s+"'","plugin startup configuration cannot be determined correctly",e);return{};}if(n>1){q.sap.log.warning("Multiple inbounds are defined for plugin '"+s+"'","plugin startup configuration will be determined using "+"the signature of 'Shell-plugin' inbound.",e);}h=O.get("signature.parameters",o["Shell-plugin"])||{};return Object.keys(h).reduce(function(r,N){var i=O.get(N+".defaultValue.value",h);if(typeof i==="string"){r[N]=i;}return r;},{});};D=function(o){Object.keys(o).filter(function(s){return typeof o[s]==="object";}).forEach(function(s){o[s]=D(o[s]);});return Object.freeze(o);};return function(o){if(o!==undefined){p=o;}if(p){return q.when(p);}p={};return this.getSite().then(function(s){var A=s.applications||{};Object.keys(A).filter(function(h){return O.get("type",this[h]["sap.flp"])==="plugin";},A).forEach(function(h){var i,j,k=this[h],m={};if(!a(k["sap.platform.runtime"])){q.sap.log.error("Cannot find 'sap.platform.runtime' section for plugin '"+h+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else if(!a(k["sap.platform.runtime"].componentProperties)){q.sap.log.error("Cannot find 'sap.platform.runtime/componentProperties' "+"section for plugin '"+h+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else{m=k["sap.platform.runtime"].componentProperties;}p[h]={url:m.url,component:k["sap.ui5"].componentName};var n=O.get("crossNavigation.inbounds",k["sap.app"])||{};j=E(h,n);i=q.extend(m.config||{},j);if(i){p[h].config=i;}if(m.asyncHints){p[h].asyncHints=m.asyncHints;}var r=O.get("deviceTypes",k["sap.ui"]);if(r){p[h].deviceTypes=r;}},A);return D(p);},function(v){return v;});};})();g.prototype._ensureStandardVizTypesPresent=function(s){if(!(s._version&&s._version.startsWith("3."))){return s;}if(!s.vizTypes){s.vizTypes={};}if(!s.vizTypes[f.STATIC_LAUNCHER]){s.vizTypes[f.STATIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncher/manifest.json");}if(!s.vizTypes[f.DYNAMIC_LAUNCHER]){s.vizTypes[f.DYNAMIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncherdynamic/manifest.json");}if(!s.vizTypes[f.CARD]){s.vizTypes[f.CARD]=q.sap.loadResource("sap/ushell/services/_CommonDataModel/vizTypeDefaults/cardManifest.json");}return s;};g.prototype.getMenuEntries=function(m){return new Promise(function(r,h){this._oSiteDeferred.then(function(s){var M=O.get("menus."+m+".payload.menuEntries",s);r(d(M)||[]);});}.bind(this));};g.hasNoAdapter=false;return g;},true);
