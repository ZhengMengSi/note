// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/clone"],function(c){"use strict";var P=function(d,r,m){this._oODataModel=d;this._oResourceBundle=r;this._oEtags={};this._oMessageModel=m;};P.prototype.getPages=function(){return this._readPages().then(function(p){for(var i=0;i<p.results.length;i++){this._storeETag(p.results[i]);}return p;}.bind(this)).then(this._convertODataToPageList.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.getPage=function(p){return this._readPage(p).then(function(a){this._storeETag(a);return a;}.bind(this)).then(this._convertODataToReferencePage.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.getPageWithoutStoringETag=function(p){return this._readPage(p).then(function(a){return a;}).then(this._convertODataToReferencePage.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.createPage=function(p){var a=this._convertReferencePageToOData(p);return this._createPage(a).then(this._storeETag.bind(this));};P.prototype.updatePage=function(u){var U=this._convertReferencePageToOData(u);U.modifiedOn=this._oEtags[u.id].modifiedOn;return this._createPage(U).then(function(p){this._storeETag(p);return this._convertODataToReferencePage(p);}.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.deletePage=function(p,t){return new Promise(function(r,a){this._oODataModel.callFunction("/deletePage",{method:"POST",urlParameters:{pageId:p,transportId:t,modifiedOn:this._oEtags[p].modifiedOn},success:r,error:a});}.bind(this));};P.prototype.copyPage=function(p){return new Promise(function(r,a){this._oODataModel.callFunction("/copyPage",{method:"POST",urlParameters:{targetId:p.targetId.toUpperCase(),sourceId:p.sourceId,title:p.title,description:p.description,devclass:p.devclass,transportId:p.transportId},success:r,error:a});}.bind(this));};P.prototype.getCatalogs=function(p,r){var d=Array.isArray(r)&&r[0];return this._fetchCatalogs(p).then(function(R){var C=R.reduce(function(a,b){if(d&&r.indexOf(b.name)<0){return a;}return a.concat(b.catalogs.results);},[]);return C;});};P.prototype._readPages=function(){return new Promise(function(r,a){this._oODataModel.read("/pageSet",{success:r,error:a});}.bind(this));};P.prototype._readPage=function(p){this._sCurrentPageId=null;this._catalogData=null;return new Promise(function(r,a){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"sections/tiles"},success:r,error:a});}.bind(this));};P.prototype._createPage=function(n){return new Promise(function(r,a){this._oODataModel.create("/pageSet",n,{success:r,error:a});}.bind(this));};P.prototype._convertODataToPageList=function(p){return p.results.map(function(o){return this._convertODataToReferencePage(o);}.bind(this));};P.prototype._convertODataToReferencePage=function(p){var o=c(p);delete o.__metadata;if(o.sections&&o.sections.results){o.sections=o.sections.results;o.sections.forEach(function(a){delete a.__metadata;a.visualizations=a.tiles?a.tiles.results:[];delete a.tiles;a.visualizations.forEach(function(v){delete v.__metadata;v.vizId=v.catalogTile;v.inboundPermanentKey=v.targetMapping;});var m=a.visualizations.length;a.visualizations.sort(function(v,b){var i=v.itemIndex||m;var d=b.itemIndex||m;return i-d;});});}if(!o.createdByFullname&&o.createdBy){o.createdByFullname=o.createdBy;}if(!o.modifiedByFullname&&o.modifiedBy){o.modifiedByFullname=o.modifiedBy;}var s=this.checkErrorMessage(o.id);o.editAllowed=s.length===0;o.code=(s.length!==0)?s[0].code:"";o.message=(s.length!==0)?s[0].message:"";o.assignmentCodeStatus=this.formatAssignmentStatusMessage(o.code);return o;};P.prototype._convertReferencePageToOData=function(p){var o={id:p.id,title:p.title,description:p.description,devclass:p.devclass,transportId:p.transportId,sections:(p.sections||[]).map(function(s){return{id:s.id,title:s.title,tiles:(s.visualizations||[]).map(function(t,i){return{id:t.id,catalogTile:t.vizId,targetMapping:t.inboundPermanentKey,itemIndex:i+1};})};})};return o;};P.prototype._storeETag=function(p){this._oEtags[p.id]={modifiedOn:p.modifiedOn,etag:p.__metadata.etag};};P.prototype.abortPendingBackendRequests=function(){if(this._oODataModel.hasPendingRequests()){for(var i=0;i<this._oODataModel.aPendingRequestHandles.length;i++){this._oODataModel.aPendingRequestHandles[i].abort();}}};P.prototype._rejectWithErrorMessage=function(e){var E,s={};if(e.statusCode==="412"){E=this._oResourceBundle.getText("Message.OverwriteChanges");}else if(e.statusCode==="400"){E=this._oResourceBundle.getText("Message.OverwriteRemovedPage");}else{try{E=JSON.parse(e.responseText).error.message.value||e.message;}catch(a){E=e.message;}}s.message=E;s.statusCode=e.statusCode;s.statusText=e.statusText;return Promise.reject(s);};P.prototype.checkErrorMessage=function(p){function f(a,q){if(!a){return[];}return a.filter(function(o){return o.target.toLowerCase().indexOf(q.toLowerCase())!==-1;});}var m=this._oMessageModel?this._oMessageModel.getData():null;return f(m,"/pageSet('"+p+"')");};P.prototype.formatAssignmentStatusMessage=function(C){if(C==="/UI2/PAGE/050"||C==="/UI2/PAGE/028"){return this._oResourceBundle.getText("Label.NotAssignedToSpace");}else if(C==="/UI2/PAGE/051"||C==="/UI2/PAGE/029"){return this._oResourceBundle.getText("Label.NotAssignedToRole");}return this._oResourceBundle.getText("Label.StatusAssigned");};P.prototype._fetchCatalogs=function(p){if(this._sCurrentPageId===p&&this._catalogData){return Promise.resolve(this._catalogData);}return new Promise(function(r,a){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"roles/catalogs/visualizations"},success:function(b){this._sCurrentPageId=p;this._catalogData=b.roles.results;this._catalogData.forEach(function(d){d.visualizationIds=[];d.catalogs.results.forEach(function(e){e.visualizations.results.forEach(function(v){d.visualizationIds.push(v.vizId);});});});r(this._catalogData);}.bind(this),error:a});}.bind(this));};P.prototype.getVizIds=function(r){var v=[],f=Array.isArray(r)&&r[0];if(this._catalogData){this._catalogData.forEach(function(a){if(!f||r.indexOf(a.name)>-1){Array.prototype.push.apply(v,a.visualizationIds);}});}return v;};P.prototype.getRoles=function(p){return this._fetchCatalogs(p).then(function(a){return a.map(function(r){return{name:r.name,title:r.title};});});};return P;},true);
