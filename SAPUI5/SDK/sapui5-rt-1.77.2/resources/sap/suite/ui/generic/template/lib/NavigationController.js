/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/core/library","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/testableHelper","sap/ui/fl/ControlPersonalizationAPI","sap/base/Log","sap/base/util/merge","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/UriParameters"],function(B,C,H,a,c,b,P,r,T,t,d,L,m,f,g,U){"use strict";var h=c.routing.HistoryDirection;var o=a.getInstance();var k=r.getCrossAppNavService();var A="sap-iapp-state--create";function l(R){var e=R.substring(R.length-5,R.length);if(e==="query"){return R.substring(0,R.length-5);}return R;}function n(e){if(e.indexOf("/")===0){return e;}return"/"+e;}function p(e){var D="";var R="";var j=Object.keys(e).sort();j.forEach(function(x){var V=e[x];if(Array.isArray(V)){var y=V.sort();for(var i=0;i<y.length;i++){var z=y[i];R=R+D+x+"="+z;D="&";}}else{R=R+D+x+"="+V;D="&";}});return R;}function q(e,i){e=e||"";var D=(e.charAt(e.length-1)==="/")?"?":"/?";return e+(i?D+i:"");}function s(e,i){var j=p(i);return q(e,j);}function u(i,R,j){var x=i.mRoutingTree[R.name];var y=R.template;var E=R.entitySet;var V=x.level;var O=-1;if(i.oFlexibleColumnLayoutHandler){O=V<3?V:0;}var z=O<0?i.oNavigationObserver:i.aNavigationObservers[O];var D=new P();var F=O<0?i.oHeaderLoadingObserver:i.aHeaderLoadingObservers[O];F.addObserver(D);var G={};var S={appComponent:i.oAppComponent,isLeaf:!R.pages||!R.pages.length,entitySet:E,navigationProperty:R.navigationProperty,componentData:{registryEntry:{oAppComponent:i.oAppComponent,componentCreateResolve:j,route:R.name,routeConfig:R,viewLevel:x.level,routingSpec:R.routingSpec,oNavigationObserver:z,oHeaderLoadingObserver:D,preprocessorsData:G}}};if(R.component.settings){f(S,R.component.settings);}var I;i.oAppComponent.runAsOwner(function(){try{var J=sap.ui.core.Component.create({name:y,settings:S,handleValidation:true,manifest:true});var K;I=new C({propagateModel:true,width:"100%",height:"100%",settings:S});K=J.then(function(M){I.setComponent(M);var x=i.mRoutingTree[R.name];x.componentId=M.getId();return I;});I.loaded=function(){return K;};}catch(e){throw new Error("Component "+y+" could not be loaded");}});return I;}function v(e,x){t.testable(u,"fnCreateComponentInstance");var y=!k||k.isInitialNavigation();var M={};var z={iHashChangeCount:0,backTarget:0,componentsDisplayed:Object.create(null)};var D=[];var E=Promise.resolve();var R=new P();var F=0;function G(){var i=x.oRouter,j=i.getTargets()._mTargets,q2=[];Object.keys(j).forEach(function(r2){var s2=j[r2],t2=s2._oOptions,u2=i.getRoute(t2.viewName),v2=u2&&u2._oConfig;if(v2&&(!v2.navigation||!v2.navigation.display)){q2.push({oConfig:v2});}});return q2;}t.testable(G,"fnGetAllPages");function I(i){var j=i||G();if(!Array.isArray(j)){j=[j];}j.forEach(function(q2){q2.oComponentContainer=u(e,q2.oConfig,function(){});});return j;}t.testable(I,"fnCreatePages");function J(){var i=x.oRouter.getViews();i.getView({viewName:"root"});return e.mRouteToTemplateComponentPromise.root;}function K(){return x.oAppComponent.getManifestEntry("sap.app").title;}function O(i,j,q2){var r2=i&&e.componentRegistry[i];var s2=r2&&r2.methods.getUrlParameterInfo;return s2?r2.viewRegistered.then(function(){var t2=j&&n(j);return s2(t2,z.componentsDisplayed[r2.route]===1).then(function(u2){f(q2,u2);});}):Promise.resolve();}function Q(i){var j=i.treeNode.componentId;var q2=i.treeNode.getPath(2,i.keys);var r2=i.appStates;return O(j,q2,r2);}function S(i,j,q2){var r2=e.mRoutingTree[i];return O(r2.componentId,q2,j);}function V(i,j){var q2;if(!i&&j instanceof T){var r2=j&&e.componentRegistry[j.getId()];var s2=r2&&r2.methods.getTitle;q2=s2&&s2();}else if(!i&&j&&j.title){q2=j.title;}q2=q2||K();e.oShellServicePromise.then(function(t2){t2.setTitle(q2);}).catch(function(){L.warning("No ShellService available");});}function W(i){var j=[e.oPagesDataLoadedObserver.getProcessFinished(true)];var q2=null;var r2=z.iHashChangeCount;delete $.componentsDisplayed;var s2=-1;for(var t2 in e.componentRegistry){var u2=e.componentRegistry[t2];var v2=u2.oControllerUtils&&u2.oControllerUtils.oServices.oTemplateCapabilities.oMessageButtonHelper;var w2=z.componentsDisplayed[u2.route]===1;var x2=u2.utils.getTemplatePrivateModel();x2.setProperty("/generic/isActive",w2);if(w2){j.push(u2.oViewRenderedPromise);if(u2.viewLevel>s2){s2=u2.viewLevel;q2=u2.oComponent;}}else{u2.utils.suspendBinding();}if(v2){v2.setEnabled(w2);}}var y2=e.oFlexibleColumnLayoutHandler&&e.oFlexibleColumnLayoutHandler.isAppTitlePrefered();V(y2,i||q2);Promise.all(j).then(function(){if(r2===z.iHashChangeCount&&g(M)){e.oAppComponent.firePageDataLoaded();}});}var X=W.bind(null,null);function Y(i,j){var q2=[];for(var r2=i;r2.level>=j;r2=e.mRoutingTree[r2.parentRoute]){q2.push(r2);}return q2.reverse();}var Z;var $;var _;t.testable(function(i){$=i;D.push(z);z={backTarget:0,componentsDisplayed:Object.create(null)};},"setCurrentIdentity");function a1(){return $;}function b1(j,q2){if(Array.isArray(j)&&j.length<2){j=j[0];}if(Array.isArray(q2)&&q2.length<2){q2=q2[0];}if(Array.isArray(j)){if(Array.isArray(q2)){if(j.length===q2.length){j=j.sort();q2=q2.sort();return j.every(function(r2,i){return r2===q2[i];});}return false;}return false;}return q2===j;}function c1(i){if(!$||$.treeNode!==i.treeNode){return false;}for(var j=i.treeNode;j.level>0;j=e.mRoutingTree[j.parentRoute]){if(!j.noKey&&i.keys[j.level]!==$.keys[j.level]){return false;}}if(g(i.appStates)!==g($.appStates)){return false;}if(g(i.appStates)){return true;}var q2=f(Object.create(null),i.appStates,$.appStates);for(var r2 in q2){if(!b1(i.appStates[r2],$.appStates[r2])){return false;}}return true;}function d1(i,j,q2){var r2=Object.create(null);for(var s2=i;s2.level>0;s2=e.mRoutingTree[s2.parentRoute]){if(!s2.noKey){r2["keys"+s2.level]=j[s2.level];}}var t2=!g(q2);var u2=i.sRouteName+(t2?"query":"");if(t2){r2["query"]=q2;}return{route:u2,parameters:r2};}function e1(i){var j=d1(Z.identity.treeNode,Z.identity.keys,Z.identity.appStates);x.oRouter.navTo(j.route,j.parameters,i);}function f1(i){if(!i||!Z.identity){return;}var j=function(r2,s2,t2){t2=s2?s2.getId():t2;var u2=e.componentRegistry[t2];(u2.methods.presetDisplayMode||Function.prototype)(i,r2);};for(var q2=Z.identity.treeNode;q2;q2=q2.parentRoute&&e.mRoutingTree[q2.parentRoute]){if(q2.componentId){j(z.componentsDisplayed[q2.sRouteName]===1,null,q2.componentId);}else{e.mRouteToTemplateComponentPromise[q2.sRouteName].then(j.bind(null,false));}if(q2.fCLLevel===0||q2.fCLLevel===3){break;}}}function g1(i){var j;if(i){if(Z||($&&$.preset)){Z={identity:i.identity,followUpNeeded:true};f1(i.displayMode);return;}if(i.identity&&c1(i.identity)){return;}j=i.mode;Z=i;f1(i.displayMode);delete Z.displayMode;}else{j=1;}Z.followUpNeeded=j<0;e.oBusyHelper.setBusyReason("HashChange",true);Z.displayMode=0;if(j<0){window.history.go(j);}else{e1(j===1);}}function h1(i,j){i.text=((i.headerTitle!==j)&&j)||"";if(_&&_.linkInfos.length>i.level){_.adjustNavigationHierarchy();}}function i1(i,j){var q2=Object.create(null);if(e.oFlexibleColumnLayoutHandler){e.oFlexibleColumnLayoutHandler.adaptBreadCrumbUrlParameters(q2,i);}var r2={treeNode:i};var s2={treeNode:i,keys:$.keys.slice(0,i.level+1),appStates:q2};var t2=Q(s2).then(function(){var v2=d1(i,$.keys,q2);r2.fullLink=x.oRouter.getURL(v2.route,v2.parameters);});j.push(t2);r2.navigate=function(v2,w2){if(e.oFlexibleColumnLayoutHandler&&!w2){var x2;for(var y2=D[z.backTarget];y2.backTarget>0&&!x2;y2=D[y2.backTarget]){if(y2.identity.treeNode===i){x2=y2.identity;}}e.oFlexibleColumnLayoutHandler.adaptPreferredLayout(q2,i,x2);}e.oBusyHelper.setBusy(t2.then(function(){u1(s2,false,v2);}));};var u2=i.getPath(2,s2.keys);r2.adaptBreadCrumbLink=function(v2){t2.then(function(){var A2=H.getInstance();var B2=A2.hrefForAppSpecificHash?A2.hrefForAppSpecificHash(r2.fullLink):"#/"+r2.fullLink;v2.setHref(B2);});var w2=function(){h1(i,v2.getText());};if(!r2.bLinkAttached){r2.bLinkAttached=true;var x2=v2.getBindingInfo("text")||{};x2.events={change:w2};}var y2=v2.getElementBinding();var z2=y2&&y2.getPath();if(z2===u2){w2();}else{v2.bindElement({path:u2,canonicalRequest:!e.bCreateRequestsCanonical});}};return r2;}function j1(i,j){var q2={title:j.treeNode.headerTitle||"",icon:j.treeNode.titleIconUrl||"",subtitle:j.treeNode.text,intent:i+j.fullLink};return q2;}function k1(){var j=[];var q2=[];var r2=e.oFlexibleColumnLayoutHandler&&e.oFlexibleColumnLayoutHandler.hasNavigationMenuSelfLink($);for(var s2=r2?$.treeNode:e.mRoutingTree[$.treeNode.parentRoute];s2;s2=e.mRoutingTree[s2.parentRoute]){var t2=i1(s2,q2);j[s2.level]=t2;}var u2=Promise.all(q2);var v2=location.hash;var w2=v2.indexOf("?");var x2=(w2!==-1&&w2<v2.indexOf("&"))?"?":"&";var y2=v2.split(x2)[0]+"&/";var z2=function(){e.oShellServicePromise.then(function(A2){A2.setHierarchy([]);u2.then(function(){var B2=[];for(var i=j.length-1;i>=0;i--){B2.push(j1(y2,j[i]));}A2.setHierarchy(B2);});}).catch(function(){L.warning("No ShellService available");});};_={linkInfos:j,adjustNavigationHierarchy:z2};z2();}function l1(){return _.linkInfos;}function m1(i){var j=$;if(Z&&Z.identity&&!Z.followUpNeeded){$=Z.identity;}else{$=Object.create(null);var q2=i.getParameter("config");var r2=l(q2.name);$.treeNode=e.mRoutingTree[r2];var s2=i.getParameter("arguments");$.appStates=s2["?query"]||Object.create(null);$.keys=[""];for(var t2=$.treeNode;t2.level>0;t2=e.mRoutingTree[t2.parentRoute]){$.keys[t2.level]=t2.noKey?"":s2["keys"+t2.level];}}$.previousIdentity=j;$.componentsDisplayed=Object.create(null);$.componentsDisplayed[$.treeNode.sRouteName]=1;k1();}function n1(i,j){var q2=R.getProcessFinished(true).then(function(){var r2={identity:{treeNode:$.treeNode,keys:$.keys,appStates:f(Object.create(null),$.appStates)},mode:1};if(Array.isArray(j)&&j.length<2){j=j[0];}if(j){r2.identity.appStates[i]=j;}else{delete r2.identity.appStates[i];}g1(r2);});e.oBusyHelper.setBusy(q2);}var o1;function p1(i,j,q2,r2){if(!i||(Array.isArray(i)&&i.length===0)){Q1(j);return;}var s2=Array.isArray(i)?i:[i];var t2=0,u2;var v2=new Promise(function(w2,x2){var y2=function(){if(t2==s2.length){w2(u2);}else{var z2=s2[t2];var A2=z1(u2,z2,true,true);A2.then(function(B2){t2++;u2=B2;y2();});}};y2();});e.oBusyHelper.setBusy(v2.then(function(w2){w2.appStates=Object.create(null);var x2;if(w2.treeNode.fCLLevel===0||w2.treeNode.fCLLevel===3){x2=Q(w2);}else{x2=e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation($,w2);}if(!j&&r2&&r2.bIsCreate&&r2.bIsDraft&&!r2.bIsDraftModified){o1={index:D.length,path:i.getPath(),identity:w2,displayMode:G1()};}return x2.then(function(){u1(w2,j,q2);});}));}function q1(j){if(!o1||o1.path!==j.getPath()){return null;}var q2;var r2=function(x2,i){return x2!==q2.identity.keys[i];};for(var i=o1.index+1;i<D.length;i++){q2=D[i];if(q2.identity.treeNode.level<o1.identity.treeNode.level||o1.identity.keys.some(r2)){return null;}}var s2=0;for(var t2=z;t2.iHashChangeCount!==o1.index;t2=D[t2.backTarget]){if(t2.iHashChangeCount<o1.index){return null;}s2--;}var u2=D[o1.index].identity;var v2={treeNode:u2.treeNode,keys:u2.keys,appStates:Object.create(null)};var w2=g1.bind(null,{identity:v2,mode:s2,displayMode:o1.displayMode});if(u2.treeNode.fCLLevel===0||u2.treeNode.fCLLevel===3){f(v2.appStates,u2.appStates);return Promise.resolve(w2);}return e.oFlexibleColumnLayoutHandler.getSpecialDraftCancelPromise($,u2,v2.appStates).then(function(){return w2;});}function r1(i,q2){var r2=r.determineNavigationPath(i);var s2={keys:["",r2.key],appStates:Object.create(null)};var t2=u1.bind(null,s2,true,q2);if($.treeNode.level===1){s2.treeNode=$.treeNode;f(s2.appStates,$.appStates);return Promise.resolve(t2);}var u2=Y($.treeNode,2);var v2=u2.map(function(j){if(j.noKey){return Promise.resolve(true);}if(!j.isDraft){return Promise.resolve($.keys[j.level]);}var x2=j.getPath(2,$.keys);var y2=e.oApplicationProxy.getSiblingPromise(x2);return y2.then(function(i){r2=r.determineNavigationPath(i,j.navigationProperty);return r2.key;},Function.prototype);});var w2=Promise.all(v2);return w2.then(function(x2){var y2=e.mEntityTree[r2.entitySet];for(var j=0;x2[j];j++){y2=u2[j];s2.keys.push(y2.noKey?"":x2[j]);}s2.treeNode=y2;if(y2===$.treeNode){f(s2.appStates,$.appStates);return t2;}var z2=e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation($,s2);return z2.then(function(){return t2;});});}function s1(i,j){if((i&&i.treeNode)!==j.treeNode){return Promise.resolve(false);}if(e.oFlexibleColumnLayoutHandler&&!e.oFlexibleColumnLayoutHandler.areIdentitiesLayoutEquivalent(i,j)){return Promise.resolve(false);}var q2=true;var r2=i.treeNode.sRouteName;for(var s2=i.treeNode;s2.level>0;s2=e.mRoutingTree[s2.parentRoute]){var t2=s2.noKey||i.keys[s2.level]===j.keys[s2.level];if(!t2&&s2.noOData){return Promise.resolve(false);}q2=q2&&t2;if(s2.noOData){r2=s2.parentRoute;}}if(q2){return Promise.resolve(true);}var u2=e.mRoutingTree[r2];var v2=i.keys.slice(0,u2.level+1);var w2=j.keys.slice(0,u2.level+1);var x2=u2.getPath(2,v2);var y2=u2.getPath(2,w2);return e.oApplicationProxy.areTwoKnownPathesIdentical(x2,y2,u2.level===1);}function t1(i){var j=D[z.backTarget];var q2=-1;if(i.level===0||(e.oFlexibleColumnLayoutHandler&&i.fCLLevel===0)){for(;j.backTarget>0&&j.identity.treeNode.level>i.level;q2--){j=D[j.backTarget];}}return j&&{candidateHash:j,candidateCount:q2};}function u1(i,j,q2){var r2=t1(i.treeNode);var s2=s1(r2&&r2.candidateHash.identity,i);var t2=s2.then(function(u2){var v2=u2?r2.candidateCount:(0+!!j);var w2={identity:i,mode:v2,displayMode:q2};g1(w2);});e.oBusyHelper.setBusy(t2);return t2;}function v1(){if(F<2){Q1();}else{var i=e.componentRegistry[$.treeNode.componentId];var j=i.utils.getTemplatePrivateModel();var q2=w1();_1({title:q2.dataLoadFailedTitle,text:q2.dataLoadFailedText,description:"",viewLevel:j.getProperty("/generic/viewLevel")});}}function w1(){return{dataLoadFailedTitle:e.getText("ST_ERROR"),dataLoadFailedText:e.getText("ST_GENERIC_ERROR_LOAD_DATA_TEXT")};}function x1(i,j,q2,r2){if(!j){return{treeNode:e.mRoutingTree.root,key:""};}var s2=r.determineNavigationPath(j);var t2=(i.level&&i.entitySet===s2.entitySet)?i:i.children.indexOf(s2.entitySet)>=0&&e.mEntityTree[s2.entitySet];if(t2){return{treeNode:t2,key:s2.key};}if(q2){var u2=e.oAppComponent.getModel();var v2=u2.getMetaModel();var w2=v2.getODataEntitySet(s2.entitySet);var x2=v2.getODataEntityType(w2.entityType);var y2;var z2=i.children.some(function(B2){t2=e.mEntityTree[B2];y2=t2.navigationProperty;if(!y2){return false;}var C2=v2.getODataAssociationEnd(x2,y2);return!!C2&&C2.multiplicity.endsWith("1");});if(z2){return{treeNode:t2,navigationProperty:y2};}}if(r2&&i.level>0){var A2=e.mRoutingTree[i.parentRoute];return x1(A2,j,q2,true);}}function y1(i,j,q2,r2){if(r2.navigationProperty){return new Promise(function(t2,u2){var v2=q2.getModel();v2.createBindingContext(r2.navigationProperty,q2,null,function(w2){var x2=w2&&y1(i,j,w2,{treeNode:r2.treeNode,key:r.determineNavigationPath(w2).key});if(x2){x2.then(t2,u2);}else{u2();}});});}var s2=j.slice(0,r2.treeNode.level);s2.push(r2.key);return Promise.resolve({treeNode:r2.treeNode,keys:s2});}function z1(i,j,q2,r2){var s2=(i&&i.treeNode)||$.treeNode;var t2=(i&&i.keys)||$.keys;var u2=x1(s2,j,q2,r2);return u2?y1(s2,t2,j,u2):Promise.reject();}function A1(i,j,q2){var r2={treeNode:i,keys:q2||$.keys.slice(0,i.level+1),appStates:j};if(i.fCLLevel===0||i.fCLLevel===3){return Q(r2);}return e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation($,r2);}function B1(i){var j=z1({treeNode:e.mRoutingTree.root},i,false,true);var q2=j.then(function(r2){r2.appStates=Object.create(null);var s2;if(r2.treeNode===$.treeNode){Object.assign(r2.appStates,$.appStates);s2={identity:r2,mode:1,displayMode:1};g1(s2);return null;}var t2=A1(r2.treeNode,r2.appStates);return t2.then(u1.bind(null,r2,true,1));});e.oBusyHelper.setBusy(q2);return q2;}function C1(i){var j;var q2=0;for(j=z;j.backTarget>0&&(!j.identity||j.identity.treeNode.level>i);q2++){j=D[j.backTarget];}if(!y&&(q2===0||j.identity.treeNode.level>i)){window.history.go(-q2-1);return;}var r2=-q2||1;var s2=f2(i);var t2={treeNode:s2,keys:$.keys.slice(0,s2.level+1),appStates:Object.create(null)};var u2=A1(t2.treeNode,t2.appStates).then(function(){if(r2<0&&(t2.treeNode.fCLLevel===1||t2.treeNode.fCLLevel===2)&&j.identity.treeNode===t2.treeNode){for(;j.backTarget>0&&!e.oFlexibleColumnLayoutHandler.areIdentitiesLayoutEquivalent(j.identity,t2);r2--){j=D[j.backTarget];if(j.identity.treeNode!==t2.treeNode){break;}}}var v2={identity:t2,mode:r2,displayMode:t2.treeNode.isDraft?6:1};g1(v2);});e.oBusyHelper.setBusy(u2);}var D1;function E1(i,j,q2){var r2=e.mEntityTree[i];var s2;if(j){var t2=k.createEmptyAppState(e.oAppComponent);t2.setData(j);t2.save();s2=t2.getKey();}var u2=$?$.keys.slice(0,r2.level):[""];u2.push("-");var v2=Object.create(null);var w2=A1(r2,v2,u2);var x2=w2.then(function(){if(s2){v2[A]=s2;}var y2={treeNode:r2,keys:u2,appStates:v2};D1=q2;u1(y2,false,4);});e.oBusyHelper.setBusy(x2);return x2;}function F1(i){var j=z1(null,i,false,false);e.oBusyHelper.setBusy(j.then(function(q2){q2.appStates=Object.create(null);f(q2.appStates,$.appStates);delete q2.appStates[A];var r2={identity:q2,mode:1};g1(r2);}));}function G1(){var i=e.componentRegistry[$.treeNode.componentId];var j=i.utils.getTemplatePrivateModel();var q2=j.getProperty("/objectPage/displayMode")||0;return q2;}function H1(i,j,q2,r2,s2){var t2=$.keys.slice(0,i.level);t2.push(j?q2:"");var u2=Object.create(null);var v2=A1(i,u2,t2);e.oBusyHelper.setBusy(v2.then(function(){var w2={treeNode:i,keys:t2,appStates:u2};u1(w2,r2,s2);}));}function I1(q2,r2,s2,t2,u2){var v2;var w2=true;for(var i=0;i<q2.children.length&&!v2;i++){var x2=q2.children[i];var y2=e.mEntityTree[x2];if(y2[q2.level?"navigationProperty":"sRouteName"]===r2){v2=y2.sRouteName;w2=!y2.noKey;}}var z2=!v2&&s2&&q2.embeddedComponents[s2];if(z2){for(var j=0;j<z2.pages.length&&!v2;j++){var A2=z2.pages[j];if(A2.navigationProperty===r2){v2=q2.sRouteName+"/"+s2+"/"+r2;w2=!(A2.routingSpec&&A2.routingSpec.noKey);}}}if(v2){var B2=e.mRoutingTree[v2];H1(B2,w2,t2,u2,G1());}}function J1(i,j,q2,r2){var s2=z1({treeNode:i},j,true,false);e.oBusyHelper.setBusy(s2.then(function(t2){t2.appStates=Object.create(null);var u2=A1(t2.treeNode,t2.appStates,t2.keys);return u2.then(u1.bind(null,t2,r2,q2));}));}function K1(){return!!Z;}function L1(i){L.info("Navigate back");if(z.backTarget&&n(o.getPreviousHash()||"")!==n(z.hash)){e.oBusyHelper.setBusyReason("HashChange",true);}z.LeaveByBack=!z.forwardingInfo;if(z.LeaveByBack){z.backSteps=i;}window.history.go(-i);}function M1(j,q2,r2,s2){var t2=e.oAppComponent.getObjectPageHeaderType()==="Dynamic"&&e.oAppComponent.getObjectPageVariantManagement()==="VendorLayer";var u2;var v2=new U(window.location.href);if(v2.mParams["sap-ui-layer"]){var w2=v2.mParams["sap-ui-layer"];for(var i=0;i<w2.length;i++){if(w2[i].toUpperCase()==="VENDOR"){u2=true;break;}}}j=n(j||"");L.info("Navigate to hash: "+j);if(j===z.hash){L.info("Navigation suppressed since hash is the current hash");return;}z.targetHash=j;if(z.backTarget&&n(o.getPreviousHash()||"")===j){L1(1);return;}var x2=$?$.treeNode.level:0;if(t2&&u2){if(!s2){if(!e.oFlexibleColumnLayoutHandler){d.clearVariantParameterInURL();}else{if(x2>=r2){if(r2===1){d.clearVariantParameterInURL();}else if(r2===2){var y2;for(var z2 in e.componentRegistry){if(e.componentRegistry[z2].viewLevel===2){y2=e.componentRegistry[z2];break;}}var A2=y2.oController.byId("template::ObjectPage::ObjectPageVariant");d.clearVariantParameterInURL(A2);}}}}}e.oBusyHelper.setBusyReason("HashChange",true);z.LeaveByReplace=q2;if(q2){x.oHashChanger.replaceHash(j);}else{x.oHashChanger.setHash(j);}}function N1(i,j,q2,r2,s2,t2){var u2=j.then(function(v2){i=q(i,v2);if(s2){z.backwardingInfo={count:s2.count,index:s2.index,targetHash:n(i)};L1(s2.count);}else{M1(i,r2,q2,t2);}return i;});e.oBusyHelper.setBusy(u2);return u2;}function O1(){var i=t1(e.mRoutingTree.root);return i&&{count:-i.candidateCount,index:i.candidateHash.iHashChangeCount,routeName:"root"};}function P1(i,j,q2){if(q2===0){return O1();}var r2=D[z.backTarget];return r2&&r2.hash&&n(r2.hash.split("?")[0])===n(j)&&{count:1,index:z.backTarget};}function Q1(i){if($.treeNode.level===0){return;}var j={treeNode:e.mRoutingTree["root"],keys:[""],appStates:Object.create(null)};var q2=e.oFlexibleColumnLayoutHandler?e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation($,j):Q(j);q2.then(u1.bind(null,j,i));e.oBusyHelper.setBusy(q2);}function R1(i){var j=e.mEntityTree[i.entitySet].sRouteName;var q2=e.mRouteToTemplateComponentPromise[j];return[q2];}function S1(j,q2){var r2=z.componentsDisplayed;var s2=function(u2){var v2=e.componentRegistry[u2.getId()];(v2.methods.presetDisplayMode||Function.prototype)(q2,r2[v2.route]===1);};for(var i=0;i<j.length;i++){var t2=j[i];t2.then(s2);}}function T1(i){var j=i&&e.mEntityTree[i.entitySet];var q2=j?j.level:1;return q2;}function U1(j,q2){var r2=e.oApplicationProxy.getHierarchySectionsFromCurrentHash();var s2=j;for(var i=q2-2;i>=0;i--){s2=r2[i]+"/"+s2;}return"/"+s2;}function V1(i,j,q2,r2,s2){var t2={};var u2=e.oFlexibleColumnLayoutHandler&&e.oFlexibleColumnLayoutHandler.getFCLAppStatesPromise(i,t2);var v2=S(i,t2,j);var w2=(u2?Promise.all([u2,v2]):v2).then(p.bind(null,t2));var x2=P1(r2,j,q2);var y2=N1(j,w2,q2,r2,x2,s2);e.oBusyHelper.setBusy(y2);return y2;}function W1(j,q2,r2,s2,t2){var u2;var v2,w2,x2;var y2=[];if(typeof j==="string"){u2=j;var z2=n(u2);if(z2==="/"){v2=0;}else{x2=z2.split("/");v2=x2.length-1;}switch(v2){case 0:w2="root";break;case 1:w2=x2[1].split("(")[0];break;default:w2="";var A2="";for(var i=0;i<v2;i++){var B2=x2[i+1];var C2=B2.indexOf("(");if(C2>0){B2=B2.substring(0,C2);}w2=w2+A2+B2;A2="/";}w2=w2.replace("---","/");}}else{var D2=r.determineNavigationPath(j,q2);v2=T1(D2);u2=D2.path;y2=R1(D2);w2=e.mEntityTree[D2.entitySet].sRouteName;}if(q2){u2=U1(u2,v2);}S1(y2,s2||0);return V1(w2,u2,v2,r2,t2);}function X1(i,j,q2,r2,s2){return W1(i,j,q2,r2,s2);}function Y1(i,j){z.componentsDisplayed[i]=j;var q2=e.mRoutingTree[i];var r2=q2.componentId;if(r2){var s2=e.componentRegistry[r2];var t2=s2.utils.getTemplatePrivateModel();t2.setProperty("/generic/isActive",j===1);}}function Z1(i){var j,q2,r2,s2,t2,u2=null,v2,w2;if(i){j=i.entitySet;q2=i.text;u2=i.icon;w2=i.description;}if(j){v2=e.oAppComponent.getModel().getMetaModel();if(v2){r2=v2.getODataEntitySet(j);s2=v2.getODataEntityType(r2.entityType);t2=s2["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(t2&&t2.TypeImageUrl&&t2.TypeImageUrl.String){u2=t2.TypeImageUrl.String;}}e.oTemplatePrivateGlobalModel.setProperty("/generic/messagePage",{text:q2,icon:u2,description:w2});if(e.oFlexibleColumnLayoutHandler){e.oFlexibleColumnLayoutHandler.displayMessagePage(i,z.componentsDisplayed);}else{var x2=x.oRouter.getTargets();x2.display("messagePage");for(var y2 in z.componentsDisplayed){Y1(y2,5);}}W(i);}function $1(){if(!g(M)){var j=null;for(var i=0;!j;i++){j=M[i];}M={};Z1(j);}}function _1(i){if(x.oTemplateContract.oFlexibleColumnLayoutHandler){i.viewLevel=i.viewLevel||0;M[i.viewLevel]=i;var j=Promise.all([E,x.oTemplateContract.oPagesDataLoadedObserver.getProcessFinished(true)]);j.then($1);j.then(e.oBusyHelper.setBusyReason.bind(null,"HashChange",false));return;}Z1(i);e.oBusyHelper.setBusyReason("HashChange",false);}function a2(){var i=[];var j=$.componentsDisplayed||z.componentsDisplayed;for(var q2 in e.componentRegistry){var r2=e.componentRegistry[q2];if(j[r2.route]===1){i.push(q2);}}return i;}function b2(){var i=[];for(var j in e.componentRegistry){i.push(j);}return i;}function c2(i){return $.keys.slice(0,i+1);}function d2(j){var q2="";var r2=z.hash;var s2=r2.split("/");var t2="";for(var i=0;i<=j;i++){q2=q2+t2+s2[i];t2="/";}return q2;}function e2(){return z;}function f2(i){var j=$.treeNode;for(;j.level>i;){j=e.mRoutingTree[j.parentRoute];}return j;}function g2(i,j,q2){var r2=q2.getId();var s2=e.componentRegistry[r2];var t2=c2(s2.viewLevel);var u2=s2.route;var v2=j.componentsDisplayed[u2];var w2=v2===1;var x2=function(D2){var E2=q2.onActivate(D2,w2)||Promise.resolve();return Promise.all([E2,s2.viewRegistered]).then(function(){s2.aKeys=t2;});};z.componentsDisplayed[u2]=1;if(j.isNonDraftCreate&&i==="-"){var y2=e.mRoutingTree[u2];var z2=e.mRoutingTree[y2.parentRoute];var A2=z2.getPath(2,t2);var B2=e.oAppComponent.getModel();var C2=A2?new Promise(function(D2){var E2={canonicalRequest:!e.bCreateRequestsCanonical};B2.createBindingContext(A2,null,E2,D2);}):Promise.resolve();return C2.then(function(D2){var E2=D2?y2.navigationProperty:"/"+q2.getEntitySet();var F2=$.appStates[A];var G2=F2?new Promise(function(H2){var I2=k.getAppState(e.oAppComponent,F2);I2.done(H2);I2.fail(H2.bind(null,null));}):Promise.resolve();return G2.then(function(H2){s2.nonDraftCreateContext=D1||b.createNonDraft(D2,E2,B2,H2&&H2.getData(),e.oApplicationProxy.mustRequireRequestsCanonical());D1=null;return x2(s2.nonDraftCreateContext.getPath());});});}delete s2.nonDraftCreateContext;return x2(i);}function h2(i,j,q2){return g2(i,j,q2).then(X);}function i2(i,j,q2){var r2={};if(j||q2){var s2=i.level;for(var t2=0;t2<s2;t2++){r2[t2]=e.oPaginatorInfo[t2];}}e.oPaginatorInfo=r2;}function j2(i){return e.oApplicationProxy.getAlternativeContextPromise(i);}function k2(i){R.startProcess();m1(i);$.preset=true;if(e.oFlexibleColumnLayoutHandler){e.oFlexibleColumnLayoutHandler.handleBeforeRouteMatched($);}}function l2(){R.stopProcess();if(Z&&Z.followUpNeeded&&Z.identity&&!c1(Z.identity)){g1();return;}e.oBusyHelper.setBusyReason("HashChange",false);var q2=$.treeNode.level;var r2=n(x.oHashChanger.getHash()||"");L.info("Route matched with hash "+r2);var s2;if(z.backwardingInfo){s2=z;s2.identity=$.previousIdentity;delete $.previousIdentity;D.push(s2);var t2=s2.iHashChangeCount+1;z={iHashChangeCount:t2,forwardingInfo:{bIsProgrammatic:true,bIsBack:true,iHashChangeCount:t2,targetHash:s2.backwardingInfo.targetHash,componentsDisplayed:s2.componentsDisplayed},backTarget:D[s2.backwardingInfo.index].backTarget,componentsDisplayed:Object.create(null)};}if(z.forwardingInfo&&z.forwardingInfo.targetHash&&z.forwardingInfo.targetHash!==r2){z.hash=r2;var u2=z.forwardingInfo.targetHash;delete z.forwardingInfo.targetHash;M1(u2,true);return;}var v2=false;for(var i=0;i<e.aStateChangers.length;i++){var w2=e.aStateChangers[i];if(w2.isStateChange($.appStates)){v2=true;}}if(v2){Z=null;z.hash=r2;return;}F++;e.oTemplatePrivateGlobalModel.setProperty("/generic/routeLevel",q2);var x2=z.forwardingInfo;delete z.forwardingInfo;if(!x2){x2={componentsDisplayed:z.componentsDisplayed,isNonDraftCreate:!$.treeNode.isDraft&&$.keys[$.treeNode.level]==="-"};var y2=z.iHashChangeCount;x2.iHashChangeCount=y2+1;var z2=o.getDirection();if(Z){x2.bIsProgrammatic=!!Z.identity;x2.bIsBack=Z.mode<0;if(x2.bIsBack){z.backSteps=0-Z.mode;}x2.bIsForward=!x2.bIsBack&&(z2===h.Forwards);z.LeaveByReplace=Z.mode===1;}else{x2.bIsProgrammatic=(r2===z.targetHash);x2.bIsBack=!!(z.LeaveByBack||(!x2.bIsProgrammatic&&(z2===h.Backwards)));x2.bIsForward=!x2.bIsBack&&(z2===h.Forwards);z.LeaveByReplace=x2.bIsProgrammatic&&z.LeaveByReplace;if(!x2.bIsProgrammatic&&$.previousIdentity&&$.previousIdentity.treeNode.level>0&&!$.previousIdentity.treeNode.isDraft){var A2=x2.isNonDraftCreate||$.treeNode!==$.previousIdentity.treeNode;for(var j=1;!A2&&j<$.keys.length;j++){A2=$.keys[j]!==$.previousIdentity.keys[j];}if(A2){var B2=e.componentRegistry[$.previousIdentity.treeNode.componentId];var C2=B2.oComponent.getModel("ui");if(C2.getProperty("/editable")){B2.oControllerUtils.oCommonUtils.resetChangesAndFireCancelEvent();C2.setProperty("/editable",false);delete B2.nonDraftCreateContext;}}}}if(!x2.bIsBack){F=2;}z.LeaveByBack=x2.bIsBack;s2=z;s2.identity=$.previousIdentity;delete $.previousIdentity;D.push(s2);z={iHashChangeCount:x2.iHashChangeCount,componentsDisplayed:Object.create(null)};if(s2.LeaveByReplace){z.backTarget=s2.backTarget;}else if(x2.bIsBack){var D2=s2.backTarget;for(var E2=s2.backSteps||1;E2>0;E2--){D2=D[D2].backTarget;}z.backTarget=D2;}else{z.backTarget=y2;}}Z=null;z.hash=r2;var F2=function(I2){if(I2){p1(I2.context,true,I2.iDisplayMode);return;}i2($.treeNode,x2.bIsProgrammatic,x2.bIsBack);if(e.oFlexibleColumnLayoutHandler){E=e.oFlexibleColumnLayoutHandler.handleRouteMatched(x2);}else{var J2=e.mRouteToTemplateComponentPromise[$.treeNode.sRouteName];E=J2.then(function(K2){return h2(x2.isNonDraftCreate?"-":$.treeNode.getPath(2,$.keys),x2,K2);});}e.oBusyHelper.setBusy(E);};if(x2.bIsBack){var G2=f2(1);var H2=G2&&G2.getPath(2,$.keys);e.oBusyHelper.setBusy(j2(H2).then(F2));}else{F2();}}function m2(i){if($&&$.preset){delete $.preset;}else{m1(i);}var j=e.oStatePreserversAvailablePromise.then(l2,e.oBusyHelper.setBusyReason.bind(null,"HashChange",false));e.oBusyHelper.setBusy(j);p2();}function n2(){$={appStates:Object.create(null),keys:[]};_1({title:e.getText("ST_ERROR"),text:e.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:""});}function o2(){return!y;}function p2(){var i;for(var j=$.treeNode;j;j=i){var q2=j.componentId&&e.componentRegistry[j.componentId];if(q2){var r2=q2.utils.getTemplatePrivateModel();r2.setProperty("/generic/currentActiveChildContext",j.selectedPath);}i=e.mRoutingTree[j.parentRoute];if(i){i.selectedPath=j.getPath(3,$.keys);}}}if(e.sRoutingType==="f"){x.oRouter.attachBeforeRouteMatched(k2);}x.oRouter.attachRouteMatched(m2);x.oRouter.attachBypassed(n2);x.concatPathAndAppStates=s;x.navigate=M1;x.navigateBack=L1.bind(null,1);x.activateOneComponent=g2;x.afterActivation=X;x.addUrlParameterInfoForRoute=S;x.getApplicableStateForIdentityAddedPromise=Q;x.setVisibilityOfRoute=Y1;x.getActiveComponents=a2;x.getAllComponents=b2;x.getRootComponentPromise=J;x.getActivationInfo=e2;x.getCurrentKeys=c2;x.getCurrentHash=d2;x.getAppTitle=K;x.navigateByExchangingQueryParam=n1;x.navigateToSubContext=p1;x.getSwitchToSiblingPromise=r1;x.getSpecialDraftCancelPromise=q1;x.getCurrentIdentity=a1;x.navigateToIdentity=u1;x.navigateAfterActivation=B1;x.navigateUpAfterDeletion=C1;x.navigateForNonDraftCreate=E1;x.adaptUrlAfterNonDraftCreateSaved=F1;x.navigateToChild=I1;x.navigateFromNodeAccordingToContext=J1;x.isNavigating=K1;x.getLinksToUpperLayers=l1;x.setTextForTreeNode=h1;x.navigationContextNotFound=v1;x.isExternalNav=o2;x.createComponentInstance=u;return{navigateToRoot:Q1,navigateToContext:X1,navigateToMessagePage:_1,navigateBack:L1.bind(null,1)};}function w(e,i){var j={oAppComponent:i.oAppComponent,oRouter:i.oAppComponent.getRouter(),oTemplateContract:i,mRouteToComponentResolve:{}};if(j.oRouter){j.oHashChanger=j.oRouter.getHashChanger();}else{j.oHashChanger=H.getInstance();}i.oNavigationControllerProxy=j;var F=new Promise(function(R){j.fnInitializationResolve=R;});i.oBusyHelper.setBusy(F);f(e,v(i,j));f(j,e);j.oRouter._oViews._getViewWithGlobalId=function(V){V.viewName=V.name||V.viewName;for(var x in i.componentRegistry){if(i.componentRegistry[x].route===V.viewName){return i.componentRegistry[x].oComponent.getComponentContainer();}}var R=j.oRouter.getRoute(V.viewName);var y;if(R&&R._oConfig){y=u(i,R._oConfig,j.mRouteToComponentResolve[V.viewName]);}else{y=sap.ui.view({viewName:V.viewName,type:V.type,height:"100%"});}return y.loaded();};r.startupRouter(j);}var N=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(e){B.apply(this,arguments);t.testableStatic(w,"NavigationController")(this,e);}});N._sChanges="Changes";return N;});
