sap.ui.define(["sap/ui/model/Filter","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/suite/ui/generic/template/ListReport/controller/WorklistHandler","sap/suite/ui/generic/template/lib/ShareUtils","sap/base/Log","sap/base/util/ObjectPath","sap/suite/ui/generic/template/js/StableIdHelper","sap/base/util/deepExtend","sap/suite/ui/generic/template/ListReport/controller/CreateWithDialogHelper"],function(F,E,l,I,M,W,S,L,O,a,d,C){"use strict";return{getMethods:function(v,t,c){var s={};s.oWorklistData={};s.oWorklistData.bWorkListEnabled=false;s.oWorklistData.bVariantDirty=true;var b=true;var f;var w=null;function e(){var i=c.getOwnerComponent();var T=t.oComponentUtils.getTemplatePrivateModel();T.setProperty("/listReport/isLeaf",i.getIsLeaf());}function o(i){c.onInitSmartFilterBarExtension(i);c.templateBaseExtension.onInitSmartFilterBar(i);s.oIappStateHandler.onSmartFilterBarInitialise();}function g(){var i=s.oIappStateHandler.parseUrlAndApplyAppState();i.then(function(){b=false;},function(B){if(B instanceof Error){B.showMessageBox();}});}function h(){if(!b){s.oIappStateHandler.changeIappState(true,false);}}function u(i){t.oCommonUtils.setEnabledToolbarButtons(i);if(!t.oCommonUtils.isSmartChart(i)){t.oCommonUtils.setEnabledFooterButtons(i);}}function r(i){var B;B=i.getSource();B.getChartAsync().then(function(G){G.attachSelectData(u.bind(null,B));G.attachDeselectData(u.bind(null,B));});}function j(i){var B=i.getParameters();var G=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(G,B);}function k(i){var B,G;B=i.getParameters();G=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(G,B,s,undefined,undefined);}function m(i){var B,T,G,H,J,K;B=i.getParameters().mainNavigation;J=i.getParameters();K=i.getSource();if(B){T=K.getText&&K.getText();G=t.oCommonUtils.getCustomData(i);if(G&&G["LinkDescr"]){H=G["LinkDescr"];B.setDescription(H);}}K=K.getParent().getParent().getParent().getParent();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(K,J,s,T,B);}function n(B){var G=v.getItems();for(var i=0;i<G.length;i++){if(!B||G[i].getBindingContextPath()===B){return G[i];}}}function N(i){t.oCommonEventHandlers.onListNavigate(i,s,undefined,true);}function p(P,B){t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(B,false,s.oSmartFilterbar,P);},Function.prototype,s);}function q(V){var i=a.getStableId({type:"ListReportAction",subType:"Create",sQuickVariantKey:V});var B=c.byId(s.oCreateWithDialogHelper.getStableIdForDialog());if(B){t.oCommonUtils.executeIfControlReady(s.oCreateWithDialogHelper.createWithDialog.bind(null),i);}else{t.oCommonUtils.executeIfControlReady(p.bind(null,undefined),i);}}function x(i){var B=c.getOwnerComponent().getCreateWithFilters();var G=B.strategy||"extension";var P;switch(G){case"extension":P=c.getPredefinedValuesForCreateExtension(s.oSmartFilterbar);break;default:L.error(G+" is not a valid strategy to extract values from the SmartFilterBar");return;}p(P,i.getSource());}function D(i){var T=t.oComponentUtils.getTemplatePrivateModel();var B=T.getProperty("/listReport/deleteEnabled");if(B){t.oCommonEventHandlers.deleteEntries(i);}}function A(i){if(!t.oComponentUtils.isDraftEnabled()){return;}var T=t.oComponentUtils.getTemplatePrivateModel();var B=T.getProperty("/listReport/vDraftState");switch(B){case"1":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("HasDraftEntity","EQ",false));break;case"2":i.push(new F("IsActiveEntity","EQ",false));break;case"3":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","NE",""));break;case"4":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","EQ",""));break;default:var G=T.getProperty("/listReport/activeObjectEnabled");if(G){i.push(new F("IsActiveEntity","EQ",true));}else{var H=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});if(i[0]&&i[0].aFilters){var J=i[0];i[0]=new F([J,H],true);}else{i.push(H);}}break;}}function y(B){var i={shareEmailPressed:function(){var J=t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]);sap.m.URLHelper.triggerEmail(null,J,document.URL);},shareJamPressed:function(){S.openJamShareDialog(t.oServices.oApplication.getAppTitle());},getDownloadUrl:function(){var T=s.oSmartTable.getTable();var J=T.getBinding("rows")||T.getBinding("items");return J&&J.getDownloadUrl()||"";},getServiceUrl:function(){var J=i.getDownloadUrl();if(J){J+="&$top=0&$inlinecount=allpages";}var K={serviceUrl:J};if(c.onSaveAsTileExtension){c.onSaveAsTileExtension(K);}return K.serviceUrl;},getModelData:function(){var J=O.get("sap.ushell.Container.getUser");var K=c.getOwnerComponent();var P=K.getAppComponent();var Q=P.getMetadata();var U=Q.getManifestEntry("sap.ui");var R=(U&&U.icons&&U.icons.icon)||"";var T=Q.getManifestEntry("sap.app");var V=(T&&T.title)||"";return{serviceUrl:i.getServiceUrl(),icon:R,title:V,isShareInJamActive:!!J&&J().isJamActive(),customUrl:S.getCustomUrl()};}};S.openSharePopup(t.oCommonUtils,B,i);var G=this.getView().byId("template::Share");var H=this.getView().byId("bookmarkButton");H.setBeforePressHandler(function(){G.focus();});}function z(i){var B=i.getId();var G=s.oSmartFilterbar;var H=[];if(i.fetchVariant()&&i.fetchVariant().filter&&i.fetchVariant().filter.filterItems){H=i.fetchVariant().filter.filterItems;}var J="";var K={search:!!G.getBasicSearchValue(),filter:!!(H.length||G.retrieveFiltersWithValues().length)};if(K.search||K.filter){J=t.oCommonUtils.getContextText("NOITEMS_SMARTCHART_WITH_FILTER",B);}else{J=t.oCommonUtils.getContextText("NOITEMS_SMARTCHART",B);}i.getChartAsync().then(function(P){P.setCustomMessages({NO_DATA:J});});}return{onInit:function(){var i=c.getOwnerComponent().getAppComponent();var B=i.getConfig();s.oWorklistData.bWorkListEnabled=!!B.pages[0].component.settings&&B.pages[0].component.settings.isWorklist;s.oSmartFilterbar=c.byId("listReportFilter");s.oSmartTable=c.byId("listReport");s.updateControlOnSelectionChange=u;f=t.oComponentUtils.getFclProxy();s.bLoadListAndFirstEntryOnStartup=f.isListAndFirstEntryLoadedOnStartup();s.oMultipleViewsHandler=new M(s,c,t);s.oCreateWithDialogHelper=new C(s,c,t);s.oWorklistHandler=new W(s,c,t);s.oIappStateHandler=new I(s,c,t);s.oIappStateHandler.onSFBVariantInitialise();if(s.oWorklistData.bWorkListEnabled){s.oWorklistHandler.fetchAndSaveWorklistSearchField();}var T=t.oComponentUtils.getTemplatePrivateModel();T.setProperty("/generic/bDataAreShownInTable",false);T.setProperty("/listReport/isHeaderExpanded",true);T.setProperty("/listReport/deleteEnabled",false);if(t.oComponentUtils.isDraftEnabled()){T.setProperty("/listReport/activeObjectEnabled",false);T.setProperty("/listReport/vDraftState","0");}T.setProperty("/listReport/multipleViews/msgVisibility",false);t.oServices.oApplication.registerStateChanger({isStateChange:s.oIappStateHandler.isStateChange});v.getUrlParameterInfo=s.oIappStateHandler.getUrlParameterInfo;v.getItems=function(){var G=s.oSmartTable.getTable();if(t.oCommonUtils.isUiTable(G)){return G.getRows();}return G.getItems();};v.displayNextObject=function(G){return new Promise(function(H,J){w={aWaitingObjects:G,resolve:H,reject:J};});};v.onComponentActivate=function(){if(!b){s.oIappStateHandler.parseUrlAndApplyAppState();}};v.refreshBinding=function(U,G){if(s.oIappStateHandler.areDataShownInTable()){if(s.oMultipleViewsHandler.refreshOperation(2,null,!U&&G)){return;}if(U||G[s.oSmartTable.getEntitySet()]){t.oCommonUtils.refreshModel(s.oSmartTable);t.oCommonUtils.refreshSmartTable(s.oSmartTable);}}};e();c.byId("template::FilterText").attachBrowserEvent("click",function(){c.byId("page").setHeaderExpanded(true);});},handlers:{addEntry:q,addEntryWithFilters:x,deleteEntries:D,deleteEntry:function(i){t.oCommonEventHandlers.deleteEntry(i);},updateTableTabCounts:function(){s.oMultipleViewsHandler.fnUpdateTableTabCounts();},contextEditableChangedForSmartField:function(i){var B=i.getSource();if(!B.getContextEditable()){B.setContextEditable(true);}},onCancelCreateWithPopUpDialog:function(){s.oCreateWithDialogHelper.onCancelPopUpDialog();},onSaveCreateWithPopUpDialog:function(i){s.oCreateWithDialogHelper.onSavePopUpDialog(i);},onSelectionChange:function(i){var T=i.getSource();u(T);},onMultiSelectionChange:function(i){t.oCommonEventHandlers.onMultiSelectionChange(i);},onSmartFieldUrlPressed:function(i){t.oCommonEventHandlers.onSmartFieldUrlPressed(i,s);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:o,onSmartFilterBarInitialized:g,onBeforeSFBVariantFetch:function(){s.oIappStateHandler.onBeforeSFBVariantFetch();},onAfterSFBVariantSave:function(){s.oIappStateHandler.onAfterSFBVariantSave();},onAfterSFBVariantLoad:function(i){s.oIappStateHandler.onAfterSFBVariantLoad(i);},onDataRequested:function(){s.oMultipleViewsHandler.onDataRequested();},onDataReceived:function(B){t.oCommonEventHandlers.onDataReceived(B);if(w){var G;var H=false;for(var i=0;i<w.aWaitingObjects.length&&!H;i++){G=n(w.aWaitingObjects[i]);if(G){N(G);w.resolve();H=true;}}if(!H){G=n();if(G){N(G);w.resolve();}else{w.reject();}}w=null;return;}var T=B.getSource().getTable();f.handleDataReceived(T,N);},onSmartChartDataReceived:function(){s.oMultipleViewsHandler.onDataRequested();},onBeforeRebindTable:function(i){var B=i.getParameters().bindingParams;s.oMultipleViewsHandler.aTableFilters=d({},B.filters);var G=B.filters.slice(0);t.oCommonEventHandlers.onBeforeRebindTable(i,{determineSortOrder:s.oMultipleViewsHandler.determineSortOrder,ensureExtensionFields:c.templateBaseExtension.ensureFieldsForSelect,addTemplateSpecificFilters:A,addExtensionFilters:c.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.fnResolveParameterizedEntitySet,isFieldControlRequired:false});c.onBeforeRebindTableExtension(i);s.oMultipleViewsHandler.onRebindContentControl(B,G);l.handleErrorsOnTableOrChart(t,i);},onListNavigate:function(i){t.oCommonEventHandlers.onListNavigate(i,s);},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkPopoverOpens:function(i){var B=i.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var G=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());t.oCommonUtils.semanticObjectLinkNavigation(B,G,c);},Function.prototype,s,Function.prototype);},onSemanticObjectLinkNavigationPressed:j,onSemanticObjectLinkNavigationTargetObtained:k,onSemanticObjectLinkNavigationTargetObtainedSmartLink:m,onDraftLinkPressed:function(i){var B=i.getSource();var G=B.getBindingContext();t.oCommonUtils.showDraftPopover(G,B);},onAssignedFiltersChanged:function(i){if(i.getSource()){c.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:h,onToggleFiltersPressed:function(){var T=t.oComponentUtils.getTemplatePrivateModel();T.setProperty("/listReport/isHeaderExpanded",!T.getProperty("/listReport/isHeaderExpanded"));},onSearchButtonPressed:function(){t.oCommonUtils.refreshModel(s.oSmartTable);s.oIappStateHandler.changeIappState(false,true);},onSemanticObjectLinkPopoverLinkPressed:function(i){t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(i,s);},onAfterTableVariantSave:function(){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){if(!b){s.oIappStateHandler.onAfterApplyTableVariant();}},onAfterChartVariantSave:function(i){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyChartVariant:function(i){if(!b){s.oIappStateHandler.onAfterApplyTableVariant();}},onBeforeRebindChart:function(i){var B=i.getSource();z(B);var G=i.getParameters().bindingParams;s.oMultipleViewsHandler.aTableFilters=d({},G.filters);var H=G.filters.slice(0);var J={setBindingPath:B.setChartBindingPath.bind(B),ensureExtensionFields:Function.prototype,addTemplateSpecificFilters:A,addExtensionFilters:c.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.fnResolveParameterizedEntitySet,isFieldControlRequired:false};t.oCommonUtils.onBeforeRebindTableOrChart(i,J,s.oSmartFilterbar);c.onBeforeRebindChartExtension(i);s.oMultipleViewsHandler.onRebindContentControl(G,H);l.handleErrorsOnTableOrChart(t,i);},onChartInitialized:function(i){r(i);t.oCommonUtils.checkToolbarIntentsSupported(i.getSource());},onSelectionDetailsActionPress:function(i){s.oMultipleViewsHandler.onDetailsActionPress(i);},onShareListReportActionButtonPress:function(i){t.oCommonUtils.executeIfControlReady(y,"template::Share");},onInlineDataFieldForAction:function(i){t.oCommonEventHandlers.onInlineDataFieldForAction(i,s);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForAction(i,s.oSmartTable);},onDeterminingDataFieldForIntentBasedNavigation:function(i){var B=i.getSource();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(B,s.oSmartTable.getTable(),s);},onTableInit:function(i){var B=i.getSource();t.oCommonUtils.checkToolbarIntentsSupported(B);},onSearchWorkList:function(i){s.oWorklistHandler.performWorklistSearch(i);},onWorkListTableSettings:function(i){s.oWorklistHandler.openWorklistPersonalisation(i);},onActiveButtonPress:function(i){var P=c.byId("template::PageVariant");var T=t.oComponentUtils.getTemplatePrivateModel();var B=T.getProperty("/listReport/activeObjectEnabled");T.setProperty("/listReport/activeObjectEnabled",!B);P.currentVariantSetModified(true);s.oSmartFilterbar.search();s.oIappStateHandler.changeIappState(true,true);}},formatters:{formatDraftType:function(i,B,H){if(i&&i.DraftUUID){if(!B){return sap.m.ObjectMarkerType.Draft;}else if(H){return i.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(i,B){if(i&&i.DraftUUID){if(!B){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(i,B,G){if(i&&i.DraftUUID){if(G==="0"&&B){return false;}return true;}return false;},formatDraftOwner:function(i,H){var B="";if(i&&i.DraftUUID&&H){var U=i.InProcessByUserDescription||i.InProcessByUser||i.LastChangedByUserDescription||i.LastChangedByUser;if(U){B=t.oCommonUtils.getText("ST_DRAFT_OWNER",[U]);}else{B=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return B;},formatItemTextForMultipleView:function(i){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatItemTextForMultipleView(i):"";},formatMessageStrip:function(i,B){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatMessageStrip(i,B):"";}},extensionAPI:new E(t,c,s)};}};});
