/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/base/ManagedObjectModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/MessageScope","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/DataLossHandler","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/base/Log","sap/base/util/extend","sap/base/util/isPlainObject"],function(U,N,F,M,a,b,c,J,R,A,d,B,D,e,P,T,C,V,t,f,L,g,h){"use strict";A=t.observableConstructor(A);var j=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function k(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function l(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function n(p,q){var s={oAppComponent:p,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:k,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:m.bindList("/",null,null,v)};s.oDataLossHandler=new D(s);s.oValidationMessageBinding.attachChange(Function.prototype);var u;var w;var x;function y(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");s.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:j.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});p.setModel(s.oTemplatePrivateGlobalModel,"_templPrivGlobal");s.oShellServicePromise.catch(function(){s.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});var m=sap.ui.getCore().getMessageManager().getMessageModel();p.setModel(m,"_templPrivMessage");}function z(){s.fnAddSideEffectPromise=function(i1){var i=0;for(;s.aRunningSideEffectExecutions[i];){i++;}s.aRunningSideEffectExecutions[i]=i1;var j1=function(){s.aRunningSideEffectExecutions[i]=null;};i1.then(j1,j1);};u.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var i1=i.getParameter("promise");setTimeout(s.oBusyHelper.setBusy.bind(null,i1),1000);s.fnAddSideEffectPromise(i1);}});var g1=p.getModel("_templPrivGlobal");var h1="/generic/draftIndicatorState";u.attachBeforeQueueItemProcess(function(i){if(i.draftSave){g1.setProperty(h1,j.Saving);}});u.attachOnQueueCompleted(function(){if(g1.getProperty(h1)===j.Saving){g1.setProperty(h1,j.Saved);}});u.attachOnQueueFailed(function(){if(g1.getProperty(h1)===j.Saving){g1.setProperty(h1,j.Clear);}});g1.setProperty("/generic/appComponentName",p.getMetadata().getComponentName());}function E(){var i={appComponent:p,oTemplateContract:s,application:new d(s),oViewDependencyHelper:new V(s)};s.oViewDependencyHelper=i.oViewDependencyHelper;s.oShellServicePromise=p.getService("ShellUIService").catch(function(){var j1=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return((j1&&j1.createInstance())||Promise.reject());});s.oShellServicePromise.catch(function(){L.warning("No ShellService available");});var g1=$().settings||Object.create(null);p.applySettings(g1);(U.prototype.init||Function.prototype).apply(p,arguments);s.appSettings=new M(p);s.oBusyHelper.setBusy(s.oShellServicePromise);x=r(i);var h1=p.getModel();s.bCreateRequestsCanonical=true;var i1=h1.messageScopeSupported();s.oBusyHelper.setBusy(i1);i1.then(function(j1){if(j1){h1.setMessageScope(c.BusinessObject);s.bCreateRequestsCanonical=false;}u=new A(h1);y();w=new e(s);z();C.enableAutomaticDraftSaving(s);if((!h1.oMetadata||!h1.oMetadata.isLoaded())||h1.oMetadata.isFailed()){h1.attachMetadataFailed(function(){w.navigateToMessagePage({title:k("ST_GENERIC_ERROR_TITLE"),text:k("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:k("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var k1 in s.componentRegistry){s.componentRegistry[k1].fnViewRegisteredResolve(true);}});}if(p&&p.getMetadata()&&p.getMetadata().getManifest()){f.setAppComponent(p);}f.setApplicationStatus(f.mApplicationStatus.LOADING);f.publishEvent("elements","ViewRenderingStarted",{});});}function G(){if(s.oNavigationHost){return"";}if(s.sRoutingType==="f"){var i=new F();s.oNavigationHost=i;s.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];s.oNavigationObserver=new P({processObservers:s.aNavigationObservers});s.aHeaderLoadingObservers=[l(),l(),l()];}else{var g1=new N({id:p.getId()+"-appContent"});s.oNavigationHost=g1;s.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:g1.attachNavigate.bind(g1),attachProcessStop:g1.attachAfterNavigate.bind(g1)}});}s.oHeaderLoadingObserver=new P({processObservers:s.aHeaderLoadingObservers||[]});s.oPagesDataLoadedObserver=new P({processObservers:[s.oHeaderLoadingObserver,s.oNavigationObserver]});s.oNavigationHost.addStyleClass(s.oApplicationProxy.getContentDensityClass());s.oBusyHelper=new B(s);s.oBusyHelper.setBusyReason("HashChange",true,true);s.oBusyHelper.getUnbusy().then(function(){s.oShellServicePromise.then(function(h1){h1.setBackNavigation(s.oApplicationProxy.onBackButtonPressed);});});return s.oNavigationHost;}function H(){if(s.oNavigationHost){s.oNavigationHost.destroy();}if(u){u.destroy();}if(w){w.destroy();}if(s.oValidationMessageBinding){s.oValidationMessageBinding.destroy();}f.setAppComponent(null);(U.prototype.exit||Function.prototype).apply(p,arguments);x();t.endApp(q);}function I(i){var g1=Object.keys(i).map(function(h1){var i1=i[h1];if(i1.pages){i1.pages=I(i1.pages);}return i[h1];});return g1;}function K(Z){if(Z._version==="1.3.0"&&Z.pages&&h(Z.pages)){Z.pages=I(Z.pages);}}function O(g1,h1){if(!g1){return;}for(var i=0;i<g1.length;i++){var i1=g1[i];if(i1.routingSpec&&i1.routingSpec.noOData){i1.entitySet=i1.routingSpec.routeName;if(h1>1){i1.navigationProperty=i1.routingSpec.routeName;}}O(i1.pages,h1+1);if(i1.embeddedComponents){for(var j1 in i1.embeddedComponents){var k1=i1.embeddedComponents[j1];if(k1.pages){k1.pages=I(k1.pages);O(k1.pages,h1+1);}}}if(i1.implementingComponent&&i1.implementingComponent.pages){i1.implementingComponent.pages=I(i1.implementingComponent.pages);O(i1.implementingComponent.pages,h1+1);}}}function Q(Z){O(Z.pages,0);}function S(i){if(i){var g1=i.entitySet;var h1=(i.component&&i.component.settings&&i.component.settings.quickVariantSelectionX&&i.component.settings.quickVariantSelectionX.variants)||{};var i1=function(h1){for(var j1 in h1){var k1=h1[j1];if(k1.entitySet){return true;}}return false;};if(i1(h1)){for(var j1 in h1){var k1=h1[j1];if(k1.entitySet===undefined){k1.entitySet=g1;}}}}}function W(Z){S(Z.pages[0]);}function X(i){if(i&&i.objectPageDynamicHeaderTitleWithVM){i.objectPageHeaderType=i.objectPageHeaderType||"Dynamic";i.objectPageVariantManagement=i.objectPageVariantManagement||"VendorLayer";}}function Y(g1){var h1;if(g1.component){h1=g1.component.settings;}else{h1=g1;if(!h1.tableSettings&&!h1.tableType&&h1.multiSelect===undefined){return;}}h1=h1||{};h1.tableType=h1.tableType||(h1.gridTable?"GridTable":undefined);h1.tableType=h1.tableType||(h1.treeTable?"TreeTable":undefined);h1.tableSettings=h1.tableSettings||{};h1.tableSettings.type=h1.tableSettings.type||h1.tableType;h1.tableSettings.multiSelect=(h1.tableSettings.multiSelect===undefined?h1.multiSelect:h1.tableSettings.multiSelect);h1.tableType=h1.tableSettings.type;h1.multiSelect=h1.tableSettings.multiSelect;h1.tableSettings.selectAll=(h1.tableSettings.selectAll===undefined?false:h1.tableSettings.selectAll);for(var i in g1.pages){Y(g1.pages[i]);}for(var i in h1.sections){Y(h1.sections[i]);}}var Z;function $(){if(!Z){var i=p.getMetadata();Z=i.getManifestEntry("sap.ui.generic.app");if(!Z){return Object.create(null);}K(Z);Q(Z);W(Z);X(Z.settings);Y(Z.pages[0]);}return Z;}var _;function a1(){if(!_){_=g({},p.getMetadata().getManifest());_["sap.ui.generic.app"]=$();}return _;}function b1(){var i=p.getFlexibleColumnLayout();s.sRoutingType=i?"f":"m";return"sap."+s.sRoutingType+".routing.Router";}var c1=Promise.resolve();function d1(){var i=new Promise(function(g1){c1.then(function(){var h1=[];s.oNavigationControllerProxy.getActiveComponents().forEach(function(i1){var j1=s.componentRegistry[i1];var k1=j1.oComponent.getComponentContainer();var l1=k1.getParent();if(l1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var m1=s.oNavigationControllerProxy.createComponentInstance(s,j1.routeConfig,s.oNavigationControllerProxy.mRouteToComponentResolve[j1.route]);h1.push(m1.loaded().then(function(m1){var n1=k1.getComponentInstance().getBindingContext();l1.removePage(k1);l1.addPage(m1);l1.to(m1);k1.destroy();var o1=m1.getComponentInstance();var p1=s.componentRegistry[o1.sId];s.mRouteToTemplateComponentPromise[j1.route]=Promise.resolve(o1);if(n1){Promise.all([p1.viewRegistered,p1.reuseComponentsReady]).then(function(){p1.utils.bindComponent(n1.getPath(),true);});}return p1.oViewRenderedPromise;}));});g1(Promise.all(h1));});});c1=i.then(Function.prototype);return c1;}var e1={init:E,createContent:G,exit:H,_getRouterClassName:b1,getConfig:$,getInternalManifest:a1,getTransactionController:function(){return u.getTransactionController();},getApplicationController:function(){return u;},getNavigationController:function(){return w;}};var f1={retemplateActiveComponents:d1};if(sap.ui.getCore().getConfiguration().getDesignMode()){g(e1,f1);}var K=t.testable(K,"fnNormalizePagesMapToArray");$=t.testable($,"getConfig");return e1;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},considerAnalyticalParameters:{type:"boolean",defaultValue:false},showDraftToggle:{type:"boolean",defaultValue:false},objectPageHeaderType:{type:"string",defaultValue:"Static"},objectPageVariantManagement:{type:"string",defaultValue:"None"},flexibleColumnLayout:{type:"object",defaultValue:null},inboundParameters:{type:"object",defaultValue:null},tableColumnVerticalAlignment:{type:"string",defaultValue:"Middle"}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},suppressDataLossPopup:function(){return false;},constructor:function(){var i=t.startApp();g(this,n(this,i));(U.prototype.constructor||Function.prototype).apply(this,arguments);}});});
