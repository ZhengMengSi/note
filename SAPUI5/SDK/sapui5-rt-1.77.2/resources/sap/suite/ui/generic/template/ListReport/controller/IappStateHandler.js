sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/base/Log","sap/base/util/deepEqual","sap/base/util/extend"],function(B,C,N,S,U,L,d,e){"use strict";var a="sap.suite.ui.generic.template.customData",b="sap.suite.ui.generic.template.extensionData",c="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var i=L.getLevel();if(i<L.Level.INFO){L.setLevel(L.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var h="";for(var k in D){s=s+h+k+": "+D[k];h="; ";}}L.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,o,t){var h=t.oCommonUtils.getNavigationHandler();var j=o.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var k=false;var m=null;var A=Promise.resolve();var D=false;var p=false;var q;var u;var v=t.oComponentUtils.getSettings();var w=null;var x=null;s.oSmartFilterbar.setSuppressSelection(true);var y=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function z(){return D;}function E(){var n1={};var o1=[];var p1=y();for(var i=0;i<p1.length;i++){var q1=p1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(q1)){o1.push(q1);}}var r1={suppressDataSelection:!D,visibleCustomFields:o1};n1[c]=r1;if(t.oComponentUtils.isDraftEnabled()){var s1=t.oComponentUtils.getTemplatePrivateModel();r1.editStateFilter=s1.getProperty("/listReport/vDraftState");var t1=s1.getProperty("/listReport/activeObjectEnabled");r1.activeStateFilter=t1;}var u1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(u1){var v1=s.oMultipleViewsHandler.getContentForIappState();if(v1){r1[u1]=v1.state;}}if(s.oWorklistData.bWorkListEnabled){var w1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var x1={"searchString":w1};r1.Worklist=x1;}var y1={};n1[a]=y1;o.getCustomAppStateDataExtension(y1);var z1;var A1=true;var B1=function(C1,D1){if(!(C1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!A1){throw new Error("State must always be provided synchronously");}if(D1){z1=z1||Object.create(null);var E1=C1.getMetadata().getNamespace();z1[E1]=D1;}};o.templateBaseExtension.provideExtensionAppStateData(B1);A1=false;if(z1){n1[b]=z1;}return n1;}function F(){var n1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var o1=new S(n1);var p1=o.getVisibleSelectionsWithDefaults();for(var i=0;i<p1.length;i++){if(!o1.getValue(p1[i])){o1.addSelectOption(p1[i],"I","EQ","");}}if(o.byId('template::PageVariant')&&o.byId('template::PageVariant').currentVariantGetModified()&&o1.getID()){o1.setID("");}if(s.oWorklistData.bWorkListEnabled){var q1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";o1.addSelectOption("Worklist.SearchField","I","EQ",q1);}var r1={selectionVariant:o1.toJSONString(),tableVariantId:(!j&&s.oSmartTable.getCurrentVariantId())||"",customData:E()};return r1;}function G(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:p,bDataAreShownInTable:D});if(!p){return;}p=false;try{w=h.storeInnerAppStateWithImmediateReturn(F(),true);}catch(i){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(w instanceof N){p=true;w=null;return;}w.promise.fail(function(n1){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+n1);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:w.appStateKey,sAppStateKeyInUrl:x});if(x===w.appStateKey){w=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:w.appStateKey});h.replaceHash(w.appStateKey);}}function R(n1,o1){var p1=t.oComponentUtils.getTemplatePrivateModel();if(n1&&t.oComponentUtils.isDraftEnabled()){p1.setProperty("/listReport/vDraftState",n1.editStateFilter||"0");p1.setProperty("/listReport/activeObjectEnabled",!!n1.activeStateFilter);s.oMultipleViewsHandler.restoreActiveButtonState(n1);}var q1=n1&&n1.visibleCustomFields;if(q1&&q1.length>0){var r1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<r1.length;i++){var s1=r1[i];var t1=s1.getName();if(q1.indexOf(t1)!==-1){s1.setVisibleInFilterBar(true);}}}D=o1&&!(n1&&n1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();g1(D);}var u1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(u1&&n1[u1]){s.oMultipleViewsHandler.restoreFromIappState(n1[u1]);}}function H(i,j){if(j){var n1=i['sap-ui-fe-variant-id'];if(n1&&n1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(n1[0]);}}else{var o1=i['sap-ui-fe-variant-id'],p1=i['sap-ui-fe-filterbar-variant-id'],q1=i['sap-ui-fe-chart-variant-id'],r1=i['sap-ui-fe-table-variant-id'];J(p1&&p1[0],q1&&q1[0],r1&&r1[0],o1&&o1[0]);}}function J(i,n1,o1,p1){if(i||p1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||p1);}if(s.oSmartTable&&(o1||p1)){s.oSmartTable.attachAfterVariantInitialise(function(q1){s.oSmartTable.setCurrentVariantId(o1||p1);});s.oSmartTable.setCurrentVariantId(o1||p1);}s.oMultipleViewsHandler.setControlVariant(n1,o1,p1);}function K(i){o.restoreCustomAppStateDataExtension(i||{});}function M(i){if(!i){return;}var n1=true;var o1=function(p1){if(!(p1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var q1=p1.getMetadata().getNamespace();if(!n1){throw new Error("State must always be restored synchronously");}return i[q1];};o.templateBaseExtension.restoreExtensionAppStateData(o1);n1=false;}function O(i,n1){i=i||{};if(i.hasOwnProperty(a)&&i.hasOwnProperty(c)){M(i[b]);K(i[a]);R(i[c],n1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}K(i);}s.oSmartFilterbar.fireFilterChange();}function P(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":r.appStateKey};}return{};});}function Q(i){var n1=t.oComponentUtils.getTemplatePrivateModel();n1.setProperty("/generic/bDataAreShownInTable",i);}function T(i,n1){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:n1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:k,bAppStateDirty:p});Q(n1);if(k){return;}if(i||n1!==D){D=n1;if(!p){p=true;if(!s.oSmartFilterbar.isDialogOpen()){if(m){G();}else{setTimeout(G,0);}}}}}function V(i){var n1=s.oSmartFilterbar.determineMandatoryFilterItems(),o1;for(var p1=0;p1<n1.length;p1++){if(n1[p1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){o1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(o1){i.oSelectionVariant.addParameter("P_DisplayCurrency",o1);}}break;}}}function W(){var n1=s.oSmartFilterbar.determineMandatoryFilterItems();var o1=s.oSmartFilterbar.getFiltersWithValues();for(var i=0;i<n1.length;i++){if(o1.indexOf(n1[i])===-1){return true;}}return false;}function X(i,n1,o1){l("fnAdaptToAppState called",{sNavType:o1,sAppStateKeyInUrl:x,sAppStateKey:i.appStateKey,storingInformationAppStateKey:w&&w.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=o1;var p1=i.appStateKey||"";if(k){return;}if(x===null){x=p1;}else if(p1!==x){return;}var q1=(!p1&&n1)||{};H(q1,j);k=true;var r1=i.selectionVariant||"";var s1=(!j&&i.tableVariantId)||"";var t1=i.oSelectionVariant||"";var u1={selectionVariant:t1,urlParameters:n1,selectedQuickVariantSelectionKey:""};var v1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var w1=JSON.parse(JSON.stringify(v1));var x1=v1.getSelectOption(a);var y1=v1.getSelectOption(c);if((r.appStateKey!==p1||r.selectionVariant!==r1||r.tableVariantId!==s1||f(r.urlParams,q1))&&o1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!w||w.appStateKey!==p1){var z1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){V(i);}if(!s.oWorklistData.bWorkListEnabled){if(!z1||s.oSmartFilterbar.isCurrentVariantStandard()){u1.selectionVariant=i.oSelectionVariant;if(o1!==sap.ui.generic.app.navigation.service.NavType.iAppState){o.modifyStartupExtension(u1);m1(u1.selectionVariant,r,r1,true);}else{m1(u1.selectionVariant,r,r1,!z1);}}else{i1(v1,x1,y1,true);u1.selectionVariant=v1;o.modifyStartupExtension(u1);i1(u1.selectionVariant,x1,y1,false);if(!d(JSON.parse(JSON.stringify(u1.selectionVariant)),w1)){m1(u1.selectionVariant,r,r1,true);}}}if(s1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(s1);}i.customData=i.customData||{};if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[c]&&i.customData[c]["Worklist"]?i.customData[c]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}O(i.customData,true);}r={appStateKey:p1,urlParams:q1,selectionVariant:r1,tableVariantId:s1};}if(o1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(o1===sap.ui.generic.app.navigation.service.NavType.initial){i1(v1,x1,y1,true);u1.selectionVariant=v1;o.modifyStartupExtension(u1);i1(u1.selectionVariant,x1,y1,false);if(!d(JSON.parse(JSON.stringify(u1.selectionVariant)),w1)){m1(u1.selectionVariant,r,r1,true);}}s.oMultipleViewsHandler.handleStartUpObject(u1);}if(m){m();m=null;}if(s.oWorklistData.bWorkListEnabled){if(o1==="initial"&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}else if(o1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var A1=(o1===sap.ui.generic.app.navigation.service.NavType.xAppState||o1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;if(s.oSmartFilterbar.isCurrentVariantStandard()){D=s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser;}else{D=s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();}var B1=s.oMultipleViewsHandler.getOriginalEnableAutoBinding();var C1=W();var D1=v.dataLoadSettings;if(D1){var E1=D1.loadDataOnAppLaunch;}var F1=false;if(D===null||D===undefined){F1=A1||s.bLoadListAndFirstEntryOnStartup;if(!F1){if((E1===null||E1===undefined)&&(B1!==null&&B1!==undefined)){D=B1&&!C1?true:false;}else{D=d1(E1,C1);}}else{D=F1;}if(!D&&s.oSmartFilterbar.isCurrentVariantStandard()&&!s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser&&s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML){s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML=false;D=false;}}Q(D);if(D){s.oSmartFilterbar.search();g1(D);}}w=null;k=false;}function Y(){if(!m){A=new Promise(function(n1){m=n1;});}var i=new Promise(function(n1,o1){var p1=x;var q1=h.parseNavigation();q1.done(function(r1,s1,t1){X(r1,s1,t1);n1();});q1.fail(function(r1,s1,t1){L.warning(r1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");X({appStateKey:p1},s1,sap.ui.generic.app.navigation.service.NavType.initial);n1();});});return i;}function Z(){var i=s.oSmartFilterbar.getFilterData();var n1,o1=s.oSmartFilterbar.getBasicSearchControl();if(o1&&o1.getValue){n1=o1.getValue();}var p1=F();i._CUSTOM=p1.customData;s.oSmartFilterbar.setFilterData(i,true);if(n1){o1.setValue(n1);}s.oSmartFilterbar.fireFilterChange();}function $(){T(true,D);}function _(i){var n1=i.getParameter("context");var o1=s.oSmartFilterbar.getFilterData();if(o1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var p1=o1._CUSTOM[c]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(p1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{O(o1._CUSTOM);}}else{var q1=E();n(q1[a]);n(q1[c]);O(q1);}if(I.indexOf(n1)<0){D=i.getParameter("executeOnSelect");T(true,D);}}function a1(){if(!j){T(true,D);}}function b1(){if(!j){T(true,D);}}function c1(i){x=i["sap-iapp-state"]||"";if(w){if(w.appStateKey!==x){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+x+" expected "+w.appStateKey);return false;}Y();return true;}return false;}function d1(i,n1){var o1;var p1=s.oSmartFilterbar.getFiltersWithValues();var q1=["ifAnyFilterExist","always","never"];if(!q1.includes(i)){i="ifAnyFilterExist";}if(i==="ifAnyFilterExist"||i===null||i===undefined){o1=p1.length&&!n1?true:false;}else if(i==="always"){o1=!n1?true:false;}else if(i==="never"){o1=false;}return o1;}function e1(){q=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(G);}function f1(){var i=v.dataLoadSettings;if(i){var n1=i.loadDataOnAppLaunch;}var o1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();var p1=o1==="tableTabData"||o1==="tableViewData"?true:false;u=p1?false:true;var q1;q1=n1===null||n1===undefined?s.oMultipleViewsHandler.getEnableAutoBinding():true;q=u||q1;if(q){var r1=new sap.ui.core.CustomData({key:"executeStandardVariantOnSelect",value:true});s.oSmartFilterbar.addCustomData(r1);}}function g1(D){var i=o.getOwnerComponent().getModel("_templPriv");var n1=W();if(D&&n1){i.setProperty("/listReport/isHeaderExpanded",true);}else if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}function h1(i,n1,o1){var p1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(p1,{replace:n1,strictMode:o1});}function i1(i,n1,o1,p1){if(i&&(n1||o1)){if(p1){i.removeSelectOption(a);i.removeSelectOption(c);}else{i.massAddSelectOption(a,n1);i.massAddSelectOption(c,o1);}}}function j1(n1,r,o1){if(n1&&(r.selectionVariant!==o1||s.sNavType==="initial")){var p1=n1.getParameterNames().concat(n1.getSelectOptionsPropertyNames());for(var i=0;i<p1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(p1[i]);}}}function k1(i,n1,o1){if(i.getParameter(n1)&&!i.getParameter(o1)){i.addParameter(o1,i.getParameter(n1));}if(i.getSelectOption(n1)&&!i.getSelectOption(o1)){var p1=i.getSelectOption(n1);p1.forEach(function(q1){i.addSelectOption(o1,q1.Sign,q1.Option,q1.Low,q1.High);});}}function l1(i){var n1=o.getOwnerComponent().getModel().getMetaModel();var o1=o.getOwnerComponent().getEntitySet();var p1=n1.getODataEntityType(n1.getODataEntitySet(o1).entityType);p1.property.forEach(function(q1){if(q1["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var r1=q1["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var s1=q1.name;k1(i,r1,s1);k1(i,s1,r1);}});}function m1(i,r,n1,o1){l1(i);j1(i,r,n1);h1(i.toJSONObject(),o1,false);}s.getCurrentAppState=F;return{areDataShownInTable:z,parseUrlAndApplyAppState:Y,getUrlParameterInfo:P,changeIappState:T,onSmartFilterBarInitialise:e1,onBeforeSFBVariantFetch:Z,onAfterSFBVariantSave:$,onAfterSFBVariantLoad:_,onAfterTableVariantSave:a1,onAfterApplyTableVariant:b1,isStateChange:c1,onSFBVariantInitialise:f1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,o,t){e(this,g(s,o,t));}});});
