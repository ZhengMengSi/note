/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/Routing","sap/fe/core/controllerextensions/FlexibleColumnLayout","sap/fe/core/controllerextensions/EditFlow","sap/ui/model/odata/v4/ODataListBinding","sap/fe/macros/field/FieldRuntime","sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/macros/CommonHelper","sap/m/MessageBox","sap/fe/core/BusyLocker","sap/fe/navigation/NavigationHelper","sap/fe/core/actions/messageHandling","sap/fe/core/FEHelper"],function(C,J,R,F,E,O,a,L,m,b,S,c,M,B,N,d,e){"use strict";var f;return C.extend("sap.fe.templates.ObjectPage.ObjectPageController",{routing:R,fcl:F,editFlow:E,onInit:function(){this.getView().setModel(this.editFlow.getUIStateModel(),"ui");this.getView().setModel(new J({sessionOn:false}),"localUI");var r=new J({visibility:false,items:null});this.getView().setModel(r,"relatedAppsModel");},getTableBinding:function(t){return t&&t._getRowBinding();},onBeforeBinding:function(o,p){var t=this,T=this._findTables(),g,h=this.byId("fe::op"),j=p.listBinding;if(h.getBindingContext()&&h.getBindingContext().hasPendingChanges()&&!(h.getBindingContext().getModel().hasPendingChanges("$auto")||h.getBindingContext().getModel().hasPendingChanges("$auto.associations"))){h.getBindingContext().getBinding().resetChanges();}for(var i=0;i<T.length;i++){g=T[i].getCreationRow();if(g){g.setBindingContext(null);}}var s=function(k){if(!p.bPersistOPScroll){h.setSelectedSection(null);h.detachModelContextChange(s);}};h.attachModelContextChange(s);if(j&&j.isA("sap.ui.model.odata.v4.ODataListBinding")){var P=t.byId("fe::paginator");if(P){P.setListBinding(j);}}if(!p.editable){var l=this.getView().getModel("localUI");if(l.getProperty("/sessionOn")===true){l.setProperty("/sessionOn",false);}}},onAfterBinding:function(o,p){var g=this.byId("fe::op"),t=this,h=o.getModel(),T=this._findTables(),i;o=g.getBindingContext();i=this.editFlow.computeEditMode(o);var u=function(){t._updateRelatedApps();o.getBinding().detachDataReceived(u);};o.getBinding().attachDataReceived(u);function j(l,n){var q=l.getCreationRow(),r,s;if(q){i.then(function(){if(q.getVisible()){r=h.bindList(n.getPath(),n.getContext(),[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});r.refreshInternal=function(){};s=r.create();q.setBindingContext(s);s.created().then(undefined,function(){L.trace("transient fast creation context deleted");});}});}}g._triggerVisibleSubSectionsEvents();function k(l){var n=t.getTableBinding(l);t.editFlow.handlePatchEvents(n);a.handlePatchEvents(n);j(l,n);}this.editFlow.handlePatchEvents(o).then(function(){T.forEach(function(l){l.done().then(k);});});a.handlePatchEvents(o);},onPageReady:function(p){var l=p.lastFocusedControl;if(l&&l.controlId&&l.focusInfo){var v=this.getView();var o=v.byId(l.controlId);if(o){o.applyFocusInfo(l.focusInfo);return;}}var g=this.byId("fe::op");var i=g.getModel("ui").getProperty("/editable")==="Display";var h;if(i){var A=g.getHeaderTitle().getActions();if(A.length){h=A.find(function(k){return k.mProperties["visible"];});if(h){h.focus();}}}else{var j=g._getFirstEditableInput();if(j){j.focus();}}},getPageTitleInformation:function(){var t=this;return new Promise(function(r,g){var o=t.byId("fe::op");var T={title:"",subtitle:"",intent:"",icon:""};var i=o.getCustomData().findIndex(function(j){return j.mProperties.key==="ObjectPageTitle";});var h=o.getCustomData().findIndex(function(j){return j.mProperties.key==="ObjectPageSubtitle";});if(o.getCustomData()[i].mProperties.value){T.title=o.getCustomData()[i].mProperties.value;}if(h>-1&&o.getCustomData()[h].getBinding("value")!==undefined){o.getCustomData()[h].getBinding("value").requestValue().then(function(v){T.subtitle=v;r(T);}).catch(function(){g();});}else{r(T);}});},executeHeaderShortcut:function(i){var s=this.getView().getId()+"--"+i,o=this.byId("fe::op").getHeaderTitle().getActions().find(function(g){return g.getId()===s;});b.fireButtonPress(o);},executeFooterShortcut:function(i){var s=this.getView().getId()+"--"+i,o=this.byId("fe::op").getFooter().getContent().find(function(g){return g.getMetadata().getName()==="sap.m.Button"&&g.getId()===s;});b.fireButtonPress(o);},executeTabShortCut:function(o){var g=this.byId("fe::op"),s=g.indexOfSection(this.byId(g.getSelectedSection())),h=g.getSections(),i=h.length-1,j=o.oSource.getCommand(),n;if(s!==-1&&i>0){if(j==="NextTab"){if(s<=i-1){n=h[++s];}}else{if(s!==0){n=h[--s];}}if(n){g.setSelectedSection(n);n.focus();}}},getFooterVisiblity:function(o){f=o.getParameter("iMessageLength");var l=this.getView().getModel("localUI");f>0?l.setProperty("/showMessageFooter",true):l.setProperty("/showMessageFooter",false);},showMessagePopover:function(o){var g=o.oMessagePopover,i=g.getBinding("items");if(i.getLength()>0){g.openBy(o);}},editDocument:function(){var o=this.getView().getModel("ui");B.lock(o);return this.editFlow.editDocument.apply(this.editFlow,arguments).finally(function(){B.unlock(o);});},saveDocument:function(o){var t=this,g=this.getView().getModel("ui");B.lock(g);return this.editFlow.saveDocument(o).then(function(){var h=t.getView().byId("MessageButton");var D={onAfterRendering:function(i){t.showMessagePopover(h);h.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};t._oDelegateOnAfter=D;h.addEventDelegate(D,t);}).catch(function(h){var i=t.getView().byId("MessageButton");if(i){t.showMessagePopover(i);}}).finally(function(){B.unlock(g);});},_updateRelatedApps:function(){var o=this.byId("fe::op");if(b.resolveStringtoBoolean(o.data("showRelatedApps"))){b.updateRelatedAppsDetails(o);}},_findTables:function(){var o=this.byId("fe::op"),t=[];function g(p,k){for(var l=0;l<p.length;l++){var P=p[l].getAggregation("items")&&p[l].getAggregation("items")[0],n=P&&P.getAggregation("content");if(n&&n.isA("sap.ui.mdc.Table")){t.push(n);if(n.getType().isA("sap.ui.mdc.table.GridTableType")&&!k.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){k.addStyleClass("sapUxAPObjectPageSubSectionFitContainer");}}}}var s=o.getSections();for(var h=0;h<s.length;h++){var i=s[h].getSubSections();for(var j=0;j<i.length;j++){g(i[j].getBlocks(),i[j]);g(i[j].getMoreBlocks(),i[j]);}}return t;},_mergePageAndLineContext:function(p,l){var o=m({},p,l),s=N.mixAttributesAndSelectionVariant(o,new S());return s;},handlers:{onFieldValueChange:function(o){this.editFlow.syncTask(o.getParameter("promise"));a.handleChange(o);},onRelatedAppsItemPressed:function(o,g){var h=o.getSource(),j=g&&g.getView()&&g.getView().getBindingContext();g.editFlow.getProgrammingModel(j).then(function(p){var P=function(){var k=h.getCustomData(),t,l,n;for(var i=0;i<k.length;i++){var q=k[i].getKey();var v=k[i].getValue();if(q=="targetSemObject"){t=v;}else if(q=="targetAction"){l=v;}else if(q=="targetParams"){n=v;}}n=N.removeSensitiveData(j,n);var r={target:{semanticObject:t,action:l},params:n};sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(r);};b.processDataLossConfirmation(P,h,p);});},onCallActionFromFooter:function(v,A,p){var o=v.getController();var t=o;return o.editFlow.onCallAction(A,p).then(function(){var g=t.getView().byId("MessageButton");if(g.isActive()){t.showMessagePopover(g);}else if(f){t._oDelegateOnAfter={onAfterRendering:function(h){t.showMessagePopover(g);g.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};g.addEventDelegate(t._oDelegateOnAfter,t);}}).catch(function(g){var h=t.getView().byId("MessageButton");if(h){t.showMessagePopover(h);}});},onDataFieldForIntentBasedNavigation:function(o,s,A,g,l,r){var h=o&&o.getView(),i=h&&h.getBindingContext();o.editFlow.getProgrammingModel(i).then(function(p){var P=function(){var j;var k={};var n={};if(r||l){if(o.getView().getAggregation("content")[0].getBindingContext()){k=N.removeSensitiveData(o.getView().getAggregation("content")[0].getBindingContext());}if(l){n=N.removeSensitiveData(l[0]);}j=o._mergePageAndLineContext(k,n);}if(g!="undefined"){j=e.setSemanticObjectMappings(j,g);}b.navigateToExternalApp(o.getView(),j,s,A);};b.processDataLossConfirmation(P,h,p);});},onChevronPressNavigateOutBound:function(o,s,g){var h=o&&o.getView(),i=h&&h.getBindingContext();return o.editFlow.getProgrammingModel(i).then(function(p){var P=function(){var j=o.routing.getOutbounds(),k,D=j[s],l=N.removeSensitiveData(o.getView().getAggregation("content")[0].getBindingContext()),n=N.removeSensitiveData(g);if(D){if(g){k=o._mergePageAndLineContext(l,n);}b.navigateToExternalApp(o.getView(),k,D.semanticObject,D.action,c.showNavigateErrorMessage);return Promise.resolve();}else{throw new Error("outbound target "+s+" not found in cross navigation definition of manifest");}};b.processDataLossConfirmation(P,h,p);});}}});});
