/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/TableDelegate","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/StableIdHelper","sap/fe/macros/field/FieldHelper","sap/ui/mdc/Table","sap/base/util/merge"],function(T,X,a,F,J,C,S,b,M,m){"use strict";M.prototype.rebindTable=function(){var o=sap.ui.getCore().byId(this.getFilter()),w=o&&(o.waitForInitialFiltersApplied||o.waitForInitialization);if(w){w.call(o).then(function(){this.bindRows(this.getRowsBindingInfo()||{});}.bind(this));}else{this.bindRows(this.getRowsBindingInfo()||{});}};var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var O=Object.assign({},T);function _(D){var n=(D.Value&&D.Value.$Path&&D.Value.$Path.lastIndexOf("/"))||-1,s=n===-1?"":D.Value.$Path.substring(0,n),p=n===-1?"":D.Value.$Path.substring(n+1);return{path:s,name:p};}function c(o,n,k,B,g){var p;if(!("$kind"in o)){var P=_(o);p=d(g.getObject(B+"/"+(P.path?P.path+"/":"")+P.name),P.path,P.name,B,g);}else{p=d(o,n,k,B,g);}return p;}function d(p,n,k,B,o){var P=(n?n+"/":"")+k,g=o.getObject(B+"/"+P+"@"),i=false,I=false,G=n?o.getObject(B+"/"+n+"@com.sap.vocabularies.Common.v1.Label")||o.getObject(B+"/"+n+"/@com.sap.vocabularies.Common.v1.Label")||o.getObject(B+"/"+n+"@sapui.name"):"",l=g["@com.sap.vocabularies.Common.v1.Label"]||k;i=g["@com.sap.vocabularies.UI.v1.Hidden"]||false;i=i===true||(i&&i["Bool"]!=="false");I=p.$Type&&p.$Type.indexOf("Edm.")!==0;if(i||I){return false;}return{name:P,path:P,groupLabel:G||null,group:n,label:l,description:g["@com.sap.vocabularies.Common.v1.Text"]&&g["@com.sap.vocabularies.Common.v1.Text"].$Path,maxLength:p.$MaxLength,precision:p.$Precision,scale:p.$Scale,type:p.$Type,filterable:true};}function e(B,o){return o.requestObject(B+"/@com.sap.vocabularies.UI.v1.LineItem").then(function(l){return l.filter(function(D){switch(D.$Type){case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataFieldDefault":case"com.sap.vocabularies.UI.v1.DataPoint":return true;case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":default:return false;}}).map(function(D){return c(D,null,null,B,o);});});}function f(E,n,B,o){return Promise.all([o.requestObject(E+"/"),o.requestObject(E+"@"),e(B,o)]).then(function(r){if(!r[0]&&!r[1]){return Promise.resolve([]);}var g=r[0],h=r[1],s=h["@Org.OData.Capabilities.V1.SortRestrictions"]||{},i=(s["NonSortableProperties"]||[]).map(function(l){return l["$PropertyPath"];}),j,p,k=r[2],I=function(l){return l.path===p.path;};for(var K in g){j=g[K];if(j&&j.$kind==="Property"){p=c(j,n,K,B,o);if(p!==false){if(k.some(I)){continue;}p.sortable=i.indexOf(K)==-1;k.push(p);}}}return k;});}O.rebindTable=function(t,B,s){if(s){B.parameters.$search=s;}else{delete B.parameters.$search;}T.rebindTable(t,B,s);};O.fetchProperties=function(t){var o=t.getDelegate()&&t.getDelegate().payload,E,g,h;E=t.data("targetCollectionName");g=t.getModel(o.model);h=g.getMetaModel();return f(E,"",E,h);};O.updateBindingInfo=function(o,B){if(B.binding&&!B.binding.isSuspended()){B.suspended=false;}T.updateBindingInfo.call(T,o,B);};O.beforeAddColumnFlex=function(p,t,P){var o=P.appComponent&&P.appComponent.getModel().getMetaModel(),g=P.modifier,i=g.targets==="xmlTree",v=false,s=g.getId(t),h=(!i&&P.view.getController())||undefined,j,V,k,l;if(!o){return Promise.resolve(null);}if(i){j=t.getAttributeNS(N,"targetCollectionName");}else{j=t.data("targetCollectionName");}k=o.createBindingContext(j);var n=j+"/"+p,q=o.createBindingContext(n);V=Promise.all([o.requestObject(n+"@com.sap.vocabularies.Common.v1.ValueListReferences"),o.requestObject(n+"@com.sap.vocabularies.Common.v1.ValueListMapping"),o.requestObject(n+"@com.sap.vocabularies.Common.v1.ValueList")]).then(function(R){var w=R[0]||R[1]||R[2];if(w){var x=b.valueHelpProperty(q),G=S.generate([S.generate([g.getId(t),"TableVH"]),p]);if(x.indexOf("$Path")>-1){x=o.getObject(x);}if(n!==x){G=S.generate([G,x]);}v=g.getAggregation(t,"dependents").some(function(D){return g.getId(D)===G;});if(!v){return r("sap.fe.macros.table.ValueHelp");}}return Promise.resolve();});function r(w){var x=X.loadTemplate(w,"fragment"),y=new J({id:s});return a.process(x,{name:w},{bindingContexts:{"collection":k,"item":q,"this":y.createBindingContext("/")},models:{"this":y,"collection":o,"item":o}}).then(function(x){var V=x.getElementsByTagNameNS("sap.ui.mdc.field","FieldValueHelp")[0];if(!i&&V){V=F.load({definition:x});}return V;}).then(function(V){if(V){g.insertAggregation(t,"dependents",V,0);}});}function u(w,H){var x=X.loadTemplate(w,"fragment"),y;if(i){y=new J({editMode:"{"+t.getAttributeNS(N,"editModePropertyBinding")+"}",onCallAction:t.getAttributeNS(N,"onCallAction"),tableType:t.getAttributeNS(N,"tableType"),parentControl:"Table",id:s,onChange:t.getAttributeNS(N,"onChange"),navigationPropertyPath:p});}else{y=new J({editMode:"{"+t.data("editModePropertyBinding")+"}",onCallAction:t.data("onCallAction"),tableType:t.data("tableType"),parentControl:"Table",id:s,onChange:t.data("onChange"),navigationPropertyPath:p});}return a.process(x,{name:w},{bindingContexts:{"collection":k,"dataField":q,"this":y.createBindingContext("/")},models:{"this":y,"collection":o,"dataField":o}}).then(function(x){var l=x.getElementsByTagNameNS("sap.ui.mdc.table","Column")[0];if(i){return l;}return F.load({definition:x,controller:H});});}l=V.then(u.bind(this,"sap.fe.macros.table.ColumnProperty",h));return l;};return O;},false);
