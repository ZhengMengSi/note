/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/FilterBarDelegate","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/StableIdHelper","sap/fe/macros/field/FieldHelper","sap/base/util/ObjectPath","sap/ui/mdc/odata/v4/FieldBaseDelegate","sap/ui/model/odata/type/String","sap/fe/macros/ResourceModel","sap/base/util/merge"],function(F,X,a,b,J,C,S,c,O,d,e,R,m){"use strict";var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",f=Object.assign({},F),v=[],D={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"},E="$editState";function _(p){var I=true;switch(p.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":I=false;break;}if(p.type&&p.type.indexOf("Boolean")>0){I=false;}return I;}function g(){return{name:E,path:E,groupLabel:null,group:null,label:R.getText("filterbar.EDITING_STATUS"),tooltip:null,hiddenFilter:false,type:"sap.ui.model.odata.type.String",baseType:new e(),defaultFilterConditions:[{fieldPath:"$editState",operator:"DRAFT_EDIT_STATE",values:["0"]}]};}function t(o){var T={id:o.data("localId"),draftEditStateModelName:o.data("draftEditStateModelName")};return h("sap.fe.macros.filter.EditState",T,{models:{"this.i18n":R.getModel()}});}function h(s,T,n){var o=X.loadTemplate(s,"fragment"),p=new J(T);n=m({},n,{bindingContexts:{"this":p.createBindingContext("/")},models:{"this":p}});return a.process(o,{name:s},{bindingContexts:n.bindingContexts,models:n.models}).then(function(o){if(n.isXml){return o.firstElementChild;}return b.load({definition:o});});}function i(p,n,K,B,M){var P=M.getObject(n+"/"+K+"@"),o,q,I,r,s,u,w,x,G=n!==B?M.getObject(n+"@com.sap.vocabularies.Common.v1.Label")||M.getObject(n+"/@com.sap.vocabularies.Common.v1.Label")||M.getObject(n+"@sapui.name"):"",L=P["@com.sap.vocabularies.Common.v1.Label"]||K,y=n.substr(B.length);I=C.getBoolAnnotationValue(P["@com.sap.vocabularies.UI.v1.Hidden"]);s=p.$Type&&p.$Type.indexOf("Edm.")!==0;if(I||s){return false;}r=C.getBoolAnnotationValue(P["@com.sap.vocabularies.UI.v1.HiddenFilter"]);u=C.getBoolAnnotationValue(P["@com.sap.vocabularies.Common.v1.IsDigitSequence"]);if(p.$MaxLength||p.$Precision||p.$Scale||u){w={};if(p.$MaxLength){w.maxLength=p.$MaxLength;}if(p.$Precision){w.precision=p.$Precision;}if(p.$Scale){w.scale=p.$Scale;}if(u){w.isDigitSequence=u;}}else{w=null;}q=P["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(q){o=q["$"+D[p.$Type]];}if(y.indexOf("/")===0){y=y.substr(1);}var z,A,H;if(y.split("/").length>1){H=B+"/"+y.substr(0,y.lastIndexOf("/"));z=M.getObject(H+"@com.sap.vocabularies.Common.v1.Label")||M.getObject(H+"/@com.sap.vocabularies.Common.v1.Label");A=G;G=z+" > "+A;}if(y){y=y+"/";}y=y+K;x={name:y,path:y,groupLabel:G||null,group:n,label:L,tooltip:P["@com.sap.vocabularies.Common.v1.QuickInfo"]||null,hiddenFilter:r,type:d.getDataTypeClass({},p.$Type)};if(p.$Type==="Edm.DateTimeOffset"){if(!w){w={};}w.V4=true;}if(w){x.constraints=w;}if(o){x.defaultFilterConditions=[{fieldPath:K,operator:"EQ",values:[o]}];}var Q=O.get(x.type||"");if(Q){x.baseType=new Q(x.formatOptions,x.constraints);}return x;}function j(s,n,B,M){return Promise.all([M.requestObject(s+"/"),M.requestObject(s+"@")]).then(function(r){var o=r[0],p=r[1];if(!o){return Promise.resolve([]);}var q,P,u=[],w=[],x=[],y=[],A={},z=p["@Org.OData.Capabilities.V1.FilterRestrictions"];if(z){if(z.NonFilterableProperties){w=z.NonFilterableProperties.map(function(G){return G.$PropertyPath;});}if(z.RequiredProperties){x=z.RequiredProperties.map(function(G){return G.$PropertyPath;});}if(z.FilterExpressionRestrictions){z.FilterExpressionRestrictions.forEach(function(G){A[G.Property.$PropertyPath]=G.AllowedExpressions;});}}z=M.getObject(s+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(z){y=z.map(function(G){return G.$PropertyPath;});}for(var K in o){q=o[K];if(q){if(q.$kind==="Property"){if(w.indexOf(K)>=0){continue;}P=i(q,n,K,B,M);if(P!==false){P.required=x.indexOf(K)>=0;P.visible=y.indexOf(K)>=0;if(A[K]){P.filterExpression=A[K];}else{P.filterExpression="auto";}P.maxConditions=_(P)?-1:1;u.push(P);}}}}return u;});}function k(){this.filterBar.detachModelContextChange(k,this);var M=this.modelName,o=this.filterBar.getModel(M);if(o){this.resolve(o);}else{this.filterBar.attachModelContextChange(k,this);}}function l(o){return new Promise(function(r,n){var M=o.getDelegate().payload&&o.getDelegate().payload.modelName,p={modelName:M,filterBar:o,resolve:r};k.call(p);});}f.beforeAddFilterFlex=function(p,o,P){if(p===E){return t(o);}var M=P.appComponent&&P.appComponent.getModel().getMetaModel(),n=P.modifier,I=n.targets==="xmlTree",s;if(!M){return Promise.resolve(null);}if(I){s="/"+o.getAttributeNS(N,"entitySet");}else{s="/"+o.data("entitySet");}var q=s+"/"+p,r,u,w=p.indexOf("/")>=0?p.substring(0,p.lastIndexOf("/")):"";u=w?S.generate([n.getId(o),"FF",w]):S.generate([n.getId(o),"FF"]);r=w?S.generate([n.getId(o),"FFVH",w]):S.generate([n.getId(o),"FFVH"]);var x=M.createBindingContext(q),T={bindingContexts:{"entitySet":M.createBindingContext(s),"property":x},models:{"entitySet":M,"property":M},isXml:I};function y(A){var B={idPrefix:r,conditionModel:"$filters>/conditions/"+p,navigationPrefix:w?"/"+w:""};return h("sap.fe.macros.ValueHelp",B,A).then(function(V){if(V){n.insertAggregation(o,"dependents",V,0);}});}function z(A){var B={idPrefix:u,vhIdPrefix:r,propertyPath:p,navigationPrefix:w?"/"+w:""};return h("sap.fe.macros.FilterField",B,A);}return Promise.all([M.requestObject(q+"@com.sap.vocabularies.Common.v1.ValueListReferences"),M.requestObject(q+"@com.sap.vocabularies.Common.v1.ValueListMapping"),M.requestObject(q+"@com.sap.vocabularies.Common.v1.ValueList")]).then(function(A){var V=Promise.resolve();var B=A[0]||A[1]||A[2];if(B){var G=c.valueHelpProperty(x),H=p.indexOf("/")>=0?p.substring(p.lastIndexOf("/")+1):p,K=S.generate([r,H]);if(q!==G){K=S.generate([K,G]);}var L=n.getAggregation(o,"dependents").some(function(Q){return n.getId(Q)===K;});if(!L){V=y(T);}}return V;}).then(z.bind(this,T));};f.fetchProperties=function(o){var s=o.data("entitySet"),n="/"+s,M;return l(o).then(function(p){if(!p){return[];}M=p.getMetaModel();if(o.getBindingContext()){n=C.getTargetCollection(o.getBindingContext(),s);}v.push(M.getObject(n+"/@sapui.name"));return j(n,n,n,M).then(function(P){if(o.data("draftEditStateModelName")){P.push(g());}return P;});});};return f;},false);
