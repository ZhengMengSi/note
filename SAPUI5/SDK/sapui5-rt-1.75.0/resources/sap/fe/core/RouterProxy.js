/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ui/core/routing/HashChanger","sap/ui/base/EventProvider"],function(L,B,A,H,E){"use strict";var e={EQUAL:0,COMPATIBLE:1,ANCESTOR:2,DIFFERENT:3};return B.extend("sap.fe.core.RouterProxy",{bIsRebuildHistoryRunning:false,bIsComputingTitleHierachy:false,oNavigationGuardState:null,bIsGuardCrossAllowed:false,init:function(a){this._oRouter=a.getRouter();this._oManagedHistory=[];this._sFlpAppName=sap.ushell.Container.getService("URLParsing").splitHash(window.location.hash).shellPart;var c=this._oRouter.getHashChanger().getHash();this._oManagedHistory.push(this._extractStateFromHash(c));history.replaceState(Object.assign({feLevel:0},history.state),null,window.location);},navToHash:function(h){var t=this,l=sap.ui.getCore().getCurrentFocusedControlId(),s=l&&sap.ui.getCore().byId(l)?sap.ui.getCore().byId(l).getFocusInfo():null,a=window.location.hash;var n=this._extractStateFromHash(h);if(!this._checkNavigationGuard(n)){if(!this.oResourceBundle){this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");}if(!confirm(this.oResourceBundle.getText("SAPFE_EXIT_NOTSAVED_MESSAGE"))){return Promise.resolve();}this.bIsGuardCrossAllowed=true;}this._pushNewState(n);return this._rebuildBrowserHistory(h).then(function(){t.storeFocusForHash(l,s,a);});},storeFocusForHash:function(l,s,a){var m=this._oManagedHistory;for(var i=0;i<m.length;i++){var h="#"+m[i].hash;if(a===h||h===a+"&/"){m[i].oLastFocusControl={controlId:l,focusInfo:s};break;}}},navTo:function(r,p){var h=this._oRouter.getURL(r,p);return this.navToHash(h);},exitFromApp:function(){return new Promise(function(r,a){var x=sap.ushell.Container.getService("CrossApplicationNavigation");x.backToPreviousApp();r();});},isCurrentStateImpactedBy:function(h){var s=this._extractStateFromHash(h);return this._compareCacheStates(s,this._oManagedHistory[this._oManagedHistory.length-1])!==e.DIFFERENT;},computeTitleHierarchy:function(d){var t=this;var v=d.oView;var a=d.oAppComponent;if(this.bIsComputingTitleHierachy==true){L.warning("computeTitleHierarchy already running ... Add this call to the pool");if(!this.computeHistoryHierarchyPool){this.computeHistoryHierarchyPool=[];}this.computeHistoryHierarchyPool.push(d);}this.bIsComputingTitleHierachy=true;var c=v.getParent();if(c&&c.getPageTitleInformation){c.getPageTitleInformation().then(function(T){var h=t._oManagedHistory.concat();var D=location.hash;if(t._oRouter.getHashChanger().getHash()===""&&location.hash.indexOf("&/")===-1){D+="&/";}var b=[];var o;var C;var p=[];var s="";var _="";var V=[];if(t.bTitleHierarchyForceDeepLink===true||(h.length===1&&t._oRouter.getHashChanger().getHash()!=="")){var f;var M=a.getModel();t.bTitleHierarchyForceDeepLink=true;p=D.split("/").filter(Boolean);p.forEach(function(j,i){if(i>0){_=M.getMetaModel().getObject("/$EntityContainer/"+(s+=j.split("(")[0]+"/")+"$Type@com.sap.vocabularies.UI.v1.HeaderInfo/TypeName");if(_!==undefined){V.push(_);}}});for(var m=0;m<p.length;m++){o={};f="";if(m===0){o.oTitleInfo={title:a.getMetadata().getManifestEntry("sap.app").title||"",subtitle:a.getMetadata().getManifestEntry("sap.app").appSubTitle||"",intent:p[0].endsWith("&")?p[0].substr(0,p[0].length-1):p[0],icon:""};b.push(o);}else{for(var g=0;g<=m;g++){f+=p[g]+(g!==m?"/":"");}o.oTitleInfo={title:V[m-1]||"",subtitle:"",intent:f,icon:""};if(V[m-1]===T.title){o.oTitleInfo.subtitle=T.subtitle;}b.push(o);}}if(p.length===1){b[0]={};}return{history:b,titleinfo:T};}else{for(var i=0;i<h.length;i++){C="#"+h[i].hash;if(C===D){T.intent=D;h[i].oTitleInfo=T;if(h.length!==1&&t._oRouter.getHashChanger().getHash()!==""){b.push(h[i]);}return{history:b,titleinfo:T};}else{if(h[i].hash.split("/").length===2&&h[i].hash.split("/")[1]===""){h[i].oTitleInfo={title:a.getMetadata().getManifestEntry("sap.app").title||"",subtitle:"",intent:"#"+h[i].hash,icon:""};}else{if(h[i].oTitleInfo===undefined){h[i].oTitleInfo=T;}}}if(h.length>1){b.push(h[i]);}}}}).then(function(d){var s=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");var S=(s&&d.history&&d.titleinfo&&s.createInstance({scopeObject:a,scopeType:"component"}))||Promise.reject();S.catch(function(){L.warning("No ShellService available");});var h=d.history===undefined?[]:d.history;var T=d.titleinfo===undefined?{}:d.titleinfo;S.then(function(o){var _=[];var b=h.reverse();for(var i=0;i<b.length;i++){if(i>0){if(b[i].oTitleInfo.title!=b[i-1].oTitleInfo.title){_.push(b[i].oTitleInfo);}}else{_.push(b[i].oTitleInfo);}}o.setHierarchy([]);o.setTitle(T.title);if(!(T.intent.split("/").length===2&&T.intent.split("/")[1]==="")){o.setHierarchy(_);}t.bIsComputingTitleHierachy=false;if(t.computeHistoryHierarchyPool&&t.computeHistoryHierarchyPool.length>0){var d=t.computeHistoryHierarchyPool[0];t.computeHistoryHierarchyPool.shift();t.computeTitleHierarchy(d);}},function(o){L.warning("No ShellService available");});}).catch(function(o){L.error("computeTitleHierarchy: Error while updating Title Hierarchy");});}},isNavigationFinalized:function(){return!this.bIsRebuildHistoryRunning;},setNavigationGuard:function(){var i=this._oManagedHistory.length-1;while(i>0&&this._compareStateKeys(this._oManagedHistory[i-1],this._oManagedHistory[i])){i--;}this.oNavigationGuardState=this._oManagedHistory[i];this.bIsGuardCrossAllowed=false;},discardNavigationGuard:function(){this.oNavigationGuardState=null;},checkHashWithGuard:function(h){if(this.oNavigationGuardState===null){return true;}var n=this._extractStateFromHash(h);return this._checkNavigationGuard(n);},isGuardCrossAllowedByUser:function(){return this.bIsGuardCrossAllowed;},_checkNavigationGuard:function(s){if(this.oNavigationGuardState===null){return true;}var c=this._compareCacheStates(this.oNavigationGuardState,s);return c!==e.DIFFERENT;},_extractStateFromHash:function(h){var s={keys:[]};var a=h.split("?")[0];var t=a.split("/");t.forEach(function(T){var r=/[^\(\)]+\([^\(\)]+\)/;if(r.test(T)){T=T.substring(0,T.length-1);var n={keyID:T.split("(")[0]};var k=T.split("(")[1].split(",");if(k.length>1){k.forEach(function(v){var b=v.split("=");n[b[0]]=b[1];});}else{n["ID"]=T.split("(")[1];}s.keys.push(n);}});var l=h.match(/\?.*layout=([^&]*)/);s.sLayout=l&&l.length>1?l[1]:null;if(s.sLayout==="MidColumnFullScreen"){s.screenMode=1;}else if(s.sLayout==="EndColumnFullScreen"){s.screenMode=2;}else{s.screenMode=0;}s.hash=this._sFlpAppName+"&/"+h;return s;},_pushNewState:function(n){if(history.state&&history.state.feLevel){while(this._oManagedHistory.length>0&&this._oManagedHistory.length>history.state.feLevel+1){this._oManagedHistory.pop();}}var l;while(this._oManagedHistory.length>0&&this._compareCacheStates(this._oManagedHistory[this._oManagedHistory.length-1],n)!==e.ANCESTOR){l=this._oManagedHistory[this._oManagedHistory.length-1].oLastFocusControl;this._oManagedHistory.pop();}n.oLastFocusControl=l;this._oManagedHistory.push(n);},_disableEventOnHashChange:function(){this._oRouter.stop();},_enableEventOnHashChange:function(i){this._oRouter.initialize(i);},_rebuildBrowserHistory:function(n){var t=this;return new Promise(function(r,a){if(t.bIsRebuildHistoryRunning===true){L.warning("_rebuildBrowserHistory already running ... Add this call to the pool");if(!t.rebuildHistoryPool){t.rebuildHistoryPool=[];}t.rebuildHistoryPool.push(n);return;}t.bIsRebuildHistoryRunning=true;function b(){if(t._oManagedHistory[0].hash.indexOf("&/")===-1){t._oManagedHistory[0].hash+="&/";}var s=Object.assign({},history.state);s.sap=Object.assign({},history.state.sap);if(!s.sap.history){s.sap.history=[];}if(t._oManagedHistory.length===1){t._enableEventOnHashChange(true);window.location.replace("#"+t._oManagedHistory[0].hash);history.replaceState(Object.assign(s,{feLevel:0}),null,"#"+t._oManagedHistory[0].hash);}else{history.replaceState(Object.assign(s,{feLevel:0}),null,"#"+t._oManagedHistory[0].hash);var i=1;while(i<t._oManagedHistory.length-1){s.sap.history=s.sap.history.concat();s.sap.history.push(t._oManagedHistory[i].hash);history.pushState(Object.assign(s,{feLevel:i}),null,"#"+t._oManagedHistory[i].hash);i++;}t._enableEventOnHashChange(true);window.location="#"+t._oManagedHistory[i].hash;s.sap.history=s.sap.history.concat();s.sap.history.push(t._oManagedHistory[i].hash);history.replaceState(Object.assign(s,{feLevel:t._oManagedHistory.length-1}),null,"#"+t._oManagedHistory[i].hash);}t.bIsRebuildHistoryRunning=false;if(t.rebuildHistoryPool&&t.rebuildHistoryPool.length>0){t._rebuildBrowserHistory(t.rebuildHistoryPool[0]);t.rebuildHistoryPool.shift();}r();}function c(){if(history.state.feLevel===0){window.removeEventListener("popstate",c);b();}else{history.back();}}t._disableEventOnHashChange();if(history.state.feLevel===undefined){window.addEventListener("popstate",c);history.back();}else if(history.state.feLevel!==0){window.addEventListener("popstate",c);history.go(-history.state.feLevel);}else{b();}});},_compareCacheStates:function(s,S){if(s.keys.length>S.keys.length){return e.DIFFERENT;}var a=true;var i;for(i=0;a&&i<s.keys.length;i++){if(s.keys[i].keyID!==S.keys[i].keyID||s.keys[i].ID!==S.keys[i].ID){a=false;}}if(!a){return e.DIFFERENT;}if(s.keys.length<S.keys.length||s.screenMode<S.screenMode){return e.ANCESTOR;}if(s.screenMode>S.screenMode){return e.DIFFERENT;}for(i=0;a&&i<s.keys.length;i++){if(s.keys[i].IsActiveEntity!==S.keys[i].IsActiveEntity){a=false;}}if(!a||s.sLayout!==S.sLayout){return e.COMPATIBLE;}else{return e.EQUAL;}},_compareStateKeys:function(s,S){if(s.keys.length!=S.keys.length){return false;}var a=true;var i;for(i=0;a&&i<s.keys.length;i++){if(s.keys[i].keyID!==S.keys[i].keyID||s.keys[i].ID!==S.keys[i].ID){a=false;}}return a;},checkIfBackIsOutOfGuard:function(){var t=this,p=this._sFlpAppName+"&/"+t._oRouter.getHashChanger().getHash();if(t.oNavigationGuardState&&t._oManagedHistory&&t._oManagedHistory.length>1){var P;for(var i=0;i<t._oManagedHistory.length;i++){if(t._oManagedHistory[i].hash===p){if(t._oManagedHistory[i-1]&&t._oManagedHistory[i-1].hash){P=t._oManagedHistory[i-1]&&typeof t._oManagedHistory[i-1].hash==="string"&&t._oManagedHistory[i-1].hash;}break;}}return!t.checkHashWithGuard(P.split(this._sFlpAppName+"&/")[1]);}}});});
