/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/actions/messageHandling","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/sticky","sap/fe/core/TransactionHelper","sap/base/Log","sap/m/Text","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/routing/HashChanger","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker"],function(C,m,X,a,F,s,T,L,b,B,D,J,H,c,d){"use strict";var f="sap.fe.core.controls.field.DraftPopOverAdminData",p=X.loadTemplate(f,"fragment"),u={},t={};var E=C.extend("sap.fe.core.controllerextensions.EditFlow",{_oTransactionHelper:null,syncTask:function(v){var n;if(v instanceof Promise){n=function(){return v;};}else if(typeof v==="function"){n=v;}this._pTasks=this._pTasks||Promise.resolve();if(!!n){this._pTasks=this._pTasks.then(n).catch(function(){return Promise.resolve();});}return this._pTasks;},getProgrammingModel:function(o){return this.getTransactionHelper().getProgrammingModel(o);},createDocument:function(l,P){var e=this,g=this.getTransactionHelper();function h(o,i){i.then(function(n){var j=e.base.getView().getBindingContext();if(!c.hasTransientContext(o)){e.requestSideEffects(o.getPath(),j);}});}return this.syncTask().then(function(){return new Promise(function(r,i){var G,j,o,M;P=P||{};if(typeof l==="object"){G=Promise.resolve(l);}else{throw new Error("Binding object expected");}G.then(function(k){o=k;M=o.getModel();var n=P.creationMode;if((!n||n==="NewPage")&&e.base.getView().getViewData()._creationMode==="Inplace"){n="Inline";}return g.getProgrammingModel(o).then(function(q){j=q;if(n&&n!=="NewPage"){return n;}else{switch(j){case"Draft":case"Sticky":if(!o.isRelative()){var v=M.getMetaModel(),w=o.getPath(),N=j==="Draft"?v.getObject(w+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction"):v.getObject(w+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction"),x=(N&&v.getObject("/"+N+"/@$ui5.overload/0/$Parameter"))||[];if(x.length>1){return"Deferred";}}return"Async";case"NonDraft":return"Sync";}}});}).then(function(k){var n,A,q=P.creationRow,v,V=Promise.resolve();if(k!=="Deferred"){if(k==="CreationRow"){P.data=P.creationRow.getBindingContext().getObject();v=q.getBindingContext();V=e.checkForValidationErrors(v);}if(k==="CreationRow"||k==="Inline"){P.keepTransientContextOnFailed=true;P.busyMode="Local";if(k==="CreationRow"){P.busyMode="None";}if(k==="Inline"){P.keepTransientContextOnFailed=false;}e.handleCreateEvents(o);}n=V.then(function(){if(!P.parentControl){P.parentControl=e.base.getView();}return g.createDocument(o,P);});}var N=new Promise(function(r){switch(k){case"Deferred":e.base.routing.navigateForwardToContext(o,{deferredContext:true,noHistoryEntry:P.noHistoryEntry,editable:true}).then(function(){r();});break;case"Async":e.base.routing.navigateForwardToContext(o,{asyncContext:n,noHistoryEntry:P.noHistoryEntry,editable:true}).then(function(){r();});break;case"Sync":A={noHistoryEntry:P.noHistoryEntry,editable:true};if(j=="Sticky"){A.transient=true;}n.then(function(x){if(!x){var R,y;R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");y=c.getAppComponent(e.base.getView()).getRootControl();e.base.routing.navigateToMessagePage(R.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:R.getText("SAPFE_ERROR"),description:R.getText("SAPFE_CREATION_FAILED_DESCRIPTION"),navContainer:y});}else{e.base.routing.navigateForwardToContext(x,A).then(function(){r();});}});break;case"Inline":h(o,n);r();break;case"CreationRow":V.then(function(){var x=v.getBinding(),y;h(o,n);y=x.create();q.setBindingContext(y);v.created().then(undefined,function(){L.trace("transient fast creation context deleted");});v.delete("$direct");});r();break;}});var w=e.base.getView().getModel("localUI");if(j==="Sticky"){w.setProperty("/sessionOn",true);}if(n){Promise.all([n,N]).then(function(x){e.setEditMode("Editable",true);var y=x[0];if(y){e.base.routing.setUIStateDirty();if(j==="Sticky"){e._handleStickyOn(y);}}r();},function(){i();});}else{r();}});});});},editDocument:function(o){var e=this,g=this.getTransactionHelper();return g.editDocument(o).then(function(n){g.getProgrammingModel(o).then(function(P){var N;if(P==="Sticky"){var l=e.base.getView().getModel("localUI");l.setProperty("/sessionOn",true);N=true;}e.setEditMode("Editable",false);if(n!==o){e.handleNewContext(n,true,N,true,true,true).then(function(){if(P==="Sticky"){e._handleStickyOn(n);}});}});});},saveDocument:function(o){var e=this,g=this.getTransactionHelper();return(this.syncTask().then(this._submitOpenChanges.bind(this,o)).then(this.checkForValidationErrors.bind(this,o)).then(g.saveDocument.bind(g,o)).then(function(A){return g.getProgrammingModel(o).then(function(P){var n;if(P==="Sticky"){var l=e.base.getView().getModel("localUI");l.setProperty("/sessionOn",false);var h=A.getModel().bindContext(A.getPath(),undefined,{$$groupId:"$auto"});A=h.getBoundContext();e._handleStickyOff(o);if(o.getPath()===A.getPath()){n=true;}}e.setEditMode("Display",false);if(A!==o){e.handleNewContext(A,true,n,false,true,false);}});}));},cancelDocument:function(o,P){var e=this,g=this.getTransactionHelper();this.syncTask().then(g.cancelDocument.bind(g,o,P)).then(function(A){g.getProgrammingModel(o).then(function(h){var n;if(h==="Sticky"){var l=e.base.getView().getModel("localUI");l.setProperty("/sessionOn",false);e._handleStickyOff(o);n=true;}e.setEditMode("Display",false);if(!A){e.base.routing.setUIStateDirty();e.base.routing.navigateBackFromContext(o);}else{e.handleNewContext(A,true,n,false,true,true);}});});},requestSideEffects:function(n,o){var M=this.base.getView().getModel().getMetaModel(),e="/"+M.getObject(M.getMetaPath(o.getPath()))["$Type"],A=M.getObject(e+"@"),S=Object.keys(A).filter(function(j){return j.indexOf("@com.sap.vocabularies.Common.v1.SideEffects")>-1;}),g=[],P,h=[],i=[];S.forEach(function(j){var k=A[j];if(k.SourceEntities){k.SourceEntities.forEach(function(l){if(l["$NavigationPropertyPath"]===n){g.push(j);}});}if(k.SourceProperties&&g.indexOf(j)===-1){k.SourceProperties.forEach(function(l){if(g.indexOf(j)===-1&&l["$PropertyPath"].indexOf(n+"/")===0){g.push(j);}});}});g.forEach(function(j){var k=[],l=A[j],q=l.TargetProperties||[],r=l.TargetEntities||[];q=q.map(function(v){return v["$PropertyPath"];}).filter(function(v){return h.indexOf(v)<0;});q.forEach(function(v){var w=M.getObject(e+"/"+v+"@com.sap.vocabularies.Common.v1.Text");if(w&&w["$Path"]){k.push(w["$Path"]);}});r=r.map(function(v){return v["$NavigationPropertyPath"];}).filter(function(v){return i.indexOf(v)<0;});h=h.concat(q).concat(k);i=i.concat(r);});P=h.map(function(j){return{"$PropertyPath":j};}).concat(i.map(function(j){return{"$NavigationPropertyPath":j};}));if(P.length){o.requestSideEffects(P);}},deleteSingleDocument:function(o,P){var e=this;this._deleteDocumentTransaction(o,P).then(function(){e.base.routing.setUIStateDirty();e.base.routing.navigateBackFromContext(o);});},deleteMultipleDocuments:function(o,P){var e=this;this._deleteDocumentTransaction(o,P).then(function(){var g=e.getView().byId(P.controlId);if(g&&g.isA("sap.ui.mdc.Table")){g.clearSelection();}var h=e.base.getView().getBindingContext();if(h&&Array.isArray(o)){var l=o[0].getBinding();if(!c.hasTransientContext(l)){e.requestSideEffects(l.getPath(),h);}}e.base.routing.setUIStateDirty();var r=c.getAppComponent(e.base.getView()).getRouterProxy();var i=false;for(var j=0;!i&&j<o.length;j++){if(r.isCurrentStateImpactedBy(o[j].getPath())){i=true;e.base.routing.navigateBackFromContext(o[j]);}}});},_deleteDocumentTransaction:function(o,P){var e=this,l=this.base.getView().getModel("localUI"),g=this.getTransactionHelper();P=P||{};return this.syncTask().then(g.deleteDocument.bind(g,o,P,l)).then(function(){var l=e.base.getView().getModel("localUI");l.setProperty("/sessionOn",false);});},applyDocument:function(o){var e=this,U=this.base.getView().getModel("ui"),g=this.getTransactionHelper();d.lock(U);return this._submitOpenChanges(o).then(function(){m.showUnboundMessages();e.base.routing.navigateBackFromContext(o);return true;}).catch(function(h){var i=[];i.push({text:g.getText("SAPFE_APPLY_ERROR"),type:"Error"});m.showUnboundMessages(i);return false;}).finally(function(){d.unlock(U);});},_submitOpenChanges:function(o){var M=o.getModel();var P=[];P.push(M.submitBatch("$auto"));P.push(M.submitBatch("$auto.associations"));return Promise.all(P).then(function(){if(M.hasPendingChanges("$auto")||M.hasPendingChanges("$auto.associations")){return Promise.reject("submit of open changes failed");}});},_handleStickyOn:function(o){var e=this,A=c.getAppComponent(this.base.getView());if(!this.bStickyOn){this.bStickyOn=true;var h=H.getInstance().getHash(),l=this.base.getView().getModel("localUI");A.getRouterProxy().setNavigationGuard();if(sap.ushell){A.getService("ShellUIService").then(function(S){S.setBackNavigation(e.onBackNavigationInSession.bind(e));});this.fnDirtyStateProvider=function(){var g=H.getInstance().getHash(),r=A.getRouterProxy(),j,S=l.getProperty("/sessionOn");if(!S){return;}if(!r.isNavigationFinalized()){j=false;h=g;}else if(h===g){j=true;}else if(r.checkHashWithGuard(g)||r.isGuardCrossAllowedByUser()){h=g;j=false;}else{j=true;}if(j){setTimeout(function(){sap.ushell.Container.setDirtyFlag(false);},0);}return j;};sap.ushell.Container.registerDirtyStateProvider(this.fnDirtyStateProvider);}var i=this.base.getView().getModel("sap.fe.i18n");this.fnHandleSessionTimeout=function(){m.removeBoundTransitionMessages();m.removeUnboundTransitionMessages();var g=new D({title:"{sap.fe.i18n>OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new b({text:"{sap.fe.i18n>OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new B({text:"{sap.fe.i18n>SAPFE_OK}",type:"Emphasized",press:function(){e._handleStickyOff();e.base.routing.navigateBackFromContext(o);}}),afterClose:function(){g.destroy();}});g.addStyleClass("sapUiContentPadding");g.setModel(i,"sap.fe.i18n");e.base.getView().addDependent(g);g.open();};this.base.getView().getModel().attachSessionTimeout(this.fnHandleSessionTimeout);this.fnStickyDiscard=function(){var g=H.getInstance().getHash();if(!g||!A.getRouterProxy().checkHashWithGuard(g)){s.discardDocument(o);e._handleStickyOff();}};this.base.routing.attachOnAfterNavigation(this.fnStickyDiscard);}},_handleStickyOff:function(){var A=c.getAppComponent(this.base.getView());if(A.getRouterProxy){A.getRouterProxy().discardNavigationGuard();}if(sap.ushell){if(this.fnDirtyStateProvider){sap.ushell.Container.deregisterDirtyStateProvider(this.fnDirtyStateProvider);this.fnDirtyStateProvider=null;}}if(this.base.getView().getModel()&&this.fnHandleSessionTimeout){this.base.getView().getModel().detachSessionTimeout(this.fnHandleSessionTimeout);}this.base.routing.detachOnAfterNavigation(this.fnStickyDiscard);this.fnStickyDiscard=null;this.setEditMode("Display",false);this.bStickyOn=false;if(A.getService){A.getService("ShellUIService").then(function(S){S.setBackNavigation();});}},handleNewContext:function(o,n,N,e,P,U){this.base.routing.setUIStateDirty();return this.base.routing.navigateToContext(o,{noHistoryEntry:n,noHashChange:N,editable:e,bPersistOPScroll:P,useHash:U});},onCallAction:function(A,P){var e=this,g=this.getTransactionHelper();P.localUIModel=e.base.getView().getModel("localUI");if(!P.parentControl){P.parentControl=this.base.getView();}return this.syncTask().then(g.onCallAction.bind(g,A,P)).then(function(){if(P.contexts){e.base.routing.setUIStateDirty();}});},formatDraftOwnerText:function(e,g,h,i,j){var k="",l=this.getTransactionHelper();var U=g||e||i||h;if(j){k+=e?l.getText("DRAFTINFO_GENERIC_LOCKED_OBJECT_POPOVER_TEXT")+" ":l.getText("DRAFTINFO_LAST_CHANGE_USER_TEXT")+" ";}k+=U?l.getText("DRAFTINFO_OWNER",[U]):l.getText("DRAFTINFO_ANOTHER_USER");return k;},formatDraftOwnerTextInline:function(e,g,h,i){return this.formatDraftOwnerText(e,h,g,i,false);},formatDraftOwnerTextInPopover:function(e,g,h,i){return this.formatDraftOwnerText(e,h,g,i,true);},onDraftLinkPressed:function(e,g){var h=this,o=e.getSource(),i=o.getBindingContext(),v=this.base.getView(),M=v.getModel().getMetaModel(),j=v.getController(),O=function(){var P=h._oPopover.getModel("draftInfo");P.setProperty("/bIsActive",i.getProperty("IsActiveEntity"));P.setProperty("/bHasDraft",i.getProperty("HasDraftEntity"));h._oPopover.getModel().bindContext(i.getPath(),undefined,{$$groupId:"$auto"});h._oPopover.openBy(o);};if(!this._oPopover||!this._oPopover.oPopup){Promise.resolve(h._oFragment||a.process(p,{name:f},{bindingContexts:{entitySet:M.createBindingContext("/"+g)},models:{entitySet:M}})).then(function(k){h._oFragment=k;return F.load({definition:k,controller:j});}).then(function(P){h._oPopover=P;v.addDependent(h._oPopover);var k=new J({bIsActive:undefined,bHasDraft:undefined});h._oPopover.setModel(k,"draftInfo");O();});}else{O();}},closeDraftAdminPopover:function(){this._oPopover.close();},handlePatchEvents:function(o){var e=this.transactionStateModel;e.setProperty("/draftStatus","Clear");var g=this,h=this.getTransactionHelper();return h.getProgrammingModel(o).then(function(P){o=(o.getBinding&&o.getBinding())||o;o.attachEvent("patchSent",function(){h.handleDocumentModifications();g.base.routing.setUIStateDirty();if(P==="Draft"){e.setProperty("/draftStatus","Saving");}});o.attachEvent("patchCompleted",function(i){if(P==="Draft"){e.setProperty("/draftStatus",i.getParameter("success")?"Saved":"Clear");}m.showUnboundMessages();});});},handleCreateEvents:function(o){var e=this.transactionStateModel,g=this.getTransactionHelper();e.setProperty("/draftStatus","Clear");return g.getProgrammingModel(o).then(function(P){o=(o.getBinding&&o.getBinding())||o;o.attachEvent("createSent",function(){g.handleDocumentModifications();if(P==="Draft"){e.setProperty("/draftStatus","Saving");}});o.attachEvent("createCompleted",function(h){if(P==="Draft"){e.setProperty("/draftStatus",h.getParameter("success")?"Saved":"Clear");}m.showUnboundMessages();});});},handleErrorOfTable:function(e){if(e.getParameter("error")){setTimeout(m.showUnboundMessages,0);}},getUIStateModel:function(){var A,e=this,g=this.getTransactionHelper();if(!this.editFlowStateModel){A=c.getAppComponent(this.base.getView()).getId();if(!u[A]){u[A]=g.getUIStateModel();}else{g.setUIStateModel(u[A]);}this.transactionStateModel=u[A];this.editFlowStateModel=new J(this.transactionStateModel.getData());this.transactionStateModel.bindList("/").attachChange(function(){var h=e.editFlowStateModel.getProperty("/createMode");e.editFlowStateModel.setJSON(e.transactionStateModel.getJSON());e.editFlowStateModel.setProperty("/createMode",h);});}return this.editFlowStateModel;},computeEditMode:function(o){var e=this;return new Promise(function(r,g){var h=e.getUIStateModel(),i=e.transactionStateModel;e.getTransactionHelper().getProgrammingModel(o).then(function(P){if(P==="Draft"){o.requestObject("IsActiveEntity").then(function(I){if(I===false){i.setProperty("/editable","Editable");o.requestObject("HasActiveEntity").then(function(j){if(j){h.setProperty("/createMode",false);}else{h.setProperty("/createMode",true);}r();});}else{i.setProperty("/editable","Display");r();}});}else{r();}});});},setEditMode:function(e,g){var o=this.getUIStateModel(),h=this.transactionStateModel;if(e){h.setProperty("/editable",e);}if(g!==undefined){o.setProperty("/createMode",g);}},checkForValidationErrors:function(o){return this.syncTask().then(function(){var P=o.getPath(),M=sap.ui.getCore().getMessageManager().getMessageModel().getData(),e,g;for(var i=0;i<M.length;i++){g=M[i];if(g.validation){e=sap.ui.getCore().byId(g.getControlId());if(e&&e.getBindingContext()&&e.getBindingContext().getPath().indexOf(P)===0){return Promise.reject("validation errors exist");}}}});},getTransactionHelper:function(){if(!this._oTransactionHelper){var A=c.getAppComponent(this.base.getView()),e=A.getId();if(!t[e]){var h=new T();h.initialize(A);t[e]=h;}this._oTransactionHelper=t[e];}return this._oTransactionHelper;},onBackNavigationInSession:function(){var e=this,v=e.base.getView(),A=c.getAppComponent(v),r=A.getRouterProxy();if(r.checkIfBackIsOutOfGuard()){var o=v&&v.getBindingContext();e.getTransactionHelper().getProgrammingModel(o).then(function(g){c.processDataLossConfirmation(function(){history.back();},v,g);});return;}history.back();}});E.onExitApplication=function(A){u[A]=undefined;t[A]=undefined;};return E;});
