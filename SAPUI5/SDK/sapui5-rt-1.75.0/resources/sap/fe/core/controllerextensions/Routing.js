/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/mvc/ControllerExtension","sap/m/MessagePage","sap/m/Link","sap/m/MessageBox","sap/ui/core/routing/HashChanger","sap/base/Log","sap/fe/core/CommonUtils","sap/ui/base/BindingParser","sap/fe/core/BusyLocker","sap/fe/core/actions/messageHandling"],function(F,a,C,M,L,b,H,c,d,B,e,m){"use strict";var u,D,A,t,P,o=[],s,E,S=[],f,g,n=function(){c.debug("target binding of custom page or re-use component: "+s);};var h={CLEAN:0,PROCESSED:1,DIRTY:2};var k=C.extend("sap.fe.core.controllerextensions.Routing",{navigateToContext:function(i,p){p=p||{};var r=this._getOwnerComponent().getRootControl(),v=this.getView().getViewData(),j,T,l=null,R,q,w=this;if(p.targetPath&&v.navigation){q=v.navigation[p.targetPath].detail;T=q.route;if(q.parameters){l=this.prepareParameters(q.parameters,T,i);}}if(i.isA("sap.ui.model.odata.v4.ODataListBinding")){if(p.asyncContext){p.asyncContext.then(function(i){w.navigateToContext(i,{noHistoryEntry:true,noHashChange:p.noHashChange,useCanonicalPath:p.useCanonicalPath,editable:p.editable,bPersistOPScroll:p.bPersistOPScroll,updateFCLLevel:p.updateFCLLevel});});A=p.asyncContext;}else if(p.deferredContext){D=true;}else{throw"navigation to a list binding is not yet supported";}}else{if(i.getBinding()&&i.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){if(d.hasTransientContext(i.getBinding())){R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");b.show(R.getText("NAVIGATION_DISABLED_MESSAGE"),{icon:b.Icon.WARNING,title:R.getText("NAVIGATION_DISABLED_TITLE"),actions:[b.Action.CLOSE],details:R.getText("TRANSIENT_CONTEXT_DESCRIPTION"),contentWidth:"100px"});return Promise.resolve();}}u=i;}t=p.editable;P=p.bPersistOPScroll;if(p.useCanonicalPath){j=i.getCanonicalPath();}else if(i.isA("sap.ui.model.odata.v4.ODataListBinding")&&i.isRelative()){j=i.getHeaderContext().getPath();}else{j=i.getPath();}var x=this._getOwnerComponent().getRouterProxy();if(p.updateFCLLevel===-1){var y=new RegExp("/[^/]*$");j=j.replace(y,"");u=null;if(j.length===0&&E){return x.exitFromApp();}}var z=H.getInstance().getHash();var G=this._getOwnerComponent().getFcl();if(p.asyncContext||p.deferredContext){j+="(...)";}else if(S&&S.length&&g&&z.split("/").length===1&&z.indexOf("(...)")===-1&&j!==""&&!G.isFclEnabled()){var I=(i&&i.getPath().substring(0,i.getPath().indexOf("(")))||z.substring(0,z.indexOf("("));var J="";while(I.indexOf("/")===0){I=I.substr(1);}if(v.viewLevel===0){J=this._createHash(S,I,i);}else if(v.viewLevel===1&&z!==""){if(p.useHash){J=z;}else if(i&&i.getPath().split("/").length<=2){J=this._createHash(S,I,i);}}if(J!==""){if(z===J){this._bindTargetPage(r.getCurrentPage(),null,null,true);return Promise.resolve();}else if(J===undefined){if(p.useHash){this._bindTargetPage(r.getCurrentPage(),null,null,true);return Promise.resolve();}}else{j=J;}}}if(G.isFclEnabled()){var K=v.FCLLevel;if(p.updateFCLLevel){K+=p.updateFCLLevel;if(K<0){K=0;}}var N;if(p.sLayout){N=p.sLayout;}else if(q&&q.layout){N=G.getFCLLayout(K,j,q.layout);}else{N=G.getFCLLayout(K,j);}j+="?layout="+N;}while(j.indexOf("/")===0){j=j.substr(1);}if(p.noHashChange){if(G.isFclEnabled()){if(j===this._getOwnerComponent().getRouter().getHashChanger().getHash()){var O;switch(v.FCLLevel){case 0:O=r.getCurrentBeginColumnPage();break;case 1:O=r.getCurrentMidColumnPage();break;default:O=r.getCurrentEndColumnPage();break;}this._bindTargetPage(O,null,null,true);return Promise.resolve();}}else{this._bindTargetPage(r.getCurrentPage(),null,null,true);return Promise.resolve();}}if(T&&l!==null){this._getOwnerComponent().getRouter().navTo(T,l);}else if(p.transient&&p.editable==true){j=j.indexOf("(...)")>-1?j:j+"?i-action=create";}return x.navToHash(j);},prepareParameters:function(p,T,i){var j;try{var l=i.getPath();var q=l.split("/");j=Object.keys(p).reduce(function(R,v){var w=p[v];var x=B.complexParser(w);var y=x.parts||[x];var z=y.map(function(G){var I=G.path.split("../");var J=q.slice(0,q.length-I.length+1);J.push(I[I.length-1]);return i.getObject(J.join("/"));});if(x.formatter){R[v]=x.formatter.apply(this,z);}else{R[v]=z.join("");}return R;},{});}catch(r){c.error("Could not parse the parameters for the navigation to route "+T);j=undefined;}return j;},navigateBackFromContext:function(i,p){p=p||{};p.updateFCLLevel=-1;return this.navigateToContext(i,p);},navigateForwardToContext:function(i,p){p=p||{};p.updateFCLLevel=1;return this.navigateToContext(i,p);},setBreadcrumbLinks:function(j,l){if(l.length&&j!==null){if(j===undefined&&l[0].getBindingContext()!==null){l.forEach(function(w){w.setBindingContext(null);});return;}else if(j&&j.getPath()){var N=j.getPath();var p=l[l.length-1].getElementBinding()&&l[l.length-1].getElementBinding().getPath();if(p&&N.indexOf(p)>-1){return;}var q=H.getInstance().hrefForAppSpecificHash("");var r="",v=N.split("/");q=q.split("/")[0];v.shift();v.splice(-1,1);for(var i=0;i<l.length;i++){var w=l[i];r=r+"/"+v[i];w.setHref(q+r);w.bindElement({path:r,parameters:{$$groupId:"$auto.associations"}});}}}},navigateToMessagePage:function(i,p){if(H.getInstance().getHash().indexOf("i-action=create")>-1){var j=p.navContainer.getParent();var l=this.getEntitySet(j);var q=l+"(...)";var r=j.getRouterProxy();r.navToHash(q);return;}var N=p.navContainer||this._getOwnerComponent().getRootControl();if(!this.oMessagePage){this.oMessagePage=new M({showHeader:false,icon:"sap-icon://message-error"});N.addPage(this.oMessagePage);}this.oMessagePage.setText(i);if(p.technicalMessage){this.oMessagePage.setCustomDescription(new L({text:p.description||p.technicalMessage,press:function(){b.show(p.technicalMessage,{icon:b.Icon.ERROR,title:p.title,actions:[b.Action.OK],defaultAction:b.Action.OK,details:p.technicalDetails||"",contentWidth:"60%"});}}));}else{this.oMessagePage.setDescription(p.description||"");}N.to(this.oMessagePage);},setUIStateDirty:function(){k.flagUIState=h.DIRTY;},setUIStateProcessed:function(){k.flagUIState=h.PROCESSED;},resetUIState:function(){k.flagUIState=h.CLEAN;},isUIStateDirty:function(){return k.flagUIState!==h.CLEAN;},cleanProcessedUIState:function(){if(k.flagUIState===h.PROCESSED){k.flagUIState=h.CLEAN;}},initializeRouting:function(j){var l=this;return new Promise(function(r,q){var R=j.getRouter(),v,w=l.getEntitySet(j),x,y=j.getComponentData(),z=y&&y.startupParameters,G=j.getModel(),I=z!==undefined&&Object.keys(z).length!==0;u=null;D=false;A=null;t=false;P=null;o=[];E=false;l.resetUIState();var J=[];J.push(G.getMetaModel().requestObject("/$EntityContainer/"+w+"/"));J.push(G.getMetaModel().requestObject("/$EntityContainer/"+w+"/@"));J.push(G.getMetaModel().requestObject("/$EntityContainer/"+w+"@"));R.attachBeforeRouteMatched(function(){var N=j.getRootControl();e.lock(N);});v=function(K){var N=K.getParameters().arguments,T="",O,Q;l.fireOnAfterNavigation();var U=j.getRootControl();e.unlock(U);if(Object.keys(N).length>0){var V;if(K.getParameter("view").getComponentInstance&&K.getParameter("view").getComponentInstance()&&K.getParameter("view").getComponentInstance().getBindingContextPattern){V=K.getParameter("view").getComponentInstance().getBindingContextPattern();}T=V||K.getParameters().config.pattern;T=T.replace(":?query:","");for(var p in N){O=N[p];if(O==="..."){Q=true;t=true;}T=T.replace("{"+p+"}",O);}if(T&&T[0]!=="/"){T="/"+T;}}var W=K.getParameter("config").target;if(j.getFcl().isFclEnabled()&&typeof W==="object"&&W.length){j.getFcl().updateFCLLevels(W,K.getParameter("views"));W.forEach(function(i,Y){var Z=j.getFcl().getTargetAggregation()[i];if(Z.pattern!==undefined){T=j.getFcl().buildBindingContext(Z.pattern,N);}var $=K.getParameter("views")[Y];if($!=null){l._bindTargetPage($,T,Q,false,true);}else{throw new Error("No Container found for target "+i+"(Please check the Router configuration)");}});}else{l._bindTargetPage(U.getCurrentPage(),T,Q,false);}l.cleanProcessedUIState();var X;if(!history.state||history.state.feLevel===undefined){var _=H.getInstance().getHash();X=j.getRouterProxy().navToHash(_);}else{X=Promise.resolve();}Promise.all([l.waitForRightMostViewReady(K),X]).then(function(Y){var Z=Y[0];var j=d.getAppComponent(Z);var $=j.getRouterProxy();var a1={oView:Z,oAppComponent:j};$.computeTitleHierarchy(a1);var b1=$._oManagedHistory;var c1=window.location.hash;var d1;for(var i=b1.length-1;i>-1;i--){var e1="#"+b1[i].hash;if(c1===e1||e1===c1+"&/"){d1=b1[i].oLastFocusControl;break;}else{b1[i].oLastFocusControl=undefined;}}if(Z.getController().onPageReady){Z.getParent().onPageReady({lastFocusedControl:d1});}}).catch(function(){c.error("An error occurs while computing the title hierarchy and calling focus method");});};Promise.all(J).then(function(V){f=V[0];var i=V[1];g=V[2]["@com.sap.vocabularies.Common.v1.DraftRoot"]||V[2]["@com.sap.vocabularies.Common.v1.DraftNode"];var T=f["$Key"];S=i["@com.sap.vocabularies.Common.v1.SemanticKey"];if(I){if(z.preferredMode&&z.preferredMode[0]==="create"&&!H.getInstance().getHash()){if(w){x=w+"(...)";}else{c.error("Cannot handle this App");}H.getInstance().replaceHash(x);R.attachRouteMatched(v);E=true;R.initialize();r();}else{var p;var K=j.getFcl();if(S&&S.length&&z[S[0].$PropertyPath]&&!K.isFclEnabled()){p=l._createHash(S,w,z);}else if(T&&z[T[0]]){p=l._createHash(T,w,z);}if(p){H.getInstance().replaceHash(p);}R.attachRouteMatched(v);R.initialize();r();}}else{R.attachRouteMatched(v);R.initialize();r();}}).catch(function(i){c.error("Metadata not loaded");});});},_bindTargetPage:function(T,l,p,N,I){var q=T.getComponentInstance?T.getComponentInstance():T.getController(),O=(q.onBeforeBinding||n).bind(q),r=(q.onAfterBinding||n).bind(q),v,w,x,y,z,G=this;function J(){if(S&&S.length){var V=[];var W=[];var Q=H.getInstance().getHash();Q=Q.split("?")[0];if(u){var X;for(var i=0;i<S.length;i++){X=u.getObject(S[i].$PropertyPath);if(X){W.push(X);}else{return undefined;}}}else{W=Q.substring(Q.indexOf("(")+1,Q.length-1).split(",");}for(var j=0;j<S.length;j++){var Y=S[j].$PropertyPath;var Z;if(W.length===1){Z=W[0];}else{Z=W[j].split("=")[1];}if(Z.indexOf("'")===0&&Z.lastIndexOf("'")===Z.length-1){Z=Z.substr(1,Z.length-2);}V.push(new F(Y,a.EQ,Z));}if(g){var $=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});V.push($);}var R=new F(V,true);return R;}}function K(){if(!N){v=T.getBindingContext();w=v&&v.getPath();x=v&&v.getBinding();y=u&&u.getBinding();}if(N||w!==l||(u&&x!==y&&!I)){if(l||N){if(!u||u.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){z=u&&u.getBinding();var i=T.getModel().getMetaModel();var j=T.getComponentInstance().getEntitySet();var V={$$patchWithoutSideEffects:true,$$groupId:"$auto"};if(i.getProperty("/"+j+"/@com.sap.vocabularies.Common.v1.Messages")){V.$select=i.getProperty("/"+j+"/@com.sap.vocabularies.Common.v1.Messages/$Path");}var W=T.getModel().bindContext(l,undefined,V);W.attachDataRequested(function(){e.lock(T);});W.attachDataReceived(function(X){var Y=X&&X.getParameter("error");e.unlock(T);if(Y){sap.ui.getCore().getLibraryResourceBundle("sap.fe.core",true).then(function(Z){m.removeUnboundTransitionMessages();G.navigateToMessagePage(Z.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:Z.getText("SAPFE_ERROR"),description:Y,navContainer:T.getParent()});});}});u=W.getBoundContext();if(G.isUIStateDirty()){setTimeout(function(){G._refreshBindingContext(v);},0);}}v=u;O(v,{editable:t,listBinding:z,bPersistOPScroll:P});T.setBindingContext(v);r(v);u=null;}else if(l===""){O(null);r(null);}}else if(G.isUIStateDirty()){G._refreshBindingContext(v);}}s=T.getComponent?T.getComponent():T.getControllerName();if(p){O(null,{editable:t});if(D||!A){if(q&&q.createDeferredContext){q.createDeferredContext(l);A=null;D=false;}}if(T.getBindingContext()&&T.getBindingContext().hasPendingChanges()){T.getBindingContext().getBinding().resetChanges();}T.setBindingContext(null);return false;}var Q=H.getInstance().getHash();if(S&&S.length&&g&&Q.split("/").length===1&&l!==""&&!I){if(!u){var R=J();var U=T.getModel().bindList("/"+Q.substring(0,Q.indexOf("(")),undefined,undefined,R);U.requestContexts().then(function(i){if(i&&i.length){l=i[0].getPath();}K();});}else{l=u.getPath();K();}}else{K();}},_refreshBindingContext:function(j){var N=[],p=[],l=[];var q=function(r){var v,w=r.getPath();if(r.isA("sap.ui.model.odata.v4.ODataContextBinding")){v=r.getDependentBindings();if(v){for(var i=0;i<v.length;i++){q(v[i]);}}else{if(N.indexOf(w)===-1){N.push(w);}}}else if(r.isA("sap.ui.model.odata.v4.ODataListBinding")){if(N.indexOf(w)===-1){N.push(w);}}else if(r.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(p.indexOf(w)===-1){p.push(w);}}};q(j.getBinding());for(var i=0;i<N.length;i++){l.push({$NavigationPropertyPath:N[i]});}for(var i=0;i<p.length;i++){l.push({$PropertyPath:p[i]});}j.requestSideEffects(l);},attachOnAfterNavigation:function(i){o.push(i);},detachOnAfterNavigation:function(j){for(var i=0;i<o.length;i++){if(o[i]===j){o.splice(i,1);}}},fireOnAfterNavigation:function(){for(var i=0;i<o.length;i++){o[i]();}},getOutbounds:function(){if(!this.outbounds){if(!this.manifest){this.manifest=this._getOwnerComponent().getMetadata().getManifest();}this.outbounds=this.manifest["sap.app"]&&this.manifest["sap.app"].crossNavigation&&this.manifest["sap.app"].crossNavigation.outbounds;}return this.outbounds;},_getOwnerComponent:function(){return d.getAppComponent(this.base.getView());},getEntitySet:function(l){var p;var q=l.getManifest();var r=q["sap.ui5"].routing.routes;var T=q["sap.ui5"].routing.targets;var v;for(var i=0;i<r.length;i++){v=r[i].pattern;if(v===""||":?query:"){p=T[r[i].target].options&&T[r[i].target].options.settings&&T[r[i].target].options.settings.entitySet;return p;}}if(!l.getFcl().isFclEnabled(l)){for(var j=0;j<r.length;j++){v=r[i].pattern;if((v!==""||":?query:")&&(T[r[j].target].options&&T[r[j].target].options.settings&&T[r[j].target].options.settings.entitySet===p)&&T[r[j].target].name==="sap.fe.templates.ObjectPage"){return p;}}}if(p==undefined){if(r.length===1){p=r[0].pattern.split("(")[0];return p;}}},_createHash:function(K,j,l){var p=j+"(";var q,v;var r=this._getEntityType();if(K.length===1){q=K[0].$PropertyPath||K[0];v=l.isA&&l.isA("sap.ui.model.odata.v4.Context")?l.getObject(q):l[q][0];if(v){p=r[q].$Type==="Edm.String"?p+"'"+v+"'":p+v;}else{p=undefined;}}else{for(var i=0;i<K.length;i++){q=K[i].$PropertyPath||K[i];v=l.getObject?l.getObject(q):l[q][0];if(v){p=r[q].$Type==="Edm.String"?p+q+"='"+v+"'":p+q+"="+v;if(i!==K.length-1){p=p+",";}}else{p=undefined;break;}}}if(p){p=p+")";return p;}return undefined;},_getEntityType:function(){return f||null;},waitForRightMostViewReady:function(i){return new Promise(function(r,j){var l=i.getParameter("views");var v=l[l.length-1].getComponentInstance();var V=v.getRootControl();if(v.isPageReady()){r(V);}else{v.attachEventOnce("pageReady",function(){r(V);});}});}});k.flagUIState=h.CLEAN;return k;});
