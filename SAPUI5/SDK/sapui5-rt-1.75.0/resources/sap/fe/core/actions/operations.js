/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/messageHandling","sap/fe/core/BusyLocker","sap/fe/macros/table/TableRuntime"],function(M,D,J,X,a,F,m,B,T){"use strict";function c(A,i,j,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}P=P||{};if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=[i];}var l=j.getMetaModel(),n=l.getMetaPath(i[0].getPath())+"/"+A,q=l.createBindingContext(n+"/@$ui5.overload/0");P.aContexts=i;P.isCriticalAction=f(l,n);return d(A,j,q,P);}function b(A,i,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var j=i.getMetaModel(),l=i.bindContext("/"+A).getPath(),n=j.createBindingContext("/"+j.createBindingContext(l).getObject("$Action")+"/0");P.isCriticalAction=f(j,l+"/@$ui5.overload");return d(A,i,n,P);}function d(A,i,j,P){return new Promise(function(r,l){P=P||{};var n=P.actionParameters||[],q={},t,u,v=P.label,S=P.showActionParameterDialog,C=P.aContexts,I=P.bIsCreateAction,w=P.isCriticalAction;if(!j){l("Action not found");}if(S||n.length>0){n=p(j,n);if(!n||n.length===0){S=false;}}if(S){t=s;}else if(w){t=e;}q={fnOnSubmitted:P.onSubmitted,actionName:A,model:i,aActionParameters:n,ownerComponent:P.ownerComponent};if(j.getObject("$IsBound")){q.aContexts=C;q.mBindingParameters=P.mBindingParameters;q.additionalSideEffect=P.additionalSideEffect;q.bGrouped=P.invocationGrouping==="ChangeSet";q.bReturnAsArray=P.bReturnAsArray;q.localUIModel=P.localUIModel;q.prefix=P.prefix;q.operationAvailableMap=P.operationAvailableMap;}if(I){q.bIsCreateAction=I;}if(t){u=t(A,v,q,n,j,P.parentControl);}else{u=_(q);}return u.then(function(O){r(O);}).catch(function(O){l(O);});});}function e(A,i,P){return new Promise(function(r,j){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),C;if(R.hasText("SAPFE_ACTION_CONFIRM|"+A)){C=R.getText("SAPFE_ACTION_CONFIRM|"+A);}else{C=R.getText("SAPFE_ACTION_CONFIRM");}M.confirm(C,{onClose:function(l){return _(P).then(function(O){r(O);}).catch(function(E){m.showUnboundMessages();});}});});}function s(A,j,P,l,n,q){var r=k(n,A),t=n.getModel().oModel.getMetaModel(),u=t.createBindingContext(r),v=n.getObject("$IsBound")?n.getPath().split("/@$ui5.overload/0")[0]:n.getPath().split("/0")[0],w=t.createBindingContext(v),x=Promise.resolve(),y="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(z,C){var E=X.loadTemplate(y,"fragment"),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),G=new J({$displayMode:{}});return a.process(E,{name:y},{bindingContexts:{action:n,actionName:w,entitySet:u},models:{action:n.getModel(),actionName:w.getModel(),entitySet:u.getModel()}}).then(function(E){return h(P.ownerComponent,l,G).then(function(){F.load({definition:E}).then(function(H){var O;var I=new D({title:j||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_TITLE"),content:[H],escapeHandler:function(V){I.close();I.destroy();z(false);},beginButton:{text:j||R.getText("SAPFE_OK"),type:"Emphasized",press:function(V){B.lock(I);var W=V.getSource();W.setEnabled(false);x.then(function(){var Y,i,Z,$=H.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");var a1=function(f1){var g1={};for(i=0;i<f1.length;i++){var h1=f1[i].getFields()[0];if(h1.getProperty("required")&&h1.mBindingInfos.value.binding){g1[h1.mBindingInfos.value.binding.getPath()]={element:h1};}}return g1;};var b1=a1($);var c1;var d1=O&&O.getParameterContext();for(i=0;i<l.length;i++){c1=l[i].$Name;Z=d1.getProperty(c1);if(!Z&&b1[c1]){Y=true;I.fireValidationError({element:b1[c1].element,property:"value",type:sap.ui.core.MessageType.Error,newValue:Z,message:R.getText("SAPFE_ACTION_PARAMETER_REQUIRED")});W.setEnabled(true);}}if(!Y){m.removeUnboundTransitionMessages();var e1;for(var i in P.aActionParameters){e1=d1.getProperty(P.aActionParameters[i].$Name);P.aActionParameters[i].value=e1;e1=undefined;}return _(P).then(function(f1){I.close();z(f1);}).catch(function(f1){W.setEnabled(true);m.showUnboundMessages();});}}).finally(function(){B.unlock(I);});}},endButton:{text:R.getText("SAPFE_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){I.close();m.removeUnboundTransitionMessages();C();}},afterClose:function(){I.destroy();}});I.setModel(n.getModel().oModel);I.setModel(G,"paramsModel");I.bindElement({path:"/",model:"paramsModel"});var K=A+"(...)";var L=P.aContexts||[];if(!L.length){K="/"+K;}I.bindElement({path:K});if(q){q.addDependent(I);}if(L.length>0){I.setBindingContext(L[0]);}O=I.getObjectBinding();if(L.length===1){O.setParameter("_it",L[0].getObject());}var N=function(S,V){var W;if(V){if(L.length>0&&V.$Path){W=L[0].getProperty(V.$Path);for(var i=1;i<L.length;i++){if(L[i].getProperty(V.$Path)!==W){return;}}}else{W=V;}}else{if(G&&G.oData[S]){W=G.oData[S];}}if(W){O.setParameter(S,W);}};var Q=function(S){var V=I.getModel().getMetaModel(),K=n.sPath&&n.sPath.split("/@")[0],W=V.getObject(K),Y=W&&W[0]&&W[0].$Parameter,Z=Y&&Y[0]&&Y[0].$Name,$=K+"/"+S+"@",a1=V.getObject($),b1=a1&&a1["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];if(b1&&b1.$Path&&b1.$Path.startsWith(Z+"/")){b1.$Path=b1.$Path.replace(Z+"/","");}return b1;};var S,U;for(var i in P.aActionParameters){S=P.aActionParameters[i].$Name;U=Q(S);N(S,U);}I.open();});});});});}function p(A,P){var i=g(A);P=P||[];if(P.length>0){}return i;}function g(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function f(i,P){return!!i.getObject(P+"@com.sap.vocabularies.Common.v1.IsActionCritical");}function _(P){var C=P.aContexts||[],l=P.model,A=P.aActionParameters||[],n=P.actionName,O=P.fnOnSubmitted,I=P.bIsCreateAction,q=false,r;function t(i){return i.then(function(j){return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function u(){if(A&&A.length){q=true;for(var j=0;j<A.length;j++){if(!A[j].value){switch(A[j].$Type){case"Edm.String":A[j].value="";break;case"Edm.Boolean":A[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":A[j].value=0;break;default:break;}}r.setParameter(A[j].$Name,A[j].value);}}}if(C.length){return new Promise(function(j,w){var x=P.mBindingParameters,G=P.bGrouped,R=P.bReturnAsArray,y=[],i,z,E=function(r,H,S){u();z=!G?"$auto."+H:r.getUpdateGroupId();y.push(r.execute(z));if(S&&S.pathExpressions){S.context.requestSideEffects(S.pathExpressions,z).then(function(){T.setActionEnablement(P.localUIModel,JSON.parse(P.operationAvailableMap),"/$contexts/"+P.prefix,P.aContexts);});}};for(i=0;i<C.length;i++){r=l.bindContext(n+"(...)",C[i],x);E(r,C.length<=1?null:i,{context:C[i],pathExpressions:P.additionalSideEffect});}(O||jQuery.noop)(y);Promise.all(y.map(t)).then(function(H){var K=[],L=[],N;for(N=0;N<H.length;N++){if(H[N].status==="rejected"){K.push(H[N].response);}if(H[N].status==="resolved"){if(I&&q){H[N].bConsiderDocumentModified=true;L.push(H[N]);}else{L.push(H[N].response);}}}if(!H||(H&&H.length===0)){w(true);}if(K.length===0){if(R){j(L);}else{j(L[0]);}}else{w({resolvedItems:L,rejectedItems:K});}});});}else{var v;r=l.bindContext("/"+n+"(...)");u();v=r.execute("actionImport");l.submitBatch("actionImport");(O||jQuery.noop)(v);return v;}}function h(A,i,P){return new Promise(function(r,j){var S=A.getComponentData().startupParameters,C=sap.ushell.Container.getService("CrossApplicationNavigation")||{};if(!C.getStartupAppState){i.map(function(l){if(S[l.$Name]){P.setProperty(l.$Name,S[l.$Name][0]);}});return r(true);}return C.getStartupAppState(A).then(function(l){var n=l.getData()||{},E=(n.selectionVariant&&n.selectionVariant.SelectOptions)||[];i.map(function(q){if(S[q.$Name]){P.setProperty("/"+q.$Name,S[q.$Name][0]);}else if(E.length>0){var t;E.some(function(u){if(u.PropertyName===q.$Name){t=u.Ranges;return true;}});if(t&&t.length===1&&t[0].Sign==="I"&&t[0].Option==="EQ"){P.setProperty("/"+q.$Name,t[0].Low);}}});return r(true);});});}function k(A,i){var P=A.getPath();P=A.getObject("$IsBound")?P.split("@$ui5.overload")[0]:P.split("/0")[0];return P.split("/"+i)[0];}var o={callBoundAction:c,callActionImport:b};return o;});
