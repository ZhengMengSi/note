sap.ui.define(["sap/ui/base/Object","sap/fe/core/actions/draft","sap/fe/core/actions/sticky","sap/fe/core/actions/operations","sap/fe/core/model/DraftModel","sap/ui/model/json/JSONModel","sap/fe/core/actions/messageHandling","sap/m/Popover","sap/m/VBox","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/m/MessageToast","sap/m/Dialog","sap/ui/model/BindingMode","sap/base/Log","sap/ui/core/message/Message","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker"],function(B,d,s,o,D,J,m,P,V,C,T,a,M,b,c,L,e,f,g){"use strict";var h={DRAFT:"Draft",STICKY:"Sticky",NON_DRAFT:"NonDraft"};function j(p){if(p&&p.getMetadata&&p.getMetadata().getName()==="sap.ui.base.Event"){p={};}return p||{};}return B.extend("sap.fe.core.TransactionHelper",{_bIsModified:false,_bCreateMode:false,_oAppComponent:null,_oResourceBundle:null,initialize:function(A){this._oAppComponent=A;},getProgrammingModel:function(i){var t=this,k=i.getModel(),l=i.getModel().getMetaModel().getMetaPath(i.getPath()),E;if(!this.sProgrammingModel){return D.upgradeOnDemand(k).then(function(I){if(I){t.sProgrammingModel=h.DRAFT;}else if(k.getMetaModel().getObject(l+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel=h.STICKY;}else{E=i.getModel().getMetaModel().getObject("/");for(var n in E){if(E[n].$kind==="EntitySet"){if(k.getMetaModel().getObject("/"+n+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel=h.STICKY;return t.sProgrammingModel;}}}t.sProgrammingModel=h.NON_DRAFT;k.sUpdateGroupId="nondraft";}return t.sProgrammingModel;});}else{return Promise.resolve(this.sProgrammingModel);}},getUIStateModel:function(){if(!this.uiModel){this.uiModel=new J({editable:"Display",busy:false,busyLocal:{},draftStatus:"Clear"});this.uiModel.setDefaultBindingMode(c.OneWay);}return this.uiModel;},setUIStateModel:function(u){this.uiModel=u;},isBusy:function(i,l){var u=this.getUIStateModel();return u.getProperty("/busy")||u.getProperty("/busyLocal/"+l);},busyHandler:function(i,l,O){var k=O?"lock":"unlock";if(i==="Global"||i==="Local"){g[k](this.getUIStateModel(),i==="Global"?"/busy":"/busyLocal/"+l);}},busyOn:function(i,l){this.busyHandler(i,l,true);},busyOff:function(i,l){this.busyHandler(i,l,false);},createDocument:function(l,p){var n,t=this,S,k,q=l.getModel(),r=q.getMetaModel(),u=r.getMetaPath(l.getPath()),N=!l.isRelative()&&(r.getObject(u+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction")||r.getObject(u+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction")),v,w=r.getObject(u+"/@com.sap.vocabularies.Common.v1.Messages/$Path"),x=(w&&{$select:w})||undefined;p=j(p);if(!l){return Promise.reject("Binding required for new document creation");}if(p.busyMode==="Local"){k=l.sId;}if(this.isBusy(p.busyMode,k)){return Promise.reject("Action can only be called once at a time");}S=!p.refreshList;t.busyOn(p.busyMode,k);if(N){v=this.onCallAction(N,{contexts:l.getHeaderContext(),showActionParameterDialog:true,label:t.getText("SAPFE_ACTION_CREATE"),bindingParameters:x,parentControl:p.parentControl,bIsCreateAction:true});}else{n=l.create(p.data,S,p.createAtEnd);v=n.created();var y=function(E){var z=E.getParameter("context"),A=sap.ui.getCore().getMessageManager(),F,G,H,I;if(z===n){l.detachCreateCompleted(y);if(!E.getParameter("success")){if(p.keepTransientContextOnFailed){F=n.getPath();G=A.getMessageModel().getData();I=false;for(var i=0;i<G.length;i++){if(G[0].target===F){I=true;break;}}if(!I){H=new e({message:t.getText("TRANSIENT_CONTEXT_MESSAGE"),description:t.getText("TRANSIENT_CONTEXT_DESCRIPTION"),target:F,persistent:false,type:"Error"});A.addMessages(H);n.created().then(function(){A.removeMessages(H);},function(){A.removeMessages(H);});}var K=function(E){if(E.getParameter("context")===n){m.showUnboundMessages();if(E.getParameter("success")){l.detachCreateCompleted(K);}}};l.attachCreateCompleted(K);m.showUnboundMessages();}else{z.created().then(undefined,function(){L.trace("transient creation context deleted");});z.delete();}}}};l.attachCreateCompleted(y);}return v.then(function(R){if(!l.isRelative()){t._bCreateMode=true;}n=n||(R&&R.response);if(R&&R.bConsiderDocumentModified){t.handleDocumentModifications();}return m.showUnboundMessages().then(function(){return n;});}).catch(function(i){return m.showUnboundMessages().then(function(){return Promise.reject(i);});}).finally(function(){t.busyOff(p.busyMode,k);});},deleteDocument:function(v,p,l){var u=this.getUIStateModel(),r,R,i=[],k=false,n=false,q=false,t,w=this;if(g.isLocked(u,"/busy")){return Promise.reject("Action can only be called once at a time");}var x,y={title:w.getText("OBJECT_PAGE_DELETE")};g.lock(u);if(p){if(!p.numberOfSelectedContexts){p=j(p);if(p.title){if(p.description){x=[p.title,p.description];y.text=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",x);}else{y.text=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}}else{y.text=w.getText("OBJECT_PAGE_CONFIRM_GENERIC_DELETE");}i=v;}else{y={title:w.getText("OBJECT_PAGE_DELETE")};if(p.numberOfSelectedContexts===1&&p.numberOfSelectedContexts===v.length){i=v;y.text=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}else if(p.numberOfSelectedContexts===1&&p.unSavedContexts.length===1){i=p.unSavedContexts;var z=i[0].getObject()["DraftAdministrativeData"]?i[0].getObject()["DraftAdministrativeData"]["LastChangedByUserDescription"]:"";x=[z];y.text=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",x);}else if(p.numberOfSelectedContexts===p.unSavedContexts.length){i=p.unSavedContexts;y.text=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS");}else if(p.numberOfSelectedContexts===v.concat(p.unSavedContexts.concat(p.lockedContexts)).length){i=v.concat(p.unSavedContexts);y.text=i.length===1?w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR"):w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL");}else{i=v.concat(p.unSavedContexts);q=true;y.text=i.length===1?w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL"):w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");y.nonDeletableText=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length,p.numberOfSelectedContexts]);}if(p.lockedContexts.length>0){n=true;y.nonDeletableText=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",[p.lockedContexts.length,p.numberOfSelectedContexts]);}if(p.unSavedContexts.length>0&&p.unSavedContexts.length!==p.numberOfSelectedContexts){if((q||n)&&i.length===p.unSavedContexts.length){k=false;i=p.unSavedContexts;if(p.unSavedContexts.length===1){y.text=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR");}else{y.text=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL");}}else{if(p.unSavedContexts.length===1){y.checkBoxText=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR");}else{y.checkBoxText=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL");}k=true;}}if(q&&n){y.nonDeletableText=w.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED_AND_NON_DELETABLE",[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length-p.lockedContexts.length,p.lockedContexts.length,p.numberOfSelectedContexts]);}}}var A=new V({items:[new T({text:y.nonDeletableText,visible:n||q}),new T({text:y.text}),new C({text:y.checkBoxText,selected:true,select:function(G){var H=G.getSource().getSelected();if(H){i=v.concat(p.unSavedContexts);t=true;}else{i=v;t=false;}},visible:k})]});var E=p.numberOfSelectedContexts?w.getText("OBJECT_PAGE_DELETE_DIALOG",[p.numberOfSelectedContexts]):w.getText("OBJECT_PAGE_DELETE");var F=new b({title:E,state:"Warning",content:[A],beginButton:new a({text:w.getText("OBJECT_PAGE_DELETE"),type:"Emphasized",press:function(){g.lock(u);var G=Array.isArray(i)?i:[i];F.close();return Promise.all(G.map(function(H){H.delete().then(function(){if(l.getProperty("/$contexts/"+p.id+"/deleteEnabled")!=undefined){if(k===true&&t===false){l.setProperty("/$contexts/"+p.id+"/deleteEnabled",true);var I=Object.assign(l.getProperty("/$contexts/"+p.id),{});I.selectedContexts=I.selectedContexts.filter(function(K){return I.deletableContexts.indexOf(K)===-1;});I.deletableContexts=[];I.selectedContexts=[];I.numberOfSelectedContexts=I.selectedContexts.length;l.setProperty("/$contexts/"+p.id,I);}else{l.setProperty("/$contexts/"+p.id+"/deleteEnabled",false);l.setProperty("/$contexts/"+p.id+"/selectedContexts",[]);l.setProperty("/$contexts/"+p.id+"/numberOfSelectedContexts",0);}}if(G.length===1){M.show(w.getText("OBJECT_PAGE_DELETE_TOAST_SINGULAR"));}else{M.show(w.getText("OBJECT_PAGE_DELETE_TOAST_PLURAL"));}m.removeBoundTransitionMessages();w._bIsModified=true;return m.showUnboundMessages().then(R);}).catch(function(I){return m.showUnboundMessages().then(r);});})).finally(function(){g.unlock(u);});}}),endButton:new a({text:w.getText("OBJECT_PAGE_CANCEL"),press:function(){F.close();}}),afterClose:function(){F.destroy();}});F.addStyleClass("sapUiContentPadding");g.unlock(u);F.open();return new Promise(function(G,H){r=H;R=G;});},editDocument:function(i){this._bIsModified=false;var t=this;var u=this.getUIStateModel();if(g.isLocked(u)){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject(new Error("Binding context to active document is required"));}g.lock(u);return this.getProgrammingModel(i).then(function(p){switch(p){case h.DRAFT:t.activeContext=i;return d.createDraftFromActiveDocument(i,{bPreserveChanges:true});case h.NON_DRAFT:return i;case h.STICKY:return s.editDocumentInStickySession(i);}}).then(function(n){u.setProperty("/editable","Editable");t._bCreateMode=false;return m.showUnboundMessages().then(function(){return n;});}).catch(function(k){return m.showUnboundMessages().then(function(){return Promise.reject(k);});}).finally(function(){g.unlock(u);});},updateDocument:function(){return Promise.resolve();},cancelDocument:function(i,p){var t=this,u=t.getUIStateModel(),k;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject("No context exists. Pass a meaningful context");}g.lock(u);p=j(p);var l=i,n=p.cancelButton,q=l.getModel(),r;return this.getProgrammingModel(i).then(function(v){k=v;if(v===h.DRAFT){var w=q.bindContext(l.getPath()+"/DraftAdministrativeData").getBoundContext();if(!t._bIsModified){return w.requestObject().then(function(x){t._bIsModified=!(x.CreationDateTime===x.LastChangeDateTime);});}}else if(v===h.NON_DRAFT){t._bIsModified=l.hasPendingChanges();}}).then(function(){return t._showDiscardPopover(n,t._bIsModified);}).then(function(){switch(k){case h.DRAFT:return l.requestObject("HasActiveEntity").then(function(H){if(!H){if(l&&l.hasPendingChanges()){l.getBinding().resetChanges();}l.delete();return false;}else{var A=t.activeContext||q.bindContext(l.getPath()+"/SiblingEntity").getBoundContext();return A.requestCanonicalPath().then(function(v){r=v;if(l&&l.hasPendingChanges()){l.getBinding().resetChanges();}l.delete();}).then(function(){if(A.getPath()!==r){A=q.bindContext(r).getBoundContext();}return A;});}});case h.STICKY:return s.discardDocument(i).then(function(i){if(i){if(i.hasPendingChanges()){i.getBinding().resetChanges();}if(!t._bCreateMode){i.refresh();return i;}}return false;});case h.NON_DRAFT:if(l===i&&t._bIsModified){i.getBinding().resetChanges();}break;}}).then(function(v){t._bIsModified=false;u.setProperty("/editable","Display");m.removeBoundTransitionMessages();return m.showUnboundMessages().then(function(){return v;});}).catch(function(v){return m.showUnboundMessages().then(function(){return Promise.reject(v);});}).finally(function(){g.unlock(u);});},saveDocument:function(i){var u=this.getUIStateModel(),k,t=this;if(g.isLocked(u)){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject(new Error("Binding context to draft document is required"));}m.removeBoundTransitionMessages();g.lock(u);return this.getProgrammingModel(i).then(function(p){switch(p){case h.DRAFT:return d.activateDocument(i);case h.STICKY:return s.activateDocument(i);case h.NON_DRAFT:k=i.getModel();k.submitBatch(k.getUpdateGroupId());return i;}}).then(function(A){t._bIsModified=false;u.setProperty("/editable","Display");M.show(t.getText("OBJECT_SAVED"));return m.showUnboundMessages().then(function(){return A;});}).catch(function(l){return m.showUnboundMessages().then(function(){return Promise.reject(l);});}).finally(function(){g.unlock(u);});},onCallAction:function(A,p){p=j(p);var u=this.getUIStateModel(),t=this,i,k,l,n,q=p.bindingParameters;if(g.isLocked(u)){return Promise.reject("Action can only be called once at a time");}if(!A){return Promise.reject("Provide name of action to be executed");}n=A.split("/")[1];A=n||A;i=n?undefined:p.contexts;if(i&&((Array.isArray(i)&&i.length)||!Array.isArray(i))){i=Array.isArray(i)?i[0]:i;k=i.getModel();}if(p.model){k=p.model;}if(!k){return Promise.reject("Pass a context for a bound action or pass the model for an unbound action");}var S=t._getBindingParameters(A,i)||{},r=t._getAppComponent(),v=false;if(i&&k){l=o.callBoundAction(A,p.contexts,k,{invocationGrouping:p.invocationGrouping,label:p.label,showActionParameterDialog:true,mBindingParameters:q,additionalSideEffect:S.aAdditionalPropertyPaths,onSubmitted:function(){v=true;g.lock(u);},parentControl:p.parentControl,ownerComponent:r,localUIModel:p.localUIModel,operationAvailableMap:p.operationAvailableMap,prefix:p.prefix,bIsCreateAction:p.bIsCreateAction});}else{l=o.callActionImport(A,k,{label:p.label,showActionParameterDialog:true,bindingParameters:q,onSubmitted:function(){v=true;g.lock(u);},parentControl:p.parentControl,localUIModel:p.localUIModel,operationAvailableMap:p.operationAvailableMap,prefix:p.prefix,ownerComponent:r});}return l.then(function(R){return m.showUnboundMessages().then(function(){return R;});}).catch(function(w){return m.showUnboundMessages().then(function(){return Promise.reject(w);});}).finally(function(){if(v){g.unlock(u);}});},_getBindingParameters:function(A,i){var k=i&&i.getModel().getMetaModel(),l=k&&k.getMetaContext(i.getPath()),S=l&&k.getObject(A+"@com.sap.vocabularies.Common.v1.SideEffects",l);if(!S){return{};}var t=S.TargetProperties||[],n=S.TargetEntities||[],E=k.getMetaPath(i.getPath()),p=[];p=p.concat(t).concat(n);t.forEach(function(q){var r=k.getObject(E+"/"+q["$PropertyPath"]+"@com.sap.vocabularies.Common.v1.Text");if(r&&r["$Path"]){var u=q["$PropertyPath"],N=u.indexOf("/")>-1?u.replace(/[^\/]+$/,""):"";p.push({"$PropertyPath":N+r["$Path"]});}});return{aAdditionalPropertyPaths:p};},_showDiscardPopover:function(i,I){var t=this;t._bContinueDiscard=false;return new Promise(function(r,k){if(!i){k("Cancel button not found");}if(I){var O=function(){i.setEnabled(true);if(t._bContinueDiscard){r();}else{k("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[new T({text:t.getText("SAPFE_DRAFT_DISCARD_MESSAGE")}),new a({text:t.getText("SAPFE_DRAFT_DISCARD_BUTTON"),width:"100%",press:function(){t._bContinueDiscard=true;t._oPopover.close();}})]})],beforeOpen:function(){i.setEnabled(false);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(i);}else{r();}});},handleDocumentModifications:function(){this._bIsModified=true;},_getAppComponent:function(){return this._oAppComponent;},getText:function(t,p){if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");}return this._oResourceBundle.getText(t,p);}});});
