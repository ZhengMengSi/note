// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["../util/Transport","sap/base/Log","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/core/UIComponent"],function(T,L,M,F,C,U){"use strict";return C.extend("sap.ushell.applications.PageComposer.controller.BaseController",{getPageRepository:function(){return this.getOwnerComponent().getPageRepository();},getRouter:function(){return U.getRouterFor(this);},getModel:function(n){return this.getView().getModel(n);},setModel:function(m,n){return this.getView().setModel(m,n);},getRootView:function(){return this.getOwnerComponent().getRootControl();},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle();},getTransportHelper:function(){if(!this.oTransportHelper){this.oTransportHelper=new T();}return this.oTransportHelper;},_createEditDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/EditDialog.controller"],function(E){if(!this.oEditPageDialogController){this.oEditPageDialogController=new E(this.getRootView(),this.getResourceBundle());}this.oEditPageDialogController.attachCancel(a);this.oEditPageDialogController.attachConfirm(o);this.oEditPageDialogController.load().then(function(){r(this.oEditPageDialogController);}.bind(this));}.bind(this));}.bind(this));},showCreateDialog:function(o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CreatePageDialog.controller"],function(c){if(!this.oCreatePageDialogController){this.oCreatePageDialogController=new c(this.getRootView(),this.getResourceBundle());}this.oCreatePageDialogController.attachConfirm(o);this.oCreatePageDialogController.attachCancel(a);this.oCreatePageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCreatePageDialogController,t,o);}.bind(this));}return this.oCreatePageDialogController;}.bind(this)).then(function(e){if(e){e.open();}r();}).catch(function(e){this.oCreatePageDialogController.destroy();this.handleBackendError(e);b();}.bind(this));}.bind(this));}.bind(this));},_createDeleteDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/DeleteDialog.controller"],function(D){if(!this.oDeletePageDialogController){this.oDeletePageDialogController=new D(this.getRootView(),this.getResourceBundle());}this.oDeletePageDialogController.attachCancel(a);this.oDeletePageDialogController.attachConfirm(o);this.oDeletePageDialogController.load().then(function(){r(this.oDeletePageDialogController);}.bind(this));}.bind(this));}.bind(this));},checkShowEditDialog:function(p,o,a){var e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return Promise.resolve();}return this.getOwnerComponent().createTransportComponent(p.devclass).then(function(t){return Promise.all([t.showTransport(p),t.showLockedMessage(p)]).then(function(r){var s=r[0],l=r[1];if(l){this.showMessageBoxError(this.getResourceBundle().getText("Dialog.LockedText",[p.transportId,l.foreignOwner]),true);}else if(s){this._createEditDialog(o,a).then(function(d){d.getModel().setProperty("/message",this.getResourceBundle().getText("EditDialog.TransportRequired"));var E=this.getTransportHelper().enhanceDialogWithTransport(d,t,o);E.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},checkShowDeleteDialog:function(p,o,a){var r=this.getResourceBundle(),e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return this._createDeleteDialog(o,a).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));d.open();});}return this.getOwnerComponent().createTransportComponent(p.devclass).then(function(t){return Promise.all([t.showTransport(p),t.showLockedMessage(p)]).then(function(R){var s=R[0],l=R[1];if(l){this.showMessageBoxError(r.getText("Dialog.LockedText",[p.transportId,l.foreignOwner]),true);}else{this._createDeleteDialog(o,a).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));if(s){d.getModel().setProperty("/message",r.getText("DeleteDialog.TransportRequired"));d=this.getTransportHelper().enhanceDialogWithTransport(d,t,o);}d.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},showCopyDialog:function(p,o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CopyPageDialog.controller"],function(c){if(!this.oCopyPageDialogController){this.oCopyPageDialogController=new c(this.getRootView(),this.getResourceBundle());}this.oCopyPageDialogController.attachConfirm(o);this.oCopyPageDialogController.attachCancel(a);return this.oCopyPageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCopyPageDialogController,t,o);}.bind(this));}return this.oCopyPageDialogController;}.bind(this)).then(function(e){if(e){e.open();e.getModel().setProperty("/sourceId",p.id);e.getModel().setProperty("/sourceTitle",p.title);}r();}).catch(function(e){this.oCopyPageDialogController.destroy();this.handleBackendError(e);b(e);}.bind(this));}.bind(this));}.bind(this));},_openTileInfoPopover:function(o,b,m){var r=this.getRootView();if(!r.oTileInfoPopover){F.load({id:r.getId(),name:"sap.ushell.applications.PageComposer.view.TileInfoPopover",controller:this}).then(function(t){r.oTileInfoPopover=t;r.addDependent(r.oTileInfoPopover);this._openTileInfoPopover(o,b,m);}.bind(this));}else{r.oTileInfoPopover.setModel(b.getModel(m));r.oTileInfoPopover.setBindingContext(b);r.oTileInfoPopover.openBy(o);}},showMessageBoxError:function(e,n){if(n){M.error(e,{onClose:this.navigateToPageOverview.bind(this)});}else{M.error(e);}},showMessageBoxWarning:function(w,n){if(n){M.warning(w,{onClose:function(){this.navigateToPageOverview();}.bind(this)});}else{M.warning(w);}},navigateToPageOverview:function(){this.getRouter().navTo("overview");},navigateToErrorPage:function(p){this.getRouter().navTo("error",{pageId:encodeURIComponent(p)},null,true);},preview:function(){var p=this.getView();sap.ui.require(["sap/ushell/applications/PageComposer/controller/PagePreviewDialog.controller"],function(P){P.open(p);});},checkMasterLanguageMismatch:function(p){var c=this.getOwnerComponent().getMetadata().getConfig().checkLanguageMismatch,u=sap.ui.getCore().getConfiguration().getSAPLogonLanguage().toUpperCase(),P=p.masterLanguage.toUpperCase();if(c&&u!==P){this.showMessageBoxError(this.getResourceBundle().getText("EditDialog.LanguageMismatch",[P,u]),true);return true;}return false;},handleBackendError:function(e){if(e.responseText){this.getOwnerComponent().showErrorDialog(e);}else{L.error(e);}},onRouteLeave:function(){this.getPageRepository().abortPendingBackendRequests();},fetchRoles:function(p){return this.getPageRepository().getRoles(p).then(function(r){return r||[];}).catch(function(e){L.error(e);return[];});},onfilterErrorMessages:function(p){function f(a,q){return a.filter(function(o){return o.target.toLowerCase().indexOf(q.toLowerCase())!==-1;});}var m=this.getModel("message").getData(),e=f(m,"/pageSet('"+p+"')");return e;}});});
