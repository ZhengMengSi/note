//Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/f/GridContainerItemLayoutData","sap/m/library","sap/ui/core/XMLComposite","sap/ushell/resources","sap/ui/core/ResizeHandler","sap/ui/base/ManagedObjectMetadata","sap/base/util/deepClone"],function(G,l,X,r,R,M,d){"use strict";var T=l.TileSizeBehavior;var S=X.extend("sap.ushell.ui.launchpad.Section",{metadata:{library:"sap.ushell",properties:{editable:{type:"boolean",group:"Misc",defaultValue:false},default:{type:"boolean",group:"Misc",defaultValue:false},enableAddButton:{type:"boolean",group:"Behavior",defaultValue:true},enableDeleteButton:{type:"boolean",group:"Behavior",defaultValue:true},enableGridBreakpoints:{type:"boolean",group:"Appearance",defaultValue:false},enableResetButton:{type:"boolean",group:"Behavior",defaultValue:true},enableShowHideButton:{type:"boolean",group:"Behavior",defaultValue:true},enableVisualizationReordering:{type:"boolean",group:"Behavior",defaultValue:false},noVisualizationsText:{type:"string",group:"Appearance",defaultValue:r.i18n.getText("Section.NoVisualizationsText")},title:{type:"string",group:"Appearance",defaultValue:""},showNoVisualizationsText:{type:"boolean",group:"Behavior",defaultValue:false},showSection:{type:"boolean",group:"Misc",defaultValue:true},sizeBehavior:{type:"sap.m.TileSizeBehavior",group:"Misc",defaultValue:T.Responsive}},defaultAggregation:"visualizations",aggregations:{visualizations:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--innerGrid",aggregation:"items"},dnd:true}},events:{"add":{},"delete":{},"reset":{},"titleChange":{},"visualizationDrop":{parameters:{draggedControl:{type:"sap.ui.core.Control"},droppedControl:{type:"sap.ui.core.Control"},dropPosition:{type:"string"}}},"sectionVisibilityChange":{parameters:{visible:{type:"boolean"}}},"borderReached":{parameters:{event:{type:"jQuery.Event"}}}}},resourceModel:r.i18nModel});S.prototype.init=function(){this.oVBox=this.byId("content");this.byId("innerGrid").addEventDelegate({onBeforeRendering:function(){R.deregister(this._sHandleResizeId);}.bind(this),onAfterRendering:function(){this._sHandleResizeId=R.register(this.oVBox,this._handleResize.bind(this));this.oVBox.toggleStyleClass("sapUshellSectionNoVisualizations",!this.getVisualizations().length);}.bind(this)});this.addEventDelegate({onsapleft:this._handleKeyboardArrowNavigation.bind(this,false),onsapleftmodifiers:this._handleKeyboardArrowNavigation.bind(this,true),onsapright:this._handleKeyboardArrowNavigation.bind(this,false),onsaprightmodifiers:this._handleKeyboardArrowNavigation.bind(this,true),onsapup:this._handleKeyboardArrowNavigation.bind(this,false),onsapupmodifiers:this._handleKeyboardArrowNavigation.bind(this,true),onsapdown:this._handleKeyboardArrowNavigation.bind(this,false),onsapdownmodifiers:this._handleKeyboardArrowNavigation.bind(this,true),onsaphome:this._setFocusOnVisualizationWithIndex.bind(this,0),onsapend:this._setFocusOnVisualizationWithIndex.bind(this,"last")});this.bUseExtendedChangeDetection=true;};S.prototype.updateVisualizations=function(){var b=this.getBinding("visualizations");var B=this.getBindingInfo("visualizations");var L=b.aLastContextData||[];L=L.map(function(f){return JSON.parse(f)[B.key];});var c=b.getContexts();var C=c.map(function(f){return f.getProperty(B.key);});var s=L.length;var D=c.diff;var a=[];var e=false;var o={};a[0]=this.oVizMovePromise||Promise.resolve();if(D){D.forEach(function(f,i){a[i+1]=a[i].then(function(p){return p;});if(e){return;}if(f.type==="delete"){var g=this._calcDeleteIndex(D,s,i);var I=this.getVisualizations()[g];this.removeVisualization(I);var h=L.splice(g,1);o[h]=I;f.done=true;}else if(f.type==="insert"){if(this.oVizMovePromise){f.done=false;a[i+1]=a[i].then(function(p){if(!this._insertVizFromPromise(p,C,f.index)){this._insertVizFromScratch(c[f.index],B,f.index);}f.done=true;return p;}.bind(this));}else{this._insertVizFromScratch(c[f.index],B,f.index);f.done=true;}}else{e=true;}}.bind(this));}else if(this.oVizMovePromise){c.forEach(function(f,i){a[i+1]=a[i].then(function(p){if(!this._insertVizFromPromise(p,C,i,true)){this._insertVizFromScratch(f,B,i,true);}return p;}.bind(this));}.bind(this));}else{e=true;}if(e){this._buildVisualizationsFromScratch(c,B);}this._resolveVizMovePromise(o);return this._cleanupAfterUpdateVisualizations(a,c,C);};S.prototype._buildVisualizationsFromScratch=function(c,b){this.destroyVisualizations();c.forEach(function(C,i){this._insertVizFromScratch(C,b,i,true);}.bind(this));};S.prototype._cleanupAfterUpdateVisualizations=function(p,c,v){return Promise.all(p).then(function(a){var i=a.pop();if(i){Object.keys(i).forEach(function(I){if(v.indexOf(I)===-1){i[I].destroy();}});}this.oVizMovePromise=null;this.fnVizMoveResolve=null;this._updateBindingContexts(c);if(c.length===0){this.invalidate();}}.bind(this));};S.prototype._calcDeleteIndex=function(D,s,a){var A=[];var b=[];for(var i=0;i<s;i++){A.push(i);b.push(i);}D.forEach(function(o,c){if(o.done===true||o.done===false){A=this._applyDiff(A,o,c+s);}if(o.done===true){b=this._applyDiff(b,o,c+s);}}.bind(this));var I=A[D[a].index];return b.indexOf(I);};S.prototype._applyDiff=function(a,D,m){var c=d(a);if(D.type==="delete"){c.splice(D.index,1);}else if(D.type==="insert"){m++;c.splice(D.index,0,m);}return c;};S.prototype._resolveVizMovePromise=function(i){if(this.fnVizMoveResolve){this.fnVizMoveResolve(i);this.fnVizMoveResolve=null;}else{Object.keys(i).forEach(function(I){i[I].destroy();});}};S.prototype._insertVizFromPromise=function(p,v,i,a){var P=v[i];var o=p[P];if(o){if(a){this.addVisualization(o);}else{this.insertVisualization(o,i);}return true;}return false;};S.prototype._insertVizFromScratch=function(c,b,i,a){var I=this._createViz(c,b);if(a){this.addVisualization(I);}else{this.insertVisualization(I,i);}};S.prototype._createViz=function(c,b){return b.factory(M.uid("clone"),c);};S.prototype._updateBindingContexts=function(c){if(!c.length){return;}var I=this.getVisualizations();var o;for(var i=0;i<I.length;i++){o=I[i];o.setBindingContext(c[i]);}};S.prototype.setVizMovePromise=function(p){this.oVizMovePromise=p;};S.prototype.setVizMoveResolve=function(f){this.fnVizMoveResolve=f;};S.prototype._setFocusOnVisualizationWithIndex=function(i,e){e.preventDefault();e.stopPropagation();window.setTimeout(function(){var v=this.getVisualizations();if(v.length){var n=v[i==="last"?v.length-1:i],N=n.getInnerControl().getContent?n.getInnerControl().getContent()[0]:n.getInnerControl();N.focus();}}.bind(this),0);};S.prototype._handleKeyboardArrowNavigation=function(m,e){if((m&&!this.getEnableVisualizationReordering())||(m&&!e.ctrlKey)){return;}var v=this.getVisualizations();for(var i=0;i<v.length;i++){var V=v[i],I=V.getInnerControl().getContent?V.getInnerControl().getContent()[0]:V.getInnerControl();if(window.document.activeElement===I.getDomRef()){if(e.type==="sapleft"||e.type==="sapup"){if(i>0){this._setFocusOnVisualizationWithIndex(i-1,e);}else{this.fireBorderReached({event:e,section:this,direction:"up"});e.stopPropagation();}}else if(e.type==="sapright"||e.type==="sapdown"){if((i+1)<v.length){this._setFocusOnVisualizationWithIndex(i+1,e);}else{this.fireBorderReached({event:e,section:this,direction:"down"});e.stopPropagation();}}else if(e.type==="sapleftmodifiers"||e.type==="sapupmodifiers"){if(i>0){this.fireVisualizationDrop({draggedControl:this.getVisualizations()[i],droppedControl:this.getVisualizations()[i-1],dropPosition:"Before"});this._setFocusOnVisualizationWithIndex(i-1,e);}else{this.fireBorderReached({event:e,section:this,direction:"up",visualization:V});e.stopPropagation();}}else if(e.type==="saprightmodifiers"||e.type==="sapdownmodifiers"){if((i+1)<v.length){this.fireVisualizationDrop({draggedControl:this.getVisualizations()[i],droppedControl:this.getVisualizations()[i+1],dropPosition:"After"});this._setFocusOnVisualizationWithIndex(i+1,e);}else{this.fireBorderReached({event:e,section:this,direction:"down",visualization:V});e.stopPropagation();}}return;}}};S.prototype.setEditable=function(v){this.setProperty("editable",!!v);this.oVBox.toggleStyleClass("sapUshellSectionEdit",!!v);};S.prototype.setShowSection=function(v,e){this.setProperty("showSection",!!v);this.oVBox.toggleStyleClass("sapUshellSectionHidden",!v);this.fireSectionVisibilityChange({visible:!!v});};S.prototype._reorderVisualizations=function(i){this.fireVisualizationDrop(i.getParameters());};S.prototype._onDragEnter=function(e){var D=e.getParameter("dragSession");var t=D.getDropControl();var s=D.getDragControl().getParent();if(t.data("default")&&!s.data("default")){e.preventDefault();}};S.prototype.addAggregation=function(a,o){if(a==="visualizations"){this._addVisualizationLayoutData(o);}X.prototype.addAggregation.apply(this,arguments);return this;};S.prototype.insertAggregation=function(a,o){if(a==="visualizations"){this._addVisualizationLayoutData(o);}X.prototype.insertAggregation.apply(this,arguments);return this;};S.prototype._getVisualizationLayoutData=function(v){if(v.getLayout){return v.getLayout();}return{rows:2,columns:2};};S.prototype._addVisualizationLayoutData=function(v){if(!v.getLayoutData()){var L=this._getVisualizationLayoutData(v);v.setLayoutData(new G(L));}};S.prototype._handleResize=function(e){var i=this.byId("innerGrid");if(e.size.width<376){i.setContainerQuery(false);}else if(e.size.width>=376){i.setContainerQuery(true);}};return S;});
