// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_CommonDataModel/PersonalizationProcessor","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/ushell/services/_CommonDataModel/SiteConverter","sap/base/util/isEmptyObject","sap/base/util/deepClone","sap/base/util/Version","sap/ushell/Config"],function(P,O,q,a,S,b,d,V,C){"use strict";var c="sap.ushell.services.CommonDataModel",e={"STATIC_LAUNCHER":"sap.ushell.StaticAppLauncher","DYNAMIC_LAUNCHER":"sap.ushell.DynamicAppLauncher","CARD":"sap.ushell.Card"};function f(A,o,p,s){var g=new q.Deferred();this._oAdapter=A;this._oPersonalizationProcessor=new P();this._oSiteDeferred=g;this._oOriginalSite={};this._oPersonalizedSite={};this._oContentProviderIndex={};this._oSiteConverter=new S();this._mPersonalizationDeltas={};this._oGetSitePromise=A.getSite().then(this._loadAndApplyPersonalization.bind(this)).fail(g.reject);}f.prototype._loadAndApplyPersonalization=function(s){this._oOriginalSite=q.extend(true,{},s);var o=new V(s._version);if(o.compareTo("3.1.0")<0){this._oAdapter.getPersonalization(o).then(function(p){if(p){this._mPersonalizationDeltas=d(p);}else{this._mPersonalizationDeltas={version:"3.0.0"};}this._triggerMixinPersonalisationInSite(s,p);}.bind(this)).fail(this._oSiteDeferred.reject);}else{this._oPersonalizedPages={};this._oSiteDeferred.resolve(s);}};f.prototype._triggerMixinPersonalisationInSite=function(s,p){return new Promise(function(r,g){this._oPersonalizationProcessor.mixinPersonalization(s,p).done(function(o){this._oPersonalizedSite=this._ensureCompleteSite(o);this._oPersonalizedSite=this._ensureGroupsOrder(this._oPersonalizedSite);this._oPersonalizedSite=this._ensureStandardVizTypesPresent(this._oPersonalizedSite);this._oSiteDeferred.resolve(this._oPersonalizedSite);r(this._oPersonalizedSite);}.bind(this)).fail(function(m){this._oSiteDeferred.reject(m);g();}.bind(this));}.bind(this));};f.prototype._triggerMixinPersonalisationInSiteAndStore=function(s,p,g){return this._triggerMixinPersonalisationInSite(s,p).then(function(o){var h=this._oSiteConverter.convertTo("3.1.0",d(o));if(this._oPersonalizedPages){this._oPersonalizedPages[g]=h;}return h;}.bind(this));};f.prototype.getHomepageGroups=function(){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var g=(s&&s.site&&s.site.payload&&s.site.payload.groupsOrder)?s.site.payload.groupsOrder:[];D.resolve(g);});return D.promise();};f.prototype.getGroups=function(){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var g=[];Object.keys(s.groups).forEach(function(k){g.push(s.groups[k]);});D.resolve(g);});return D.promise();};f.prototype.getGroup=function(i){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var g=s.groups[i];if(g){D.resolve(g);}else{D.reject("Group "+i+" not found");}});return D.promise();};f.prototype.getSite=function(){return this._oSiteDeferred.promise();};f.prototype.getPage=function(p){return new Promise(function(r,g){if(!this._oAdapter.getPage){g("The configured CDM adapter doesn't support the CDM 3.1 pages: Function 'getPage' not implemented.");return;}this._oGetSitePromise.done(function(){if(C.last("/core/shell/enablePersonalization")){this._getPageAndPersonalization(p).then(function(o){var h=o.page,i=o.personalization,j=this._oSiteConverter.convertTo("3.0.0",d(h));this._oOriginalSite.pages[h.identification.id]=d(h);this._mPersonalizationDeltas=d(i);var k=i[p]||{};this._triggerMixinPersonalisationInSiteAndStore.call(this,j,k,p).then(r).catch(function(){g("Personalization Processor: Cannot mixin the personalization.");});}.bind(this)).catch(g);}else{this._oAdapter.getPage(p).then(r).catch(g);}}.bind(this)).fail(g);}.bind(this));};f.prototype._getPageAndPersonalization=function(p){return new Promise(function(r,g){var o=new Promise(function(h,i){this._oAdapter.getPersonalization(this._oOriginalSite._version).done(h).fail(i);}.bind(this));Promise.all([this._oAdapter.getPage(p),o]).then(function(h){r({page:h[0],personalization:h[1]});}).catch(function(){g("CommonDataModel Service: Cannot get page "+p+" or its personalization");});}.bind(this));};f.prototype.getPages=function(p){if(!this._oAdapter.getPages){return Promise.reject("The configured CDM adapter doesn't support the CDM 3.1 pages: Function 'getPages' not implemented.");}var g=[];return this._oAdapter.getPages(p).then(function(o){function _(s,h){return new Promise(function(r,j){this._oAdapter.getPersonalization(this._oOriginalSite._version).done(function(k){var m=h,n=k,t=this._oSiteConverter.convertTo("3.0.0",m);this._oOriginalSite.pages[m.identification.id]=d(m);this._mPersonalizationDeltas=d(n);var u=n[s]||{};this._triggerMixinPersonalisationInSiteAndStore.call(this,t,u,s).then(r).catch(function(){j("Personalization Processor: Cannot mixin the personalization.");});}.bind(this)).fail(j);}.bind(this));}var s,h;for(var i=0;i<p.length;i++){s=p[i];h=o[s];if(C.last("/core/shell/enablePersonalization")){g.push(_.call(this,s,h));}else{g.push(Promise.resolve(h));}}return Promise.all(g);}.bind(this));};f.prototype.getApplications=function(){return new Promise(function(r,g){this._oSiteDeferred.then(function(s){var A=s.applications;if(A){r(A);}else{g("CDM applications not found.");}}).fail(g);}.bind(this));};f.prototype.getVisualizations=function(){return new Promise(function(r,g){this._oSiteDeferred.then(function(s){var v=s.visualizations;if(v){r(v);}else{g("CDM visualizations not found.");}}).fail(g);}.bind(this));};f.prototype.getGroupFromOriginalSite=function(g){var D=new q.Deferred();if(typeof g==="string"&&this._oOriginalSite&&this._oOriginalSite.groups&&this._oOriginalSite.groups[g]){D.resolve(q.extend(true,{},this._oOriginalSite.groups[g]));}else{D.reject("Group does not exist in original site.");}return D.promise();};f.prototype.getOriginalPage=function(p){return this._oOriginalSite.pages[p];};f.prototype.save=function(p){var D=new q.Deferred(),o,g;if(this._oOriginalSite._version==="3.1.0"){if(!p){return D.reject("No page id was provided").promise();}g=this._oSiteConverter.convertTo("3.0.0",this._oOriginalSite.pages[p]);o=this._oSiteConverter.convertTo("3.0.0",this._oPersonalizedPages[p]);}else{g=this._oOriginalSite;o=this._oPersonalizedSite;}this._oPersonalizationProcessor.extractPersonalization(o,g).done(function(E){if(!b(E)){if(this._mPersonalizationDeltas.version===undefined){this._mPersonalizationDeltas.version=this._oOriginalSite._version;}this._mPersonalizationDeltas[p]=E;this._setPersonalization(this._mPersonalizationDeltas).then(D.resolve).catch(D.reject);}else{D.resolve();}}.bind(this)).fail(function(){D.reject("Personalization Processor: Cannot extract personalization.");});return D.promise();};f.prototype._setPersonalization=function(g,p){if(this._oPendingPersonalizationDeferred){if(!this._oNextPersonalizationQuery){this._oNextPersonalizationQuery={fnNextCall:null,aPromiseResolvers:[]};}return new Promise(function(r,h){this._oNextPersonalizationQuery.fnNextCall=this._setPersonalization.bind(this,g,p);this._oNextPersonalizationQuery.aPromiseResolvers.push({resolve:r,reject:h});}.bind(this));}this._oPendingPersonalizationDeferred=this._oAdapter.setPersonalization(g,p);return new Promise(function(r,h){this._oPendingPersonalizationDeferred.then(r).fail(h).always(function(){delete this._oPendingPersonalizationDeferred;if(this._oNextPersonalizationQuery){var n=this._oNextPersonalizationQuery.fnNextCall();this._cleanupPersonalizationQueuePromises(n,this._oNextPersonalizationQuery.aPromiseResolvers);delete this._oNextPersonalizationQuery;}}.bind(this));}.bind(this));};f.prototype._cleanupPersonalizationQueuePromises=function(n,g){g.forEach(function(p){n.then(p.resolve).catch(p.reject);});};function l(){var p=sap.ushell.Container.getService("PluginManager");return p.loadPlugins("ContentProvider");}f.prototype._getUnreferencedCatalogApplications=function(E){var u={};var A=Object.keys(E.applications).map(function(s){return E.applications[s]["sap.app"].id;}).reduce(function(i,s){i[s]=true;return i;},{});var o=E.catalogs;Object.keys(o).forEach(function(s){var g=o[s].payload.appDescriptors;g.map(function(h){return h.id;}).filter(function(h){return!A[h];}).forEach(function(B){if(!u.hasOwnProperty(s)){u[s]={};}u[s][B]=true;});});return u;};f.prototype._formatUnreferencedApplications=function(s,u){return"One or more apps from "+s+" content provider are not listed among the applications section "+"of the extended site and will be discarded - "+Object.keys(u).map(function(g){var B=Object.keys(u[g]).map(function(U){return"'"+U+"'";});return"From catalog '"+g+"': "+B.join(", ");}).join("; ");};f.prototype._removeUnreferencedApplications=function(E,u){Object.keys(E.catalogs).forEach(function(s){var o=E.catalogs[s].payload;var A=o.appDescriptors;o.appDescriptors=A.filter(function(g){return u[s]&&!u[s][g.id];});});};f.prototype.getExtensionSites=function(){var t=this;var D=new q.Deferred();l().done(function(){var g=Object.keys(t._oContentProviderIndex),T=g.length;if(T===0){D.resolve([]);return;}var G=g.map(function(s,i){var o=t._oContentProviderIndex[s];var h;try{h=o.getSite();if(!h||typeof h.then!=="function"){throw"getSite does not return a Promise";}}catch(E){h=Promise.reject("call to getSite failed: "+E);}return h.then(function(s,j){var k=q.extend(true,{},j);var u=t._getUnreferencedCatalogApplications(j);if(Object.keys(u).length>0){var m=t._formatUnreferencedApplications(s,u);q.sap.log.error(m,null,c);t._removeUnreferencedApplications(k,u);}var L={providerId:s,success:true,site:k};D.notify(L);return L;}.bind(null,s),function(s,j){return{providerId:s,success:false,error:j};}.bind(null,s));});Promise.all(G).then(function(L){D.resolve(L);});});return D.promise();};f.prototype.registerContentProvider=function(i,s){if(this._oContentProviderIndex[i]){q.sap.log.error("a content provider with ID '"+i+"' is already registered",null,c);return;}this._oContentProviderIndex[i]=s;q.sap.log.debug("ContentProvider '"+i+"' was registered",null,c);};f.prototype._ensureCompleteSite=function(p){if(p.groups){var g=p.groups;Object.keys(g).forEach(function(k){if(!g[k]){delete g[k];}else{if(!g[k].payload){g[k].payload={};}if(!g[k].payload.links){g[k].payload.links=[];}if(!g[k].payload.tiles){g[k].payload.tiles=[];}if(!g[k].payload.groups){g[k].payload.groups=[];}}});}return p;};f.prototype._ensureGroupsOrder=function(s){var g=O.get("site.payload.groupsOrder",s),G=s.groups,h,i=0;if(!g){return s;}while(i<g.length){h=g[i];if(!G[h]){g.splice(i,1);}else{i++;}}return s;};f.prototype.getPlugins=(function(){var D,E,p;E=function(s,o){var g,n=Object.keys(o).length;if(n===0){return{};}if(!o.hasOwnProperty("Shell-plugin")){q.sap.log.error("Cannot find inbound with id 'Shell-plugin' for plugin '"+s+"'","plugin startup configuration cannot be determined correctly",c);return{};}if(n>1){q.sap.log.warning("Multiple inbounds are defined for plugin '"+s+"'","plugin startup configuration will be determined using "+"the signature of 'Shell-plugin' inbound.",c);}g=O.get("signature.parameters",o["Shell-plugin"])||{};return Object.keys(g).reduce(function(r,N){var h=O.get(N+".defaultValue.value",g);if(typeof h==="string"){r[N]=h;}return r;},{});};D=function(o){Object.keys(o).filter(function(s){return typeof o[s]==="object";}).forEach(function(s){o[s]=D(o[s]);});return Object.freeze(o);};return function(o){if(o!==undefined){p=o;}if(p){return q.when(p);}p={};return this.getSite().then(function(s){var A=s.applications||{};Object.keys(A).filter(function(g){return O.get("type",this[g]["sap.flp"])==="plugin";},A).forEach(function(g){var h,i,j=this[g],k={};if(!a(j["sap.platform.runtime"])){q.sap.log.error("Cannot find 'sap.platform.runtime' section for plugin '"+g+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else if(!a(j["sap.platform.runtime"].componentProperties)){q.sap.log.error("Cannot find 'sap.platform.runtime/componentProperties' "+"section for plugin '"+g+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else{k=j["sap.platform.runtime"].componentProperties;}p[g]={url:k.url,component:j["sap.ui5"].componentName};var m=O.get("crossNavigation.inbounds",j["sap.app"])||{};i=E(g,m);h=q.extend(k.config||{},i);if(h){p[g].config=h;}if(k.asyncHints){p[g].asyncHints=k.asyncHints;}},A);return D(p);},function(v){return v;});};})();f.prototype._ensureStandardVizTypesPresent=function(s){if(!(s._version&&s._version.startsWith("3."))){return s;}if(!s.vizTypes){s.vizTypes={};}if(!s.vizTypes[e.STATIC_LAUNCHER]){s.vizTypes[e.STATIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncher/manifest.json");}if(!s.vizTypes[e.DYNAMIC_LAUNCHER]){s.vizTypes[e.DYNAMIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncherdynamic/manifest.json");}if(!s.vizTypes[e.CARD]){s.vizTypes[e.CARD]=q.sap.loadResource("sap/ushell/services/_CommonDataModel/vizTypeDefaults/cardManifest.json");}return s;};f.hasNoAdapter=false;return f;},true);
