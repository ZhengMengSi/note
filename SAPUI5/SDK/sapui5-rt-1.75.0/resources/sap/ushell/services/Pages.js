// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/utils/RestrictedJSONModel","sap/base/util/deepClone","sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/resources","sap/ushell/utils"],function(L,r,R,d,a,b,u){"use strict";var P=function(){this.COMPONENT_NAME="sap/ushell/services/Pages";this._oCdmServicePromise=sap.ushell.Container.getServiceAsync("CommonDataModel");this._oVisualizationLoadingServicePromise=sap.ushell.Container.getServiceAsync("VisualizationLoading");this._oPagesModel=new R({pages:[]});};P.prototype._generateId=function(p){var i=[];var o=this.getModel().getProperty(this.getPagePath(p));o.sections.forEach(function(s){i.push(s.id);s.visualizations.forEach(function(v){i.push(v.id);});});return u.generateUniqueId(i);};P.prototype.getModel=function(){return this._oPagesModel;};P.prototype.getPageIndex=function(p){var c=this._oPagesModel.getProperty("/pages");for(var i=0;i<c.length;++i){if(c[i].id===p){return i;}}return undefined;};P.prototype.getPagePath=function(p){var i=this.getPageIndex(p);if(typeof i==="undefined"){return"";}return"/pages/"+i;};P.prototype.loadPage=function(p){var s=this.getPagePath(p);if(s){return Promise.resolve(s);}return Promise.all([this._oCdmServicePromise,this._oVisualizationLoadingServicePromise]).then(function(S){var c=S[0];var v=S[1];return Promise.all([c.getPage(p),c.getVisualizations(),c.getApplications(),v.loadVisualizationData()]).then(function(e){var o=e[0];var V=e[1];var A=e[2];var i=this._oPagesModel.getProperty("/pages/").length;var n="/pages/"+i;this._oPagesModel._setProperty(n,this._getModelForPage(o,V,A));return n;}.bind(this)).catch(function(e){L.error("Pages: Failed to gather site data.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));}.bind(this)).catch(function(e){L.error("Pages: Couldn't resolve CDM Service or Visualization Loading Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));};P.prototype.findVisualization=function(v,p){return this._oCdmServicePromise.then(function(c){return Promise.all([this.loadPage(p),c.getVisualizations(),c.getApplications()]);}.bind(this)).then(function(c){var s=c[0];var e=this.getModel().getProperty(s+"/sections")||[];return e.reduce(function(f,g,h){var V=g.visualizations.reduce(function(i,j,k){if(j.vizId===v){i.push(k);}return i;},[]);if(V.length){f.push({pageId:p,sectionIndex:h,vizIndexes:V});}return f;},[]);}.bind(this));};P.prototype.moveVisualization=function(p,s,S,t,T){if(s===t&&S===T){return Promise.resolve();}this._setDirtyState();var o=this._oPagesModel.getProperty("/pages/"+p);var c=o.id;var e=o.sections[s];var f=o.sections[t];var g=e.id;var h=f.id;var m=e.visualizations[S];var M=m.id;e.visualizations.splice(S,1);if(T===-1){T=f.visualizations.length;}else if(s===t&&S<T){T--;}f.visualizations.splice(T,0,m);if(e.default&&!e.visualizations.length){o.sections.splice(s,1);}this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(C){C.getPage(c).then(function(i){var e=i.payload.sections[g];var j=e.payload.layout.vizOrder;var k=e.payload.viz;var f=i.payload.sections[h];var l=f.payload.layout.vizOrder;var n=f.payload.viz;var q=d(k[M]);j.splice(j.indexOf(M),1);l.splice(T,0,M);if(g!==h){delete k[M];n[M]=q;}if(e.payload.default&&!Object.keys(k).length){delete i.payload.sections[g];i.payload.layout.sectionOrder.splice(s,1);}this.savePersonalization(c);}.bind(this)).catch(function(){L.error("Personalization cannot be saved: CDM Service cannot retrieve the required page");}).catch(function(){L.error("Personalization cannot be saved: CDM Service cannot be retrieved");});}.bind(this));};P.prototype.deleteVisualization=function(p,s,S){var o=this._oPagesModel.getProperty("/pages/"+p);var c=o.sections[s];if(c.default&&c.visualizations.length<2){return this.deleteSection(p,s);}this._setDirtyState();var e=c.visualizations;var f=e[S];e.splice(S,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(C){return C.getPage(o.id);}).then(function(g){var h=g.payload.sections[c.id].payload.layout.vizOrder;var v=g.payload.sections[c.id].payload.viz;Object.keys(v).forEach(function(V){if(v[V].vizId===f.vizId){delete v[V];h.splice(S,1);}});this.savePersonalization(g.identification.id);}.bind(this));};P.prototype._getSectionIndex=function(p,s){var S=this.getModel().getProperty(p+"/sections")||[],i=0;for(;i<S.length;i+=1){if(S[i].id===s){return i;}}return undefined;};P.prototype._getVisualizationData=function(v,V,A,o,p){var c=o||{};var s=r.getAppId(V[v]),C=[c,r.getConfig(V[v]),a.getInbound(A[s]),A[s]];return{id:c.id||this._generateId(p),vizId:v||"",vizType:r.getTypeId(V[v])||"",title:r.getTitle(C)||"",subTitle:r.getSubTitle(C)||"",icon:r.getIcon(C)||"",keywords:r.getKeywords(C)||[],info:r.getInfo(C)||"",target:r.getTarget(V[v])||{}};};P.prototype.addVisualization=function(v,p,s){return this._oCdmServicePromise.then(function(c){return Promise.all([this.loadPage(p),c.getVisualizations(),c.getApplications()]).then(function(e){var f=e[0],S=this._getSectionIndex(f,s),g=this.getModel().getProperty(f+"/sections")||[],V=this._getVisualizationData(v,e[1],e[2],{},p);var D;for(var i=0;i<g.length;i++){if(g[i].default){D=i;}}if(S!==undefined||D!==undefined){this._setDirtyState();var h=S!==undefined?S:D||0,j=f+"/sections/"+h+"/visualizations";this.getModel().getProperty(j).push(V);this.getModel().refresh();return c.getPage(p).then(function(o){var l=o.payload.sections[s||o.payload.layout.sectionOrder[0]];l.payload.layout.vizOrder.push(V.id);l.payload.viz[V.id]={id:V.id,vizId:v};this.savePersonalization(p);}.bind(this));}var k=parseInt(f.split("/")[2],10);return this.addSection(k,0,{title:b.i18n.getText("DefaultSection.Title"),default:true,visualizations:[V]});}.bind(this));}.bind(this));};P.prototype.moveSection=function(p,s,t){if(s===t){return Promise.resolve();}this._setDirtyState();var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var m=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);var M=m.id;S.splice(s,1);if(s<t){t--;}S.splice(t,0,m);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(C){C.getPage(c).then(function(e){var f=e.payload.layout.sectionOrder;f.splice(f.indexOf(M),1);f.splice(t,0,M);this.savePersonalization(c);}.bind(this)).catch(function(){L.error("Personalization cannot be saved: CDM Service cannot retrieve the required page");});}.bind(this)).catch(function(){L.error("Personalization cannot be saved: CDM Service cannot be retrieved");});};P.prototype.addSection=function(p,s,S){this._setDirtyState();var o=S||{},c=this._oPagesModel.getProperty("/pages/"+p+"/sections"),e=this._oPagesModel.getProperty("/pages/"+p+"/id");var n={id:o.id!==undefined?o.id:this._generateId(e),title:o.title!==undefined?o.title:"",visible:o.visible!==undefined?o.visible:true,preset:o.preset!==undefined?o.preset:false,locked:o.locked!==undefined?o.locked:false,default:o.default!==undefined?o.default:false,visualizations:o.visualizations!==undefined?o.visualizations:[]};c.splice(s,0,n);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(C){return C.getPage(e).then(function(f){var g={visible:n.visible,preset:n.preset,locked:n.locked,default:n.default,layout:{vizOrder:[]},viz:{}};if(n.visualizations){var i=0,v;for(;i<n.visualizations.length;i++){v=n.visualizations[i];g.layout.vizOrder.push(v.id);if(v.isBookmark){g.viz[v.id]=v;}else{g.viz[v.id]={id:v.id,vizId:v.vizId};}}}var h={identification:{id:n.id,title:n.title},payload:g};f.payload.layout.sectionOrder.splice(s,0,n.id);f.payload.sections[n.id]=h;this.savePersonalization(e);}.bind(this));}.bind(this));};P.prototype.deleteSection=function(p,s){this._setDirtyState();var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var e=S[s].id;S.splice(s,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(C){return C.getPage(c).then(function(o){delete o.payload.sections[e];o.payload.layout.sectionOrder.splice(s,1);this.savePersonalization(c);return Promise.resolve(o);}.bind(this)).catch(function(E){L.error("Pages: Failed to get Page from CDM Service.",E,this.COMPONENT_NAME);this.cancelPersonalization();return Promise.reject(E);}.bind(this));}.bind(this)).catch(function(E){L.error("Pages: Failed to get CDM Service.",E,this.COMPONENT_NAME);this.cancelPersonalization();return Promise.reject(E);}.bind(this));};P.prototype.setSectionVisibility=function(p,s,v){this._setDirtyState();var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");var o=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);if(o.visible===v){return Promise.resolve();}o.visible=v;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(C){return C.getPage(c).then(function(e){e.payload.sections[S].payload.visible=v;this.savePersonalization(c);return Promise.resolve(e);}.bind(this)).catch(function(e){L.error("Pages: Failed to get Page from CDM Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));}.bind(this)).catch(function(e){L.error("Pages: Failed to get CDM Service.",e,this.COMPONENT_NAME);this.cancelPersonalization();return Promise.reject(e);}.bind(this));};P.prototype.renameSection=function(p,s,n){this._setDirtyState();var o=this._oPagesModel.getProperty("/pages/"+p);var S=o.sections[s];S.title=n;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(c){return c.getPage(o.id);}).then(function(c){c.payload.sections[S.id].identification.title=n;this.savePersonalization(c.identification.id);}.bind(this));};P.prototype.resetSection=function(p,s){this._setDirtyState();var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");return this._oCdmServicePromise.then(function(C){return Promise.all([C.getVisualizations(),C.getApplications(),C.getPage(c)]).then(function(e){var v=e[0];var A=e[1];var o=e[2];var O=C.getOriginalPage(c);var f=this._getModelForPage(O,v,A);var g=d(f.sections.find(function(j){return j.id===S;}));var h=g.visualizations.map(function(V){return V.id;});var i=this._oPagesModel.getProperty("/pages/"+p);i.sections.forEach(function(j){if(g.id!==j.id){j.visualizations.forEach(function(V){if(h.indexOf(V.id)!==-1){var n=this._generateId(c);var k=d(o.payload.sections[j.id].payload.viz[V.id]);delete o.payload.sections[j.id].payload.viz[V.id];var l=o.payload.sections[j.id].payload.layout.vizOrder.indexOf(k.id);k.id=n;o.payload.sections[j.id].payload.viz[n]=k;o.payload.sections[j.id].payload.layout.vizOrder[l]=n;V.id=n;}}.bind(this));}}.bind(this));this._oPagesModel._setProperty("/pages/"+p+"/sections/"+s,g);o.payload.sections[g.id]=O.payload.sections[g.id];return this.savePersonalization(o.identification.id);}.bind(this)).catch(function(e){L.error("Pages: Failed to gather data from CDM Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));}.bind(this)).catch(function(e){L.error("Pages: Couldn't resolve CDM Service.",e,this.COMPONENT_NAME);this.cancelPersonalization();return Promise.reject(e);}.bind(this));};P.prototype.resetPage=function(p){this._setDirtyState();var s=this._oPagesModel.getProperty("/pages/"+p+"/id");return this._oCdmServicePromise.then(function(c){return Promise.all([c.getVisualizations(),c.getApplications(),c.getPage(s)]).then(function(S){var o=c.getOriginalPage(s);var v=S[0];var A=S[1];var C=S[2];var O=this._getModelForPage(o,v,A);this._oPagesModel._setProperty("/pages/"+p,O);C.payload=d(o.payload);this.savePersonalization(C.identification.id);}.bind(this)).catch(function(e){L.error("Pages: Failed to gather data from CDM Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));}.bind(this)).catch(function(e){L.error("Pages: Couldn't resolve CDM Service.",e,this.COMPONENT_NAME);this.cancelPersonalization();return Promise.reject(e);}.bind(this));};P.prototype._setDirtyState=function(){if(!this._bDirtyState){this._bDirtyState=true;this._oCopiedModelData=d(this._oPagesModel.getProperty("/"));}};P.prototype.savePersonalization=function(p){return this._oCdmServicePromise.then(function(c){return c.save(p).then(function(){L.info("Save CDM Model");this._bDirtyState=false;}.bind(this));}.bind(this));};P.prototype.cancelPersonalization=function(){if(this._bDirtyState){this._oPagesModel._setData(this._oCopiedModelData);this._bDirtyState=false;}};P.prototype._getModelForPage=function(p,v,c){var o={id:p.identification.id||"",title:p.identification.title||"",description:"",sections:[]};p.payload.layout.sectionOrder.forEach(function(s){var C=p.payload.sections[s];var S={id:C.identification.id||"",title:C.identification.title||"",visualizations:[],visible:C.payload.visible!==undefined?C.payload.visible:true,locked:C.payload.locked!==undefined?C.payload.locked:false,preset:C.payload.preset!==undefined?C.payload.preset:true,default:C.payload.default!==undefined?C.payload.default:false};C.payload.layout.vizOrder.forEach(function(i){var V=C.payload.viz[i],e=V.vizId,f=V.isBookmark?V:this._getVisualizationData(e,v,c,V,p.identification.id);S.visualizations.push(f);}.bind(this));o.sections.push(S);}.bind(this));return o;};P.prototype.addBookmarkToPage=function(c,p){if(!p){return Promise.reject("Pages Service - Adding bookmark tile failed: No page id is provided.");}this._setDirtyState();return this.loadPage(p).then(function(e){var v=c;v.isBookmark=true;v.id=this._generateId(p);var i=parseInt(/pages\/(\d+)/.exec(e)[1],10);var o=this._oPagesModel.getProperty(e);var D=o.sections.find(function(s){return s.default;});if(!D){return this.addSection(i,0,{title:b.i18n.getText("DefaultSection.Title"),default:true,visualizations:[v]});}D.visualizations.push(v);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(C){C.getPage(p).then(function(f){var s=f.payload.sections[D.id];s.payload.layout.vizOrder.push(v.id);s.payload.viz[v.id]=v;this.savePersonalization(p);}.bind(this));}.bind(this));}.bind(this)).catch(function(e){L.error("Pages Service - Insert New Bookmark Tile Failed");return Promise.reject(e);});};P.hasNoAdapter=true;return P;},true);
