// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/model/odata/v2/ODataModel","sap/ushell/resources","sap/ushell/utils/clone"],function(O,a,r,c){"use strict";var P=function(s,p,b){this.S_COMPONENT_NAME="sap.ushell_abap.adapters.abap.PagePersistenceAdapter";var d=(O.get("config.serviceUrl",b)||"").replace(/\/?$/,"/");this._oODataModel=new a({serviceUrl:d,headers:{"sap-language":sap.ushell.Container.getUser().getLanguage(),"sap-client":(s&&s.getClient())||sap.ushell.Container.getLogonSystem().getClient()},defaultCountMode:"None",skipMetadataAnnotationParsing:true,useBatch:false});this._oMetadataPromise=new Promise(function(e,f){this._oODataModel.attachMetadataLoaded(e);this._oODataModel.attachMetadataFailed(f);}.bind(this));};P.prototype.getPage=function(p){return this._readPage(p).then(this._convertODataToReferencePage).catch(this._rejectWithError.bind(this));};P.prototype.getPages=function(p){return this._readPages(p).then(function(b){return b.results.map(this._convertODataToReferencePage);}.bind(this)).catch(this._rejectWithError.bind(this));};P.prototype._readPage=function(p){return this._oMetadataPromise.then(function(){return new Promise(function(b,d){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"sections/tiles"},success:b,error:d});}.bind(this));}.bind(this));};P.prototype._readPages=function(p){return this._oMetadataPromise.then(function(){return new Promise(function(b,d){sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(F,e){var f=[],o;for(var i=0;i<p.length;i++){o=new F({path:"id",operator:e.EQ,value1:encodeURIComponent(p[i]),and:false});f.push(o);}return this._oODataModel.read("/pageSet",{urlParameters:{"$expand":"sections/tiles"},filters:f,success:b,error:d});}.bind(this));}.bind(this));}.bind(this));};P.prototype._convertODataToReferencePage=function(p){var o=c(p);delete o.__metadata;if(o.sections&&o.sections.results){o.sections=o.sections.results;o.sections.forEach(function(s){delete s.__metadata;s.visualizations=s.tiles.results;delete s.tiles;s.visualizations.forEach(function(v){delete v.__metadata;v.vizId=v.catalogTile;v.inboundPermanentKey=v.targetMapping;});});}if(!o.createdByFullname&&o.createdBy){o.createdByFullname=o.createdBy;}if(!o.modifiedByFullname&&o.modifiedBy){o.modifiedByFullname=o.modifiedBy;}return o;};P.prototype._rejectWithError=function(e){var E={component:this.S_COMPONENT_NAME,description:r.i18n.getText("PagePersistenceAdapter.CannotLoadPage"),detail:e};return Promise.reject(E);};return P;},true);
