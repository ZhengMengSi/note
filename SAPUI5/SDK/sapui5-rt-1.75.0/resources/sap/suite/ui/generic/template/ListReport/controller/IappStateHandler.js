sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/base/Log","sap/base/util/deepEqual","sap/base/util/extend"],function(B,C,N,S,U,L,d,e){"use strict";var a="sap.suite.ui.generic.template.customData",b="sap.suite.ui.generic.template.extensionData",c="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var i=L.getLevel();if(i<L.Level.INFO){L.setLevel(L.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var h="";for(var k in D){s=s+h+k+": "+D[k];h="; ";}}L.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,o,t){var h=t.oCommonUtils.getNavigationHandler();var j=o.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var k=false;var m=null;var A=Promise.resolve();var D=false;var p=false;var q;var u=null;var v=null;s.oSmartFilterbar.setSuppressSelection(true);var w=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function x(){return D;}function y(){var k1={};var l1=[];var m1=w();for(var i=0;i<m1.length;i++){var n1=m1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(n1)){l1.push(n1);}}var o1={suppressDataSelection:!D,visibleCustomFields:l1};k1[c]=o1;if(t.oComponentUtils.isDraftEnabled()){var p1=t.oComponentUtils.getTemplatePrivateModel();o1.editStateFilter=p1.getProperty("/listReport/vDraftState");var q1=p1.getProperty("/listReport/activeObjectEnabled");o1.activeStateFilter=q1;}var r1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(r1){var s1=s.oMultipleViewsHandler.getContentForIappState();if(s1){o1[r1]=s1.state;}}if(s.oWorklistData.bWorkListEnabled){var t1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var u1={"searchString":t1};o1.Worklist=u1;}var v1={};k1[a]=v1;o.getCustomAppStateDataExtension(v1);var w1;var x1=true;var y1=function(z1,A1){if(!(z1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!x1){throw new Error("State must always be provided synchronously");}if(A1){w1=w1||Object.create(null);var B1=z1.getMetadata().getNamespace();w1[B1]=A1;}};o.templateBaseExtension.provideExtensionAppStateData(y1);x1=false;if(w1){k1[b]=w1;}return k1;}function z(){var k1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var l1=new S(k1);var m1=o.getVisibleSelectionsWithDefaults();for(var i=0;i<m1.length;i++){if(!l1.getValue(m1[i])){l1.addSelectOption(m1[i],"I","EQ","");}}if(o.byId('template::PageVariant')&&o.byId('template::PageVariant').currentVariantGetModified()&&l1.getID()){l1.setID("");}if(s.oWorklistData.bWorkListEnabled){var n1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";l1.addSelectOption("Worklist.SearchField","I","EQ",n1);}var o1={selectionVariant:l1.toJSONString(),tableVariantId:(!j&&s.oSmartTable.getCurrentVariantId())||"",customData:y()};return o1;}function E(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:p,bDataAreShownInTable:D});if(!p){return;}p=false;try{u=h.storeInnerAppStateWithImmediateReturn(z(),true);}catch(i){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(u instanceof N){p=true;u=null;return;}u.promise.fail(function(k1){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+k1);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:u.appStateKey,sAppStateKeyInUrl:v});if(v===u.appStateKey){u=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:u.appStateKey});h.replaceHash(u.appStateKey);}}function R(k1,l1){var m1=t.oComponentUtils.getTemplatePrivateModel();if(k1&&t.oComponentUtils.isDraftEnabled()){m1.setProperty("/listReport/vDraftState",k1.editStateFilter||"0");m1.setProperty("/listReport/activeObjectEnabled",!!k1.activeStateFilter);s.oMultipleViewsHandler.restoreActiveButtonState(k1);}var n1=k1&&k1.visibleCustomFields;if(n1&&n1.length>0){var o1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<o1.length;i++){var p1=o1[i];var q1=p1.getName();if(n1.indexOf(q1)!==-1){p1.setVisibleInFilterBar(true);}}}D=l1&&!(k1&&k1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();d1(D);}}function F(i,j){if(j){var k1=i['sap-ui-fe-variant-id'];if(k1&&k1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(k1[0]);}}else{var l1=i['sap-ui-fe-variant-id'],m1=i['sap-ui-fe-filterbar-variant-id'],n1=i['sap-ui-fe-chart-variant-id'],o1=i['sap-ui-fe-table-variant-id'];G(m1&&m1[0],n1&&n1[0],o1&&o1[0],l1&&l1[0]);}}function G(i,k1,l1,m1){if(i||m1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||m1);}if(s.oSmartTable&&(l1||m1)){s.oSmartTable.attachAfterVariantInitialise(function(n1){s.oSmartTable.setCurrentVariantId(l1||m1);});s.oSmartTable.setCurrentVariantId(l1||m1);}s.oMultipleViewsHandler.setControlVariant(k1,l1,m1);}function H(i){o.restoreCustomAppStateDataExtension(i||{});}function J(i){if(!i){return;}var k1=true;var l1=function(m1){if(!(m1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var n1=m1.getMetadata().getNamespace();if(!k1){throw new Error("State must always be restored synchronously");}return i[n1];};o.templateBaseExtension.restoreExtensionAppStateData(l1);k1=false;}function K(i,k1){i=i||{};if(i.hasOwnProperty(a)&&i.hasOwnProperty(c)){J(i[b]);H(i[a]);R(i[c],k1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}H(i);}s.oSmartFilterbar.fireFilterChange();}function M(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":r.appStateKey};}return{};});}function O(i){var k1=t.oComponentUtils.getTemplatePrivateModel();k1.setProperty("/generic/bDataAreShownInTable",i);}function P(i,k1){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:k1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:k,bAppStateDirty:p});O(k1);if(k){return;}if(i||k1!==D){D=k1;if(!p){p=true;if(!s.oSmartFilterbar.isDialogOpen()){if(m){E();}else{setTimeout(E,0);}}}}}function Q(i){var k1=s.oSmartFilterbar.determineMandatoryFilterItems(),l1;for(var m1=0;m1<k1.length;m1++){if(k1[m1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){l1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(l1){i.oSelectionVariant.addParameter("P_DisplayCurrency",l1);}}break;}}}function T(){var k1=s.oSmartFilterbar.determineMandatoryFilterItems();var l1=s.oSmartFilterbar.getFiltersWithValues();for(var i=0;i<k1.length;i++){if(l1.indexOf(k1[i])===-1){return true;}}return false;}function V(i,k1,l1){l("fnAdaptToAppState called",{sNavType:l1,sAppStateKeyInUrl:v,sAppStateKey:i.appStateKey,storingInformationAppStateKey:u&&u.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=l1;var m1=i.appStateKey||"";if(k){return;}if(v===null){v=m1;}else if(m1!==v){return;}var n1=(!m1&&k1)||{};F(n1,j);k=true;var o1=i.selectionVariant||"";var p1=(!j&&i.tableVariantId)||"";var q1=i.oSelectionVariant||"";var r1={selectionVariant:q1,urlParameters:k1,selectedQuickVariantSelectionKey:""};var s1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var t1=JSON.parse(JSON.stringify(s1));var u1=s1.getSelectOption(a);var v1=s1.getSelectOption(c);if((r.appStateKey!==m1||r.selectionVariant!==o1||r.tableVariantId!==p1||f(r.urlParams,n1))&&l1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!u||u.appStateKey!==m1){var w1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){Q(i);}if(!s.oWorklistData.bWorkListEnabled){if(!w1||s.oSmartFilterbar.isCurrentVariantStandard()){r1.selectionVariant=i.oSelectionVariant;if(l1!==sap.ui.generic.app.navigation.service.NavType.iAppState){o.modifyStartupExtension(r1);j1(r1.selectionVariant,r,o1,true);}else{j1(r1.selectionVariant,r,o1,!w1);}}else{f1(s1,u1,v1,true);r1.selectionVariant=s1;o.modifyStartupExtension(r1);f1(r1.selectionVariant,u1,v1,false);if(!d(JSON.parse(JSON.stringify(r1.selectionVariant)),t1)){j1(r1.selectionVariant,r,o1,true);}}}if(p1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(p1);}i.customData=i.customData||{};var x1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(x1&&i.customData[c]&&i.customData[c][x1]){s.oMultipleViewsHandler.restoreFromIappState(i.customData[c][x1]);}if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[c]&&i.customData[c]["Worklist"]?i.customData[c]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}K(i.customData,true);}r={appStateKey:m1,urlParams:n1,selectionVariant:o1,tableVariantId:p1};}if(l1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(l1===sap.ui.generic.app.navigation.service.NavType.initial){f1(s1,u1,v1,true);r1.selectionVariant=s1;o.modifyStartupExtension(r1);f1(r1.selectionVariant,u1,v1,false);if(!d(JSON.parse(JSON.stringify(r1.selectionVariant)),t1)){j1(r1.selectionVariant,r,o1,true);}}s.oMultipleViewsHandler.handleStartUpObject(r1);}if(m){m();m=null;}if(s.oWorklistData.bWorkListEnabled){if(l1==="initial"&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}else if(l1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var y1=(l1===sap.ui.generic.app.navigation.service.NavType.xAppState||l1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;if(s.oSmartFilterbar.isCurrentVariantStandard()){D=s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser;}else{D=s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();}if(D===null||D===undefined){D=y1||s.bLoadListAndFirstEntryOnStartup||q||s.oMultipleViewsHandler.getEnableAutoBinding();}var z1=T();if(z1&&s.oSmartFilterbar.isCurrentVariantStandard()&&!s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser&&s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML){s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML=false;D=false;}O(D);if(D){s.oSmartFilterbar.search();d1(D);}}u=null;k=false;}function W(){if(!m){A=new Promise(function(k1){m=k1;});}var i=new Promise(function(k1,l1){var m1=v;var n1=h.parseNavigation();n1.done(function(o1,p1,q1){V(o1,p1,q1);k1();});n1.fail(function(o1,p1,q1){L.warning(o1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");V({appStateKey:m1},p1,sap.ui.generic.app.navigation.service.NavType.initial);k1();});});return i;}function X(){var i=s.oSmartFilterbar.getFilterData();var k1,l1=s.oSmartFilterbar.getBasicSearchControl();if(l1&&l1.getValue){k1=l1.getValue();}var m1=z();i._CUSTOM=m1.customData;s.oSmartFilterbar.setFilterData(i,true);if(k1){l1.setValue(k1);}s.oSmartFilterbar.fireFilterChange();}function Y(){P(true,D);}function Z(i){var k1=i.getParameter("context");var l1=s.oSmartFilterbar.getFilterData();if(l1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var m1=l1._CUSTOM[c]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(m1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{K(l1._CUSTOM);}}else{var n1=y();n(n1[a]);n(n1[c]);K(n1);}if(I.indexOf(k1)<0){D=i.getParameter("executeOnSelect");P(true,D);}}function $(){if(!j){P(true,D);}}function _(){if(!j){P(true,D);}}function a1(i){v=i["sap-iapp-state"]||"";if(u){if(u.appStateKey!==v){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+v+" expected "+u.appStateKey);return false;}W();return true;}return false;}function b1(){q=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(E);}function c1(){q=s.oSmartTable.getEnableAutoBinding()||s.oMultipleViewsHandler.getEnableAutoBinding();if(q){var i=new sap.ui.core.CustomData({key:"executeStandardVariantOnSelect",value:true});s.oSmartFilterbar.addCustomData(i);}}function d1(D){var i=o.getOwnerComponent().getModel("_templPriv");var k1=T();if(D&&k1){i.setProperty("/listReport/isHeaderExpanded",true);}else if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}function e1(i,k1,l1){var m1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(m1,{replace:k1,strictMode:l1});}function f1(i,k1,l1,m1){if(i&&(k1||l1)){if(m1){i.removeSelectOption(a);i.removeSelectOption(c);}else{i.massAddSelectOption(a,k1);i.massAddSelectOption(c,l1);}}}function g1(k1,r,l1){if(k1&&(r.selectionVariant!==l1||s.sNavType==="initial")){var m1=k1.getParameterNames().concat(k1.getSelectOptionsPropertyNames());for(var i=0;i<m1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(m1[i]);}}}function h1(i,k1,l1){if(i.getParameter(k1)&&!i.getParameter(l1)){i.addParameter(l1,i.getParameter(k1));}if(i.getSelectOption(k1)&&!i.getSelectOption(l1)){var m1=i.getSelectOption(k1);m1.forEach(function(n1){i.addSelectOption(l1,n1.Sign,n1.Option,n1.Low,n1.High);});}}function i1(i){var k1=o.getOwnerComponent().getModel().getMetaModel();var l1=o.getOwnerComponent().getEntitySet();var m1=k1.getODataEntityType(k1.getODataEntitySet(l1).entityType);m1.property.forEach(function(n1){if(n1["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var o1=n1["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var p1=n1.name;h1(i,o1,p1);h1(i,p1,o1);}});}function j1(i,r,k1,l1){i1(i);g1(i,r,k1);e1(i.toJSONObject(),l1,false);}s.getCurrentAppState=z;return{areDataShownInTable:x,parseUrlAndApplyAppState:W,getUrlParameterInfo:M,changeIappState:P,onSmartFilterBarInitialise:b1,onBeforeSFBVariantFetch:X,onAfterSFBVariantSave:Y,onAfterSFBVariantLoad:Z,onAfterTableVariantSave:$,onAfterApplyTableVariant:_,isStateChange:a1,onSFBVariantInitialise:c1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,o,t){e(this,g(s,o,t));}});});
