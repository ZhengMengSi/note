/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/core/Control","sap/ui/integration/util/Manifest","sap/ui/integration/util/ServiceManager","sap/base/Log","sap/f/cards/DataProviderFactory","sap/f/cards/NumericHeader","sap/f/cards/Header","sap/f/cards/BaseContent","sap/f/cards/IconFormatter","sap/f/cards/BindingHelper","sap/f/cards/CardActions","sap/f/cards/NumericSideIndicator","sap/m/HBox","sap/m/VBox","sap/ui/core/Icon","sap/m/Text","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/base/util/LoaderExtensions","sap/f/CardRenderer","sap/f/library","sap/ui/integration/library","sap/ui/core/InvisibleText","sap/base/strings/formatMessage","sap/ui/integration/controls/ActionsToolbar"],function(q,C,a,b,S,L,D,N,H,B,I,c,d,e,f,V,g,T,J,R,h,i,l,j,k,m,A){"use strict";var M={TYPE:"/sap.card/type",DATA:"/sap.card/data",HEADER:"/sap.card/header",HEADER_POSITION:"/sap.card/headerPosition",CONTENT:"/sap.card/content",SERVICES:"/sap.ui5/services",APP_TYPE:"/sap.app/type",PARAMS:"/sap.card/configuration/parameters"};var n=l.cards.HeaderPosition;var o=l.cards.AreaType;var p=j.CardDataMode;function r(F,t){if(F.parts&&F.translationKey&&F.parts.length===2){var u={parts:[F.translationKey,F.parts[0].toString(),F.parts[1].toString()],formatter:function(v,P,w){var x=P||F.parts[0];var y=w||F.parts[1];if(Array.isArray(P)){x=P.length;}if(Array.isArray(w)){y=w.length;}var z=parseFloat(x)||0;var E=parseFloat(y)||0;return m(v,[z,E]);}};t.bindProperty("statusText",u);}}var s=a.extend("sap.ui.integration.widgets.Card",{metadata:{library:"sap.ui.integration",interfaces:["sap.f.ICard"],properties:{manifest:{type:"any",defaultValue:""},parameters:{type:"object",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"},dataMode:{type:"sap.ui.integration.CardDataMode",group:"Behavior",defaultValue:p.Active},baseUrl:{type:"sap.ui.core.URI",defaultValue:null}},aggregations:{_header:{type:"sap.f.cards.IHeader",multiple:false,visibility:"hidden"},_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{action:{allowPreventDefault:true,parameters:{actionSource:{type:"sap.ui.core.Control"},manifestParameters:{type:"object"},type:{type:"sap.ui.integration.CardActionType"}}},manifestReady:{parameters:{}}},associations:{hostConfigurationId:{},host:{}}},renderer:i});s.prototype.init=function(){this._ariaText=new k({id:this.getId()+"-ariaText"});this._oRb=C.getLibraryResourceBundle("sap.f");this.setModel(new J(),"parameters");this.setBusyIndicatorDelay(0);this._busyStates=new Map();};s.prototype._initReadyState=function(){this._aReadyPromises=[];this._awaitEvent("_headerReady");this._awaitEvent("_contentReady");this._awaitEvent("_cardReady");this._oReadyPromise=Promise.all(this._aReadyPromises).then(function(){this._bReady=true;this.fireEvent("_ready");}.bind(this));};s.prototype._clearReadyState=function(){this._bReady=false;this._aReadyPromises=[];this._oReadyPromise=null;};s.prototype.onBeforeRendering=function(){var t=this.getHostConfigurationId();if(this.getDataMode()!==p.Active){return;}if(t){this.addStyleClass(t.replace(/-/g,"_"));}if(this._bApplyManifest){this._bApplyManifest=false;var v=this.getManifest();this._clearReadyState();this._initReadyState();if(!v){this.destroyManifest();}else{this.createManifest(v,this.getBaseUrl());}}};s.prototype.setManifest=function(v){this.setProperty("manifest",v);this._bApplyManifest=true;return this;};s.prototype.setParameters=function(v){this.setProperty("parameters",v);this._bApplyManifest=true;return this;};s.prototype.createManifest=function(v,t){var O={};if(typeof v==="string"){O.manifestUrl=v;v=null;}this._startBusyState("applyManifest");this._oCardManifest=new b("sap.card",v,t);return this._oCardManifest.load(O).then(function(){this.fireManifestReady();this._applyManifest();}.bind(this)).catch(this._applyManifest.bind(this));};s.prototype._applyManifest=function(){var P=this.getParameters();this._registerManifestModulePath();if(this._oCardManifest&&this._oCardManifest.getResourceBundle()){var t=new R({bundle:this._oCardManifest.getResourceBundle()});t.enhance(C.getLibraryResourceBundle("sap.ui.integration"));this.setModel(t,"i18n");}this._oCardManifest.processParameters(P);this._applyManifestSettings();};s.prototype._awaitEvent=function(E){this._aReadyPromises.push(new Promise(function(t){this.attachEventOnce(E,function(){t();});}.bind(this)));};s.prototype.isReady=function(){return this._bReady;};s.prototype.refresh=function(){if(this.getDataMode()===p.Active){this._clearReadyState();this._initReadyState();this.destroyManifest();this._bApplyManifest=true;this.invalidate();}};s.prototype.exit=function(){this.destroyManifest();this._busyStates=null;this._oRb=null;if(this._ariaText){this._ariaText.destroy();this._ariaText=null;}};s.prototype.destroyManifest=function(){if(this._oCardManifest){this._oCardManifest.destroy();this._oCardManifest=null;}if(this._oServiceManager){this._oServiceManager.destroy();this._oServiceManager=null;}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null;this._oDataProvider=null;}if(this._oTemporaryContent){this._oTemporaryContent.destroy();this._oTemporaryContent=null;}this.destroyAggregation("_header");this.destroyAggregation("_content");this._aReadyPromises=null;this._busyStates.clear();};s.prototype._registerManifestModulePath=function(){if(!this._oCardManifest){return;}this._sAppId=this._oCardManifest.get("/sap.app/id");if(this._sAppId){h.registerResourcePath(this._sAppId.replace(/\./g,"/"),this._oCardManifest.getUrl());}else{L.error("Card sap.app/id entry in the manifest is mandatory");}};s.prototype.getManifest=function(){var v=this.getProperty("manifest");if(v&&typeof v==="object"){return q.extend(true,{},v);}return v;};s.prototype.getParameters=function(){var v=this.getProperty("parameters");if(v&&typeof v==="object"){return q.extend(true,{},v);}return v;};s.prototype._applyManifestSettings=function(){var t=this._oCardManifest.get(M.APP_TYPE);if(t&&t!=="card"){L.error("sap.app/type entry in manifest is not 'card'");}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy();}this._oDataProviderFactory=new D();this._applyServiceManifestSettings();this._applyDataManifestSettings();this._applyHeaderManifestSettings();this._applyContentManifestSettings();};s.prototype._applyDataManifestSettings=function(){var t=this._oCardManifest.get(M.DATA);if(!t){this.fireEvent("_cardReady");return;}if(this._oDataProvider){this._oDataProvider.destroy();}this._oDataProvider=this._oDataProviderFactory.create(t,this._oServiceManager);if(this._oDataProvider){this._startBusyState("data");this.setModel(new J());this._oDataProvider.attachDataChanged(function(E){this.getModel().setData(E.getParameter("data"));}.bind(this));this._oDataProvider.attachError(function(E){this._handleError("Data service unavailable. "+E.getParameter("message"));}.bind(this));this._oDataProvider.triggerDataUpdate().then(function(){this.fireEvent("_cardReady");this._endBusyState("data");}.bind(this));}};s.prototype._applyServiceManifestSettings=function(){var t=this._oCardManifest.get(M.SERVICES);if(!t){return;}if(!this._oServiceManager){this._oServiceManager=new S(t,this);}};s.prototype.getCardHeader=function(){return this.getAggregation("_header");};s.prototype.getCardHeaderPosition=function(){if(!this._oCardManifest){return"Top";}return this._oCardManifest.get(M.HEADER_POSITION)||n.Top;};s.prototype.getCardContent=function(){return this.getAggregation("_content");};s.prototype._applyHeaderManifestSettings=function(){var t=this._oCardManifest.get(M.HEADER),u,P,v;if(!t){this.fireEvent("_headerReady");return;}u=this._createHeader(t);v=this._createActionsToolbar();if(v){u.setToolbar(v);}P=this.getAggregation("_header");if(P){P.destroy();}this.setAggregation("_header",u);if(u.isReady()){this.fireEvent("_headerReady");}else{u.attachEvent("_ready",function(){this.fireEvent("_headerReady");}.bind(this));}};s.prototype._createHeader=function(t){var u,v=this._oServiceManager,w=this._oDataProviderFactory,x=this._sAppId,y=new d({card:this,areaType:o.Header}),z={title:t.title,subtitle:t.subTitle};if(t.status&&typeof t.status.text==="string"){z.statusText=t.status.text;}switch(t.type){case"Numeric":q.extend(z,{unitOfMeasurement:t.unitOfMeasurement,details:t.details,sideIndicators:t.sideIndicators});if(t.mainIndicator){z.number=t.mainIndicator.number;z.scale=t.mainIndicator.unit;z.trend=t.mainIndicator.trend;z.state=t.mainIndicator.state;}z=c.createBindingInfos(z);if(t.sideIndicators){z.sideIndicators=z.sideIndicators.map(function(E){return new e(E);});}u=new N(z);break;default:if(t.icon){z.iconSrc=t.icon.src;z.iconDisplayShape=t.icon.shape;z.iconInitials=t.icon.text;}z=c.createBindingInfos(z);if(z.iconSrc){z.iconSrc=c.formattedProperty(z.iconSrc,function(E){return I.formatSrc(E,x);});}u=new H(z);break;}if(t.status&&t.status.text&&t.status.text.format){r(t.status.text.format,u);}u._sAppId=x;u.setServiceManager(v);u.setDataProviderFactory(w);u._setData(t.data);u._setAccessibilityAttributes(t);y.attach(t,u);u._oActions=y;return u;};s.prototype.getHostInstance=function(){var t=this.getHost();if(!t){return null;}return C.byId(t);};s.prototype._createActionsToolbar=function(){var t=this.getHostInstance(),u,v;if(!t){return null;}u=new A();v=u.createToolbar(t,this);if(v){return u;}return null;};s.prototype._applyContentManifestSettings=function(){var t=this._oCardManifest.get(M.TYPE),u=t&&t.toLowerCase()==="component",v=this._oCardManifest.get(M.CONTENT),w=!!v,x=t+" "+this._oRb.getText("ARIA_ROLEDESCRIPTION_CARD");this._ariaText.setText(x);if(w&&!t){L.error("Card type property is mandatory!");this.fireEvent("_contentReady");return;}if(!w&&!u){this._endBusyState("applyManifest");this.fireEvent("_contentReady");return;}if(!v&&u){v=this._oCardManifest.getJson();}this._setTemporaryContent();B.create(t,v,this._oServiceManager,this._oDataProviderFactory,this._sAppId).then(function(y){this._setCardContent(y);}.bind(this)).catch(function(E){this._handleError(E);}.bind(this)).finally(function(){this._endBusyState("applyManifest");}.bind(this));};s.prototype.onAfterRendering=function(){var t;if(this._oCardManifest&&this._oCardManifest.get(M.TYPE)){t=this._oCardManifest.get(M.TYPE).toLowerCase();}if(t==="analytical"){this.$().addClass("sapFCardAnalytical");}};s.prototype._setCardContent=function(t){var u=t.getActions();if(u){u.setCard(this);}t.attachEvent("_error",function(E){this._handleError(E.getParameter("logMessage"),E.getParameter("displayMessage"));}.bind(this));t.setBusyIndicatorDelay(0);var P=this.getAggregation("_content");if(P&&P!==this._oTemporaryContent){P.destroy();}this.setAggregation("_content",t);if(t.isReady()){this.fireEvent("_contentReady");}else{t.attachEvent("_ready",function(){this.fireEvent("_contentReady");}.bind(this));}};s.prototype._setTemporaryContent=function(){var t=this._getTemporaryContent(),P=this.getAggregation("_content");if(P&&P!==t){P.destroy();}this.setAggregation("_content",t);};s.prototype._handleError=function(t,u){L.error(t);this._endBusyStateAll();this.fireEvent("_error",{message:t});var v="Unable to load the data.",E=u||v,w=this._getTemporaryContent(),P=this.getAggregation("_content");var x=new V({justifyContent:"Center",alignItems:"Center",items:[new g({src:"sap-icon://message-error",size:"1rem"}).addStyleClass("sapUiTinyMargin"),new T({text:E})]});if(P&&P!==w){P.destroy();this.fireEvent("_contentReady");}w.setBusy(false);w.addItem(x);this.setAggregation("_content",w);};s.prototype._getTemporaryContent=function(){if(!this._oTemporaryContent){this._oTemporaryContent=new f({justifyContent:"Center",busyIndicatorDelay:0,busy:true});this._oTemporaryContent.addStyleClass("sapFCardTemporaryContent");this._oTemporaryContent.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return;}var t=this._oCardManifest.get(M.TYPE)+"Content",u=this._oCardManifest.get(M.CONTENT),v=B.getMinHeight(t,u,this._oTemporaryContent);if(this.getHeight()==="auto"){this._oTemporaryContent.$().css({"min-height":v});}}},this);}this._oTemporaryContent.destroyItems();return this._oTemporaryContent;};s.prototype._startBusyState=function(t){this._busyStates.set(t,true);this.setBusy(true);};s.prototype._endBusyState=function(t){this._busyStates.delete(t);if(!this._busyStates.size){this.setBusy(false);}};s.prototype._endBusyStateAll=function(){this._busyStates.clear();this.setBusy(false);};s.prototype.setDataMode=function(t){if(this._oDataProviderFactory&&t===p.Inactive){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null;}this.setProperty("dataMode",t,true);if(this.getProperty("dataMode")===p.Active){this.refresh();}return this;};s.prototype.loadDesigntime=function(){if(!this._oCardManifest){return Promise.reject("Manifest not yet available");}var t=this._oCardManifest.get("/sap.app/id");if(!t){return Promise.reject("App id not maintained");}var u=t.replace(/\./g,"/");return new Promise(function(v,w){var x=u+"/"+(this._oCardManifest.get("/sap.card/designtime")||"designtime/Card.designtime");if(x){sap.ui.require([x,"sap/base/util/deepClone"],function(y,z){v({designtime:y,manifest:z(this._oCardManifest._oManifest.getRawJson(),30)});}.bind(this),function(){w({error:x+" not found"});});}else{w();}}.bind(this));};return s;});
