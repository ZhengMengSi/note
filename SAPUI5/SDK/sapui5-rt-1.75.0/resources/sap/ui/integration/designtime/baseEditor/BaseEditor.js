/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/baseEditor/util/createPromise","sap/ui/integration/designtime/baseEditor/propertyEditor/PropertyEditorFactory","sap/ui/integration/designtime/baseEditor/PropertyEditor","sap/ui/core/Control","sap/ui/model/resource/ResourceModel","sap/base/util/ObjectPath","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/util/restricted/_merge","sap/ui/model/json/JSONModel","sap/base/i18n/ResourceBundle","sap/base/Log"],function(c,P,a,C,R,O,m,i,_,J,b,L){"use strict";var B=C.extend("sap.ui.integration.designtime.baseEditor.BaseEditor",{metadata:{properties:{"json":{type:"object"},"config":{type:"object"},"_defaultConfig":{type:"object",visibility:"hidden",defaultValue:{i18n:"sap/ui/integration/designtime/baseEditor/i18n/i18n.properties"}}},defaultAggregation:"content",aggregations:{"_propertyEditors":{type:"sap.ui.core.Control",visibility:"hidden"},content:{type:"sap.ui.core.Control",multiple:true}},events:{jsonChange:{parameters:{json:{type:"object"}}},propertyEditorsReady:{parameters:{propertyEditors:{type:"array"}}}}},constructor:function(){this._mPropertyEditors={};this._mEditorClasses={};this._aCancelHandlers=[];C.prototype.constructor.apply(this,arguments);},renderer:function(r,o){var d=o.getContent();r.openStart("div",o);r.openEnd();if(d.length){d.forEach(function(e){r.renderControl(e);});}else{o.getPropertyEditorsSync().forEach(function(p){r.renderControl(p);});}r.close("div");}});B.prototype.exit=function(){this._reset();};B.prototype.setJson=function(j){var d;if(typeof j==="string"){try{d=JSON.parse(j);}catch(e){L.error("sap.ui.integration.designtime.baseEditor.BaseEditor: invalid JSON string is specified");}}else if(i(j)){d=_({},j);}else{L.error("sap.ui.integration.designtime.baseEditor.BaseEditor: unsupported data type specified in setJson()");}if(d){this.setProperty("json",d,false);this._initialize();}return this;};B.prototype.addDefaultConfig=function(o){this.setProperty("_defaultConfig",this._mergeConfig(this.getProperty("_defaultConfig"),o));this.setConfig(this._oUnmergedConfig||{});return this;};B.prototype.setConfig=function(o){this._oUnmergedConfig=o;return this._setConfig(this._mergeConfig(this.getProperty("_defaultConfig"),o));};B.prototype._mergeConfig=function(t,s){var r=m({},t,s);r.i18n=[].concat(t.i18n||[],s.i18n||[]);return r;};B.prototype._setConfig=function(o){P.registerTypes(o.propertyEditors);var r=this.setProperty("config",o,false);this._initialize();return r;};B.prototype._reset=function(){this._aCancelHandlers.forEach(function(f){f();});if(this._oI18nModel){this._oI18nModel.destroy();delete this._oI18nModel;}if(this._oContextModel){this._oContextModel.destroy();delete this._oContextModel;}this._mEditorClasses={};Object.keys(this._mPropertyEditors).forEach(function(p){this._mPropertyEditors[p].destroy();},this);this._mPropertyEditors={};this.destroyAggregation("_propertyEditors");};B.prototype._initialize=function(){this._reset();var j=this.getJson();var d=this.getConfig();if(j&&d&&d.properties){this._oContextModel=this._createContextModel();this._createI18nModel().then(function(e){if(e.length){if(!this._oI18nModel){this._oI18nModel=new R({bundle:e.shift()});this.setModel(this._oI18nModel,"i18n");this._oI18nModel.setDefaultBindingMode("OneWay");}e.forEach(function(o){this._oI18nModel.enhance(o);},this);}}.bind(this)).then(this._createEditors.bind(this));}};B.prototype._createContextModel=function(){var j=this.getJson();var d=j;var e=this.getConfig();if(e.context){d=O.get(e.context.split("/"),j);}var M=new J(d);M.setDefaultBindingMode("OneWay");return M;};B.prototype._createI18nModel=function(){return this._createPromise(function(r,f){var o=this.getConfig();Promise.all(o.i18n.map(function(I){return new Promise(function(r,d){b.create({url:sap.ui.require.toUrl(I),async:true}).then(r,d);});})).then(r,f);}.bind(this));};B.prototype._createEditors=function(){var o=this.getConfig();return Promise.all(Object.keys(o.properties).map(function(p){var d=this.getConfig().properties[p];return[p,this._createPropertyEditor(d)];}.bind(this))).then(function(p){return p.map(function(d){var s=d[0];var e=d[1];if(e){e.attachValueChange(this._onValueChange.bind(this));this._mPropertyEditors[s]=e;this.addAggregation("_propertyEditors",e);return e;}},this).filter(function(d){return!!d;});}.bind(this)).then(function(p){return Promise.all(p.map(function(d){return d.ready();}));}).then(this._checkReady.bind(this));};B.prototype._checkReady=function(){if(this.getPropertyEditorsSync().every(function(e){return e.isReady();})){this.firePropertyEditorsReady({propertyEditors:this.getPropertyEditorsSync()});}};B.prototype._createPromise=function(f){var p=c(f);this._aCancelHandlers.push(p.cancel);var r=function(d,v){this._aCancelHandlers=this._aCancelHandlers.filter(function(f){return f!==d;});return v;}.bind(this,p.cancel);return p.promise.then(r,r);};B.prototype.getPropertyConfig=function(p){return this.getConfig().properties[p];};B.prototype._createPropertyEditor=function(p){return new a({config:p,editor:this});};B.prototype.getPropertyEditor=function(p){return new Promise(function(r){if(!this._mPropertyEditors||Object.keys(this._mPropertyEditors).length===0){this.attachEventOnce("propertyEditorsReady",r);}else{r();}}.bind(this)).then(function(){return this.getPropertyEditorSync(p);}.bind(this));};B.prototype.getPropertyEditorSync=function(p){return this._mPropertyEditors[p];};B.prototype.getPropertyEditors=function(t){return new Promise(function(r){if(!this._mPropertyEditors||Object.keys(this._mPropertyEditors).length===0){this.attachEventOnce("propertyEditorsReady",r);}else{r();}}.bind(this)).then(function(){return this.getPropertyEditorsSync(t);}.bind(this));};B.prototype.getPropertyEditorsSync=function(t){var h=function(p,T){return p.getConfig().tags&&(p.getConfig().tags.indexOf(T)!==-1);};if(!t){return this.getAggregation("_propertyEditors")||[];}else if(typeof t==="string"){return this.getPropertyEditorsSync().filter(function(p){return h(p,t);});}else if(Array.isArray(t)){return this.getPropertyEditorsSync().filter(function(p){return t.every(function(T){return h(p,T);});});}else{return[];}};B.prototype._onValueChange=function(e){var p=e.getParameter("path");var d=p.split("/");this._oContext=this._oContextModel.getData();O.set(d,e.getParameter("value"),this._oContext);this._oContextModel.checkUpdate();this.fireJsonChange({json:_({},this.getJson())});};return B;});
