/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/integration/designtime/baseEditor/util/binding/ObjectBinding","./../util/isAggregationTemplate","sap/ui/model/json/JSONModel","sap/m/Label","sap/ui/core/Fragment","sap/base/util/restricted/_merge","sap/ui/base/ManagedObjectObserver","sap/ui/integration/designtime/baseEditor/util/createPromise","sap/base/util/ObjectPath"],function(C,O,i,J,L,F,_,M,c,a){"use strict";var B=C.extend("sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor",{metadata:{properties:{"renderLabel":{type:"boolean",defaultValue:true},"config":{type:"any"}},aggregations:{"_label":{type:"sap.m.Label",visibility:"hidden",multiple:false},"content":{type:"sap.ui.core.Control",multiple:false}},events:{valueChange:{parameters:{path:{type:"string"},value:{type:"any"}}},ready:{}}},xmlFragment:null,constructor:function(){C.prototype.constructor.apply(this,arguments);this._oConfigModel=new J(this.getConfig());this._oConfigModel.setDefaultBindingMode("OneWay");this.setModel(this._oConfigModel);this.setBindingContext(this._oConfigModel.getContext("/"));this._setReady(false);this._aEditorWrappers=[];this._bInitFinished=false;this._loadFragment().then(this.asyncInit.bind(this)).then(function(){this._bInitFinished=true;if(typeof this._iExpectedWrapperCount!=="undefined"){this._checkReadyState();}}.bind(this));},setValue:function(v){var o=this.getConfig();if(typeof v==="undefined"&&typeof o.defaultValue!=="undefined"){v=o.defaultValue;}this._oConfigModel.setData(Object.assign({},o,{value:v}));o.value=v;this._iExpectedWrapperCount=this.getExpectedWrapperCount(v);this._checkReadyState();},getExpectedWrapperCount:function(v){return 0;},_checkReadyState:function(){if(this._mWrapperReadyCheck){this._mWrapperReadyCheck.cancel();}if(!this._bInitFinished){this._setReady(false);return;}if(typeof this._iExpectedWrapperCount==="undefined"){this._setReady(false);throw new Error("Ready check was executed before setting the number of expected wrappers. Did you call BasePropertyEditor.prototype.setValue from your editor?");}else if(this._iExpectedWrapperCount===0){this._setReady(true);return;}if(this._iExpectedWrapperCount===this._aEditorWrappers.length){if(this._aEditorWrappers.every(function(w){return w.isReady();})){this._setReady(true);}else{this._setReady(false);this._mWrapperReadyCheck=c(function(r){Promise.all(this._aEditorWrappers.map(function(w){return w.ready();})).then(r);}.bind(this));this._mWrapperReadyCheck.promise.then(function(){this._setReady(true);delete this._mWrapperReadyCheck;}.bind(this));}}else{this._setReady(false);}},wrapperInit:function(e){var w=e.getSource();if(i(w)){return;}this._aEditorWrappers.push(w);w.attachReady(function(){this._setReady(false);this._checkReadyState();}.bind(this));if(!this._oWrapperObserver){this._oWrapperObserver=new M(function(m){this._aEditorWrappers=this._aEditorWrappers.filter(function(E){return E!==m.object;});}.bind(this));}this._oWrapperObserver.observe(w,{destroy:true});this._checkReadyState();},_setReady:function(r){var p=this._bIsReady;this._bIsReady=r;if(p!==true&&r===true){this.fireReady();}},isReady:function(){return!!this._bIsReady;},ready:function(){return new Promise(function(r){if(this.isReady()){r();}else{this.attachEventOnce("ready",r);}}.bind(this));},_loadFragment:function(){if(!this.xmlFragment){return Promise.resolve();}return F.load({name:this.xmlFragment,controller:this}).then(function(e){this.setContent(e);}.bind(this));},asyncInit:function(){return Promise.resolve();},clone:function(){this.destroyContent();return C.prototype.clone.apply(this,arguments);},exit:function(){this._oConfigModel.destroy();if(this._oConfigBinding){this._oConfigBinding.destroy();}if(this._oWrapperObserver){this._oWrapperObserver.destroy();}},setConfig:function(o){var r=this.setProperty("config",_({},o));this._initialize();return r;},setModel:function(m,n){var r=C.prototype.setModel.apply(this,arguments);this._initialize();return r;},getValue:function(){return this.getConfig().value;},_initialize:function(){var o=this.getConfig();var j=this.getModel("_context");if(j&&o){if(o.path&&!o.value){o=Object.assign({},o,{value:"{context>"+o.path+"}"});this.getConfig().value=o.value;}else{this.setValue(o.value);}if(!this._oConfigBinding){this._oConfigBinding=new O();this._oConfigBinding.setModel(this.getModel("i18n"),"i18n");this._oConfigBinding.setModel(j,"context");this._oConfigBinding.setBindingContext(j.getContext("/"),"context");this.bindProperty("visible","visible");this._oConfigBinding.attachChange(function(e){this._oConfigModel.checkUpdate();if(e.getParameter("path")==="value"){this.setValue(e.getParameter("value"));}else{a.set(e.getParameter("path").split("/"),e.getParameter("value"),this.getConfig());}}.bind(this));}this._oConfigBinding.setObject(o);}},getI18nProperty:function(n){return this.getModel("i18n").getProperty(n);},getLabel:function(){var l=this.getAggregation("_label");if(!l){l=new L({text:"{label}",design:"Bold"});this.setAggregation("_label",l);}return l;},renderer:function(r,p){r.openStart("div",p);r.openEnd();if(p.getRenderLabel()&&p.getLabel()){r.openStart("div");r.openEnd();r.renderControl(p.getLabel());r.close("div");}r.renderControl(p.getContent());r.close("div");},fireValueChange:function(v){this.fireEvent("valueChange",{path:this.getConfig().path,value:v});}});return B;});
