/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/baseEditor/propertyEditor/BasePropertyEditor","sap/base/util/deepClone","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel","sap/base/util/restricted/_merge","sap/base/util/restricted/_omit","sap/base/util/isPlainObject"],function(B,d,O,J,_,a,i){"use strict";var S={"json":"BASE_EDITOR.MAP.TYPES.OBJECT","string":"BASE_EDITOR.MAP.TYPES.STRING","boolean":"BASE_EDITOR.MAP.TYPES.BOOLEAN","number":"BASE_EDITOR.MAP.TYPES.NUMBER"};var M=B.extend("sap.ui.integration.designtime.baseEditor.propertyEditor.mapEditor.MapEditor",{xmlFragment:"sap.ui.integration.designtime.baseEditor.propertyEditor.mapEditor.MapEditor",init:function(){this._itemsModel=new J();this._itemsModel.setDefaultBindingMode("OneWay");this.setModel(this._itemsModel,"itemsModel");this._supportedTypesModel=new J();this._supportedTypesModel.setDefaultBindingMode("OneWay");this.setModel(this._supportedTypesModel,"supportedTypes");this.attachModelContextChange(function(){if(this.getModel("i18n")){var r=this.getModel("i18n").getResourceBundle();this._supportedTypesModel.setData(Object.keys(S).map(function(k){return{key:k,label:r.getText(S[k])};}));}},this);this._mTypes={};},setValue:function(v){v=i(v)?v:{};var I=Object.keys(v).map(function(k){var V=this.formatInputValue(v[k]);if(!this._mTypes[k]){this._mTypes[k]=i(V)?"json":"string";}return{key:k,value:[{type:this._mTypes[k],path:k,value:V}]};},this);this._itemsModel.setData(I);B.prototype.setValue.call(this,v);},getExpectedWrapperCount:function(v){return Object.keys(v).length;},formatInputValue:function(v){return v;},_onRemoveElement:function(e){var k=e.getSource().getBindingContext("itemsModel").getObject().key;var p=this.getConfig().value;this.fireValueChange(a(p,k));},_onAddElement:function(){var p=_({},this.getValue());var k=this._getUniqueKey(p);p[k]="";this.fireValueChange(p);},_getUniqueKey:function(p){var k="key";var I=0;while(p.hasOwnProperty(k)){k="key"+ ++I;}return k;},_onKeyChange:function(e){var I=(this._itemsModel.getData()||[]).slice();var o=e.getSource();var n=e.getParameter("value");var s=o.getBindingContext("itemsModel").getObject().key;var k=I.map(function(b){return b.key;});var E=k.indexOf(s);if(E>=0&&(k.indexOf(n)<0||n===s)){o.setValueState("None");var b=d(I[E]);b.key=n;I.splice(E,1,b);if(n!==s){var m={};I.forEach(function(b){m[b.key]=b.value[0].value;});this.fireValueChange(m);}}else{o.setValueState("Error");o.setValueStateText(this.getI18nProperty("BASE_EDITOR.MAP.DUPLICATE_KEY"));}},_onTypeChange:function(e,k){this._mTypes[k]=e.getParameter("selectedItem").getKey();this.setValue(this.getValue());},_propertyEditorsChange:function(e){var p=e.getParameter("previousPropertyEditors")[0];var P=e.getParameter("propertyEditors")[0];if(p){p.detachValueChange(this._onPropertyValueChange,this);}if(P){P.attachValueChange(this._onPropertyValueChange,this);}},_onPropertyValueChange:function(e){var E=_({},this.getValue());var p=e.getParameter("path");var P=p.split("/");var v=e.getParameter("value");O.set(P,v,E);this.fireValueChange(E);},renderer:B.getMetadata().getRenderer().render});return M;});
