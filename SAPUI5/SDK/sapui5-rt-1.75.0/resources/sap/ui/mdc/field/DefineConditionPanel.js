/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/XMLComposite','sap/ui/model/Filter','sap/ui/model/type/String','sap/ui/base/ManagedObjectObserver','sap/m/FlexItemData','sap/base/util/merge','sap/base/util/deepEqual','sap/ui/mdc/library','sap/ui/mdc/condition/Condition','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator','sap/ui/mdc/util/BaseType','sap/ui/mdc/Field'],function(X,F,S,M,a,m,d,l,C,b,O,B,c){"use strict";var E=l.EditMode;var o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");});var D=X.extend("sap.ui.mdc.field.DefineConditionPanel",{metadata:{properties:{conditions:{type:"object[]",group:"Data",defaultValue:[],byValue:true},formatOptions:{type:"object",defaultValue:{}}},events:{}},fragment:"sap.ui.mdc.field.DefineConditionPanel",init:function(){sap.ui.getCore().getMessageManager().registerObject(this,true);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["conditions","formatOptions"]});var v=this.byId("defineCondition");this._oObserver.observe(v,{aggregations:["content"]});},exit:function(){sap.ui.getCore().getMessageManager().unregisterObject(this,true);this._oObserver.disconnect();this._oObserver=undefined;if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}},onBeforeRendering:function(){if(!this.oOperatorModel){this.oOperatorModel=new sap.ui.model.json.JSONModel();this.setModel(this.oOperatorModel,"om");}k.call(this);if(this.getConditions().length===0){this.updateDefineConditions();this._updateButtonVisibility();}},_updateButtonVisibility:function(t){var v=this.byId("defineCondition");if(!v){return;}var R=v.getContent();var u=this.getFormatOptions();var w=u.maxConditions;for(var i=0;i<R.length;i++){var x=R[i];var H=x.getContent()[2];var y=H.getItems()[1];y.setVisible((i===R.length-1)&&(w==-1||i<w-1));}},removeCondition:function(i){var t=i.oSource;var u=t.getBindingContext("$this").getObject();var v=this.getConditions();var I=C.indexOfCondition(u,v);this._bUpdateConditionsInternal=true;v.splice(I,1);this.setProperty("conditions",v,true);this.updateDefineConditions();this._updateButtonVisibility();this.invalidate();},addCondition:function(i){var t=i.oSource;var u=t.getBindingContext("$this").getObject();var v=this.getConditions();var I=C.indexOfCondition(u,v);var w=this.getFormatOptions();var x=w.maxConditions;if(x==-1||v.length<x){this._bUpdateConditionsInternal=true;this.addDummyCondition(I+1);}},addDummyCondition:function(i){var t=j.call(this);var u=t.indexOf("EQ")>=0?"EQ":t[0];var v=C.createCondition(u,[null]);b.updateConditionValues(v);b.checkConditionsEmpty(v,t);var w=this.getConditions();if(i!==undefined){w.splice(i,0,v);}else{w.push(v);}this.setProperty("conditions",w,true);this._updateButtonVisibility();},updateDefineConditions:function(){var i=this.getConditions().filter(function(t){return t.operator!=="EEQ";});s.call(this,i,true,false);if(i.length===0){this._bUpdateConditionsInternal=true;this.addDummyCondition();}},valueCtrlFactory:function(i,t){var u=t.oModel;var P=t.sPath;var v=parseInt(P.split("/")[P.split("/").length-1]);P=P.slice(0,P.lastIndexOf("/"));P=P.slice(0,P.lastIndexOf("/"));var w=u.getProperty(P);var x=b.getOperator(w.operator);var y=n.call(this);var V=h.call(this,y,x,"$this>",v);V.addStyleClass("sapUiSmallPaddingBegin");V.setLayoutData(new a({shrinkFactor:0,growFactor:1}));if(V.attachChange){V.attachChange(this.onChange.bind(this));V.onpaste=this.onPaste.bind(this);}var z=this.getConditions();s.call(this,z,true,false);return V;},onChange:function(i){var t=j.call(this);var u=this.getConditions();b.checkConditionsEmpty(u,t);b.updateConditionsValues(u,t);this.setProperty("conditions",u,true);},onSelectChange:function(i){var t=i.getSource();var K=t.getValue();var u=t._sOldKey;var v=b.getOperator(K);var w=u&&b.getOperator(u);if(w&&!d(v.valueTypes[0],w.valueTypes[0])&&v.valueTypes[0]!==O.ValueType.Static){var x=t.getBindingContext("$this").getObject();var y=this.getConditions();var I=C.indexOfCondition(x,y);if(I>=0){x=y[I];if(x.values.length>0&&x.values[0]!==null){x.values[0]=null;}if(x.values.length>1&&x.values[1]!==null){x.values[1]=null;}this._bUpdateConditionsInternal=true;this.setProperty("conditions",y,true);}}delete t._sOldKey;},onPaste:function(t){var u,v=t.srcControl;if(window.clipboardData){u=window.clipboardData.getData("Text");}else{u=t.originalEvent.clipboardData.getData('text/plain');}var w=u.split(/\r\n|\r|\n/g);if(w&&w.length>1){setTimeout(function(){var x=j.call(this);var T=n.call(this);var y=q.call(this,T);var L=w.length;var z=this.getConditions();for(var i=0;i<L;i++){if(w[i]){var V=w[i];var A=V.split(/\t/g);var G;if(A.length==2&&A[0]&&A[1]){G=b.getOperator("BT");}else{A=[V.trim()];G=b.getDefaultOperator(y);}V=G?G.format(A):A[0];if(G){var H=G.getCondition(V,T);if(H){b.checkConditionsEmpty(H,x);z.push(H);}}}}this.setProperty("conditions",z,true);if(v.setDOMValue){v.setDOMValue("");}}.bind(this),0);}}});function _(i){if(i.name==="content"&&i.mutation==="insert"){e.call(this,i.child);}if(i.name==="value"){g.call(this,i.object,i.current,i.old);}if(i.name==="formatOptions"){var t=this.getConditions();if(t.length>0){f.call(this);this.setConditions([]);this.setConditions(t);}var u=i.current&&i.current.operators;var v=i.old&&i.old.operators;if(!d(u,v)){k.call(this);}var T=i.current&&i.current.valueType&&i.current.valueType.getMetadata().getName();var w=i.old&&i.old.valueType&&i.old.valueType.getMetadata().getName();if(T!==w&&t.length>0){s.call(this,t,true,true);}}if(i.name==="conditions"){if(this._bUpdateConditionsInternal){this._bUpdateConditionsInternal=false;return;}if(this._sConditionsTimer){clearTimeout(this._sConditionsTimer);this._sConditionsTimer=null;}this._sConditionsTimer=setTimeout(function(){this._sConditionsTimer=null;this.updateDefineConditions();this._updateButtonVisibility();}.bind(this),0);}}function e(G){var i=G.getContent();var t=i[0];var H=i[1];var L=H.getBinding("items");L.suspend();this._oObserver.observe(t,{properties:["value"]});}function f(){var v=this.byId("defineCondition");var G=v.getContent();for(var i=0;i<G.length;i++){var t=G[i];var u=t.getContent();var H=u[1];var L=H.getBinding("items");L.resume();}}function g(i,K,t){var G=i.getParent();var u=G.getContent();var H=u[1];var L=H.getBinding("items");i._sOldKey=t;if(!K){var v=i.getBindingContext("$this").getObject();var w=this.getConditions();var I=C.indexOfCondition(v,w);if(I>=0){v=w[I];v.operator=t;this._bUpdateConditionsInternal=true;this.setProperty("conditions",w,true);}}this.onChange();L.checkUpdate(true);}function h(i,t,P,u){if(t.valueTypes[u]&&[O.ValueType.Self,O.ValueType.Static].indexOf(t.valueTypes[u])===-1){i=t._createLocalType(t.valueTypes[u]);}if(t.createControl){return t.createControl(i,t,P,u);}var v=false;if(t.valueTypes[u]===O.ValueType.Static){v=true;i=p.call(this);}var T=v?B.String:q.call(this,i);var N;var w;var x;var y;switch(T){case B.Boolean:if(i.oConstraints&&i.oConstraints.hasOwnProperty("nullable")&&i.oConstraints.nullable===false){w=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));x=m({},i.oFormatOptions);y=m(i.oConstraints,{nullable:true});N=new w(x,y);}else{N=i;}break;case B.Numeric:if(i.oFormatOptions&&i.oFormatOptions.hasOwnProperty("emptyString")&&i.oFormatOptions.emptyString===null){N=i;}else{w=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));x=m(i.oFormatOptions,{emptyString:null});N=new w(x,i.oConstraints);}break;case B.Date:case B.Time:case B.DateTime:N=i;break;default:N=i;break;}var z=new c({delegate:r.call(this),value:{path:P,type:N,mode:'TwoWay',targetType:'raw'},editMode:v?E.Display:E.Editable,width:"100%"});return z;}function j(){var i=this.getFormatOptions();var t=i&&i.operators;if(!t||t.length===0){t=b.getOperatorsForType(B.String);}return t;}function k(){if(!this.oOperatorModel){return;}var t=n.call(this);var u=j.call(this);var I=o.getText("valuehelp.INCLUDE");var v=o.getText("valuehelp.EXCLUDE");var w=[];for(var i=0;i<u.length;i++){var x=u[i];var y=b.getOperator(x);if(y.showInSuggest!==undefined&&y.showInSuggest==false){continue;}var T=y.textKey||"operators."+y.name+".longText";var z=y.getTypeText(T,t.getName().toLowerCase());if(z===T){z=y.longText;}var A=y.additionalInfo;if(A===undefined){if(A!==""&&y.formatRange){A=y.formatRange(y._getRange(undefined,t),t);}else{A=y.exclude?v:I;}}w.push({key:y.name,additionalText:z,info:A});}this.oOperatorModel.setData(w);}function n(){var i=this.getFormatOptions();var t=i&&i.valueType;if(!t){t=p.call(this);}return t;}function p(){if(!this._oDefaultType){this._oDefaultType=new S();}return this._oDefaultType;}function q(t){var T=t.getMetadata().getName();var i=t.oFormatOptions;var u=t.oConstraints;var v=this.getFormatOptions().delegate;var P=this.getFormatOptions().payload;var w=v?v.getBaseType(P,T,i,u):B.String;if(w===B.Unit){w=B.Numeric;}return w;}function r(){var i=this.getFormatOptions();var N=i.delegateName||"sap/ui/mdc/field/FieldBaseDelegate";var P=i.payload;return{name:N,payload:P};}function s(t,u,T){var v=n.call(this);var U=[];var i=0;for(i=0;i<t.length;i++){var w=t[i];var x=b.getOperator(w.operator);if(x.valueTypes[0]===O.ValueType.Static&&(w.values.length===0||T)){if(x.getStaticText){var y=x.getStaticText(v);if(w.values.length>0){w.values[0]=y;}else{w.values.push(y);}U.push(i);}}}if(U.length>0){this._bUpdateConditionsInternal=true;this.setProperty("conditions",t,true);if(u){var V=this.byId("defineCondition");var G=V.getContent();for(i=0;i<U.length;i++){var z=G[U[i]];var A=z.getContent();var H=A[1];var L=H.getBinding("items");L.checkUpdate(true);}}}}return D;});
