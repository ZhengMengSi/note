/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/mdc/FilterBarDelegate",'sap/base/util/ObjectPath','sap/base/util/merge','sap/ui/mdc/odata/v4/FieldBaseDelegate','sap/ui/mdc/condition/FilterOperatorUtil',"sap/ui/model/FilterOperator","sap/ui/model/Filter",'sap/ui/mdc/util/IdentifierUtil'],function(F,O,m,a,b,M,c,I){"use strict";var d=Object.assign({},F);var D={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"};var e={};d._fetchPropertiesByMetadata=function(f,p){var o,g,C,h,i;if(p){var j=p.modifier;o=j.getProperty(f,"delegate");g=o.payload.modelName===null?undefined:o.payload.modelName;C=o.payload.collectionName;h=p.appComponent.getModel(g);}else{o=f.getProperty("delegate");g=o.payload.modelName===null?undefined:o.payload.modelName;C=o.payload.collectionName;h=f.getModel(g);}i=f.getId?f.getId():f.id;var k={getDelegate:function(){return{payload:{modelName:g,collectionName:C}};},getModel:function(s){return h;},getId:function(){return i;}};return this.fetchProperties(k);};d._isMultiValue=function(f){var i=true;switch(f){case"SearchExpression":case"SingleRange":case"SingleValue":i=false;break;default:break;}return i;};d._ensureSingleRangeEQOperators=function(){var o;if(!b.getOperator("SINGLE_RANGE_EQ")){o=m({},b.getOperator("EQ"));o.name="SINGLE_RANGE_EQ";o.getModelFilter=function(C,f){return new c({filters:[new c(f,M.GE,C.values[0]),new c(f,M.LE,C.values[0])],and:true});};b.addOperator(o);}if(!b.getOperator("SINGLE_RANGE_EEQ")){o=m({},b.getOperator("EEQ"));o.name="SINGLE_RANGE_EEQ";o.getModelFilter=function(C,f){return new c({filters:[new c(f,M.GE,C.values[0]),new c(f,M.LE,C.values[0])],and:true});};b.addOperator(o);}};d._ensureMultiRangeBTEXOperator=function(){if(!b.getOperator("MULTI_RANGE_BTEX")){var o=m({},b.getOperator("BT"));o.name="MULTI_RANGE_BTEX";o.getModelFilter=function(C,f){return new c({filters:[new c(f,M.GT,C.values[0]),new c(f,M.LT,C.values[1])],and:true});};b.addOperator(o);}};d._getFilterOperators=function(f){var o=null,g=null;switch(f){case"SingleValue":case"MultiValue":o="EQ,EEQ";break;case"SingleRange":o="SINGLE_RANGE_EQ,SINGLE_RANGE_EEQ,LE,GE";this._ensureSingleRangeEQOperators();break;case"MultiRange":o="EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;case"SearchExpression":o="StartsWith,EndsWith,Contains";break;case"MultiRangeOrSearchExpression":o="StartsWith,EndsWith,Contains,EQ,EEQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;default:break;}if(o){g=o.split(',');}return g;};d._createFilterField=function(p,f,P){var o=P.modifier;var n=p.path||p.name;var s={};if(f.getId){s.id=f.getId();}else{s.id=f.id;}var S=o.getControlIdBySelector(s,P.appComponent);var i=S+"--filter--"+I.replace(n);return o.createControl("sap.ui.mdc.FilterField",P.appComponent,P.view,i,{dataType:p.type,conditions:"{$filters>/conditions/"+n+'}',required:p.required,label:p.label,maxConditions:p.maxConditions,delegate:{name:"sap/ui/mdc/odata/v4/FieldBaseDelegate",payload:{}}},true).then(function(g){if(p.fieldHelp){var h=p.fieldHelp;if(P.view.getId){h=P.view.getId()+"--"+p.fieldHelp;}else{h=P.viewId+"--"+p.fieldHelp;}o.setAssociation(g,"fieldHelp",h);}if(p.filterOperators){if(f.getId){o.setProperty(g,"operators",p.filterOperators);}else{o.setProperty(g,"operators",p.filterOperators.join(','));}}if(p.tooltip){o.setProperty(g,"tooltip",p.tooltip);}if(p.constraints){o.setProperty(g,"dataTypeConstraints",p.constraints);}if(p.formatOptions){o.setProperty(g,"dataTypeFormatOptions",p.formatOptions);}return g;});};d._createFilter=function(p,f,P){return this._fetchPropertiesByMetadata(f,P).then(function(g){var o=g.find(function(h){return(I.getPropertyKey(h)===p);});if(!o){return null;}return Promise.resolve(this._createFilterField(o,f,P));}.bind(this));};d.beforeAddFilterFlex=function(p,f,P){return Promise.resolve(this._createFilter(p,f,P));};d.afterRemoveFilterFlex=function(f,o,p){return Promise.resolve(true);};d._getFieldGroupsByFilterFacetsAnnotation=function(o,E){};d._getDataType=function(p){var t=O.get(p.type||"");if(!t){throw new Error("DataType '"+p.type+"' cannot be determined");}return new t(p.formatOptions,p.constraints);};d._fetchPropertyInfo=function(o,E,n,f,k){var p={};var h=false;if(o.getObject(E+"/"+k+"@com.sap.vocabularies.UI.v1.HiddenFilter")){h=true;}var i=false;if(o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.IsDigitSequence")){i=true;}var g=null;var j=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.FilterDefaultValue");if(j){var v=j["$"+D[f.$Type]];switch(f.$Type){case"Edm.DateTimeOffset":g=v;break;default:g=v;}}var l=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.Label")||k;var t=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.QuickInfo")||null;var C={};if(f.$MaxLength||f.$Precision||f.$Scale||i){if(f.$MaxLength){C.maxLength=f.$MaxLength;}if(f.$Precision){C.precision=f.$Precision;}if(f.$Scale){C.scale=f.$Scale;}if(i){C.isDigitSequence=i;}}else{C=null;}var P={name:k,label:l,tooltip:t,type:a.getDataTypeClass(p,f.$Type),hiddenFilter:h};if(f.$Type==="Edm.DateTimeOffset"){if(!C){C={};}C.V4=true;}if(C){P.constraints=C;}P.baseType=d._getDataType(P);if(g){P.defaultFilterConditions=[{fieldPath:k,operator:"EQ",values:[g]}];}if(n){P.path=n+"/"+k;}return P;};d._fetchEntitySet=function(o,E,v,n){return Promise.all([o.requestObject(E+"/"),o.requestObject(E+"@")]).then(function(r){var f=r[0];var g=r[1]||{};if(!f){return Promise.resolve([]);}var h,p,i=[],P=[],N=[],R=[],s=[],A={},j={};var k=o.getObject(E);if(k&&k.$NavigationPropertyBinding){j=k.$NavigationPropertyBinding;}var l=g["@Org.OData.Capabilities.V1.FilterRestrictions"];if(l){if(l.NonFilterableProperties){N=l.NonFilterableProperties.map(function(x){return x.$PropertyPath;});}if(l.RequiredProperties){R=l.RequiredProperties.map(function(x){return x.$PropertyPath;});}if(l.FilterExpressionRestrictions){l.FilterExpressionRestrictions.forEach(function(x){A[x.Property.$PropertyPath]=x.AllowedExpressions;});}}l=o.getObject(E+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(l){s=l.map(function(x){return x.$PropertyPath;});}var q=o.getObject(E+"/@sapui.name");var G=q;var t=o.getObject(E+"@com.sap.vocabularies.Common.v1.Label");if(!t){t=G;}for(var K in f){h=f[K];if(h){if(h.$kind==="Property"){if(N.indexOf(K)>=0){continue;}if(o.getObject(E+"/"+K+"@com.sap.vocabularies.UI.v1.Hidden")){continue;}p=d._fetchPropertyInfo(o,E,n,h,K);if(p){p.group=G;p.groupLabel=t;p.required=R.indexOf(K)>=0;p.visible=s.indexOf(K)>=0;if(A[K]){var u=d._getFilterOperators(A[K]);if(u){p.filterOperators=u;}}p.maxConditions=d._isMultiValue(A[K])?-1:1;i.push(p);}}else if((h.$kind==="NavigationProperty")&&(!h.$isCollection)&&(v.indexOf(q)===-1)){v.push(q);var w=j[K];if(w){P.push(d._fetchEntitySet(o,'/'+w,v,K));}}}}return Promise.all(P).then(function(x){x.forEach(function(y){i=i.concat(y);});return i;});});};d._setModel=function(){var s=this.getDelegate().payload.modelName;s=s===null?undefined:s;var o=this.getModel(s);if(o){this.detachModelContextChange(this._oDelegate._setModel,this);this._oDelegate._fModelProvided(o);}};d._waitForMetaModel=function(f,s){return new Promise(function(r,g){var s=s===null?undefined:s;var o=f.getModel(s);if(o){r(o);}if(!f.attachModelContextChange){g();}this._fModelProvided=r;f.attachModelContextChange(this._setModel,f);}.bind(this));};d.fetchProperties=function(f){var s=f.getDelegate().payload.modelName;var E=f.getDelegate().payload.collectionName;return new Promise(function(r,g){var o;var C=f.getId()+'->'+E;if(e[C]){r(e[C]);return;}this._waitForMetaModel(f,s).then(function(h){if(!h||!E){g("model or entity set name not available");return;}o=h.getMetaModel();if(!o){g("metadata model not available");}else{var v=[];d._fetchEntitySet(o,'/'+E,v).then(function(p){e[C]=p;r(p);});}},function(){g("model not obtained");});}.bind(this));};d.cleanup=function(f){var s=f.getId()+"->";Object.keys(e).forEach(function(k){if(k.indexOf(s)===0){delete e[k];}});};return d;});
