/*
* ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
*/
sap.ui.define(['sap/ui/model/json/JSONModel','sap/base/util/array/diff','sap/m/Button','sap/base/util/merge','sap/base/util/deepEqual'],function(J,d,B,m,a){"use strict";var I=false;var F={showP13nPanel:function(s){return new Promise(function(r,b){this.mSettings=s;if(s.p13nType){s=m(s,this._getAdditionalControlInfo(s.p13nType));}sap.ui.require(I?['sap/m/Dialog',s.panelPath]:['sap/m/ResponsivePopover',s.panelPath],function(C,P){this.sortP13nData(s.p13nData);this.oJSONModel=new J(s.p13nData);this.oJSONModel.setSizeLimit(10000);this.oState=m({},s.p13nData);this.fnHandleChange=function(c){F.handleChanges(c).then(function(){if(s.fnAfterCreateChanges){s.fnAfterCreateChanges();}if(this.oJSONModel){this.oState=m({},this.oJSONModel.getData());}}.bind(this));}.bind(this);var p=new P({change:I?function(){}:[this._registerChangeEvent,this]});p.setP13nModel(this.oJSONModel);var D=this._createP13nContainer(C,p,I,this.oJSONModel,s.control,s.title,this.fnHandleChange);s.control.addDependent(D);if(I){D.open();}else{D.openBy(s.source);}r(p);}.bind(this));}.bind(this));},_registerChangeEvent:function(){var c=[],i=[],C=[];var f=function(o){return o.selected;};i=this.oState.items.filter(f);C=this.oJSONModel.getData().items.filter(f);c=this.getArrayDeltaChanges(i,C,this.mSettings.fnSymbol,this.mSettings.control,this.mSettings.changeOperations[0],this.mSettings.changeOperations[1],this.mSettings.changeOperations[2]);this.oState=m({},this.oJSONModel.getData());this.fnHandleChange(c);},_getAdditionalControlInfo:function(p){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var c=[],s,t,P;switch(p){case"Sort":s=function(o){return o.name+o.descending;};c=["removeSort","addSort","moveSort"];t=r.getText("sort.PERSONALIZATION_DIALOG_TITLE");P="sap/ui/mdc/p13n/SortPanel";break;case"Columns":s=function(o){return o.name;};c=["removeColumn","addColumn","moveColumn"];t=r.getText("table.SETTINGS_COLUMN");P="sap/ui/mdc/p13n/SelectionPanel";break;case"Chart":s=function(o){return o.name+o.role;};c=["removeItem","addItem","moveItem"];t=r.getText("chart.PERSONALIZATION_DIALOG_TITLE");P="sap/ui/mdc/p13n/ChartItemPanel";break;case"AdaptFilters":s=function(o){return o.name;};c=["removeFilter","addFilter","moveFilter"];t=r.getText("filterbar.ADAPT_TITLE");P="sap/ui/mdc/p13n/AdaptFiltersPanel";break;}var A={changeOperations:c,symbol:s,title:t,panelPath:P};return A;},_createPopover:function(C,p,t,c){var o=new C({title:t,horizontalScrolling:false,verticalScrolling:true,contentWidth:"26rem",resizable:true,contentHeight:"40rem",placement:"HorizontalPreferredRight",content:p,afterClose:function(){o.destroy();c([]);}});return o;},_createModalDialog:function(C,p,t,c,j){var D=m({},j.getProperty("/"));var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var o=new C({title:t,horizontalScrolling:false,verticalScrolling:true,contentWidth:"40rem",contentHeight:"55rem",draggable:true,resizable:true,stretch:"{device>/system/phone}",content:p,buttons:[new B({text:r.getText("p13nDialog.OK"),type:"Emphasized",press:function(){this._registerChangeEvent();o.close();o.destroy();}.bind(this)}),new B({text:r.getText("p13nDialog.CANCEL"),press:function(){o.close();o.destroy();j.setProperty("/",m({},D));c([]);}})]});return o;},_createP13nContainer:function(C,p,I,j,c,t,f){var o;if(I){o=this._createModalDialog(C,p,t,f,j);}else{o=this._createPopover(C,p,t,f);}o.addStyleClass("sapUiMdcPersonalizationDialog");o.toggleStyleClass("sapUiSizeCompact",!!jQuery(c.getDomRef()).closest(".sapUiSizeCompact").length);return o;},getArrayDeltaChanges:function(e,c,s,C,r,i,M){var R=d(e,c,s);var f=function(o,A){return A.filter(function(E){return E&&(E.name===o.name);})[0];};var g=function(P){var o={name:P.name};if(P.id){o.id=P.id;}if(P.index>=0){o.index=P.index;}if(P.role){o.role=P.role;}if(P.hasOwnProperty("descending")){o.descending=P.descending==="true"||P.descending===true;}return o;};var b=[];var p=e.slice(0);R.forEach(function(o){if(o.type==="delete"&&p[o.index]===undefined){p.splice(o.index,1);return;}var P,E,l;if(o.type==="insert"){E=f(c[o.index],p);if(E){E.index=p.indexOf(E);p.splice(E.index,1,undefined);b.push(this.createAddRemoveChange(C,r,g(E)));}}P=o.type==="delete"?p[o.index]:c[o.index];P.index=o.index;if(o.type==="delete"){p.splice(P.index,1);}else{p.splice(P.index,0,P);}if(M){l=b.length;if(l){E=b[l-1];E=E?E.changeSpecificData.content:undefined;}if(E&&E.name===P.name&&o.index!=E.index){b.pop();b.push(this.createMoveChange(E.id,E.name,o.index,M,C,M!=="moveSort"));return;}}b.push(this.createAddRemoveChange(C,o.type==="delete"?r:i,g(P)));}.bind(this));return b;},getConditionDeltaChanges:function(f,o,O,c){var C,b=[];var e=o;var s=O?O:[];if(a(e,s)){return b;}var r=function(e,s){var R;do{R=false;for(var i=0;i<e.length;i++){for(var j=0;j<s.length;j++){if(a(e[i],s[j])){e.splice(i,1);s.splice(j,1);R=true;break;}}if(R){break;}}}while(R);};r(e,s);if((e.length>0)||(s.length>0)){s.forEach(function(g){C=F.createConditionChange("removeCondition",c,f,g);if(C){b.push(C);}});e.forEach(function(g){C=F.createConditionChange("addCondition",c,f,g);if(C){b.push(C);}});}return b;},createAddRemoveChange:function(c,o,C){var A={selectorElement:c,changeSpecificData:{changeType:o,content:C}};return A;},createMoveChange:function(i,p,n,M,c,P){var o={selectorElement:c,changeSpecificData:{changeType:M,content:{id:i,name:p,index:n}}};if(!P){delete o.changeSpecificData.content.id;}return o;},createConditionChange:function(c,C,f,o){var b={selectorElement:C,changeSpecificData:{changeType:c,content:{name:f,condition:o}}};return b;},sortP13nData:function(D){var l=sap.ui.getCore().getConfiguration().getLocale().toString();var c=window.Intl.Collator(l,{});D.items.sort(function(f,b){if(f.selected&&b.selected){return(f.position||0)-(b.position||0);}else if(f.selected){return-1;}else if(b.selected){return 1;}else if(!f.selected&&!b.selected){return c.compare(f.label,b.label);}});},handleChanges:function(c){return new Promise(function(r,b){sap.ui.require(["sap/ui/fl/write/api/ControlPersonalizationWriteAPI"],function(C){C.add({changes:c}).then(function(D){r(D);},b);});});}};return F;});
