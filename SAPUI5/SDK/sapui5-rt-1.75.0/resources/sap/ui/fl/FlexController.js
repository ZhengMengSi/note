/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Change","sap/ui/fl/Variant","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/context/ContextManager","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log","sap/base/util/restricted/_uniqWith"],function(C,U,L,a,V,b,c,d,A,R,e,J,X,f,g,_){"use strict";var F=function(s,h){this._oChangePersistence=undefined;this._sComponentName=s||"";this._sAppVersion=h||U.DEFAULT_APP_VERSION;if(this._sComponentName&&this._sAppVersion){this._createChangePersistence();}};F.prototype.setComponentName=function(s){this._sComponentName=s;this._createChangePersistence();};F.prototype.getComponentName=function(){return this._sComponentName;};F.prototype.getAppVersion=function(){return this._sAppVersion;};F.prototype.getVariantModelData=function(){var D;if(this._oChangePersistence&&this._oChangePersistence._oVariantController._mVariantManagement&&Object.keys(this._oChangePersistence._oVariantController._mVariantManagement).length>0){D=this._oChangePersistence._oVariantController.fillVariantModel();}return D;};F.prototype.setVariantSwitchPromise=function(p){this._oVariantSwitchPromise=p;};F.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve();}return this._oVariantSwitchPromise;};F.prototype.createBaseChange=function(o,h){var i;var j;var k=c._getContextIdsFromUrl();if(k.length>1){throw new Error("More than one DesignTime Context is currently active.");}if(!h){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.");}o.reference=this.getComponentName();o.packageName="$TMP";o.context=k.length===1?k[0]:"";o.validAppVersions=U.getValidAppVersions({appVersion:this.getAppVersion(),developerMode:o.developerMode,scenario:o.scenario});i=a.createInitialFileContent(o);j=new a(i);if(o.variantReference){j.setVariantReference(o.variantReference);}return j;};F.prototype.createChange=function(o,h){var i;var j;return Promise.resolve().then(function(){if(!h){throw new Error("A flexibility change cannot be created without a targeted control.");}var s=h.id||h.getId();if(!o.selector){o.selector={};}i=h.appComponent||U.getAppComponentForControl(h);if(!i){throw new Error("No application component found. To offer flexibility, the control with the ID '"+s+"' has to have a valid relation to its owning application component.");}Object.assign(o.selector,J.getSelector(s,i));j=this.createBaseChange(o,i);var k=h.controlType||U.getControlType(h);if(!k){throw new Error("No control type found - the change handler can not be retrieved.");}return this._getChangeHandler(j,k,h,J);}.bind(this)).then(function(k){if(k){k.completeChangeContent(j,o,{modifier:J,appComponent:i});}else{throw new Error("Change handler could not be retrieved for change "+JSON.stringify(o)+".");}return j;});};F.prototype.createVariant=function(v,o){var h;var i;if(!o){throw new Error("No Application Component found - to offer flexibility the variant has to have a valid relation to its owning application component.");}if(v.content.variantManagementReference){var j=J.checkControlId(v.content.variantManagementReference,o);if(!j){throw new Error("Generated ID attribute found - to offer flexibility a stable VariantManagement ID is needed to assign the changes to, but for this VariantManagement control the ID was generated by SAPUI5 "+v.content.variantManagementReference);}}v.content.reference=this.getComponentName();v.content.packageName="$TMP";v.content.validAppVersions=U.getValidAppVersions(this.getAppVersion(),v.developerMode,v.scenario);i=V.createInitialFileContent(v);h=new V(i);return h;};F.prototype.addChange=function(o,h){return this.createChange(o,h).then(function(i){var j=U.getAppComponentForControl(h);this.addPreparedChange(i,j);return i;}.bind(this));};F.prototype.addPreparedChange=function(o,h){if(o.getVariantReference()){var m=h.getModel(U.VARIANT_MODEL_NAME);m.addChange(o);}this._oChangePersistence.addChange(o,h);return o;};F.prototype.deleteChange=function(o,h){this._oChangePersistence.deleteChange(o);if(o.getVariantReference()){h.getModel(U.VARIANT_MODEL_NAME).removeChange(o);}};F.prototype.createAndApplyChange=function(o,h){var i;return Promise.resolve().then(function(){return this.addChange(o,h);}.bind(this)).then(function(j){i=j;var p={modifier:J,appComponent:U.getAppComponentForControl(h),view:U.getViewForControl(h)};i.setQueuedForApply();return A.applyChangeOnControl(i,h,p);}).then(function(r){if(!r.success){var E=r.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(i,true);throw E;}return i;}.bind(this));};F.prototype._checkDependencies=function(o,D,m,h,r){var j=this._canChangePotentiallyBeApplied(o,h);if(!j){return[];}r.push(o);var s=o.getId();var k=D[s]&&D[s].dependencies||[];for(var i=0,n=k.length;i<n;i++){var l=U.getChangeFromChangesMap(m,k[i]);j=this._checkDependencies(l,D,m,h,r);if(j.length===0){r=[];break;}delete D[s];}return r;};F.prototype._canChangePotentiallyBeApplied=function(o,h){var s=o.getDependentControlSelectorList();s.push(o.getSelector());return!s.some(function(S){return!J.bySelector(S,h);});};F.prototype.waitForChangesToBeApplied=function(s){var S;if(Array.isArray(s)){S=s;}else{S=[s];}var p=S.map(function(v){return this._waitForChangesToBeApplied(v);}.bind(this));return Promise.all(p).then(function(){return undefined;});};F.prototype._waitForChangesToBeApplied=function(s){var o=s.id&&sap.ui.getCore().byId(s.id)||s;var m=this._oChangePersistence.getChangesMapForComponent();var p=[];var D=Object.assign({},m.mDependencies);var h=m.mChanges;var i=h[o.getId()]||[];var n=i.filter(function(k){return!k.isCurrentProcessFinished();},this);var j=s.appComponent||U.getAppComponentForControl(o);var r=[];n.forEach(function(k){var l=this._checkDependencies(k,D,m.mChanges,j,[]);l.forEach(function(q){if(r.indexOf(q)===-1){r.push(q);}});}.bind(this));r.forEach(function(k){p=p.concat(k.addChangeProcessingPromises());},this);p.push(this.waitForVariantSwitch());return Promise.all(p);};F.prototype.saveAll=function(s,D){return this._oChangePersistence.saveDirtyChanges(s,undefined,D).then(function(r){if(D&&r&&r.response){var v=r.response;if(Array.isArray(v)){v=v[0];}d.ensureDraftVersionExists({reference:v.reference,layer:v.layer});}return r;});};F.prototype.processXmlView=function(v,p){var o=f.get(p.componentId);var h=U.getAppComponentForControl(o);p.appComponent=h;p.modifier=X;p.view=v;return this._oChangePersistence.getChangesForView(p).then(A.applyAllChangesForXMLView.bind(A,p)).catch(this._handlePromiseChainError.bind(this,p.view));};F.prototype._handlePromiseChainError=function(v,E){g.error("Error processing view "+E+".");return v;};F.prototype._getSelectorOfChange=function(o){if(!o||!o.getSelector){return undefined;}return o.getSelector();};F.prototype._getChangeHandler=function(o,s,h,m){var i=o.getChangeType();var l=o.getLayer();return this._getChangeRegistry().getChangeHandler(i,s,h,m,l);};F.prototype._getChangeRegistry=function(){var i=C.getInstance();i.initSettings();return i;};F.prototype.getComponentChanges=function(p,i){return this._oChangePersistence.getChangesForComponent(p,i);};F.prototype.checkForOpenDependenciesForControl=function(s,m,o){return this._oChangePersistence.checkForOpenDependenciesForControl(s,m,o);};F.prototype.hasHigherLayerChanges=function(p){p=p||{};var s=p.upToLayer||L.getCurrentLayer(false);p.includeVariants=true;p.includeCtrlVariants=true;return this.getComponentChanges(p).then(function(v){var h=v===this._oChangePersistence.HIGHER_LAYER_CHANGES_EXIST||v.some(function(o){return L.compareAgainstCurrentLayer(o.getLayer(),s)>0;});return!!h;}.bind(this));};F.prototype._createChangePersistence=function(){this._oChangePersistence=b.getChangePersistenceForComponent(this.getComponentName(),this.getAppVersion());return this._oChangePersistence;};F.prototype.resetChanges=function(l,G,o,s,h){return this._oChangePersistence.resetChanges(l,G,s,h).then(function(i){if(i.length!==0){return R.revertMultipleChanges(i,{appComponent:o,modifier:J,flexController:this});}}.bind(this)).then(function(){if(o){var m=o.getModel(U.VARIANT_MODEL_NAME);if(m){e.update({parameters:[],updateURL:true,updateHashEntry:true,model:m});}}});};F.prototype.discardChanges=function(h,D){var s=L.getCurrentLayer(!!D);var i=0;var l;var o;l=h.length;while(i<h.length){o=h[i];if(o&&o.getLayer&&o.getLayer()===s){this._oChangePersistence.deleteChange(o);}if(l===h.length){i++;}else{l=h.length;}}return this._oChangePersistence.saveDirtyChanges();};F.prototype.discardChangesForId=function(i,D){if(!i){return Promise.resolve();}var o=this._oChangePersistence.getChangesMapForComponent();var h=o.mChanges[i]||[];return this.discardChanges(h,D);};F.prototype.applyVariantChanges=function(h,o){var p=[];var m=J;var i=h.map(function(j){this._oChangePersistence._addChangeAndUpdateDependencies(o,j);return this._getSelectorOfChange(j);}.bind(this));var s=function(S,t){return S.id===t.id;};i=_(i,s);i.forEach(function(S){p.push(function(){var j=m.bySelector(S,o);if(!j){g.error("A flexibility change tries to change a nonexistent control.");return new U.FakePromise();}return A.applyAllChangesForControl(this._oChangePersistence.getChangesMapForComponent.bind(this._oChangePersistence),o,this,j);}.bind(this));}.bind(this));return U.execPromiseQueueSequentially(p);};F.prototype.saveSequenceOfDirtyChanges=function(D){return this._oChangePersistence.saveDirtyChanges(false,D);};F.prototype.getResetAndPublishInfo=function(p){p.reference=this._sComponentName;p.appVersion=this._sAppVersion;return this._oChangePersistence.getResetAndPublishInfo(p);};return F;},true);
