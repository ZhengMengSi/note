/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/Change","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/write/_internal/CompatibilityConnector","sap/ui/fl/Cache","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/context/ContextManager","sap/ui/fl/write/_internal/Storage","sap/ui/fl/variants/VariantController","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/util/merge","sap/base/util/isEmptyObject","sap/base/Log","sap/ui/fl/apply/_internal/flexState/FlexState"],function(D,C,V,U,L,a,b,A,c,S,d,e,J,q,m,i,f,F){"use strict";var g=function(l){this._mComponent=l;this._mChanges=h();this._mChangesInitial=m({},this._mChanges);this._mVariantsChanges={};if(!this._mComponent||!this._mComponent.name){f.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._oVariantController=new d(this._mComponent.name,this._mComponent.appVersion,{});this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function h(){return{mChanges:{},mDependencies:{},mDependentChangesOnMe:{},mControlsWithDependencies:{},aChanges:[]};}function _(o){if(o){switch(o.getFileType()){case"change":return"variantDependentControlChanges";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";}}}g.prototype.getComponentName=function(){return this._mComponent.name;};g.prototype.getCacheKey=function(o){return b.getCacheKey(this._mComponent,o);};g.prototype._preconditionsFulfilled=function(l,I,o){var n=o instanceof C?o.getDefinition():o;if(!n.fileName){f.warning("A change without fileName is detected and excluded from component: "+this._mComponent.name);return false;}function p(){if(I){return(n.fileType==="change")||(n.fileType==="variant");}return(n.fileType==="change")&&(n.changeType!=="defaultVariant");}function r(){if(I){if((n.fileType==="variant")||(n.changeType==="defaultVariant")){return n.selector&&n.selector.persistencyKey;}}return true;}function s(){return c.doesContextMatch(n,l);}function t(){if((n.fileType==="ctrl_variant")||(n.fileType==="ctrl_variant_change")||(n.fileType==="ctrl_variant_management_change")){return n.variantManagementReference||n.variantReference||(n.selector&&n.selector.id);}}if((p()&&r()&&s())||t()){return true;}return false;};g.prototype.getChangesForComponent=function(p,I){return b.getChangesFillingCache(this._mComponent,p,I).then(function(w){var o=m({},w);var s=p&&p.component&&U.getAppComponentForControl(p.component);var t=o.changes&&Array.isArray(o.changes.changes)&&o.changes.changes.length!==0;var v=o.changes&&o.changes.variantSection&&!i(o.changes.variantSection);if(!t&&!v){return[];}var u=s?s.getComponentData():(p&&p.componentData||{});var x=o.changes.changes;if(!this._oMessagebundle&&o.messagebundle&&s){if(!s.getModel("i18nFlexVendor")){if(x.some(function(N){return N.layer==="VENDOR";})){this._oMessagebundle=o.messagebundle;var M=new J(this._oMessagebundle);s.setModel(M,"i18nFlexVendor");}}}var y=p&&p.includeCtrlVariants;var z=p&&p.currentLayer;var B=!(p&&p.ignoreMaxLayerParameter);var E=[o.changes.variantSection];if(z){x=x.filter(this._filterChangeForCurrentLayer.bind(this,z));E.push(false,z);}else if(L.isLayerFilteringRequired()&&B){x=x.filter(this._filterChangeForMaxLayer.bind(this));E.push(true);}else if(this._bHasChangesOverMaxLayer&&!B){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}if(v){if(y||E.length>1){var G=this._getAllCtrlVariantChanges.apply(this,E);x=y?x.concat(G):x;}this._oVariantController.checkAndSetVariantContent(o,u&&u.technicalParameters);}if(!y&&!i(this._oVariantController.getChangeFileContent())){x=x.concat(this._oVariantController.loadInitialChanges());}var H=p&&p.includeVariants;var K=o.changes.contexts||[];return new Promise(function(N){c.getActiveContexts(K).then(function(O){N(x.filter(this._preconditionsFulfilled.bind(this,O,H)).map(n.bind(this,o)));}.bind(this));}.bind(this));}.bind(this));function l(v,o){var s;Object.keys(v).some(function(t){return v[t].variants.some(function(u){if(u.content.fileName===o.getDefinition().variantReference){s=u;return true;}});});return s;}function r(v,o){return v.controlChanges.some(function(s,t){if(s.fileName===o.getDefinition().fileName){v.controlChanges.splice(t,1,o);return true;}});}function n(o,s){var t;if(s instanceof C){t=s;this._mChangesEntries[t.getFileName()]=t;}else{if(!this._mChangesEntries[s.fileName]){this._mChangesEntries[s.fileName]=new C(s);}t=this._mChangesEntries[s.fileName];t.setState(C.states.PERSISTED);if(t.getVariantReference()){var v=this._oVariantController.getChangeFileContent();var u=l.call(this,v,t);if(u&&r(u,t)){b.setVariantManagementSection(this._mComponent,v);}}}return t;}};g.prototype._filterChangeForMaxLayer=function(o){if(L.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(o))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;};g.prototype._filterChangeForCurrentLayer=function(l,o){return l===this._getLayerFromChangeOrChangeContent(o);};g.prototype._getLayerFromChangeOrChangeContent=function(o){var s;if(o instanceof V||o instanceof C){s=o.getLayer();}else{s=o.layer;}return s;};g.prototype._getAllCtrlVariantChanges=function(v,l,s){var n=[];var o=function(){return true;};if(l){o=this._filterChangeForMaxLayer.bind(this);}else if(typeof s==="string"&&s!==""){o=this._filterChangeForCurrentLayer.bind(this,s);}Object.keys(v).forEach(function(p){var r=v[p];r.variants=r.variants.filter(function(t){return!t.content.layer||o(t.content);});r.variants.forEach(function(t){if(Array.isArray(t.variantChanges.setVisible)){t.variantChanges.setVisible=t.variantChanges.setVisible.filter(o);var u=t.variantChanges.setVisible.slice(-1)[0];if(u&&!u.content.visible&&u.content.createdByReset){return;}n=n.concat(t.variantChanges.setVisible);}Object.keys(t.variantChanges).forEach(function(w){if(w!=="setVisible"){t.variantChanges[w]=t.variantChanges[w].filter(o);n=t.variantChanges[w].length>0?n.concat(t.variantChanges[w].slice(-1)[0]):n;}});n=(t.content.fileName!==p)?n.concat([t.content]):n;t.controlChanges=t.controlChanges.filter(o);n=n.concat(t.controlChanges);});Object.keys(r.variantManagementChanges).forEach(function(t){r.variantManagementChanges[t]=r.variantManagementChanges[t].filter(o);n=r.variantManagementChanges[t].length>0?n.concat(r.variantManagementChanges[t].slice(-1)[0]):n;});});return n;};g.prototype.getSmartVariantManagementChangeMap=function(){return this._mVariantsChanges;};g.prototype.getChangesForVariant=function(s,l,p){if(this._mVariantsChanges[l]){return Promise.resolve(this._mVariantsChanges[l]);}var n=function(r){var t=false;var u=r._oDefinition.selector;q.each(u,function(v,w){if(v===s&&w===l){t=true;}});return t;};var o=function(r,t){f.error("key : "+r+" and text : "+t.value);};return this.getChangesForComponent(p).then(function(r){return r.filter(n);}).then(function(r){if(!this._mVariantsChanges[l]){this._mVariantsChanges[l]={};}var I;r.forEach(function(t){I=t.getId();if(t.isValid()){if(this._mVariantsChanges[l][I]&&t.isVariant()){f.error("Id collision - two or more variant files having the same id detected: "+I);q.each(t.getDefinition().texts,o);f.error("already exists in variant : ");q.each(this._mVariantsChanges[l][I].getDefinition().texts,o);}this._mVariantsChanges[l][I]=t;}}.bind(this));return this._mVariantsChanges[l];}.bind(this));};g.prototype.addChangeForVariant=function(s,l,p){var o;var I;var n;var r;var t;if(!p){return undefined;}if(!p.type){f.error("sap.ui.fl.Persistence.addChange : type is not defined");}var u=q.type(p.content);if(u!=='object'&&u!=='array'){f.error("mParameters.content is not of expected type object or array, but is: "+u,"sap.ui.fl.Persistence#addChange");}n={};if(typeof(p.texts)==="object"){q.each(p.texts,function(w,x){n[w]={value:x,type:"XFLD"};});}var v={creation:this._mComponent.appVersion,from:this._mComponent.appVersion};if(this._mComponent.appVersion&&p.developerMode){v.to=this._mComponent.appVersion;}I={changeType:p.type,service:p.ODataService,texts:n,content:p.content,reference:this._mComponent.name,isVariant:p.isVariant,packageName:p.packageName,isUserDependent:p.isUserDependent,validAppVersions:v};I.selector={};I.selector[s]=l;o=C.createInitialFileContent(I);if(p.id){o.fileName=p.id;}r=new C(o);t=r.getId();if(!this._mVariantsChanges[l]){this._mVariantsChanges[l]={};}this._mVariantsChanges[l][t]=r;return r.getId();};g.prototype.saveAllChangesForVariant=function(s){var p=[];q.each(this._mVariantsChanges[s],function(l,o){var n=o.getId();switch(o.getPendingAction()){case"NEW":p.push(a.create(o.getDefinition(),o.getRequest(),o.isVariant()).then(function(r){if(r&&r.response&&r.response[0]){o.setResponse(r.response[0]);}else{o.setState(C.states.PERSISTED);}b.addChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return r;}.bind(this)));break;case"UPDATE":p.push(a.update(o.getDefinition(),o.getRequest()).then(function(r){if(r&&r.response){o.setResponse(r.response);}else{o.setState(C.states.PERSISTED);}b.updateChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return r;}.bind(this)));break;case"DELETE":p.push(a.deleteChange(o.getDefinition(),o.getRequest()).then(function(r){var o=this._mVariantsChanges[s][n];if(o.getPendingAction()==="DELETE"){delete this._mVariantsChanges[s][n];}b.deleteChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return r;}.bind(this)));break;default:break;}}.bind(this));return Promise.all(p);};function j(s,o){return s.idIsLocal?o.createId(s.id):s.id;}g.prototype.loadChangesMapForComponent=function(o){return this.getChangesForComponent({component:o}).then(l.bind(this));function l(n){this._mChanges=h();n.forEach(this._addChangeAndUpdateDependencies.bind(this,o));this._mChangesInitial=m({},this._mChanges);return this.getChangesMapForComponent.bind(this);}};g.prototype.checkForOpenDependenciesForControl=function(s,M,o){return Object.keys(this._mChanges.mDependencies).some(function(K){return this._mChanges.mDependencies[K].changeObject.getDependentSelectorList().some(function(l){return l===M.getControlIdBySelector(s,o);});},this);};g.prototype.copyDependenciesFromInitialChangesMap=function(o,l,n){var I=m({},this._mChangesInitial.mDependencies);var p=I[o.getId()];if(p){var N=[];p.dependencies.forEach(function(s){if(l(s)){this._mChanges.mDependentChangesOnMe[s]=this._mChanges.mDependentChangesOnMe[s]||[];this._mChanges.mDependentChangesOnMe[s].push(o.getId());N.push(s);}}.bind(this));o.getDependentControlSelectorList().forEach(function(s){this._mChanges.mControlsWithDependencies[j(s,n)]=true;}.bind(this));p.dependencies=N;this._mChanges.mDependencies[o.getId()]=p;}return this._mChanges;};g.prototype._addChangeAndUpdateDependencies=function(o,l){l.setInitialApplyState();D.addChangeAndUpdateDependencies(l,o,this._mChanges);};g.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(o,l){D.addRuntimeChangeAndUpdateDependencies(l,o,this._mChanges,this._mChangesInitial);};g.prototype.getChangesMapForComponent=function(){return this._mChanges;};function k(p,o){var M=p.modifier;var l=p.appComponent;var s=o.getSelector();if(!s||!p){return false;}if(s.viewSelector){var n=M.getControlIdBySelector(s.viewSelector,l);return n===p.viewId;}var r=s.id;if(r){var t=r.slice(0,r.lastIndexOf("--"));var v;if(o.getSelector().idIsLocal){if(l){v=l.getLocalId(p.viewId);}}else{v=p.viewId;}return t===v;}return false;}g.prototype.getChangesForView=function(p){return this.getChangesForComponent(p).then(function(l){return l.filter(k.bind(this,p));}.bind(this));};g.prototype.addChange=function(v,o){var l=this.addDirtyChange(v);this._addRunTimeCreatedChangeAndUpdateDependencies(o,l);this._addPropagationListener(o);return l;};g.prototype.addDirtyChange=function(v){var n;if(v instanceof C||v instanceof V){n=v;}else{n=new C(v);}if(this._aDirtyChanges.indexOf(n)===-1){this._aDirtyChanges.push(n);}return n;};g.prototype._addPropagationListener=function(o){var l=U.getAppComponentForControl(o);if(l instanceof e){var n=function(P){return!P._bIsSapUiFlFlexControllerApplyChangesOnControl;};var N=l.getPropagationListeners().every(n);if(N){var M=l.getManifestObject();var v=U.getAppVersionFromManifest(M);var p=sap.ui.require("sap/ui/fl/FlexControllerFactory");var r=p.create(this.getComponentName(),v);var P=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),l,r);P._bIsSapUiFlFlexControllerApplyChangesOnControl=true;l.addPropagationListener(P);}}};g.prototype.saveDirtyChanges=function(s,l,n){var o=l||this._aDirtyChanges;var p=o.slice(0);var r=this._getRequests(o);var P=this._getPendingActions(o);if(P.length===1&&r.length===1&&P[0]==="NEW"){var R=r[0];var t=this._prepareDirtyChanges(o);return a.create(t,R,undefined,n).then(function(u){this._massUpdateCacheAndDirtyState(p,s);return u;}.bind(this));}return this.saveSequenceOfDirtyChanges(p,s,n);};g.prototype.saveSequenceOfDirtyChanges=function(l,s,n){return l.reduce(function(p,o){return p.then(this._performSingleSaveAction(o,n)).then(this._updateCacheAndDirtyState.bind(this,o,s));}.bind(this),Promise.resolve());};g.prototype._performSingleSaveAction=function(o,l){return function(){if(o.getPendingAction()==="NEW"){return a.create(o.getDefinition(),o.getRequest(),undefined,l);}if(o.getPendingAction()==="DELETE"){return a.deleteChange(o.getDefinition(),o.getRequest());}};};g.prototype._updateCacheAndDirtyState=function(o,s){var l="changes";if(!s){if(o.getPendingAction()==="NEW"){if(U.isChangeRelatedToVariants(o)){l=_(o);b.setVariantManagementSection(this._mComponent,m({},this._oVariantController.getChangeFileContent()),o);}b.addChange(this._mComponent,o.getDefinition(),l);}else if(o.getPendingAction()==="DELETE"){if(U.isChangeRelatedToVariants(o)){l=_(o);b.setVariantManagementSection(this._mComponent,m({},this._oVariantController.getChangeFileContent()),o);}b.deleteChange(this._mComponent,o.getDefinition(),l);}}this._aDirtyChanges=this._aDirtyChanges.filter(function(E){return o.getId()!==E.getId();});};g.prototype._massUpdateCacheAndDirtyState=function(l,s){l.forEach(function(o){this._updateCacheAndDirtyState(o,s);},this);};g.prototype._getRequests=function(l){var r=[];l.forEach(function(o){var R=o.getRequest();if(r.indexOf(R)===-1){r.push(R);}});return r;};g.prototype._getPendingActions=function(l){var p=[];l.forEach(function(o){var P=o.getPendingAction();if(p.indexOf(P)===-1){p.push(P);}});return p;};g.prototype._prepareDirtyChanges=function(l){var n=[];l.forEach(function(o){n.push(o.getDefinition());});return n;};g.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};g.prototype.deleteChange=function(o,r){var n=this._aDirtyChanges.indexOf(o);if(n>-1){if(o.getPendingAction()==="DELETE"){return;}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(o,r);return;}o.markForDeletion();this.addDirtyChange(o);this._deleteChangeInMap(o,r);};g.prototype._deleteChangeInMap=function(o,r){var s=o.getId();var l=this._mChanges.mChanges;var M=r?this._mChangesInitial:this._mChanges;var n=M.mDependencies;var p=M.mDependentChangesOnMe;Object.keys(l).some(function(t){var u=l[t];var v=u.map(function(E){return E.getId();}).indexOf(o.getId());if(v!==-1){u.splice(v,1);return true;}});Object.keys(n).forEach(function(t){if(t===s){delete n[t];}else if(n[t].dependencies&&Array.isArray(n[t].dependencies)&&n[t].dependencies.indexOf(s)!==-1){n[t].dependencies.splice(n[t].dependencies.indexOf(s),1);if(n[t].dependencies.length===0){delete n[t];}}});Object.keys(p).forEach(function(t){if(t===s){delete p[t];}else if(Array.isArray(p[t])&&p[t].indexOf(s)!==-1){p[t].splice(p[t].indexOf(s),1);if(p[t].length===0){delete p[t];}}});var I=this._mChanges.aChanges.indexOf(o);if(I!==-1){this._mChanges.aChanges.splice(I,1);}};g.prototype.loadSwitchChangesMapForComponent=function(p){p.changesMap=this._mChanges.mChanges;return this._oVariantController.getChangesForVariantSwitch(p);};g.prototype.transportAllUIChanges=function(r,s,l,n){return this.getChangesForComponent({currentLayer:l,includeCtrlVariants:true}).then(function(o){return S.publish({transportDialogSettings:{rootControl:r,styleClass:s},layer:l,reference:this.getComponentName(),appVersion:this._mComponent.appVersion,localChanges:o,appVariantDescriptors:n});}.bind(this));};g.prototype._getChangesFromMapByNames=function(n){return this._mChanges.aChanges.filter(function(o){return n.indexOf(o.getFileName())!==-1;});};g.prototype.resetChanges=function(l,G,s,n){var o=s&&s.length>0;var p=n&&n.length>0;if(!G&&!o&&!p){f.error("Of the generator, selector IDs and change types parameters at least one has to filled");return Promise.reject("Of the generator, selector IDs and change types parameters at least one has to filled");}return this.getChangesForComponent({currentLayer:l,includeCtrlVariants:true}).then(function(r){var P={reference:this.getComponentName(),appVersion:this._mComponent.appVersion,layer:l,changes:r};if(G){P.generator=G;}if(o){P.selectorIds=s;}if(p){P.changeTypes=n;}return a.resetChanges(P);}.bind(this)).then(function(r){var t=[];if(s||n){var N=[];if(r&&r.response&&r.response.length>0){r.response.forEach(function(u){N.push(u.name);});}b.removeChanges(this._mComponent,N);t=this._getChangesFromMapByNames(N);}return t;}.bind(this));};g.prototype.resetVariantMap=function(r){F.clearPreparedMaps(this._mComponent.name);return this._oVariantController.resetMap(r);};g.prototype.getResetAndPublishInfo=function(p){return a.getFlexInfo(p);};return g;},true);
