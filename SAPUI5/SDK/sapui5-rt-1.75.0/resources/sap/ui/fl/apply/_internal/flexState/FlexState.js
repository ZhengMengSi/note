/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/util/ObjectPath","sap/ui/core/Component","sap/ui/fl/apply/_internal/StorageUtils","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/prepareVariantsMap","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/base/Log"],function(m,O,C,S,L,p,a,b,c,U,d){"use strict";var F={};var _={};var e={};var f={};var g={appDescriptorMap:p,changesMap:a,variantsMap:b};function h(P){var u=C.get(P.componentId);P.componentData=P.componentData||u.getComponentData()||{};P.manifest=P.manifest||P.rawManifest||u.getManifestObject();P.reference=P.reference||U.getComponentClassName(u);}function i(R,M){if(!_[R]){throw Error("State is not yet initialized");}if(!_[R].preparedMaps[M]){var P={storageResponse:_[R].unfilteredStorageResponse,componentId:_[R].componentId,componentData:_[R].componentData};_[R].preparedMaps[M]=F._callPrepareFunction(M,P);}return _[R].preparedMaps[M];}function j(R){return i(R,"appDescriptorMap");}function k(R){return i(R,"changesMap");}function l(R){return i(R,"variantsMap");}function n(P){if(P.reference.endsWith(".Component")){var u=P.reference.split(".");u.pop();var R=u.join(".");_[R]=m({},{storageResponse:{changes:S.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:S.getEmptyFlexDataResponse()},preparedMaps:{},componentId:P.componentId,partialFlexState:P.partialFlexState});f[R]=f[P.reference];}}function o(R){var u=m({},R);var v=u.changes;var w=["changes","variants","variantChanges","variantDependentControlChanges","variantManagementChanges"];if(c.isLayerFilteringRequired()){w.forEach(function(T){v[T]=c.filterChangeDefinitionsByMaxLayer(v[T]);});}return u;}function q(P){f[P.reference]=L.loadFlexData(P).then(function(R){_[P.reference]=m({},{unfilteredStorageResponse:R,preparedMaps:{},componentId:P.componentId,componentData:P.componentData,partialFlexState:P.partialFlexState});n(P);r(P.reference);return R;});return f[P.reference];}function r(R){var u=c.getUshellContainer();if(u){e[R]=t.bind(null,R);u.getService("ShellNavigation").registerNavigationFilter(e[R]);}}function s(R){var u=c.getUshellContainer();if(u&&e[R]){u.getService("ShellNavigation").unregisterNavigationFilter(e[R]);delete e[R];}}function t(R,N,u){var v=c.getUshellContainer();if(v){var w=v.getService("ShellNavigation");try{var x=c.getMaxLayerTechnicalParameter(N);var P=c.getMaxLayerTechnicalParameter(u);if(x!==P){F.clearMaxLayerFiltering(R);}}catch(E){d.error(E.message);}return w.NavigationFilterStatus.Continue;}}F.initialize=function(P){return Promise.resolve().then(function(P){h(P);if(f[P.reference]){return f[P.reference].then(function(P){if(_[P.reference].partialFlexState===true&&P.partialFlexState!==true){P.partialFlexData=_[P.reference].unfilteredStorageResponse.changes;return q(P);}if(_[P.reference].componentId!==P.componentId){return q(P);}return _[P.reference].unfilteredStorageResponse;}.bind(null,P));}return q(P);}.bind(null,P)).then(function(P,R){if(!_[P.reference].storageResponse){_[P.reference].storageResponse=o(R);}F.getVariantsState(P.reference);}.bind(null,P));};F.clearAndInitialize=function(P){h(P);var v=!!O.get(["preparedMaps","variantsMap"],_[P.reference]);F.clearState(P.reference);return F.initialize(P).then(function(v,R){if(v){return F.getVariantsState(R);}}.bind(null,v,P.reference));};F.clearState=function(R){if(R){s(R);delete _[R];delete f[R];}else{Object.keys(_).forEach(function(R){s(R);});_={};f={};}};F.clearMaxLayerFiltering=function(R){delete _[R].storageResponse;F.clearPreparedMaps(R);};F.getUIChanges=function(R){return k(R).changes;};F.getAppDescriptorChanges=function(R){return j(R).appDescriptorChanges;};F.getVariantsState=function(R){var v=l(R);_[R].unfilteredStorageResponse.changes.variantSection=v;return v;};F.getUI2Personalization=function(R){return _[R].unfilteredStorageResponse.changes.ui2personalization;};F._callPrepareFunction=function(M,P){return g[M](P);};F.getStorageResponse=function(R){if(f[R]){return f[R].then(function(){return _[R].unfilteredStorageResponse;});}};F.getFlexObjectsFromStorageResponse=function(R){return _[R].unfilteredStorageResponse.changes;};F.clearPreparedMaps=function(R){if(_[R]){_[R].preparedMaps={};}};return F;},true);
