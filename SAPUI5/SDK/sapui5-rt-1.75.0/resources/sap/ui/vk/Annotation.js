/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/vk/AnnotationStyle"],function(C,A){"use strict";var c=C.extend("sap.ui.vk.Annotation",{metadata:{properties:{nodeRef:"any",title:"string",style:{type:"sap.ui.vk.AnnotationStyle",defaultValue:A.Default},visible:{type:"boolean",defaultValue:true}},events:{titleChanged:{parameteres:{title:{type:"string"}}}}},constructor:function(i,S){C.apply(this,arguments);}});c.prototype._getNodeRefCenter=function(){var a=new THREE.Vector3();if(this.getNodeRef()){var n=this.getNodeRef();if(n.userData.lodInfo.boundingBox){var t=n.userData.lodInfo.boundingBox;var b=new THREE.Vector3(t[0],t[1],t[2]);var e=new THREE.Vector3(t[3],t[4],t[5]);var f=new THREE.Box3(b,e);f.getCenter(a);a.applyMatrix4(n.matrixWorld);}}return a;};c.prototype._getNodeRefScreenCenter=function(v){var a=this._getNodeRefCenter();var b=v.getCamera().getCameraRef();var e=v.getDomRef().getBoundingClientRect();var h=e.width/2;var f=e.height/2;a.project(b);a.x=(a.x*h)+h;a.y=(a.y*f)+f;return a;};c.prototype._getSortIndex=function(v){if(this.getNodeRef()){var a=this._getNodeRefCenter();var b=v.getCamera().getCameraRef();a.project(b);return Math.floor(10000*(1-a.z));}return"auto";};c.prototype.setScene=function(a){this._sceneRef=a;};c.prototype._getOpacity=function(){if(this._sceneRef){var z=this.getDomRef().style.zIndex;var a=this._sceneRef.getAnnotations().filter(function(g){return g.getVisible()===true;});var b=Array.from(a,function(g){return g.getDomRef().style.zIndex;});var e=Math.max.apply(null,b);var f=Math.min.apply(null,b);return 0.7+(z-f)*0.3/(e-f);}return 1;};c.prototype._getDelay=function(){if(this._sceneRef){var z=this.getDomRef().style.zIndex;var e=this._sceneRef.getAnnotations().filter(function(a){return a.getVisible()===true;});var f=Array.from(e,function(a){return a.getDomRef().style.zIndex;}).sort(function(a,b){return b-a;});return f.indexOf(z);}};c.prototype.onAfterRendering=function(){var a=this.getDomRef();if(a){a.style.display=this.getTitle()?"block":"none";this._initialOffsetWidth=a.offsetWidth;this._initialOffsetHeight=a.offsetHeight;this._textDiv=this._textDiv||new sap.m.TextArea({value:this.getTitle(),growing:true,valueLiveUpdate:true});this._textDiv.detachLiveChange(this._handleTitleChange,this);this._textDiv.attachLiveChange(this._handleTitleChange,this);this._textDiv.addStyleClass("sapUiVizKitAnnotationText");this._textDiv.placeAt(a);delete this._textDiv.ontouchstart;if(!this.getVisible()){a.style.visibility="hidden";}}};c.prototype._handleTitleChange=function(){this.fireTitleChanged({title:this._textDiv.getValue()});};c.prototype.setVisible=function(v){this.setProperty("visible",v);var a=this.getDomRef();if(a){a.style.visibility=v?"visible":"hidden";}};c.prototype._update=function(v){var t=this;var a=this.getDomRef();if(a){var n=this._getNodeRefScreenCenter(v);var b=v.getDomRef().getBoundingClientRect();if(this.getStyle()!==A.Fixed){a.style.zIndex=this._getSortIndex(v);a.style.opacity=this._getOpacity();a.style.animationDelay=this._getDelay()+"s";a.style.transform="perspective(1px) scale3d("+a.style.opacity+", "+a.style.opacity+", "+a.style.opacity+")";}switch(this.getStyle()){case A.Default:a.style.transformOrigin="bottom center";a.style.left=(n.x-a.offsetWidth/2)+"px";var e=n.y;a.style.bottom="calc("+(e+(a.offsetHeight*0.25))+"px + 2.5rem)";break;case A.Explode:a.style.transformOrigin="bottom left";var f=(n.x-this._initialOffsetWidth/2);a.style.left="calc("+(f+(this._initialOffsetWidth*0.25))+"px - 3rem)";a.style.bottom="calc("+(n.y+this._initialOffsetHeight*0.25)+"px + 3rem)";break;case A.Square:a.style.transformOrigin="top right";a.style.right="calc("+(b.width-(n.x-this._initialOffsetWidth/2))+"px + 3rem)";a.style.top="calc("+(b.height-n.y)+"px + 3rem)";break;case A.Random:var g=a.childNodes;if(g){var r={leftMargin:"5rem",bottomMargin:"5rem",squareLeft:"-6rem",squareBottom:"-6rem",transformOrigin:"bottom left",connectSquare:g[1]};var l={leftMargin:"-15rem",bottomMargin:"5rem",squareLeft:"15rem",squareBottom:"-6rem",transformOrigin:"bottom right",connectSquare:g[4]};var h={leftMargin:"0rem",bottomMargin:"0rem",squareLeft:"-1rem",squareBottom:"-1rem",transformOrigin:"bottom left",connectSquare:g[1]};this._position=n.x<b.width/2?l:r;if(this._isFold===true){this._position=h;}}a.style.setProperty("--square-left",this._position.squareLeft);a.style.setProperty("--square-bottom",this._position.squareBottom);a.style.transformOrigin=this._position.transformOrigin;a.style.left="calc("+(n.x-this._initialOffsetWidth*0.25)+"px + "+this._position.leftMargin+")";a.style.bottom="calc("+(n.y+this._initialOffsetHeight*0.25)+"px + "+this._position.bottomMargin+")";if(g[0]&&this._position.connectSquare&&g[2]){d(g[0],this._position.connectSquare,g[2]);g[0].onclick=function(){this._isFold=!this._isFold;}.bind(this);}if(!g[3].innerHTML||this._prevText!==this._textDiv.getValue()){this._prevText=this._textDiv.getValue();g[3].innerHTML="<span>"+this._prevText.split("").join("</span><span>")+"</span>";this._textDiv.rerender();Array.from(g[3].childNodes).forEach(function(k){k.style.animationDelay=(this._getDelay()+Math.random())+"s";}.bind(this));}break;case A.Fixed:var m=function(){t._handleViewportMove(t,event);};var i=function(){t._handleViewportTouchMove(t,event,m,i,v,j);};var j=function(){t._handleViewportStop(t,m,i,v,j);};if(sap.ui.Device.support.touch){this._textDiv.ontouchstart=function(k){if(k.originalEvent.button===0||!k.originalEvent.button){delete t._textDiv.ontouchend;t._moving=true;t._initialX=k.targetTouches[0].clientX;t._initialY=k.targetTouches[0].clientY;v.attachBrowserEvent("touchmove",i);v.attachBrowserEvent("mousemove",m);v.attachBrowserEvent("mouseup",j);}};}else{this._textDiv.onmousedown=function(k){if(k.originalEvent.button===0){t._moving=true;t._initialX=k.clientX;t._initialY=k.clientY;v.attachBrowserEvent("mousemove",m);v.attachBrowserEvent("mouseup",j);}};}break;default:break;}}};c.prototype._handleViewportTouchMove=function(a,e,m,t,v,b){if(a._moving){a._textDiv.ontouchend=function(e){a._handleViewportStop(a,m,t,v,b);};a._currentX=e.targetTouches[0].clientX-a._initialX;a._currentY=e.targetTouches[0].clientY-a._initialY;}s(a._currentX,a._currentY,a.getDomRef());};c.prototype._handleViewportMove=function(a,e){if(a._moving){a._currentX=e.clientX-a._initialX;a._currentY=e.clientY-a._initialY;}s(a._currentX,a._currentY,a.getDomRef());};c.prototype._handleViewportStop=function(a,m,t,v,b){a._moving=false;var e=a.getDomRef();var f=window.getComputedStyle(document.getElementById(e.id));var g=e.style.transform;e.style.transform="";var x=parseFloat(g.substring(g.indexOf("(")+1,g.indexOf(",")));var y=parseFloat(g.substring(g.indexOf(",")+1,g.indexOf(")")));e.style.left=(parseFloat(f.left)+x)+"px";e.style.top=(parseFloat(f.top)+y)+"px";v.detachBrowserEvent("touchmove",t);v.detachBrowserEvent("mousemove",m);v.detachBrowserEvent("mouseup",b);};function s(x,y,a){a.style.transform="translate("+x+"px, "+y+"px)";}function d(f,t,l){var T=f.offsetTop+f.offsetHeight/2;var a=t.offsetTop+t.offsetHeight/2;var L=f.offsetLeft+f.offsetWidth/2;var b=t.offsetLeft+t.offsetWidth/2;var e=Math.abs(a-T);var g=Math.abs(b-L);var h=Math.sqrt(e*e+g*g);var i=180/Math.PI*Math.acos(e/h);var j,k;if(a>T){j=(a-T)/2+T;}else{j=(T-a)/2+a;}if(b>L){k=(b-L)/2+L;}else{k=(L-b)/2+b;}if((T<a&&L<b)||(a<T&&b<L)||(T>a&&L>b)||(a>T&&b>L)){i*=-1;}j-=h/2;l.style.transform="rotate("+i+"deg)";l.style.top=j+"px";l.style.left=k+"px";l.style.height=h+"px";}return c;});
