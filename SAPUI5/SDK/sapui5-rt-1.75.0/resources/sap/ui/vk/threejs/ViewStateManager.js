/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ContentConnector","../ViewStateManagerBase","./thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight"],function(v,C,V,t,a,b,d,e,S,O,R,N,f,H,g,h){"use strict";var j;var k=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var m=k.getMetadata().getParent().getClass().prototype;k.prototype.init=function(){if(m.init){m.init.call(this);}this._channel=0;this._layers=new THREE.Layers();this._layers.set(this._channel);this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._outlineRenderer=new f(1.0);this._outlinedNodes=new Set();this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1.0);this._visibilityTracker=new j();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this._selectionColor=new THREE.Color(0xC0C000);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._customPositionedNodes=new Set();this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new H();this._transitionHighlightPlayer=new H();v.getEventBus().subscribe("sap.ui.vk","activateView",this._onViewActivated,this);};k.prototype.exit=function(){v.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onViewActivated,this);};k.prototype._setContent=function(c){var s=null;if(c&&c instanceof S){s=c;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}};k.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};k.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};k.prototype._handleContentReplaced=function(c){var i=c.getParameter("newContent");this._setContent(i);};k.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;return this;};k.prototype._setNodeHierarchy=function(c){var i=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear();}if(c){this._nodeHierarchy=c;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._initialState={visible:[],hidden:[]};var l=this;var r=c.findNodesByName();r.forEach(function(s){(s.layers.test(l._layers)?l._initialState.visible:l._initialState.hidden).push(s);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(c!==i){this.fireNodeHierarchyReplaced({oldNodeHierarchy:i,newNodeHierarchy:c});}return this;};k.prototype._handleNodeReplaced=function(c){var r=c.getParameter("ReplacedNodeRef");var i=c.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(i,true);this.setSelectionState(r,false);}};k.prototype._handleNodeUpdated=function(c){var i=c.getParameter("nodeRef");if(this.getSelectionState(i)){this.setSelectionState(i,false);this.setSelectionState(i,true);}};k.prototype._renderOutline=function(r,s,i){var c=d(this._outlineColorABGR);var l=new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0);this._outlineRenderer.render(r,s,i,Array.from(this._outlinedNodes),l,this._jointCollection);};k.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};k.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};k.prototype._getCurrentView=function(){var c=sap.ui.getCore().byId(this.getViewManager());if(!c){return null;}var i=c.getActiveView();return i;};k.prototype.resetNodeProperty=function(c,i){var l=this._getCurrentView();if(!l){return;}var r=l.getNodeInfos();if(r){var s=[];s.push(c);if(this._jointCollection&&this._jointCollection.length>0){for(var u=0;u<this._jointCollection.length;u++){var w=this._jointCollection[u];var x=w.parent;if(x!==c){break;}s.push(w.node);}}r.forEach(function(y){if(!s.includes(y.target)){return;}if(!i||i!=="opacity"){var z={nodeRefs:[],positions:[]};var A;var B;var D;if(y.transform){var E=new THREE.Vector3();var F=new THREE.Quaternion();var G=new THREE.Vector3();var I=q(y.transform);I.decompose(E,F,G);A=E.toArray();B=F.toArray();D=G.toArray();}else if(y.scale&&y.rotate&&y.translate){A=y.translate.slice();B=y.rotate.slice();D=y.scale.slice();}if(A){z.nodeRefs.push(y.target);z.positions.push({translation:A,quaternion:B,scale:D});this.setTransformation(z.nodeRefs,z.positions,true);}}else{c._vkSetOpacity(y.opacity,this._jointCollection);var J={changed:c,opacity:r.opacity};this.fireOpacityChanged(J);}}.bind(this));}};k.prototype.getVisibilityComplete=function(){var c=this.getNodeHierarchy(),i=c.findNodesByName(),l=[],r=[];i.forEach(function(s){var u=c.createNodeProxy(s);var w=u.getVeId();c.destroyNodeProxy(u);if(w){if(this.getVisibilityState(s)){l.push(w);}else{r.push(w);}}},this);return{visible:l,hidden:r};};k.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};k.prototype.getVisibilityState=function(c){var l=this._layers;return Array.isArray(c)?c.map(function(i){return i.layers.test(l);}):c.layers.test(l);};k.prototype.setVisibilityState=function(c,i,r){if(!Array.isArray(c)){c=[c];}var l=Array.isArray(i);var s=[];var u=c;if(r){u=[];c.forEach(function(D,E){var F=this._collectNodesRecursively(D);u=u.concat(F);var G=s.length;s.length=G+F.length;s.fill(l?i[E]:i,G);},this);}else if(!l){s.length=u.length;s.fill(i);}else{s=i;}var w=[];var x=new Set();var y=this._layers,z=this._channel;var A=u.filter(function(D,E){if(x.has(D)){return false;}x.add(D);var A=D?D.layers.test(y)!=s[E]:false;if(A){w.push(s[E]);}return A;},this);if(A.length>0){var B={visible:[],hidden:[]};A.forEach(function(D,E){if(w[E]){D.layers.enable(z);B.visible.push(D);}else{D.layers.disable(z);B.hidden.push(D);}},this);if(this.getShouldTrackVisibilityChanges()){A.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(B);}return this;};k.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};k.prototype.enumerateOutlinedNodes=function(c){this._outlinedNodes.forEach(c);return this;};k.prototype.getSelectionState=function(c){var s=this._selectedNodes;function i(l){return s.has(l);}return Array.isArray(c)?c.map(i):i(c);};k.prototype._isAChild=function(c,i){var l=c.parent;while(l){if(i.has(l)){return true;}l=l.parent;}return false;};k.prototype._AddBoundingBox=function(c){if(c.userData.boundingBox===undefined){c.userData.boundingBox=new THREE.Box3();c._vkCalculateObjectOrientedBoundingBox();}if(!c.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&c.userData.boxHelper===undefined){var i=new THREE.Box3Helper(c.userData.boundingBox,0xffff00);i.material.color=this._selectionColor;this._boundingBoxesScene.add(i);i.parent=c;c.userData.boxHelper=i;}};k.prototype._RemoveBoundingBox=function(c){if(c.userData.boundingBox!==undefined){delete c.userData.boundingBox;}if(c.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(c.userData.boxHelper);delete c.userData.boxHelper;}};k.prototype._updateBoundingBoxesIfNeeded=function(){var u=new Set();this._selectedNodes.forEach(function(c){var i=c.parent;while(i){if(this._selectedNodes.has(i)){u.add(i);}i=i.parent;}}.bind(this));u.forEach(function(c){c._vkCalculateObjectOrientedBoundingBox();});};k.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(c){if(c.userData.boundingBox){c._vkCalculateObjectOrientedBoundingBox();}});};k.prototype.setShowSelectionBoundingBox=function(c){this._showSelectionBoundingBox=c;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(i){this._AddBoundingBox(i);}.bind(this));}else{this._selectedNodes.forEach(function(i){this._RemoveBoundingBox(i);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};k.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};k.prototype._isAncestorSelected=function(c){c=c.parent;while(c){if(this._selectedNodes.has(c)){return true;}c=c.parent;}return false;};k.prototype._updateHighlightColor=function(c,r){var s=r||this._selectedNodes.has(c);c.userData.highlightColor=s?this._highlightColorABGR:undefined;c._vkUpdateMaterialColor();var u=c.children;for(var i=0,l=u.length;i<l;i++){var w=u[i].userData;if(w&&w.objectType===O.Hotspot){continue;}this._updateHighlightColor(u[i],s);}};k.prototype.setSelectionState=function(c,s,r,i){if(!Array.isArray(c)){c=[c];}c=(r||this.getRecursiveSelection()?this._collectNodesRecursively(c):c).filter(function(u,w,x){return x.indexOf(u)===w;});if(this.getRecursiveSelection()&&!s){c=this._nodeHierarchy._appendAncestors(c);}var l=c.filter(function(u){return this._selectedNodes.has(u)!==s;},this);if(l.length>0){l.forEach(function(u){if(u){this._selectedNodes[s?"add":"delete"](u);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](u);}}},this);l.forEach(function(u){if(u){this._updateHighlightColor(u,s||this._isAncestorSelected(u));}},this);if(!i){this.fireSelectionChanged({selected:s?l:[],unselected:s?[]:l});}}return this;};k.prototype.setSelectionStates=function(s,u,r,c){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(u)){u=[u];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);u=(r||this.getRecursiveSelection()?this._collectNodesRecursively(u):u);if(this.getRecursiveSelection()){u=this._nodeHierarchy._appendAncestors(u,s);}var i=s.filter(function(w){return this._selectedNodes.has(w)===false;},this);var l=u.filter(function(w){return this._selectedNodes.has(w)===true;},this);if(i.length>0||l.length>0){i.forEach(function(w){this._selectedNodes.add(w);this._updateHighlightColor(w,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(w);}},this);l.forEach(function(w){this._selectedNodes.delete(w);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(w);}},this);l.forEach(function(w){this._updateHighlightColor(w,this._isAncestorSelected(w));},this);if(!c){this.fireSelectionChanged({selected:i,unselected:l});}}return this;};k.prototype.setOutlineColor=function(c){switch(typeof c){case"number":this._outlineColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._outlineColorABGR=e(a(c));}break;default:return this;}this.fireOutlineColorChanged({outlineColor:b(d(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this;};k.prototype.getOutlineColor=function(i){return i?this._outlineColorABGR:b(d(this._outlineColorABGR));};k.prototype.getOutliningState=function(c){var i=this._outlinedNodes;function l(r){return i.has(r);}return Array.isArray(c)?c.map(l):l(c);};k.prototype.setOutliningStates=function(c,u,r,i){if(!Array.isArray(c)){c=[c];}if(!Array.isArray(u)){u=[u];}c=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(c):c);u=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(u):u);if(this.getRecursiveOutlining()){u=this._nodeHierarchy._appendAncestors(u,c);}var l=c.filter(function(w){return this._outlinedNodes.has(w)===false;},this);var s=u.filter(function(w){return this._outlinedNodes.has(w)===true;},this);if(l.length>0||s.length>0){l.forEach(function(w){this._outlinedNodes.add(w);},this);s.forEach(function(w){this._outlinedNodes.delete(w);},this);if(!i){this.fireOutliningChanged({outlined:l,unoutlined:s});}}return this;};k.prototype.setOutlineWidth=function(w){this._outlineWidth=w;this._outlineRenderer.setOutlineWidth(w);this.fireOutlineWidthChanged({width:w});return this;};k.prototype.getOutlineWidth=function(){return this._outlineWidth;};k.prototype._collectNodesRecursively=function(c){var r=[],i=this;if(!Array.isArray(c)){c=[c];}c.forEach(function collectChildNodes(l){r.push(l);i._nodeHierarchy.enumerateChildren(l,collectChildNodes,false,true);});return r;};k.prototype._getOpacity=function(c){return c.userData.opacity!==undefined?c.userData.opacity:null;};k.prototype.getOpacity=function(c){if(Array.isArray(c)){return c.map(this._getOpacity,this);}else{return this._getOpacity(c);}};k.prototype.setOpacity=function(c,i,r){if(!Array.isArray(c)){c=[c];}var l=Array.isArray(i);if(i==null){i=undefined;}else if(l){i.forEach(function(A,B){if(A==null){i[B]=undefined;}});}var s=[];var u=c;if(!l){s.length=u.length;s.fill(i);}else{s=i;}var w=[];var x=new Set();var y=u.filter(function(A,B){if(x.has(A)){return false;}x.add(A);var y=A?A.userData.opacity!==s[B]:false;if(y){w.push(s[B]);}return y;},this);if(y.length>0){y.forEach(function(A,B){A._vkSetOpacity(w[B],this._jointCollection);},this);var z={changed:y,opacity:l?w:w[0]};this.fireOpacityChanged(z);}return this;};k.prototype._getTintColorABGR=function(c){return c.userData.tintColor!==undefined?c.userData.tintColor:null;};k.prototype._getTintColor=function(c){return c.userData.tintColor!==undefined?b(d(c.userData.tintColor)):null;};k.prototype.getTintColor=function(c,i){var l=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(c)){return c.map(this[l],this);}else{return this[l](c);}};k.prototype.setTintColor=function(c,i,r){if(!Array.isArray(c)){c=[c];}var l=function(D){var E=null;switch(typeof D){case"number":E=D;break;case"string":if(sap.ui.core.CSSColor.isValid(D)){E=e(a(D));}break;default:E=undefined;break;}return E;};var s=Array.isArray(i);var u=[];var w=c;if(r){w=[];c.forEach(function(D,E){var F=this._collectNodesRecursively(D);w=w.concat(F);var G=u.length;u.length=G+F.length;u.fill(s?i[E]:i,G);},this);}else if(!s){u.length=w.length;u.fill(i);}else{u=i;}var x=[];var y=new Set();var z=w.filter(function(D,E){if(y.has(D)){return false;}y.add(D);var z=D?D.userData.tintColor!==l(u[E]):false;if(z){x.push(u[E]);}return z;},this);if(z.length>0){var A=[];z.forEach(function(D,E){var F=l(x[E]);D._vkSetTintColor(F);A.push(F);},this);var B={changed:z,tintColor:s?x:x[0],tintColorABGR:s?A:A[0]};this.fireTintColorChanged(B);}return this;};k.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=e(a(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(i){this._updateHighlightColor(i,true);},this);}this.fireHighlightColorChanged({highlightColor:b(d(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};k.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:b(d(this._highlightColorABGR));};k.prototype.getTransformation=function(c){var i=function(l){return{translation:this.getTranslation(l),quaternion:this.getRotation(l,R.Quaternion),scale:this.getScale(l)};}.bind(this);if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(l){r.push(i(l));});return r;};k.prototype.getTranslation=function(c){var i=function(l){return!l.userData.position?l.position.toArray():l.userData.position.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(l){r.push(i(l));});return r;};k.prototype.getScale=function(c){var i=function(l){return!l.userData.scale?l.scale.toArray():l.userData.scale.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(l){r.push(i(l));});return r;};k.prototype.getRotation=function(c,r){var i=function(u){var w=!u.userData.quaternion?u.quaternion:u.userData.quaternion;var l;switch(r){case R.AngleAxis:if(w.w>1){w.normalize();}var A=2*Math.acos(w.w);var x;var y;var z;var s=Math.sqrt(1-w.w*w.w);if(s<0.0001){x=1;y=0;z=0;}else{x=w.x/s;y=w.y/s;z=w.z/s;}l=[x,y,z,A];break;case R.Euler:var B=new THREE.Euler();B.setFromQuaternion(w);l=B.toArray();break;default:l=w.toArray();}return l;};if(!Array.isArray(c)){return i(c);}var l=[];c.forEach(function(s){l.push(i(s));});return l;};k.prototype.setTransformation=function(c,i,l){var r=Array.isArray(c);if(!Array.isArray(c)){c=[c];}var s={changed:[],transformation:[]};var u=function(w){return{position:w.position.toArray(),quaternion:w.quaternion.toArray(),scale:w.scale.toArray()};};if(!i){c.forEach(function(w){if(w.userData.position&&w.userData.quaternion&&w.userData.scale){w.position=w.userData.position;w.quaternion=w.userData.quaternion;w.scale=w.userData.scale;w.updateMatrix();delete w.userData.position;delete w.userData.quaternion;delete w.userData.scale;delete w.userData.invMatrix;delete w.userData.animMatrix;}this._customPositionedNodes.delete(w);s.changed.push(w);s.transformation.push(u(w));},this);}else{if(!Array.isArray(i)){i=[i];}c.forEach(function(w,x){var y=w.userData;if(!y){return;}if(!y.position){y.position=w.position.clone();}if(!y.quaternion){y.quaternion=w.quaternion.clone();}if(!y.scale){y.scale=w.scale.clone();}var z=i[x];w.position.fromArray(z.translation);w.scale.fromArray(z.scale);if(z.quaternion){w.quaternion.fromArray(z.quaternion);}else if(z.angleAxis){var A=new THREE.Vector3(z.angleAxis[0],z.angleAxis[1],z.angleAxis[2]);w.quaternion.setFromAxisAngle(A,z.angleAxis[3]);}else if(z.euler){var B=new THREE.Euler();B.fromArray(z.euler[0],z.euler[1],z.euler[2],z.euler[3]);w.quaternion.setFromEuler(B);}w.updateMatrix();if(l||!y.animMatrix){y.invMatrix=(y.invMatrix||new THREE.Matrix4()).getInverse(w.matrix);y.animMatrix=(y.animMatrix||new THREE.Matrix4()).identity();}else{y.animMatrix.multiplyMatrices(y.invMatrix,w.matrix);}this._customPositionedNodes.add(w);s.changed.push(w);s.transformation.push(u(w));},this);}if(!r){s.changed=s.changed[0];s.transformation=s.transformation[0];}this.fireTransformationChanged(s);return this;};k.prototype.getJoints=function(){return this._jointCollection;};k.prototype.setJoints=function(c){this._clearJointNodes();this._jointCollection=[];if(!c){return this;}var i=new Set();var l=new Map();c.forEach(function(s){i.add(s.node);l.set(s.node,s);});while(i.size>0){var r=i.values().next().value;i.delete(r);var s=l.get(r);var u=[s];var w=[];var x=s.parent;while(x){s=l.get(x);if(s!==undefined){if(i.delete(x)){u.push(s);}if(w.length>0){s.nodesToUpdate=s.nodesToUpdate||[];while(w.length>0){var y=w.pop();if(s.nodesToUpdate.indexOf(y)>=0){break;}s.nodesToUpdate.push(y);}}w.length=0;x=s.parent;}else{w.push(x);x=x.parent;}}while(u.length>0){this._jointCollection.push(u.pop());}}return this;};k.prototype._clearJointNodes=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(c){var i=c.node;if(i&&i.userData){delete i.userData.invMatrix;delete i.userData.animMatrix;}var l=c.parent;if(l&&l.userData){delete l.userData.invMatrix;delete l.userData.animMatrix;}if(c.nodesToUpdate){c.nodesToUpdate.forEach(function(s){if(s&&s.userData){delete s.userData.invMatrix;delete s.userData.animMatrix;}});}});}};var n=new THREE.Vector3();var o=new THREE.Quaternion();var p=new THREE.Vector3();k.prototype._updateJointNodes=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(c){var i=c.node;if(i.userData&&i.userData.animMatrix===null){return;}c.parent.updateMatrixWorld(true);i.updateMatrixWorld(true);i.matrix.compose(n.fromArray(c.translation),o.fromArray(c.quaternion),p.fromArray(c.scale));i.matrixWorld.multiplyMatrices(c.parent.matrixWorld,i.matrix);if(i.userData.animMatrix){i.matrixWorld.multiply(i.userData.animMatrix);}if(i.parent){i.matrix.getInverse(i.parent.matrixWorld).multiply(i.matrixWorld);}else{i.matrix.copy(i.matrixWorld);}i.matrix.decompose(i.position,i.quaternion,i.scale);i.matrixWorldNeedsUpdate=false;if(c.nodesToUpdate){c.nodesToUpdate.forEach(function(s){if(s.matrixAutoUpdate){s.updateMatrix();}s.matrixWorld.multiplyMatrices(s.parent.matrixWorld,s.matrix);s.matrixWorldNeedsUpdate=false;});}});}};k.prototype._recalculateJointsForNodes=function(c){if(this._jointCollection&&this._jointCollection.length>0){var i=new Map();this._jointCollection.forEach(function(r){i.set(r.node,r);});var l=new THREE.Matrix4();c.forEach(function(r){var s=i.get(r);if(s){r.updateMatrixWorld();s.parent.updateMatrixWorld();l.getInverse(s.parent.matrixWorld).multiply(r.matrixWorld);var n=new THREE.Vector3();var o=new THREE.Quaternion();var p=new THREE.Vector3();l.decompose(n,o,p);n.toArray(s.translation);o.toArray(s.quaternion);p.toArray(s.scale);}});}};k.prototype._setForSkippingJoints=function(c){if(this._jointCollection&&this._jointCollection.length>0){var i=new Map();this._jointCollection.forEach(function(l){i.set(l.node,l);});c.forEach(function(l){var r=i.get(l);if(r){if(!l.userData){l.userData={};}l.userData.animMatrix=null;}});}};k.prototype._updateMaterialInNode=function(c){var l=c.target;var i,r;if(l&&l.children){for(i=0;i<l.children.length;i++){r=l.children[i];if(r.userData&&r.userData.animatedColor){r._vkUpdateMaterialColor();}}}var s=l.userData.materialId;l.userData.materialId=c.materialId;var u=false;if(s===undefined){if(l.userData.materialId!==undefined){u=true;}}else if(s!==l.userData.materialId){u=true;}if(!u){return;}var w=null;if(l.userData.materialId){var x=this._scene.getMaterial(l.userData.materialId);if(x){w=x.getMaterialRef();}}if(l&&l.children){for(i=0;i<l.children.length;i++){r=l.children[i];if(w){r.material=w;r.userData.materialId=c.materialId;}else if(r.userData&&r.userData.initialMaterialId){var y=this._scene.getMaterial(r.userData.initialMaterialId);if(y){var z=y.getMaterialRef();r.material=z;r.userData.materialId=r.userData.initialMaterialId;}}if(r.material&&r.material.userData){r.userData.originalMaterial=r.material;r.material=r.material.clone();}}}};function q(c){return new THREE.Matrix4().set(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],0,0,0,1);}k.prototype._resetNodesStatusByCurrenView=function(c,s,i){var l=this.getNodeHierarchy();if(l){var r;if(c){r=c.getPlaybacks();}var u=c.getNodeInfos();if(u){this._nodesTransitionHelper.clear();var w={nodeRefs:[],positions:[]};var x=new THREE.Vector3();var y=new THREE.Quaternion();var z=new THREE.Vector3();u.forEach(function(D){if(D.target===null){return;}function E(I,J,K){for(var L=0;L<I.elements.length;L++){if(Math.abs(I.elements[L]-J.elements[L])>K){return false;}}return true;}if(D.transform){var F=q(D.transform);if(!E(F,D.target.matrix,1e-6)){if((!r||!r.length)&&i){var G=l.createNodeProxy(D.target);this._nodesTransitionHelper.setNodeForDisplay(G,F);}else{F.decompose(x,y,z);w.nodeRefs.push(D.target);w.positions.push({translation:x.toArray(),quaternion:y.toArray(),scale:z.toArray()});}}}else if(D.scale&&D.rotate&&D.translate){w.nodeRefs.push(D.target);w.positions.push({translation:D.translate.slice(),quaternion:D.rotate.slice(),scale:D.scale.slice()});}}.bind(this));if(c.userData&&c.userData.nodeStartDataByAnimation){c.userData.nodeStartDataByAnimation.forEach(function(D,E){if(D.translate&&D.rotate&&D.scale){w.nodeRefs.push(E);w.positions.push({translation:D.translate.slice(),quaternion:D.rotate.slice(),scale:D.scale.slice()});}},this);}if(w.nodeRefs.length){this.setTransformation(w.nodeRefs,w.positions,true);}if(s){var A=[];var B=[];u.forEach(function(D){(D.visible?A:B).push(D.target);});this.setVisibilityState(l.getChildren()[0].children,false,true);this.setVisibilityState(A,true,false);this.setVisibilityState(B,false,false);this._startViewChangeNodeTransition();}}}};k.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var c=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){c=false;});var i=function(){if(c){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(i);}}.bind(this);window.requestAnimationFrame(i);};k.prototype._resetNodesMaterialAndOpacityByCurrenView=function(c){if(!c){return;}var i=c.getNodeInfos();if(i){i.forEach(function(r){if(!r.target){return;}this._updateMaterialInNode(r);}.bind(this));i.forEach(function(r){if(!r.target||!r.target.userData){return;}r.target.userData.opacity=r.opacity;});var l=this._scene.getSceneRef();l._vkSetOpacity(undefined,this._jointCollection);}this._selectedNodes.forEach(function(r){this._updateHighlightColor(r);}.bind(this));};k.prototype._onViewActivated=function(c,i,l){var r=this.getViewManager();if(!r||l.source.getId()!==r){return;}this.activateView(l.view,false,l.playViewGroup,l.notAnimateCameraChange);};k.prototype.activateView=function(c,i,l,r){this.fireViewStateApplying({view:c});this.setJoints(undefined);this._customPositionedNodes.clear();this._resetNodesMaterialAndOpacityByCurrenView(c);this._resetTransitionHighlight(c);this._resetNodesStatusByCurrenView(c,true,true);this._highlightPlayer.reset(c,this._scene);this.fireViewStateApplied({view:c,ignoreAnimationPosition:i,notAnimateCameraChange:r,playViewGroup:l});v.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:c,ignoreAnimationPosition:i,notAnimateCameraChange:r,playViewGroup:l});return this;};k.prototype.setHighlightDisplayState=function(s){if(s===g.playing){this._highlightPlayer.start((new Date()).getTime());}else if(s===g.stopped){this._highlightPlayer.stop();}else if(s===g.pausing){this._highlightPlayer.pause((new Date()).getTime());}this.fireHighlightColorChanged({highlightColor:b(d(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};k.prototype._startHighlight=function(){this._highlightPlayer.start((new Date()).getTime());return this;};k.prototype._playHighlight=function(){return this._highlightPlayer.play((new Date()).getTime());};k.prototype._resetTransitionHighlight=function(c){this._transitionHighlightPlayer.reset();this._transitionHighlightPlayer.fadeInNodes=[];this._transitionHighlightPlayer.fadeOutNodes=[];this._transitionHighlightPlayer.setViewStateManager(this);var l=c.getNodeInfos();if(!l){return;}var r=function(x,y,z){if(!x||!x.length){return;}for(var i=0;i<x.length;i++){var A=x[i];if(A.type==="Mesh"&&(!z||(z&&!z.includes(A)))){y.push(A);}r(A.children,y,z);}};var s=[];var u=[];var w=this;l.forEach(function(i){var x=i.target;var y=x.layers.test(w._layers);if(y&&!i.visible){s.push(x);}if(!y&&i.visible){u.push(x);}});r(u,this._transitionHighlightPlayer.fadeInNodes);r(s,this._transitionHighlightPlayer.fadeOutNodes,this._transitionHighlightPlayer.fadeInNodes);};k.prototype._startTransitionHighlight=function(c){var i=this._transitionHighlightPlayer.fadeInNodes;var l=this._transitionHighlightPlayer.fadeOutNodes;if(i&&i.length){var r=new h("FadeIn",{duration:c/500.0,opacities:[0.0,1.0],cycles:1});this._transitionHighlightPlayer.addHighlights(r,i);}if(l&&l.length){var s=new h("FadeOut",{duration:c/500.0,opacities:[1.0,0.0],cycles:1,fadeOut:true});this._transitionHighlightPlayer.addHighlights(s,l);}if((i&&i.length)||(l&&l.length)){this._transitionHighlightPlayer.start((new Date()).getTime());this._transitionHighlightPlayer.play((new Date()).getTime());return c;}else{return 0;}return 0;};k.prototype._playTransitionHighlight=function(){return this._transitionHighlightPlayer.play((new Date()).getTime());};j=function(){this._visibilityChanges=new Set();};j.prototype.getInfo=function(c){var i=[];this._visibilityChanges.forEach(function(l){var r=c.createNodeProxy(l);var s=r.getVeId();c.destroyNodeProxy(r);if(s){i.push(s);}else{i.push(c.getScene().nodeRefToPersistentId(l));}});return i;};j.prototype.clear=function(){this._visibilityChanges.clear();};j.prototype.trackNodeRef=function(c){if(this._visibilityChanges.has(c)){this._visibilityChanges.delete(c);}else{this._visibilityChanges.add(c);}};C.injectMethodsIntoClass(k);return k;});
