/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/core/library","sap/ui/core/Core","sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/assert","sap/base/util/deepEqual"],function(t,e,i,r,a,o,n,s){"use strict";var l=t.smartfield.TextInEditModeSource;var d=r.extend("sap.ui.comp.smartfield.TextArrangementDelegate",{constructor:function(t){r.apply(this,arguments);this.oTextArrangementType=null;this.oFactory=t;this.oSmartField=t._oParent;this.bValidMetadata=false;this.sBindingContextPath="";this.sAbsolutePathToVLProperty="";this._mOneTimeDescriptionCache=new Map;this._sTextArrangementLastReadValue=null;this._mTextArrangementLastReadAdditionalFilters=null}});d.prototype.setValue=function(t,e){var i=this.oSmartField,r=i._oControl;if(this.bValidMetadata&&t!==e&&r){var a=r[r.current],o=a&&a.getBinding("value");if(!o){return}var n=i.isPropertyBeingUpdatedByModel("value");switch(i._getComputedTextInEditModeSource()){case l.NavigationProperty:var s=!!i.getModel().getData(o.getBindings()[1].getPath(),i.getBindingContext(),true);if(n&&!s||!n){a.setValue(t)}return;case l.ValueList:case l.ValueListNoValidation:if(!n){a.setValue(t)}else if(this._sTextArrangementLastReadValue!==t){this.fetchIDAndDescriptionCollectionIfRequired()}return}}};d.getPaths=function(t,e){var i=e.property&&e.property.valueListAnnotation;switch(t){case l.NavigationProperty:var r=e.annotations.text;if(!r){return{}}return{keyField:r.entityType.key.propertyRef[0].name,descriptionField:r.property.typePath,entitySetName:r.entitySet.name};case l.ValueList:if(!i){return{}}return{keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet&&e.property.valueListEntitySet.name};case l.ValueListNoValidation:if(!i){return{}}return{valueListNoValidation:true,keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet.name}}};d.prototype.getBindingInfo=function(t){var e,i=t.valueListNoValidation,r={},a=this.oSmartField,o=this.oFactory,n=o._oMetaData;this.oTextArrangementType=t&&t.type;if(!this.oTextArrangementType){var s=a.getBindingInfo("value");this.oTextArrangementType=s&&s.type||{};var u=d.getPaths(o._bTextInDisplayModeValueList?l.ValueList:a._getComputedTextInEditModeSource(),n);this.oTextArrangementType=o._oTypes.getType(n.property,Object.assign(r,this.oTextArrangementType.oFormatOptions),this.oTextArrangementType.oConstraints,{composite:true,keyField:u.keyField,descriptionField:u.descriptionField,valueListNoValidation:i,valueList:a._getComputedTextInEditModeSource()===l.ValueList,delegate:this})}var p=this.oSmartField.getBinding("value").getValue(),y=a._getComputedTextInEditModeSource(),c=d.getPaths(this.oFactory._bTextInDisplayModeValueList?l.ValueList:y,n);var h=this.getTextAnnotationPropertyPath({entitySet:{name:c.entitySetName},entityID:p});if(h===""||h.indexOf("undefined")!==-1){h="__$$SmartFieldNotExistingBindingPath"}e={model:n.model,type:this.oTextArrangementType,parts:[{path:n.path},{path:h}]};return e};d.prototype.getTextAnnotationPropertyPath=function(t){t=t||{};var e=t.textInEditModeSource||this.oSmartField._getComputedTextInEditModeSource(),i=this.oFactory,r=i._oMetaData;if(i._bTextInDisplayModeValueList){e=l.ValueList}switch(e){case l.NavigationProperty:var a=t.textAnnotation||r.annotations.text;return i._oHelper.getTextAnnotationPropertyPath(a);case l.ValueList:var o=t.edmValueListKeyProperty||r.property.valueListKeyProperty,n=t.bindingContextPath||this.sBindingContextPath;return i._oHelper.getAbsolutePropertyPathToValueListEntity({property:o,bindingContextPath:n,entitySet:t.entitySet,entityID:t.entityID});case l.ValueListNoValidation:var o=t&&t.edmValueListKeyProperty||r.property.valueListKeyProperty,n=t&&t.bindingContextPath||this.sBindingContextPath,a=t&&t.textAnnotation||r&&r.annotations&&r.annotations.text;if(a&&n!=="/undefined"&&this.oSmartField._isValueInitial()){var s=i._oHelper.getTextAnnotationPropertyPath(a);if(s&&s!==this.oFactory.getMetaData().path){return s}}return i._oHelper.getAbsolutePropertyPathToValueListEntity({property:o,bindingContextPath:n,entitySet:t.entitySet,entityID:t.entityID});case l.None:return"";default:return""}};d.prototype.checkRequiredMetadata=function(t,e){var i=this.oFactory,r=i._oMetaData;switch(t){case l.None:return false;case l.NavigationProperty:var a=r.annotations.text,o;if(a){o=a.entityType}var n={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,entityTypeOfNavigationProperty:o,textAnnotation:r.property&&r.property.property&&r.property.property["com.sap.vocabularies.Common.v1.Text"]};if(e){return i._oHelper.checkNavigationPropertyRequiredMetadataNoAsserts(n)}else{return i._oHelper.checkNavigationPropertyRequiredMetadata(n)}case l.ValueList:case l.ValueListNoValidation:var s={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,valueListAnnotation:r.property&&r.property.valueListAnnotation};if(e){return i._oHelper.checkValueListRequiredMetadataForTextArrangmentNoAsserts(s)}else{return i._oHelper.checkValueListRequiredMetadataForTextArrangment(s)}default:return false}};d.prototype.onBeforeValidateValue=function(t,e){var i=this.oSmartField;if(!i.getBindingContext()){return}var r=this.onFetchIDAndDescriptionCollectionSuccess.bind(this,{success:e.success});var a=this.onFetchIDAndDescriptionCollectionError.bind(this,{error:e.error});var o={value:t,success:r,error:a,filterFields:e.filterFields,bCheckValuesValidity:e.bCheckValuesValidity};this.fetchIDAndDescriptionCollection(o);var n=i._oControl.edit;if(n&&t){n.setBusyIndicatorDelay(300);n.setBusy(true)}};d.prototype.fetchIDAndDescriptionCollectionIfRequired=function(t){var e=this.oSmartField;var i=e.getMode();var r=e._getComputedTextInEditModeSource();var a=this.oFactory&&this.oFactory.getMetaData();var o=a&&a.annotations&&a.annotations.text;if(i==="edit"&&a&&a.annotations&&a.annotations.valuelistType==="fixed-values"){return}if(o&&(a&&o.path===a.path||this.sBindingContextPath==="/undefined"||!e._isValueInitial())){o=null}if(r===l.ValueList||!o&&r===l.ValueListNoValidation&&this.oFactory._getDisplayBehaviourConfiguration()!=="idOnly"||this.oFactory._bTextInDisplayModeValueList){var n="value",d=e.getModel(),u=e.getBindingContext(),p=e.getBinding(n).getPath(),y=d&&u&&p&&d.getProperty(p,u),c=y==null||y==="";var h=this.getAdditionalFiltersData(e,e.getControlFactory().getMetaData(),{});var g=this._mTextArrangementLastReadAdditionalFilters&&!s(this._mTextArrangementLastReadAdditionalFilters,h);if(!c&&(g||this._sTextArrangementLastReadValue!==y||!this.oTextArrangementType||t)){var f=["keyField"];var F={value:y,oldValue:y,updateBusyIndicator:false,initialRendering:true,mode:i};this.fetchIDAndDescriptionCollection({value:y,filterFields:f,success:this.onFetchIDAndDescriptionCollectionSuccess.bind(this,F)})}}};d.prototype.fetchIDAndDescriptionCollection=function(t){var e=t.value;if(e==null||e===""){return}if(t.bCheckValuesValidity){t.filterFields=["keyField"]}this.readODataModel(t)};d.prototype.readODataModel=function(t){var e=this.oSmartField,i,r,a,o,n,s=e._getComputedTextInEditModeSource(),u=e.getControlFactory().getMetaData(),p=d.getPaths(this.oFactory._bTextInDisplayModeValueList?l.ValueList:s,u),y="/"+p.entitySetName,c=u&&u.annotations&&u.annotations.valueListData||null,h=p.keyField,g=p.descriptionField,f=this.oFactory&&this.oFactory.getValueListProvider(),F=c&&c.valueListEntitySetName===p.entitySetName,m=F&&c&&c.outParams?Object.values(c.outParams):[],v=F&&c&&c.fields?c.fields:[],P={success:t.success,error:t.error};if(!g&&(this.oSmartField.getMode()==="display"||!e._isValueListValidationMode())){return}this._sTextArrangementLastReadValue=t.value;i=this.getAbsolutePathToVLProperty();if(i){r=this.getSelectedEntity(i);if(r){this.clearAbsolutePathToVLProperty();setTimeout(t.success.bind(this,r));return}}n=this.getDataForNextDescriptionRequest(t.value);if(n&&n.hasOwnProperty(g)&&f&&f._shouldHaveHistory&&!f._shouldHaveHistory()){setTimeout(t.success.bind(this,n));return}o=this.getAdditionalFiltersData(e,u,n);var T={keyFieldPath:h,aFilterFields:t.filterFields};if(g){T.descriptionFieldPath=g}for(a in o){t.filterFields.push(a)}T.additionalFilters=o;var V=this.getFilters(t.value,T);var x=this.getUrlParameters({keyField:h,descriptionField:g,outParams:m,allFields:v});P.filters=V;P.urlParameters=x;this._mTextArrangementLastReadAdditionalFilters=o;e._getTextArrangementRead().read(e.getModel(),y,P).then(t.success).catch(t.error)};d.prototype.getSelectedEntity=function(t){return t!==""&&this.oSmartField.getBindingContext().getProperty(t)};d.prototype.clearAbsolutePathToVLProperty=function(){this.sAbsolutePathToVLProperty=""};d.prototype.setAbsolutePathToVLProperty=function(t){this.sAbsolutePathToVLProperty=t};d.prototype.getAbsolutePathToVLProperty=function(){return this.sAbsolutePathToVLProperty};d.prototype.getAdditionalFiltersData=function(t,e,i){var r,a,o,n,s,l={};if(typeof i==="undefined"){i={}}if(e&&e.annotations&&e.annotations.valueListData){a=e.annotations.valueListData.inParams;r=e.annotations.valueListData.constParams}if(r){for(o in r){l[o]=r[o]}}if(a){for(n in a){s=a[n];if(s!==e.annotations.valueListData.keyField){l[s]=i[s]!==undefined?i[s]:t.getBindingContext().getProperty(n)}}}return l};d.prototype._setBindingPath=function(t,e,i,r){var a=t.getModel(),o=t.getTextInEditModeSource()==="ValueListNoValidation"||t._getComputedTextInEditModeSource()==="ValueListNoValidation",s;n(Array.isArray(e)," - "+this.getMetadata().getName());if(a){if(Array.isArray(e)&&e.length===1){s=a.getKey(e[0])}if(o&&e.length!==1){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,true)}else if(typeof s==="string"){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,false,o)}}};d.prototype.onFetchIDAndDescriptionCollectionSuccess=function(t,e,i){var r,a,o,n,s,d,u,p=this.oSmartField;t=Object.assign({updateBusyIndicator:true},t);if(!p){return}o=t.mode||p.getMode();r=e&&Array.isArray(e.results)&&e.results.length===1?e.results[0]:null;a=p&&p.getControlFactory()&&p.getControlFactory().getValueListProvider()||null;n=p._oControl.edit;s=n&&n.getBinding("value");d=p._oControl.display;u=e&&e.results===undefined?[e]:e.results;if(r&&a){a._calculateAndSetODataModelOutputData(r);if(o==="edit"&&!t.initialRendering&&p._getComputedTextInEditModeSource()!==l.NavigationProperty){a._oHistoryValuesProvider&&a._oHistoryValuesProvider.setFieldData([r])}}if(!t.initialRendering){p.oValidation.handleValueListWarning(u)}if(n&&t.updateBusyIndicator){n.setBusyIndicatorDelay(0);n.setBusy(false)}if(typeof t.success==="function"){t.success(u)}if((o==="display"||o==="display_uom")&&t.initialRendering){this._setBindingPath(p,u,"text",d)}if(s&&o==="edit"&&p.isTextInEditModeSourceNotNone()){this._setBindingPath(p,u,"value",n)}};d.prototype.onFetchIDAndDescriptionCollectionError=function(t,e){var i=this.oSmartField._oControl.edit;if(i){i.setBusyIndicatorDelay(0);i.setBusy(false)}if(typeof t.error==="function"){t.error(e)}};d.prototype.bindPropertyForValueList=function(t,e,i,r){var a=this.oSmartField,o={},n,s,d,u=a._getComputedTextInEditModeSource();if(u===l.ValueList||u===l.ValueListNoValidation||this.oFactory._bTextInDisplayModeValueList){s=e&&e.getBinding(t);if(this.oFactory&&s){d=s.getType();if((!d||!d.isA("sap.ui.comp.smartfield.type.TextArrangement"))&&this.oFactory._getTextArrangementType){n=this.oFactory._getTextArrangementType();if(n){d=n}}if(d){o={type:d}}o.skipValidation=i;o.bValueListNoValidation=r;e.bindProperty(t,this.getBindingInfo(o))}}};d.prototype.getUrlParameters=function(t){var e=[t.keyField];if(t.descriptionField){e.push(t.descriptionField)}t.outParams.forEach(function(t){if(e.indexOf(t)===-1){e.push(t)}});if(this.oSmartField._getComputedTextInEditModeSource()!==l.NavigationProperty){e=t.allFields.map(function(t){return t.name})}return{$select:e.join(","),$top:2}};d.prototype.getFilters=function(t,e){this.destroyFilters();var i=e.aFilterFields,r;if(i.length===1){switch(i[0]){case"keyField":this.oIDFilter=u(t,e);return[this.oIDFilter];case"descriptionField":this.oDescriptionFilter=p(t,e);return[this.oDescriptionFilter]}}this.oIDFilter=u(t,e);r=this._getAdditionalFilters(e);this.oFilters=new a({and:true,filters:[new a({and:false,filters:[this.oIDFilter]})]});if(r.aFilters.length>0){this.oFilters.aFilters.push(r)}return[this.oFilters]};d.prototype.setDataForNextDescriptionRequest=function(t,e){this._mOneTimeDescriptionCache.set(t,e)};d.prototype.getDataForNextDescriptionRequest=function(t){var e=this._mOneTimeDescriptionCache.get(t);this._mOneTimeDescriptionCache.delete(t);return e};function u(t,e){return new a({value1:t,path:e.keyFieldPath,operator:o.EQ})}function p(t,e){return new a({value1:t,path:e.descriptionFieldPath,operator:o.Contains})}d.prototype._getAdditionalFilters=function(t){var e=[],i=this.oSmartField.getControlFactory().getMetaData(),r=i.annotations&&i.annotations.valueListData,o=r&&r.fields;Object.keys(t.additionalFilters).forEach(function(i){var a=t.additionalFilters[i],n=o.find(function(t){return t.name===i}),s=r.aInitialValueIsSignificantFields.indexOf(i)!==-1,l=this._generateFiltersForField(a,i,n,s);if(l){e.push(l)}}.bind(this));return new a({and:true,filters:e})};d.prototype._generateFiltersForField=function(t,e,i,r){if(t===null||t===undefined||t===""){if(r){return this._generateFiltersForEmptyField(e,i&&i.nullable==="false")}}else{return new a({value1:t,path:e,operator:o.EQ})}};d.prototype._generateFiltersForEmptyField=function(t,e){if(e){return new a({value1:"",path:t,operator:o.EQ})}return new a([new a({value1:"",path:t,operator:o.EQ}),new a({value1:null,path:t,operator:o.EQ})],false)};d.prototype.destroyFilters=function(){if(this.oIDFilter){this.oIDFilter.destroy();this.oIDFilter=null}if(this.oDescriptionFilter){this.oDescriptionFilter.destroy();this.oDescriptionFilter=null}if(this.oFilters){this.oFilters.destroy();this.oFilters=null}};d.prototype.destroy=function(){this.oSmartField=null;this.bValidMetadata=false;this.sBindingContextPath="";this.sAbsolutePathToVLProperty="";this._mOneTimeDescriptionCache=null;this._mTextArrangementLastReadAdditionalFilters=null;this.destroyFilters()};return d});
//# sourceMappingURL=TextArrangementDelegate.js.map