/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.loader.config({shim:{"sap/ndc/thirdparty/ZXing":{amd:true,exports:"ZXing"}}});sap.ui.define(["sap/base/Log","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/m/Input","sap/m/Label","sap/m/Button","sap/m/Dialog","sap/ui/dom/includeStylesheet","./BarcodeScannerUIContainer","sap/m/MessageToast","sap/m/library","sap/ui/base/Event","sap/ui/base/EventProvider","sap/ui/Device"],function(e,t,n,o,a,i,r,s,l,d,c,f,u,p){"use strict";document.addEventListener("settingsDone",H);document.addEventListener("SettingCompleted",H);document.addEventListener("mockSettingsDone",H);s({url:sap.ui.require.toUrl("sap/ndc/css/sapNdcBarcodeScanner.css")});var g={},v,y,S,b=new t({available:false}),m=null,h={},E="",B={audio:false,video:{facingMode:"environment"}},w,C,R,D,P,A,x=null,M,_,I,O=0,L=0,N=false,T=true,Z=new n({bundleName:"sap.ndc.messagebundle"});function F(){try{v=cordova.plugins.barcodeScanner;if(v){e.debug("Cordova BarcodeScanner plugin is available!")}else{e.error("BarcodeScanner: cordova.plugins.barcodeScanner is not available");U()}}catch(t){e.info("BarcodeScanner: cordova.plugins is not available");U()}}function U(){sap.ui.require(["sap/ndc/thirdparty/ZXing"],function(t){S=t;if(S){y=new S.BrowserMultiFormatReader;if(y){e.debug("ZXing BrowserMultiFormatReader API is available!")}else{b.setProperty("/available",false);e.error("BarcodeScanner: ZXing BrowserMultiFormatReader API is not available")}}else{b.setProperty("/available",false);e.error("BarcodeScanner: Scanner API is not available")}},function(t){b.setProperty("/available",false);e.error("BarcodeScanner: ZXing is not available")})}function z(){return!!(window&&window.navigator&&window.navigator.mediaDevices&&window.navigator.mediaDevices.getUserMedia)}function G(){try{if(self!=top&&typeof cordova==="undefined"){window.cordova=top.cordova}}catch(t){e.info("BarcodeScanner: cordova is not available in cross-origin iframe")}}function k(){try{if(self!=top&&(typeof EB==="undefined"||typeof Rho==="undefined")){if(typeof top.EB!=="undefined"||typeof top.Rho!=="undefined"){window.EB=top.EB;window.Rho=top.Rho}}}catch(t){e.info("BarcodeScanner: EB and Rho are not available in cross-origin iframe")}if(g.getScanAPIInfo()==="ZebraEnterpriseBrowser"){EB.Barcode.disable()}}function H(){G();v=null;y=null;S=null;k();D=null;P=null;b.setProperty("/available",true);if(sap.Settings===undefined){e.debug("No sap.Settings. No feature vector available.");F()}else if(sap.Settings&&typeof sap.Settings.isFeatureEnabled==="function"){sap.Settings.isFeatureEnabled("cordova.plugins.barcodeScanner",function(t){if(t){F()}else{b.setProperty("/available",false);e.warning("BarcodeScanner: Feature disabled")}},function(){e.warning("BarcodeScanner: Feature check failed")})}else{e.warning("BarcodeScanner: Feature vector (sap.Settings.isFeatureEnabled) is not available")}}function W(t){if(t){e.warning("isNoScanner. Message: "+t)}K();m.destroyContent();m.setTitle("");m.setStretch(false);m.setContentHeight("auto");m.removeStyleClass("sapUiNoContentPadding");m.setTitle(E);var n=new a(m.getId()+"-txt_barcode",{text:"{i18n>BARCODE_DIALOG_MSG}",visible:"{/isNoScanner}"});m.addContent(n);var r=new o(m.getId()+"-inp_barcode",{value:"{/barcode}",valueLiveUpdate:true,ariaLabelledBy:n.getId(),liveChange:function(e){if(typeof h.onLiveUpdate==="function"){h.onLiveUpdate({newValue:e.getParameter("newValue")})}},placeholder:"{i18n>BARCODE_DIALOG_PLACEHOLDER}"});m.addContent(r);var s=c.ButtonType;m.setBeginButton(new i(m.getId()+"-btn_barcode_ok",{type:s.Emphasized,text:"{i18n>BARCODE_DIALOG_OK}",press:function(e){g.closeScanDialog();if(typeof h.onSuccess==="function"){h.onSuccess({text:m.getModel().getProperty("/barcode"),cancelled:false})}}}));m.setEndButton(new i({text:"{i18n>BARCODE_DIALOG_CANCEL}",press:function(){g.closeScanDialog()}}));m.setBusy(false);m.open()}function X(){if(window.navigator.mediaDevices.getUserMedia){if(w){B.video.facingMode="user"}else{B.video.facingMode="environment"}if(B.video.frameRate!==undefined){delete B.video.frameRate}window.navigator.mediaDevices.getUserMedia(B).then(function(e){if(y){if(p.os.ios&&p.os.versionStr.split(".")[0]==="16"){var t=e.getTracks();t[0].stop()}J()}else{m.getModel().setProperty("/isNoScanner",true);W()}}).catch(function(){m.getModel().setProperty("/isNoScanner",true);W()})}else{m.getModel().setProperty("/isNoScanner",true);W()}}function j(e,n,o,a){var s;h.onSuccess=e;h.onFail=n;h.onLiveUpdate=o;if(!m||m&&m.getContent().length===0){s=new t;m=new r("sapNdcBarcodeScannerDialog",{icon:"sap-icon://bar-code",title:Z.getProperty("BARCODE_DIALOG_SCANNING_TITLE"),stretch:true,horizontalScrolling:false,verticalScrolling:false,endButton:new i({text:"{i18n>BARCODE_DIALOG_CANCEL}",enabled:false,press:function(){K();m.getModel().setProperty("/isNoScanner",false);W()}}),afterClose:function(){K();m.destroyContent();m.destroy();m=null}});m.setEscapeHandler(function(t){g.closeScanDialog();if(typeof e==="function"){e({text:s.getProperty("/barcode"),cancelled:true})}t.resolve()});m.setModel(s);m.setModel(Z,"i18n")}if(typeof a==="string"&&a!=null&&a.trim()!=""){E=a}else{E=Z.getProperty("BARCODE_DIALOG_TITLE")}if(!v&&z()){X()}else{if(b.getProperty("/available")){m.getModel().setProperty("/isNoScanner",false)}else{m.getModel().setProperty("/isNoScanner",true)}W()}return m}function J(){m.attachAfterOpen(function(){m.getEndButton().setEnabled(true);m.setBusy(false);if(!I){I=x?x.getDomRef("highlight"):undefined}if(!M){M=x?x.getDomRef("video"):undefined}if(typeof C==="number"&&C>0){B.video.frameRate=C}else if(typeof C!=="undefined"){d.show(Z.getResourceBundle().getText("BARCODE_DIALOG_CAMERA_UPDATE_PARAMETER_ERROR_MSG","frameRate"),{duration:1e3})}y.decodeFromConstraints(B,x.getId()+"-video",function(t,n){V();if(t){var o,a,i;var r=0,s=0,l=0,d=0,c;if(I&&!N){I.innerHTML="";N=true}if(I){a=M.clientWidth/M.videoWidth;i=M.clientHeight/M.videoHeight;if(t.resultPoints){l=t.resultPoints[0].y;d=t.resultPoints[0].x;s=t.resultPoints[0].x;r=t.resultPoints[0].y;for(c=0;c<t.resultPoints.length;c++){o=t.resultPoints[c];if(o.x<d&&o.x<s){d=o.x}else if(o.x>d&&o.x>s){s=o.x}if(o.y<l&&o.y<r){l=o.y}else if(o.y>l&&o.y>r){r=o.y}}}I.hidden=false;I.style.top=l*i+"px";I.style.left=d*a+"px";I.style.width=(s-d>0?(s-d+O)*a:5)+"px";I.style.height=(r-l>0?(r-l+L)*i:5)+"px"}if(t.cancelled==="false"||!t.cancelled){t.cancelled=false;if(typeof h.onSuccess==="function"){h.onSuccess(t)}K();g.closeScanDialog()}}else{if(I&&N){I.hidden=true;I.style.top="0";I.style.left="0";I.style.width="0";I.style.height="0"}}if(n&&S&&!(n instanceof S.NotFoundException)){e.warning("Started continuous decode failed.");if(typeof h.onFail==="function"){h.onFail(n);m.getModel().setProperty("/isNoScanner",true);W()}}})});m.destroyContent();I=undefined;_=undefined;M=undefined;x=new l;m.addContent(x);m.setContentWidth("100%");m.setContentHeight("100%");m.addStyleClass("sapUiNoContentPadding");m.setBusy(true);m.open();N=false}function V(){var e=.15;if(!M||!M.videoHeight||!M.videoWidth){return}if(!_&&x){_=x.getDomRef("overlay")}q();if(_){var t=M.clientWidth*(1-2*e);var n=M.clientHeight*(1-2*e);if(t<=n){n=t*(1-2*e)}var o=x.getDomRef("overlay-box");o.style.width=t+"px";o.style.height=n+"px";_.style.width=t+"px";_.style.height=n+"px";_.style.borderWidth=(M.clientHeight-n)/2+"px "+(M.clientWidth-t)/2+"px"}}function q(){if(R!=="skipUpdateZoom"&&M){var t=M.srcObject.getVideoTracks();var n=window.navigator.mediaDevices.getSupportedConstraints();var o=t[0].getCapabilities();if(n.zoom&&o&&o.zoom){e.debug("Support zoom to update");if(typeof R==="undefined"||R===null){R=o.zoom.min}}else{e.debug("Don't support zoom or getCapabilities() failed.");R="skipUpdateZoom";return}try{t[0].applyConstraints({advanced:[{zoom:R}]}).then(function(){R="skipUpdateZoom";e.debug("The zoom is updated successfully.")}).catch(function(t){if(t&&t.message&&t.message.match(/out of range|Failed to read the 'zoom' property/i)){R="skipUpdateZoom";d.show(Z.getResourceBundle().getText("BARCODE_DIALOG_CAMERA_UPDATE_PARAMETER_ERROR_MSG","zoom"),{duration:1e3})}else{e.error("Update zoom failed. Error Message:"+t)}})}catch(t){e.error("applyConstraints() failed. Error Message:"+t);R="skipUpdateZoom"}var a=t[0].getSettings();e.debug("frameRate is "+a.frameRate+". zoom is "+a.zoom)}}function K(){if(y){y.reset();y.stopContinuousDecode();y.reader.reset()}}function Q(){var t=function(t){if(t["data"]==""||t["time"]==""){if(typeof D==="function"){var n={text:"Zebra Scan failed",resultStatus:"Error"};if(A){n=new f("scanFailEvent",new u,{text:"Zebra Scan failed",resultStatus:"Error"})}D(n)}e.error("Zebra Enterprise Browser Scan Failed")}else{e.debug("Zebra EB Scan Result: "+t.data+"; Scan Json: "+JSON.stringify(t));if(typeof P==="function"){var o={text:t.data,format:t.source,resultStatus:"Success",cancelled:false};if(A){o=new f("scanSuccessEvent",new u,{text:t.data,format:t.source,resultStatus:"Success",cancelled:false})}P(o)}}};EB.Barcode.enable({},t)}function Y(e){var t=false;if(g.getScanAPIInfo()==="ZebraEnterpriseBrowser"&&(!e||typeof e!=="boolean")){t=true}return t}g.scan=function(t,n,o,a,i,r,s,l){if(!T){e.error("Barcode scanning is already in progress.");return}T=false;w=i;C=r;R=s;if(b.getProperty("/available")==true&&v==null&&y==null){F()}if(Y(l)){T=true;A=false;if(typeof P==="function"&&typeof D==="function"){P=t;D=n}else{P=t;D=n;Q()}EB.Barcode.triggerType=EB.Barcode.SOFT_ONCE;EB.Barcode.start()}else if(v){var d;if(w){d={preferFrontCamera:true}}v.scan(function(e){if(e.cancelled==="false"||!e.cancelled){e.cancelled=false;if(typeof t==="function"){t(e)}}else{j(t,n,o,a)}T=true},function(t){e.error("Barcode scanning failed.");T=true;if(typeof n==="function"){if(typeof t==="string"){var o=t;t={text:o};e.debug("Change the type of oEvent from string to object")}n(t)}},d)}else{j(t,n,o,a)}};g.closeScanDialog=function(){if(m){m.close()}T=true};g.getStatusModel=function(){return b};g.getScanAPIInfo=function(){var e="unknown";if(typeof EB!=="undefined"&&typeof EB.Barcode!=="undefined"){e="ZebraEnterpriseBrowser"}else if(v){e="Cordova"}else if(y){e="ZXing"}return e};g.setPhysicalScan=function(e){if(g.getScanAPIInfo()==="ZebraEnterpriseBrowser"&&typeof e==="function"){A=true;document.addEventListener("visibilitychange",function(){if(document.visibilityState==="visible"){k();Q()}});if(typeof P==="function"&&typeof D==="function"){P=e;D=e}else{P=e;D=e;Q()}}};H();return g},true);
//# sourceMappingURL=BarcodeScanner.js.map