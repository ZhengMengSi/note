/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","../utils/MetadataAnalyser","../utils/SelectionVariantHelper","sap/fe/navigation/SelectionVariant","sap/m/Token","../utils/oDataModelProvider","sap/ui/core/CustomData","sap/m/DynamicDateUtil","sap/ui/comp/util/DateTimeUtil","sap/ui/core/format/DateFormat","../utils/AppConstants","../utils/UrlGenerateHelper","sap/ui/core/IconPool"],function(e,t,a,r,i,n,o,s,l,g,d,u,c,f){"use strict";var p="smartForm";var h="copyCardSmartForm";return e.extend("sap.insights.base.BaseController",{constructor:function(){this._oParentViewModel=new t({oCard:{}});this.oSmartFormMap={};this.oDraftCardParams={};this.bEnableCardEdit=true},_createOdataModelsforDialog:function(e){var t=[];e.forEach(function(e){t.push(o.getOdataModel(e.descriptorContent["sap.app"].dataSources))});if(t.length){return Promise.all(t)}},setFilterTextForNoData:function(e,t,a){sap.ui.getCore().loadLibrary("sap.ui.comp",{async:true}).then(function(){sap.ui.require(["sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout","sap/m/Text"],function(r,i,n,o){e.removeAllGroups();var s=new r;var l=new i;var g=new o({text:t?this.i18Bundle.getText("noFilterMsg"):this.i18Bundle.getText("noFilterLoaded")});l.addElement(g);s.addGroupElement(l);e.setLayout(new n);e.addGroup(s);if(a){e.getAggregation("content").getLayout().setBackgroundDesign("Transparent")}}.bind(this))}.bind(this))},_setSmartFormForCardEdit:function(e){this._oParentViewModel.setProperty("/oCard",e);var t=e.descriptorContent["sap.app"].id,a=this.oSmartFormMap[t]&&!this.smartFormEditable?Promise.resolve(this.oSmartFormMap[t]):this._createSmartFormForCardEdit(e,this.smartFormEditable);a.then(function(t){if(this.smartFormEditable){t.setEditable(true)}var a=this.byId(p)||this.byId(h);a.removeAllItems();var r=e.descriptorContent["sap.app"].dataSources;o.getOdataModel(r).then(function(e){var r=e&&e.loaded;var i=false;if(t.getGroups()&&t.getGroups().length&&t.getGroups()[0].getGroupElements()){i=t.getGroups()[0].getGroupElements().some(function(e){return e.getElements().some(function(e){return e.getVisible()})})}if(t.getAggregation("content").getFormContainers().length&&r&&i){t.setVisible(true);setTimeout(function(){var e=t.getAggregation("content").getLayout();if(e){e.setBackgroundDesign("Transparent")}a.addItem(t)},0)}else{this.setFilterTextForNoData(t,r,true);a.addItem(t)}}.bind(this))}.bind(this))},_createSmartFormForCardEdit:function(e){return new Promise(function(t){sap.ui.getCore().loadLibraries(["sap.ui.comp","sap.m"],{async:true}).then(function(){sap.ui.require(["sap/ui/comp/smartmultiinput/SmartMultiInput","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout","sap/m/Title","sap/m/Toolbar"],function(l,g,d,u,f,p,h){var v=e.descriptorContent;var m=v["sap.card"].configuration.parameters;var y=v["sap.insights"].filterEntitySet;var S=m&&m._entitySet.value;var C=v["sap.app"].dataSources;o.getOdataModel(C).then(function(o){var C=o&&o.loaded;this._oParentViewModel.setProperty("/oCard",e);var T={layout:new f({labelSpanS:6}),customToolbar:new h({content:[new p({text:this.i18Bundle.getText("filterBy"),titleStyle:"H5"})],style:"Clear"})};var b=new g(T);var E=new d;var P=[],D=[],_=[],F=[],I,k,O=[];if(m){P=m._mandatoryODataParameters.value||[];D=m._mandatoryODataFilters.value||[];_=m._relevantODataParameters.value||[];F=m._relevantODataFilters.value||[];k=m._semanticDateRangeSetting;if(k){I=JSON.parse(k.value);O=Object.keys(I)||[]}}b.attachEditToggled(function(e){var t=e.getParameters().editable;var a=e.getSource().getGroups()&&e.getSource().getGroups().length?e.getSource().getGroups()[0]:null;if(t&&a){a.getGroupElements().forEach(function(e){e.getFields().forEach(function(e){e.attachInnerControlsCreated(function(e){var t=e.getSource(),a=t.getBindingPath("value");if((P.includes(a)||D.includes(a))&&t.getProperty("editable")){t.setMandatory(true)}else if(t.getMandatory()){t.setMandatory(false)}t.checkClientError()})})})}});var V=function(e,t){if(t){var a=new s({key:"date",value:t});e.insertCustomData(a)}};var x=o&&a.getParameterisedEntitySetByEntitySet(o.oData,y);var M=x?a.getPropertyNamesOfEntitySet(o.oData,x):[];if(C){if(_.length){_.forEach(function(e){var t=x;var r=true;if(M.indexOf(e)===-1){t=S;r=false}var i=a.isValueListWithFixedValues(o.oData,t,e);var s=a.isDate(o.oData,t,e);var g=O.includes(e);var d=new u;var f=new l({entitySet:t,value:"{"+e+"}",editable:r,visible:r,singleTokenMode:true,supportRanges:false,innerControlsCreated:this._handleVisibilityChange.bind(this,g,true)});if(i){f.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var a=t.getInnerControls();if(Array.isArray(a)&&a.length){var r=t.getAggregation("_initialTokens");if(t.getSingleTokenMode()){var i=a[0],n=Array.isArray(r)&&r.length?r[0]:null;if(i.setForceSelection){i.setForceSelection(false);if(n){i.setSelectedKey(n.getKey())}else{i.setSelectedItem(null)}}}else{var o=a[0];if(Array.isArray(r)&&r.length){o.setSelectedKeys(r.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});f.checkClientError=function(){return this._checkClientError(f)}.bind(this);f.attachSelectionChange(this._handleParameterSelectionChange.bind(this))}else{f.attachTokenUpdate(this._handleParameterTokenUpdate.bind(this,null,g))}var p=m[e].value;var h=m[e].label;if(p){var v=new n({key:p,text:h?h:p});if(s){if(!O.includes(e)){V(v,new Date(p))}else{if(I&&this.smartFormEditable){var y=this._getOptionsForDynamicDate(I,e);var C=this.byId("hiddenDDR");C.setOptions(y)}p=c.formatSemanticDateTime(p,"Parameter")[0];V(v,p)}}if(i&&f.getInnerControls().length){var T=f.getInnerControls()[0];T.setSelectedKey(v.getKey())}f.addAggregation("_initialTokens",v)}if(p&&f.getVisible()){d.addElement(f);E.addGroupElement(d)}else if(this.bEnableCardEdit&&f.getVisible()){d.addElement(f);E.addGroupElement(d)}this._attachInitialiseToGroupElement(d)}.bind(this))}var A=a.getPropertyNamesOfEntitySet(o.oData,y);F.forEach(function(e){var t=e;if(!(t==="DisplayCurrency"&&_.indexOf("P_DisplayCurrency")>-1)){var n=y;var s=true;if(A.indexOf(t)===-1){var g="P_"+t;if(M.indexOf(g)>-1){n=x;t=g}else{n=S;s=false}}var d=a.isValueListWithFixedValues(o.oData,n,t);var f=a.isDate(o.oData,n,t);var p=O.includes(t);var h=new u;var v;if(t.indexOf("P_")===0){v=true}else{v=a.getPropertyFilterRestrictionByEntitySet(o.oData,n,t)}var C=new l({entitySet:n,value:"{"+t+"}",editable:s,visible:s,supportRanges:!v,singleTokenMode:v,innerControlsCreated:this._handleVisibilityChange.bind(this,p,false)});if(d){C.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var a=t.getInnerControls();if(Array.isArray(a)&&a.length){var r=t.getAggregation("_initialTokens");if(t.getSingleTokenMode()){var i=a[0],n=Array.isArray(r)&&r.length?r[0]:null;if(i.setForceSelection){i.setForceSelection(false);if(n){i.setSelectedKey(n.getKey())}else{i.setSelectedItem(null)}}}else{var o=a[0];if(Array.isArray(r)&&r.length){o.setSelectedKeys(r.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});C.checkClientError=function(){return this._checkClientError(C)}.bind(this);C.attachSelectionChange(this._handleFilterSelectionChange.bind(this))}else{if(p){C.setSingleTokenMode(true)}C.attachTokenUpdate(this._handleFilterTokenUpdate.bind(this,null,p))}var T=new i(m[e].value);var b=T.getSelectOption(e);if(b&&b.length){var P=[],D=[];P=r.getTokenFromSelectOptions(b,e);P.forEach(function(t,a){if(f){if(!O.includes(e)){V(t,new Date(t.getKey()))}else{if(I&&this.smartFormEditable){var r=this._getOptionsForDynamicDate(I,e);var i=this.byId("hiddenFilterDDR");i.setOptions(r)}D=c.formatSemanticDateTime(null,b[a],"Filter");D=c.formatSemanticDateTime(b[a],"Filter");D.forEach(function(e){V(t,e)})}}if(d&&C.getInnerControls().length){var n=C.getInnerControls()[0];n.setSelectedKey(t.getKey())}C.addAggregation("_initialTokens",t)}.bind(this));h.addElement(C);E.addGroupElement(h)}else if(this.bEnableCardEdit){h.addElement(C);E.addGroupElement(h)}this._attachInitialiseToGroupElement(h)}}.bind(this))}if(E.getAggregation("formElements")&&E.getAggregation("formElements").length){b.addGroup(E)}var w=v["sap.app"].id;if(C){b.setModel(o.oData)}this.oSmartFormMap[w]=b;t(b)}.bind(this))}.bind(this))}.bind(this))}.bind(this))},_handleVisibilityChange:function(e,t,a){var r=a.getSource();var i=this.byId(p);var n=i&&i.getItems()[0];var o=false;if(e&&r.getMode()==="edit"){var s=r.getInnerControls();if(s.length){var l=s[0];r.setShowValueHelp(false);r.setShowSuggestion(false);l.addEndIcon({src:f.getIconURI("check-availability"),press:t?this._handleParameterTokenUpdate.bind(this,r,true):this._handleFilterTokenUpdate.bind(this,r,true)})}}setTimeout(function(){if(n){var e=n.getGroups()&&n.getGroups().length?n.getGroups()[0]:null;var t=e&&e.getGroupElements();if(t&&t.length){t.forEach(function(t){var a=t.getFields();a.forEach(function(e){if(!this.smartFormEditable&&e.getId()===r.getId()&&(e.getTokens&&e.getTokens().length===0)){t.removeField(e)}if(t.getVisible()&&e.getTokens&&e.getTokens().length){o=true}}.bind(this));if(!t.getFields().length){e.removeGroupElement(t)}}.bind(this))}}if(!o&&i){i.removeAllItems();this.setFilterTextForNoData(n,true,false);i.addItem(n)}}.bind(this),0)},_handleFilterTokenUpdate:function(e,t,n){var o=e?e:n.getSource();if(o.getMandatory()){o.checkClientError()}var s=o.getBinding("value").sPath;var l=o.getTokens();var g=this._oParentViewModel.getProperty("/oCard");var d=g.descriptorContent["sap.app"].id;var u=o.getModel();var c=a.isDate(u,o.getEntitySet(),s);var f;if(t&&e){f=this.byId("hiddenFilterDDR");f.attachChange(this._onSemanticFilterDateChange.bind(this,s,o));f.openBy(e.getDomRef())}else if(l.length){var p=new i;var h=[];var v="";l.forEach(function(e){v="";if(e.data("selectOption")){var t=e.data("selectOption");if(!t.Text){t.Text=e.getText?e.getText():null}h.push(t)}else if(e.data("range")){var a=e.data("range");var i=r.getSelectOptionFromRange(a,e.getText());h.push(i)}else if(c){var n=u.formatValue(e.getKey(),"Edm.DateTime");p.addSelectOption(s,"I","EQ",n,null,n)}else if(o._parseValue){var l=o._parseValue(e.getKey());v=e.getText()?e.getText():e.getKey();p.addSelectOption(s,"I","EQ",l,null,v)}else{v=e.getText()?e.getText():e.getKey();p.addSelectOption(s,"I","EQ",e.getKey(),null,v)}});p.massAddSelectOption(s,h);this.oDraftCardParams[d][s]=p.toJSONString()}else{this.oDraftCardParams[d][s]=r.getEmptySVStringforProperty(s)}},getLabelForField:function(e,t,a){if(e&&t){var r=this.byId("hiddenFilterDDR");var i=r.getIdForLabel()||"";i=i.substring(0,i.lastIndexOf("-"));if(i){var n=sap.ui.getCore().byId(i);return n&&n.getValue()}else if(r&&r.getProperty("value")){return r.getProperty("value")}else if(a&&typeof a.getTokens==="function"){var o=a.getTokens()||[],s=o.map(function(e){return e.getText()});return{type:"filters",value:s}}}},_handleFilterSelectionChange:function(e){var t=e.getParameters();var a=e.getSource().getBinding("value").getPath();var o=this._oParentViewModel.getProperty("/oCard");var s=o.descriptorContent["sap.app"].id;var l=e.getSource();var g=new i;var d="";if(t.selectedItem){l.setValueState("None");var u=e.getParameter("selectedItem");if(u){d=u.getText()?u.getText():u.getKey();l.removeAllAggregation("_initialTokens");l.addAggregation("_initialTokens",new n({key:u.getKey(),text:d}));g.addSelectOption(a,"I","EQ",u.getKey(),null,d);this.oDraftCardParams[s][a]=g.toJSONString()}else{this.oDraftCardParams[s][a]=r.getEmptySVStringforProperty(a)}}else{var c=e.getSource().getInnerControls()[0].getSelectedItems();if(c.length){l.setValueState("None");l.removeAllAggregation("_initialTokens");c.forEach(function(e){d=e.getText()?e.getText():e.getKey();l.addAggregation("_initialTokens",new n({key:e.getKey(),text:d}));g.addSelectOption(a,"I","EQ",e.getKey(),null,d)});this.oDraftCardParams[s][a]=g.toJSONString()}else{this.oDraftCardParams[s][a]=r.getEmptySVStringforProperty(a)}}},_handleParameterSelectionChange:function(e){var t=e.getParameter("selectedItem");var a=e.getSource(),r="";var i={value:"",label:""};if(t){a.setValueState("None");r=t.getText()?t.getText():t.getKey();i.value=t.getKey();i.label=r}a.removeAllAggregation("_initialTokens");a.addAggregation("_initialTokens",new n({key:i.value,text:i.label}));var o=e.getSource().getBinding("value").getPath();var s=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.app"].id;this.oDraftCardParams[s][o]=i},_handleParameterTokenUpdate:function(e,t,r){var i=e?e:r.getSource();if(i.getMandatory()){i.checkClientError()}var n=i.getBinding("value").sPath;var o=i.getTokens();var s=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.app"].id;var l={value:"",label:""};var g=i.getModel();var d=a.isDate(g,i.getEntitySet(),n);var u,f;if(t&&e){f=this.byId("hiddenDDR");f.attachChange(this._onSemanticParameterDateChange.bind(this,n,i));f.openBy(e.getDomRef())}if(o.length){l.label=o[0].getText()?o[0].getText():o[0].getKey();if(f&&f._parseValue){u=f._parseValue(o[0].getKey());if(u){f.setValue(u);l.value=c.getDateRangeValue(u,true);l.label=u}else{l.value=o[0].getKey()}}else{u=i._parseValue&&i._parseValue(o[0].getKey());if(d&&u){u=i.getModel().formatValue(u,i.getDataType());l.value=u}else if(u){l.value=u}else{u=o[0].getKey();l.value=u}}}this.oDraftCardParams[s][n]=l},_mergeDraftParamsIncard:function(e){var t=e.descriptorContent["sap.card"].configuration.parameters;var a=e.descriptorContent["sap.app"].id;var r=this.oDraftCardParams[a];Object.keys(r).forEach(function(e){if(t[e]){if(t[e].type==="datetime"&&typeof t[e].value==="string"&&t[e].value.includes("operation")){var a=JSON.parse(t[e].value);a.operation=r[e];t[e].value=JSON.stringify(a)}else{t[e].value=r[e].value?r[e].value:r[e];if(r[e].label){t[e].label=r[e].label}}}else if(e.indexOf("P_")===0&&t[e.replace("P_","")]){r[e.replace("P_","")]=r[e].replace("P_","");t[e.replace("P_","")].value=r[e].replace("P_","");delete r[e]}});c.processPrivateParams(e,r);Object.keys(t).forEach(function(e){var a=t[e].value;if(t[e].type==="datetime"&&typeof a==="string"&&a.includes("datetime")){a=a.split("datetime");a=a[a.length-1];a=a.replace(/["']/g,"");t[e].value=a}});return e},_checkClientError:function(e){var t=e.getSingleTokenMode()?!e.getInnerControls()[0].getSelectedKey():!e.getInnerControls()[0].getSelectedKeys().length,a=e.getMandatory()&&t;e.setValueState(a?"Error":"None");return a},_attachInitialiseToGroupElement:function(e){if(e.getFields()&&e.getFields().length){e.getFields()[0].attachInitialise(function(){if(e.getFields().length&&e.getLabelControl()&&!e.getLabelControl().getText()){var t=e.getFields()[0].getBindingPath("value");if(t&&e.getFields()[0].getVisible()){e.getFields()[0].setTextLabel(t)}}})}},_onSemanticParameterDateChange:function(e,t,a){var r=a.getParameter("value");var i=this._oParentViewModel.getProperty("/oCard");var o=i.descriptorContent["sap.app"].id;this.oDraftCardParams[o][e].value=r.operator;this.oDraftCardParams[o][e].label=r.operator;t.getInnerControls()[0].setTokens([]);var s=r.operator==="DATE";var l=new n({key:s?r.values[0]:r.operator,text:s?r.values[0]:r.operator});t.getInnerControls()[0].setTokens([l]);var g=a.getParameter("valid");t.setValueState(g?"None":"Error")},_onSemanticFilterDateChange:function(e,t,a){var n=a.getParameter("value");var o=this.getLabelForField(e,n,t);var s=c.getDateRangeValue(n,false,o);var l=this._oParentViewModel.getProperty("/oCard");var g=l.descriptorContent["sap.app"].id;var d=new i;if(!s.High){s.High=""}d.addSelectOption(e,"I",s.Option,s.Low,s.High,s.Text);this.oDraftCardParams[g][e]=d.toJSONString();t.getInnerControls()[0].setTokens([]);var u=r.getTokenFromSelectOptions(d.getSelectOption(e),e);t.getInnerControls()[0].setTokens(u);var f=a.getParameter("valid");t.setValueState(f?"None":"Error")},_getOptionsForDynamicDate:function(e,t){var a;if(e[t]["sap:filter-restriction"]==="single-value"){a=u.DATE_OPTIONS.SINGLE_OPTIONS}else if(e[t]["sap:filter-restriction"]==="interval"){a=u.DATE_OPTIONS.RANGE_OPTIONS;a=a.concat(u.DATE_OPTIONS.SINGLE_OPTIONS)}if(e&&e[t].exclude){a=a.filter(function(a){return!e[t].selectedValues.includes(a)})}return a}})});
//# sourceMappingURL=Base.controller.js.map