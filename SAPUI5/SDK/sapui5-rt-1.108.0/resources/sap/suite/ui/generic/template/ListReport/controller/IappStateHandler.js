sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/suite/ui/generic/template/listTemplates/listUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/Device","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/suite/ui/generic/template/ListReport/controller/LegacyStateHandler","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/js/StableIdHelper"],function(e,t,a,r,n,i,o,s,l,c,p,u,f,d,m,S){"use strict";var g="ListReport.controller.IappStateHandler";var v=new o(g);var y=v.getLogger();var b=v.Level;var D="sap.suite.ui.generic.template.customData",h="sap.suite.ui.generic.template.extensionData",V="sap.suite.ui.generic.template.genericData";function O(e,t){if(sap.ui.support){var a=y.getLevel();if(a<b.INFO){y.setLevel(b.INFO)}}var r;if(typeof t==="string"){r=t}else{r="";var n="";for(var i in t){r=r+n+i+": "+t[i];n="; "}}y.info(e,r,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler")}function C(e,a,o){var m=new d(a);var v;var b=new Promise(function(e){v=e});var C=[];var E=[];var F=a.byId(S.getStableId({type:"ListReportTable",subType:"SmartTable"}));if(F){C.push(o.oCommonUtils.getControlStateWrapper(F))}var P=a.byId(S.getStableId({type:"ListReportAction",subType:"SearchField"}));if(P){C.push(o.oCommonUtils.getControlStateWrapper(P))}var w=e.oMultipleViewsHandler.getGeneralContentStateWrapper();if(w){w.getLocalId=function(){return"$multipleViewsGeneralContent"};C.push(w)}if(a.getOwnerComponent().getSmartVariantManagement()&&!a.getOwnerComponent().getVariantManagementHidden()){E=C;C=[]}var N=e.oMultipleViewsHandler.getSFBVariantContentStateWrapper();if(N){N.getLocalId=function(){return"$multipleViewsSFBVariantContent"};E.push(N)}var I=[];function x(){I.forEach(function(e){e()})}var L={getLocalId:function(){return"$customFilters"},getState:function(){var e={appExtension:Object.create(null),adaptationExtensions:Object.create(null)};if(o.oComponentUtils.isDraftEnabled()){var r=o.oComponentUtils.getTemplatePrivateModel();e.editState=r.getProperty("/listReport/vDraftState")}a.getCustomAppStateDataExtension(e.appExtension);var n=true;var i=function(a,r){if(!(a instanceof t)){throw new p(g,"State must always be set with respect to a ControllerExtension")}if(!n){throw new p(g,"State must always be provided synchronously")}e.adaptationExtensions[a.getMetadata().getNamespace()]=r};a.templateBaseExtension.provideExtensionAppStateData(i);n=false;return e},setState:function(e){if(o.oComponentUtils.isDraftEnabled()){var r=o.oComponentUtils.getTemplatePrivateModel();r.setProperty("/listReport/vDraftState",e.editState)}a.restoreCustomAppStateDataExtension(e.appExtension);var n=true;var i=function(a){if(!(a instanceof t)){throw new p(g,"State must always be retrieved with respect to a ControllerExtension")}if(!n){throw new p(g,"State must always be restored synchronously")}return e.adaptationExtensions[a.getMetadata().getNamespace()]};a.templateBaseExtension.restoreExtensionAppStateData(i);n=false},attachStateChanged:function(e){if(a.byId("editStateFilter")){a.byId("editStateFilter").attachChange(e)}I.push(e)}};var A=o.oCommonUtils.getControlStateWrapper(e.oSmartFilterbar,{oCustomFiltersWrapper:L});var T=a.byId(S.getStableId({type:"ListReportPage",subType:"DynamicPage"}));var M=o.oCommonUtils.getControlStateWrapper(T);C.push(M);var U=e.oSmartFilterbar.getSmartVariant();if(U){var H=o.oCommonUtils.getControlStateWrapper(U,{managedControlWrappers:E.concat([A]),dynamicPageWrapper:M});C.push(H)}else{C.push(A)}function W(){var t=o.oComponentUtils.getTemplatePrivateModel();function a(e){t.setProperty("/generic/bDataAreShownInTable",e)}function r(){return t.getProperty("/generic/bDataAreShownInTable")}function n(e,t){if(e===r()){return}a(e);t()}return{getLocalId:function(){return"$dataLoaded"},setState:a,getState:r,attachStateChanged:function(t){e.oSmartFilterbar.attachSearch(n.bind(null,true,t));e.oSmartFilterbar.attachFilterChange(n.bind(null,false,t))}}}var J=W();C.push(J);C.forEach(function(e){e.attachStateChanged(Y)});var k=o.oServices.oApplication.getNavigationHandler();var R=a.getOwnerComponent().getSmartVariantManagement();var j=o.oComponentUtils.getSettings();e.oSmartFilterbar.setSuppressSelection(true);var _=true;function B(e){J.setState(e)}function Q(){var e=o.oComponentUtils.getTemplatePrivateModel();return e.getProperty("/generic/bDataAreShownInTable")}function K(){e.oSmartFilterbar.search()}function $(){var e={};C.forEach(function(t){if(t.getLocalId()){e[t.getLocalId()]=t.getState()}});return{version:sap.ui.version,controlStates:e}}function G(e){if(R){var t=e["sap-ui-fe-variant-id"];if(t&&t[0]){U.setCurrentVariantId(t[0])}}else{var a=e["sap-ui-fe-variant-id"],r=e["sap-ui-fe-filterbar-variant-id"],n=e["sap-ui-fe-chart-variant-id"],i=e["sap-ui-fe-table-variant-id"];q(r&&r[0],n&&n[0],i&&i[0],a&&a[0])}}function q(t,a,r,n){if(t||n){U.setCurrentVariantId(t||n)}if(r||n){e.oPresentationControlHandler.setCurrentVariantId(r||n);e.oMultipleViewsHandler.setControlVariant(a,r)}}function z(e){a.restoreCustomAppStateDataExtension(e||{})}function X(){if(!ee()){return}e.refreshModel();if(u.system.phone){de()}J.setState(true);Y()}function Y(){O("changeIappState called",{bDataAreShownInTable:Q()});if(e.oSmartFilterbar.isDialogOpen()||_){return}o.oComponentUtils.stateChanged()}function Z(t){var a=e.oSmartFilterbar.determineMandatoryFilterItems(),r;for(var n=0;n<a.length;n++){if(a[n].getName().indexOf("P_DisplayCurrency")!==-1){if(t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){r=t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(r){t.oSelectionVariant.addParameter("P_DisplayCurrency",r)}}break}}}function ee(){var t=e.oSmartFilterbar.determineMandatoryFilterItems();var a=e.oSmartFilterbar.getFiltersWithValues();return t.every(function(e){return a.includes(e)})}function te(t){var a=typeof t==="string"?JSON.parse(t):t;var r=a&&a.SortOrder;e.oPresentationControlHandler.applyNavigationSortOrder(r)}function ae(e){le(e.controlStates);if(Q()){K()}else{o.oComponentUtils.hidePlaceholder()}if(!ee()){o.oComponentUtils.hidePlaceholder()}}function re(t,r,n){G(r);if(t.presentationVariant!==undefined){te(t.presentationVariant)}if(t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&t.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1){Z(t)}var i={viaExternalNavigation:true,selectionVariant:t.oSelectionVariant,urlParameters:r,selectedQuickVariantSelectionKey:n,semanticDates:(typeof t.semanticDates==="string"?JSON.parse(t.semanticDates):t.semanticDates)||{}};if(!e.oWorklistData.bWorkListEnabled){a.modifyStartupExtension(i);if(e.oSmartFilterbar.isCurrentVariantStandard()){i.semanticDates=f.addSemanticDateRangeDefaultValue(j,e.oSmartFilterbar,i.semanticDates,i.urlParameters||{});i.semanticDates.Dates.forEach(function(e){i.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")})}be(i.selectionVariant,t.selectionVariant||"",true,i.semanticDates,false)}z();e.oMultipleViewsHandler.handleStartUpObject(i);he(e.oSmartFilterbar.isCurrentVariantStandard())}function ne(t,r){G(t);var i={viaExternalNavigation:false,selectionVariant:"",urlParameters:t,selectedQuickVariantSelectionKey:r,semanticDates:{}};var o=e.oSmartFilterbar.getUiState();var l=new n(JSON.stringify(o.getSelectionVariant()));Se(l);var c=JSON.parse(JSON.stringify(l));var p=o.getSemanticDates();i.selectionVariant=l;i.semanticDates=p;a.modifyStartupExtension(i);if(!(s(JSON.parse(JSON.stringify(i.selectionVariant)),c)&&s(i.semanticDates,p))){be(i.selectionVariant,"",true,i.semanticDates,true)}z();e.oMultipleViewsHandler.handleStartUpObject(i);if(!e.oWorklistData.bWorkListEnabled&&!e.oSmartFilterbar.getLiveMode()&&e.oSmartFilterbar.isCurrentVariantStandard()){i.semanticDates=f.addSemanticDateRangeDefaultValue(j,e.oSmartFilterbar,i.semanticDates||{},i.urlParameters);i.semanticDates.Dates.forEach(function(e){i.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")})}he();U&&U.currentVariantSetModified(false)}function ie(e,t){return s(e.map(JSON.stringify).sort(),t.map(JSON.stringify).sort())}function oe(t,i,o){G(i);var l={viaExternalNavigation:false,selectionVariant:t.oSelectionVariant,urlParameters:i,selectedQuickVariantSelectionKey:o,semanticDates:(typeof t.semanticDates==="string"?JSON.parse(t.semanticDates):t.semanticDates)||{}};if(t.presentationVariant!==undefined){te(t.presentationVariant)}var c=e.oSmartFilterbar.getUiState();var p=new n(JSON.stringify(c.getSelectionVariant()));Se(p);var u=JSON.parse(JSON.stringify(p));var d=c.getSemanticDates();if(t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&t.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1){Z(t)}if(!e.oWorklistData.bWorkListEnabled){if(e.oSmartFilterbar.isCurrentVariantStandard()){a.modifyStartupExtension(l);l.semanticDates=f.addSemanticDateRangeDefaultValue(j,e.oSmartFilterbar,l.semanticDates,l.urlParameters);l.semanticDates.Dates.forEach(function(e){l.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")});var m=e.oSmartFilterbar.getAllFilterItems().map(function(e){return e.getName()});var S=function(e){return m.includes(e.PropertyName)};var g=e.oSmartFilterbar.getAnalyticalParameters().map(function(e){return e.name});var v=function(e){return g.includes(e.PropertyName)};var y=r.getMergedVariants([p,l.selectionVariant]);var b=y.toJSONObject();var D=p.toJSONObject();if(!ie(D.SelectOptions.filter(S),b.SelectOptions.filter(S))||!ie(D.Parameters.filter(v),b.Parameters.filter(v))){be(y,t.selectionVariant,true,l.semanticDates,false);U.currentVariantSetModified(true)}}else{l.selectionVariant=p;l.semanticDates=d;a.modifyStartupExtension(l);if(!(s(JSON.parse(JSON.stringify(l.selectionVariant)),u)&&s(l.semanticDates,d))){be(l.selectionVariant,t.selectionVariant,true,l.semanticDates,false)}}}z();e.oMultipleViewsHandler.handleStartUpObject(l);he()}function se(t,a,r){O("fnAdaptToAppState called",{sNavType:r});e.oSmartFilterbar.setSuppressSelection(false);_=false;if(r===sap.ui.generic.app.navigation.service.NavType.iAppState){ae(t);return}var n=o.oComponentUtils.getSelectionInfo();var i=n&&n.pageEntitySet;var s=e.oMultipleViewsHandler.getPreferredKey(i);switch(r){case sap.ui.generic.app.navigation.service.NavType.initial:ne(a,s);break;case sap.ui.generic.app.navigation.service.NavType.xAppState:case sap.ui.generic.app.navigation.service.NavType.URLParams:if(t.bNavSelVarHasDefaultsOnly){oe(t,a,s)}else{re(t,a,s)}break;default:throw new p(g,"Invalid navigation type: "+r)}if(Q()){e.oSmartFilterbar.search();if(!u.system.desktop){de()}}else{o.oComponentUtils.hidePlaceholder()}Y()}function le(e){C.forEach(function(t){t.setState(e[t.getLocalId()])})}function ce(e){if(!e){return b.then(pe)}var t;if(c(e)){t=sap.ui.generic.app.navigation.service.NavType.initial}else{t=sap.ui.generic.app.navigation.service.NavType.iAppState;e=m.getStateInCurrentFormat(e)}var a=l({oDefaultedSelectionVariant:new n,oSelectionVariant:new n(e&&e.selectionVariant)},e);b.then(function(){se(a,{},t)});return b}function pe(){var e=new Promise(function(e){try{var t=k.parseNavigation();t.done(function(t,a,r){if(r!==sap.ui.generic.app.navigation.service.NavType.iAppState){se(t,a,r)}e()});t.fail(function(t,a,r){y.warning(t.getErrorCode()+"app state could not be parsed - continuing with empty state");se({},a,sap.ui.generic.app.navigation.service.NavType.initial);e()})}catch(t){se({},{},sap.ui.generic.app.navigation.service.NavType.initial);e()}});return e}function ue(t){if(e.oWorklistData.bWorkListEnabled&&t.getParameter("context")!=="SET_VM_ID"){K()}}function fe(e){ue(e)}function de(){var e=a.getOwnerComponent().getModel("_templPriv");e.setProperty("/listReport/isHeaderExpanded",false)}function me(t,a,r,n){var o=new i({selectionVariant:t,semanticDates:n});e.oSmartFilterbar.setUiState(o,{replace:a,strictMode:r})}function Se(e){[h,D,V].forEach(e.removeSelectOption.bind(e))}function ge(t,a,r){if(t&&(a!==""||r)){var n=t.getParameterNames().concat(t.getSelectOptionsPropertyNames());for(var i=0;i<n.length;i++){e.oSmartFilterbar.addFieldToAdvancedArea(n[i])}}}function ve(e,t,a){if(e.getParameter(t)&&!e.getParameter(a)){e.addParameter(a,e.getParameter(t))}if(e.getSelectOption(t)&&!e.getSelectOption(a)){var r=e.getSelectOption(t);r.forEach(function(t){e.addSelectOption(a,t.Sign,t.Option,t.Low,t.High)})}}function ye(e){var t=a.getOwnerComponent().getModel().getMetaModel();var r=a.getOwnerComponent().getEntitySet();var n=t.getODataEntityType(t.getODataEntitySet(r).entityType);n.property.forEach(function(t){if(t["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var a=t["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||t["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var r=t.name;ve(e,a,r);ve(e,r,a)}})}function be(t,a,r,n,i){ye(t);if(r){e.oSmartFilterbar.clearVariantSelection()}ge(t,a,i);me(t.toJSONObject(),r,false,n)}function De(){var t={loadDataOnAppLaunch:"ifAnyFilterExist"};var r=e.oMultipleViewsHandler.getOriginalEnableAutoBinding();if(r!==undefined&&r!==null){t.loadDataOnAppLaunch=r?"always":"never"}var n=a.getOwnerComponent().getDataLoadSettings();if(n&&n.loadDataOnAppLaunch===""){n.loadDataOnAppLaunch=undefined}return l(t,n)}function he(t){var r=e.oWorklistData.bWorkListEnabled||e.oSmartFilterbar.getLiveMode()||e.bLoadListAndFirstEntryOnStartup;var n=De().loadDataOnAppLaunch;if(!U||a.getOwnerComponent().getVariantManagementHidden()){r=r||n==="always";r=r||n==="ifAnyFilterExist"&&e.oSmartFilterbar.getFiltersWithValues().length>0}else{var i=(r||n!=="never")&&ee();U&&U.setExecuteOnStandard(i);if(e.oSmartFilterbar.isCurrentVariantStandard()){var o=U.getExecuteOnStandard();if(i!==o){r=o}else{r=r||n==="always";r=r||n==="ifAnyFilterExist"&&e.oSmartFilterbar.getFiltersWithValues().length>0}}else{r=r||e.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()}}r=r||t;r=r&&ee();J.setState(!!r)}return{areDataShownInTable:Q,setDataShownInTable:B,onSearchPressed:X,customAppStateChange:x,changeIappState:Y,onSmartFilterBarInitialized:v,onAfterSFBVariantLoad:fe,applyState:ce,getCurrentAppState:$,setFiltersUsingUIState:me}}return e.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(e,t,a){l(this,C(e,t,a))}})});
//# sourceMappingURL=IappStateHandler.js.map