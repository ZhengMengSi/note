sap.ui.define(["sap/ui/model/Filter","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/listTemplates/controller/MessageStripHelper","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/suite/ui/generic/template/ListReport/controller/WorklistHandler","sap/suite/ui/generic/template/lib/ShareUtils","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/ObjectPath","sap/suite/ui/generic/template/js/StableIdHelper","sap/base/util/deepExtend","sap/suite/ui/generic/template/lib/CreateWithDialogHandler","sap/suite/ui/generic/template/ListReport/controller/MultiEditHandler","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/lib/AddCardsHelper","sap/insights/CardHelper"],function(e,t,n,i,a,r,o,l,s,c,d,u,p,g,f,m,v,S){"use strict";var C=new c("ListReport.controller.ControllerImplementation").getLogger();var h={getMethods:function(c,h,b){var E={};E.oWorklistData={bWorkListEnabled:!!h.oComponentUtils.getSettings().isWorklist};var y;var T=null;function I(){var e=b.getOwnerComponent();var t=h.oComponentUtils.getTemplatePrivateModel();t.setProperty("/listReport/isLeaf",e.getIsLeaf())}function D(e){var t=e.getSource();var n=b.getOwnerComponent().getAnnotationPath();if(n!==undefined){F(t,n)}b.onInitSmartFilterBarExtension(e);b.templateBaseExtension.onInitSmartFilterBar(e)}function F(e,t){if(t.indexOf("com.sap.vocabularies.UI.v1.PresentationVariant")>-1){return}var i=new m(JSON.stringify(e.getUiState().getSelectionVariant()));var a=b.getOwnerComponent().getModel().getMetaModel();var r=b.getOwnerComponent().getEntitySet();var o=a.getODataEntityType(a.getODataEntitySet(r).entityType);var l=a.getObject(o.$path+"/"+t);if(l&&l.SelectionVariant&&(l.SelectionVariant.Path||l.SelectionVariant.AnnotationPath)){t=(l.SelectionVariant.Path||l.SelectionVariant.AnnotationPath).split("@")[1]}var s=a.getObject(o.$path+"/"+t);if(s){s=n.createSVObject(s,e);s.FilterContextUrl=i.getFilterContextUrl();E.oIappStateHandler.setFiltersUsingUIState(s.toJSONObject(),true,false)}else{var c=b.getOwnerComponent().getAppComponent().getNavigationController();c.navigateToMessagePage({title:h.oCommonUtils.getText("ST_ERROR"),text:"Manifest property 'annotationPath' is configured with "+t+" but no such annotation found.",description:""})}}function H(e){h.oCommonUtils.setEnabledToolbarButtons(e);if(!s.isSmartChart(e)){h.oCommonUtils.setEnabledFooterButtons(e)}}function M(e){var t;t=e.getSource();t.getChartAsync().then(function(e){e.attachSelectData(H.bind(null,t));e.attachDeselectData(H.bind(null,t))})}function P(e){var t=e.getParameters();var n=e.getSource();h.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(n,t)}function U(e){var t,n;t=e.getParameters();n=e.getSource();h.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(n.getEntitySet(),n.getFieldSemanticObjectMap(),t,E)}function R(e){var t=e.getParameters(),n=t.mainNavigation,i=e.getSource(),a;if(n){a=i.getText&&i.getText();var r=h.oCommonUtils.getCustomData(e);if(r&&r["LinkDescr"]){var o=r["LinkDescr"];n.setDescription(o)}}h.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(E.oPresentationControlHandler.getEntitySet(),{},t,E,a)}function w(e){var t=c.getItems();for(var n=0;n<t.length;n++){if(!e||t[n].getBindingContextPath()===e){return t[n]}}}function A(e){h.oCommonEventHandlers.onListNavigate(e,E,undefined,true)}function O(e,t,n){var i=h.oServices.oCRUDManager.getDefaultValues(t,e);if(i instanceof Promise){var a=function(e){n.call(this,e[0],t)};i.then(a,a)}else{n.call(this,e,t)}}function L(e,t){if(e){B(e,t)}else{O(null,t,B)}}function B(e,t){if(t.data("CrossNavigation")){h.oCommonUtils.fnProcessDataLossOrDraftDiscardConfirmation(function(){h.oCommonEventHandlers.addEntry(t,false,E.oSmartFilterbar,e)},Function.prototype,"LeaveApp")}else{h.oCommonEventHandlers.addEntry(t,false,E.oSmartFilterbar,e)}}function x(){var e=E.oMultipleViewsHandler.getMode()!=="single"&&E.oMultipleViewsHandler.getSelectedKey()||"";var t=u.getStableId({type:"ListReportAction",subType:"Create",sQuickVariantKey:e});h.oCommonUtils.executeIfControlReady(function(t){var n=u.getStableId({type:"ListReportAction",subType:"CreateWithDialog",sQuickVariantKey:e});var i=n&&b.byId(n);if(i){E.oCreateWithDialogHandler.createWithDialog(i,t)}else{L(null,t)}},t)}function V(e){O(undefined,e.getSource(),k)}function k(e,t){var n=b.getOwnerComponent().getCreateWithFilters();var i=n.strategy||"extension";var a;switch(i){case"extension":a=b.getPredefinedValuesForCreateExtension(E.oSmartFilterbar,e)||{};break;default:C.error(i+" is not a valid strategy to extract values from the SmartFilterBar");return}var r=u.getStableId({type:"ListReportAction",subType:"CreateWithDialog"});var o=r&&b.byId(r);if(o){E.oCreateWithDialogHandler.createWithDialog(o,t,a)}else{L(a,t)}}function N(e){var t=h.oComponentUtils.getTemplatePrivateModel();var n=t.getProperty("/listReport/deleteEnabled");if(n){h.oCommonEventHandlers.deleteEntries(e)}}function W(t){if(!h.oComponentUtils.isDraftEnabled()){return}var n=h.oComponentUtils.getTemplatePrivateModel();var i=n.getProperty("/listReport/vDraftState");switch(i){case"1":t.push(new e("IsActiveEntity","EQ",true));t.push(new e("HasDraftEntity","EQ",false));break;case"2":t.push(new e("IsActiveEntity","EQ",false));break;case"3":t.push(new e("IsActiveEntity","EQ",true));t.push(new e("SiblingEntity/IsActiveEntity","EQ",null));t.push(new e("DraftAdministrativeData/InProcessByUser","NE",""));break;case"4":t.push(new e("IsActiveEntity","EQ",true));t.push(new e("SiblingEntity/IsActiveEntity","EQ",null));t.push(new e("DraftAdministrativeData/InProcessByUser","EQ",""));break;case"5":t.push(new e("IsActiveEntity","EQ",true));break;default:var a=new e({filters:[new e("IsActiveEntity","EQ",false),new e("SiblingEntity/IsActiveEntity","EQ",null)],and:false});if(t[0]&&t[0].aFilters){var r=t[0];t[0]=new e([r,a],true)}else{t.push(a)}break}}function j(){return E.oSmartFilterbar.getBasicSearchValue()||E.oWorklistHandler.getSearchString()}function _(e){var t={sharePageToPressed:function(e){var t=h.oServices.oApplication.getBusyHelper();if(t.isBusy()){return}var n=h.oServices.oApplication.getAppTitle();var i=l.getCurrentUrl().then(function(t){switch(e){case"MicrosoftTeams":l.openMSTeamsShareDialog(n,t);break;case"Email":n=h.oCommonUtils.getText("EMAIL_HEADER",[n]);sap.m.URLHelper.triggerEmail(null,n,t);break;default:break}});t.setBusy(i)},shareJamPressed:function(){l.openJamShareDialog(h.oServices.oApplication.getAppTitle())},shareTilePressed:function(){l.fireBookMarkPress()},getDownloadUrl:function(){var e=E.oPresentationControlHandler.getBinding(E);return e&&e.getDownloadUrl()||""},getServiceUrl:function(){return E.oSmartFilterbar.hasDateRangeTypeFieldsWithValue().then(function(e){var n=e?"":t.getDownloadUrl();n=n&&n+"&$top=0&$inlinecount=allpages";var i={serviceUrl:n};b.onSaveAsTileExtension(i);return i.serviceUrl})},getModelData:function(){var e=d.get("sap.ushell.Container.getUser");var n=b.getOwnerComponent().getAppComponent().getMetadata();var i=n.getManifestEntry("sap.ui");var a=n.getManifestEntry("sap.app");return t.getServiceUrl().then(function(t){return l.getCurrentUrl().then(function(n){return{serviceUrl:t,icon:i&&i.icons?i.icons.icon:"",title:a?a.title:"",isShareInJamActive:!!e&&e().isJamActive(),customUrl:l.getCustomUrl(),currentUrl:n}})})}};l.openSharePopup(h.oCommonUtils,e,t)}function Q(e){var t=e.getId();var n=E.oSmartFilterbar;var i="";var a=[];var r=!!(h.oComponentUtils&&h.oComponentUtils.getSettings()&&(h.oComponentUtils.getSettings().quickVariantSelectionX||h.oComponentUtils.getSettings().quickVariantSelection));if(e.fetchVariant()&&e.fetchVariant().filter&&e.fetchVariant().filter.filterItems){a=e.fetchVariant().filter.filterItems}var o={search:!!n.getBasicSearchValue(),filter:!!(a.length||n.retrieveFiltersWithValues().length)};if(r){i=h.oCommonUtils.getContextText("NOITEMS_MULTIVIEW_LR_SMARTTABLE_WITH_FILTER",t)}else if(o.search||o.filter){i=h.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE_WITH_FILTER",t)}else{i=h.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE",t)}e.setNoData(i)}function q(e){var t=e.getId();var n=h.oCommonUtils.getContextText("NOITEMS_LR_SMARTCHART",t);e.getChartAsync().then(function(e){e.setCustomMessages({NO_DATA:n})})}function z(e){var t=e.getEntitySet();h.oComponentUtils.preloadComponent(t)}var J;function $(e){if(J){J()}J=Function.prototype;h.oCommonEventHandlers.onDataReceived(e);if(T){var t;var n=false;for(var i=0;i<T.aWaitingObjects.length&&!n;i++){t=w(T.aWaitingObjects[i]);if(t){A(t);T.resolve();n=true}}if(!n){t=w();if(t){A(t);T.resolve()}else{T.reject()}}T=null;return}y.handleDataReceived(e,A);var a=h.oComponentUtils.getTemplatePrivateModel();a.setProperty("/listReport/firstSelection",true);E.oIappStateHandler.setDataShownInTable(true);h.oComponentUtils.hidePlaceholder()}return{onInit:function(){E.oSmartFilterbar=b.byId("listReportFilter");E.oPresentationControlHandler=h.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(b.byId(u.getStableId({type:"ListReportTable",subType:"SmartTable"}))||b.byId(u.getStableId({type:"ListReportTable",subType:"SmartList"})));E.updateControlOnSelectionChange=H;y=h.oComponentUtils.getFclProxy();E.bLoadListAndFirstEntryOnStartup=y.isListAndFirstEntryLoadedOnStartup();var e=new r(E,b,h);E.oMultipleViewsHandler=e;E.oMessageStripHelper=new i(E.oPresentationControlHandler,e,b,h,"listReport");E.refreshModel=function(){var t=h.oCommonUtils.refreshModel(E.oPresentationControlHandler.getEntitySet());if(t){e.refreshSiblingControls(E.oPresentationControlHandler)}};E.oCreateWithDialogHandler=new g(E,b,h);E.oWorklistHandler=new o(E,b,h);E.oIappStateHandler=new a(E,b,h);E.oMultiEditHandler=new f(E,b,h);var t=h.oComponentUtils.getTemplatePrivateModel();t.setProperty("/generic/bDataAreShownInTable",false);t.setProperty("/listReport/firstSelection",false);t.setProperty("/listReport/isHeaderExpanded",true);t.setProperty("/listReport/deleteEnabled",false);t.setProperty("/listReport/multiEditEnabled",false);if(h.oComponentUtils.isDraftEnabled()){t.setProperty("/listReport/vDraftState","0")}t.setProperty("/listReport/multipleViews/msgVisibility",false);c.adaptToChildContext=function(e){E.oPresentationControlHandler.scrollToSelectedItemAsPerChildContext(e)};c.getItems=function(){return E.oPresentationControlHandler.getItems()};c.displayNextObject=function(e){return new Promise(function(t,n){T={aWaitingObjects:e,resolve:t,reject:n}})};c.refreshBinding=function(e,t){if(E.oIappStateHandler.areDataShownInTable()){if(E.oMultipleViewsHandler.refreshOperation(2,null,!e&&t)){return}if(e||t[b.getOwnerComponent().getEntitySet()]){h.oCommonUtils.refreshModel(b.getOwnerComponent().getEntitySet());E.oPresentationControlHandler.refresh()}}};c.getCurrentState=function(){return{permanentState:{data:E.oIappStateHandler.getCurrentAppState(),lifecycle:{permanent:true}}}};c.applyState=function(e){E.oIappStateHandler.applyState(e.permanentState).then(function(){if(!E.oIappStateHandler.areDataShownInTable()){y.handleDataReceived()}})};I();b.byId("template::FilterText").attachBrowserEvent("click",function(){b.byId("page").setHeaderExpanded(true)});var n=b.byId(u.getStableId({type:"ListReportAction",subType:"Share"})+"-internalBtn");n.attachPress(function(){_(n)})},handlers:{addEntry:x,addEntryWithFilters:V,deleteEntries:N,deleteEntry:function(e){h.oCommonEventHandlers.deleteEntry(e)},updateTableTabCounts:function(){E.oMultipleViewsHandler.fnUpdateTableTabCounts()},onCancelCreateWithPopUpDialog:function(){E.oCreateWithDialogHandler.onCancelPopUpDialog()},onSaveCreateWithPopUpDialog:function(e){E.oCreateWithDialogHandler.onSavePopUpDialog(e)},onSelectionChange:function(e){var t=e.getSource();H(t)},onMultiSelectionChange:function(e){h.oCommonEventHandlers.onMultiSelectionChange(e)},onContactDetails:function(e){h.oCommonEventHandlers.onContactDetails(e)},onSmartFilterBarInitialise:D,onSmartFilterBarInitialized:function(){E.oIappStateHandler.onSmartFilterBarInitialized()},onAfterSFBVariantLoad:function(e){E.oIappStateHandler.onAfterSFBVariantLoad(e)},onSmartListDataReceived:function(e){var t=e.getSource();$(t)},onBeforeRebindTable:function(e){var t=e.getSource();Q(t);var i=e.getParameters().bindingParams;E.oMultipleViewsHandler.aTableFilters=p({},i.filters);var a=i.filters.slice(0);h.oCommonEventHandlers.onBeforeRebindTable(e,{determineSortOrder:E.oMultipleViewsHandler.determineSortOrder,ensureExtensionFields:b.templateBaseExtension.ensureFieldsForSelect,addTemplateSpecificFilters:W,getSearchString:j,addExtensionFilters:b.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:E.oMultipleViewsHandler.resolveParameterizedEntitySet,isFieldControlRequired:false,isPopinWithoutHeader:true,isDataFieldForActionRequired:true,isFieldControlsPathRequired:true,isMandatoryFiltersRequired:true});b.onBeforeRebindTableExtension(e);var r=i.events.dataRequested||Function.prototype;i.events.dataRequested=function(e){z(t);r.call(this,e)};var o=i.events.dataReceived||Function.prototype;i.events.dataReceived=function(e){$(t);o.call(this,e)};var l=i.events.refresh||Function.prototype;i.events.refresh=function(e){E.oMultipleViewsHandler.onDataRequested();l.call(this,e)};E.oMessageStripHelper.onBeforeRebindControl(e);E.oMultipleViewsHandler.onRebindContentControl(i,a);n.handleErrorsOnTableOrChart(h,e,E)},onListNavigate:function(e){h.oCommonEventHandlers.onListNavigate(e,E)},onEdit:function(e){h.oCommonEventHandlers.onListNavigate(e,E,undefined,undefined,true)},onCallActionFromToolBar:function(e){h.oCommonEventHandlers.onCallActionFromToolBar(e,E)},onDataFieldForIntentBasedNavigation:function(e){h.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(e,E)},onDataFieldWithIntentBasedNavigation:function(e){h.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(e,E)},onBeforeSemanticObjectLinkNavigationCallback:function(e){return h.oCommonEventHandlers.onBeforeSemanticObjectLinkNavigationCallback(e)},onBeforeSemanticObjectLinkPopoverOpens:function(e){var t=e.getSource();var n=E.oSmartFilterbar.getUiState().getSelectionVariant();if(E.oSmartFilterbar.getEntitySet()!==t.getEntitySet()){n.FilterContextUrl=h.oServices.oApplication.getNavigationHandler().constructContextUrl(t.getEntitySet(),t.getModel())}var i=JSON.stringify(n);h.oCommonUtils.semanticObjectLinkNavigation(e,i,b,E)},onSemanticObjectLinkNavigationPressed:P,onSemanticObjectLinkNavigationTargetObtained:U,onSemanticObjectLinkNavigationTargetObtainedSmartLink:R,onDraftLinkPressed:function(e){var t=e.getSource();var n=t.getBindingContext();h.oCommonUtils.showDraftPopover(n,t)},onAssignedFiltersChanged:function(e){if(e.getSource()){b.byId("template::FilterText").setText(e.getSource().retrieveFiltersWithValuesAsText())}},onSearchButtonPressed:function(){E.oIappStateHandler.onSearchPressed()},onAddCardsToRepository:function(e){var t=E.oPresentationControlHandler;var n=b.getOwnerComponent();var i=t.getModel();var a=t.getEntitySet();var r=b.getView();var o=i.getMetaModel().getODataEntitySet(a);var l=i.getMetaModel().getODataEntityType(o.entityType);var s={};s["currentControlHandler"]=t;s["component"]=n;s["view"]=r;s["entitySet"]=o;s["entityType"]=l;s["oSmartFilterbar"]=E.oSmartFilterbar;v.showColumnsForCardGeneration(s,e.getSource()).then(function(e){S.getServiceAsync("UIService").then(function(t){t.showCardPreview(e.getManifest()).then(function(){})}).catch(function(e){})})},onBeforeRebindChart:function(e){var t=e.getSource();q(t);var i=e.getParameters().bindingParams;E.oMultipleViewsHandler.aTableFilters=p({},i.filters);var a=i.filters.slice(0);var r={setBindingPath:t.setChartBindingPath.bind(t),ensureExtensionFields:Function.prototype,addTemplateSpecificFilters:W,addExtensionFilters:b.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:E.oMultipleViewsHandler.resolveParameterizedEntitySet,isFieldControlRequired:false,isMandatoryFiltersRequired:true};h.oCommonUtils.onBeforeRebindTableOrChart(e,r,E.oSmartFilterbar);b.onBeforeRebindChartExtension(e);var o=i.events.dataReceived||Function.prototype;i.events.dataReceived=function(e){E.oMultipleViewsHandler.onDataRequested();h.oComponentUtils.hidePlaceholder();o.call(this,e)};E.oMultipleViewsHandler.onRebindContentControl(i,a);n.handleErrorsOnTableOrChart(h,e,E)},onChartInitialized:function(e){M(e);h.oCommonUtils.checkToolbarIntentsSupported(e.getSource())},onSelectionDetailsActionPress:function(e){E.oMultipleViewsHandler.onDetailsActionPress(e)},onShareListReportActionButtonPress:function(e){h.oCommonUtils.executeIfControlReady(_,u.getStableId({type:"ListReportAction",subType:"Share"})+"-internalBtn")},onInlineDataFieldForAction:function(e){h.oCommonEventHandlers.onInlineDataFieldForAction(e)},onInlineDataFieldForIntentBasedNavigation:function(e){h.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(e.getSource(),E)},onDeterminingDataFieldForAction:function(e){h.oCommonEventHandlers.onDeterminingDataFieldForAction(e,E.oPresentationControlHandler)},onDeterminingDataFieldForIntentBasedNavigation:function(e){h.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(e.getSource(),E.oPresentationControlHandler.getSelectedContexts(),E.oSmartFilterbar)},onTableInit:function(e){var t=e.getSource();h.oCommonUtils.checkToolbarIntentsSupported(t);var n=new sap.ui.model.base.ManagedObjectModel(t);t.setModel(n,"tableobserver")},onSearchWorkList:function(e){E.oWorklistHandler.performWorklistSearch(e)},onMultiEditButtonPress:function(){E.oMultiEditHandler.onMultiEditButtonPress()},onSaveMultiEditDialog:function(e){E.oMultiEditHandler.onSaveMultiEditDialog(e)},onCancelMultiEditDialog:function(e){E.oMultiEditHandler.onCancelMultiEditDialog(e)},dataStateFilter:function(e,t){return E.oMessageStripHelper.dataStateFilter(e,t)},dataStateClose:function(){E.oMessageStripHelper.onClose()}},formatters:{formatDraftType:function(e,t,n){if(e&&e.DraftUUID){if(!t){return sap.m.ObjectMarkerType.Draft}else if(n){return e.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved}}return sap.m.ObjectMarkerType.Flagged},formatDraftVisibility:function(e,t){if(e&&e.DraftUUID){if(!t){return sap.m.ObjectMarkerVisibility.TextOnly}}return sap.m.ObjectMarkerVisibility.IconAndText},formatDraftLineItemVisible:function(e,t){if(e&&e.DraftUUID){if(t==="5"){return false}return true}return false},formatDraftOwner:function(e,t){var n="";if(e&&e.DraftUUID&&t){var i=e.InProcessByUserDescription||e.InProcessByUser||e.LastChangedByUserDescription||e.LastChangedByUser;if(i){n=h.oCommonUtils.getText("ST_DRAFT_OWNER",[i])}else{n=h.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER")}}return n},formatItemTextForMultipleView:function(e){return E.oMultipleViewsHandler?E.oMultipleViewsHandler.formatItemTextForMultipleView(e):""},formatMessageStrip:function(e,t){return E.oMultipleViewsHandler?E.oMultipleViewsHandler.formatMessageStrip(e,t):""}},extensionAPI:new t(h,b,E)}}};return h});
//# sourceMappingURL=ControllerImplementation.js.map