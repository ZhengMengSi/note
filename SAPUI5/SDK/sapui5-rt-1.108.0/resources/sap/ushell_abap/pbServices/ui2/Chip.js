// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell_abap/pbServices/ui2/Bag","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/Error","sap/ushell_abap/pbServices/ui2/ChipDefinition","sap/base/Log","sap/ui/core/Manifest"],function(e,t,i,n,r,a){"use strict";var o={};var s={};function u(e){return Object.prototype.hasOwnProperty.call(o,e)?o[e]:null}var p=function(o,p){var c=this,l,f,h,g,d,C,m,w,I;function P(){if(!g){throw new i(c+": CHIP is just a stub","sap.ushell_abap.pbServices.ui2.Chip")}}function v(i){var n;l=new t.Map;if(!i){return}for(n=0;n<i.length;n+=1){l.put(i[n].id,new e(p,i[n]))}}function y(e){var t=e.basePath,n,r,a,o=e.viewName;if(e.componentName){e.$Namespace=e.componentName}else{r=/^(?:([^\/]+)\/)?(.*)\.view\.(.*)$/.exec(o);if(!r){throw new i(c+": Illegal view name: "+o,"Chip")}a=r[1];o=r[2];e.$ViewType=r[3].toUpperCase();if(a){o=a+"."+o}else{n=o.lastIndexOf(".");if(n<1){throw new i(c+": Missing namespace: "+o,"Chip")}a=o.substring(0,n)}e.$Namespace=a;e.$ViewName=o}var s=e.virtualNamespace;if(s){e.$VirtualNamespace=s}e.$UrlPrefix=e.$Namespace.replace(/\./g,"/");if(t!=="."){t=t.replace(/\/?$/,"/");e.$UrlPrefix=t+e.$UrlPrefix}e.$UrlPrefix=c.toAbsoluteUrl(e.$UrlPrefix)}function b(){h={};if(g.contracts.configuration&&g.contracts.configuration.parameters){h=JSON.parse(JSON.stringify(g.contracts.configuration.parameters))}c.updateConfiguration(h,o.configuration)}function U(e){var t,n;if(g){throw new i(c+": cannot initialize twice",null,"Chip")}g=e;g.contracts=g.contracts||{};if(!g.implementation||!g.implementation.sapui5){throw new i(c+": Missing SAPUI5 implementation","Chip")}y(g.implementation.sapui5);b();r.debug("Initialized: "+c,null,"Chip");if(m){for(t=0,n=m.length;t<n;t+=2){m[t]()}m=null}}this.updateBags=function(t){var i,n,r=l.keys();for(i=0;i<t.length;i+=1){n=t[i].id;if(l.containsKey(n)){l.get(n).update(t[i]);r.splice(r.indexOf(n),1)}else{l.put(n,new e(p,t[i]))}}for(i=0;i<r.length;i+=1){l.remove(r[i])}};this.createApi=function(e,t){var n={},r,a,o,s;P();s=g.contracts;if(s){for(o in s){if(Object.prototype.hasOwnProperty.call(s,o)){a=u(o);if(!a){throw new i(this+": Contract '"+o+"' is not supported","Chip")}n[o]={};r=a.call(n[o],e);if(t){t.put(o,r)}}}}return n};this.getAvailableTypes=function(){var e;P();if(g.contracts.types&&g.contracts.types.parameters&&typeof g.contracts.types.parameters.supportedTypes==="string"&&g.contracts.types.parameters.supportedTypes!==""){e=g.contracts.types.parameters.supportedTypes.toLowerCase();return e.split(",")}return[]};this.getDefaultType=function(){var e=this.getAvailableTypes();if(g.contracts.types&&g.contracts.types.parameters&&typeof g.contracts.types.parameters.defaultType==="string"&&g.contracts.types.parameters.defaultType!==""){var t=g.contracts.types.parameters.defaultType;t=t.toLowerCase();if(e.indexOf(t)>-1){return t}throw new i("The chip has the default type: "+t+" which is not supported")}if(e.indexOf("tile")>-1){return"tile"}if(e.length>0){return e[0]}return""};this.getBag=function(e){if(!e){throw new i("Missing bag ID","Chip")}return l.get(e)};this.getBagIds=function(){return l.keys()};this.getBaseChipId=function(){return o.baseChipId};this.getCatalog=function(){if(w){return w}return o.$proxy?undefined:p.createCatalog(o.catalogId)};this.getConfigurationParameter=function(e){P();return h[e]};this._getChipRawConfigurationString=function(){return o.configuration};this.getDescription=function(){return o.description};this.getId=function(){return o.id};this.getReferenceChipId=function(){return o.referenceChipId};this.getImplementationAsSapui5=function(e){var t,i,n;r.error("Deprecated API call of 'Chip.getImplementationAsSapui5'. Please use 'getImplementationAsSapui5Async' instead",null,"sap.ushell_abap.pbServices.ui2.Chip");P();t={chip:e};i=g.implementation.sapui5;n=this.getBaseChipId();if(n!=="X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER"&&n!=="X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER"){if(i.$VirtualNamespace){i.$absolutePath=this.toAbsoluteUrl(i.basePath);sap.ui.loader.config({paths:JSON.parse('{"'+i.$Namespace.replace(/\./g,"/")+'":"'+i.$absolutePath+'"}')})}else{sap.ui.loader.config({paths:JSON.parse('{"'+i.$Namespace.replace(/\./g,"/")+'":"'+i.$UrlPrefix+'"}')})}}if(i.componentName){var a=new sap.ui.core.ComponentContainer;this.oComponentPromise=new Promise(function(e,n){sap.ui.require(["sap/ui/core/Component"],function(r){r.create({name:i.componentName,componentData:t}).then(function(e){a.setComponent(e)}).then(e).catch(n)})});return a}return sap.ui.view({type:i.$ViewType,viewName:i.$ViewName,viewData:t})};this.getImplementationAsSapui5Async=function(e){try{P()}catch(e){return Promise.reject(e)}return new Promise(function(t,i){sap.ui.require(["sap/ui/core/ComponentContainer","sap/ui/core/Component","sap/ui/core/mvc/View"],function(n,r,a){var o={chip:e};var s=g.implementation.sapui5;var u=this.getBaseChipId();if(u!=="X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER"&&u!=="X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER"){if(s.$VirtualNamespace){s.$absolutePath=this.toAbsoluteUrl(s.basePath);sap.ui.loader.config({paths:JSON.parse('{"'+s.$Namespace.replace(/\./g,"/")+'":"'+s.$absolutePath+'"}')})}else{sap.ui.loader.config({paths:JSON.parse('{"'+s.$Namespace.replace(/\./g,"/")+'":"'+s.$UrlPrefix+'"}')})}}if(s.componentName){var p;if(u==="X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER"||u==="X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER"){p=Promise.resolve(false)}else{p=this._loadManifest(s.$UrlPrefix+"/manifest.json")}return p.then(function(e){return r.create({name:s.componentName,componentData:o,manifest:e})}).then(function(e){return new n({component:e})}).then(t).catch(i)}return a.create({type:s.$ViewType,viewName:s.$ViewName,viewData:o}).then(t).catch(i)}.bind(this))}.bind(this))};this._loadManifest=function(e){if(!s[e]){s[e]=a.load({manifestUrl:e,async:true}).then(function(e){return e.getRawJson()}).catch(function(){return null})}return s[e]};this.getRemoteCatalog=function(){return w};this.getTitle=function(){return o.title||g&&g.appearance&&g.appearance.title};this.isBasedOn=function(e){var t="X-SAP-UI2-PAGE:"+e.getPage().getId()+":"+e.getId();function i(e){return e===t||e.indexOf(t+":")===0}return o.referenceChipId&&i(o.referenceChipId)||i(o.id)};this.isReference=function(){return!!o.referenceChipId};this.isBrokenReference=function(){return o.referenceChipId==="O"};this.isStub=function(){return!g};this.load=function(e,a){function s(e,t){d=e;C=t;var i,n;if(m){for(i=1,n=m.length;i<n;i+=2){m[i](e,t)}m=null}}function u(){if(p){p.createChipDefinition(o.url,U,s);return}t.get(o.url,true,function(e){r.debug("Loaded: "+c,null,"Chip");U(new n(e))},s)}function l(){if(!o.url){if(I){throw new i("Remote catalog did not deliver CHIP '"+o.id+"'","Chip")}throw new i("Missing module URL","Chip")}I=false;f=t.absoluteUrl(o.url);u()}if(!this.isStub()){throw new i("Chip is not a stub anymore","Chip")}if(typeof e!=="function"){throw new i("Missing success handler","Chip")}a=a||p.getPageBuildingService().getDefaultErrorHandler();if(d){t.callHandler(a.bind(null,d,C),null,true);return}if(m){m.push(e,a);return}if(o.url){u()}else if(o.remoteCatalogId){this.getRemoteCatalog().readRegisteredChips(l,s);I=true}else{p.getPageBuildingService().readChip(o.id,function(e){o=e;l()},s)}m=[e,a]};this.refresh=function(e,t){function n(t){o.title=t.title;o.configuration=t.configuration;o.referenceChipId=t.referenceChipId;v(t.ChipBags&&t.ChipBags.results);if(!c.isStub()){c.updateConfiguration(h,o.configuration)}e()}function r(e){if(e.results[0]){n(e.results[0])}else{t=t||p.getPageBuildingService().getDefaultErrorHandler();t("Could not refresh CHIP. No update received from catalog "+o.remoteCatalogId)}}if(typeof e!=="function"){throw new i("Missing success handler","Chip")}if(!o.url){throw new i(c+": CHIP is just a stub","Chip")}if(o.remoteCatalogId){this.getRemoteCatalog().readChips([o.id],r,t)}else{p.getPageBuildingService().readChip(o.id,n,t)}};this.update=function(e){if(typeof e!=="object"||e.id!==this.getId()){throw new i("Invalid update data: "+this,"Chip")}if(e.ChipBags&&e.ChipBags.results){this.updateBags(e.ChipBags&&e.ChipBags.results)}if(o.url){return}if(!e.url){return}o=e;f=t.absoluteUrl(o.url);r.debug("Updated: "+this,null,"Chip")};this.updateConfiguration=function(e,t){var n,a,o;if(!t){return}if(typeof t==="string"){try{n=JSON.parse(t)}catch(e){r.warning(this+': ignoring invalid configuration "'+t+'"',null,"Chip");return}}else{n=t}for(a in n){if(Object.prototype.hasOwnProperty.call(n,a)){if(Object.prototype.hasOwnProperty.call(h,a)){o=n[a];if(o===undefined){delete e[a]}else if(typeof o!=="string"){throw new i("Value for '"+a+"' must be a string","Chip")}else{e[a]=o}}else{r.warning(this+": ignoring unknown configuration parameter "+a,null,"Chip")}}}};this.toAbsoluteUrl=function(e){return t.absoluteUrl(e,f)};this.toString=function(e){var t=['Chip({sChipUrl:"',f,'"'];if(e){t.push(",oAlterEgo:",JSON.stringify(o),",oBags:",l.toString(),",oDefinition:",JSON.stringify(g))}t.push("})");return t.join("")};this.isInitiallyDefined=function(e){return e}.bind(null,o&&!o.hasOwnProperty("$proxy"));this._setDefinition=function(e){g=e};if(!o){throw new i("Missing CHIP description","Chip")}f=t.absoluteUrl(o.url);if(o.remoteCatalogId){w=p.createCatalog(o.remoteCatalogId);if(!o.url){w.registerChip(this)}}v(o.ChipBags&&o.ChipBags.results);r.debug("Created: "+this,null,"Chip")};p.addContract=function(e,t){if(u(e)){throw new i("Cannot register contract '"+e+"' twice","Chip")}o[e]=t};p.removeContract=function(e){delete o[e]};if(!o.navigation){p.addContract("navigation",function(e){this.navigateToUrl=function(e,t){throw new i("'navigation' contract not implemented!")}})}return p});
//# sourceMappingURL=Chip.js.map