/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["@sap/cds-compiler","fs","path","prettier","sap/base/Log","sap/base/util/merge","sap/fe/core/buildingBlocks/BuildingBlockRuntime","sap/fe/core/converters/ConverterContext","sap/fe/core/services/SideEffectsServiceFactory","sap/fe/core/TemplateModel","sap/ui/base/BindingParser","sap/ui/core/Component","sap/ui/core/InvisibleText","sap/ui/core/util/serializer/Serializer","sap/ui/core/util/XMLPreprocessor","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/preprocessors/XmlPreprocessor","sap/ui/fl/initial/_internal/Storage","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/lib/_MetadataRequestor","sap/ui/model/odata/v4/ODataMetaModel","xpath"],function(e,t,r,n,a,o,i,c,s,u,l,f,m,p,d,v,g,y,h,b,x,P,w){"use strict";var C={};var j=i.registerBuildingBlock;var S=n.format;function O(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=k(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var n=0;var a=function(){};return{s:a,n:function(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o=true,i=false,c;return{s:function(){r=r.call(e)},n:function(){var e=r.next();o=e.done;return e},e:function(e){i=true;c=e},f:function(){try{if(!o&&r.return!=null)r.return()}finally{if(i)throw c}}}}function M(e){return I(e)||B(e)||k(e)||A()}function A(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function B(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function I(e){if(Array.isArray(e))return E(e)}function T(e,t){return L(e)||D(e,t)||k(e,t)||F()}function F(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function k(e,t){if(!e)return;if(typeof e==="string")return E(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return E(e,t)}function E(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function D(e,t){var r=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(r==null)return;var n=[];var a=true;var o=false;var i,c;try{for(r=r.call(e);!(a=(i=r.next()).done);a=true){n.push(i.value);if(t&&n.length===t)break}}catch(e){o=true;c=e}finally{try{if(!a&&r["return"]!=null)r["return"]()}finally{if(o)throw c}}return n}function L(e){if(Array.isArray(e))return e}function R(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function X(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?R(Object(r),!0).forEach(function(t){z(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):R(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function z(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}var N=function(e,t){try{var r='<root><core:Fragment fragmentName="'.concat(e,'" type="XML" xmlns:core="sap.ui.core" /></root>');var n=new window.DOMParser;var a=n.parseFromString(r,"text/xml");var o={models:{},bindingContexts:{}};for(var i in t){var c=new b;c.setData(t[i]);o.models[i]=c;o.bindingContexts[i]=o.models[i].createBindingContext("/")}return Promise.resolve(d.process(a.firstElementChild,{name:e},o)).then(function(e){var t=e.getElementsByTagName("core:Fragment");if((t===null||t===void 0?void 0:t.length)>0){var r=O(t),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;a.innerHTML=""}}catch(e){r.e(e)}finally{r.f()}}var o=e.children.length>1?e.outerHTML:e.innerHTML;return V(o,{filter:function(e){return e.type!=="Comment"}})})}catch(e){return Promise.reject(e)}};C.processFragment=N;var V=require("xml-formatter");a.setLevel(1,"sap.ui.core.util.XMLPreprocessor");jest.setTimeout(4e4);var H={macros:"sap.fe.macros",macro:"sap.fe.macros",macroField:"sap.fe.macros.field",macrodata:"http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",log:"http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",unittest:"http://schemas.sap.com/sapui5/preprocessorextension/sap.fe.unittesting/1",control:"sap.fe.core.controls",core:"sap.ui.core",m:"sap.m",f:"sap.ui.layout.form",internalMacro:"sap.fe.macros.internal",mdc:"sap.ui.mdc",mdcat:"sap.ui.mdc.actiontoolbar",mdcField:"sap.ui.mdc.field",mdcTable:"sap.ui.mdc.table",u:"sap.ui.unified",macroMicroChart:"sap.fe.macros.microchart",microChart:"sap.suite.ui.microchart",macroTable:"sap.fe.macros.table"};var q=w.useNamespaces(H);var _=function(e){j(e)};C.registerMacro=_;var J=function(e){d.plugIn(null,e.namespace,e.name);if(e.publicNamespace){d.plugIn(null,e.publicNamespace,e.name)}};C.unregisterMacro=J;var U=function(e,t){return q(e,t)};expect.extend({toHaveControl:function(e,t){var r=U("/root".concat(t),e);return{message:function(){var r=Q(e);return"did not find controls matching ".concat(t," in generated xml:\n ").concat(r)},pass:r&&r.length>=1}},toNotHaveControl:function(e,t){var r=U("/root".concat(t),e);return{message:function(){var r=Q(e);return"There is a control matching ".concat(t," in generated xml:\n ").concat(r)},pass:r&&r.length===0}}});C.runXPathQuery=U;var W=function(e){if(Array.isArray(e)){e=e.join("")}var t=$(e);t=t.replace(/uid--id-[0-9]{13}-[0-9]{1,2}/g,"uid--id");return t};C.formatBuildingBlockXML=W;var K=function(e,t,r){var n="string(/root".concat(e,"/@").concat(t,")");return U(n,r)};C.getControlAttribute=K;var Q=function(e){var t=new window.XMLSerializer;var r=t.serializeToString(e);return $(r)};C.serializeXML=Q;var $=function(e){return S(e,{parser:"xml",xmlWhitespaceSensitivity:"ignore"})};C.formatXML=$;var G=function(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:r.basename(e).replace(".cds",".xml");var o=t.readFileSync(e,"utf-8");var i=Y(o,"sap.fe.test.JestService",n);var c=r.resolve(e,"..","gen");var s=r.resolve(c,a);t.mkdirSync(c,{recursive:true});t.writeFileSync(s,i);return s};C.compileCDS=G;function Y(r){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"sap.fe.test.JestService";var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var o={"source.cds":r};if(r.includes("'@sap/cds/common'")){o["common.cds"]=t.readFileSync(require.resolve("@sap/cds/common.cds"),"utf-8")}var i=e.compileSources(o,{});var c=X(X({odataForeignKeys:true,odataFormat:"structured",odataContainment:false},a),{},{service:n});var s=e.to.edmx(i,c);if(!s){throw new Error("Compilation failed. Hint: Make sure that the CDS model defines service ".concat(n,"."))}return s}C.cds2edmx=Y;var Z=function(e){try{var t={scopeObject:{},scopeType:"",settings:{}};return Promise.resolve((new s).createInstance(t).then(function(t){var r=t.getInterface();r.getContext=function(){return{scopeObject:{getModel:function(){return{getMetaModel:function(){return e}}}}}};return r}))}catch(e){return Promise.reject(e)}};C.getFakeSideEffectsService=Z;var ee=function(){var e=[];return{addIssue:function(t,r,n){e.push({issueCategory:t,issueSeverity:r,details:n})},getIssues:function(){return e},checkIfIssueExists:function(t,r,n){return e.find(function(e){return e.issueCategory===t&&e.issueSeverity===r&&e.details===n})}}};C.getFakeDiagnostics=ee;var te=function(e,t){var r=e.entitySets.find(function(e){return e.name===t.entitySet});var n=ae(r,e,r);return new c(e,t,ee(),o,n)};C.getConverterContextForTest=te;var re={};var ne=function(e){try{function n(){return re[e]}var t=x.create({},"4.0",{});var r=function(){if(!re[e]){var r=new P(t,e,undefined,null);return Promise.resolve(r.fetchEntityContainer()).then(function(){re[e]=r})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(a){return Promise.reject(a)}};C.getMetaModel=ne;var ae=function(e,t,r){var n={startingEntitySet:e,navigationProperties:[],targetObject:r,targetEntitySet:e,targetEntityType:e.entityType,convertedTypes:t};n.contextLocation=n;return n};C.getDataModelObjectPathForProperty=ae;var oe=function(e){var t=l.complexParser(e);for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++){n[a-1]=arguments[a]}return t.formatter.apply(undefined,n)};C.evaluateBinding=oe;function ie(e,t,r){var n=l.complexParser(e);var a=new m;a.bindProperty("text",n);var o=new b(t);a.setModel(o);a.setBindingContext(o.createBindingContext("/"));if(r){for(var i=0,c=Object.entries(r);i<c.length;i++){var s=T(c[i],2),u=s[0],f=s[1];var p=new b(f);a.setModel(p,u);a.setBindingContext(p.createBindingContext("/"),u)}}return a.getText()}C.evaluateBindingWithModel=ie;var ce="testViewId";var se=function(e,t,r,n){try{var a=n(ce,e);var o="someComponent";var i={"sap.app":{id:o,type:"application",crossNavigation:{outbounds:[]}}};var c={getDiagnostics:jest.fn().mockReturnValue(ee()),getModel:jest.fn().mockReturnValue({getMetaModel:jest.fn().mockReturnValue(t)}),getComponentData:jest.fn().mockReturnValue({}),getManifestObject:jest.fn().mockReturnValue({getEntry:function(e){return i[e]}})};jest.spyOn(y,"loadFlexData").mockReturnValue(Promise.resolve(a));jest.spyOn(f,"get").mockReturnValue(c);jest.spyOn(h,"getAppComponentForControl").mockReturnValue(c);return Promise.resolve(v.initialize({componentId:o})).then(function(){return Promise.resolve(g.process(r,{name:"Test Fragment",componentId:o,id:ce})).then(function(e){r=e;return r})})}catch(e){return Promise.reject(e)}};C.applyFlexChanges=se;var ue=function(e){return M(e.querySelectorAll("*")).flatMap(function(e){return M(e.attributes).map(function(e){return e.name})}).filter(function(e){return e.includes("sap.ui.fl.appliedChanges")})};C.getChangesFromXML=ue;var le=function(e,t,r,n,a,o){try{var i="<root>".concat(e,"</root>");var c=new window.DOMParser;var s=c.parseFromString(i,"text/xml");return Promise.resolve(ne(t)).then(function(e){if(!n.hasOwnProperty("converterContext")){n=Object.assign(n,{converterContext:new u({},e)})}Object.keys(n).forEach(function(t){if(n[t]&&n[t].isTemplateModel){n[t]=new u(n[t].data,e)}});var t={models:Object.assign({metaModel:e},n),bindingContexts:{}};Object.keys(r).forEach(function(a){expect(typeof e.getObject(r[a])).toBeDefined();var o=n[a]||e;t.bindingContexts[a]=o.createBindingContext(r[a]);t.models[a]=o});if(t.models["this"]){t.bindingContexts["this"]=t.models["this"].createBindingContext("/")}return Promise.resolve(d.process(s.firstElementChild,{name:"Test Fragment"},t)).then(function(t){var r=function(){if(a&&o){M(t.querySelectorAll("[id]")).forEach(function(e){e.id="".concat(ce,"--").concat(e.id)});return Promise.resolve(se(a,e,t,o)).then(function(e){t=e;var r=ue(t);expect(r.length).toBe(a.length)})}}();return r&&r.then?r.then(function(){return t}):t})})}catch(e){return Promise.reject(e)}};C.getTemplatingResult=le;var fe=function(e,t,r,n,a,o){try{return Promise.resolve(le(e,t,r,n,a,o)).then(Q)}catch(e){return Promise.reject(e)}};C.getTemplatedXML=fe;function me(e){var t=0;function r(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var r="";for(var n=0;n<t+e;n++){r+="\t"}return r}var n={start:function(e,t){var n="";if(t){if(e.getParent()){var a=e.getParent().getAggregation(t).indexOf(e);if(a>0){n+=",\n".concat(r())}}}n+="".concat(e.getMetadata().getName(),"(");return n},end:function(){return"})"},middle:function(e){var t="{id: ".concat(e.getId());for(var n in e.mProperties){if(e.mProperties.hasOwnProperty(n)){t+=",\n".concat(r()," ").concat(n,": ").concat(e.mProperties[n])}else if(e.mBindingInfos.hasOwnProperty(n)){var a=e.mBindingInfos[n];t+=",\n".concat(r()," ").concat(n,": formatter(").concat(a.parts.map(function(e){return"\n".concat(r(1)).concat(e.model?e.model:"",">").concat(e.path)}),")")}}for(var o in e.mAssociations){if(e.mAssociations.hasOwnProperty(o)){t+=",\n".concat(r()," ").concat(o,": ").concat(e.mAssociations[o][0])}}t+="";return t},startAggregation:function(e,n){var a=",\n".concat(r()).concat(n);t++;if(e.mBindingInfos[n]){a+="={ path:'".concat(e.mBindingInfos[n].path,"', template:\n").concat(r())}else{a+="=[\n".concat(r())}return a},endAggregation:function(e,n){t--;if(e.mBindingInfos[n]){return"\n".concat(r(),"}")}else{return"\n".concat(r(),"]")}}};if(Array.isArray(e)){return e.map(function(e){return new p(e,n).serialize()})}else{return new p(e,n).serialize()}}C.serializeControl=me;function pe(){var e;var t=new Promise(function(t){e=t});return{promise:t,resolve:e}}C.createAwaiter=pe;return C},false);
//# sourceMappingURL=JestTemplatingHelper.js.map