/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/BaseController","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/Placeholder","sap/fe/core/helpers/ClassSupport","sap/fe/macros/table/TableSizeHelper","sap/ui/base/BindingParser","sap/ui/core/routing/HashChanger","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/AnnotationHelper"],function(e,t,r,n,o,a,i,c,s,u){"use strict";var l,f,h,p,g;var d=o.usingExtension;var v=o.defineUI5Class;function m(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=y(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var n=0;var o=function(){};return{s:o,n:function(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,i=false,c;return{s:function(){r=r.call(e)},n:function(){var e=r.next();a=e.done;return e},e:function(e){i=true;c=e},f:function(){try{if(!a&&r.return!=null)r.return()}finally{if(i)throw c}}}}function y(e,t){if(!e)return;if(typeof e==="string")return b(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return b(e,t)}function b(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function P(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function C(e,t,r,n){if(!r)return;Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}function R(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function T(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;_(e,t)}function _(e,t){_=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return _(e,t)}function M(e,t,r,n,o){var a={};Object.keys(n).forEach(function(e){a[e]=n[e]});a.enumerable=!!a.enumerable;a.configurable=!!a.configurable;if("value"in a||a.initializer){a.writable=true}a=r.slice().reverse().reduce(function(r,n){return n(e,t,r)||r},a);if(o&&a.initializer!==void 0){a.value=a.initializer?a.initializer.call(o):void 0;a.initializer=undefined}if(a.initializer===void 0){Object.defineProperty(e,t,a);a=null}return a}function H(e,t){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}var w=(l=v("sap.fe.core.rootView.RootViewBaseController"),f=d(n),l(h=(p=function(t){T(n,t);function n(){var e;for(var r=arguments.length,n=new Array(r),o=0;o<r;o++){n[o]=arguments[o]}e=t.call.apply(t,[this].concat(n))||this;C(e,"oPlaceholder",g,R(e));e.bIsComputingTitleHierachy=false;return e}var o=n.prototype;o.onInit=function e(){a.init();this._aHelperModels=[]};o.getPlaceholder=function e(){return this.oPlaceholder};o.attachRouteMatchers=function e(){this.oPlaceholder.attachRouteMatchers();this.getAppComponent().getRoutingService().attachAfterRouteMatched(this._onAfterRouteMatched,this)};o.onExit=function e(){this.getAppComponent().getRoutingService().detachAfterRouteMatched(this._onAfterRouteMatched,this);this.oRouter=undefined;a.exit();this._aHelperModels.forEach(function(e){e.destroy()})};o.getResourceBundle=function e(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()};o.getRouter=function e(){if(!this.oRouter){this.oRouter=this.getAppComponent().getRouter()}return this.oRouter};o._createHelperModel=function e(){var t=new s;this._aHelperModels.push(t);return t};o.waitForRightMostViewReady=function e(t){return new Promise(function(e){var r=t.getParameter("views"),n=[];r.forEach(function(e){var t=e;if(e&&e.getComponentInstance){var r=e.getComponentInstance();t=r.getRootControl()}if(t&&t.getController()&&t.getController().pageReady){n.push(t)}});var o=n[n.length-1];if(o&&o.getController().pageReady.isPageReady()){e(o)}else if(o){o.getController().pageReady.attachEventOnce("pageReady",function(){e(o)})}})};o._onAfterRouteMatched=function t(r){var n=this;if(!this._oRouteMatchedPromise){this._oRouteMatchedPromise=this.waitForRightMostViewReady(r).then(function(e){var t=n.getView().getContent()[0];if(t&&t.getAutoFocus&&!t.getAutoFocus()){t.setProperty("autoFocus",true,true)}var r=n.getAppComponent();n._scrollTablesToLastNavigatedItems();if(r.getEnvironmentCapabilities().getCapabilities().UShell){n._computeTitleHierarchy(e)}var o=r.getRouterProxy().isFocusForced();r.getRouterProxy().setFocusForced(false);if(e.getController()&&e.getController().onPageReady&&e.getParent().onPageReady){e.getParent().onPageReady({forceFocus:o})}if(n.onContainerReady){n.onContainerReady()}}).catch(function(t){e.error("An error occurs while computing the title hierarchy and calling focus method",t)}).finally(function(){n._oRouteMatchedPromise=null})}};o._getTitleHierarchyCache=function e(){if(!this.oTitleHierarchyCache){this.oTitleHierarchyCache={}}return this.oTitleHierarchyCache};o._computeTitleInfo=function e(t,r,n){var o=n.split("/");if(o[o.length-1].indexOf("?")===-1){n+="?restoreHistory=true"}else{n+="&restoreHistory=true"}return{title:t,subtitle:r,intent:n,icon:""}};o._formatTitle=function e(t,r,n){var o="";switch(t){case"Value":o="".concat(r);break;case"ValueDescription":o="".concat(r," (").concat(n,")");break;case"DescriptionValue":o="".concat(n," (").concat(r,")");break;case"Description":o="".concat(n);break;default:}return o};o._fetchTitleValue=function t(n){try{var o=false;var a=this;var c=a.getAppComponent(),s=a.getView().getModel(),l=c.getMetaModel(),f=l.getMetaPath(n),h=s.createBindingContext(n),p=u.format(l.getObject("".concat(f,"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value")),{context:l.createBindingContext("/")});if(!p){return Promise.resolve("")}var g=u.format(l.getObject("".concat(f,"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value/$Path@com.sap.vocabularies.Common.v1.Text")),{context:l.createBindingContext("/")}),d=l.getObject("".concat(f,"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value/$Path@")),v=[],m=i.complexParser(p),y=new Promise(function(e){var t=r.computeDisplayMode(d);e(t)});v.push(y);var b=m.parts?m.parts[0].path:m.path,C=m.formatter,R=s.bindProperty(b,h);R.initialize();var T=new Promise(function(e){var t=function(r){var n=C?C(r.getSource().getValue()):r.getSource().getValue();R.detachChange(t);e(n)};R.attachChange(t)});v.push(T);if(g){var _=i.complexParser(g);var M=_.parts?_.parts[0].path:_.path;M=b.lastIndexOf("/")>-1?"".concat(b.slice(0,b.lastIndexOf("/")),"/").concat(M):M;var H=_.formatter,w=s.bindProperty(M,h);w.initialize();var I=new Promise(function(e){var t=function(r){var n=H?H(r.getSource().getValue()):r.getSource().getValue();w.detachChange(t);e(n)};w.attachChange(t)});v.push(I)}var A=P(function(){return Promise.resolve(Promise.all(v)).then(function(e){var t="";if(typeof e!=="string"){t=a._formatTitle(e[0],e[1],e[2])}o=true;return t})},function(t){e.error("Error while fetching the title from the header info :"+t)});return Promise.resolve(A&&A.then?A.then(function(e){return o?e:""}):o?A:"")}catch(e){return Promise.reject(e)}};o._getAppSpecificHash=function e(){return c.getInstance().hrefForAppSpecificHash?c.getInstance().hrefForAppSpecificHash(""):""};o._getHash=function e(){return c.getInstance().getHash()};o.getTitleInfoFromPath=function e(t){var r=this;var n=this._getTitleHierarchyCache();if(n[t]){return Promise.resolve(n[t])}var o=this.getAppComponent().getMetaModel();var a=o.getMetaPath(t);var i=o.getObject("".concat(a,"/@com.sap.vocabularies.UI.v1.HeaderInfo/TypeName"));var c=this._getAppSpecificHash();var s=c+t.slice(1);return this._fetchTitleValue(t).then(function(e){var o=r._computeTitleInfo(i,e,s);n[t]=o;return o})};o._ensureHierarchyElementsAreStrings=function e(t){var r=[];for(var n in t){var o=t[n];var a={};for(var i in o){a[i]=typeof o[i]!=="string"?String(o[i]):o[i]}r.push(a)}return r};o._getTargetTypeFromHash=function e(t){var r=this.getAppComponent();var n="";var o=r.getManifestEntry("/sap.ui5/routing/routes");var a=m(o),i;try{for(a.s();!(i=a.n()).done;){var c=i.value;var s=r.getRouter().getRoute(c.name);if(s.match(t)){var u=Array.isArray(c.target)?c.target[0]:c.target;n=r.getRouter().getTarget(u)._oOptions.name;break}}}catch(e){a.e(e)}finally{a.f()}return n};o._computeTitleHierarchy=function t(r){var n=this;var o=this.getAppComponent(),a=r.getBindingContext(),i=r.getParent(),c=[],s=this._getAppSpecificHash(),u=o.getMetadata().getManifestEntry("sap.app").title||"",l=o.getMetadata().getManifestEntry("sap.app").appSubTitle||"";var f,h;if(i&&i._getPageTitleInformation){if(a){if(this._getTargetTypeFromHash("")==="sap.fe.templates.ListReport"){c.push(Promise.resolve(this._computeTitleInfo(u,l,s)))}h=a.getPath();var p=h.split("/");var g="";p.shift();p.pop();p.forEach(function(e){g+="/".concat(e);var t=o.getMetaModel(),r=t.getMetaPath(g),a=t.getObject("".concat(r,"/@com.sap.vocabularies.Common.v1.ResultContext"));if(!a){c.push(n.getTitleInfoFromPath(g))}})}f=i._getPageTitleInformation();f=this._computeTitleInfo(f.title,f.subtitle,s+this._getHash());if(a){this._getTitleHierarchyCache()[h]=f}else{this._getTitleHierarchyCache()[s]=f}}else{c.push(Promise.reject("Title information missing in HeaderInfo"))}return Promise.all(c).then(function(e){var t=n._ensureHierarchyElementsAreStrings(e),r=f.title;t.reverse();o.getShellServices().setHierarchy(t);o.getShellServices().setTitle(r)}).catch(function(t){e.error(t)}).finally(function(){n.bIsComputingTitleHierachy=false}).catch(function(t){e.error(t)})};o.calculateLayout=function e(t,r,n){var o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return null};o.onContextBoundToView=function e(t){if(t){var r=this.getView().getModel("internal").getProperty("/deepestPath"),n=t.getPath();if(!r||r.indexOf(n)!==0){this.getView().getModel("internal").setProperty("/deepestPath",n,undefined,true)}}};o.displayMessagePage=function e(t,r){return Promise.resolve(true)};o.updateUIStateForView=function e(t,r){};o.getInstancedViews=function e(){return[]};o._scrollTablesToLastNavigatedItems=function e(){};o.getAppContentContainer=function e(t){var r=this.getAppComponent();var n=r.getManifestEntry("/sap.ui5/routing/config/controlId")||"appContent";return t.byId(n)};return n}(t),g=M(p.prototype,"oPlaceholder",[f],{configurable:true,enumerable:true,writable:true,initializer:null}),p))||h);return w},false);
//# sourceMappingURL=RootViewBaseController.js.map