/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/ListReport/VisualFilters","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","../../ManifestSettings","../Common/DataVisualization"],function(e,t,i,n,r,a,o,l,v){"use strict";var u={};var s=v.getSelectionVariant;var d=l.AvailabilityType;var c=a.getExpressionFromAnnotation;var f=a.compileExpression;var p=r.KeyHelper;var g=n.IssueType;var y=n.IssueSeverity;var m=n.IssueCategory;var h=i.Placement;var b=i.insertCustomElements;var P=t.getVisualFilters;var F=e.isFilteringCaseSensitive;var S=e.getTypeConfig;var E=e.getSelectionVariantConfiguration;function T(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function O(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?T(Object(i),!0).forEach(function(t){x(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):T(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function x(e,t,i){if(t in e){Object.defineProperty(e,t,{value:i,enumerable:true,configurable:true,writable:true})}else{e[t]=i}return e}var D;(function(e){e["Default"]="Default";e["Slot"]="Slot"})(D||(D={}));var C="Edm.String";var I="sap.ui.model.odata.type.String";function j(e){var t={};e.Data.forEach(function(i){if(i.$Type==="com.sap.vocabularies.UI.v1.DataField"){var n,r;t[i.Value.path]={group:e.fullyQualifiedName,groupLabel:f(c(e.Label||((n=e.annotations)===null||n===void 0?void 0:(r=n.Common)===null||r===void 0?void 0:r.Label)||e.qualifier))||e.qualifier}}});return t}function A(e){return e.reduce(function(e,t){t.propertyNames.forEach(function(t){e[t]=true});return e},{})}function w(e,t){if(t&&e.length>0){return e.every(function(e){return e.enableAnalytics&&t===e.annotation.collection})}return false}function N(e,t){var i=[];return e.map(function(e){var n=e.control.filters;var r=[];for(var a in n){if(Array.isArray(n[a].paths)){var o=n[a].paths;o.forEach(function(e){if(e&&e.annotationPath&&i.indexOf(e.annotationPath)===-1){i.push(e.annotationPath);var n=E(e.annotationPath,t);if(n){r.push(n)}}})}}return r}).reduce(function(e,t){return e.concat(t)},[])}var R=function(e,t){var i=t.split("/");var n;var r="";while(i.length){var a=i.shift();n=n?"".concat(n,"/").concat(a):a;var o=e.resolvePath(n);if(o._type==="NavigationProperty"&&o.isCollection){a+="*"}r=r?"".concat(r,"/").concat(a):a}return r};var V=function(e,t,i,n,r){var a,o,l;if(t!==undefined&&t.targetType===undefined&&(n||((a=t.annotations)===null||a===void 0?void 0:(o=a.UI)===null||o===void 0?void 0:(l=o.Hidden)===null||l===void 0?void 0:l.valueOf())!==true)){var v,u,s,g,y,m,h,b;var P=r.getAnnotationEntityType(t);return{key:p.getSelectionFieldKeyFromPath(i),annotationPath:r.getAbsoluteAnnotationPath(i),conditionPath:R(e,i),availability:((v=t.annotations)===null||v===void 0?void 0:(u=v.UI)===null||u===void 0?void 0:(s=u.HiddenFilter)===null||s===void 0?void 0:s.valueOf())===true?d.Hidden:d.Adaptation,label:f(c(((g=t.annotations.Common)===null||g===void 0?void 0:(y=g.Label)===null||y===void 0?void 0:y.valueOf())||t.name)),group:P.name,groupLabel:f(c((P===null||P===void 0?void 0:(m=P.annotations)===null||m===void 0?void 0:(h=m.Common)===null||h===void 0?void 0:(b=h.Label)===null||b===void 0?void 0:b.valueOf())||P.name))}}return undefined};function L(e){var t={"Edm.Boolean":{modelType:"Bool"},"Edm.Byte":{modelType:"Int"},"Edm.Date":{modelType:"Date"},"Edm.DateTime":{modelType:"Date"},"Edm.DateTimeOffset":{modelType:"DateTimeOffset"},"Edm.Decimal":{modelType:"Decimal"},"Edm.Double":{modelType:"Float"},"Edm.Float":{modelType:"Float"},"Edm.Guid":{modelType:"Guid"},"Edm.Int16":{modelType:"Int"},"Edm.Int32":{modelType:"Int"},"Edm.Int64":{modelType:"Int"},"Edm.SByte":{modelType:"Int"},"Edm.Single":{modelType:"Float"},"Edm.String":{modelType:"String"},"Edm.Time":{modelType:"TimeOfDay"},"Edm.TimeOfDay":{modelType:"TimeOfDay"},"Edm.Stream":{}};return e&&e in t&&t[e].modelType}u.getModelType=L;var M=function(e,t,i,n,r){var a={};if(i){i.forEach(function(i){var o=i.name;var l=(t?"".concat(t,"/"):"")+o;var v=V(e,i,l,n,r);if(v){a[l]=v}})}return a};var U=function(e,t,i,n){var r={};if(t){t.forEach(function(t){var a;var o=e.resolvePath(t);if(o===undefined){return}if(o._type==="NavigationProperty"){a=M(e,t,o.targetType.entityProperties,i,n)}else if(o.targetType!==undefined&&o.targetType._type==="ComplexType"){a=M(e,t,o.targetType.properties,i,n)}else{var l=t.includes("/")?t.split("/").splice(0,1).join("/"):"";a=M(e,l,[o],i,n)}r=O(O({},r),a)})}return r};var k=function(e,t,i,n){var r=e[t];var a=r&&r.availability;if(r){delete e[t]}else{r=V(n,n.resolvePath(t),t,true,i)}if(!r){var o;(o=i.getDiagnostics())===null||o===void 0?void 0:o.addIssue(m.Annotation,y.High,g.MISSING_SELECTIONFIELD)}if(r){var l,v;r.availability=a===d.Hidden?d.Hidden:d.Default;r.isParameter=!!((l=n.annotations)!==null&&l!==void 0&&(v=l.Common)!==null&&v!==void 0&&v.ResultContext)}return r};var q=function(e,t,i,n,r){var a=[];var o={};var l=t.entityProperties;r===null||r===void 0?void 0:r.forEach(function(e){o[e.value]=true});if(e&&e.length>0){e===null||e===void 0?void 0:e.forEach(function(e){var o=e.PropertyName;var l=o.value;var v={};r===null||r===void 0?void 0:r.forEach(function(e){v[e.value]=true});if(!(l in n)){if(!(l in v)){var u=K(l,i,t);if(u){a.push(u)}}}})}else if(l){l.forEach(function(e){var r,l;var v=(r=e.annotations)===null||r===void 0?void 0:(l=r.Common)===null||l===void 0?void 0:l.FilterDefaultValue;var u=e.name;if(!(u in n)){if(v&&!(u in o)){var s=K(u,i,t);if(s){a.push(s)}}}})}return a};function $(e){var t,i;var n=e.getDataModelObjectPath();var r=n.startingEntitySet.entityType;var a=!!((t=r.annotations)!==null&&t!==void 0&&(i=t.Common)!==null&&i!==void 0&&i.ResultContext)&&!n.targetEntitySet;var o=a&&e.getConverterContextFor("/".concat(n.startingEntitySet.name));return o?r.entityProperties.map(function(e){return k({},e.name,o,r)}):[]}var B=function(e,t,i){var n=t.length===0||t.every(function(e){return!e.applySupported.enableSearch});var r=e.length===0||e.every(function(e){return e.enableAnalytics&&!e.enableAnalyticsSearch});var a=i.getContextPath();if(a&&n&&r){return true}else{return false}};u.getFilterBarhideBasicSearch=B;var H=function(e,t){var i=t.getManifestWrapper().getFilterConfiguration();var n=(i===null||i===void 0?void 0:i.filterFields)||{};var r=U(e,Object.keys(n).map(function(e){return p.getPathFromSelectionFieldKey(e)}),true,t);var a={};for(var o in n){var l=n[o];var v=p.getPathFromSelectionFieldKey(o);var u=r[v];var s=l.type==="Slot"?D.Slot:D.Default;var c=l&&l!==null&&l!==void 0&&l.visualFilter?P(e,t,o,n):undefined;a[o]={key:o,type:s,annotationPath:u===null||u===void 0?void 0:u.annotationPath,conditionPath:(u===null||u===void 0?void 0:u.conditionPath)||v,template:l.template,label:l.label,position:l.position||{placement:h.After},availability:l.availability||d.Default,settings:l.settings,visualFilter:c,required:l.required}}return a};u.getManifestFilterFields=H;var K=function(e,t,i){return k({},e,t,i)};u.getFilterField=K;var J=function(e,t){if(t==="RequiredProperties"||t==="NonFilterableProperties"){var i=[];if(e&&e[t]){i=e[t].map(function(e){return e.$PropertyPath||e.value})}return i}else if(t==="FilterAllowedExpressions"){var n={};if(e&&e.FilterExpressionRestrictions){e.FilterExpressionRestrictions.forEach(function(e){if(n[e.Property.value]){n[e.Property.value].push(e.AllowedExpressions)}else{n[e.Property.value]=[e.AllowedExpressions]}})}return n}return e};u.getFilterRestrictions=J;var W=function(){return{name:"$search",path:"$search",dataType:I,maxConditions:1}};var G=function(){return{name:"$editState",path:"$editState",groupLabel:"",group:"",dataType:I,hiddenFilter:false}};var _=function(e){var t;if(!o.isSingleton(e.getEntitySet())){var i,n;var r=(i=e.getEntitySet())===null||i===void 0?void 0:(n=i.annotations)===null||n===void 0?void 0:n.Capabilities;t=r===null||r===void 0?void 0:r.SearchRestrictions}return t};var z=function(e,t){var i,n,r;var a=(i=e.getEntitySet())===null||i===void 0?void 0:(n=i.annotations)===null||n===void 0?void 0:(r=n.Capabilities)===null||r===void 0?void 0:r.NavigationRestrictions;var o=a&&a.RestrictedProperties;return o&&o.find(function(e){return e&&e.NavigationProperty&&(e.NavigationProperty.$NavigationPropertyPath===t||e.NavigationProperty.value===t)})};u.getNavigationRestrictions=z;var Q=function(e){return{key:e.key,annotationPath:e.annotationPath,conditionPath:e.conditionPath,name:e.conditionPath,label:e.label,hiddenFilter:e.availability==="Hidden",display:"Value",isParameter:e.isParameter,caseSensitive:e.caseSensitive,availability:e.availability,position:e.position,type:e.type,template:e.template,menu:e.menu,required:e.required}};var X=function(e){var t=["SingleValue","MultiValue","SingleRange","MultiRange","SearchExpression","MultiRangeOrSearchExpression"];e.sort(function(e,i){return t.indexOf(e)-t.indexOf(i)});return e[0]};u.getSpecificAllowedExpression=X;var Y=function(e,t){var i,n,r,a,o,l;var v=e===null||e===void 0?void 0:(i=e.Common)===null||i===void 0?void 0:i.Text,u=v&&(e&&(e===null||e===void 0?void 0:(n=e.Common)===null||n===void 0?void 0:(r=n.Text)===null||r===void 0?void 0:(a=r.annotations)===null||a===void 0?void 0:(o=a.UI)===null||o===void 0?void 0:o.TextArrangement)||t&&(t===null||t===void 0?void 0:(l=t.UI)===null||l===void 0?void 0:l.TextArrangement));if(u){if(u.valueOf()==="UI.TextArrangementType/TextOnly"){return"Description"}else if(u.valueOf()==="UI.TextArrangementType/TextLast"){return"ValueDescription"}return"DescriptionValue"}return v?"DescriptionValue":"Value"};u.displayMode=Y;var Z=function(e,t,i){var n;var r=Q(t);var a=t.annotationPath;if(!a){return r}var o=e.getConverterContextFor(a).getDataModelObjectPath().targetObject;var l=o===null||o===void 0?void 0:o.annotations;var v=e===null||e===void 0?void 0:(n=e.getDataModelObjectPath().targetObject)===null||n===void 0?void 0:n.annotations;var u=i.formatOptions;var s=i.constraints;r=Object.assign(r,{formatOptions:u,constraints:s,display:Y(l,v)});return r};u.fetchPropertyInfo=Z;var ee=function(e){var t=true;switch(e.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":t=false;break;default:break}if(e.type&&e.type.indexOf("Boolean")>0){t=false}return t};u.isMultiValue=ee;var te=function(e){return(e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath")&&e.Value.path.includes("/")};var ie=function(e){var t,i,n;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";var o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var l=arguments.length>4?arguments[4]:undefined;var v=N(r,e);var u=A(v);var d=e.getEntityType();var c=a&&((t=e.getEntityTypeAnnotation(a))===null||t===void 0?void 0:t.annotation)||((i=d.annotations)===null||i===void 0?void 0:(n=i.UI)===null||n===void 0?void 0:n.SelectionFields)||[];var f=[];if(r.length===0&&!!l){var p;(p=e.getEntityTypeAnnotation(l).annotation)===null||p===void 0?void 0:p.forEach(function(e){if(te(e)){if(!f.includes(e.Value.path.split("/")[0])){f.push(e.Value.path.split("/")[0])}}})}var g=O(O(O({},M(d,"",d.entityProperties,o,e)),U(d,f,false,e)),U(d,e.getManifestWrapper().getFilterConfiguration().navigationProperties,o,e));var y=[];var m=s(d,e);if(m){y=m.SelectOptions}var h=(c===null||c===void 0?void 0:c.reduce(function(t,i){var n=i.value;if(!(n in u)){var r;if(a.startsWith("@com.sap.vocabularies.UI.v1.SelectionFields")){r=""}else{r=a.split("/@com.sap.vocabularies.UI.v1.SelectionFields")[0]}var o=r?r+"/"+n:n;var l=k(g,o,e,d);if(l){l.group="";l.groupLabel="";t.push(l)}}return t},[]))||[];var b=q(y,d,e,u,c);return{excludedFilterProperties:u,entityType:d,annotatedSelectionFields:c,filterFields:g,propertyInfoFields:h,defaultFilterFields:b}};var ne=function(e){var t=S(e,e===null||e===void 0?void 0:e.type);if((e===null||e===void 0?void 0:e.type)===C&&(t.constraints.nullable===undefined||t.constraints.nullable===true)){t.formatOptions.parseKeepsEmptyString=false}return t};u.fetchTypeConfig=ne;var re=function(e,t,i,n){var r=Z(t,e,n[e.key]),a="";if(e.conditionPath){a=e.conditionPath.replace(/\+|\*/g,"")}if(r){var o;r=Object.assign(r,{maxConditions:!r.isParameter&&ee(r)?-1:1,required:(o=e.required)!==null&&o!==void 0?o:r.isParameter||i.indexOf(a)>=0,caseSensitive:F(t),dataType:n[e.key].type})}return r};u.assignDataTypeToPropertyInfo=re;var ae=function(e,t,i){var n=[];var r={};if(i){e=e.concat(i)}e.forEach(function(e){if(e.annotationPath){var i=t.getConverterContextFor(e.annotationPath);var a=i.getDataModelObjectPath().targetObject;n.push(a===null||a===void 0?void 0:a.type);var o=ne(a);r[e.key]=o}else{n.push(C);r[e.key]={type:I}}});var a;if(!o.isSingleton(t.getEntitySet())){var l,v,u;a=(l=t.getEntitySet())===null||l===void 0?void 0:(v=l.annotations)===null||v===void 0?void 0:(u=v.Capabilities)===null||u===void 0?void 0:u.FilterRestrictions}var s=a;var d={};d["RequiredProperties"]=J(s,"RequiredProperties")||[];d["NonFilterableProperties"]=J(s,"NonFilterableProperties")||[];d["FilterAllowedExpressions"]=J(s,"FilterAllowedExpressions")||{};var c=t.getContextPath();var f=c.split("/");if(f.length>2){var p=f[f.length-1];f.splice(-1,1);var g=z(t,p);var y=g&&g.FilterRestrictions;d.RequiredProperties.concat(J(y,"RequiredProperties")||[]);d.NonFilterableProperties.concat(J(y,"NonFilterableProperties")||[]);d.FilterAllowedExpressions=O(O({},J(y,"FilterAllowedExpressions")||{}),d.FilterAllowedExpressions)}var m=d.RequiredProperties;var h=d.NonFilterableProperties;var b=[];e.forEach(function(e){var i;if(h.indexOf(i)===-1){var n=re(e,t,m,r);b.push(n)}});var P=t.getDataModelObjectPath();if(o.isObjectPathDraftSupported(P)){b.push(G())}var F=_(t);var S=Boolean(F&&!F.Searchable);if(c&&S!==true){if(!F||F!==null&&F!==void 0&&F.Searchable){b.push(W())}}return b};u.processSelectionFields=ae;var oe=function(e,t,i){return b(e,H(t,i),{availability:"overwrite",label:"overwrite",type:"overwrite",position:"overwrite",template:"overwrite",settings:"overwrite",visualFilter:"overwrite",required:"overwrite"})};u.insertCustomManifestElements=oe;var le=function(e){var t,i;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";var a=arguments.length>3?arguments[3]:undefined;var o=arguments.length>4?arguments[4]:undefined;var l=ie(e,n,r,a,o);var v=$(e);var u=JSON.parse(JSON.stringify(l.propertyInfoFields));var s=l.entityType;u=v.concat(u);u=oe(u,s,e);var d=ae(u,e,l.defaultFilterFields);d.sort(function(e,t){if(e.groupLabel===undefined||e.groupLabel===null){return-1}if(t.groupLabel===undefined||t.groupLabel===null){return 1}return e.groupLabel.localeCompare(t.groupLabel)});var c=JSON.stringify(d);c=c.replace(/\{/g,"\\{");c=c.replace(/\}/g,"\\}");var f=c;var p=JSON.parse(JSON.stringify(l.propertyInfoFields));p=v.concat(p);var g=l.excludedFilterProperties;var y=s===null||s===void 0?void 0:(t=s.annotations)===null||t===void 0?void 0:(i=t.UI)===null||i===void 0?void 0:i.FilterFacets;var m={};var h=e.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.FieldGroup");if(y===undefined||y.length<0){for(var b in h){m=O(O({},m),j(h[b]))}}else{m=y.reduce(function(e,t){for(var i=0;i<(t===null||t===void 0?void 0:(n=t.Target)===null||n===void 0?void 0:(r=n.$target)===null||r===void 0?void 0:(a=r.Data)===null||a===void 0?void 0:a.length);i++){var n,r,a,o,l,v,u,s,d;e[t===null||t===void 0?void 0:(o=t.Target)===null||o===void 0?void 0:(l=o.$target)===null||l===void 0?void 0:(v=l.Data[i])===null||v===void 0?void 0:(u=v.Value)===null||u===void 0?void 0:u.path]={group:t===null||t===void 0?void 0:(s=t.ID)===null||s===void 0?void 0:s.toString(),groupLabel:t===null||t===void 0?void 0:(d=t.Label)===null||d===void 0?void 0:d.toString()}}return e},{})}var P=l.filterFields;var S=p.concat(Object.keys(P).filter(function(e){return!(e in g)}).map(function(e){return Object.assign(P[e],m[e])}));var E=e.getContextPath();if(w(n,E)){var T=n[0].aggregates;if(T){var x=Object.keys(T).map(function(e){return T[e].relativePath});S=S.filter(function(e){return x.indexOf(e.key)===-1})}}var D=oe(S,s,e);var C=F(e);D.forEach(function(e){e.caseSensitive=C});return{selectionFields:D,sPropertyInfo:f}};u.getSelectionFields=le;var ve=function(e,t,i){var n=J(t,"RequiredProperties");var r=_(e);var a=Boolean(r&&!r.Searchable);var o=i.getObject();if(n.length>0||a||(o===null||o===void 0?void 0:o.FetchValues)===2){return true}return false};u.getExpandFilterFields=ve;return u},false);
//# sourceMappingURL=FilterBar.js.map