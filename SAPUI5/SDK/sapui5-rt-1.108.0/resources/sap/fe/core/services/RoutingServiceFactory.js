/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/controllerextensions/Placeholder","sap/fe/core/helpers/AppStartupHelper","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/base/BindingParser","sap/ui/base/EventProvider","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/model/odata/v4/ODataUtils"],function(e,t,r,a,n,o,i,s,u,h,c,l,f,g){"use strict";var v,p,d,m,P,C,R;var _={};var M=o.event;var y=o.defineUI5Class;function b(e,t,r,a){if(!r)return;Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(a):void 0})}function x(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function L(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;T(e,t)}function T(e,t){T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return T(e,t)}function S(e,t,r,a,n){var o={};Object.keys(a).forEach(function(e){o[e]=a[e]});o.enumerable=!!o.enumerable;o.configurable=!!o.configurable;if("value"in o||o.initializer){o.writable=true}o=r.slice().reverse().reduce(function(r,a){return a(e,t,r)||r},o);if(n&&o.initializer!==void 0){o.value=o.initializer?o.initializer.call(n):void 0;o.initializer=undefined}if(o.initializer===void 0){Object.defineProperty(e,t,o);o=null}return o}function w(e,t){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}var E=(v=y("sap.fe.core.services.RoutingServiceEventing"),p=M(),d=M(),v(m=(P=function(e){L(t,e);function t(){var t;for(var r=arguments.length,a=new Array(r),n=0;n<r;n++){a[n]=arguments[n]}t=e.call.apply(e,[this].concat(a))||this;b(t,"routeMatched",C,x(t));b(t,"afterRouteMatched",R,x(t));return t}return t}(c),C=S(P.prototype,"routeMatched",[p],{configurable:true,enumerable:true,writable:true,initializer:null}),R=S(P.prototype,"afterRouteMatched",[d],{configurable:true,enumerable:true,writable:true,initializer:null}),P))||m);var I=function(o){L(c,o);function c(){var e;for(var t=arguments.length,r=new Array(t),a=0;a<t;a++){r[a]=arguments[a]}e=o.call.apply(o,[this].concat(r))||this;e.navigationInfoQueue=[];return e}_.RoutingService=c;var l=c.prototype;l.init=function e(){var t=this.getContext();if(t.scopeType==="component"){this.oAppComponent=t.scopeObject;this.oModel=this.oAppComponent.getModel();this.oMetaModel=this.oModel.getMetaModel();this.oRouter=this.oAppComponent.getRouter();this.oRouterProxy=this.oAppComponent.getRouterProxy();this.eventProvider=new E;var r=this.oAppComponent.getManifestEntry("/sap.ui5/routing");var a=this.oAppComponent.getManifestEntry("/sap.ui5/rootView");this._parseRoutingConfiguration(r,a);var n=this.oAppComponent.getManifestEntry("/sap.app");this.outbounds=n&&n.crossNavigation&&n.crossNavigation.outbounds}this.initPromise=Promise.resolve(this)};l.beforeExit=function e(){this.oRouter.detachRouteMatched(this._fnOnRouteMatched,this);this.eventProvider.fireEvent("routeMatched",{})};l.exit=function e(){this.eventProvider.destroy()};l._parseRoutingConfiguration=function t(r,a){var n=this;var o=(a===null||a===void 0?void 0:a.viewName)==="sap.fe.core.rootView.Fcl"||(a===null||a===void 0?void 0:a.viewName)==="sap.fe.templates.RootContainer.view.Fcl";this._mTargets={};Object.keys(r.targets).forEach(function(e){n._mTargets[e]=Object.assign({targetName:e},r.targets[e]);if(n._mTargets[e].contextPattern!==undefined){n._mTargets[e].viewLevel=n._getViewLevelFromPattern(n._mTargets[e].contextPattern,0)}});this._mRoutes={};for(var i in r.routes){var s=r.routes[i],u=Array.isArray(s.target)?s.target:[s.target],h=Array.isArray(r.routes)?s.name:i,c=s.pattern;if(c.length<8||c.indexOf(":?query:")!==c.length-8){e.warning("Pattern for route ".concat(h," doesn't end with ':?query:' : ").concat(c))}var l=this._getViewLevelFromPattern(c,0);this._mRoutes[h]={name:h,pattern:c,targets:u,routeLevel:l};for(var f=0;f<u.length;f++){var g=this._mTargets[u[f]].parent;if(g){u.push(g)}}if(!o){if(this._mTargets[u[0]].viewLevel===undefined||this._mTargets[u[0]].viewLevel<l){this._mTargets[u[0]].viewLevel=l}this._mTargets[u[0]].FCLLevel=-1}else if(u.length===1&&this._mTargets[u[0]].controlAggregation!=="beginColumnPages"){this._mTargets[u[0]].FCLLevel=3}else{u.forEach(function(e){switch(n._mTargets[e].controlAggregation){case"beginColumnPages":n._mTargets[e].FCLLevel=0;break;case"midColumnPages":n._mTargets[e].FCLLevel=1;break;default:n._mTargets[e].FCLLevel=2}})}}Object.keys(this._mTargets).forEach(function(e){while(n._mTargets[e].parent){var t=n._mTargets[e].parent;n._mTargets[t].viewLevel=n._mTargets[t].viewLevel||n._mTargets[e].viewLevel;n._mTargets[t].contextPattern=n._mTargets[t].contextPattern||n._mTargets[e].contextPattern;n._mTargets[t].FCLLevel=n._mTargets[t].FCLLevel||n._mTargets[e].FCLLevel;n._mTargets[t].controlAggregation=n._mTargets[t].controlAggregation||n._mTargets[e].controlAggregation;e=t}});var v=[];var p=[];var d;for(var m in this._mRoutes){var P=this._mRoutes[m].routeLevel;if(P===0){v.push(m)}else if(P===1){p.push(m)}}if(v.length===1){d=v[0]}else if(p.length===1){d=p[0]}if(d){var C=this._mRoutes[d].targets.slice(-1)[0];this.sContextPath="";if(this._mTargets[C].options&&this._mTargets[C].options.settings){var R=this._mTargets[C].options.settings;this.sContextPath=R.contextPath||"/".concat(R.entitySet)}if(!this.sContextPath){e.warning("Cannot determine default contextPath: contextPath or entitySet missing in default target: ".concat(C))}}else{e.warning("Cannot determine default contextPath: no default route found.")}Object.keys(this._mTargets).map(function(e){return n._mTargets[e]}).sort(function(e,t){return e.viewLevel<t.viewLevel?-1:1}).forEach(function(e){if(e.options){var t=e.options.settings;var r=t.contextPath||(t.entitySet?"/".concat(t.entitySet):"");if(!t.fullContextPath&&r){t.fullContextPath="".concat(r,"/")}Object.keys(t.navigation||{}).forEach(function(r){var a=n._mRoutes[t.navigation[r].detail.route];if(a&&a.targets){a.targets.forEach(function(a){if(n._mTargets[a].options&&n._mTargets[a].options.settings&&!n._mTargets[a].options.settings.fullContextPath){if(e.viewLevel===0){n._mTargets[a].options.settings.fullContextPath="".concat((r.startsWith("/")?"":"/")+r,"/")}else{n._mTargets[a].options.settings.fullContextPath="".concat(t.fullContextPath+r,"/")}}})}})}})};l._getViewLevelFromPattern=function e(t,r){t=t.replace(":?query:","");var a=new RegExp("/[^/]*$");if(t&&t[0]!=="/"&&t[0]!=="?"){t="/".concat(t)}if(t.length){t=t.replace(a,"");if(this.oRouter.match(t)||t===""){return this._getViewLevelFromPattern(t,++r)}else{return this._getViewLevelFromPattern(t,r)}}else{return r}};l._getRouteInformation=function e(t){return this._mRoutes[t]};l._getTargetInformation=function e(t){return this._mTargets[t]};l._getComponentId=function e(t,r){if(r.indexOf("".concat(t,"---"))===0){return r.substr(t.length+3)}return r};l.getTargetInformationFor=function e(t){var r=this;var a=this._getComponentId(t._sOwnerId,t.getId());var n=null;Object.keys(this._mTargets).forEach(function(e){if(r._mTargets[e].id===a||r._mTargets[e].viewId===a){n=e}});return this._getTargetInformation(n)};l.getLastSemanticMapping=function e(){return this.oLastSemanticMapping};l.setLastSemanticMapping=function e(t){this.oLastSemanticMapping=t};l.navigateTo=function e(t,r,a,n){var o=this;var i,h;if(t.getModel()&&t.getModel().getMetaModel&&t.getModel().getMetaModel()){h=s.isStickySessionSupported(t.getModel().getMetaModel())}if(!a){i=Promise.resolve(u.getSemanticPath(t))}else{i=this.prepareParameters(a,r,t).then(function(e){return o.oRouter.getURL(r,e)})}return i.then(function(e){o.oRouterProxy.navToHash(e,n,false,false,!h)})};l.prepareParameters=function t(r,a,n){var o=this;var i;try{var s=n.getPath();var u=n.getModel().getMetaModel();var c=s.split("/");var l=Object.keys(r).map(function(e){var t=r[e];var a=h.complexParser(t);var i=a.parts||[a];var s=i.map(function(e){var t=e.path.split("../");var r=c.slice(0,c.length-t.length+1);r.push(t[t.length-1]);var a=r.join("/");var o=u.getMetaContext(a);return n.requestProperty(a).then(function(e){var t=o.getObject();var r=t.$Type;return g.formatLiteral(e,r)})});return Promise.all(s).then(function(t){var r=a.formatter?a.formatter.apply(o,t):t.join("");return{key:e,value:r}})});i=Promise.all(l).then(function(e){var t={};e.forEach(function(e){t[e.key]=e.value});return t})}catch(t){e.error("Could not parse the parameters for the navigation to route ".concat(a));i=Promise.resolve(undefined)}return i};l._fireRouteMatchEvents=function e(t){this.eventProvider.fireEvent("routeMatched",t);this.eventProvider.fireEvent("afterRouteMatched",t);i.cleanProcessedEditState()};l.navigateToContext=function e(t,a,n,o){var i=this;var u="",h,c=false;if(t.getModel()&&t.getModel().getMetaModel){c=s.isStickySessionSupported(t.getModel().getMetaModel())}if(a&&a.targetPath&&n&&n.navigation){var l=n.navigation[a.targetPath].detail;u=l.route;if(l.parameters){h=this.prepareParameters(l.parameters,u,t)}}var f=this._getPathFromContext(t,a);if(f.length===0&&this.bExitOnNavigateBackToRoot){this.oRouterProxy.exitFromApp();return Promise.resolve(true)}if(a!==null&&a!==void 0&&a.asyncContext||a!==null&&a!==void 0&&a.bDeferredContext){f+="(...)"}var g=this._calculateLayout(f,a);if(g){f+="?layout=".concat(g)}var v={oAsyncContext:a===null||a===void 0?void 0:a.asyncContext,bDeferredContext:a===null||a===void 0?void 0:a.bDeferredContext,bTargetEditable:a===null||a===void 0?void 0:a.editable,bPersistOPScroll:a===null||a===void 0?void 0:a.bPersistOPScroll,useContext:(a===null||a===void 0?void 0:a.updateFCLLevel)===-1||a!==null&&a!==void 0&&a.bRecreateContext?undefined:t,bDraftNavigation:a===null||a===void 0?void 0:a.bDraftNavigation,bShowPlaceholder:(a===null||a===void 0?void 0:a.showPlaceholder)!==undefined?a===null||a===void 0?void 0:a.showPlaceholder:true};if(a!==null&&a!==void 0&&a.checkNoHashChange){var p=this.oRouterProxy.getHash().replace(/[&?]{1}sap-iapp-state=[A-Z0-9]+/,"");if(f===p){var d=this.oRouter.getRouteInfoByHash(this.oRouterProxy.getHash());if(d){d.navigationInfo=v;d.routeInformation=this._getRouteInformation(this.sCurrentRouteName);d.routePattern=this.sCurrentRoutePattern;d.views=this.aCurrentViews}this.oRouterProxy.setFocusForced(!!a.bForceFocus);this._fireRouteMatchEvents(d);return Promise.resolve(true)}}if(a!==null&&a!==void 0&&a.transient&&a.editable==true&&f.indexOf("(...)")===-1){if(f.indexOf("?")>-1){f+="&i-action=create"}else{f+="?i-action=create"}}if(o&&o.name==="sap.fe.templates.ListReport"){var m=this.oRouter.getRouteInfoByHash(f);if(m){var P=this._getRouteInformation(m.name);if(P&&P.targets&&P.targets.length>0){var C=P.targets[P.targets.length-1];var R=this._getTargetInformation(C);if(R&&R.name==="sap.fe.templates.ObjectPage"){r.removeUnboundTransitionMessages()}}}}this.navigationInfoQueue.push(v);if(u&&h){return h.then(function(e){e.bIsStickyMode=c;i.oRouter.navTo(u,e);return Promise.resolve(true)})}return this.oRouterProxy.navToHash(f,false,a===null||a===void 0?void 0:a.noPreservationCache,a===null||a===void 0?void 0:a.bForceFocus,!c).then(function(e){if(!e){i.navigationInfoQueue.pop()}return e})};l.navigateToRoute=function e(t,r){var a=this.oRouter.getURL(t,r);return this.oRouterProxy.navToHash(a,undefined,undefined,undefined,!r.bIsStickyMode)};l.isCurrentStateImpactedBy=function e(t){var r=t.getPath();if(this.oRouterProxy.isCurrentStateImpactedBy(r)){return true}else if(/^[^\(\)]+\([^\(\)]+\)$/.test(r)){var a;if(this.oLastSemanticMapping&&this.oLastSemanticMapping.technicalPath===r){a=this.oLastSemanticMapping.semanticPath}else{a=u.getSemanticPath(t)}return a!=r?this.oRouterProxy.isCurrentStateImpactedBy(a):false}else{return false}};l._findPathToNavigate=function e(t){var r=new RegExp("/[^/]*$");t=t.replace(r,"");if(this.oRouter.match(t)||t===""){return t}else{return this._findPathToNavigate(t)}};l._checkIfContextSupportsSemanticPath=function e(t){var r=t.getPath();if(!/^\/[^\(]+\([^\)]+\)$/.test(r)){return false}var a=t.getModel().getMetaModel();var n=a.getMetaContext(t.getPath()).getObject("@sapui.name");if(!u.getSemanticKeys(a,n)){return false}return s.isDraftSupported(a,r)};l._getPathFromContext=function e(t,r){var a;if(t.isA("sap.ui.model.odata.v4.ODataListBinding")&&t.isRelative()){a=t.getHeaderContext().getPath()}else{a=t.getPath()}if(r.updateFCLLevel===-1){a=this._findPathToNavigate(a);if(this.oLastSemanticMapping&&this.oLastSemanticMapping.technicalPath===a){a=this.oLastSemanticMapping.semanticPath}}else if(this._checkIfContextSupportsSemanticPath(t)){var n=u.getSemanticPath(t,true);if(!n){this.setLastSemanticMapping(undefined)}else if(n!==a){this.setLastSemanticMapping({technicalPath:a,semanticPath:n});a=n}}if(a[0]==="/"){a=a.substring(1)}return a};l._calculateLayout=function e(t,r){var a=r.FCLLevel;if(r.updateFCLLevel){a+=r.updateFCLLevel;if(a<0){a=0}}return this.oAppComponent.getRootViewController().calculateLayout(a,t,r.sLayout,r.keepCurrentLayout)};l._beforeRouteMatched=function e(){var r=(new a).isPlaceholderEnabled();if(!r){var n=this.oAppComponent.getRootControl();t.lock(n)}};l._onRouteMatched=function r(n){var o=this;var i=this.oAppComponent.getAppStateHandler(),s=this.oAppComponent.getRootControl();var u=(new a).isPlaceholderEnabled();if(t.isLocked(s)&&!u){t.unlock(s)}var h=n.getParameters();if(this.navigationInfoQueue.length){h.navigationInfo=this.navigationInfoQueue[0];this.navigationInfoQueue=this.navigationInfoQueue.slice(1)}else{h.navigationInfo={}}if(i.checkIfRouteChangedByIApp()){h.navigationInfo.bReasonIsIappState=true;i.resetRouteChangedByIApp()}this.sCurrentRouteName=n.getParameter("name");this.sCurrentRoutePattern=h.config.pattern;this.aCurrentViews=n.getParameter("views");h.routeInformation=this._getRouteInformation(this.sCurrentRouteName);h.routePattern=this.sCurrentRoutePattern;this._fireRouteMatchEvents(h);if(!history.state||history.state.feLevel===undefined){this.oRouterProxy.restoreHistory().then(function(){o.oRouterProxy.resolveRouteMatch()}).catch(function(t){e.error("Error while restoring history",t)})}else{this.oRouterProxy.resolveRouteMatch()}};l.attachRouteMatched=function e(t,r,a){this.eventProvider.attachEvent("routeMatched",t,r,a)};l.detachRouteMatched=function e(t,r){this.eventProvider.detachEvent("routeMatched",t,r)};l.attachAfterRouteMatched=function e(t,r,a){this.eventProvider.attachEvent("afterRouteMatched",t,r,a)};l.detachAfterRouteMatched=function e(t,r){this.eventProvider.detachEvent("afterRouteMatched",t,r)};l.getRouteFromHash=function e(t,r){var a=t.getHashChanger().hash;var n=t.getRouteInfoByHash(a);return r.getMetadata().getManifestEntry("/sap.ui5/routing/routes").filter(function(e){return e.name===n.name})[0]};l.getTargetsFromRoute=function e(t){var r=this;var a=t.target;if(typeof a==="string"){return[this._mTargets[a]]}else{var n=[];a.forEach(function(e){n.push(r._mTargets[e])});return n}};l.initializeRouting=function t(){var r=this;this._fnOnRouteMatched=this._onRouteMatched.bind(this);this.oRouter.attachRouteMatched(this._fnOnRouteMatched,this);var n=(new a).isPlaceholderEnabled();if(!n){this.oRouter.attachBeforeRouteMatched(this._beforeRouteMatched.bind(this))}this.navigationInfoQueue=[];i.resetEditState();this.bExitOnNavigateBackToRoot=!this.oRouter.match("");var o=this.oRouter.getHashChanger().getHash().indexOf("sap-iapp-state")!==-1;return this.oAppComponent.getStartupParameters().then(function(e){var t=e!==undefined&&Object.keys(e).length!==0;var a=r.oRouter.getHashChanger().getHash();if(!o&&t&&!a){if(e.preferredMode&&e.preferredMode[0].toUpperCase().indexOf("CREATE")!==-1){return r._manageCreateStartup(e)}else{return r._manageDeepLinkStartup(e)}}}).catch(function(t){e.error("Error during routing initialization",t)})};l.getDefaultCreateHash=function e(t){return n.getDefaultCreateHash(t,this.getContextPath(),this.oRouter)};l._manageCreateStartup=function e(t){var r=this;return n.getCreateStartupHash(t,this.getContextPath(),this.oRouter,this.oMetaModel).then(function(e){if(e){r.oRouter.getHashChanger().replaceHash(e);if(t!==null&&t!==void 0&&t.preferredMode&&t.preferredMode[0].toUpperCase().indexOf("AUTOCREATE")!==-1){r.oAppComponent.setStartupModeAutoCreate()}else{r.oAppComponent.setStartupModeCreate()}r.bExitOnNavigateBackToRoot=true}})};l._manageDeepLinkStartup=function e(t){var r=this;return n.getDeepLinkStartupHash(this.oAppComponent.getManifest()["sap.ui5"].routing,t,this.oModel).then(function(e){var t;if(e.context){var a=e.context.getPath();var n=r._checkIfContextSupportsSemanticPath(e.context)?u.getSemanticPath(e.context):a;if(n!==a){r.setLastSemanticMapping({technicalPath:a,semanticPath:n})}t=n.substring(1)}else if(e.hash){t=e.hash}if(t){r.oRouter.getHashChanger().replaceHash(t);r.oAppComponent.setStartupModeDeeplink()}})};l.getOutbounds=function e(){return this.outbounds};l.getContextPath=function e(){return this.sContextPath};l.getInterface=function e(){return this};return c}(l);_.RoutingService=I;var A=function(e){L(t,e);function t(){return e.apply(this,arguments)||this}var r=t.prototype;r.createInstance=function e(t){var r=new I(t);return r.initPromise};return t}(f);return A},false);
//# sourceMappingURL=RoutingServiceFactory.js.map