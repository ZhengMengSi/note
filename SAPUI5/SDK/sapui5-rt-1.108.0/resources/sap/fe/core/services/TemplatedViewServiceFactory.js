/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/fe/core/helpers/LoaderUtils","sap/fe/core/TemplateModel","sap/ui/core/cache/CacheManager","sap/ui/core/Component","sap/ui/core/Core","sap/ui/core/mvc/View","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/Device","sap/ui/model/base/ManagedObjectModel","sap/ui/model/json/JSONModel","sap/ui/VersionInfo","../helpers/DynamicAnnotationPathHelper"],function(e,t,r,n,o,a,i,c,s,u,l,f,v,p,d,g){"use strict";var h=g.resolveDynamicExpression;var m=r.requireDependencies;function y(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function w(e,t){return S(e)||V(e,t)||b(e,t)||C()}function C(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function b(e,t){if(!e)return;if(typeof e==="string")return M(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return M(e,t)}function M(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function V(e,t){var r=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(r==null)return;var n=[];var o=true;var a=false;var i,c;try{for(r=r.call(e);!(o=(i=r.next()).done);o=true){n.push(i.value);if(t&&n.length===t)break}}catch(e){a=true;c=e}finally{try{if(!o&&r["return"]!=null)r["return"]()}finally{if(a)throw c}}return n}function S(e){if(Array.isArray(e))return e}function O(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;I(e,t)}function I(e,t){I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return I(e,t)}var x=function(r){O(s,r);function s(){return r.apply(this,arguments)||this}var u=s.prototype;u.init=function e(){var t=this;var r=this;var n=[];var o=this.getContext();var i=o.scopeObject;var c=a.getOwnerComponentFor(i);var s=c.getMetaModel();var u="".concat(c.getMetadata().getComponentName(),"::").concat(c.getLocalId(i.getId()));var f=i.getEnhanceI18n()||[];var v;this.oFactory=o.factory;if(f){v=c.getMetadata().getComponentName();for(var p=0;p<f.length;p++){var g=c.getModel(f[p]);if(g&&g.isA("sap.ui.model.resource.ResourceModel")){f[p]=g}else{f[p]="".concat(v,".").concat(f[p].replace(".properties",""))}}}var h="".concat(c.getMetadata().getName(),"_").concat(u,"_").concat(sap.ui.getCore().getConfiguration().getLanguageTag());n.push(l.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:i,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.macros.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:f,modelName:"sap.fe.i18n"}}).then(function(e){r.oResourceModelService=e;return e.getResourceModel()}));n.push(l.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:s,appComponent:c,component:i}}).then(function(e){r.oCacheHandlerService=e;return e.validateCacheKey(h,i)}));n.push(d.load().then(function(e){var t="";if(!e.libraries){t=sap.ui.buildinfo.buildtime}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(){return"<NOVALUE>"}));var y;this.initPromise=Promise.all(n).then(function(e){var t=e[1];var n=e[2];var o=c.getShellServices();var a=c.getSideEffectsService();a.initializeSideEffects(c.getEnvironmentCapabilities().getCapabilities());y=t?"".concat(t,"-").concat(n,"-").concat(u,"-").concat(o.instanceType,"-pageModel"):undefined;return Promise.all(e.concat([r._getCachedModel(y)]))}).then(function(e){try{var r=e[0];var n=e[1];var o=e[3];return Promise.resolve(m(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"])).then(function(e){var a=w(e,2),i=a[0],c=a[1];return t.createView(r,u,n,y,o,i,c)})}catch(e){return Promise.reject(e)}}).then(function(e){var t=l.get("sap.fe.core.services.CacheHandlerService").getInstance(s);t.invalidateIfNeeded(e,h,i)})};u._getCachedModel=function e(t){if(t&&i.getConfiguration().getViewCache()){return o.get(t)}return undefined};u._setCachedModel=function e(t,r){if(t&&i.getConfiguration().getViewCache()){o.set(t,r)}return undefined};u.refreshView=function t(r){var n=r.getRootControl();if(n){n.destroy()}else if(this.oView){this.oView.destroy()}return this.createView(this.resourceModel,this.stableId,"","",undefined,this.TemplateConverter,this.MetaModelConverter).then(function(){r.oContainer.invalidate()}).catch(function(t){r.oContainer.invalidate();e.error(t)})};u.createView=function r(o,i,s,u,l,d,g){try{var m=this;m.resourceModel=o;m.stableId=i;m.TemplateConverter=d;m.MetaModelConverter=g;var w=m.getContext();var C=w.settings;var b=C.converterType;var M=w.scopeObject;var V=a.getOwnerComponentFor(M);var S=V.getRoutingService().getTargetInformationFor(M).options.settings.fullContextPath;var O=V.getMetaModel();var I=V.getManifest();var x=new p(f).setDefaultBindingMode("OneWay");var j=new p(I);var P=false;function A(){var e=S.split("/");var t=e.reduce(function(e,t){if(t===""){return e}if(e===""){e="/".concat(t)}else{var r=O.getObject("".concat(e,"/$NavigationPropertyBinding/").concat(t));if(r&&Object.keys(r).length>0){e+="/$NavigationPropertyBinding"}e+="/".concat(t)}return e},"");var r=C.viewType||M.getViewType()||"XML";if(r!=="XML"){r=undefined}return{type:r,preprocessors:{xml:{bindingContexts:{entitySet:t?O.createBindingContext(t):null,fullContextPath:S?O.createBindingContext(S):null,contextPath:S?O.createBindingContext(S):null,converterContext:D.createBindingContext("/",undefined,{noResolve:true}),viewData:E?N.createBindingContext("/"):null},models:{entitySet:O,fullContextPath:O,contextPath:O,"sap.fe.i18n":o,metaModel:O,device:x,manifest:j,converterContext:D,viewData:N},appComponent:V}},id:i,viewName:C.viewName||M.getViewName(),viewData:E,cache:{keys:[s]},models:{"sap.fe.i18n":o},height:"100%"}}var D,N,T,E;var _=function(t){e.error(t.message,t);T.viewName=C.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";T.preprocessors.xml.models["error"]=new p(t);return M.runAsOwner(function(){return c.create(T).then(function(e){m.oView=e;m.oView.setModel(new v(m.oView),"$view");M.setAggregation("rootControl",m.oView);return s})})};return Promise.resolve(y(function(){return Promise.resolve(V.getService("routingService")).then(function(r){var a;var y=r.getTargetInformationFor(M);var w=I["sap.app"]&&I["sap.app"].crossNavigation&&I["sap.app"].crossNavigation.outbounds||{};var C=M.getNavigation()||{};Object.keys(C).forEach(function(e){var t=C[e];var r;if(t.detail&&t.detail.outbound&&w[t.detail.outbound]){r=w[t.detail.outbound];t.detail.outboundDetail={semanticObject:r.semanticObject,action:r.action,parameters:r.parameters}}if(t.create&&t.create.outbound&&w[t.create.outbound]){r=w[t.create.outbound];t.create.outboundDetail={semanticObject:r.semanticObject,action:r.action,parameters:r.parameters}}});E={navigation:C,viewLevel:y.viewLevel,stableId:i,contentDensities:(a=I["sap.ui5"])===null||a===void 0?void 0:a.contentDensities,resourceBundle:o.__bundle,fullContextPath:S,isDesktop:f.system.desktop,isPhone:f.system.phone};if(M.getViewData){Object.assign(E,M.getViewData())}var x=V.getShellServices();E.converterType=b;E.shellContentDensity=x.getContentDensity();E.useNewLazyLoading=t.fromQuery(window.location.search).get("sap-fe-xx-lazyloadingtest")==="true";E.retrieveTextFromValueList=I["sap.fe"]&&I["sap.fe"].form?I["sap.fe"].form.retrieveTextFromValueList:undefined;N=new p(E);if(E&&E.controlConfiguration){Object.keys(E.controlConfiguration).forEach(function(e){if(e.indexOf("[")!==-1){var t=h(e,O);E.controlConfiguration[t]=E.controlConfiguration[e]}})}g.convertTypes(O,V.getEnvironmentCapabilities().getCapabilities());D=new n(function(){try{if(l){return l}else{var t=V.getDiagnostics();var r=t.getIssues().length;var n=d.convertPage(b,O,E,t,S,V.getEnvironmentCapabilities().getCapabilities());var o=t.getIssues();var a=o.slice(r);if(a.length>0){e.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core")}return n}}catch(t){e.error(t,t);return{}}},O);if(!P){T=A();M.setModel(D,"_pageModel");return M.runAsOwner(function(){return c.create(T).catch(_).then(function(e){m.oView=e;m.oView.setModel(new v(m.oView),"$view");m.oView.setModel(N,"viewData");M.setAggregation("rootControl",m.oView);if(!l){m._setCachedModel(u,D.getData())}return s}).catch(function(t){return e.error(t.message,t)})})}})},function(t){e.error(t.message,t);throw new Error("Error while creating view : ".concat(t))}))}catch(L){return Promise.reject(L)}};u.getView=function e(){return this.oView};u.getInterface=function e(){return this};u.exit=function e(){if(this.oResourceModelService){this.oResourceModelService.destroy()}if(this.oCacheHandlerService){this.oCacheHandlerService.destroy()}this.oFactory.removeGlobalInstance()};return s}(s);var j=function(e){O(t,e);function t(){var t;for(var r=arguments.length,n=new Array(r),o=0;o<r;o++){n[o]=arguments[o]}t=e.call.apply(e,[this].concat(n))||this;t._oInstanceRegistry={};return t}var r=t.prototype;r.createInstance=function e(r){t.iCreatingViews++;var n=new x(Object.assign({factory:this},r));return n.initPromise.then(function(){t.iCreatingViews--;return n})};r.removeGlobalInstance=function e(){this._oInstanceRegistry={}};t.getNumberOfViewsInCreationState=function e(){return t.iCreatingViews};return t}(u);return j},false);
//# sourceMappingURL=TemplatedViewServiceFactory.js.map