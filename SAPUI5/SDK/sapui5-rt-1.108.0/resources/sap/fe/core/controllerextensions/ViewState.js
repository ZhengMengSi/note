/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil"],function(e,t,r,n,o,i,a,p,l,s,c){"use strict";var u,f,d,y,v,g,S,h,b,P,w,m,O,C,A,I,R,j,B,_,D,K,V,E,H,x,N,k,M,F,T,z,$,L,U,q,G,Q,J,W,X,Y,Z,ee,te,re,ne,oe,ie;var ae=n.publicExtension;var pe=n.privateExtension;var le=n.finalExtension;var se=n.extensible;var ce=n.defineUI5Class;function ue(e,t){try{var r=e()}catch(e){return t(true,e)}if(r&&r.then){return r.then(t.bind(null,false),t.bind(null,true))}return t(false,r)}function fe(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function de(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;ye(e,t)}function ye(e,t){ye=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return ye(e,t)}function ve(e,t,r,n,o){var i={};Object.keys(n).forEach(function(e){i[e]=n[e]});i.enumerable=!!i.enumerable;i.configurable=!!i.configurable;if("value"in i||i.initializer){i.writable=true}i=r.slice().reverse().reduce(function(r,n){return n(e,t,r)||r},i);if(o&&i.initializer!==void 0){i.value=i.initializer?i.initializer.call(o):void 0;i.initializer=undefined}if(i.initializer===void 0){Object.defineProperty(e,t,i);i=null}return i}var ge="#additionalStates",Se=a.NavType;var he={"sap.ui.fl.variants.VariantManagement":{retrieve:function(e){return{variantId:e.getCurrentVariantKey()}},apply:function(e,t){if(t&&t.variantId!==undefined&&t.variantId!==e.getCurrentVariantKey()){var r=this._checkIfVariantIdIsAvailable(e,t.variantId)?t.variantId:e.getStandardVariantKey();return s.activateVariant({element:e,variantReference:r})}}},"sap.m.IconTabBar":{retrieve:function(e){return{selectedKey:e.getSelectedKey()}},apply:function(e,t){if(t&&t.selectedKey){var r=e.getItems().find(function(e){return e.getKey()===t.selectedKey});if(r){e.setSelectedItem(r)}}}},"sap.ui.mdc.FilterBar":{retrieve:function(e){return c.retrieveExternalState(e).then(function(t){var r=e.getPropertyInfoSet(),n=t.filter||{};r.filter(function(e){return n[e.path]&&(e.removeFromAppState||n[e.path].length===0)}).forEach(function(e){delete n[e.path]});return t})},apply:function(e,t){if(t){return c.applyExternalState(e,t)}}},"sap.ui.mdc.Table":{retrieve:function(e){return c.retrieveExternalState(e)},apply:function(e,t){if(t){if(!t.supplementaryConfig){t.supplementaryConfig={}}return c.applyExternalState(e,t)}},refreshBinding:function(t){var r=t.getRowBinding();if(r){var n=r.getRootBinding();if(n===r){r.refresh()}else{var o=r.getHeaderContext();var i=r.getGroupId();if(o){o.requestSideEffects([{$NavigationPropertyPath:""}],i)}}}else{e.info("Table: ".concat(t.getId()," was not refreshed. No binding found!"))}}},"sap.ui.mdc.Chart":{retrieve:function(e){return c.retrieveExternalState(e)},apply:function(e,t){if(t){return c.applyExternalState(e,t)}}},"sap.uxap.ObjectPageLayout":{retrieve:function(e){return{selectedSection:e.getSelectedSection()}},apply:function(e,t){if(t){e.setSelectedSection(t.selectedSection)}},refreshBinding:function(t){var n=t.getBindingContext();var a=n&&n.getBinding();if(a){var p=i.getMetaPathForContext(n);var l=o.getControlRefreshStrategyForContextPath(t,p);if(l==="self"){var s=n.getModel(),c=s.getMetaModel(),u=r.getContextPathProperties(c,p,{$kind:"NavigationProperty"})||{},f=Object.keys(u).reduce(function(e,t){if(u[t].$isCollection!==true){e.push({$NavigationPropertyPath:t})}return e},[]),d=[{$PropertyPath:"*"}],y=a.getGroupId();n.requestSideEffects(d.concat(f),y)}else if(l==="includingDependents"){a.refresh()}}else{e.info("ObjectPage: ".concat(t.getId()," was not refreshed. No binding found!"))}}},"sap.fe.macros.table.QuickFilterContainer":{retrieve:function(e){return{selectedKey:e.getSelectorKey()}},apply:function(e,t){if(t){e.setSelectorKey(t.selectedKey)}}},"sap.m.SegmentedButton":{retrieve:function(e){return{selectedKey:e.getSelectedKey()}},apply:function(e,t){if(t){e.setSelectedKey(t.selectedKey)}}},"sap.m.Select":{retrieve:function(e){return{selectedKey:e.getSelectedKey()}},apply:function(e,t){if(t){e.setSelectedKey(t.selectedKey)}}},"sap.f.DynamicPage":{retrieve:function(e){return{headerExpanded:e.getHeaderExpanded()}},apply:function(e,t){if(t){e.setHeaderExpanded(t.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(e){var t=e.getController();if(t&&t.viewState){return t.viewState.retrieveViewState(t.viewState)}return{}},apply:function(e,t,r){var n=e.getController();if(n&&n.viewState){return n.viewState.applyViewState(t,r)}},refreshBinding:function(e){var t=e.getController();if(t&&t.viewState){return t.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:function(e){var t=e.getComponentInstance();if(t){return this.retrieveControlState(t.getRootControl())}return{}},apply:function(e,t,r){var n=e.getComponentInstance();if(n){return this.applyControlState(n.getRootControl(),t,r)}}}};var be=(u=ce("sap.fe.core.controllerextensions.ViewState"),f=ae(),d=le(),y=ae(),v=se(l.After),g=pe(),S=le(),h=pe(),b=le(),P=ae(),w=se(l.After),m=ae(),O=se(l.After),C=ae(),A=se(l.After),I=pe(),R=le(),j=ae(),B=se(l.After),_=pe(),D=le(),K=ae(),V=se(l.After),E=ae(),H=le(),x=ae(),N=le(),k=ae(),M=se(l.After),F=pe(),T=le(),z=ae(),$=se(l.Instead),L=ae(),U=le(),q=pe(),G=ae(),Q=se(l.After),J=ae(),W=se(l.After),X=ae(),Y=se(l.After),Z=pe(),ee=ae(),te=se(l.After),re=pe(),ne=le(),u(oe=(ie=function(r){de(n,r);function n(){var e;e=r.call(this)||this;e._iRetrievingStateCounter=0;e._pInitialStateApplied=new Promise(function(t){e._pInitialStateAppliedResolve=t});return e}var o=n.prototype;o.refreshViewBindings=function e(){try{var t=this;return Promise.resolve(t.collectResults(t.base.viewState.adaptBindingRefreshControls)).then(function(e){var r=Promise.resolve();e.filter(function(e){return e&&e.isA&&e.isA("sap.ui.base.ManagedObject")}).forEach(function(e){r=r.then(t.refreshControlBinding.bind(t,e))});return r})}catch(e){return Promise.reject(e)}};o.adaptBindingRefreshControls=function e(t){};o.refreshControlBinding=function t(r){var n=this.getControlRefreshBindingHandler(r);var o=Promise.resolve();if(typeof n.refreshBinding!=="function"){e.info("refreshBinding handler for control: ".concat(r.getMetadata().getName()," is not provided"))}else{o=o.then(n.refreshBinding.bind(this,r))}return o};o.getControlRefreshBindingHandler=function e(t){var r={};if(t){for(var n in he){if(t.isA(n)){r["refreshBinding"]=he[n].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(t,r);return r};o.adaptBindingRefreshHandler=function e(t,r){};o.onSuspend=function e(){};o.onRestore=function e(){};o.destroy=function e(){delete this._pInitialStateAppliedResolve;r.prototype.destroy.call(this)};o.collectResults=function e(t){var r=[];for(var n=arguments.length,o=new Array(n>1?n-1:0),i=1;i<n;i++){o[i-1]=arguments[i]}o.push(r);t.apply(this,o);return Promise.all(r)};o.adaptControlStateHandler=function e(t,r){};o.getControlStateHandler=function e(t){var r=[],n=[];if(t){for(var o in he){if(t.isA(o)){r.push(Object.assign({},he[o]));break}}}this.base.viewState.adaptControlStateHandler(t,n);return r.concat(n)};o.adaptStateControls=function e(t){};o.getStateKey=function e(t){return this.getView().getLocalId(t.getId())||t.getId()};o.retrieveViewState=function e(){try{var r=this;function i(){return r._iRetrievingStateCounter===0?n:undefined}++r._iRetrievingStateCounter;var n;var o=ue(function(){return Promise.resolve(r._pInitialStateApplied).then(function(){return Promise.resolve(r.collectResults(r.base.viewState.adaptStateControls)).then(function(e){return Promise.resolve(Promise.all(e.filter(function(e){return e&&e.isA&&e.isA("sap.ui.base.ManagedObject")}).map(function(e){return r.retrieveControlState(e).then(function(t){return{key:r.getStateKey(e),value:t}})}))).then(function(e){n=e.reduce(function(e,r){var n={};n[r.key]=r.value;return t(e,n)},{});return Promise.resolve(Promise.resolve(r._retrieveAdditionalStates())).then(function(e){if(e&&Object.keys(e).length){n[ge]=e}})})})})},function(e,t){--r._iRetrievingStateCounter;if(e)throw t;return t});return Promise.resolve(o&&o.then?o.then(i):i(o))}catch(a){return Promise.reject(a)}};o.retrieveAdditionalStates=function e(t){};o._retrieveAdditionalStates=function e(){var t={};this.base.viewState.retrieveAdditionalStates(t);return t};o.retrieveControlState=function e(r){var n=this;var o=this.getControlStateHandler(r);return Promise.all(o.map(function(e){if(typeof e.retrieve!=="function"){throw new Error("controlStateHandler.retrieve is not a function for control: ".concat(r.getMetadata().getName()))}return e.retrieve.call(n,r)})).then(function(e){return e.reduce(function(e,r){return t(e,r)},{})})};o.applyInitialStateOnly=function e(){return true};o.applyViewState=function t(r,n){try{var o=this;if(o.base.viewState.applyInitialStateOnly()&&o._getInitialStateApplied()){return Promise.resolve()}var i=ue(function(){return Promise.resolve(o.collectResults(o.base.viewState.onBeforeStateApplied)).then(function(){return Promise.resolve(o.collectResults(o.base.viewState.adaptStateControls)).then(function(e){var t=Promise.resolve();e.filter(function(e){return e&&e.isA&&e.isA("sap.ui.base.ManagedObject")}).forEach(function(e){var i=o.getStateKey(e);t=t.then(o.applyControlState.bind(o,e,r?r[i]:undefined,n))});return Promise.resolve(t).then(function(){var e=function(){if(n.navigationType===Se.iAppState){return Promise.resolve(o.collectResults(o.base.viewState.applyAdditionalStates,r?r[ge]:undefined)).then(function(){})}else{return Promise.resolve(o.collectResults(o.base.viewState.applyNavigationParameters,n)).then(function(){return Promise.resolve(o.collectResults(o.base.viewState._applyNavigationParametersToFilterbar,n)).then(function(){})})}}();if(e&&e.then)return e.then(function(){})})})})},function(t,r){function n(){if(t)throw r;return r}var i=fe(function(){return Promise.resolve(o.collectResults(o.base.viewState.onAfterStateApplied)).then(function(){o._setInitialStateApplied()})},function(t){e.error(t)});return i&&i.then?i.then(n):n(i)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};o._checkIfVariantIdIsAvailable=function e(t,r){var n=t.getVariants();var o=false;n.forEach(function(e){if(e.key===r){o=true}});return o};o._setInitialStateApplied=function e(){if(this._pInitialStateAppliedResolve){var t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};o._getInitialStateApplied=function e(){return!this._pInitialStateAppliedResolve};o.onBeforeStateApplied=function e(t){};o.onAfterStateApplied=function e(t){};o.applyAdditionalStates=function e(t,r){};o._applyNavigationParametersToFilterbar=function e(t,r){};o.applyNavigationParameters=function e(t,r){};o.applyControlState=function e(t,r,n){var o=this;var i=this.getControlStateHandler(t);var a=Promise.resolve();i.forEach(function(e){if(typeof e.apply!=="function"){throw new Error("controlStateHandler.apply is not a function for control: ".concat(t.getMetadata().getName()))}a=a.then(e.apply.bind(o,t,r,n))});return a};o.getInterface=function e(){return this};return n}(p),ve(ie.prototype,"refreshViewBindings",[f,d],Object.getOwnPropertyDescriptor(ie.prototype,"refreshViewBindings"),ie.prototype),ve(ie.prototype,"adaptBindingRefreshControls",[y,v],Object.getOwnPropertyDescriptor(ie.prototype,"adaptBindingRefreshControls"),ie.prototype),ve(ie.prototype,"refreshControlBinding",[g,S],Object.getOwnPropertyDescriptor(ie.prototype,"refreshControlBinding"),ie.prototype),ve(ie.prototype,"getControlRefreshBindingHandler",[h,b],Object.getOwnPropertyDescriptor(ie.prototype,"getControlRefreshBindingHandler"),ie.prototype),ve(ie.prototype,"adaptBindingRefreshHandler",[P,w],Object.getOwnPropertyDescriptor(ie.prototype,"adaptBindingRefreshHandler"),ie.prototype),ve(ie.prototype,"onSuspend",[m,O],Object.getOwnPropertyDescriptor(ie.prototype,"onSuspend"),ie.prototype),ve(ie.prototype,"onRestore",[C,A],Object.getOwnPropertyDescriptor(ie.prototype,"onRestore"),ie.prototype),ve(ie.prototype,"collectResults",[I,R],Object.getOwnPropertyDescriptor(ie.prototype,"collectResults"),ie.prototype),ve(ie.prototype,"adaptControlStateHandler",[j,B],Object.getOwnPropertyDescriptor(ie.prototype,"adaptControlStateHandler"),ie.prototype),ve(ie.prototype,"getControlStateHandler",[_,D],Object.getOwnPropertyDescriptor(ie.prototype,"getControlStateHandler"),ie.prototype),ve(ie.prototype,"adaptStateControls",[K,V],Object.getOwnPropertyDescriptor(ie.prototype,"adaptStateControls"),ie.prototype),ve(ie.prototype,"getStateKey",[E,H],Object.getOwnPropertyDescriptor(ie.prototype,"getStateKey"),ie.prototype),ve(ie.prototype,"retrieveViewState",[x,N],Object.getOwnPropertyDescriptor(ie.prototype,"retrieveViewState"),ie.prototype),ve(ie.prototype,"retrieveAdditionalStates",[k,M],Object.getOwnPropertyDescriptor(ie.prototype,"retrieveAdditionalStates"),ie.prototype),ve(ie.prototype,"retrieveControlState",[F,T],Object.getOwnPropertyDescriptor(ie.prototype,"retrieveControlState"),ie.prototype),ve(ie.prototype,"applyInitialStateOnly",[z,$],Object.getOwnPropertyDescriptor(ie.prototype,"applyInitialStateOnly"),ie.prototype),ve(ie.prototype,"applyViewState",[L,U],Object.getOwnPropertyDescriptor(ie.prototype,"applyViewState"),ie.prototype),ve(ie.prototype,"_checkIfVariantIdIsAvailable",[q],Object.getOwnPropertyDescriptor(ie.prototype,"_checkIfVariantIdIsAvailable"),ie.prototype),ve(ie.prototype,"onBeforeStateApplied",[G,Q],Object.getOwnPropertyDescriptor(ie.prototype,"onBeforeStateApplied"),ie.prototype),ve(ie.prototype,"onAfterStateApplied",[J,W],Object.getOwnPropertyDescriptor(ie.prototype,"onAfterStateApplied"),ie.prototype),ve(ie.prototype,"applyAdditionalStates",[X,Y],Object.getOwnPropertyDescriptor(ie.prototype,"applyAdditionalStates"),ie.prototype),ve(ie.prototype,"_applyNavigationParametersToFilterbar",[Z],Object.getOwnPropertyDescriptor(ie.prototype,"_applyNavigationParametersToFilterbar"),ie.prototype),ve(ie.prototype,"applyNavigationParameters",[ee,te],Object.getOwnPropertyDescriptor(ie.prototype,"applyNavigationParameters"),ie.prototype),ve(ie.prototype,"applyControlState",[re,ne],Object.getOwnPropertyDescriptor(ie.prototype,"applyControlState"),ie.prototype),ie))||oe);return be},false);
//# sourceMappingURL=ViewState.js.map