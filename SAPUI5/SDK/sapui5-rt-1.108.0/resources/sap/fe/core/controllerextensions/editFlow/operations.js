/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../../operationsHelper"],function(e,t,n,r,o,a,i,s,l,c,u,f,d,g,v,m,h,p){"use strict";var P=g.MessageType;var M=i.generate;function x(e,t){var n=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=C(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var r=0;var o=function(){};return{s:o,n:function(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,i=false,s;return{s:function(){n=n.call(e)},n:function(){var e=n.next();a=e.done;return e},e:function(e){i=true;s=e},f:function(){try{if(!a&&n.return!=null)n.return()}finally{if(i)throw s}}}}function C(e,t){if(!e)return;if(typeof e==="string")return y(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return y(e,t)}function y(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++){r[n]=e[n]}return r}function b(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}function A(e,t){try{var n=e()}catch(e){return t(true,e)}if(n&&n.then){return n.then(t.bind(null,false),t.bind(null,true))}return t(false,n)}var E=function(e,t,n,r,o,a,i){try{return Promise.resolve(q(e,t,n,r)).then(function(e){var n;if(e!==null&&e!==void 0&&e.some(function(e){return e.status==="rejected"})){throw e}var s=sap.ui.getCore().getMessageManager().getMessageModel().getData();if(t.internalModelContext&&t.internalModelContext.getProperty("412Executed")&&(n=t.internalModelContext.getProperty("strictHandlingFails"))!==null&&n!==void 0&&n.length){if(!i){t.internalModelContext.setProperty("DelayMessages",t.internalModelContext.getProperty("DelayMessages").concat(s))}else{f.getMessageManager().addMessages(t.internalModelContext.getProperty("DelayMessages"));if(s.length){r.showMessageDialog({onBeforeShowMessage:function(e,n){return F(t,o,a,e,n)}})}}}else if(s.length){r.showMessageDialog({isActionParameterDialogOpen:t===null||t===void 0?void 0:t.oDialog.isOpen(),onBeforeShowMessage:function(e,n){return F(t,o,a,e,n)}})}return e})}catch(e){return Promise.reject(e)}};var O=s.Constants,T=s.InvocationGrouping;var S=u.Action;function I(e,t,n,r,o){if(!t||t.length===0){return Promise.reject("Bound actions always requires at least one context")}var a=Array.isArray(t);o.aContexts=a?t:[t];var i=n.getMetaModel(),s="".concat(i.getMetaPath(o.aContexts[0].getPath()),"/").concat(e),l=i.createBindingContext("".concat(s,"/@$ui5.overload/0"));o.isCriticalAction=k(i,s,o.aContexts,l);var c=function(e){if(e[0].status==="fulfilled"){return e[0].value}else{throw e[0].reason||e}};return D(e,n,l,r,o).then(function(e){if(a){return e}else{return c(e)}},function(e){if(a){throw e}else{return c(e)}})}function $(e,t,n,r){if(!t){return Promise.reject("Action expects a model/context for execution")}var o=t.getMetaModel(),a=t.bindContext("/".concat(e)).getPath(),i=o.createBindingContext("/".concat(o.createBindingContext(a).getObject("$Action"),"/0"));r.isCriticalAction=k(o,"".concat(a,"/@$ui5.overload"));return D(e,t,i,n,r)}function N(e,t,n){if(!t){return Promise.reject("Bound functions always requires a context")}var r=n.getMetaModel(),o="".concat(r.getMetaPath(t.getPath()),"/").concat(e),a=r.createBindingContext(o);return j(e,n,a,t)}function B(e,t){if(!e){return Promise.resolve()}var n=t.getMetaModel(),r=t.bindContext("/".concat(e)).getPath(),o=n.createBindingContext("/".concat(n.createBindingContext(r).getObject("$Function"),"/0"));return j(e,t,o)}function j(e,t,n,r){var o;if(!n||!n.getObject()){return Promise.reject(new Error("Function ".concat(e," not found")))}if(r){n=t.bindContext("".concat(e,"(...)"),r);o="functionGroup"}else{n=t.bindContext("/".concat(e,"(...)"));o="functionImport"}var a=n.execute(o);t.submitBatch(o);return a.then(function(){return n.getBoundContext()})}function D(e,t,n,r,o){return new Promise(function(a,i){try{var s={};var l;var c;var u=o.label;var d=o.skipParameterDialog;var g=o.aContexts;var v=o.bIsCreateAction;var m=o.isCriticalAction;var h;var p;var P;var M;var x;var C;var y;var E=n.getObject();if(!n||!n.getObject()){return Promise.resolve(i(new Error("Action ".concat(e," not found"))))}var O=H(n);var S=O.length>0&&!(O.length===1&&O[0].$Name==="ResultIsActiveEntity");var I=o.parameterValues;var $=r.getComponentData();var N=$&&$.startupParameters||{};if(S&&d){y=K(v,O,I,N)}l=null;if(S){if(!(d&&y)){l=R}}else if(m){l=w}s={fnOnSubmitted:o.onSubmitted,fnOnResponse:o.onResponse,actionName:e,model:t,aActionParameters:O,bGetBoundContext:o.bGetBoundContext,defaultValuesExtensionFunction:o.defaultValuesExtensionFunction,label:o.label,selectedItems:o.selectedItems};if(n.getObject("$IsBound")){if(o.additionalSideEffect&&o.additionalSideEffect.pathExpressions){h=t.getMetaModel();p=h.getMetaPath(g[0].getPath());P=h.getObject("".concat(p,"/@com.sap.vocabularies.Common.v1.Messages/$Path"));if(P){M=o.additionalSideEffect.pathExpressions.findIndex(function(e){return typeof e==="string"&&e===P});C=n.getObject("$ReturnType");x=C&&!C.$isCollection&&n.getModel().getObject(p).$Type===C.$Type;if(M>-1||x){o.mBindingParameters=o.mBindingParameters||{};if(n.getObject("$ReturnType/$Type/".concat(P))&&(!o.mBindingParameters.$select||o.mBindingParameters.$select.split(",").indexOf(P)===-1)){o.mBindingParameters.$select=o.mBindingParameters.$select?"".concat(o.mBindingParameters.$select,",").concat(P):P;if(M===-1){o.additionalSideEffect.pathExpressions.push("*")}if(o.additionalSideEffect.triggerActions.length===0&&M>-1){o.additionalSideEffect.pathExpressions.splice(M,1)}}}}}s.aContexts=g;s.mBindingParameters=o.mBindingParameters;s.additionalSideEffect=o.additionalSideEffect;s.bGrouped=o.invocationGrouping===T.ChangeSet;s.internalModelContext=o.internalModelContext;s.operationAvailableMap=o.operationAvailableMap;s.isCreateAction=v;s.bObjectPage=o.bObjectPage;if(o.controlId){s.control=o.parentControl.byId(o.controlId)}else{s.control=o.parentControl}}if(v){s.bIsCreateAction=v}var B=(E.$Parameter||[]).some(function(e){return(E.$EntitySetPath&&E.$EntitySetPath===e.$Name||E.$IsBound)&&e.$isCollection});s.isStatic=B;return Promise.resolve(function(){if(l){c=l(e,r,u,s,O,I,n,o.parentControl,o.entitySetName,o.messageHandler);return c.then(function(e){_(o,s,E);a(e)}).catch(function(e){i(e)})}else{if(I){var t=function(e){var t;s.aActionParameters[e].value=I===null||I===void 0?void 0:(t=I.find(function(t){return t.name===s.aActionParameters[e].$Name}))===null||t===void 0?void 0:t.value};for(var d in s.aActionParameters){t(d)}}else if(N){for(var g in s.aActionParameters){s.aActionParameters[g].value=N[s.aActionParameters[g].$Name][0]}}var v;var m=A(function(){return b(function(){var e,t;(e=s)===null||e===void 0?void 0:(t=e.internalModelContext)===null||t===void 0?void 0:t.setProperty("412Executed",false);return Promise.resolve(q(r,s,o.parentControl,o.messageHandler)).then(function(e){var t;v=e;var n=sap.ui.getCore().getMessageManager().getMessageModel().getData();if(s.internalModelContext&&s.internalModelContext.getProperty("412Executed")&&(t=s.internalModelContext.getProperty("strictHandlingFails"))!==null&&t!==void 0&&t.length){s.internalModelContext.setProperty("DelayMessages",s.internalModelContext.getProperty("DelayMessages").concat(n))}_(o,s,E);a(v)})},function(){i(v)})},function(e,t){function n(){var n;o===null||o===void 0?void 0:(n=o.messageHandler)===null||n===void 0?void 0:n.showMessageDialog();if(e)throw t;return t}var l=function(){var e;if(s.internalModelContext&&s.internalModelContext.getProperty("412Executed")&&(e=s.internalModelContext.getProperty("strictHandlingFails"))!==null&&e!==void 0&&e.length){var t=b(function(){var e=s.internalModelContext.getProperty("strictHandlingFails");var t=[];e.forEach(function(e){t.push(e.oAction.getContext())});s.aContexts=t;return Promise.resolve(q(r,s,o.parentControl,o.messageHandler)).then(function(e){f.getMessageManager().addMessages(s.internalModelContext.getProperty("DelayMessages"));s.internalModelContext.setProperty("strictHandlingFails",[]);s.internalModelContext.setProperty("processedMessageIds",[]);_(o,s,E);a(e)})},function(e){i(e)});if(t&&t.then)return t.then(function(){})}}();return l&&l.then?l.then(n):n(l)});if(m&&m.then)return m.then(function(){})}}())}catch(e){return Promise.reject(e)}})}function w(e,t,r,o,a,i,s,l,c,f){return new Promise(function(r,a){var i=e?e:null;i=i.indexOf(".")>=0?i.split(".")[i.split(".").length-1]:i;var s=i&&c?"".concat(c,"|").concat(i):"";var d=l.getController().oResourceBundle;var g=n.getTranslatedText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",d,null,s);u.confirm(g,{onClose:function(e){try{var n=function(){if(e===S.OK){var n=b(function(){return Promise.resolve(q(t,o,l,f)).then(function(e){r(e)})},function(e){var t=b(function(){return Promise.resolve(f.showMessageDialog()).then(function(){a(e)})},function(){a(e)});return t&&t.then?t.then(function(){}):void 0});if(n&&n.then)return n.then(function(){})}else{r()}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}})})}function _(e,n,r){if(n.internalModelContext&&n.operationAvailableMap&&n.aContexts&&n.aContexts.length&&r.$IsBound){var o=n.isStatic;if(!o){t.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),e.selectedItems,"table")}else if(n.control){var a=n.control;if(a.isA("sap.ui.mdc.Table")){var i=a.getSelectedContexts();t.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),i,"table")}}}}function F(e,t,n,r,a){var i=a.showMessageBox,s=a.showMessageDialog;var l=e.control;var c=r.filter(function(e){return e.getTarget()===""});var u=r.filter(function(t){return t.getTarget&&t.getTarget().indexOf(e.actionName)!==-1&&e.aActionParameters.some(function(e){return t.getTarget().indexOf(e.$Name)!==-1})});u.forEach(function(e){e.isAPDTarget=true});var f=u.length?true:false;if(n.isOpen()&&t.length!==0&&!e.isStatic){if(!e.bGrouped){if(t.length>1||!f){n.close();n.destroy()}}else if(!f){n.close();n.destroy()}}var d=[];var g=n.isOpen();if(r.length===1&&r[0].getTarget&&r[0].getTarget()!==undefined&&r[0].getTarget()!==""){if(l&&l.getModel("ui").getProperty("/isEditable")===false||!l){i=!f;s=false}else if(l&&l.getModel("ui").getProperty("/isEditable")===true){i=false;s=false}}else if(l){if(l.getModel("ui").getProperty("/isEditable")===false){if(g&&f){s=false}}else if(l.getModel("ui").getProperty("/isEditable")===true){if(!g&&f){s=true;d=c.concat(u)}else if(!g&&c.length===0){s=false}}}return{showMessageBox:i,showMessageDialog:s,filteredMessages:d.length?d:r,fnGetMessageSubtitle:l&&l.isA("sap.ui.mdc.Table")&&o.setMessageSubtitle.bind({},l,t)}}function R(t,i,s,g,p,P,x,C,y,T){var S=U(x,t),I=x.getModel().oModel.getMetaModel(),$=I.createBindingContext(S),B=x.getObject("$IsBound")?x.getPath().split("/@$ui5.overload/0")[0]:x.getPath().split("/0")[0],j=I.createBindingContext(B),D=g.isCreateAction,w="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(S,I){try{var B=m.loadTemplate(w,"fragment");var _=new h({$displayMode:{}});var R=[];var H=[];var k={};var V=function(){try{return Promise.resolve(Promise.all(H.filter(function(e){var t=e.getFields()[0];return t.getRequired()}).map(function(e){var t=e.getFields()[0].isA("sap.ui.mdc.MultiValueField")?e.getFields()[0].getItems():e.getFields()[0].getValue();if(t===undefined||t===null||t===""||Array.isArray(t)&&!t.length){return e}}))).then(function(e){return e.filter(function(e){return e!==undefined})})}catch(e){return Promise.reject(e)}};var L=function(e,t,n){var r=f.getMessageManager();var o=r.getMessageModel().getData();t=t||[];if(!o.length){t=[]}e.forEach(function(e){var a=e.$Name;o.forEach(function(e){var o=a.replace("-inner","");if(e.controlIds.length>0&&(e.getControlId().includes("APD_::".concat(a))||e.getControlId().includes("APD_::".concat(a,"inner"))&&t.indexOf("APD_::".concat(o))<0)){if(n){r.removeMessages(e)}else{t.push("APD_::".concat(o))}}if(e.target.includes("APD_::".concat(a))){t.push("APD_::".concat(o));e.target=n?"":e.target;if(n){r.removeMessages(e)}}})});return t};var q={handleChange:function(e){T.removeTransitionMessages();var t=e.getSource();var n=e.getParameter("id");var r=e.getParameter("promise");if(r){k[n]=r.then(function(){return t.getValue()})}L(p,R)}};var U=b(function(){return Promise.resolve(v.process(B,{name:w},{bindingContexts:{action:x,actionName:j,entitySet:$},models:{action:x.getModel(),actionName:j.getModel(),entitySet:$.getModel(),metaModel:$.getModel()}})).then(function(v){var m=g.aContexts||[];var $=[];var B;return Promise.resolve(n.setUserDefaults(i,p,_,true)).then(function(){return Promise.resolve(d.load({definition:v,controller:q})).then(function(d){var v=d;var j=C.getController().oResourceBundle;var w=new c(undefined,{title:s||n.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE",j),content:[v],escapeHandler:function(){w.close();T.removeTransitionMessages();I(O.CancelActionDialog)},beginButton:new l(M(["fe","APD_",t,"Action","Ok"]),{text:D?n.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON",j):G(j,s,t,y),type:"Emphasized",press:function(){try{return Promise.resolve(A(function(){return Promise.resolve(V()).then(function(e){var t=false;function a(e){if(t)return e;r.lock(w);return b(function(){return Promise.resolve(Promise.all(Object.keys(k).map(function(e){return k[e]}))).then(function(){T.removeTransitionMessages();var e;var t=B&&B.getParameterContext();for(var n in p){if(p[n].$isCollection){var o=w.getModel("mvfview").getProperty("/".concat(p[n].$Name)),a=[];for(var l in o){a.push(o[l].Key)}e=a}else{e=t.getProperty(p[n].$Name)}p[n].value=e;e=undefined}g.label=s;return A(function(){return b(function(){var e;g===null||g===void 0?void 0:(e=g.internalModelContext)===null||e===void 0?void 0:e.setProperty("412Executed",false);return Promise.resolve(E(i,g,C,T,m,w,false)).then(function(e){w.close();S(e)})},function(e){var t;var n=sap.ui.getCore().getMessageManager().getMessageModel().getData();if(g.internalModelContext&&g.internalModelContext.getProperty("412Executed")&&(t=g.internalModelContext.getProperty("strictHandlingFails"))!==null&&t!==void 0&&t.length){g.internalModelContext.setProperty("DelayMessages",g.internalModelContext.getProperty("DelayMessages").concat(n))}throw e})},function(e,t){function n(){if(r.isLocked(w)){r.unlock(w)}if(e)throw t;return t}var o=function(){var e;if(g.internalModelContext&&g.internalModelContext.getProperty("412Executed")&&(e=g.internalModelContext.getProperty("strictHandlingFails"))!==null&&e!==void 0&&e.length){var t=b(function(){var e=g.internalModelContext.getProperty("strictHandlingFails");var t=[];e.forEach(function(e){t.push(e.oAction.getContext())});g.aContexts=t;return Promise.resolve(E(i,g,C,T,m,w,true)).then(function(e){g.internalModelContext.setProperty("strictHandlingFails",[]);g.internalModelContext.setProperty("processedMessageIds",[]);S(e)})},function(){var e;if(g.internalModelContext&&g.internalModelContext.getProperty("412Executed")&&(e=g.internalModelContext.getProperty("strictHandlingFails"))!==null&&e!==void 0&&e.length){f.getMessageManager().addMessages(g.internalModelContext.getProperty("DelayMessages"))}return Promise.resolve(T.showMessageDialog({isActionParameterDialogOpen:w.isOpen(),onBeforeShowMessage:function(e,t){return F(g,m,w,e,t)}})).then(function(){})});if(t&&t.then)return t.then(function(){})}}();return o&&o.then?o.then(n):n(o)})})},function(e){var t=true;return Promise.resolve(T.showMessages({context:g.aContexts[0],isActionParameterDialogOpen:w.isOpen(),messagePageNavigationCallback:function(){w.close()},onBeforeShowMessage:function(e,n){var r=F(g,m,w,e,n);t=r.showMessageDialog;return r}})).then(function(){if(t){I(e)}})})}if(e.length){for(var l=0;l<e.length;l++){e[l].getFields()[0].setValueState("Error");e[l].getFields()[0].setValueStateText(n.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_MISSING_MANDATORY_MSG",j,e[l].getLabel().getText()))}return}R=L(p,R);var c=function(){if(R.length>0){return Promise.resolve(o.showUnboundMessages()).then(function(){t=true})}}();return c&&c.then?c.then(a):a(c)})},function(e,t){if(r.isLocked(w)){r.unlock(w)}if(e)throw t;return t}))}catch(e){return Promise.reject(e)}}}),endButton:new l(M(["fe","APD_",t,"Action","Cancel"]),{text:n.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",j),press:function(){L(p,R,true);w.close();T.removeTransitionMessages();I(O.CancelActionDialog)}}),beforeOpen:function(t){try{var r=Object.assign({},t);T.removeTransitionMessages();var o=function(){var e=w.getModel().getMetaModel(),t=x.sPath&&x.sPath.split("/@")[0],n=e.getObject("".concat(t,"@com.sap.vocabularies.Common.v1.DefaultValuesFunction"));return n};var i=function(t){try{var i=o();var s=function(r,o){return new Promise(function(a){try{var i=function(){if(o!==undefined){var i=function(){if(m.length>0&&o.$Path){var i=b(function(){return Promise.resolve(n.requestSingletonProperty(o.$Path,B.getModel())).then(function(e){function n(){if(m.length>1){var n=o.$Path;if(n.indexOf("".concat(t,"/"))===0){n=n.replace("".concat(t,"/"),"")}for(var i=1;i<m.length;i++){if(m[i].getProperty(n)!==e){a({paramName:r,value:undefined,bNoPossibleValue:true})}}}a({paramName:r,value:e})}var i=function(){if(e===null){return Promise.resolve(B.getParameterContext().requestProperty(o.$Path)).then(function(t){e=t})}}();return i&&i.then?i.then(n):n(i)})},function(){e.error("Error while reading default action parameter",r,g.actionName);a({paramName:r,value:undefined,bLatePropertyError:true})});if(i&&i.then)return i.then(function(){})}else{a({paramName:r,value:o})}}();if(i&&i.then)return i.then(function(){})}else if(_&&_.oData[r]){a({paramName:r,value:_.oData[r]})}else{a({paramName:r,value:undefined})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})};var l=function(e){var t=w.getModel().getMetaModel(),r=n.getParameterPath(x.getPath(),e)+"@",o=t.getObject(r),a=o&&o["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];return a};var c=[];var f,d;for(var v in p){f=p[v].$Name;d=l(f);c.push(s(f,d))}if(x.getObject("$IsBound")&&m.length>0){if(i&&i.length>0&&typeof i==="string"){for(var h in m){$.push(N(i,m[h],g.model))}}}var M=Promise.all(c);var C=Promise.resolve([]);var y;if($&&$.length>0){C=Promise.all($)}if(g.defaultValuesExtensionFunction){var A=g.defaultValuesExtensionFunction.substring(0,g.defaultValuesExtensionFunction.lastIndexOf(".")||-1).replace(/\./gi,"/"),E=g.defaultValuesExtensionFunction.substring(g.defaultValuesExtensionFunction.lastIndexOf(".")+1,g.defaultValuesExtensionFunction.length);y=a.actionWrapper(r,A,E,{contexts:m})}var O=b(function(){return Promise.resolve(Promise.all([M,C,y])).then(function(e){var t=e[0];var r=e[1];var o=e[2];var a;var s=function(e){var n;a=p[e].$Name;var s=P===null||P===void 0?void 0:(n=P.find(function(t){return t.name===p[e].$Name}))===null||n===void 0?void 0:n.value;if(s){B.setParameter(p[e].$Name,s)}else if(o&&o.hasOwnProperty(a)){B.setParameter(p[e].$Name,o[a])}else if(t[e]&&t[e].value!==undefined){B.setParameter(p[e].$Name,t[e].value)}else if(i&&!t[e].bNoPossibleValue){if(m.length>1){var l=0;while(l<m.length-1){if(r[l]&&r[l+1]&&r[l].getObject(a)===r[l+1].getObject(a)){l++}else{break}}if(l===m.length-1){B.setParameter(p[e].$Name,r[l].getObject(a))}}else if(r[0]&&r[0].getObject(a)){B.setParameter(p[e].$Name,r[0].getObject(a))}}};for(var l in p){s(l)}var c=t.some(function(e){if(e.bLatePropertyError){return e.bLatePropertyError}});if(c){var f=n.getTranslatedText("C_APP_COMPONENT_SAPFE_ETAG_LATE_PROPERTY",j);u.warning(f,{contentWidth:"25em"})}})},function(t){e.error("Error while retrieving the parameter",t)});return Promise.resolve(O&&O.then?O.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};var s=function(){try{var t=function(){if(x.getObject("$IsBound")&&m.length>0){var t=x.getObject("$Parameter");var n=t[0]&&t[0].$Name;var r=b(function(){return Promise.resolve(m[0].requestObject()).then(function(e){if(e){B.setParameter(n,e)}return Promise.resolve(i(n)).then(function(){})})},function(t){e.error("Error while retrieving the parameter",t)});if(r&&r.then)return r.then(function(){})}else{return Promise.resolve(i()).then(function(){})}}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};return Promise.resolve(s()).then(function(){})}catch(e){return Promise.reject(e)}},afterClose:function(){w.destroy()}});g.oDialog=w;H=v.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");w.setModel(x.getModel().oModel);w.setModel(_,"paramsModel");w.bindElement({path:"/",model:"paramsModel"});var q=new h({});w.setModel(q,"mvfview");var U="".concat(t,"(...)");if(!m.length){U="/".concat(U)}w.bindElement({path:U});if(C){C.addDependent(w)}if(m.length>0){w.setBindingContext(m[0])}B=w.getObjectBinding();w.open()})})})},function(e){I(e)});return Promise.resolve(U&&U.then?U.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})}function H(e){var t=e.getObject("$Parameter")||[];if(t&&t.length){if(e.getObject("$IsBound")){return t.slice(1,t.length)||[]}}return t}function k(e,t,n,r){var o=e.getObject("".concat(t,"@com.sap.vocabularies.Common.v1.IsActionCritical"));var a=o&&o.$Path;if(!a){return!!o}var i=r&&r.getObject("$Parameter"),s=a&&a.split("/"),l=i&&i.length&&typeof i==="object"&&a&&n&&n.length;if(l){i.filter(function(e){var t=s&&s.indexOf(e.$Name);if(t>-1){s.splice(t,1)}});a=s.join("/");return n[0].getObject(a)}else if(a){return n[0].getObject(a)}}function G(e,t,r,o){var a=r?r:null;var i=a.split(".");a=a.indexOf(".")>=0?i[i.length-1]:a;var s=a&&o?"".concat(o,"|").concat(a):"";var l="ACTION_PARAMETER_DIALOG_ACTION_NAME";var c=e&&n.checkIfResourceKeyExists(e.aCustomBundles,"".concat(l,"|").concat(s));if(t){if(c){return n.getTranslatedText(l,e,null,s)}else if(e&&n.checkIfResourceKeyExists(e.aCustomBundles,"".concat(l,"|").concat(o))){return n.getTranslatedText(l,e,null,"".concat(o))}else if(e&&n.checkIfResourceKeyExists(e.aCustomBundles,"".concat(l))){return n.getTranslatedText(l,e)}else{return t}}else{return n.getTranslatedText("C_COMMON_DIALOG_OK",e)}}function V(e,t,n,r,o,a,i){var s;if(e.aContexts.length>1){var l;var c=sap.ui.getCore().getMessageManager().getMessageModel().getData();var u=e.internalModelContext.getProperty("processedMessageIds");var f=c.filter(function(t){var n=u.find(function(e){return t.getId()===e});if(!n){u.push(t.getId());if(t.getType()===P.Success){e.internalModelContext.setProperty("DelayMessages",e.internalModelContext.getProperty("DelayMessages").concat(t))}}return t.getPersistent()===true&&t.getType()!==P.Success&&!n});e.internalModelContext.setProperty("processedMessageIds",u);if(f.length){if(e.internalModelContext){l=e.internalModelContext.getProperty("strictHandlingFails");l.push({oAction:t,groupId:n});e.internalModelContext.setProperty("strictHandlingFails",l)}}}if(r===o&&e.internalModelContext&&(s=e.internalModelContext.getProperty("412Messages"))!==null&&s!==void 0&&s.length){p.renderMessageView(e,i,a,e.internalModelContext.getProperty("412Messages"),true)}}function L(e,t,n,r,o,a,i,s){var l,c=true;if(n){var u;var f=e.getBoundContext().getPath();var d=e.getModel().getMetaModel().getMetaPath(f);var g=e.getModel().getMetaModel().getObject(d);if(g&&((u=g[0])===null||u===void 0?void 0:u.$kind)!=="Action"){c=false}}if(!c){l=n?e.execute(r).then(function(){return e.getBoundContext()}):e.execute(r)}else{l=n?e.execute(r,undefined,p.fnOnStrictHandlingFailed.bind(W,r,t,o,s,e.getContext(),i,a)).then(function(){V(t,e,r,s,i,a,o);return Promise.resolve(e.getBoundContext())}).catch(function(){V(t,e,r,s,i,a,o);return Promise.reject()}):e.execute(r,undefined,p.fnOnStrictHandlingFailed.bind(W,r,t,o,s,e.getContext(),i,a)).then(function(n){V(t,e,r,s,i,a,o);return Promise.resolve(n)}).catch(function(){V(t,e,r,s,i,a,o);return Promise.reject()})}return l.catch(function(){throw O.ActionExecutionFailed})}function q(t,n,r,o){var a=n.aContexts||[];var i=n.model;var s=n.aActionParameters||[];var l=n.actionName;var c=n.fnOnSubmitted;var u=n.fnOnResponse;var f=r&&r.isA("sap.ui.core.mvc.View")&&r.getController().oResourceBundle;var d;function g(){if(s&&s.length){for(var e=0;e<s.length;e++){if(!s[e].value){switch(s[e].$Type){case"Edm.String":s[e].value="";break;case"Edm.Boolean":s[e].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":s[e].value=0;break;default:break}}d.setParameter(s[e].$Name,s[e].value)}}}if(a.length){return new Promise(function(r){var s=n.mBindingParameters;var u=n.bGrouped;var v=n.bGetBoundContext;if(n.internalModelContext&&!n.internalModelContext.getProperty("412Executed")){n.internalModelContext.setProperty("strictHandlingPromises",[]);n.internalModelContext.setProperty("strictHandlingFails",[]);n.internalModelContext.setProperty("412Messages",[]);n.internalModelContext.setProperty("processedMessageIds",[]);n.internalModelContext.setProperty("DelayMessages",[])}var m=[];var h;var p;var P;var M=function(e,r,a,i){g();P=!u?"$auto.".concat(r):e.getUpdateGroupId();n.requestSideEffects=J.bind(W,t,a,n);h=L(e,n,v,P,f,o,i,r);m.push(h);J(t,a,n,P)};var x=function(e,r,a,s){return new Promise(function(l){var c=[];g();P="apiMode".concat(r);n.requestSideEffects=J.bind(W,t,a,n,P,c);h=L(e,n,v,P,f,o,s,r);m.push(h);c.push(h);J(t,a,n,P,c);i.submitBatch(P);Promise.all(c).then(function(){return l()}).catch(function(){return l()})})};function C(t){(c||function e(){})(m);function r(e,t,r){d=i.bindContext("".concat(l,"(...)"),e,s);return x(d,t,{context:e,pathExpressions:n.additionalSideEffect&&n.additionalSideEffect.pathExpressions,triggerActions:n.additionalSideEffect&&n.additionalSideEffect.triggerActions},r)}var o=Promise.resolve();var u=0;t.forEach(function(e){var t=++u;o=o.then(function(){return r(e,t,a.length)})});o.then(function(){y()}).catch(function(t){e.error(t)})}if(!u){C(a)}else{for(p=0;p<a.length;p++){d=i.bindContext("".concat(l,"(...)"),a[p],s);M(d,a.length<=1?null:p,{context:a[p],pathExpressions:n.additionalSideEffect&&n.additionalSideEffect.pathExpressions,triggerActions:n.additionalSideEffect&&n.additionalSideEffect.triggerActions},a.length)}(c||function e(){})(m);y()}function y(){return Promise.allSettled(m).then(r)}}).finally(function(){(u||function e(){})()})}else{d=i.bindContext("/".concat(l,"(...)"));g();var v="actionImport";var m=d.execute(v,undefined,p.fnOnStrictHandlingFailed.bind(W,v,{label:n.label,model:i},f,null,null,null,o));i.submitBatch(v);(c||function e(){})(m);return m.finally(function(){(u||function e(){})()})}}function U(e,t){var n=e.getPath();n=e.getObject("$IsBound")?n.split("@$ui5.overload")[0]:n.split("/0")[0];return n.split("/".concat(t))[0]}function K(e,t,n,r){if(n){var o=x(t),a;try{var i=function(){var e=a.value;if(e.$Name!=="ResultIsActiveEntity"&&!(n!==null&&n!==void 0&&n.find(function(t){return t.name===e.$Name}))){return{v:false}}};for(o.s();!(a=o.n()).done;){var s=i();if(typeof s==="object")return s.v}}catch(e){o.e(e)}finally{o.f()}}else if(e&&r){var l=x(t),c;try{for(l.s();!(c=l.n()).done;){var u=c.value;if(!r[u.$Name]){return false}}}catch(e){l.e(e)}finally{l.f()}}return true}function J(n,r,o,a,i){var s=n.getSideEffectsService();var l;if(r&&r.triggerActions&&r.triggerActions.length){r.triggerActions.forEach(function(e){if(e){l=s.executeAction(e,r.context,a);if(i){i.push(l)}}})}if(r&&r.pathExpressions&&r.pathExpressions.length>0){l=s.requestSideEffects(r.pathExpressions,r.context,a);if(i){i.push(l)}l.then(function(){if(o.operationAvailableMap&&o.internalModelContext){t.setActionEnablement(o.internalModelContext,JSON.parse(o.operationAvailableMap),o.selectedItems,"table")}}).catch(function(t){e.error("Error while requesting side effects",t)})}}var W={callBoundAction:I,callActionImport:$,callBoundFunction:N,callFunctionImport:B,executeDependingOnSelectedContexts:L,valuesProvidedForAllParameters:K,getActionParameterActionName:G,actionParameterShowMessageCallback:F,afterActionResolution:_};return W},false);
//# sourceMappingURL=operations.js.map