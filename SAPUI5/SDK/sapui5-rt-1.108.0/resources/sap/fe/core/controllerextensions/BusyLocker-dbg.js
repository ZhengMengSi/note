/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log"], function (Log) {
  "use strict";

  var _iTimeoutInSeconds = 30,
      _mLockCounters = {},
      _oReferenceDummy = {
    getId: function () {
      return "BusyLocker.ReferenceDummy";
    },
    setBusy: function (bBusy) {
      Log.info("setBusy(".concat(bBusy, ") triggered on dummy reference"));
    }
  };

  function getLockCountId(oReference, sPath) {
    return oReference.getId() + (sPath || "/busy");
  }

  function isLocked(oReference, sPath) {
    return getLockCountId(oReference, sPath) in _mLockCounters;
  }

  function getLockCountEntry(oReference, sPath) {
    if (!oReference || !oReference.getId) {
      Log.warning("No reference for BusyLocker, using dummy reference");
      oReference = _oReferenceDummy;
    }

    sPath = sPath || "/busy";
    var sId = getLockCountId(oReference, sPath);

    if (!(sId in _mLockCounters)) {
      _mLockCounters[sId] = {
        id: sId,
        path: sPath,
        reference: oReference,
        count: 0
      };
    }

    return _mLockCounters[sId];
  }
  /**
   * @param mLockCountEntry
   */


  function deleteLockCountEntry(mLockCountEntry) {
    delete _mLockCounters[mLockCountEntry.id];
  }

  function applyLockState(mLockCountEntry) {
    var bIsModel = mLockCountEntry.reference.isA && mLockCountEntry.reference.isA("sap.ui.model.Model"),
        bBusy = mLockCountEntry.count !== 0;

    if (bIsModel) {
      mLockCountEntry.reference.setProperty(mLockCountEntry.path, bBusy, undefined, true);
    } else if (mLockCountEntry.reference.setBusy) {
      mLockCountEntry.reference.setBusy(bBusy);
    }

    clearTimeout(mLockCountEntry.timeout);

    if (bBusy) {
      mLockCountEntry.timeout = setTimeout(function () {
        Log.error("busy lock for ".concat(mLockCountEntry.id, " with value ").concat(mLockCountEntry.count, " timed out after ").concat(_iTimeoutInSeconds, " seconds!"));
      }, _iTimeoutInSeconds * 1000);
    } else {
      deleteLockCountEntry(mLockCountEntry);
    }

    return bBusy;
  }

  function changeLockCount(mLockCountEntry, iDelta) {
    if (iDelta === 0) {
      mLockCountEntry.count = 0;
      Log.info("busy lock count '".concat(mLockCountEntry.id, "' was reset to 0"));
    } else {
      mLockCountEntry.count += iDelta;
      Log.info("busy lock count '".concat(mLockCountEntry.id, "' is ").concat(mLockCountEntry.count));
    }
  }

  var BusyLocker = {
    lock: function (oModelOrControl, sPath) {
      return this._updateLock(oModelOrControl, sPath, 1);
    },
    unlock: function (oModelOrControl, sPath) {
      return this._updateLock(oModelOrControl, sPath, -1);
    },
    isLocked: function (oModelOrControl, sPath) {
      return isLocked(oModelOrControl, sPath);
    },
    _updateLock: function (oReference, sPath, iDelta) {
      var mLockCountEntry = getLockCountEntry(oReference, sPath);
      changeLockCount(mLockCountEntry, iDelta);
      return applyLockState(mLockCountEntry);
    }
  };
  return BusyLocker;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfaVRpbWVvdXRJblNlY29uZHMiLCJfbUxvY2tDb3VudGVycyIsIl9vUmVmZXJlbmNlRHVtbXkiLCJnZXRJZCIsInNldEJ1c3kiLCJiQnVzeSIsIkxvZyIsImluZm8iLCJnZXRMb2NrQ291bnRJZCIsIm9SZWZlcmVuY2UiLCJzUGF0aCIsImlzTG9ja2VkIiwiZ2V0TG9ja0NvdW50RW50cnkiLCJ3YXJuaW5nIiwic0lkIiwiaWQiLCJwYXRoIiwicmVmZXJlbmNlIiwiY291bnQiLCJkZWxldGVMb2NrQ291bnRFbnRyeSIsIm1Mb2NrQ291bnRFbnRyeSIsImFwcGx5TG9ja1N0YXRlIiwiYklzTW9kZWwiLCJpc0EiLCJzZXRQcm9wZXJ0eSIsInVuZGVmaW5lZCIsImNsZWFyVGltZW91dCIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwiZXJyb3IiLCJjaGFuZ2VMb2NrQ291bnQiLCJpRGVsdGEiLCJCdXN5TG9ja2VyIiwibG9jayIsIm9Nb2RlbE9yQ29udHJvbCIsIl91cGRhdGVMb2NrIiwidW5sb2NrIl0sInNvdXJjZVJvb3QiOiIuIiwic291cmNlcyI6WyJCdXN5TG9ja2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMb2cgZnJvbSBcInNhcC9iYXNlL0xvZ1wiO1xuY29uc3QgX2lUaW1lb3V0SW5TZWNvbmRzID0gMzAsXG5cdF9tTG9ja0NvdW50ZXJzOiBhbnkgPSB7fSxcblx0X29SZWZlcmVuY2VEdW1teSA9IHtcblx0XHRnZXRJZDogZnVuY3Rpb24gKCkge1xuXHRcdFx0cmV0dXJuIFwiQnVzeUxvY2tlci5SZWZlcmVuY2VEdW1teVwiO1xuXHRcdH0sXG5cdFx0c2V0QnVzeTogZnVuY3Rpb24gKGJCdXN5OiBhbnkpIHtcblx0XHRcdExvZy5pbmZvKGBzZXRCdXN5KCR7YkJ1c3l9KSB0cmlnZ2VyZWQgb24gZHVtbXkgcmVmZXJlbmNlYCk7XG5cdFx0fVxuXHR9O1xuZnVuY3Rpb24gZ2V0TG9ja0NvdW50SWQob1JlZmVyZW5jZTogYW55LCBzUGF0aDogYW55KSB7XG5cdHJldHVybiBvUmVmZXJlbmNlLmdldElkKCkgKyAoc1BhdGggfHwgXCIvYnVzeVwiKTtcbn1cbmZ1bmN0aW9uIGlzTG9ja2VkKG9SZWZlcmVuY2U6IGFueSwgc1BhdGg6IGFueSkge1xuXHRyZXR1cm4gZ2V0TG9ja0NvdW50SWQob1JlZmVyZW5jZSwgc1BhdGgpIGluIF9tTG9ja0NvdW50ZXJzO1xufVxuZnVuY3Rpb24gZ2V0TG9ja0NvdW50RW50cnkob1JlZmVyZW5jZTogYW55LCBzUGF0aDogYW55KSB7XG5cdGlmICghb1JlZmVyZW5jZSB8fCAhb1JlZmVyZW5jZS5nZXRJZCkge1xuXHRcdExvZy53YXJuaW5nKFwiTm8gcmVmZXJlbmNlIGZvciBCdXN5TG9ja2VyLCB1c2luZyBkdW1teSByZWZlcmVuY2VcIik7XG5cdFx0b1JlZmVyZW5jZSA9IF9vUmVmZXJlbmNlRHVtbXk7XG5cdH1cblxuXHRzUGF0aCA9IHNQYXRoIHx8IFwiL2J1c3lcIjtcblx0Y29uc3Qgc0lkID0gZ2V0TG9ja0NvdW50SWQob1JlZmVyZW5jZSwgc1BhdGgpO1xuXG5cdGlmICghKHNJZCBpbiBfbUxvY2tDb3VudGVycykpIHtcblx0XHRfbUxvY2tDb3VudGVyc1tzSWRdID0ge1xuXHRcdFx0aWQ6IHNJZCxcblx0XHRcdHBhdGg6IHNQYXRoLFxuXHRcdFx0cmVmZXJlbmNlOiBvUmVmZXJlbmNlLFxuXHRcdFx0Y291bnQ6IDBcblx0XHR9O1xuXHR9XG5cdHJldHVybiBfbUxvY2tDb3VudGVyc1tzSWRdO1xufVxuLyoqXG4gKiBAcGFyYW0gbUxvY2tDb3VudEVudHJ5XG4gKi9cbmZ1bmN0aW9uIGRlbGV0ZUxvY2tDb3VudEVudHJ5KG1Mb2NrQ291bnRFbnRyeTogYW55KSB7XG5cdGRlbGV0ZSBfbUxvY2tDb3VudGVyc1ttTG9ja0NvdW50RW50cnkuaWRdO1xufVxuXG5mdW5jdGlvbiBhcHBseUxvY2tTdGF0ZShtTG9ja0NvdW50RW50cnk6IGFueSkge1xuXHRjb25zdCBiSXNNb2RlbCA9IG1Mb2NrQ291bnRFbnRyeS5yZWZlcmVuY2UuaXNBICYmIG1Mb2NrQ291bnRFbnRyeS5yZWZlcmVuY2UuaXNBKFwic2FwLnVpLm1vZGVsLk1vZGVsXCIpLFxuXHRcdGJCdXN5ID0gbUxvY2tDb3VudEVudHJ5LmNvdW50ICE9PSAwO1xuXG5cdGlmIChiSXNNb2RlbCkge1xuXHRcdG1Mb2NrQ291bnRFbnRyeS5yZWZlcmVuY2Uuc2V0UHJvcGVydHkobUxvY2tDb3VudEVudHJ5LnBhdGgsIGJCdXN5LCB1bmRlZmluZWQsIHRydWUpO1xuXHR9IGVsc2UgaWYgKG1Mb2NrQ291bnRFbnRyeS5yZWZlcmVuY2Uuc2V0QnVzeSkge1xuXHRcdG1Mb2NrQ291bnRFbnRyeS5yZWZlcmVuY2Uuc2V0QnVzeShiQnVzeSk7XG5cdH1cblxuXHRjbGVhclRpbWVvdXQobUxvY2tDb3VudEVudHJ5LnRpbWVvdXQpO1xuXHRpZiAoYkJ1c3kpIHtcblx0XHRtTG9ja0NvdW50RW50cnkudGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuXHRcdFx0TG9nLmVycm9yKFxuXHRcdFx0XHRgYnVzeSBsb2NrIGZvciAke21Mb2NrQ291bnRFbnRyeS5pZH0gd2l0aCB2YWx1ZSAke21Mb2NrQ291bnRFbnRyeS5jb3VudH0gdGltZWQgb3V0IGFmdGVyICR7X2lUaW1lb3V0SW5TZWNvbmRzfSBzZWNvbmRzIWBcblx0XHRcdCk7XG5cdFx0fSwgX2lUaW1lb3V0SW5TZWNvbmRzICogMTAwMCk7XG5cdH0gZWxzZSB7XG5cdFx0ZGVsZXRlTG9ja0NvdW50RW50cnkobUxvY2tDb3VudEVudHJ5KTtcblx0fVxuXG5cdHJldHVybiBiQnVzeTtcbn1cblxuZnVuY3Rpb24gY2hhbmdlTG9ja0NvdW50KG1Mb2NrQ291bnRFbnRyeTogYW55LCBpRGVsdGE6IGFueSkge1xuXHRpZiAoaURlbHRhID09PSAwKSB7XG5cdFx0bUxvY2tDb3VudEVudHJ5LmNvdW50ID0gMDtcblx0XHRMb2cuaW5mbyhgYnVzeSBsb2NrIGNvdW50ICcke21Mb2NrQ291bnRFbnRyeS5pZH0nIHdhcyByZXNldCB0byAwYCk7XG5cdH0gZWxzZSB7XG5cdFx0bUxvY2tDb3VudEVudHJ5LmNvdW50ICs9IGlEZWx0YTtcblx0XHRMb2cuaW5mbyhgYnVzeSBsb2NrIGNvdW50ICcke21Mb2NrQ291bnRFbnRyeS5pZH0nIGlzICR7bUxvY2tDb3VudEVudHJ5LmNvdW50fWApO1xuXHR9XG59XG5cbmNvbnN0IEJ1c3lMb2NrZXIgPSB7XG5cdGxvY2s6IGZ1bmN0aW9uIChvTW9kZWxPckNvbnRyb2w6IGFueSwgc1BhdGg/OiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gdGhpcy5fdXBkYXRlTG9jayhvTW9kZWxPckNvbnRyb2wsIHNQYXRoLCAxKTtcblx0fSxcblxuXHR1bmxvY2s6IGZ1bmN0aW9uIChvTW9kZWxPckNvbnRyb2w6IGFueSwgc1BhdGg/OiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gdGhpcy5fdXBkYXRlTG9jayhvTW9kZWxPckNvbnRyb2wsIHNQYXRoLCAtMSk7XG5cdH0sXG5cblx0aXNMb2NrZWQ6IGZ1bmN0aW9uIChvTW9kZWxPckNvbnRyb2w6IGFueSwgc1BhdGg/OiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gaXNMb2NrZWQob01vZGVsT3JDb250cm9sLCBzUGF0aCk7XG5cdH0sXG5cblx0X3VwZGF0ZUxvY2s6IGZ1bmN0aW9uIChvUmVmZXJlbmNlOiBhbnksIHNQYXRoOiBhbnksIGlEZWx0YTogYW55KSB7XG5cdFx0Y29uc3QgbUxvY2tDb3VudEVudHJ5ID0gZ2V0TG9ja0NvdW50RW50cnkob1JlZmVyZW5jZSwgc1BhdGgpO1xuXHRcdGNoYW5nZUxvY2tDb3VudChtTG9ja0NvdW50RW50cnksIGlEZWx0YSk7XG5cdFx0cmV0dXJuIGFwcGx5TG9ja1N0YXRlKG1Mb2NrQ291bnRFbnRyeSk7XG5cdH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IEJ1c3lMb2NrZXI7XG4iXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBO0FBQUE7Ozs7RUFDQSxJQUFNQSxrQkFBa0IsR0FBRyxFQUEzQjtFQUFBLElBQ0NDLGNBQW1C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