/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/controllerextensions/pageReady/DataQueryWatcher","sap/fe/core/services/TemplatedViewServiceFactory","sap/ui/base/EventProvider","sap/ui/core/Component","sap/ui/core/Core","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../CommonUtils","../helpers/ClassSupport"],function(e,t,i,r,n,o,a,s,c){"use strict";var p,h,d,u,f,g,l,y,v,b,P,_,R,m,E,O,C,w,D,A,x,W,j;var B=c.publicExtension;var I=c.privateExtension;var F=c.methodOverride;var T=c.finalExtension;var k=c.extensible;var U=c.defineUI5Class;function S(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;q(e,t)}function q(e,t){q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,i){t.__proto__=i;return t};return q(e,t)}function V(e,t,i,r,n){var o={};Object.keys(r).forEach(function(e){o[e]=r[e]});o.enumerable=!!o.enumerable;o.configurable=!!o.configurable;if("value"in o||o.initializer){o.writable=true}o=i.slice().reverse().reduce(function(i,r){return r(e,t,i)||i},o);if(n&&o.initializer!==void 0){o.value=o.initializer?o.initializer.call(n):void 0;o.initializer=undefined}if(o.initializer===void 0){Object.defineProperty(e,t,o);o=null}return o}var z=(p=U("sap.fe.core.controllerextensions.PageReady"),h=F(),d=F(),u=B(),f=T(),g=F("_routing"),l=F("_routing"),y=F("_routing"),v=B(),b=T(),P=B(),_=T(),R=B(),m=T(),E=B(),O=T(),C=B(),w=T(),D=I(),A=k(a.Instead),x=B(),p(W=(j=function(o){S(a,o);function a(){return o.apply(this,arguments)||this}var c=a.prototype;c.onInit=function t(){var n=this;this._nbWaits=0;this._oEventProvider=this._oEventProvider?this._oEventProvider:new i;this._oView=this.base.getView();this._oAppComponent=s.getAppComponent(this._oView);this._oPageComponent=r.getOwnerComponentFor(this._oView);if(this._oPageComponent&&this._oPageComponent.attachContainerDefined){this._oPageComponent.attachContainerDefined(function(e){return n.registerContainer(e.getParameter("container"))})}else{this.registerContainer(this._oView)}var o=this._oAppComponent.getRootControl().getController();var a=o.getPlaceholder&&o.getPlaceholder();if(a!==null&&a!==void 0&&a.isPlaceholderDebugEnabled()){this.attachEvent("pageReady",null,function(){a.getPlaceholderDebugStats().iPageReadyEventTimestamp=Date.now()},this);this.attachEvent("heroesBatchReceived",null,function(){a.getPlaceholderDebugStats().iHeroesBatchReceivedEventTimestamp=Date.now()},this)}this.queryWatcher=new e(this._oEventProvider,this.checkPageReadyDebounced.bind(this))};c.onExit=function e(){delete this._oAppComponent;if(this._oContainer){this._oContainer.removeEventDelegate(this._fnContainerDelegate)}};c.waitFor=function e(t){var i=this;this._nbWaits++;t.finally(function(){setTimeout(function(){i._nbWaits--},0)}).catch(null)};c.onRouteMatched=function e(){this._bIsPageReady=false};c.onRouteMatchedFinished=function e(){try{var t=this;return Promise.resolve(t.onAfterBindingPromise).then(function(){t.checkPageReadyDebounced()})}catch(e){return Promise.reject(e)}};c.registerAggregatedControls=function e(t){var i=this;if(t){var r=t.getBinding();this.queryWatcher.registerBinding(r)}var n=[];var o=this.getView().findAggregatedObjects(true);o.forEach(function(e){var t=e.getObjectBinding();if(t){i.queryWatcher.registerBinding(t)}else{var r=Object.keys(e.mBindingInfos);r.forEach(function(t){var r=e.mBindingInfos[t].binding;if(r&&r.isA("sap.ui.model.odata.v4.ODataListBinding")){i.queryWatcher.registerBinding(r)}})}if(e.isA("sap.ui.mdc.Table")||e.isA("sap.ui.mdc.Chart")){i.bTablesChartsLoaded=false;n.push(i.queryWatcher.registerTableOrChart(e))}else if(e.isA("sap.fe.core.controls.FilterBar")){i.queryWatcher.registerFilterBar(e)}});return n};c.onAfterBinding=function e(t){var i=this;var r=this;if(this._bAfterBindingAlreadyApplied){return}this._bAfterBindingAlreadyApplied=true;if(this.isContextExpected()&&t===undefined){this.bHasContext=false;return}else{this.bHasContext=true}this.attachEventOnce("pageReady",null,function(){r._bAfterBindingAlreadyApplied=false;r.queryWatcher.reset()},null);this.onAfterBindingPromise=new Promise(function(e){try{var r=i.registerAggregatedControls(t);var n=function(){if(r.length>0){return Promise.resolve(Promise.all(r)).then(function(){i.bTablesChartsLoaded=true;i.checkPageReadyDebounced();e()})}else{i.checkPageReadyDebounced();e()}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})};c.isPageReady=function e(){return this._bIsPageReady};c.waitPageReady=function e(){var t=this;return new Promise(function(e){if(t.isPageReady()){e()}else{t.attachEventOnce("pageReady",null,function(){e()},t)}})};c.attachEventOnce=function e(t,i,r,n){return this._oEventProvider.attachEventOnce(t,i,r,n)};c.attachEvent=function e(t,i,r,n){return this._oEventProvider.attachEvent(t,i,r,n)};c.detachEvent=function e(t,i){return this._oEventProvider.detachEvent(t,i)};c.registerContainer=function e(t){var i=this;this._oContainer=t;this._fnContainerDelegate={onBeforeShow:function(){i.bShown=false;i._bIsPageReady=false},onBeforeHide:function(){i.bShown=false;i._bIsPageReady=false},onAfterShow:function(){var e;i.bShown=true;(e=i.onAfterBindingPromise)===null||e===void 0?void 0:e.then(function(){i._checkPageReady(true)})}};this._oContainer.addEventDelegate(this._fnContainerDelegate,this)};c.isContextExpected=function e(){return false};c.checkPageReadyDebounced=function e(){var t=this;if(this.pageReadyTimer){clearTimeout(this.pageReadyTimer)}this.pageReadyTimer=setTimeout(function(){t._checkPageReady()},200)};c._checkPageReady=function e(){var i=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var o=function(){if(!n.getUIDirty()){n.detachEvent("UIUpdated",o);i._bWaitingForRefresh=false;setTimeout(function(){i._checkPageReady()},20)}};var a=function(){if(n.getUIDirty()){setTimeout(a,500)}else if(i._bWaitingForRefresh){i._bWaitingForRefresh=false;n.detachEvent("UIUpdated",o);i._checkPageReady()}};if(this.bShown&&this.queryWatcher.isDataReceived()!==false&&this.bTablesChartsLoaded!==false&&(!this.isContextExpected()||this.bHasContext)){if(this.queryWatcher.isDataReceived()===true&&!r&&!this._bWaitingForRefresh&&n.getUIDirty()){this.queryWatcher.resetDataReceived();this._bWaitingForRefresh=true;n.attachEvent("UIUpdated",o);setTimeout(a,500)}else if(!this._bWaitingForRefresh&&n.getUIDirty()||this._nbWaits!==0||t.getNumberOfViewsInCreationState()>0||this.queryWatcher.isSearchPending()){this._bWaitingForRefresh=true;n.attachEvent("UIUpdated",o);setTimeout(a,500)}else if(!this._bWaitingForRefresh){this._bIsPageReady=true;this._oEventProvider.fireEvent("pageReady")}}};return a}(o),V(j.prototype,"onInit",[h],Object.getOwnPropertyDescriptor(j.prototype,"onInit"),j.prototype),V(j.prototype,"onExit",[d],Object.getOwnPropertyDescriptor(j.prototype,"onExit"),j.prototype),V(j.prototype,"waitFor",[u,f],Object.getOwnPropertyDescriptor(j.prototype,"waitFor"),j.prototype),V(j.prototype,"onRouteMatched",[g],Object.getOwnPropertyDescriptor(j.prototype,"onRouteMatched"),j.prototype),V(j.prototype,"onRouteMatchedFinished",[l],Object.getOwnPropertyDescriptor(j.prototype,"onRouteMatchedFinished"),j.prototype),V(j.prototype,"onAfterBinding",[y],Object.getOwnPropertyDescriptor(j.prototype,"onAfterBinding"),j.prototype),V(j.prototype,"isPageReady",[v,b],Object.getOwnPropertyDescriptor(j.prototype,"isPageReady"),j.prototype),V(j.prototype,"waitPageReady",[P,_],Object.getOwnPropertyDescriptor(j.prototype,"waitPageReady"),j.prototype),V(j.prototype,"attachEventOnce",[R,m],Object.getOwnPropertyDescriptor(j.prototype,"attachEventOnce"),j.prototype),V(j.prototype,"attachEvent",[E,O],Object.getOwnPropertyDescriptor(j.prototype,"attachEvent"),j.prototype),V(j.prototype,"detachEvent",[C,w],Object.getOwnPropertyDescriptor(j.prototype,"detachEvent"),j.prototype),V(j.prototype,"isContextExpected",[D,A],Object.getOwnPropertyDescriptor(j.prototype,"isContextExpected"),j.prototype),V(j.prototype,"checkPageReadyDebounced",[x],Object.getOwnPropertyDescriptor(j.prototype,"checkPageReadyDebounced"),j.prototype),j))||W);return z},false);
//# sourceMappingURL=PageReady.js.map