/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/m/MessageBox"],function(e,t,r,n){"use strict";var o={};var i=r.CollaborationUtils;var a=r.Activity;var c=t.isCollaborationConnected;var l=t.initializeCollaboration;var s=t.endCollaboration;var u=t.broadcastCollaborationMessage;function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach(function(t){d(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function d(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}var g="/collaboration/myActivity";var p="/collaboration/activeUsers";var C="/collaboration/activities";var b=function(e){var t=e.getModel("internal");return c(t)};o.isConnected=b;var y=function(e,t,r){if(b(e)){var n=e.getModel("internal");var o=Array.isArray(r)?r.join("|"):r;if(t===a.LiveChange){var i=n.getProperty(g);if(i===o){return}else{n.setProperty(g,o)}}else{n.setProperty(g,null)}u(t,o,n)}};o.send=y;var P=function(e){return e.getModel().getMetaModel().getObject("/@com.sap.vocabularies.Common.v1.WebSocketBaseURL")};var m=function(e){var t=(e===null||e===void 0?void 0:e.getBindingContext)&&e.getBindingContext();return!!(t&&P(t))};o.isCollaborationEnabled=m;var O=function(e){try{var t=e.getModel("internal");var r=i.getMe(e);if(!r){return Promise.resolve()}var n=e.getBindingContext();var o=P(n);var a=n.getModel().getServiceUrl();if(!o){return Promise.resolve()}return Promise.resolve(n.requestProperty("DraftAdministrativeData/DraftUUID")).then(function(n){if(!n){return}l(r,o,n,a,t,function(t){h(t,e)})})}catch(e){return Promise.reject(e)}};o.connect=O;var A=function(e){var t=e.getModel("internal");s(t)};o.disconnect=A;function h(e,t){var r,o;var c=t.getModel("internal");var l=c.getProperty(p);var s;var v;var d=e.clientContent&&t.getModel().getMetaModel().getMetaPath(e.clientContent);e.userAction=e.userAction||e.clientAction;var b={id:e.userID,name:e.userDescription,initials:i.formatInitials(e.userDescription),color:i.getUserColor(e.userID,l,[])};var y=b;switch(e.userAction){case a.Join:case a.JoinEcho:if(l.findIndex(function(e){return e.id===b.id})===-1){l.unshift(b);c.setProperty(p,l)}if(e.userAction===a.Join){u(a.JoinEcho,c.getProperty(g),c)}if(e.userAction===a.JoinEcho){if(e.clientContent){e.userAction=a.LiveChange;h(e,t)}}break;case a.Leave:l=l.filter(function(e){return e.id!==b.id||e.me});c.setProperty(p,l);var P=c.getProperty(C)||{};var m=function(e){if(Array.isArray(e)){return e.filter(function(e){return e.id!==b.id})}else{for(var t in e){e[t]=m(e[t])}return e}};m(P);c.setProperty(C,P);break;case a.Change:var O=e===null||e===void 0?void 0:(r=e.clientContent)===null||r===void 0?void 0:r.split("|").map(function(e){return t.getModel().getMetaModel().getMetaPath(e)});O.forEach(function(r,n){var o,i;var l=f(f({},e),{},{clientContent:e===null||e===void 0?void 0:(o=e.clientContent)===null||o===void 0?void 0:o.split("|")[n]});var s=c.getProperty(C+r)||[];v=E(l.clientContent);s=((i=s)===null||i===void 0?void 0:i.filter)&&s.filter(function(e){return e.key!==v});if(s){c.setProperty(C+r,s);M(t,l,r,a.Change)}});break;case a.Create:M(t,e,d,a.Create);break;case a.Delete:M(t,e,d,a.Delete);break;case a.Activate:A(t);n.information(i.getText("C_COLLABORATIONDRAFT_ACTIVATE",b.name));D(e.clientContent,t);break;case a.Discard:A(t);n.information(i.getText("C_COLLABORATIONDRAFT_DISCARD",b.name));D(e.clientContent,t);break;case a.LiveChange:y=b;y.key=E(e.clientContent);var x="";var j=d.split("/");for(var k=1;k<j.length-1;k++){x+="/".concat(j[k]);if(!c.getProperty(C+x)){c.setProperty(C+x,{})}}s=c.getProperty(C+d);s=(o=s)!==null&&o!==void 0&&o.slice?s.slice():[];s.push(y);c.setProperty(C+d,s);break;case a.Undo:s=c.getProperty(C+d);v=E(e.clientContent);c.setProperty(C+d,s.filter(function(e){return e.key!==v}));break}}function M(e,t,r,o){var c=i.getAppComponent(e);var l=e.getModel().getMetaModel();var s=x(e);var u=c.getSideEffectsService();var v=s.getBindingContext();var f=v.getPath();var d=l.getMetaPath(f);var g=t.clientContent;if(o===a.Delete){var p=t.clientContent.split("|");var C=p.findIndex(function(e){return f.startsWith(e)});if(C>-1){n.information(i.getText("C_COLLABORATIONDRAFT_DELETE",t.userDescription),{onClose:function(){var t=e.getModel().bindContext(p[C]).getBoundContext();s.getController()._routing.navigateBackFromContext(t)}})}g=p[0]}if(g.startsWith(f)){var b=r.replace(d,"").slice(1);if(b){(function(){var e=[{$PropertyPath:b}];var t=u.getEntityTypeFromContext(v);var r=u.getODataEntitySideEffects(t);var n=Object;var o=n.fromEntries(n.entries(r).filter(function(e){var t;return((t=e[1].SourceProperties)===null||t===void 0?void 0:t.findIndex(function(e){return e.value===b}))>-1}));for(var i in o){o[i].TargetProperties.forEach(function(t){e.push({$PropertyPath:t})})}u.requestSideEffects(e,v,"$auto")})()}}s.getController().editFlow.updateDocument(v,Promise.resolve())}function D(e,t){var r=x(t);var n=t.getModel().bindContext(e).getBoundContext();r.getController().routing.navigate(n)}function x(t){var r=i.getAppComponent(t);return e.getCurrentPageView(r)}function E(e){return e.substring(e.lastIndexOf("(")+1,e.lastIndexOf(")"))}return{connect:O,disconnect:A,isConnected:b,isCollaborationEnabled:m,send:y}},false);
//# sourceMappingURL=ActivitySync.js.map