/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/library","sap/fe/core/templating/PropertyFormatters","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/FilterUtils","sap/fe/navigation/library","sap/ui/Device","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/p13n/StateUtil"],function(t,e,a,r,i,n,o,l,s,d,g,u,f){"use strict";var p=d.system;var c=s.NavType,h=i.VariantManagement,v=i.TemplateContentView,V=i.InitialLoadMode;var C=e.FilterRestrictions,y=/\+|\*/g;var _={_bSearchTriggered:false,applyInitialStateOnly:function(){return true},onBeforeStateApplied:function(t){var e=this.getView(),a=e.getController(),r=a._getFilterBarControl(),i=a._getControls("table");if(r){r.setSuspendSelection(true);t.push(r.waitForInitialization())}i.forEach(function(e){t.push(e.initialized())});delete this._bSearchTriggered},onAfterStateApplied:function(){var t=this.getView().getController();var e=t._getFilterBarControl();if(e){e.setSuspendSelection(false)}else if(t._isFilterBarHidden()){var a=t.getView().getBindingContext("internal");a.setProperty("hasPendingFilters",false);if(t._isMultiMode()){t._getMultiModeControl().setCountsOutDated(true)}}},adaptBindingRefreshControls:function(t){var e=this.getView(),r=e.getController(),i=r._getControls(),n=a.getControlsForRefresh(e,i);Array.prototype.push.apply(t,n)},adaptStateControls:function(t){var e=this.getView(),a=e.getController(),r=e.getViewData(),i=r.variantManagement===h.Control;var n=this._getFilterBarVM(e);if(n){t.push(n)}if(a._isMultiMode()){t.push(a._getMultiModeControl())}a._getControls("table").forEach(function(e){var a=e.getQuickFilter();if(a){t.push(a)}if(i){t.push(e.getVariant())}t.push(e)});if(a._getControls("Chart")){a._getControls("Chart").forEach(function(e){t.push(e)})}if(a._hasMultiVisualizations()){t.push(a._getSegmentedButton(v.Chart));t.push(a._getSegmentedButton(v.Table))}var o=a._getFilterBarControl();if(o){t.push(o)}t.push(e.byId("fe::ListReport"))},retrieveAdditionalStates:function(t){var e=this.getView(),a=e.getController(),r=e.getBindingContext("internal").getProperty("hasPendingFilters");t.dataLoaded=!r||!!this._bSearchTriggered;if(a._hasMultiVisualizations()){var i=e.getBindingContext("internal").getProperty("alpContentView");t.alpContentView=i}delete this._bSearchTriggered},applyAdditionalStates:function(t){var e=this.getView(),a=e.getController(),r=a._getFilterBarControl();if(t){if(t.dataLoaded===false&&r){r._bSearchTriggered=false}else if(t.dataLoaded===true){if(r){r.triggerSearch()}this._bSearchTriggered=true}if(a._hasMultiVisualizations()){var i=e.getBindingContext("internal");if(!p.desktop&&t.alpContentView==v.Hybrid){t.alpContentView=v.Chart}i.getModel().setProperty("".concat(i.getPath(),"/alpContentView"),t.alpContentView)}}},_applyNavigationParametersToFilterbar:function(e,a){var r=this;var i=this.getView();var n=i.getController();var o=n.getAppComponent();var l=o.getComponentData();var s=l&&l.startupParameters||{};var d=this.handleVariantIdPassedViaURLParams(s);var g;a.push(d.then(function(t){if(t&&t.length>0){if(t[0]===true||t[1]===true){g=true}}return r._applySelectionVariant(i,e,g)}).then(function(){var t=n._getDynamicListReportControl();var a=false;var o=r._getFilterBarVM(i);var l=n._getFilterBarControl();if(l){if(e.navigationType!==c.initial&&e.requiresStandardVariant||!o&&i.getViewData().initialLoad===V.Enabled||n._shouldAutoTriggerSearch(o)){l.triggerSearch()}else{a=r._preventInitialSearch(o)}l.setSuspendSelection(false);r._bSearchTriggered=!a;t.setHeaderExpanded(p.desktop||a)}}).catch(function(){t.error("Variant ID cannot be applied")}))},handleVariantIdPassedViaURLParams:function(t){var e=t["sap-ui-fe-variant-id"],a=t["sap-ui-fe-filterbar-variant-id"],r=t["sap-ui-fe-table-variant-id"];var i;if(e||a||r){i={sPageVariantId:e&&e[0],sFilterBarVariantId:a&&a[0],sTableVariantId:r&&r[0]}}return this._handleControlVariantId(i)},_handleControlVariantId:function(t){var e=this;var a;var r=this.getView(),i=[];var n=r.getViewData().variantManagement;if(t&&t.sPageVariantId&&n==="Page"){a=r.byId("fe::PageVariantManagement");a.getVariants().forEach(function(r){if(r.key===t.sPageVariantId){i.push(e._applyControlVariant(a,t.sPageVariantId,true))}})}else if(t&&n==="Control"){if(t.sFilterBarVariantId){a=r.getController()._getFilterBarVariantControl();if(a){a.getVariants().forEach(function(r){if(r.key===t.sFilterBarVariantId){i.push(e._applyControlVariant(a,t.sFilterBarVariantId,true))}})}}if(t.sTableVariantId){var o=r.getController(),l=o._getControls("table");l.forEach(function(a){var r=a.getVariant();if(a&&r){r.getVariants().forEach(function(a){if(a.key===t.sTableVariantId){i.push(e._applyControlVariant(r,t.sTableVariantId))}})}})}}return Promise.all(i)},_applyControlVariant:function(t,e,a){var r=this._checkIfVariantIdIsAvailable(t,e)?e:t.getStandardVariantKey();var i=g.activateVariant({element:t,variantReference:r});return i.then(function(){return a})},_getFilterBarVM:function(t){var e=t.getViewData();switch(e.variantManagement){case h.Page:return t.byId("fe::PageVariantManagement");case h.Control:return t.getController()._getFilterBarVariantControl();case h.None:return null;default:throw new Error("unhandled variant setting: ".concat(e.variantManagement))}},_preventInitialSearch:function(t){if(!t){return true}var e=t.getVariants();var a=e.find(function(e){return e.key===t.getCurrentVariantKey()});return!a.executeOnSelect},_applySelectionVariant:function(t,a,r){var i=t.getController()._getFilterBarControl(),n=a.selectionVariant,o=a.selectionVariantDefaults;if(!i||!n){return Promise.resolve()}var l={};var s=t.getModel().getMetaModel();var d=t.getViewData();var g=d.contextPath||"/".concat(d.entitySet);var u=e.getMandatoryFilterFields(s,g);var f=i.data("useSemanticDateRange");var p;switch(d.variantManagement){case h.Page:p=t.byId("fe::PageVariantManagement");break;case h.Control:p=t.getController()._getFilterBarVariantControl();break;case h.None:default:break}var c=a.requiresStandardVariant;var v=o&&o.getSelectOptionsPropertyNames().length>0&&p.getDefaultVariantKey()===p.getStandardVariantKey()&&a.bNavSelVarHasDefaultsOnly;if(r||v){l=i.getConditions()}e.addDefaultDisplayCurrency(u,n,o);e.addSelectionVariantToConditions(n,l,s,g,v,f,d);return this._activateSelectionVariant(i,l,p,c,r)},_activateSelectionVariant:function(t,e,a,r,i){var n=this;var o;if(a&&!i){var l=r?a.getStandardVariantKey():a.getDefaultVariantKey();if(l===null){l=a.getId()}o=g.activateVariant({element:a,variantReference:l}).then(function(){return r||a.getDefaultVariantKey()===a.getStandardVariantKey()})}else{o=Promise.resolve(true)}return o.then(function(a){if(a){return n._fnApplyConditions(t,e)}})},_fnApplyConditions:function(t,a){var i={},s=[],d=function(t){t.validated=u.Validated;if(t.operator==="Empty"){t.operator="EQ";t.values=[""]}else if(t.operator==="NotEmpty"){t.operator="NE";t.values=[""]}delete t.isEmpty};var g=function(t,a){var i=r.getEntitySetPath(a),o=t.getModel().getMetaModel(),s=e.getFilterRestrictionsByPath(i,o),d=s[C.NON_FILTERABLE_PROPERTIES],g=l.getConvertedFilterFields(t,a),u=[];Object.keys(g).forEach(function(t){var e=g[t];var a=e.conditionPath.replace(y,"");if(d.indexOf(a)===-1){var r=e.annotationPath;var i=o.createBindingContext(r);u.push({path:e.conditionPath,hiddenFilter:e.availability==="Hidden",hasValueHelp:!r?false:n.hasValueHelp(i.getObject(),{context:i})})}});return u};return t.waitForInitialization().then(function(){var e=o.getCustomData(t,"entityType");var r=g(t,e);r.filter(function(t){return t.path!=="$editState"&&t.path!=="$search"}).forEach(function(t){if(t.path in a){i[t.path]=a[t.path];if(!t.hiddenFilter){s.push({name:t.path})}if(t.hasValueHelp){i[t.path].forEach(d)}else{i[t.path].forEach(function(t){t.validated=t.filtered?u.NotValidated:t.validated})}}else{i[t.path]=[]}});return f.applyExternalState(t,{filter:i,items:s})})}};return _},false);
//# sourceMappingURL=ViewState.js.map