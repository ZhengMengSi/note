/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/TypeUtil","sap/fe/macros/DelegateUtil","sap/fe/macros/ODataMetaModelUtil","sap/ui/core/Core","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,r,a,i,n,o,l,p,s,f,d,u,c,v,g,h,y){"use strict";var m=l.getLabel;var b=l.getAssociatedUnitPropertyPath;var P=l.getAssociatedUnitProperty;var C=l.getAssociatedTimezonePropertyPath;var I=l.getAssociatedTimezoneProperty;var M=l.getAssociatedTextPropertyPath;var T=l.getAssociatedTextProperty;var D=l.getAssociatedCurrencyPropertyPath;var O=l.getAssociatedCurrencyProperty;var F=o.getDisplayMode;var x=i.getInvolvedDataModelObjects;var U=a.fetchTypeConfig;var E=Object.assign({},u);E.fetchProperties=function(e){var t=this;var r=this._getModel(e);var a;if(!r){a=new Promise(function(r){e.attachModelContextChange({resolver:r},$,t)}).then(function(r){return t._createPropertyInfos(e,r)})}else{a=this._createPropertyInfos(e,r)}return a.then(function(t){if(e.data){e.data("$tablePropertyInfo",t)}return t})};function $(e,t){var r=e.getSource();var a=this._getModel(r);if(a){r.detachModelContextChange($);t.resolver(a)}}function A(e,t,r){var a,i,n,o,l;var p={properties:{}},s=(a=e.annotations)===null||a===void 0?void 0:(i=a.Common)===null||i===void 0?void 0:i.Text,f=s===null||s===void 0?void 0:(n=s.annotations)===null||n===void 0?void 0:(o=n.UI)===null||o===void 0?void 0:(l=o.TextArrangement)===null||l===void 0?void 0:l.toString(),d=s&&f&&F(e);if(t){if(d==="Description"){p.properties[t.name]=t}else if(d&&d!=="Value"||!s){p.properties[e.name]=r;p.properties[t.name]=t}}return p}E._createPropertyInfos=function(e,t){var r=e.getDelegate().payload;var a=[];var i="/".concat(r.collectionName);var n=t.getMetaModel();return n.requestObject("".concat(i,"@")).then(function(t){var r=t["@Org.OData.Capabilities.V1.SortRestrictions"];var n=f.getSortRestrictionsInfo(r);var o=t["@Org.OData.Capabilities.V1.FilterRestrictions"];var l=f.getFilterRestrictionsInfo(o);var d=s.getCustomData(e,"columns");var u={};var c=x(e.getModel().getMetaModel().getContext(i)).targetEntityType;d.customData.forEach(function(t){var r={name:t.path,label:t.label,sortable:B(n,t),filterable:_(l,t),maxConditions:R(l,t),typeConfig:s.isTypeFilterable(t.$Type)?e.getTypeUtil().getTypeConfig(t.$Type):undefined};var i=c.entityProperties.find(function(e){return e.name===t.path});if(!i){i=j(c.navigationProperties,t)}if(i){var o=U(i);var f=p.getTypeConfig(o.type,o.formatOptions,o.constraints)||e.getTypeUtil().getTypeConfig(t.$Type);var d=w(i);var v=A(i,d,t);var g=Object.keys(v.properties);if(g.length>0){r.propertyInfos=g;r.sortable=false;r.filterable=false;g.forEach(function(e){u[e]=v.properties[e]});if(g.some(function(e){var t;return e!==((t=i)===null||t===void 0?void 0:t.name)})){u[i.name]=i}}else{r.path=t.path}r.typeConfig=r.typeConfig?f:undefined}else{r.path=t.path}a.push(r)});var v=S(u,a,n,l);return a.concat(v)})};E.updateBindingInfo=function(e,t){u.updateBindingInfo.apply(this,[e,t]);if(!e){return}var a=e.getDelegate().payload;if(a&&t){t.path=t.path||a.collectionPath||"/".concat(a.collectionName);t.model=t.model||a.model}if(!t){t={}}var i=d.byId(e.getFilter()),o=e.isFilteringEnabled();var l;var p,s;var f=[];var y=e.data("$tablePropertyInfo");if(o){l=e.getConditions();p=v.getFilterInfo(e,l,y,[]);if(p.filters){f.push(p.filters)}}if(i){l=i.getConditions();if(l){var m=c.getParameterNames(i);E._updatePropertyInfo(y,e,l,a);s=v.getFilterInfo(i,l,y,m);if(s.filters){f.push(s.filters)}var b=c.getParametersInfo(i,l);if(b){t.path=b}}t.parameters.$search=r.normalizeSearchTerm(i.getSearch())||undefined}this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=y.reduce(function(e,t){if(t.path&&t.path.indexOf("/")===-1){e=e?"".concat(e,",").concat(t.path):t.path}return e},"");t.parameters.$count=true;if(n.isDraftSupported(e.getModel().getMetaModel(),t.path)){f.push(new g("IsActiveEntity",h.EQ,true))}t.filters=new g(f,true)};E.getTypeUtil=function(){return p};E._getModel=function(e){var t=e.getDelegate().payload;return e.getModel(t.model)};E._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.sorter&&e.sorter.length==0){var r=t?t.defaultSortPropertyName:undefined;if(r){e.sorter.push(new y(r,false))}}};E._updatePropertyInfo=function(e,t,r,a){var i=Object.keys(r),n=t.getModel().getMetaModel();i.forEach(function(r){if(e.findIndex(function(e){return e.path===r})===-1){var i={path:r,typeConfig:t.getTypeUtil().getTypeConfig(n.getObject("/".concat(a.collectionName,"/").concat(r)).$Type)};e.push(i)}})};E.updateBinding=function(r,a,i){var n=false;var o=r.getBindingContext("internal");var l="pendingManualBindingUpdate";var p=o===null||o===void 0?void 0:o.getProperty(l);var s=r.getRowBinding();if(s){var f=s.getFilters("Application");n=t(a.filters,f[0])&&s.getQueryOptionsFromParameters().$search===a.parameters.$search&&!p}u.updateBinding.apply(E,[r,a,i]);if(!s){s=r.getRowBinding()}if(n&&r.getFilter()&&i){o===null||o===void 0?void 0:o.setProperty(l,true);s.requestRefresh(s.getGroupId()).finally(function(){o===null||o===void 0?void 0:o.setProperty(l,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}r.fireEvent("bindingUpdated")};function S(e,t,r,a){var i={},n=[];Object.keys(e).forEach(function(o){var l=e[o],f=t.find(function(e){return e.name===o});if(!f||f!==null&&f!==void 0&&f.propertyInfos){var d="Property::".concat(o);i[o]=d;if(!l.path||l.path.indexOf("/")>1){var u,c,v;var g=(u=l.annotations)===null||u===void 0?void 0:(c=u.UI)===null||c===void 0?void 0:(v=c.DataFieldDefault)===null||v===void 0?void 0:v.Value;l.path=l.path||g.path;l.label=m(l);if(s.isTypeFilterable(g===null||g===void 0?void 0:g.$target.type)){var h=U(l);l.typeConfig=p.getTypeConfig(h.type,h.formatOptions,h.constraints)}}if(l.path){n.push({name:d,label:l.label,path:l.path,sortable:B(r,l),filterable:_(a,l),typeConfig:(f===null||f===void 0?void 0:f.typeConfig)||l.typeConfig,maxConditions:R(a,l)})}}});t.forEach(function(e){if(e.propertyInfos){var t;e.propertyInfos=(t=e.propertyInfos)===null||t===void 0?void 0:t.map(function(e){var t;return(t=i[e])!==null&&t!==void 0?t:e})}});return n}function B(e,t){return t.path&&e[t.path]?e[t.path].sortable:t.sortable}function _(e,t){return t.path&&e[t.path]?e[t.path].filterable:t.filterable}function R(e,t){return t.path&&f.isMultiValueFilterExpression(e.propertyInfo[t.path])?-1:1}function j(e,t){var r;return e.length>0?(r=e.map(function(e){return e.targetType.entityProperties.find(function(e){return t.path&&t.path.indexOf(e.name)>-1})}))===null||r===void 0?void 0:r[0]:undefined}function w(e){var t=M(e)||D(e)||b(e)||C(e);var r=T(e)||O(e)||P(e)||I(e);if(r&&t&&(t===null||t===void 0?void 0:t.indexOf("/"))>-1){r.name=t;r.path=t}return r}return E},false);
//# sourceMappingURL=TableDelegate.js.map