/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/CommonUtils", "sap/fe/core/controllerextensions/collaboration/ActivitySync", "sap/fe/core/controllerextensions/collaboration/CollaborationCommon"], function (CommonUtils, CollaborationActivitySync, CollaborationCommon) {
  "use strict";

  var Activity = CollaborationCommon.Activity;

  function getRelatedFieldFromValueHelp(oValueHelp) {
    var oView = CommonUtils.getTargetView(oValueHelp);
    return oView.findElements(true, function (oElem) {
      return oElem.getFieldHelp && oElem.getDomRef() && oElem.getFieldHelp() === oValueHelp.getId();
    })[0];
  }

  function onValueHelpOpenDialog(oEvent) {
    var oValueHelp = oEvent.getSource();
    var oField = collaborationHelper.getRelatedFieldFromValueHelp(oValueHelp);
    var bCollaborationEnabled = CollaborationActivitySync.isConnected(oField);

    if (bCollaborationEnabled && oField.getBinding("value")) {
      var sFullPath = oField.getBinding("value").isA("sap.ui.model.CompositeBinding") ? // for the compositeBinding, we just send a message containing the path of the first element
      // it is enough to lock the entire field
      "".concat(oField.getBindingContext().getPath(), "/").concat(oField.getBinding("value").getBindings()[0].getPath()) : "".concat(oField.getBindingContext().getPath(), "/").concat(oField.getBinding("value").getPath());
      CollaborationActivitySync.send(oField, Activity.LiveChange, sFullPath);
    }
  }

  function onValueHelpCloseDialog(oEvent) {
    var oValueHelp = oEvent.getSource();
    var oField = collaborationHelper.getRelatedFieldFromValueHelp(oValueHelp);
    var bCollaborationEnabled = CollaborationActivitySync.isConnected(oField);
    var isCompositeBinding = oField.getBinding("value").isA("sap.ui.model.CompositeBinding");
    var oValueBeforeUpdate = isCompositeBinding ? oField.getValue()[1] : oField.getValue();
    return new Promise(function (resolve) {
      setTimeout(function () {
        var _oField$getBinding;

        var value = isCompositeBinding ? oValueHelp.getConditions()[0].values[0] : (_oField$getBinding = oField.getBinding("value")) === null || _oField$getBinding === void 0 ? void 0 : _oField$getBinding.getValue();

        if (bCollaborationEnabled && oValueBeforeUpdate === value) {
          var sFullPath = isCompositeBinding ? "".concat(oField.getBindingContext().getPath(), "/").concat(oField.getBinding("value").getBindings()[0].getPath()) : "".concat(oField.getBindingContext().getPath(), "/").concat(oField.getBinding("value").getPath());
          CollaborationActivitySync.send(oField, Activity.Undo, sFullPath);
        }

        resolve();
      }, 0);
    });
  }

  var collaborationHelper = {
    getRelatedFieldFromValueHelp: getRelatedFieldFromValueHelp,
    onValueHelpOpenDialog: onValueHelpOpenDialog,
    onValueHelpCloseDialog: onValueHelpCloseDialog
  };
  return collaborationHelper;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRSZWxhdGVkRmllbGRGcm9tVmFsdWVIZWxwIiwib1ZhbHVlSGVscCIsIm9WaWV3IiwiQ29tbW9uVXRpbHMiLCJnZXRUYXJnZXRWaWV3IiwiZmluZEVsZW1lbnRzIiwib0VsZW0iLCJnZXRGaWVsZEhlbHAiLCJnZXREb21SZWYiLCJnZXRJZCIsIm9uVmFsdWVIZWxwT3BlbkRpYWxvZyIsIm9FdmVudCIsImdldFNvdXJjZSIsIm9GaWVsZCIsImNvbGxhYm9yYXRpb25IZWxwZXIiLCJiQ29sbGFib3JhdGlvbkVuYWJsZWQiLCJDb2xsYWJvcmF0aW9uQWN0aXZpdHlTeW5jIiwiaXNDb25uZWN0ZWQiLCJnZXRCaW5kaW5nIiwic0Z1bGxQYXRoIiwiaXNBIiwiZ2V0QmluZGluZ0NvbnRleHQiLCJnZXRQYXRoIiwiZ2V0QmluZGluZ3MiLCJzZW5kIiwiQWN0aXZpdHkiLCJMaXZlQ2hhbmdlIiwib25WYWx1ZUhlbHBDbG9zZURpYWxvZyIsImlzQ29tcG9zaXRlQmluZGluZyIsIm9WYWx1ZUJlZm9yZVVwZGF0ZSIsImdldFZhbHVlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwidmFsdWUiLCJnZXRDb25kaXRpb25zIiwidmFsdWVzIiwiVW5kbyJdLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsiY29sbGFib3JhdGlvbkhlbHBlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ29tbW9uVXRpbHMgZnJvbSBcInNhcC9mZS9jb3JlL0NvbW1vblV0aWxzXCI7XG5pbXBvcnQgQ29sbGFib3JhdGlvbkFjdGl2aXR5U3luYyBmcm9tIFwic2FwL2ZlL2NvcmUvY29udHJvbGxlcmV4dGVuc2lvbnMvY29sbGFib3JhdGlvbi9BY3Rpdml0eVN5bmNcIjtcbmltcG9ydCB7IEFjdGl2aXR5IH0gZnJvbSBcInNhcC9mZS9jb3JlL2NvbnRyb2xsZXJleHRlbnNpb25zL2NvbGxhYm9yYXRpb24vQ29sbGFib3JhdGlvbkNvbW1vblwiO1xuXG5mdW5jdGlvbiBnZXRSZWxhdGVkRmllbGRGcm9tVmFsdWVIZWxwKG9WYWx1ZUhlbHA6IGFueSkge1xuXHRjb25zdCBvVmlldyA9IENvbW1vblV0aWxzLmdldFRhcmdldFZpZXcob1ZhbHVlSGVscCk7XG5cdHJldHVybiBvVmlldy5maW5kRWxlbWVudHModHJ1ZSwgZnVuY3Rpb24gKG9FbGVtOiBhbnkpIHtcblx0XHRyZXR1cm4gb0VsZW0uZ2V0RmllbGRIZWxwICYmIG9FbGVtLmdldERvbVJlZigpICYmIG9FbGVtLmdldEZpZWxkSGVscCgpID09PSBvVmFsdWVIZWxwLmdldElkKCk7XG5cdH0pWzBdO1xufVxuXG5mdW5jdGlvbiBvblZhbHVlSGVscE9wZW5EaWFsb2cob0V2ZW50OiBhbnkpIHtcblx0Y29uc3Qgb1ZhbHVlSGVscCA9IG9FdmVudC5nZXRTb3VyY2UoKTtcblx0Y29uc3Qgb0ZpZWxkID0gY29sbGFib3JhdGlvbkhlbHBlci5nZXRSZWxhdGVkRmllbGRGcm9tVmFsdWVIZWxwKG9WYWx1ZUhlbHApO1xuXHRjb25zdCBiQ29sbGFib3JhdGlvbkVuYWJsZWQgPSBDb2xsYWJvcmF0aW9uQWN0aXZpdHlTeW5jLmlzQ29ubmVjdGVkKG9GaWVsZCk7XG5cdGlmIChiQ29sbGFib3JhdGlvbkVuYWJsZWQgJiYgb0ZpZWxkLmdldEJpbmRpbmcoXCJ2YWx1ZVwiKSkge1xuXHRcdGNvbnN0IHNGdWxsUGF0aCA9IG9GaWVsZC5nZXRCaW5kaW5nKFwidmFsdWVcIikuaXNBKFwic2FwLnVpLm1vZGVsLkNvbXBvc2l0ZUJpbmRpbmdcIilcblx0XHRcdD8gLy8gZm9yIHRoZSBjb21wb3NpdGVCaW5kaW5nLCB3ZSBqdXN0IHNlbmQgYSBtZXNzYWdlIGNvbnRhaW5pbmcgdGhlIHBhdGggb2YgdGhlIGZpcnN0IGVsZW1lbnRcblx0XHRcdCAgLy8gaXQgaXMgZW5vdWdoIHRvIGxvY2sgdGhlIGVudGlyZSBmaWVsZFxuXHRcdFx0ICBgJHtvRmllbGQuZ2V0QmluZGluZ0NvbnRleHQoKS5nZXRQYXRoKCl9LyR7b0ZpZWxkLmdldEJpbmRpbmcoXCJ2YWx1ZVwiKS5nZXRCaW5kaW5ncygpWzBdLmdldFBhdGgoKX1gXG5cdFx0XHQ6IGAke29GaWVsZC5nZXRCaW5kaW5nQ29udGV4dCgpLmdldFBhdGgoKX0vJHtvRmllbGQuZ2V0QmluZGluZyhcInZhbHVlXCIpLmdldFBhdGgoKX1gO1xuXHRcdENvbGxhYm9yYXRpb25BY3Rpdml0eVN5bmMuc2VuZChvRmllbGQsIEFjdGl2aXR5LkxpdmVDaGFuZ2UsIHNGdWxsUGF0aCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gb25WYWx1ZUhlbHBDbG9zZURpYWxvZyhvRXZlbnQ6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuXHRjb25zdCBvVmFsdWVIZWxwID0gb0V2ZW50LmdldFNvdXJjZSgpO1xuXHRjb25zdCBvRmllbGQgPSBjb2xsYWJvcmF0aW9uSGVscGVyLmdldFJlbGF0ZWRGaWVsZEZyb21WYWx1ZUhlbHAob1ZhbHVlSGVscCk7XG5cdGNvbnN0IGJDb2xsYWJvcmF0aW9uRW5hYmxlZCA9IENvbGxhYm9yYXRpb25BY3Rpdml0eVN5bmMuaXNDb25uZWN0ZWQob0ZpZWxkKTtcblx0Y29uc3QgaXNDb21wb3NpdGVCaW5kaW5nID0gb0ZpZWxkLmdldEJpbmRpbmcoXCJ2YWx1ZVwiKS5pc0EoXCJzYXAudWkubW9kZWwuQ29tcG9zaXRlQmluZGluZ1wiKTtcblx0Y29uc3Qgb1ZhbHVlQmVmb3JlVXBkYXRlID0gaXNDb21wb3NpdGVCaW5kaW5nID8gb0ZpZWxkLmdldFZhbHVlKClbMV0gOiBvRmllbGQuZ2V0VmFsdWUoKTtcblxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcblx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcblx0XHRcdGNvbnN0IHZhbHVlID0gaXNDb21wb3NpdGVCaW5kaW5nID8gb1ZhbHVlSGVscC5nZXRDb25kaXRpb25zKClbMF0udmFsdWVzWzBdIDogb0ZpZWxkLmdldEJpbmRpbmcoXCJ2YWx1ZVwiKT8uZ2V0VmFsdWUoKTtcblx0XHRcdGlmIChiQ29sbGFib3JhdGlvbkVuYWJsZWQgJiYgb1ZhbHVlQmVmb3JlVXBkYXRlID09PSB2YWx1ZSkge1xuXHRcdFx0XHRjb25zdCBzRnVsbFBhdGggPSBpc0NvbXBvc2l0ZUJpbmRpbmdcblx0XHRcdFx0XHQ/IGAke29GaWVsZC5nZXRCaW5kaW5nQ29udGV4dCgpLmdldFBhdGgoKX0vJHtvRmllbGQuZ2V0QmluZGluZyhcInZhbHVlXCIpLmdldEJpbmRpbmdzKClbMF0uZ2V0UGF0aCgpfWBcblx0XHRcdFx0XHQ6IGAke29GaWVsZC5nZXRCaW5kaW5nQ29udGV4dCgpLmdldFBhdGgoKX0vJHtvRmllbGQuZ2V0QmluZGluZyhcInZhbHVlXCIpLmdldFBhdGgoKX1gO1xuXG5cdFx0XHRcdENvbGxhYm9yYXRpb25BY3Rpdml0eVN5bmMuc2VuZChvRmllbGQsIEFjdGl2aXR5LlVuZG8sIHNGdWxsUGF0aCk7XG5cdFx0XHR9XG5cdFx0XHRyZXNvbHZlKCk7XG5cdFx0fSwgMCk7XG5cdH0pO1xufVxuXG5jb25zdCBjb2xsYWJvcmF0aW9uSGVscGVyID0ge1xuXHRnZXRSZWxhdGVkRmllbGRGcm9tVmFsdWVIZWxwLFxuXHRvblZhbHVlSGVscE9wZW5EaWFsb2csXG5cdG9uVmFsdWVIZWxwQ2xvc2VEaWFsb2dcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNvbGxhYm9yYXRpb25IZWxwZXI7XG4iXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBO0FBQUE7Ozs7OztFQUlBLFNBQVNBLDRCQUFULENBQXNDQyxVQUF0QyxFQUF1RDtJQUN0RCxJQUFNQyxLQUFLLEdBQUdDLFdBQVcsQ0FBQ0MsYUFBWixDQUEwQkgsVUFBMUIsQ0FBZDtJQUNBLE9BQU9DLEtBQUssQ0FBQ0csWUFBTixDQUFtQixJQUFuQixFQUF5QixVQUFVQyxLQUFWLEVBQXNCO01BQ3JELE9BQU9BLEtBQUssQ0FBQ0MsWUFBTixJQUFzQkQsS0FBSyxDQUFDRSxTQUFOLEVBQXRCLElBQTJDRixLQUFLLENBQUNDLFlBQU4sT0FBeUJOLFVBQVUsQ0FBQ1EsS0FBWCxFQUEzRTtJQUNBLENB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