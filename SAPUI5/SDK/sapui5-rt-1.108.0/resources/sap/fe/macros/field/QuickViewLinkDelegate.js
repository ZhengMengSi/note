/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/isPlainObject","sap/fe/core/CommonUtils","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ToES6Promise","sap/fe/macros/field/FieldHelper","sap/fe/macros/field/FieldRuntime","sap/fe/navigation/SelectionVariant","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/mdc/link/Factory","sap/ui/mdc/link/LinkItem","sap/ui/mdc/link/SemanticObjectMapping","sap/ui/mdc/link/SemanticObjectMappingItem","sap/ui/mdc/link/SemanticObjectUnavailableAction","sap/ui/mdc/LinkDelegate","sap/ui/model/json/JSONModel"],function(e,t,n,i,a,r,o,c,s,l,u,m,d,f,v,g,p,h,b,O){"use strict";function j(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}var S=Object.assign({},b);var y={iLinksShownInPopup:3,sapmLink:"sap.m.Link",sapuimdcLink:"sap.ui.mdc.Link",sapmObjectIdentifier:"sap.m.ObjectIdentifier",sapmObjectStatus:"sap.m.ObjectStatus"};S.getConstants=function(){return y};S._getEntityType=function(e,t){if(t){return t.createBindingContext(e.entityType)}else{return undefined}};S._getSemanticsModel=function(e,t){if(t){return new O(e)}else{return undefined}};S._getDataField=function(e,t){return t.createBindingContext(e.dataField)};S._getContact=function(e,t){return t.createBindingContext(e.contact)};S.fnTemplateFragment=function(){var e=this;var t,n;var i={};var a;if(this.resolvedpayload){a=this.resolvedpayload}else{a=this.payload}if(a&&!a.LinkId){a.LinkId=this.oControl&&this.oControl.isA(y.sapuimdcLink)?this.oControl.getId():undefined}if(a.LinkId){n=this.oControl.getModel("$sapuimdcLink").getProperty("/titleLinkHref");a.titlelink=n}var r=this._getSemanticsModel(a,this.oMetaModel);if(a.entityType&&this._getEntityType(a,this.oMetaModel)){t="sap.fe.macros.field.QuickViewLinkForEntity";i.bindingContexts={entityType:this._getEntityType(a,this.oMetaModel),semantic:r.createBindingContext("/")};i.models={entityType:this.oMetaModel,semantic:r}}else if(a.dataField&&this._getDataField(a,this.oMetaModel)){t="sap.fe.macros.field.QuickViewLinkForDataField";i.bindingContexts={dataField:this._getDataField(a,this.oMetaModel),semantic:r.createBindingContext("/")};i.models={dataField:this.oMetaModel,semantic:r}}else if(a.contact&&this._getContact(a,this.oMetaModel)){t="sap.fe.macros.field.QuickViewLinkForContact";i.bindingContexts={contact:this._getContact(a,this.oMetaModel)};i.models={contact:this.oMetaModel}}i.models.entitySet=this.oMetaModel;i.models.metaModel=this.oMetaModel;if(this.oControl&&this.oControl.getModel("viewData")){i.models.viewData=this.oControl.getModel("viewData");i.bindingContexts.viewData=this.oControl.getModel("viewData").createBindingContext("/")}var o=d.loadTemplate(t,"fragment");return Promise.resolve(m.process(o,{name:t},i)).then(function(t){return u.load({definition:t,controller:e})}).then(function(t){if(t){if(i.models&&i.models.semantic){t.setModel(i.models.semantic,"semantic");t.setBindingContext(i.bindingContexts.semantic,"semantic")}if(i.bindingContexts&&i.bindingContexts.entityType){t.setModel(i.models.entityType,"entityType");t.setBindingContext(i.bindingContexts.entityType,"entityType")}}e.resolvedpayload=undefined;return t})};S.fetchAdditionalContent=function(e,t){var n;this.oControl=t;var i=e===null||e===void 0?void 0:(n=e.navigationPath)===null||n===void 0?void 0:n.match(/{(.*?)}/);var a=i&&i.length>1&&i[1]?t.getModel().bindContext(i[1],t.getBindingContext(),{$$ownRequest:true}):null;this.payload=e;if(t&&t.isA(y.sapuimdcLink)){this.oMetaModel=t.getModel().getMetaModel();return this.fnTemplateFragment().then(function(e){if(a){e.setBindingContext(a.getBoundContext())}return[e]})}return Promise.resolve([])};S._fetchLinkCustomData=function(e){if(e.getParent()&&e.isA(y.sapuimdcLink)&&(e.getParent().isA(y.sapmLink)||e.getParent().isA(y.sapmObjectIdentifier)||e.getParent().isA(y.sapmObjectStatus))){return e.getCustomData()}else{return undefined}};S.fetchLinkItems=function(e,t,n){if(t&&S._getSemanticObjects(e)){var i=t.getObject();if(n){n.initialize(S._getSemanticObjects(e))}var a=this._link&&this._fetchLinkCustomData(this._link);this.aLinkCustomData=a&&this._fetchLinkCustomData(this._link).map(function(e){return e.mProperties.value});var r=S._calculateSemanticAttributes(i,e,n,this._link);var o=r.results;var c=r.payload;return S._retrieveNavigationTargets("",o,c,n,this._link).then(function(e){return e.length===0?null:e})}else{return Promise.resolve(null)}};S.fetchLinkType=function(t,n){var i=this;var a=n;var r=Object.assign({},t);var o={initialType:{type:2,directLink:undefined},runtimeType:undefined};return new Promise(function(e,t){var c;if(r!==null&&r!==void 0&&r.semanticObjects){i._link=n;return Promise.resolve(a.retrieveLinkItems()).then(function(t){var n;var i;if((t===null||t===void 0?void 0:t.length)===1){n=new v({text:t[0].getText(),href:t[0].getHref()});i=r.hasQuickViewFacets==="false"?1:2}else if(r.hasQuickViewFacets==="false"&&(t===null||t===void 0?void 0:t.length)===0){i=0}else{i=2}e({initialType:{type:i,directLink:n?n:undefined},runtimeType:undefined})})}else if((r===null||r===void 0?void 0:(c=r.contact)===null||c===void 0?void 0:c.length)>0){e(o)}else if(r!==null&&r!==void 0&&r.entityType&&r!==null&&r!==void 0&&r.navigationPath){e(o)}t(new Error("no payload or semanticObjects found"))}).catch(function(t){e.error("Error in SimpleLinkDelegate.fetchLinkType",t)})};S._RemoveTitleLinkFromTargets=function(e,t,n){var i,a;var r=false;if(t&&n&&n[0]){var o,c;var s=n[0].intent.split("?")[0];if(e&&e[0]){c="#".concat(e[0].getProperty("key"));o=s===c;if(o){i=e[0].getProperty("href");this.payload.titlelinkhref=i;if(e[0].isA("sap.ui.mdc.link.LinkItem")){a=e[0].getParent();a.getModel("$sapuimdcLink").setProperty("/titleLinkHref",i);r=true}}}}return{links:e,titlelinkremoved:r}};S._IsSemanticObjectDynamic=function(e,t){if(e&&t.aLinkCustomData){return t.aLinkCustomData.filter(function(t){return e.filter(function(e){return e!==t}).length>0}).length>0}else{return false}};S._getLineContext=function(e,t){if(!t){if(e.getAggregation("content")[0]&&e.getAggregation("content")[0].getBindingContext()){return e.getAggregation("content")[0].getBindingContext()}}return t};S._setFilterContextUrlForSelectionVariant=function(e,t,n){if(e.getViewData().entitySet&&t){var i=n.constructContextUrl(e.getViewData().entitySet,e.getModel());t.setFilterContextUrl(i)}return t};S._setObjectMappings=function(e,t,n,i){var a=false;n.forEach(function(n){var r=n.semanticObject;var o=r.match(/{(.*?)}/);if(o!==null&&o!==void 0&&o.length&&o.length>1&&o[1]&&t[o[1]]){r=t[o[1]]}if(e===r){var c=n.items;for(var s=0;s<c.length;s++){var l=c[s].key;var u=c[s].value;if(t[l]){i.removeParameter(u);i.removeSelectOption(u);i.renameParameter(l,u);i.renameSelectOption(l,u);t[u]=t[l];a=true}}}});return{params:t,hasChanged:a}};S._getLinkItemWithNewParameter=function(e,t,n,i,a,o,c,s,l,u){var m={titlelinkremoved:false};var d=a.expandCompactHash(i.getHref()).then(function(d){try{function O(){var r={target:{semanticObject:f.semanticObject,action:f.action},params:p,appStateKey:s};delete r.params["sap-xapp-state"];i.setHref("#".concat(a.constructShellHash(r)));o.aSemanticLinks.push(i.getHref());m=S._RemoveTitleLinkFromTargets.bind(e)([i],t,n);if(m.titlelinkremoved){return i}else{return i}}var f=a.parseShellHash(d);var v=Object.assign({},c);var g=S._setObjectMappings(f.semanticObject,v,o.semanticObjectMappings,l),p=g.params,h=g.hasChanged;var b=function(){if(h){return Promise.resolve(r(u.getAppStateKeyAndUrlParameters(l.toJSONString()))).then(function(e){s=e[1]})}}();return Promise.resolve(b&&b.then?b.then(O):O(b))}catch(j){return Promise.reject(j)}});return{linkitempromise:d,titlelinkremoved:m.titlelinkremoved}};S.modifyLinkItems=function(t,n,a){try{var c=this;return Promise.resolve(o.checkPrimaryActions(t,true)).then(function(o){var l=o;var u=l.titleLink;var m=l.hasTitleLink;if(a.length!==0){c.payload=t;var d=a[0].getParent();var f=i.getTargetView(d);var v=i.getAppComponent(f);var g=v.getShellServices();if(!g.hasUShell()){e.error("QuickViewLinkDelegate: Cannot retrieve the shell services");return Promise.reject()}var p=f.getModel().getMetaModel();var h=d.getBindingContext();var b={semanticObject:t.mainSemanticObject,action:""};return j(function(){function e(){var e=v.getNavigationService();var n=f.getController();var i;var o;h=S._getLineContext(f,h);var l=p.getMetaPath(h.getPath());o=n._intentBasedNavigation.removeSensitiveData(h.getObject(),l);o=n._intentBasedNavigation.prepareContextForExternalNavigation(o,h);i=e.mixAttributesAndSelectionVariant(o.semanticAttributes,new s);b.propertiesWithoutConflict=o.propertiesWithoutConflict;f.getController().intentBasedNavigation.adaptNavigationContext(i,b);S._removeTechnicalParameters(i);i=S._setFilterContextUrlForSelectionVariant(f,i,e);return Promise.resolve(r(e.getAppStateKeyAndUrlParameters(i.toJSONString()))).then(function(n){var r=n[0];var o=n[1];var s=[];var l;t.aSemanticLinks=[];for(var d in a){l=S._getLinkItemWithNewParameter(c,m,u,a[d],g,t,r,o,i,e);if(!l.titlelinkremoved){s.push(l.linkitempromise)}}return Promise.resolve(Promise.all(s))})}var i=d&&c._fetchLinkCustomData(d).map(function(e){return e.mProperties.value});var o=function(){if(S._IsSemanticObjectDynamic(i,c)){var e=S._calculateSemanticAttributes(n.getObject(),t,undefined,c._link);var r=e.results;var o=e.payload;return Promise.resolve(S._retrieveNavigationTargets("",r,o,undefined,c._link)).then(function(e){a=e})}}();return o&&o.then?o.then(e):e(o)},function(t){e.error("Error while getting the navigation service",t);return undefined})}else{return a}})}catch(e){return Promise.reject(e)}};S.beforeNavigationCallback=function(e,t){var n=t.getSource(),i=t.getParameter("href"),r=f.getService("URLParsing"),o=i&&r.parseShellHash(i);a.storeControlRefreshStrategyForHash(n,o);return Promise.resolve(true)};S._removeTechnicalParameters=function(e){e.removeSelectOption("@odata.context");e.removeSelectOption("@odata.metadataEtag");e.removeSelectOption("SAP__Messages")};S._getSemanticObjectCustomDataValue=function(e,t){var n,i;for(var a=0;a<e.length;a++){n=e[a].getKey();i=e[a].getValue();t[n]={value:i}}};S._createNewPayloadWithDynamicSemanticObjectsResolved=function(e,t,n){var i,a;for(var r=0;r<e.semanticObjects.length;r++){i=e.semanticObjects[r];if(i&&i.indexOf("{")===0&&i.indexOf("}")===i.length-1){a=i.substr(1,i.indexOf("}")-1);i=t[a].value;if(e.mainSemanticObject&&e.mainSemanticObject.split(a).length===2&&e.mainSemanticObject.split(a)[0]==="{"&&e.mainSemanticObject.split(a)[1]==="}"){if(i){n.mainSemanticObject=i}else{n.mainSemanticObject=undefined}}if(i&&typeof i==="string"){n.semanticObjectsResolved.push(i?i:undefined);n.semanticObjects.push(i?i:undefined)}else if(Array.isArray(i)){for(var o=0;o<i.length;o++){n.semanticObjectsResolved.push(i[o]?i[o]:undefined);n.semanticObjects.push(i[o]?i[o]:undefined)}}}else{n.semanticObjects.push(i)}}};S._setPayloadWithDynamicSemanticObjectsResolved=function(e,n){var i;if(n.semanticObjectsResolved.length>0){i={};i.entityType=e.entityType;i.dataField=e.dataField;i.contact=e.contact;i.mainSemanticObject=e.mainSemanticObject;i.navigationPath=e.navigationPath;i.propertyPathLabel=e.propertyPathLabel;i.semanticObjectMappings=t(e.semanticObjectMappings);i.semanticObjects=n.semanticObjects;var a=t(e.semanticObjectUnavailableActions);var r;a.forEach(function(t){if(t!==null&&t!==void 0&&t.semanticObject&&t.semanticObject.indexOf("{")===0){r=e.semanticObjects.findIndex(function(e){return e===t.semanticObject});if(r!==undefined){t.semanticObject=i.semanticObjects[r]}}});i.semanticObjectUnavailableActions=a;if(n.mainSemanticObject){i.mainSemanticObject=n.mainSemanticObject}else{i.mainSemanticObject=undefined}for(var o=0;o<n.semanticObjects.length;o++){if(i.mainSemanticObject===n.semanticObjectsResolved[o]){i.mainSemanticObject=n.semanticObjects[o]}if(!!i.semanticObjectMappings&&i.semanticObjectMappings.length>0){if(i.semanticObjectMappings[o]){i.semanticObjectMappings[o]={semanticObject:n.semanticObjects[o],items:i.semanticObjectMappings[o].items}}}if(i.semanticObjects[o]){i.semanticObjects[o]=n.semanticObjects[o]}else{i.semanticObjects.splice(o,1)}}for(var c=0;c<i.semanticObjectMappings.length;c++){if(i.semanticObjectMappings[c]&&i.semanticObjectMappings[c].semanticObject===undefined){i.semanticObjectMappings.splice(c,1)}}}return i};S._getPayloadWithDynamicSemanticObjectsResolved=function(e,t){var n;var i={};var a={semanticObjects:[],semanticObjectsResolved:[]};if(e.semanticObjects){if(t&&t.length>0){S._getSemanticObjectCustomDataValue(t,i);S._createNewPayloadWithDynamicSemanticObjectsResolved(e,i,a);n=S._setPayloadWithDynamicSemanticObjectsResolved(e,a);return n}}else{return undefined}};S._updatePayloadWithSemanticAttributes=function(t,i,a,r,o){t.forEach(function(t){if(i){i.addContextObject(t,a)}r[t]={};for(var c in a){var s=null,l=null;if(i){s=i.getSemanticObjectAttribute(t,c);if(!s){s=i.createAttributeStructure();i.addSemanticObjectAttribute(t,c,s)}}if(a[c]===undefined||a[c]===null){if(s){s.transformations.push({value:undefined,description:"â„¹ Undefined and null values have been removed in SimpleLinkDelegate."})}continue}if(n(a[c])){if(o&&o[t]){var u=Object.keys(o[t]);var m=void 0,d=void 0,f=void 0,v=void 0;for(var g=0;g<u.length;g++){v=u[g];if(v.indexOf(c)===0){m=o[t][v];d=v.split("/")[v.split("/").length-1];f=a[c][d];if(m&&d&&f){r[t][m]=f}}}}if(s){s.transformations.push({value:undefined,description:"â„¹ Plain objects has been removed in SimpleLinkDelegate."})}continue}var p=o&&o[t]&&o[t][c]?o[t][c]:c;if(s&&c!==p){l={value:undefined,description:"â„¹ The attribute ".concat(c," has been renamed to ").concat(p," in SimpleLinkDelegate."),reason:"ðŸ”´ A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object ".concat(t," with source attribute ").concat(c," and target attribute ").concat(p,". You can modify the annotation if the mapping result is not what you expected.")}}if(r[t][p]){e.error("SimpleLinkDelegate: The attribute ".concat(c," can not be renamed to the attribute ").concat(p," due to a clash situation. This can lead to wrong navigation later on."))}r[t][p]=a[c];if(s){if(l){s.transformations.push(l);var h=i.createAttributeStructure();h.transformations.push({value:a[c],description:"â„¹ The attribute ".concat(p," with the value ").concat(a[c]," has been added due to a mapping rule regarding the attribute ").concat(c," in SimpleLinkDelegate.")});i.addSemanticObjectAttribute(t,p,h)}}}})};S._calculateSemanticAttributes=function(e,t,n,i){var a=i&&this._fetchLinkCustomData(i);var r=S._getPayloadWithDynamicSemanticObjectsResolved(t,a);var o=r?r:t;this.resolvedpayload=r;var c=S._getSemanticObjects(o);var s=S._convertSemanticObjectMapping(S._getSemanticObjectMappings(o));if(!c.length){c.push("")}var l={};S._updatePayloadWithSemanticAttributes(c,n,e,l,s);return{payload:o,results:l}};S._retrieveNavigationTargets=function(t,n,a,r,o){var s=this;if(!a.semanticObjects){return Promise.resolve([])}var u=a.semanticObjects;var m={ownNavigation:undefined,availableActions:[]};var d=0;return l.loadLibrary("sap.ui.fl",{async:true}).then(function(){return new Promise(function(l){sap.ui.require(["sap/ui/fl/Utils"],function(f){try{var g=f.getAppComponentForControl(o===undefined?s.oControl:o);var p=g?g.getShellServices():null;if(!p){l(m.availableActions,m.ownNavigation)}if(!p.hasUShell()){e.error("SimpleLinkDelegate: Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");l(m.availableActions,m.ownNavigation)}var h=u.map(function(e){return[{semanticObject:e,params:n?n[e]:undefined,appStateKey:t,sortResultsBy:"text"}]});var b=j(function(){return Promise.resolve(p.getLinks(h)).then(function(e){var t=false;for(var n=0;n<e.length;n++){for(var o=0;o<e[n].length;o++){if(e[n][o].length>0){t=true;break}if(t){break}}}if(!e||!e.length||!t){l(m.availableActions,m.ownNavigation)}var f=S._getSemanticObjectUnavailableActions(a);var g=S._convertSemanticObjectUnavailableAction(f);var h=c._fnFixHashQueryString(i.getHash());if(h){h+="?"}var b=function(e,t){return!!g&&!!g[e]&&g[e].indexOf(t)>-1};var O=function(e){var t=p.parseShellHash(e.intent);if(b(t.semanticObject,t.action)){return}var n="#".concat(p.constructShellHash({target:{shellHash:e.intent}}));if(e.intent&&e.intent.indexOf(h)===0){m.ownNavigation=new v({href:n,text:e.text});return}var i=new v({key:t.semanticObject&&t.action?"".concat(t.semanticObject,"-").concat(t.action):undefined,text:e.text,description:undefined,href:n,icon:undefined,initiallyVisible:e.tags&&e.tags.indexOf("superiorAction")>-1});if(i.getProperty("initiallyVisible")){d++}m.availableActions.push(i);if(r){r.addSemanticObjectIntent(t.semanticObject,{intent:i.getHref(),text:i.getText()})}};for(var j=0;j<u.length;j++){e[j][0].forEach(O)}if(d===0){for(var y=0;y<m.availableActions.length;y++){if(y<s.getConstants().iLinksShownInPopup){m.availableActions[y].setProperty("initiallyVisible",true)}else{break}}}l(m.availableActions,m.ownNavigation)})},function(){e.error("SimpleLinkDelegate: '_retrieveNavigationTargets' failed executing getLinks method");l(m.availableActions,m.ownNavigation)});return Promise.resolve(b&&b.then?b.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})})})};S._getSemanticObjects=function(e){return e.semanticObjects?e.semanticObjects:[]};S._getSemanticObjectUnavailableActions=function(e){var t=[];if(e.semanticObjectUnavailableActions){e.semanticObjectUnavailableActions.forEach(function(e){t.push(new h({semanticObject:e.semanticObject,actions:e.actions}))})}return t};S._getSemanticObjectMappings=function(e){var t=[];var n=[];if(e.semanticObjectMappings){e.semanticObjectMappings.forEach(function(e){n=[];if(e.items){e.items.forEach(function(e){n.push(new p({key:e.key,value:e.value}))})}t.push(new g({semanticObject:e.semanticObject,items:n}))})}return t};S._convertSemanticObjectMapping=function(e){if(!e.length){return undefined}var t={};e.forEach(function(e){if(!e.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '".concat(e.getSemanticObject(),"' is not valid"))}t[e.getSemanticObject()]=e.getItems().reduce(function(e,t){e[t.getKey()]=t.getValue();return e},{})});return t};S._convertSemanticObjectUnavailableAction=function(e){var t;var n;var i=[];if(!e.length){return undefined}var a={};e.forEach(function(e){t=e.getSemanticObject();if(!t){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '".concat(t,"' is not valid"))}i=e.getActions();if(a[t]===undefined){a[t]=i}else{n=a[t];i.forEach(function(e){n.push(e)});a[t]=n}});return a};return S},false);
//# sourceMappingURL=QuickViewLinkDelegate.js.map