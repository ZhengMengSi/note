// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/appRuntime/ui5/performance/FesrEnhancer","sap/ushell/EventHub","sap/base/Log","sap/ui/thirdparty/hasher"],function(e,t,s,i,jQuery,r,n,a,p,u,o){"use strict";function l(){var l=this,d,c,f=true,h={},g,v={},m={},y={},C,S;this.init=function(i,r,n,u,c,h){d=i;g=r;S=n;if(u!==undefined){f=u}this.addAppInfoToCache(c,h);e.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){a.startInteraction();t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:true});var i=JSON.parse(e.oMessage.data),r=s.fromURL(i.body.sUrl).get("sap-ui-app-id");o.disableCFLPUpdate=true;o.replaceHash(i.body.sHash);o.disableCFLPUpdate=false;l.create(r,i.body.sUrl);return(new jQuery.Deferred).resolve().promise()}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);l.destroy(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);l.store(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);o.disableCFLPUpdate=true;o.replaceHash(t.body.sHash);o.disableCFLPUpdate=false;l.restore(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}}}}});p.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&m[e.componentId]){m[e.componentId]=e.disable}});this.initialSetup()};this.initialSetup=function(){t.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,isIframeValid:true,isIframeBusy:true})};this.create=function(e,s){if(r.browser.chrome){n.show(0)}sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});var a=new Promise(function(t){l.getAppInfo(e,s).then(function(e){t(e)})}).then(function(r){l.getURLParameters(new i(s).query(true)).then(function(s){g(e,s,r).then(function(e){S(e);t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:false});sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{})})})});return a};this.destroy=function(e){function t(e){var t=e.sId||"<unkown>";try{e.destroy()}catch(e){u.error("exception when trying to close sapui5 application with id '"+t+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}if(e&&v[e]){if(v[e]===C){C=undefined}delete m[v[e].sId];t(v[e]);delete v[e]}else if(C){delete m[C.sId];t(C);C=undefined}sap.ushell.Container.cleanDirtyStateProviderArray();a.setAppShortId();sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.store=function(e){var t=C,s;v[e]=t;s=t.getComponentInstance();t.setVisible(false);if(sap.ushell.Container){y[e]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray()}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.deactivate()}else{if(s.suspend){s.suspend()}if(s.getRouter&&s.getRouter()){s.getRouter().stop()}}}sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.restore=function(e){var t=v[e],s=t.getComponentInstance(),i=m[t.sId];sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});t.setVisible(true);if(y[e]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(y[e])}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.activate()}else{if(s.restore){s.restore()}if(s.getRouter&&s.getRouter()&&s.getRouter().initialize){if(i===false){s.getRouter().initialize()}else{s.getRouter().initialize(true)}}}C=t}sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{})};this.getURLParameters=function(e){return new Promise(function(s,r){if(e.hasOwnProperty("sap-intent-param")){var n=e["sap-intent-param"];t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:n}).then(function(t){delete e["sap-intent-param"];var r=jQuery.extend({},e,new i("?"+t).query(true),true);s(r)},function(t){s(e)})}else{s(e)}})};this.getAppInfo=function(e,t){return new Promise(function(s){function i(){c.getAppInfo(e,t).then(function(t){l.addAppInfoToCache(e,t);s(t)})}if(f===true&&h[e]){s(JSON.parse(JSON.stringify(h[e])))}else if(c){i()}else{sap.ui.require([d.replace(/\./g,"/")],function(e){c=e;i()})}})};this.addAppInfoToCache=function(e,t){if(e&&t&&f===true&&h[e]===undefined){h[e]=JSON.parse(JSON.stringify(t))}};this.setComponent=function(e){C=e;if(C){m[C.sId]=true}}}return new l},true);
//# sourceMappingURL=AppLifeCycleAgent.js.map