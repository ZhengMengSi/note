/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","jquery.sap.global","sap/zen/dsh/utils/BaseHandler"],function(e,jQuery,t){"use strict";var i=function(){t.apply(this,arguments);var e=this;this.sCmdOnSetShellUrl=null;this.oAppState=null;this.aAllowedSemanticSources=[];this.aValidJumpTargets=[];this.sSelection=null;this.create=function(e,t){this.oAppState=null;this.sSelection=null;var i=t.id;var a=this.createDefaultProxy(i);this.init(a,t);a.setVisible(false);return a};this.update=function(e,t){this.init(e,t);return e};this.init=function(e,t){if(t){this.sCmdOnSetShellUrl=t.onSetShellUrlCommand;if(t.shellAppTitle){this.setTitle(t.shellAppTitle)}if(t.appState){this.setAppState(t.appState,t.hostUI5Control)}if(t.context){this.setNavigationContext(t.context,t.hostUI5Control)}var i=t.clientAction;if(i&&i.length>0){if(i==="NAVIGATE_BACK"){this.navigateBack()}else if(i==="GET_SHELL_URL"){this.setShellUrl()}else if(i==="SET_APP_TITLE"){this.setTitle(t.shellAppTitle)}else if(i==="SAVE_TILE"){this.saveTile(t)}else if(i==="SEND_EMAIL"){this.sendEmail(t)}else if(i==="FETCH_JUMP_TARGETS"){this.fetchJumpTargets(t)}else if(i==="JUMP_TO"){this.jumpToTarget(t)}}}};function i(){return sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation")}function a(){return sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("ShellNavigation")}this.setShellUrl=function(){if(this.sCmdOnSetShellUrl&&this.sCmdOnSetShellUrl.length>0){sap.ushell.Container.getFLPUrlAsync(true).then(function(t){var i=this.sCmdOnSetShellUrl;i=e.prepareCommand(i,"__URL__",t);var a=new Function(i);a()}.bind(this))}};this.setTitle=function(e){sap.zen.dsh.sapbi_page&&sap.zen.dsh.sapbi_page.appComponent&&sap.zen.dsh.sapbi_page.appComponent.getService("ShellUIService").then(function(t){if(t){t.setTitle(e)}},function(){})};this.setAppState=function(e,t){if(e){var n=t&&sap.ui.getCore().byId(t);if(n&&n.fireStateChange){return n.fireStateChange({state:e})}if(!sap.zen.dsh.sapbi_page.appComponent){return}var s=i();var o=a();if(o){if(this.oAppState){var r=this.oAppState.getData();if(r&&r.customData&&r.customData.bookmarkedAppState===e){return}}s.createEmptyAppStateAsync(sap.zen.dsh.sapbi_page.appComponent).then(function(t){this.oAppState=t;var i={customData:{bookmarkedAppState:e}};this.oAppState.setData(i);this.oAppState.save();o.toAppHash("sap-iapp-state="+this.oAppState.getKey(),false);this.setShellUrl()}.bind(this))}}};this.setNavigationContext=function(e,t){var i=t&&sap.ui.getCore().byId(t);if(i&&i.fireSelectionChange){var a=JSON.stringify(e);if(this.sSelection!==a){this.sSelection=a;i.fireSelectionChange({selection:this.createSelectionVariantObject(e)})}}};this.saveTile=function(e){var t=new sap.ushell.ui.footerbar.AddBookmarkButton({beforePressHandler:function(){if(e.shellAppTitle){t.setTitle(e.shellAppTitle)}if(e.tile&&e.tile.subTitle){t.setSubtitle(e.tile.subTitle)}if(e.tile&&e.tile.info){t.setInfo(e.tile.info)}}});t.firePress()};this.sendEmail=function(e){var t=e.email&&e.email.destination;var i=e.email&&e.email.subject;var a=e.email&&e.email.text;sap.m.URLHelper.triggerEmail(t,i,a)};this.navigateBack=function(){var e=i();if(e){e.backToPreviousApp()}};this.fetchJumpTargets=function(e){this.getAllowedSemanticSources(e);var t=e.context;var a=this.createSelectionVariantObject(t);var n={};this.addNameSelectionPairFromArray(t.selections,n);this.addNameSelectionPairFromArray(t.filter,n);this.addNameSelectionPairFromArray(t.variables,n);var s=i();var o;if(a!==undefined&&sap.zen.dsh.sapbi_page&&sap.zen.dsh.sapbi_page.appComponent){var r=s.createEmptyAppState(sap.zen.dsh.sapbi_page.appComponent);var l={selectionVariant:a};r.setData(l);r.save();o=r.getKey()}this.getValidJumpTargets(s,n,o,e)};this.getAllowedSemanticSources=function(e){this.aAllowedSemanticSources=[];if(e.navigation&&e.navigation.allowedSemanticSources){var t=e.navigation.allowedSemanticSources.length;if(t&&t>0){for(var i=0;i<t;i++){this.aAllowedSemanticSources.push(e.navigation.allowedSemanticSources[i].entry.semanticName)}}}return this.aAllowedSemanticSources};this.getValidJumpTargets=function(t,i,a,n){this.aValidJumpTargets=[];var s=[];this.aAllowedSemanticSources.forEach(function(e){s.push([{semanticObject:e,params:i,ignoreFormFactor:false,ui5Component:sap.zen.dsh.sapbi_page.appComponent,appStateKey:a,compactIntents:false}])});var o=t.hrefForAppSpecificHash("");if(o){var r=o.indexOf("?");o=o.substring(0,r>0?r:o.length-2)}var l=[];t.getLinks(s).done(function(t){t.forEach(function(e){e[0].forEach(function(e){if(e.text&&e.intent&&e.intent!==o&&e.intent.indexOf(o+"?")!==0){l.push(e)}})});l.sort(function(e,t){return e.text.localeCompare(t.text)});if(l&&l.length>0){for(var i=0;i<l.length;++i){var a=l[i];this.aValidJumpTargets.push({text:a.text,hash:a.intent})}}if(n.navigation&&n.navigation.onJumpTargetsFetchedCommand&&n.navigation.onJumpTargetsFetchedCommand.length>0){var s=JSON.stringify(this.aValidJumpTargets);s=encodeURI(s);var r=e.prepareCommand(n.navigation.onJumpTargetsFetchedCommand,"__JUMPTARGETS__",s);var p=new Function(r);p()}}.bind(this))};this.jumpToTarget=function(e){var t=i();var a=e.jumpTarget;if(t&&a&&a.length>0){if(e.navigation&&e.navigation.navigateInPlace){t.toExternal({target:{shellHash:a}})}else{window.open(a)}}};this.createSelectionVariantObject=function(e){if(!e){return}var t={};var i=this.getContextSelectOptions(e);if(i!==undefined){t.SelectOptions=i;t.SelectionVariantID=(new Date).toISOString();t.Text="Temporary Variant "+t.SelectionVariantID;return t}};this.getContextSelectOptions=function(e){var t={};var i=[];this.addSelectOptionsFromArray(e.selections,t);this.addSelectOptionsFromArray(e.filter,t);this.addSelectOptionsFromArray(e.variables,t);for(var a in t){if(Object.prototype.hasOwnProperty.call(t,a)){i.push({PropertyName:a,Ranges:t[a]})}}if(i.length>0){return i}};this.addSelectOptionsFromArray=function(e,t){if(e){var i=e.length;if(i>0){for(var a=0;a<i;a++){var n=e[a].dimension.name;if(n&&n.length>0&&!Object.prototype.hasOwnProperty.call(t,n)){if(e[a].dimension.selection){t[n]=[{Sign:"I",Option:"EQ",Low:e[a].dimension.selection,High:null}]}else if(e[a].dimension.selections&&e[a].dimension.selections.length>0){t[n]=e[a].dimension.selections.map(function(e){if(e.LowType!=="DATE"){return e}var t={};for(var i in e){if(Object.prototype.hasOwnProperty.call(e,i)){t[i]=(i==="Low"||i==="High")&&e[i]?e[i]+"T00:00:00.000Z":e[i]}}return t})}}}}}};this.addNameSelectionPairFromArray=function(e,t){var i,a,n;if(e&&t){var s=e.length;if(s>0){for(var o=0;o<s;o++){i=e[o].dimension.name;if(i&&i.length>0&&!t[i]){a=e[o].dimension.selection;if(a&&a.length>0){t[i]=a}else{n=e[o].dimension.selections;if(n&&n.length===1&&n[0].Sign&&n[0].Sign==="I"&&n[0].Option&&n[0].Option==="EQ"){t[i]=n[0].Low==="#"?"":n[0].Low;if(n[0].LowType==="DATE"){t[i]=t[i]+"T00:00:00.000Z"}}}}}}}};this.getDefaultProxyClass=function(){return["sap.m.Button","sap.ui.commons.Button"]};this.getType=function(){return"fiorihelper"}};var a=new i;t.dispatcher.addHandlers(a.getType(),a);return a});
//# sourceMappingURL=fiorihelper_handler.js.map