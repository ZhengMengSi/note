/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/core/Core","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/gantt/simple/GanttUtils"],function(e,t,i,o,a){"use strict";var s={};var n=function(e,t,a,s,n,r,f){this.scale=d3.time.scale().domain(e).range(t).clamp(false);this.timeRange=e;this.viewRange=t;this.zoomRate=i.assign(a,1);this.zoomOrigin=i.assign(s,0);this.viewOffset=i.assign(n,0);this.locale=r;if(r&&r.getUtcdiff()){var g=o.getTimeStampFormatter();this.timeZoneOffset=Math.round((g.parse("20000101"+r.getUtcdiff()).getTime()-g.parse("20000101000000").getTime())/1e3);if(r.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset}}this._oZoomStrategy=f};n.prototype.CONSTANT={C_SEPARATOR:"_@@_",C_MESSAGE:{ARGUMENT_ERROR:"AxisOrdinal: Argument Error!"}};n.prototype.timeToView=function(e,i){if(t.getConfiguration().getRTL()!==true){return(this.scale(e)-this.zoomOrigin)*this.zoomRate-(i?0:this.viewOffset)}else{return this.viewRange[1]*this.zoomRate-((this.scale(e)+this.zoomOrigin)*this.zoomRate+(i?0:this.viewOffset))}};n.prototype.viewToTime=function(e,i){if(t.getConfiguration().getRTL()!==true){return this.scale.invert((e+(i?0:this.viewOffset))/this.zoomRate+this.zoomOrigin)}else{return this.scale.invert(this.viewRange[1]-(e+(i?0:this.viewOffset))/this.zoomRate-this.zoomOrigin)}};n.prototype.setTimeRange=function(e){this.timeRange=e;this.scale.domain(e);return this};n.prototype.getTimeRange=function(){return this.scale.domain()};n.prototype.getTimeRangeSlice=function(e,i){var o=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(e),this.timeZoneOffset):this.viewToTime(e);var a=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(i),this.timeZoneOffset):this.viewToTime(i);if(t.getConfiguration().getRTL()!==true){return[o,a]}else{return[a,o]}};n.prototype.setViewRange=function(e){this.viewRange=e;this.scale.range(e);return this};n.prototype.getViewRange=function(){var e=this.scale.range();return[Math.round((e[0]-this.zoomOrigin)*this.zoomRate-this.viewOffset),Math.round((e[1]-this.zoomOrigin)*this.zoomRate-this.viewOffset)]};n.prototype.getZoomStrategy=function(){return this._oZoomStrategy};n.prototype.setZoomRate=function(e){this.zoomRate=i.assign(e,1);return this};n.prototype.getZoomRate=function(){return this.zoomRate};n.prototype.setZoomOrigin=function(e){this.zoomOrigin=i.assign(e,0);return this};n.prototype.getZoomOrigin=function(){return this.zoomOrigin};n.prototype.setViewOffset=function(e){this.viewOffset=i.assign(e,0);return this};n.prototype.getViewOffset=function(){return this.viewOffset};n.prototype.setLocale=function(e){this.locale=e;if(e&&e.getUtcdiff()){var t=o.getTimeStampFormatter();this.timeZoneOffset=Math.round((t.parse("20000101"+e.getUtcdiff()).getTime()-t.parse("20000101000000").getTime())/1e3);if(e.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset}}return this};n.prototype.getLocale=function(){return this.locale};n.prototype.clone=function(){return new n([new Date(this.timeRange[0].valueOf()),new Date(this.timeRange[1].valueOf())],this.viewRange.slice(0),this.zoomRate,this.zoomOrigin,this.viewOffset,this.locale,this._oZoomStrategy)};n.prototype._get2dContext=function(e,t){if(!s.context){s.context=document.createElement("canvas").getContext("2d")}if(s.fontSize!==e||s.fontFamily!==t){s.context.font=e+"px "+t;s.fontSize=e;s.fontFamily=t}return s.context};n.prototype._getShapeTextWidth=function(e,t,i){return this._get2dContext(t,i).measureText(e).width};n.prototype.getCurrentTickTimeIntervalLevel=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions(),i=0;for(var o in t){if(t[o]===e){return i}i++}};n.prototype.getCurrentTickTimeIntervalKey=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions();for(var i in t){if(t[i]===e){return i}}};n.prototype.getNowLabel=function(e){var t=new Date;if(e===undefined||e){t=new Date(t.getTime()+t.getTimezoneOffset()*6e4)}else{t=a.getFormatedDateByTimeZone(t)}var i=this.timeToView(t);var o=d3.time.second.offset(t,this.timeZoneOffset);return[{date:o,value:Math.round(i)}]};n.prototype.getFirstSmallIntervalIndex=function(e,t){for(var i=0;i<e.length;i++){var a=o.dateToAbapTimestamp(e[i].date);if(a>=t){return i}}};n.prototype.getTickTimeIntervalLabel=function(a,s,r){var f,g,l,h=null;if(this.locale&&this.locale.getDstHorizons().length>0){h=this.locale.getDstHorizons()}var m=o.getTimeStampFormatter();var u=[];if(h){for(f=0;f<h.length;f++){u[f]={};g=h[f].getStartTime();l=h[f].getEndTime();u[f].startDate=m.parse(g);u[f].endDate=m.parse(l)}}var v=this.timeZoneOffset?[d3.time.second.offset(this.timeRange[0],this.timeZoneOffset),d3.time.second.offset(this.timeRange[1],this.timeZoneOffset)]:this.timeRange;var c=new n(v,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy);var T=null;var p=null;var d=null;var w=null;var S=null;var y=null;var O=null;var R=[];var Z=[];var _=null;if(s){y=this.timeZoneOffset?d3.time.second.offset(s[0],this.timeZoneOffset):s[0];O=this.timeZoneOffset?d3.time.second.offset(s[1],this.timeZoneOffset):s[1];T=this.timeZoneOffset?[d3.time.second.offset(s[0],this.timeZoneOffset),d3.time.second.offset(s[1],this.timeZoneOffset)]:s;p=[this.timeToView(s[0]),this.timeToView(s[1])];if(u&&u.length){this._calculateTimeRange(u,y,O,R)}_=this._calculateScale(R,Z,T,p,false)}else if(r){y=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(r[0]),this.timeZoneOffset):this.viewToTime(r[0]);O=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(r[1]),this.timeZoneOffset):this.viewToTime(r[1]);T=[y,O];p=r;if(u.length){this._calculateTimeRange(u,y,O,R)}_=this._calculateScale(R,Z,T,p,false)}else{y=v[0];O=v[1];T=v;p=this.viewRange;if(u.length){this._calculateTimeRange(u,y,O,R)}_=this._calculateScale(R,Z,T,p,v)}Z=_.viewRangeSet;d=_.visibleScale;w=_.dstScale;S=_.normalScale;var L=[];var z,D,k,b;var F={unit:this._oZoomStrategy.getTimeLineOption().largeInterval.unit,span:this._oZoomStrategy.getTimeLineOption().largeInterval.span};var C={unit:this._oZoomStrategy.getTimeLineOption().smallInterval.unit,span:this._oZoomStrategy.getTimeLineOption().smallInterval.span};var I,x;if(F){var P=[];var V=[];var U=[];if(!(d instanceof Array)){P[0]=this._getTimeIntervalTicks(F,d)}else{for(I=0;I<w.length;I++){V[I]=w[I].ticks(e.get(F.unit).range,F.span);U[I]=S[I].ticks(e.get(F.unit).range,F.span)}for(I=0;I<d.length;I++){P[I]=d[I].ticks(e.get(F.unit).range,F.span)}}var M=[];if(P[0]!==null){for(I=0;I<P.length;I++){for(x=0;x<P[I].length;x++){z=P[I][x];k=c.timeToView(z);b=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getUpperRowFormatter(),z));M.push({date:z,value:Math.round(k),label:b})}}}if(V[0]!==null){for(I=0;I<V.length;I++){for(x=0;x<V[I].length;x++){z=V[I][x];D=U[I][x];k=c.timeToView(d3.time.second.offset(z.getTime(),-60*60));b=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getUpperRowFormatter(),z));M.push({date:z,value:Math.round(k),label:b})}}}L.push(M)}else{L.push([])}if(C){var A=[];var E=[];var H=[];if(!(d instanceof Array)){H[0]=this._getTimeIntervalTicks(C,d)}else{for(I=0;I<w.length;I++){A[I]=w[I].ticks(e.get(C.unit).range,C.span);E[I]=S[I].ticks(e.get(C.unit).range,C.span)}for(I=0;I<d.length;I++){H[I]=d[I].ticks(e.get(C.unit).range,C.span)}}var G=[];if(H[0]){for(I=0;I<H.length;I++){for(x=0;x<H[I].length;x++){z=H[I][x];var N;var W=false;if(u.length){for(var q=0;q<u.length;q++){if(z.getTime()===u[q].startDate.getTime()){N=d3.time.second.offset(z.getTime(),60*60);if(x===H[I].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){W=true}}if(x===H[I].length-1&&z.getTime()===d3.time.second.offset(u[q].endDate.getTime(),60*60).getTime()){N=d3.time.second.offset(z.getTime(),-60*60)}}}k=c.timeToView(z);var j;if(W){break}else if(N){j=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getUpperRowFormatter(),N));b=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getLowerRowFormatter(),N));N=null}else{j=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getUpperRowFormatter(),z));b=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getLowerRowFormatter(),z))}G.push({date:z,value:Math.round(k),label:b,largeLabel:j})}}}if(A[0]){for(I=0;I<A.length;I++){for(x=0;x<A[I].length;x++){z=A[I][x];D=E[I][x];var B;var K=false;if(x===A[I].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){if(R.length>0){for(var J=0;J<R.length;J++){if(!R[J].haveDST&&D.getTime()===R[J].range[0].getTime()){K=true}}}}if(u.length){for(var Q=0;Q<u.length;Q++){if(z.getTime()===u[Q].startDate.getTime()){B=d3.time.second.offset(z.getTime(),60*60)}if(x===A[I].length-1&&z.getTime()===d3.time.second.offset(u[Q].endDate.getTime(),60*60).getTime()){B=d3.time.second.offset(z.getTime(),-60*60)}}}if(!this._oZoomStrategy.isLowerRowTickHourSensitive()){k=c.timeToView(d3.time.second.offset(z.getTime(),-60*60))}else{k=c.timeToView(D)}if(K){break}else if(B){b=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getLowerRowFormatter(),B));B=null}else{b=i.getLowerCaseLabel(i.getFormattedDate(this._oZoomStrategy.getLowerRowFormatter(),z))}G.push({date:z,value:Math.round(k),label:b})}}}L.push(G)}else{L.push([])}var X=L[0];var Y=L[1];var $=this.getZoomStrategy().getVisibleHorizon().getStartTime();this.largeIntervalLabel=true;this.largeIntervalPath=false;var ee=this.getFirstSmallIntervalIndex(Y,$);var te,ie,oe=30;var ae,se,ne=0;var re=t.getConfiguration().getRTL();if(Y[ee]){var fe=Y[ee].largeLabel;this.firstTickPosition=Y[ee].value;var ge=false;var le=document.querySelector(".sapGanttTimeHeaderSvgText")||document.querySelector(".sapGanttTimeHeaderSvgText0");if(le){var he=getComputedStyle(le);ae=he.fontSize;se=he.fontFamily;ne=Math.ceil(this._getShapeTextWidth(fe,ae,se))+oe}te=re?this.firstTickPosition-ne:this.firstTickPosition+ne;for(f=0;f<X.length;f++){ne=le?Math.ceil(this._getShapeTextWidth(X[f].label,ae,se))+oe:0;ie=re?X[f].value-ne:X[f].value+ne;var me=re?X[f].value<this.firstTickPosition&&X[f].value>=te:X[f].value>this.firstTickPosition&&X[f].value<=te;var ue=re?this.firstTickPosition<X[f].value&&this.firstTickPosition>=ie:this.firstTickPosition>X[f].value&&this.firstTickPosition<=ie;var ve=X[f].label!==fe;if(me||ue&&ve){this.largeIntervalLabel=false;break}}if(this.largeIntervalLabel){for(f=0;f<X.length;f++){if(X[f].label===fe){if(X[f].value===this.firstTickPosition){this.largeIntervalPath=true}X[f].value=this.firstTickPosition;ge=true;break}}if(!ge){var ce={value:this.firstTickPosition,label:fe};L[0].push(ce)}}}return L};n.prototype._getTimeIntervalTicks=function(t,i){if(t.unit!==sap.gantt.config.TimeUnit.week){return i.ticks(e.get(t.unit).range,t.span)}var o=["d3.time.sunday","d3.time.monday","d3.time.tuesday","d3.time.wednesday","d3.time.thursday","d3.time.friday","d3.time.saturday"];return i.ticks(e.get(o[this.getZoomStrategy().getFirstDayOfWeek()]).range,t.span)};n.prototype._calculateScale=function(e,t,i,o,a){var s=null;var r=[];var f=[];if(e.length){s=[];var g=0;var l=0;for(var h=0;h<e.length;h++){t[h]=[this.timeToView(e[h].range[0]),this.timeToView(e[h].range[1])];if(e[h].haveDST){r[g]=new n(e[h].dstRange,t[h],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;f[g]=new n(e[h].range,t[h],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;g++}else{s[l]=new n(e[h].range,t[h],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;l++}}}else if(a){s=new n(a,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale}else{s=new n(i,o,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale}var m={viewRangeSet:t,visibleScale:s,dstScale:r,normalScale:f};return m};n.prototype._calculateTimeRange=function(e,t,i,o){if(e.length){var a=t;var s=i;var n=[];var r=[];var f,g;f=e[0].startDate;g=e[0].endDate;this._calculateRangeItem(f,g,a,s,n,r);if(e.length>1){for(var l=1;l<e.length;l++){if(n.length){var h=[];for(var m in n){h.push(n[m])}n=[];for(var u=0;u<h.length;u++){f=e[l].startDate;g=e[l].endDate;a=h[u].range[0];s=h[u].range[1];this._calculateRangeItem(f,g,a,s,n,r)}}}}for(var v in r){o.push(r[v])}for(var c in n){o.push(n[c])}}};n.prototype._calculateRangeItem=function(e,t,i,o,a,s){var n=null;if(i<e){if(o<t){if(o>e){n={};n.haveDST=false;n.range=[i,e];a.push(n);n={};n.haveDST=true;n.range=[e,o];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(o,60*60)];s.push(n)}else{n={};n.haveDST=false;n.range=[i,o];a.push(n)}}else{n={};n.haveDST=false;n.range=[i,e];a.push(n);n={};n.haveDST=true;n.range=[e,t];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(t.getTime(),60*60)];s.push(n);n={};n.haveDST=false;n.range=[t,o];a.push(n)}}else if(i>=e){if(i<t){if(o<=t){n={};n.haveDST=true;n.range=[i,o];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(o,60*60)];s.push(n)}else{n={};n.haveDST=true;n.range=[i,t];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(t.getTime(),60*60)];s.push(n);n={};n.haveDST=false;n.range=[t,o];a.push(n)}}else{n={};n.haveDST=false;n.range=[i,o];a.push(n)}}};return n},true);
//# sourceMappingURL=AxisTime.js.map